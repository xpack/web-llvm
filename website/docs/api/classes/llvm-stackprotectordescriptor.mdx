---

# DO NOT EDIT!
# Automatically generated via docusaurus-plugin-doxygen by Doxygen.

slug: /api/classes/llvm/stackprotectordescriptor
custom_edit_url: null
keywords:
  - doxygen
  - reference
  - class
toc_max_heading_level: 3

---

import CodeBlock from '@theme/CodeBlock'

import DoxygenPage from '@xpack/docusaurus-plugin-doxygen/components/DoxygenPage'
import IncludesList from '@xpack/docusaurus-plugin-doxygen/components/IncludesList'
import IncludesListItem from '@xpack/docusaurus-plugin-doxygen/components/IncludesListItem'
import MemberDefinition from '@xpack/docusaurus-plugin-doxygen/components/MemberDefinition'
import MembersIndex from '@xpack/docusaurus-plugin-doxygen/components/MembersIndex'
import MembersIndexItem from '@xpack/docusaurus-plugin-doxygen/components/MembersIndexItem'
import SectionDefinition from '@xpack/docusaurus-plugin-doxygen/components/SectionDefinition'

import pluginConfig from '@site/docusaurus-plugin-doxygen-config.json'

# The `StackProtectorDescriptor` Class Reference

<DoxygenPage pluginConfig={pluginConfig}>

Encapsulates all of the information needed to generate a stack protector check, and signals to isel when initialized that one needs to be generated. <a href="#details">More...</a>

## Declaration

<CodeBlock>class llvm::StackProtectorDescriptor</CodeBlock>

## Included Headers

<IncludesList>
<IncludesListItem
  filePath="llvm/CodeGen/CodeGenCommonISel.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h"
  isLocal="true" />
</IncludesList>

## Public Constructors Index

<MembersIndex>

<MembersIndexItem
  name={<><a href="#ad5fb7a049f0def99d06f6d19ef0e5ded">StackProtectorDescriptor</a> ()=default</>}>
</MembersIndexItem>

</MembersIndex>

## Public Member Functions Index

<MembersIndex>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;</>}
  name={<><a href="#a6dca6975019bcf560ab04e7756cbe3a2">getFailureMBB</a> ()</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;</>}
  name={<><a href="#a8ad101291a071ef005af5b5653a9c516">getParentMBB</a> ()</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;</>}
  name={<><a href="#a2aa77282a145eb011d595a554810d367">getSuccessMBB</a> ()</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a275ec5215a2578ade2b508eaccf0ddc9">initialize</a> (const BasicBlock &#42;BB, MachineBasicBlock &#42;MBB, bool FunctionBasedInstrumentation)</>}>
Initialize the stack protector descriptor structure for a new basic block. <a href="#a275ec5215a2578ade2b508eaccf0ddc9">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a2c52761f81703c84723223cb3e21277e">resetPerBBState</a> ()</>}>
Reset state that changes when we handle different basic blocks. <a href="#a2c52761f81703c84723223cb3e21277e">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a33dac72fe3581c561d8a3922bbf94681">resetPerFunctionState</a> ()</>}>
Reset state that only changes when we switch functions. <a href="#a33dac72fe3581c561d8a3922bbf94681">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#ab02aa9780b3650004c5a6dd172020ca4">shouldEmitFunctionBasedCheckStackProtector</a> () const</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a9f7bb247910a6a75a3b45832033893a9">shouldEmitStackProtector</a> () const</>}>
Returns true if all fields of the stack protector descriptor are initialized implying that we should/are ready to emit a stack protector. <a href="#a9f7bb247910a6a75a3b45832033893a9">More...</a>
</MembersIndexItem>

</MembersIndex>

## Private Member Functions Index

<MembersIndex>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;</>}
  name={<><a href="#a9a6e81d14098ef1916072a82010e6f16">addSuccessorMBB</a> (const BasicBlock &#42;BB, MachineBasicBlock &#42;ParentMBB, bool IsLikely, MachineBasicBlock &#42;SuccMBB=nullptr)</>}>
Add a successor machine basic block to ParentMBB. <a href="#a9a6e81d14098ef1916072a82010e6f16">More...</a>
</MembersIndexItem>

</MembersIndex>

## Private Member Attributes Index

<MembersIndex>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;</>}
  name={<><a href="#aabc0037fd7f3971198d114d8e6a3ccd6">FailureMBB</a> = nullptr</>}>
This basic block visited on stack protector check failure that will contain a call to &#95;&#95;stack&#95;chk&#95;fail(). <a href="#aabc0037fd7f3971198d114d8e6a3ccd6">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;</>}
  name={<><a href="#aeca5c22988a25ef69aab08d05609249a">ParentMBB</a> = nullptr</>}>
The basic block for which we are generating the stack protector. <a href="#aeca5c22988a25ef69aab08d05609249a">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;</>}
  name={<><a href="#a6b3367d87b62a5cf89a0d14264ab1150">SuccessMBB</a> = nullptr</>}>
A basic block visited on stack protector check success that contains the terminators of ParentMBB. <a href="#a6b3367d87b62a5cf89a0d14264ab1150">More...</a>
</MembersIndexItem>

</MembersIndex>

## Description {#details}

Encapsulates all of the information needed to generate a stack protector check, and signals to isel when initialized that one needs to be generated.

<em>NOTE</em> The following is a high level documentation of <a href="/docs/api/classes/llvm/selectiondag">SelectionDAG</a> Stack Protector Generation. This is now also ported be shared with GlobalISel, but without any significant changes.

High Level Overview of ISel Stack Protector Generation:

Previously, the &quot;stack protector&quot; IR pass handled stack protector generation. This necessitated splitting basic blocks at the IR level to create the success/failure basic blocks in the tail of the basic block in question. As a result of this, calls that would have qualified for the sibling call optimization were no longer eligible for optimization since said calls were no longer right in the &quot;tail position&quot; (i.e. the immediate predecessor of a <a href="/docs/api/classes/llvm/returninst">ReturnInst</a> instruction).

Since the sibling call optimization causes the callee to reuse the caller&#39;s stack, if we could delay the generation of the stack protector check until later in CodeGen after the sibling call decision was made, we get both the tail call optimization and the stack protector check!

A few goals in solving this problem were:


<ul>
<li>Preserve the architecture independence of stack protector generation.</li>
<li>Preserve the normal IR level stack protector check for platforms like OpenBSD for which we support platform-specific stack protector generation.</li>
</ul>


The main problem that guided the present solution is that one can not solve this problem in an architecture independent manner at the IR level only. This is because:


<ul>
<li>The decision on whether or not to perform a sibling call on certain platforms (for instance i386) requires lower level information related to available registers that can not be known at the IR level.</li>
<li>Even if the previous point were not true, the decision on whether to perform a tail call is done in LowerCallTo in <a href="/docs/api/classes/llvm/selectiondag">SelectionDAG</a> (or <a href="/docs/api/classes/llvm/calllowering">CallLowering</a> in GlobalISel) which occurs after the Stack Protector <a href="/docs/api/classes/llvm/pass">Pass</a>. As a result, one would need to put the relevant callinst into the stack protector check success basic block (where the return inst is placed) and then move it back later at ISel/MI time before the stack protector check if the tail call optimization failed. The MI level option was nixed immediately since it would require platform-specific pattern matching. The ISel level option was nixed because <a href="/docs/api/classes/llvm/selectiondag">SelectionDAG</a> only processes one IR level basic block at a time implying one could not create a DAG Combine to move the callinst.</li>
</ul>


To get around this problem:


<ul>
<li><a href="/docs/api/classes/llvm/selectiondag">SelectionDAG</a> can only process one block at a time, we can generate multiple machine basic blocks for one IR level basic block. This is how we handle bit tests and switches.</li>
<li>At the MI level, tail calls are represented via a special return MIInst called &quot;tcreturn&quot;. Thus if we know the basic block in which we wish to insert the stack protector check, we get the correct behavior by always inserting the stack protector check right before the return statement. This is a &quot;magical transformation&quot; since no matter where the stack protector check intrinsic is, we always insert the stack protector check code at the end of the BB.</li>
</ul>


Given the aforementioned constraints, the following solution was devised:


<ul>
<li>On platforms that do not support ISel stack protector check generation, allow for the normal IR level stack protector check generation to continue.</li>
<li>On platforms that do support ISel stack protector check generation:
a. <a href="/docs/api/classes/llvm/use">Use</a> the IR level stack protector pass to decide if a stack protector is required/which BB we insert the stack protector check in by reusing the logic already therein.
b. After we finish selecting the basic block, we produce the validation code with one of these techniques: 1) with a call to a guard check function 2) with inlined instrumentation
1) We insert a call to the check function before the terminator.
2) We first find a splice point in the parent basic block before the terminator and then splice the terminator of said basic block into the success basic block. Then we code-gen a new tail for the parent basic block consisting of the two loads, the comparison, and finally two branches to the success/failure basic blocks. We conclude by code-gening the failure basic block if we have not code-gened it already (all stack protector checks we generate in the same function, use the same failure basic block).</li>
</ul>

Definition at line 116 of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h">CodeGenCommonISel.h</a>.

<SectionDefinition>

## Public Constructors

### StackProtectorDescriptor() {#ad5fb7a049f0def99d06f6d19ef0e5ded}

<MemberDefinition
  prototype="llvm::StackProtectorDescriptor::StackProtectorDescriptor ()"
  labels = {["default"]}>

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h/#l00118">118</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h">CodeGenCommonISel.h</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Public Member Functions

### getFailureMBB() {#a6dca6975019bcf560ab04e7756cbe3a2}

<MemberDefinition
  prototype={<>MachineBasicBlock &#42; llvm::StackProtectorDescriptor::getFailureMBB ()</>}
  labels = {["inline"]}>

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h/#l00172">172</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h">CodeGenCommonISel.h</a>.
</MemberDefinition>

### getParentMBB() {#a8ad101291a071ef005af5b5653a9c516}

<MemberDefinition
  prototype={<>MachineBasicBlock &#42; llvm::StackProtectorDescriptor::getParentMBB ()</>}
  labels = {["inline"]}>

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h/#l00170">170</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h">CodeGenCommonISel.h</a>.
</MemberDefinition>

### getSuccessMBB() {#a2aa77282a145eb011d595a554810d367}

<MemberDefinition
  prototype={<>MachineBasicBlock &#42; llvm::StackProtectorDescriptor::getSuccessMBB ()</>}
  labels = {["inline"]}>

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h/#l00171">171</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h">CodeGenCommonISel.h</a>.
</MemberDefinition>

### initialize() {#a275ec5215a2578ade2b508eaccf0ddc9}

<MemberDefinition
  prototype={<>void llvm::StackProtectorDescriptor::initialize (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; BB, <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42; MBB, bool FunctionBasedInstrumentation)</>}
  labels = {["inline"]}>
Initialize the stack protector descriptor structure for a new basic block.

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h/#l00132">132</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h">CodeGenCommonISel.h</a>.
</MemberDefinition>

### resetPerBBState() {#a2c52761f81703c84723223cb3e21277e}

<MemberDefinition
  prototype="void llvm::StackProtectorDescriptor::resetPerBBState ()"
  labels = {["inline"]}>
Reset state that changes when we handle different basic blocks.

This currently includes:


<ul>
<li>The specific basic block we are generating a stack protector for (ParentMBB).</li>
<li>The successor machine basic block that will contain the tail of parent mbb after we create the stack protector check (SuccessMBB). This BB is visited only on stack protector check success.</li>
</ul>

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h/#l00154">154</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h">CodeGenCommonISel.h</a>.
</MemberDefinition>

### resetPerFunctionState() {#a33dac72fe3581c561d8a3922bbf94681}

<MemberDefinition
  prototype="void llvm::StackProtectorDescriptor::resetPerFunctionState ()"
  labels = {["inline"]}>
Reset state that only changes when we switch functions.

This currently includes:


<ul>
<li>FailureMBB since we reuse the failure code path for all stack protector checks created in an individual function.</li>
</ul>


2.The guard variable since the guard variable we are checking against is always the same.

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h/#l00168">168</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h">CodeGenCommonISel.h</a>.
</MemberDefinition>

### shouldEmitFunctionBasedCheckStackProtector() {#ab02aa9780b3650004c5a6dd172020ca4}

<MemberDefinition
  prototype="bool llvm::StackProtectorDescriptor::shouldEmitFunctionBasedCheckStackProtector () const"
  labels = {["inline"]}>

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h/#l00126">126</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h">CodeGenCommonISel.h</a>.
</MemberDefinition>

### shouldEmitStackProtector() {#a9f7bb247910a6a75a3b45832033893a9}

<MemberDefinition
  prototype="bool llvm::StackProtectorDescriptor::shouldEmitStackProtector () const"
  labels = {["inline"]}>
Returns true if all fields of the stack protector descriptor are initialized implying that we should/are ready to emit a stack protector.

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h/#l00122">122</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h">CodeGenCommonISel.h</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Private Member Functions

### addSuccessorMBB() {#a9a6e81d14098ef1916072a82010e6f16}

<MemberDefinition
  prototype={<>MachineBasicBlock &#42; StackProtectorDescriptor::addSuccessorMBB (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; BB, <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42; ParentMBB, bool IsLikely, <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42; SuccMBB=nullptr)</>}>
Add a successor machine basic block to ParentMBB.

Add a successor MBB to ParentMBB&lt; creating a new MachineBB for BB if SuccMBB is 0.

If the successor mbb has not been created yet (i.e. if SuccMBB = 0), then the machine basic block will be created. Assign a large weight if IsLikely is true.

Declaration at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h/#l00195">195</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h">CodeGenCommonISel.h</a>, definition at line <a href="/docs/api/files/lib/lib/codegen/codegencommonisel-cpp/#l00029">29</a> of file <a href="/docs/api/files/lib/lib/codegen/codegencommonisel-cpp">CodeGenCommonISel.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Private Member Attributes

### FailureMBB {#aabc0037fd7f3971198d114d8e6a3ccd6}

<MemberDefinition
  prototype={<>MachineBasicBlock&#42; llvm::StackProtectorDescriptor::FailureMBB = nullptr</>}>
This basic block visited on stack protector check failure that will contain a call to &#95;&#95;stack&#95;chk&#95;fail().

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h/#l00190">190</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h">CodeGenCommonISel.h</a>.
</MemberDefinition>

### ParentMBB {#aeca5c22988a25ef69aab08d05609249a}

<MemberDefinition
  prototype={<>MachineBasicBlock&#42; llvm::StackProtectorDescriptor::ParentMBB = nullptr</>}>
The basic block for which we are generating the stack protector.

As a result of stack protector generation, we will splice the terminators of this basic block into the successor mbb SuccessMBB and replace it with a compare/branch to the successor mbbs SuccessMBB/FailureMBB depending on whether or not the stack protector was violated.

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h/#l00182">182</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h">CodeGenCommonISel.h</a>.
</MemberDefinition>

### SuccessMBB {#a6b3367d87b62a5cf89a0d14264ab1150}

<MemberDefinition
  prototype={<>MachineBasicBlock&#42; llvm::StackProtectorDescriptor::SuccessMBB = nullptr</>}>
A basic block visited on stack protector check success that contains the terminators of ParentMBB.

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h/#l00186">186</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h">CodeGenCommonISel.h</a>.
</MemberDefinition>

</SectionDefinition>

<hr/>

The documentation for this class was generated from the following files:

<ul>
<li><a href="/docs/api/files/include/include/llvm/include/llvm/codegen/codegencommonisel-h">CodeGenCommonISel.h</a></li>
<li><a href="/docs/api/files/lib/lib/codegen/codegencommonisel-cpp">CodeGenCommonISel.cpp</a></li>
</ul>

</DoxygenPage>
