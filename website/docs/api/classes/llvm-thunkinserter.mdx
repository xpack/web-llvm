---

# DO NOT EDIT!
# Automatically generated via docusaurus-plugin-doxygen by Doxygen.

slug: /api/classes/llvm/thunkinserter
custom_edit_url: null
keywords:
  - doxygen
  - reference
  - class
toc_max_heading_level: 3

---

import CodeBlock from '@theme/CodeBlock'

import DoxygenPage from '@xpack/docusaurus-plugin-doxygen/components/DoxygenPage'
import IncludesList from '@xpack/docusaurus-plugin-doxygen/components/IncludesList'
import IncludesListItem from '@xpack/docusaurus-plugin-doxygen/components/IncludesListItem'
import MemberDefinition from '@xpack/docusaurus-plugin-doxygen/components/MemberDefinition'
import MembersIndex from '@xpack/docusaurus-plugin-doxygen/components/MembersIndex'
import MembersIndexItem from '@xpack/docusaurus-plugin-doxygen/components/MembersIndexItem'
import SectionDefinition from '@xpack/docusaurus-plugin-doxygen/components/SectionDefinition'

import pluginConfig from '@site/docusaurus-plugin-doxygen-config.json'

# The `ThunkInserter` Class Template Reference

<DoxygenPage pluginConfig={pluginConfig}>

This class assists in inserting MI thunk functions into the module and rewriting the existing machine functions to call these thunks. <a href="#details">More...</a>

## Declaration

<CodeBlock>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;
class llvm::ThunkInserter&lt;Derived, InsertedThunksTy&gt;</CodeBlock>

## Included Headers

<IncludesList>
<IncludesListItem
  filePath="llvm/CodeGen/IndirectThunks.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h"
  isLocal="true" />
</IncludesList>

## Public Member Functions Index

<MembersIndex>

<MembersIndexItem
  template={<>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;</>}
  type="void"
  name={<><a href="#ad580754b469f950b5e7cb2a453f41768">init</a> (Module &amp;M)</>}>
</MembersIndexItem>

<MembersIndexItem
  template={<>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;</>}
  type="bool"
  name={<><a href="#a547880d64e46c0d922e0bb0f0d7f5fb9">run</a> (MachineModuleInfo &amp;MMI, MachineFunction &amp;MF)</>}>
</MembersIndexItem>

</MembersIndex>

## Protected Member Functions Index

<MembersIndex>

<MembersIndexItem
  template={<>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;</>}
  type="void"
  name={<><a href="#a1a95b72d4c28ba76251171967da03b01">createThunkFunction</a> (MachineModuleInfo &amp;MMI, StringRef Name, bool Comdat=true, StringRef TargetAttrs=&quot;&quot;)</>}>
Create an empty thunk function. <a href="#a1a95b72d4c28ba76251171967da03b01">More...</a>
</MembersIndexItem>

<MembersIndexItem
  template={<>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;</>}
  type="void"
  name={<><a href="#a740bcd15c5627326e077787331b1d60a">doInitialization</a> (Module &amp;M)</>}>
Initializes thunk inserter. <a href="#a740bcd15c5627326e077787331b1d60a">More...</a>
</MembersIndexItem>

<MembersIndexItem
  template={<>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;</>}
  type={<><a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> char &#42;</>}
  name={<><a href="#a7d87c609ee113d729a15013e29da1030">getThunkPrefix</a> ()</>}>
Returns common prefix for thunk function&#39;s names. <a href="#a7d87c609ee113d729a15013e29da1030">More...</a>
</MembersIndexItem>

<MembersIndexItem
  template={<>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;</>}
  type="InsertedThunksTy"
  name={<><a href="#a1f77fc3ad826da7fc3c13df75da3c8ff">insertThunks</a> (MachineModuleInfo &amp;MMI, MachineFunction &amp;MF, InsertedThunksTy ExistingThunks)</>}>
Rewrites the function if necessary, returns the set of thunks added. <a href="#a1f77fc3ad826da7fc3c13df75da3c8ff">More...</a>
</MembersIndexItem>

<MembersIndexItem
  template={<>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;</>}
  type="bool"
  name={<><a href="#a0e76d9a11bcf2f5bb6b8842ae88ebf9e">mayUseThunk</a> (const MachineFunction &amp;MF)</>}>
Checks if MF may use thunks (true - maybe, false - definitely not). <a href="#a0e76d9a11bcf2f5bb6b8842ae88ebf9e">More...</a>
</MembersIndexItem>

<MembersIndexItem
  template={<>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;</>}
  type="void"
  name={<><a href="#ad70655ccbb3ff3439dfe9fabddd15625">populateThunk</a> (MachineFunction &amp;MF)</>}>
Populate the thunk function with instructions. <a href="#ad70655ccbb3ff3439dfe9fabddd15625">More...</a>
</MembersIndexItem>

</MembersIndex>

## Private Member Functions Index

<MembersIndex>

<MembersIndexItem
  template={<>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;</>}
  type={<>Derived &amp;</>}
  name={<><a href="#afe63ca4ad74420bebf6cadbb92b6c327">getDerived</a> ()</>}>
</MembersIndexItem>

</MembersIndex>

## Private Member Attributes Index

<MembersIndex>

<MembersIndexItem
  template={<>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;</>}
  type="InsertedThunksTy"
  name={<><a href="#af1ca178a0ee2f220f7a8e4b6a1a1209c">InsertedThunks</a></>}>
</MembersIndexItem>

</MembersIndex>

## Description {#details}

This class assists in inserting MI thunk functions into the module and rewriting the existing machine functions to call these thunks.

One of the common cases is implementing security mitigations that involve replacing some machine code patterns with calls to special thunk functions.

Inserting a module pass late in the codegen pipeline may increase memory usage, as it serializes the transformations and forces preceding passes to produce machine code for all functions before running the module pass. For that reason, <a href="/docs/api/classes/llvm/thunkinserter">ThunkInserter</a> can be driven by a <a href="/docs/api/classes/llvm/machinefunctionpass">MachineFunctionPass</a> by passing one <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> at a time to its <code>run(MMI, MF)</code> method. Then, the derived class should
<ul>
<li>call createThunkFunction from its insertThunks method exactly once for each of the thunk functions to be inserted</li>
<li>populate the thunk in its populateThunk method</li>
</ul>


Note that if some other pass is responsible for rewriting the functions, the insertThunks method may simply create all possible thunks at once, probably postponed until the first occurrence of possibly affected MF.

Alternatively, insertThunks method can rewrite MF by itself and only insert the thunks being called. In that case InsertedThunks variable can be used to track which thunks were already inserted.

In any case, the thunk function has to be inserted on behalf of some other function and then populated on its own &quot;iteration&quot; later - this is because <a href="/docs/api/classes/llvm/machinefunctionpass">MachineFunctionPass</a> will see the newly created functions, but they first have to go through the preceding passes from the same pass manager, possibly even through the instruction selector.

Definition at line 61 of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h">IndirectThunks.h</a>.

<SectionDefinition>

## Public Member Functions

### init() {#ad580754b469f950b5e7cb2a453f41768}

<MemberDefinition
  template={<>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;</>}
  prototype={<>void llvm::ThunkInserter&lt; Derived, InsertedThunksTy &gt;::init (<a href="/docs/api/classes/llvm/module">Module</a> &amp; M)</>}
  labels = {["inline"]}>

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h/#l00110">110</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h">IndirectThunks.h</a>.
</MemberDefinition>

### run() {#a547880d64e46c0d922e0bb0f0d7f5fb9}

<MemberDefinition
  template={<>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;</>}
  prototype={<>bool llvm::ThunkInserter&lt; Derived, InsertedThunksTy &gt;::run (<a href="/docs/api/classes/llvm/machinemoduleinfo">MachineModuleInfo</a> &amp; MMI, <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp; MF)</>}>

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h/#l00115">115</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h">IndirectThunks.h</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Protected Member Functions

### createThunkFunction() {#a1a95b72d4c28ba76251171967da03b01}

<MemberDefinition
  template={<>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;</>}
  prototype={<>void llvm::ThunkInserter&lt; Derived, InsertedThunksTy &gt;::createThunkFunction (<a href="/docs/api/classes/llvm/machinemoduleinfo">MachineModuleInfo</a> &amp; MMI, <a href="/docs/api/classes/llvm/stringref">StringRef</a> Name, bool Comdat=<a href="/docs/api/files/lib/lib/analysis/basicaliasanalysis-cpp/#af6d5cafbdfc5313e65d990120021a3ec">true</a>, <a href="/docs/api/classes/llvm/stringref">StringRef</a> TargetAttrs=&quot;&quot;)</>}
  labels = {["protected"]}>
Create an empty thunk function.

The new function will eventually be passed to populateThunk. If multiple thunks are created, populateThunk can distinguish them by their names.

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h/#l00077">77</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h">IndirectThunks.h</a>.
</MemberDefinition>

### doInitialization() {#a740bcd15c5627326e077787331b1d60a}

<MemberDefinition
  template={<>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;</>}
  prototype={<>void llvm::ThunkInserter&lt; Derived, InsertedThunksTy &gt;::doInitialization (<a href="/docs/api/classes/llvm/module">Module</a> &amp; M)</>}
  labels = {["inline", "protected"]}>
Initializes thunk inserter.

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h/#l00087">87</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h">IndirectThunks.h</a>.
</MemberDefinition>

### getThunkPrefix() {#a7d87c609ee113d729a15013e29da1030}

<MemberDefinition
  template={<>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;</>}
  prototype={<>const char &#42; llvm::ThunkInserter&lt; Derived, InsertedThunksTy &gt;::getThunkPrefix ()</>}
  labels = {["protected"]}>
Returns common prefix for thunk function&#39;s names.

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h/#l00090">90</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h">IndirectThunks.h</a>.
</MemberDefinition>

### insertThunks() {#a1f77fc3ad826da7fc3c13df75da3c8ff}

<MemberDefinition
  template={<>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;</>}
  prototype={<>InsertedThunksTy llvm::ThunkInserter&lt; Derived, InsertedThunksTy &gt;::insertThunks (<a href="/docs/api/classes/llvm/machinemoduleinfo">MachineModuleInfo</a> &amp; MMI, <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp; MF, InsertedThunksTy ExistingThunks)</>}
  labels = {["protected"]}>
Rewrites the function if necessary, returns the set of thunks added.

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h/#l00096">96</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h">IndirectThunks.h</a>.
</MemberDefinition>

### mayUseThunk() {#a0e76d9a11bcf2f5bb6b8842ae88ebf9e}

<MemberDefinition
  template={<>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;</>}
  prototype={<>bool llvm::ThunkInserter&lt; Derived, InsertedThunksTy &gt;::mayUseThunk (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp; MF)</>}
  labels = {["protected"]}>
Checks if MF may use thunks (true - maybe, false - definitely not).

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h/#l00093">93</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h">IndirectThunks.h</a>.
</MemberDefinition>

### populateThunk() {#ad70655ccbb3ff3439dfe9fabddd15625}

<MemberDefinition
  template={<>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;</>}
  prototype={<>void llvm::ThunkInserter&lt; Derived, InsertedThunksTy &gt;::populateThunk (<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp; MF)</>}
  labels = {["protected"]}>
Populate the thunk function with instructions.

If multiple thunks are created, the content that must be inserted in the thunk function body should be derived from the MF&#39;s name.

Depending on the preceding passes in the pass manager, by the time populateThunk is called, MF may have a few target-specific instructions (such as a single MBB containing the return instruction).

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h/#l00107">107</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h">IndirectThunks.h</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Private Member Functions

### getDerived() {#afe63ca4ad74420bebf6cadbb92b6c327}

<MemberDefinition
  template={<>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;</>}
  prototype={<>Derived &amp; llvm::ThunkInserter&lt; Derived, InsertedThunksTy &gt;::getDerived ()</>}
  labels = {["inline"]}>

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h/#l00062">62</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h">IndirectThunks.h</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Private Member Attributes

### InsertedThunks {#af1ca178a0ee2f220f7a8e4b6a1a1209c}

<MemberDefinition
  template={<>template &lt;typename Derived, typename InsertedThunksTy = bool&gt;</>}
  prototype={<>InsertedThunksTy llvm::ThunkInserter&lt; Derived, InsertedThunksTy &gt;::InsertedThunks</>}>

Definition at line <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h/#l00068">68</a> of file <a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h">IndirectThunks.h</a>.
</MemberDefinition>

</SectionDefinition>

<hr/>

The documentation for this class was generated from the following file:

<ul>
<li><a href="/docs/api/files/include/include/llvm/include/llvm/codegen/indirectthunks-h">IndirectThunks.h</a></li>
</ul>

</DoxygenPage>
