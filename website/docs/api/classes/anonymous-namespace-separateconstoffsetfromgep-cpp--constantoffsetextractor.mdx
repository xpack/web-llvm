---

# DO NOT EDIT!
# Automatically generated via docusaurus-plugin-doxygen by Doxygen.

slug: /api/classes/anonymous-namespace-separateconstoffsetfromgep-cpp-/constantoffsetextractor
custom_edit_url: null
keywords:
  - doxygen
  - reference
  - class
toc_max_heading_level: 3

---

import CodeBlock from '@theme/CodeBlock'

import DoxygenPage from '@xpack/docusaurus-plugin-doxygen/components/DoxygenPage'
import MemberDefinition from '@xpack/docusaurus-plugin-doxygen/components/MemberDefinition'
import MembersIndex from '@xpack/docusaurus-plugin-doxygen/components/MembersIndex'
import MembersIndexItem from '@xpack/docusaurus-plugin-doxygen/components/MembersIndexItem'
import SectionDefinition from '@xpack/docusaurus-plugin-doxygen/components/SectionDefinition'

import pluginConfig from '@site/docusaurus-plugin-doxygen-config.json'

# The `ConstantOffsetExtractor` Class Reference

<DoxygenPage pluginConfig={pluginConfig}>

A helper class for separating a constant offset from a GEP index. <a href="#details">More...</a>

## Declaration

<CodeBlock>class anonymous_namespace{SeparateConstOffsetFromGEP.cpp}::ConstantOffsetExtractor</CodeBlock>

## Private Constructors Index

<MembersIndex>

<MembersIndexItem
  name={<><a href="#a30c61b0081d8d8eb75beb4d5193c5e89">ConstantOffsetExtractor</a> (BasicBlock::iterator InsertionPt)</>}>
</MembersIndexItem>

</MembersIndex>

## Private Member Functions Index

<MembersIndex>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/value">Value</a> &#42;</>}
  name={<><a href="#a0d18d46ccd1e656e6b3611358e1d83aa">applyExts</a> (Value &#42;V)</>}>
A helper function to apply ExtInsts, a list of s/zext, to value V. <a href="#a0d18d46ccd1e656e6b3611358e1d83aa">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a6b504895b92395669bf978ee919c33a4">CanTraceInto</a> (bool SignExtended, bool ZeroExtended, BinaryOperator &#42;BO, bool NonNegative)</>}>
A helper function that returns whether we can trace into the operands of binary operator BO for a constant offset. <a href="#a6b504895b92395669bf978ee919c33a4">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/value">Value</a> &#42;</>}
  name={<><a href="#a865a2e6eb480b162bfa814a81e1a8568">distributeExtsAndCloneChain</a> (unsigned ChainIndex)</>}>
After the first step of rebuilding the GEP index without the constant offset, distribute s/zext to the operands of all operators in UserChain. <a href="#a865a2e6eb480b162bfa814a81e1a8568">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/apint">APInt</a></>}
  name={<><a href="#a7b43ed82204cf5a8d8508f6caa62f71e">find</a> (Value &#42;V, bool SignExtended, bool ZeroExtended, bool NonNegative)</>}>
Searches the expression that computes V for a non-zero constant C s.t. <a href="#a7b43ed82204cf5a8d8508f6caa62f71e">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/apint">APInt</a></>}
  name={<><a href="#a57fabe3822ccf25985ef25e631ee3ccd">findInEitherOperand</a> (BinaryOperator &#42;BO, bool SignExtended, bool ZeroExtended)</>}>
A helper function to look into both operands of a binary operator. <a href="#a57fabe3822ccf25985ef25e631ee3ccd">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/value">Value</a> &#42;</>}
  name={<><a href="#a78959368b08ec9f83d62069638155baf">rebuildWithoutConstOffset</a> ()</>}>
After finding the constant offset C from the GEP index I, we build a new index I&#39; s.t. <a href="#a78959368b08ec9f83d62069638155baf">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/value">Value</a> &#42;</>}
  name={<><a href="#a2694526eb3294698abfd547a63429a32">removeConstOffset</a> (unsigned ChainIndex)</>}>
Reassociates the GEP index to the form I&#39; + C and returns I&#39;. <a href="#a2694526eb3294698abfd547a63429a32">More...</a>
</MembersIndexItem>

</MembersIndex>

## Private Member Attributes Index

<MembersIndex>

<MembersIndexItem
  type={<><a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/datalayout">DataLayout</a> &amp;</>}
  name={<><a href="#a6dcfbde4b78703662d54658387268cfc">DL</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/smallvector">SmallVector</a>&lt; <a href="/docs/api/classes/llvm/castinst">CastInst</a> &#42;, 16 &gt;</>}
  name={<><a href="#af3e3847ac4a5a018d2152ac912c1e28d">ExtInsts</a></>}>
A data structure used in rebuildWithoutConstOffset. <a href="#af3e3847ac4a5a018d2152ac912c1e28d">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a></>}
  name={<><a href="#aa948ae88ae245e1e9cd2b674a41743e0">IP</a></>}>
Insertion position of cloned instructions. <a href="#aa948ae88ae245e1e9cd2b674a41743e0">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/smallvector">SmallVector</a>&lt; <a href="/docs/api/classes/llvm/user">User</a> &#42;, 8 &gt;</>}
  name={<><a href="#ad0114f230694b36b1e009ab3424bc216">UserChain</a></>}>
The path from the constant offset to the old GEP index. <a href="#ad0114f230694b36b1e009ab3424bc216">More...</a>
</MembersIndexItem>

</MembersIndex>

## Public Static Functions Index

<MembersIndex>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/value">Value</a> &#42;</>}
  name={<><a href="#a867434c3e87f84340731c31c5e1b863d">Extract</a> (Value &#42;Idx, GetElementPtrInst &#42;GEP, User &#42;&amp;UserChainTail)</>}>
Extracts a constant offset from the given GEP index. <a href="#a867434c3e87f84340731c31c5e1b863d">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<>int64&#95;t</>}
  name={<><a href="#aaffc55116f7466c3676d8852dc95175d">Find</a> (Value &#42;Idx, GetElementPtrInst &#42;GEP)</>}>
Looks for a constant offset from the given GEP index without extracting it. <a href="#aaffc55116f7466c3676d8852dc95175d">More...</a>
</MembersIndexItem>

</MembersIndex>

## Description {#details}

A helper class for separating a constant offset from a GEP index.

In real programs, a GEP index may be more complicated than a simple addition of something and a constant integer which can be trivially splitted. For example, to split ((a &lt;&lt; 3) | 5) + b, we need to search deeper for the constant offset, so that we can separate the index to (a &lt;&lt; 3) + b and 5.

Therefore, this class looks into the expression that computes a given GEP index, and tries to find a constant integer that can be hoisted to the outermost level of the expression as an addition. Not every constant in an expression can jump out. e.g., we cannot transform (b &#42; (a + 5)) to (b &#42; a + 5); nor can we transform (3 &#42; (a + 5)) to (3 &#42; a + 5), however in this case, -instcombine probably already optimized (3 &#42; (a + 5)) to (3 &#42; a + 15).

Definition at line 229 of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp">SeparateConstOffsetFromGEP.cpp</a>.

<SectionDefinition>

## Private Constructors

### ConstantOffsetExtractor() {#a30c61b0081d8d8eb75beb4d5193c5e89}

<MemberDefinition
  prototype={<>anonymous&#95;namespace&#123;SeparateConstOffsetFromGEP.cpp&#125;::ConstantOffsetExtractor::ConstantOffsetExtractor (<a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> InsertionPt)</>}
  labels = {["inline"]}>

Definition at line <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp/#l00247">247</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp">SeparateConstOffsetFromGEP.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Private Member Functions

### applyExts() {#a0d18d46ccd1e656e6b3611358e1d83aa}

<MemberDefinition
  prototype={<>Value &#42; ConstantOffsetExtractor::applyExts (<a href="/docs/api/classes/llvm/value">Value</a> &#42; V)</>}>
A helper function to apply ExtInsts, a list of s/zext, to value V.

e.g., if ExtInsts = &#91;sext i32 to i64, zext i16 to i32&#93;, this function returns &quot;sext i32 (zext i16 V to i32) to i64&quot;.

Definition at line <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp/#l00310">310</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp">SeparateConstOffsetFromGEP.cpp</a>.
</MemberDefinition>

### CanTraceInto() {#a6b504895b92395669bf978ee919c33a4}

<MemberDefinition
  prototype={<>bool ConstantOffsetExtractor::CanTraceInto (bool SignExtended, bool ZeroExtended, <a href="/docs/api/classes/llvm/binaryoperator">BinaryOperator</a> &#42; BO, bool NonNegative)</>}>
A helper function that returns whether we can trace into the operands of binary operator BO for a constant offset.

<code>SignExtended</code> Whether BO is surrounded by sext <code>ZeroExtended</code> Whether BO is surrounded by zext <code>NonNegative</code> Whether BO is known to be non-negative, e.g., an in-bound array index.

Definition at line <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp/#l00319">319</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp">SeparateConstOffsetFromGEP.cpp</a>.
</MemberDefinition>

### distributeExtsAndCloneChain() {#a865a2e6eb480b162bfa814a81e1a8568}

<MemberDefinition
  prototype={<>Value &#42; ConstantOffsetExtractor::distributeExtsAndCloneChain (unsigned ChainIndex)</>}>
After the first step of rebuilding the GEP index without the constant offset, distribute s/zext to the operands of all operators in UserChain.

e.g., zext(sext(a + (b + 5)) (assuming no overflow) =&gt; zext(sext(a)) + (zext(sext(b)) + zext(sext(5))).

The function also updates UserChain to point to new subexpressions after distributing s/zext. e.g., the old UserChain of the above example is 5 -&gt; b + 5 -&gt; a + (b + 5) -&gt; sext(...) -&gt; zext(sext(...)), and the new UserChain is zext(sext(5)) -&gt; zext(sext(b)) + zext(sext(5)) -&gt; zext(sext(a)) + (zext(sext(b)) + zext(sext(5))

<code>ChainIndex</code> The index to UserChain. ChainIndex is initially UserChain.size() - 1, and is decremented during the recursion.

Definition at line <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp/#l00302">302</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp">SeparateConstOffsetFromGEP.cpp</a>.
</MemberDefinition>

### find() {#a7b43ed82204cf5a8d8508f6caa62f71e}

<MemberDefinition
  prototype={<>APInt ConstantOffsetExtractor::find (<a href="/docs/api/classes/llvm/value">Value</a> &#42; V, bool SignExtended, bool ZeroExtended, bool NonNegative)</>}>
Searches the expression that computes V for a non-zero constant C s.t.

V can be reassociated into the form V&#39; + C. If the searching is successful, returns C and update UserChain as a def-use chain from C to V; otherwise, UserChain is empty.

<code>V</code> The given expression <code>SignExtended</code> Whether V will be sign-extended in the computation of the GEP index <code>ZeroExtended</code> Whether V will be zero-extended in the computation of the GEP index <code>NonNegative</code> Whether V is guaranteed to be non-negative. For example, an index of an inbounds GEP is guaranteed to be non-negative. Levaraging this, we can better split inbounds GEPs.

Definition at line <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp/#l00264">264</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp">SeparateConstOffsetFromGEP.cpp</a>.
</MemberDefinition>

### findInEitherOperand() {#a57fabe3822ccf25985ef25e631ee3ccd}

<MemberDefinition
  prototype={<>APInt ConstantOffsetExtractor::findInEitherOperand (<a href="/docs/api/classes/llvm/binaryoperator">BinaryOperator</a> &#42; BO, bool SignExtended, bool ZeroExtended)</>}>
A helper function to look into both operands of a binary operator.

Definition at line <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp/#l00267">267</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp">SeparateConstOffsetFromGEP.cpp</a>.
</MemberDefinition>

### rebuildWithoutConstOffset() {#a78959368b08ec9f83d62069638155baf}

<MemberDefinition
  prototype={<>Value &#42; ConstantOffsetExtractor::rebuildWithoutConstOffset ()</>}>
After finding the constant offset C from the GEP index I, we build a new index I&#39; s.t.

I&#39; + C = I. This function builds and returns the new index I&#39; according to UserChain produced by function &quot;find&quot;.

The building conceptually takes two steps: 1) iteratively distribute s/zext towards the leaves of the expression tree that computes I 2) reassociate the expression tree to the form I&#39; + C.

For example, to extract the 5 from sext(a + (b + 5)), we first distribute sext to a, b and 5 so that we have sext(a) + (sext(b) + 5). Then, we reassociate it to (sext(a) + sext(b)) + 5. Given this form, we know I&#39; is sext(a) + sext(b).

Definition at line <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp/#l00285">285</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp">SeparateConstOffsetFromGEP.cpp</a>.
</MemberDefinition>

### removeConstOffset() {#a2694526eb3294698abfd547a63429a32}

<MemberDefinition
  prototype={<>Value &#42; ConstantOffsetExtractor::removeConstOffset (unsigned ChainIndex)</>}>
Reassociates the GEP index to the form I&#39; + C and returns I&#39;.

Definition at line <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp/#l00305">305</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp">SeparateConstOffsetFromGEP.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Private Member Attributes

### DL {#a6dcfbde4b78703662d54658387268cfc}

<MemberDefinition
  prototype={<>const DataLayout&amp; anonymous&#95;namespace&#123;SeparateConstOffsetFromGEP.cpp&#125;::ConstantOffsetExtractor::DL</>}>

Definition at line <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp/#l00337">337</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp">SeparateConstOffsetFromGEP.cpp</a>.
</MemberDefinition>

### ExtInsts {#af3e3847ac4a5a018d2152ac912c1e28d}

<MemberDefinition
  prototype={<>SmallVector&lt;CastInst &#42;, 16&gt; anonymous&#95;namespace&#123;SeparateConstOffsetFromGEP.cpp&#125;::ConstantOffsetExtractor::ExtInsts</>}>
A data structure used in rebuildWithoutConstOffset.

Contains all sext/zext instructions along UserChain.

Definition at line <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp/#l00332">332</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp">SeparateConstOffsetFromGEP.cpp</a>.
</MemberDefinition>

### IP {#aa948ae88ae245e1e9cd2b674a41743e0}

<MemberDefinition
  prototype={<>BasicBlock::iterator anonymous&#95;namespace&#123;SeparateConstOffsetFromGEP.cpp&#125;::ConstantOffsetExtractor::IP</>}>
Insertion position of cloned instructions.

Definition at line <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp/#l00335">335</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp">SeparateConstOffsetFromGEP.cpp</a>.
</MemberDefinition>

### UserChain {#ad0114f230694b36b1e009ab3424bc216}

<MemberDefinition
  prototype={<>SmallVector&lt;User &#42;, 8&gt; anonymous&#95;namespace&#123;SeparateConstOffsetFromGEP.cpp&#125;::ConstantOffsetExtractor::UserChain</>}>
The path from the constant offset to the old GEP index.

e.g., if the GEP index is &quot;a &#42; b + (c + 5)&quot;. After running function find, UserChain&#91;0&#93; will be the constant 5, UserChain&#91;1&#93; will be the subexpression &quot;c + 5&quot;, and UserChain&#91;2&#93; will be the entire expression &quot;a &#42; b + (c + 5)&quot;.

This path helps to rebuild the new GEP index.

Definition at line <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp/#l00328">328</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp">SeparateConstOffsetFromGEP.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Public Static Functions

### Extract() {#a867434c3e87f84340731c31c5e1b863d}

<MemberDefinition
  prototype={<>Value &#42; ConstantOffsetExtractor::Extract (<a href="/docs/api/classes/llvm/value">Value</a> &#42; Idx, <a href="/docs/api/classes/llvm/getelementptrinst">GetElementPtrInst</a> &#42; GEP, <a href="/docs/api/classes/llvm/user">User</a> &#42;&amp; UserChainTail)</>}
  labels = {["static"]}>
Extracts a constant offset from the given GEP index.

It returns the new index representing the remainder (equal to the original index minus the constant offset), or nullptr if we cannot extract a constant offset. <code>Idx</code> The given GEP index <code>GEP</code> The given GEP <code>UserChainTail</code> Outputs the tail of UserChain so that we can garbage-collect unused instructions in UserChain.

Definition at line <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp/#l00238">238</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp">SeparateConstOffsetFromGEP.cpp</a>.
</MemberDefinition>

### Find() {#aaffc55116f7466c3676d8852dc95175d}

<MemberDefinition
  prototype={<>int64&#95;t ConstantOffsetExtractor::Find (<a href="/docs/api/classes/llvm/value">Value</a> &#42; Idx, <a href="/docs/api/classes/llvm/getelementptrinst">GetElementPtrInst</a> &#42; GEP)</>}
  labels = {["static"]}>
Looks for a constant offset from the given GEP index without extracting it.

It returns the numeric value of the extracted constant offset (0 if failed). The meaning of the arguments are the same as Extract.

Definition at line <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp/#l00244">244</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp">SeparateConstOffsetFromGEP.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<hr/>

The documentation for this class was generated from the following file:

<ul>
<li><a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/separateconstoffsetfromgep-cpp">SeparateConstOffsetFromGEP.cpp</a></li>
</ul>

</DoxygenPage>
