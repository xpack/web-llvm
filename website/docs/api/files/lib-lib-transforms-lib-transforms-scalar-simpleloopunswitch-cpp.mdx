---

# DO NOT EDIT!
# Automatically generated via docusaurus-plugin-doxygen by Doxygen.

slug: /api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp
custom_edit_url: null
keywords:
  - doxygen
  - reference
  - file

---

import Link from '@docusaurus/Link'

import CodeLine from '@xpack/docusaurus-plugin-doxygen/components/CodeLine'
import DoxygenPage from '@xpack/docusaurus-plugin-doxygen/components/DoxygenPage'
import Highlight from '@xpack/docusaurus-plugin-doxygen/components/Highlight'
import IncludesList from '@xpack/docusaurus-plugin-doxygen/components/IncludesList'
import IncludesListItem from '@xpack/docusaurus-plugin-doxygen/components/IncludesListItem'
import MemberDefinition from '@xpack/docusaurus-plugin-doxygen/components/MemberDefinition'
import MembersIndex from '@xpack/docusaurus-plugin-doxygen/components/MembersIndex'
import MembersIndexItem from '@xpack/docusaurus-plugin-doxygen/components/MembersIndexItem'
import ProgramListing from '@xpack/docusaurus-plugin-doxygen/components/ProgramListing'
import SectionDefinition from '@xpack/docusaurus-plugin-doxygen/components/SectionDefinition'

import pluginConfig from '@site/docusaurus-plugin-doxygen-config.json'

# The `SimpleLoopUnswitch.cpp` File Reference

<DoxygenPage pluginConfig={pluginConfig}>



## Included Headers

<IncludesList>
<IncludesListItem
  filePath="llvm/Transforms/Scalar/SimpleLoopUnswitch.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/scalar/simpleloopunswitch-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/DenseMap.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/densemap-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/STLExtras.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/stlextras-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/Sequence.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/sequence-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SetVector.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/setvector-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SmallPtrSet.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/smallptrset-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SmallVector.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/smallvector-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/Statistic.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/Twine.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/twine-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/AssumptionCache.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/assumptioncache-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/BlockFrequencyInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/blockfrequencyinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/CFG.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/cfg-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/CodeMetrics.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/codemetrics-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/DomTreeUpdater.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/domtreeupdater-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/GuardUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/guardutils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/LoopAnalysisManager.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/loopanalysismanager-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/LoopInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/loopinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/LoopIterator.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/loopiterator-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/MemorySSA.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/memoryssa-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/MemorySSAUpdater.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/memoryssaupdater-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/MustExecute.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/mustexecute-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/ProfileSummaryInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/profilesummaryinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/ScalarEvolution.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/scalarevolution-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/TargetTransformInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/targettransforminfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/ValueTracking.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/valuetracking-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/BasicBlock.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/basicblock-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Constant.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/constant-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Constants.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/constants-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Dominators.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/dominators-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Function.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/function-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/IRBuilder.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/irbuilder-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/InstrTypes.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/instrtypes-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Instruction.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/instruction-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Instructions.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/instructions-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/IntrinsicInst.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/intrinsicinst-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Module.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/module-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/PatternMatch.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/patternmatch-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/ProfDataUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/profdatautils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Use.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/use-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Value.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/value-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/Casting.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/casting-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/CommandLine.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/Debug.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/debug-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/ErrorHandling.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/errorhandling-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/GenericDomTree.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/genericdomtree-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/InstructionCost.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/instructioncost-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/raw_ostream.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/raw-ostream-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Scalar/LoopPassManager.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/scalar/looppassmanager-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/BasicBlockUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/basicblockutils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/Cloning.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/cloning-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/Local.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/local-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/LoopUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/looputils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/ValueMapper.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/valuemapper-h"
  isLocal="true" />
<IncludesListItem
  filePath="algorithm"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="cassert"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="iterator"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="numeric"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="optional"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="utility"
  permalink=""
  isLocal="false" />
</IncludesList>

## Namespaces Index

<MembersIndex>

<MembersIndexItem
  type="namespace"
  name={<><a href="/docs/api/namespaces/anonymous-simpleloopunswitch-cpp-">anonymous&#123;SimpleLoopUnswitch.cpp&#125;</a></>}>
</MembersIndexItem>

</MembersIndex>

## Classes Index

<MembersIndex>

<MembersIndexItem
  type="struct"
  name={<><a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc">CompareDesc</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type="struct"
  name={<><a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant">InjectedInvariant</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type="struct"
  name={<><a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate">NonTrivialUnswitchCandidate</a></>}>
</MembersIndexItem>

</MembersIndex>

## Functions Index

<MembersIndex>

<MembersIndexItem
  type="bool"
  name={<><a href="#a98ebfee3c290028ee7875184aac567ce">areLoopExitPHIsLoopInvariant</a> (const Loop &amp;L, const BasicBlock &amp;ExitingBB, const BasicBlock &amp;ExitBB)</>}>
<a href="/docs/api/namespaces/llvm/check">Check</a> that all the LCSSA PHI nodes in the loop exit block have trivial incoming values along this edge. <a href="#a98ebfee3c290028ee7875184aac567ce">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;</>}
  name={<><a href="#aea49493e2ae224d30cda2b3235d180b0">buildClonedLoopBlocks</a> (Loop &amp;L, BasicBlock &#42;LoopPH, BasicBlock &#42;SplitBB, ArrayRef&lt; BasicBlock &#42; &gt; ExitBlocks, BasicBlock &#42;ParentBB, BasicBlock &#42;UnswitchedSuccBB, BasicBlock &#42;ContinueSuccBB, const SmallDenseMap&lt; BasicBlock &#42;, BasicBlock &#42;, 16 &gt; &amp;DominatingSucc, ValueToValueMapTy &amp;VMap, SmallVectorImpl&lt; DominatorTree::UpdateType &gt; &amp;DTUpdates, AssumptionCache &amp;AC, DominatorTree &amp;DT, LoopInfo &amp;LI, MemorySSAUpdater &#42;MSSAU, ScalarEvolution &#42;SE)</>}>
Build the cloned blocks for an unswitched copy of the given loop. <a href="#aea49493e2ae224d30cda2b3235d180b0">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#afe5225e90ea8896cab9cda7246af413d">buildClonedLoops</a> (Loop &amp;OrigL, ArrayRef&lt; BasicBlock &#42; &gt; ExitBlocks, const ValueToValueMapTy &amp;VMap, LoopInfo &amp;LI, SmallVectorImpl&lt; Loop &#42; &gt; &amp;NonChildClonedLoops)</>}>
Build the cloned loops of an original loop from unswitching. <a href="#afe5225e90ea8896cab9cda7246af413d">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a0eaf12b7854445670a7b0af3fe87b86c">buildPartialInvariantUnswitchConditionalBranch</a> (BasicBlock &amp;BB, ArrayRef&lt; Value &#42; &gt; ToDuplicate, bool Direction, BasicBlock &amp;UnswitchedSucc, BasicBlock &amp;NormalSucc, Loop &amp;L, MemorySSAUpdater &#42;MSSAU)</>}>
Copy a set of loop invariant values, and conditionally branch on them. <a href="#a0eaf12b7854445670a7b0af3fe87b86c">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a45b06cc0aa3a6fcbace0aacf3b25a9e6">buildPartialUnswitchConditionalBranch</a> (BasicBlock &amp;BB, ArrayRef&lt; Value &#42; &gt; Invariants, bool Direction, BasicBlock &amp;UnswitchedSucc, BasicBlock &amp;NormalSucc, bool InsertFreeze, const Instruction &#42;I, AssumptionCache &#42;AC, const DominatorTree &amp;DT)</>}>
Copy a set of loop invariant values <code>ToDuplicate</code> and insert them at the end of <code>BB</code> and conditionally branch on the copied condition. <a href="#a45b06cc0aa3a6fcbace0aacf3b25a9e6">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="int"
  name={<><a href="#a0e686f0d790f0fd925a036c4cb50199b">CalculateUnswitchCostMultiplier</a> (const Instruction &amp;TI, const Loop &amp;L, const LoopInfo &amp;LI, const DominatorTree &amp;DT, ArrayRef&lt; NonTrivialUnswitchCandidate &gt; UnswitchCandidates)</>}>
<a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a> multiplier is a way to limit potentially exponential behavior of loop-unswitch. <a href="#a0e686f0d790f0fd925a036c4cb50199b">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a94bc2ff14a27583461b207499f426ee2">canonicalizeForInvariantConditionInjection</a> (CmpPredicate &amp;Pred, Value &#42;&amp;LHS, Value &#42;&amp;RHS, BasicBlock &#42;&amp;IfTrue, BasicBlock &#42;&amp;IfFalse, const Loop &amp;L)</>}>
Tries to canonicalize condition described by: <a href="#a94bc2ff14a27583461b207499f426ee2">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/loop">Loop</a> &#42;</>}
  name={<><a href="#af747cc9f106d837a03d08bd395ede216">cloneLoopNest</a> (Loop &amp;OrigRootL, Loop &#42;RootParentL, const ValueToValueMapTy &amp;VMap, LoopInfo &amp;LI)</>}>
Recursively clone the specified loop and all of its children. <a href="#af747cc9f106d837a03d08bd395ede216">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/tinyptrvector">TinyPtrVector</a>&lt; <a href="/docs/api/classes/llvm/value">Value</a> &#42; &gt;</>}
  name={<><a href="#a1061b839196c8068b89d05aced41de29">collectHomogenousInstGraphLoopInvariants</a> (const Loop &amp;L, Instruction &amp;Root, const LoopInfo &amp;LI)</>}>
Collect all of the loop invariant input values transitively used by the homogeneous instruction graph from a given root. <a href="#a1061b839196c8068b89d05aced41de29">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a7737deb6a166cd21dc8465bb48f110b2">collectUnswitchCandidates</a> (SmallVectorImpl&lt; NonTrivialUnswitchCandidate &gt; &amp;UnswitchCandidates, IVConditionInfo &amp;PartialIVInfo, Instruction &#42;&amp;PartialIVCondBranch, const Loop &amp;L, const LoopInfo &amp;LI, AAResults &amp;AA, const MemorySSAUpdater &#42;MSSAU)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a607c1e689b230ff38733bfc0bfd3b6da">collectUnswitchCandidatesWithInjections</a> (SmallVectorImpl&lt; NonTrivialUnswitchCandidate &gt; &amp;UnswitchCandidates, IVConditionInfo &amp;PartialIVInfo, Instruction &#42;&amp;PartialIVCondBranch, Loop &amp;L, const DominatorTree &amp;DT, const LoopInfo &amp;LI, AAResults &amp;AA, const MemorySSAUpdater &#42;MSSAU)</>}>
Collect unswitch candidates by invariant conditions that are not immediately present in the loop. <a href="#a607c1e689b230ff38733bfc0bfd3b6da">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/instructioncost">InstructionCost</a></>}
  name={<><a href="#a78a15f5bff768264b9e435e319db18f3">computeDomSubtreeCost</a> (DomTreeNode &amp;N, const SmallDenseMap&lt; BasicBlock &#42;, InstructionCost, 4 &gt; &amp;BBCostMap, SmallDenseMap&lt; DomTreeNode &#42;, InstructionCost, 4 &gt; &amp;DTCostMap)</>}>
Recursively compute the cost of a dominator subtree based on the per-block cost map provided. <a href="#a78a15f5bff768264b9e435e319db18f3">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#aeabcdff1c388af9ac5a98f1ec4ba2471">deleteDeadBlocksFromLoop</a> (Loop &amp;L, SmallVectorImpl&lt; BasicBlock &#42; &gt; &amp;ExitBlocks, DominatorTree &amp;DT, LoopInfo &amp;LI, MemorySSAUpdater &#42;MSSAU, ScalarEvolution &#42;SE, LPMUpdater &amp;LoopUpdater)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a13971a178ec8248ecf4b0a903c4db1c6">deleteDeadClonedBlocks</a> (Loop &amp;L, ArrayRef&lt; BasicBlock &#42; &gt; ExitBlocks, ArrayRef&lt; std::unique&#95;ptr&lt; ValueToValueMapTy &gt; &gt; VMaps, DominatorTree &amp;DT, MemorySSAUpdater &#42;MSSAU)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="NonTrivialUnswitchCandidate"
  name={<><a href="#a52374e76082ee94158724e5695a88a02">findBestNonTrivialUnswitchCandidate</a> (ArrayRef&lt; NonTrivialUnswitchCandidate &gt; UnswitchCandidates, const Loop &amp;L, const DominatorTree &amp;DT, const LoopInfo &amp;LI, AssumptionCache &amp;AC, const TargetTransformInfo &amp;TTI, const IVConditionInfo &amp;PartialIVInfo)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/loop">Loop</a> &#42;</>}
  name={<><a href="#a5e771bd40bbd3121ec36a96aa44ef46a">getTopMostExitingLoop</a> (const BasicBlock &#42;ExitBB, const LoopInfo &amp;LI)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#afa8d35023dc30883011a5641eac69d38">hoistLoopToNewParent</a> (Loop &amp;L, BasicBlock &amp;Preheader, DominatorTree &amp;DT, LoopInfo &amp;LI, MemorySSAUpdater &#42;MSSAU, ScalarEvolution &#42;SE)</>}>
Hoist the current loop up to the innermost loop containing a remaining exit. <a href="#afa8d35023dc30883011a5641eac69d38">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="NonTrivialUnswitchCandidate"
  name={<><a href="#aa8f270ce4d001ee9e7839aa11c607931">injectPendingInvariantConditions</a> (NonTrivialUnswitchCandidate Candidate, Loop &amp;L, DominatorTree &amp;DT, LoopInfo &amp;LI, AssumptionCache &amp;AC, MemorySSAUpdater &#42;MSSAU)</>}>
Materialize pending invariant condition of the given candidate into IR. <a href="#aa8f270ce4d001ee9e7839aa11c607931">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a9ba70601e2398b462375dd8f3e9bc1b2">insertCandidatesWithPendingInjections</a> (SmallVectorImpl&lt; NonTrivialUnswitchCandidate &gt; &amp;UnswitchCandidates, Loop &amp;L, ICmpInst::Predicate Pred, ArrayRef&lt; CompareDesc &gt; Compares, const DominatorTree &amp;DT)</>}>
Given chain of loop branch conditions looking like: br (Variant &lt; Invariant1) br (Variant &lt; Invariant2) br (Variant &lt; Invariant3) ... collect set of invariant conditions on which we want to unswitch, which look like: Invariant1 &lt;= Invariant2 Invariant2 &lt;= Invariant3 ... Though they might not immediately exist in the IR, we can still inject them. <a href="#a9ba70601e2398b462375dd8f3e9bc1b2">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a41cbe08b01edbedddb8d8706d13c5270">isSafeForNoNTrivialUnswitching</a> (Loop &amp;L, LoopInfo &amp;LI)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a45007554e260296266b8ae927dde223f">postUnswitch</a> (Loop &amp;L, LPMUpdater &amp;U, StringRef LoopName, bool CurrentLoopValid, bool PartiallyInvariant, bool InjectedCondition, ArrayRef&lt; Loop &#42; &gt; NewLoops)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#ab79f3dcf9607c6a8908cda57cc964f49">rebuildLoopAfterUnswitch</a> (Loop &amp;L, ArrayRef&lt; BasicBlock &#42; &gt; ExitBlocks, LoopInfo &amp;LI, SmallVectorImpl&lt; Loop &#42; &gt; &amp;HoistedLoops, ScalarEvolution &#42;SE)</>}>
Rebuild a loop after unswitching removes some subset of blocks and edges. <a href="#ab79f3dcf9607c6a8908cda57cc964f49">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet</a>&lt; <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;, 16 &gt;</>}
  name={<><a href="#a0c9b0aa6fff67d00a95f47fc121491e5">recomputeLoopBlockSet</a> (Loop &amp;L, LoopInfo &amp;LI)</>}>
Recompute the set of blocks in a loop after unswitching. <a href="#a0c9b0aa6fff67d00a95f47fc121491e5">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a669b909f685098d484bb789192620885">replaceLoopInvariantUses</a> (const Loop &amp;L, Value &#42;Invariant, Constant &amp;Replacement)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a9a1db01205f9a51a14b99e53e3068da1">rewritePHINodesForExitAndUnswitchedBlocks</a> (BasicBlock &amp;ExitBB, BasicBlock &amp;UnswitchedBB, BasicBlock &amp;OldExitingBB, BasicBlock &amp;OldPH, bool FullUnswitch)</>}>
Rewrite the PHI nodes in the loop exit basic block and the split off unswitched block. <a href="#a9a1db01205f9a51a14b99e53e3068da1">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a003a854484a7b23c151bc0b3d684e5d9">rewritePHINodesForUnswitchedExitBlock</a> (BasicBlock &amp;UnswitchedBB, BasicBlock &amp;OldExitingBB, BasicBlock &amp;OldPH)</>}>
Rewrite the PHI nodes in an unswitched loop exit basic block. <a href="#a003a854484a7b23c151bc0b3d684e5d9">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a81f9271273f74a220003075573119a05">shouldInsertFreeze</a> (Loop &amp;L, Instruction &amp;TI, DominatorTree &amp;DT, AssumptionCache &amp;AC)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#af08d593d99b84298decf28611dd32f50">shouldTryInjectBasingOnMetadata</a> (const BranchInst &#42;BI, const BasicBlock &#42;TakenSucc)</>}>
Returns true, if metadata on <code>BI</code> allows us to optimize branching into <code>TakenSucc</code> via injection of invariant conditions. <a href="#af08d593d99b84298decf28611dd32f50">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a4cbb86574a065a122292322ed4e27b0e">shouldTryInjectInvariantCondition</a> (const ICmpInst::Predicate Pred, const Value &#42;LHS, const Value &#42;RHS, const BasicBlock &#42;IfTrue, const BasicBlock &#42;IfFalse, const Loop &amp;L)</>}>
Returns true, if predicate described by ( <code>Pred</code>, <code>LHS</code>, <code>RHS</code> ) succeeding into blocks ( <code>IfTrue</code>, <code>IfFalse</code>) can be optimized by injecting a loop-invariant condition. <a href="#a4cbb86574a065a122292322ed4e27b0e">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/value">Value</a> &#42;</>}
  name={<><a href="#a5ca2e820d1b5a49dcaad5e6873917198">skipTrivialSelect</a> (Value &#42;Cond)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#ad5b466cbd242079ab18347e5248fd1b9">STATISTIC</a> (NumBranches, &quot;Number of branches unswitched&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#ab3ab9463ab2f6721ceff43efa0ba37e5">STATISTIC</a> (NumSwitches, &quot;Number of switches unswitched&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#a5b42a29a9e74c94c6d7826358ff0cf51">STATISTIC</a> (NumSelects, &quot;Number of selects turned into branches for unswitching&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#a825e9b46eaa40a5853a43f520d9b3a9d">STATISTIC</a> (NumGuards, &quot;Number of guards turned into branches for unswitching&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#aa6e446decc15b9df1996f94f20798fbf">STATISTIC</a> (NumTrivial, &quot;Number of unswitches that are trivial&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#a91923c5ac786f070c692a9ae19983ecb">STATISTIC</a> (NumCostMultiplierSkipped, &quot;Number of unswitch candidates that had their cost multiplier skipped&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#ab781a25844101ae293fa4d6e9f27902f">STATISTIC</a> (NumInvariantConditionsInjected, &quot;Number of invariant conditions injected and unswitched&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;</>}
  name={<><a href="#af3ac46dde637293a34d0ff7b619a656b">turnGuardIntoBranch</a> (IntrinsicInst &#42;GI, Loop &amp;L, DominatorTree &amp;DT, LoopInfo &amp;LI, MemorySSAUpdater &#42;MSSAU)</>}>
Turns a llvm.experimental.guard intrinsic into implicit control flow branch, making the following replacement: <a href="#af3ac46dde637293a34d0ff7b619a656b">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;</>}
  name={<><a href="#a2e6301db15e4516c92e21f33761886c6">turnSelectIntoBranch</a> (SelectInst &#42;SI, DominatorTree &amp;DT, LoopInfo &amp;LI, MemorySSAUpdater &#42;MSSAU, AssumptionCache &#42;AC)</>}>
Turns a select instruction into implicit control flow branch, making the following replacement: <a href="#a2e6301db15e4516c92e21f33761886c6">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a050cc2b2d1467ffcad6a825f1141424c">unswitchAllTrivialConditions</a> (Loop &amp;L, DominatorTree &amp;DT, LoopInfo &amp;LI, ScalarEvolution &#42;SE, MemorySSAUpdater &#42;MSSAU)</>}>
This routine scans the loop to find a branch or switch which occurs before any side effects occur. <a href="#a050cc2b2d1467ffcad6a825f1141424c">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#acc20b8effcbe869069ff973354344872">unswitchBestCondition</a> (Loop &amp;L, DominatorTree &amp;DT, LoopInfo &amp;LI, AssumptionCache &amp;AC, AAResults &amp;AA, TargetTransformInfo &amp;TTI, ScalarEvolution &#42;SE, MemorySSAUpdater &#42;MSSAU, LPMUpdater &amp;LoopUpdater)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a00b3b7cedd83de61be0312c6535f3f37">unswitchLoop</a> (Loop &amp;L, DominatorTree &amp;DT, LoopInfo &amp;LI, AssumptionCache &amp;AC, AAResults &amp;AA, TargetTransformInfo &amp;TTI, bool Trivial, bool NonTrivial, ScalarEvolution &#42;SE, MemorySSAUpdater &#42;MSSAU, ProfileSummaryInfo &#42;PSI, BlockFrequencyInfo &#42;BFI, LPMUpdater &amp;LoopUpdater)</>}>
Unswitch control flow predicated on loop invariant conditions. <a href="#a00b3b7cedd83de61be0312c6535f3f37">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#aae4261fb86bc9023c3383785afa66b9a">unswitchNontrivialInvariants</a> (Loop &amp;L, Instruction &amp;TI, ArrayRef&lt; Value &#42; &gt; Invariants, IVConditionInfo &amp;PartialIVInfo, DominatorTree &amp;DT, LoopInfo &amp;LI, AssumptionCache &amp;AC, ScalarEvolution &#42;SE, MemorySSAUpdater &#42;MSSAU, LPMUpdater &amp;LoopUpdater, bool InsertFreeze, bool InjectedCondition)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a6a082aa2e05f44f7dab89e2ff8c582ff">unswitchTrivialBranch</a> (Loop &amp;L, BranchInst &amp;BI, DominatorTree &amp;DT, LoopInfo &amp;LI, ScalarEvolution &#42;SE, MemorySSAUpdater &#42;MSSAU)</>}>
Unswitch a trivial branch if the condition is loop invariant. <a href="#a6a082aa2e05f44f7dab89e2ff8c582ff">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#aadf6036e1d19c8ba91242af6ec48d40b">unswitchTrivialSwitch</a> (Loop &amp;L, SwitchInst &amp;SI, DominatorTree &amp;DT, LoopInfo &amp;LI, ScalarEvolution &#42;SE, MemorySSAUpdater &#42;MSSAU)</>}>
Unswitch a trivial switch if the condition is loop invariant. <a href="#aadf6036e1d19c8ba91242af6ec48d40b">More...</a>
</MembersIndexItem>

<MembersIndexItem
  template={<>template &lt;typename CallableT&gt;</>}
  type="void"
  name={<><a href="#a18b0f192065386f9e0bc793a08bbf3ff">visitDomSubTree</a> (DominatorTree &amp;DT, BasicBlock &#42;BB, CallableT Callable)</>}>
Helper to visit a dominator subtree, invoking a callable on each node. <a href="#a18b0f192065386f9e0bc793a08bbf3ff">More...</a>
</MembersIndexItem>

</MembersIndex>

## Variables Index

<MembersIndex>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#aab1355fa0b9b124a5424d170db011c9e">DropNonTrivialImplicitNullChecks</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a08f48517d908cdf7a21eed936deb7f7c">EnableNonTrivialUnswitch</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a58389dda20e5bd529f3fb18c6531c7ce">EnableUnswitchCostMultiplier</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a777551c6c08e4e3588b36665a8572414">FreezeLoopUnswitchCond</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#aad5d88dba5221d4277024edf98cec9ac">InjectInvariantConditionHotnesThreshold</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a777260b6a90536fc8e2d844a891eddb5">InjectInvariantConditions</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#a93f97c549049a827518c9bce17a53833">MSSAThreshold</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a0986070d3233b98011a6bd838a65f1cb">UnswitchGuards</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; int &gt;</>}
  name={<><a href="#a49834115bcfb38ad510305e2e587f67a">UnswitchNumInitialUnscaledCandidates</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; int &gt;</>}
  name={<><a href="#a8ec915a44f00522e05af0372fe598372">UnswitchSiblingsToplevelDiv</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; int &gt;</>}
  name={<><a href="#a639210c26d1952e9108bcdbb0353443b">UnswitchThreshold</a></>}>
</MembersIndexItem>

</MembersIndex>

## Defines Index

<MembersIndex>

<MembersIndexItem
  type="#define"
  name={<><a href="#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>&nbsp;&nbsp;&nbsp;&quot;simple-loop-unswitch&quot;</>}>
===- <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a> - Hoist loop-invariant control flow ------â€”===// <a href="#ad78e062f62e0d6e453941fb4ca843e4d">More...</a>
</MembersIndexItem>

</MembersIndex>


<SectionDefinition>

## Functions

### areLoopExitPHIsLoopInvariant() {#a98ebfee3c290028ee7875184aac567ce}

<MemberDefinition
  prototype={<>static bool areLoopExitPHIsLoopInvariant (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp; ExitingBB, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp; ExitBB)</>}
  labels = {["static"]}>
<a href="/docs/api/namespaces/llvm/check">Check</a> that all the LCSSA PHI nodes in the loop exit block have trivial incoming values along this edge.

Definition at line <a href="#l00252">252</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### buildClonedLoopBlocks() {#aea49493e2ae224d30cda2b3235d180b0}

<MemberDefinition
  prototype={<>static BasicBlock &#42; buildClonedLoopBlocks (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; LoopPH, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; SplitBB, <a href="/docs/api/classes/llvm/arrayref">ArrayRef</a>&lt; <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; &gt; ExitBlocks, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; ParentBB, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; UnswitchedSuccBB, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; ContinueSuccBB, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap</a>&lt; <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;, 16 &gt; &amp; DominatingSucc, <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp; VMap, <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt; DominatorTree::UpdateType &gt; &amp; DTUpdates, <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &amp; AC, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42; MSSAU, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42; SE)</>}
  labels = {["static"]}>
Build the cloned blocks for an unswitched copy of the given loop.

The cloned blocks are inserted before the loop preheader (<code>LoopPH</code>) and after the split block (<code>SplitBB</code>) that will be used to select between the cloned and original loop.

This routine handles cloning all of the necessary loop blocks and exit blocks including rewriting their instructions and the relevant PHI nodes. <a href="/docs/api/classes/llvm/any">Any</a> loop blocks or exit blocks which are dominated by a different successor than the one for this clone of the loop blocks can be trivially skipped. We use the <code>DominatingSucc</code> map to determine whether a block satisfies that property with a simple map lookup.

It also correctly creates the unconditional branch in the cloned unswitched parent block to only point at the unswitched successor.

This does not handle most of the necessary updates to <code><a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a></code>. Only exit block splitting is correctly reflected in <code><a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a></code>, essentially all of the cloned blocks (and their loops) are left without full <code><a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a></code> updates. This also doesn&#39;t fully update <code><a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a></code>. It adds the cloned blocks to them but doesn&#39;t create the cloned <code><a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a></code> structure and instead the caller must recompute an accurate DT. It <em>does</em> correctly update the <code><a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a></code> provided in <code>AC</code>.

Definition at line <a href="#l01166">1166</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### buildClonedLoops() {#afe5225e90ea8896cab9cda7246af413d}

<MemberDefinition
  prototype={<>static void buildClonedLoops (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; OrigL, <a href="/docs/api/classes/llvm/arrayref">ArrayRef</a>&lt; <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; &gt; ExitBlocks, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp; VMap, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI, <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt; <a href="/docs/api/classes/llvm/loop">Loop</a> &#42; &gt; &amp; NonChildClonedLoops)</>}
  labels = {["static"]}>
Build the cloned loops of an original loop from unswitching.

Because unswitching simplifies the CFG of the loop, this isn&#39;t a trivial operation. We need to re-verify that there even is a loop (as the backedge may not have been cloned), and even if there are remaining backedges the backedge set may be different. However, we know that each child loop is undisturbed, we only need to find where to place each child loop within either any parent loop or within a cloned version of the original loop.

Because child loops may end up cloned outside of any cloned version of the original loop, multiple cloned sibling loops may be created. All of them are returned so that the newly introduced loop nest roots can be identified.

Definition at line <a href="#l01422">1422</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### buildPartialInvariantUnswitchConditionalBranch() {#a0eaf12b7854445670a7b0af3fe87b86c}

<MemberDefinition
  prototype={<>static void buildPartialInvariantUnswitchConditionalBranch (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp; BB, <a href="/docs/api/classes/llvm/arrayref">ArrayRef</a>&lt; <a href="/docs/api/classes/llvm/value">Value</a> &#42; &gt; ToDuplicate, bool Direction, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp; UnswitchedSucc, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp; NormalSucc, <a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42; MSSAU)</>}
  labels = {["static"]}>
Copy a set of loop invariant values, and conditionally branch on them.

Definition at line <a href="#l00292">292</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### buildPartialUnswitchConditionalBranch() {#a45b06cc0aa3a6fcbace0aacf3b25a9e6}

<MemberDefinition
  prototype={<>static void buildPartialUnswitchConditionalBranch (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp; BB, <a href="/docs/api/classes/llvm/arrayref">ArrayRef</a>&lt; <a href="/docs/api/classes/llvm/value">Value</a> &#42; &gt; Invariants, bool Direction, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp; UnswitchedSucc, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp; NormalSucc, bool InsertFreeze, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42; I, <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &#42; AC, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT)</>}
  labels = {["static"]}>
Copy a set of loop invariant values <code>ToDuplicate</code> and insert them at the end of <code>BB</code> and conditionally branch on the copied condition.

We only branch on a single value.

Definition at line <a href="#l00272">272</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### CalculateUnswitchCostMultiplier() {#a0e686f0d790f0fd925a036c4cb50199b}

<MemberDefinition
  prototype={<>static int CalculateUnswitchCostMultiplier (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp; TI, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/classes/llvm/arrayref">ArrayRef</a>&lt; NonTrivialUnswitchCandidate &gt; UnswitchCandidates)</>}
  labels = {["static"]}>
<a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a> multiplier is a way to limit potentially exponential behavior of loop-unswitch.

<a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a> is multipied in proportion of 2^number of unswitch candidates available. Also accounting for the number of &quot;sibling&quot; loops with the idea to account for previous unswitches that already happened on this cluster of loops. There was an attempt to keep this formula simple, just enough to limit the worst case behavior. Even if it is not that simple now it is still not an attempt to provide a detailed heuristic size prediction.

TODO: Make a proper accounting of &quot;explosion&quot; effect for all kinds of unswitch candidates, making adequate predictions instead of wild guesses. That requires knowing not just the number of &quot;remaining&quot; candidates but also costs of unswitching for each of these candidates.

Definition at line <a href="#l02818">2818</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### canonicalizeForInvariantConditionInjection() {#a94bc2ff14a27583461b207499f426ee2}

<MemberDefinition
  prototype={<>static void canonicalizeForInvariantConditionInjection (<a href="/docs/api/classes/llvm/cmppredicate">CmpPredicate</a> &amp; Pred, <a href="/docs/api/classes/llvm/value">Value</a> &#42;&amp; LHS, <a href="/docs/api/classes/llvm/value">Value</a> &#42;&amp; RHS, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;&amp; IfTrue, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;&amp; IfFalse, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L)</>}
  labels = {["static"]}>
Tries to canonicalize condition described by:

br (LHS pred RHS), label IfTrue, label IfFalse

into its equivalent where <code>Pred</code> is something that we support for injected invariants (so far it is limited to ult), LHS in canonicalized form is non-invariant and RHS is an invariant.

Definition at line <a href="#l02993">2993</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### cloneLoopNest() {#af747cc9f106d837a03d08bd395ede216}

<MemberDefinition
  prototype={<>static Loop &#42; cloneLoopNest (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; OrigRootL, <a href="/docs/api/classes/llvm/loop">Loop</a> &#42; RootParentL, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp; VMap, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI)</>}
  labels = {["static"]}>
Recursively clone the specified loop and all of its children.

The target parent loop for the clone should be provided, or can be null if the clone is a top-level loop. While cloning, all the blocks are mapped with the provided value map. The entire original loop must be present in the value map. The cloned loop is returned.

Definition at line <a href="#l01363">1363</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### collectHomogenousInstGraphLoopInvariants() {#a1061b839196c8068b89d05aced41de29}

<MemberDefinition
  prototype={<>static TinyPtrVector&lt; Value &#42; &gt; collectHomogenousInstGraphLoopInvariants (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp; Root, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI)</>}
  labels = {["static"]}>
Collect all of the loop invariant input values transitively used by the homogeneous instruction graph from a given root.

This essentially walks from a root recursively through loop variant operands which have perform the same logical operation (AND or OR) and finds all inputs which are loop invariant. For some operations these can be re-associated and unswitched out of the loop entirely.

Definition at line <a href="#l00193">193</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### collectUnswitchCandidates() {#a7737deb6a166cd21dc8465bb48f110b2}

<MemberDefinition
  prototype={<>static bool collectUnswitchCandidates (<a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt; NonTrivialUnswitchCandidate &gt; &amp; UnswitchCandidates, <a href="/docs/api/structs/llvm/ivconditioninfo">IVConditionInfo</a> &amp; PartialIVInfo, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;&amp; PartialIVCondBranch, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI, <a href="/docs/api/classes/llvm/aaresults">AAResults</a> &amp; AA, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42; MSSAU)</>}
  labels = {["static"]}>

Definition at line <a href="#l02897">2897</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### collectUnswitchCandidatesWithInjections() {#a607c1e689b230ff38733bfc0bfd3b6da}

<MemberDefinition
  prototype={<>static bool collectUnswitchCandidatesWithInjections (<a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt; NonTrivialUnswitchCandidate &gt; &amp; UnswitchCandidates, <a href="/docs/api/structs/llvm/ivconditioninfo">IVConditionInfo</a> &amp; PartialIVInfo, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;&amp; PartialIVCondBranch, <a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI, <a href="/docs/api/classes/llvm/aaresults">AAResults</a> &amp; AA, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42; MSSAU)</>}
  labels = {["static"]}>
Collect unswitch candidates by invariant conditions that are not immediately present in the loop.

However, they can be injected into the code if we decide it&#39;s profitable. An example of such conditions is following:

for (...) &#123; x = load ... if (! x &lt;u C1) break; if (! x &lt;u C2) break; &lt;do something&gt; &#125;

We can unswitch by condition &quot;C1 &lt;=u C2&quot;. If that is true, then &quot;x &lt;u C1 &lt;=
C2&quot; automatically implies &quot;x &lt;u C2&quot;, so we can get rid of one of loop-variant checks in unswitched loop version.

Definition at line <a href="#l03219">3219</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### computeDomSubtreeCost() {#a78a15f5bff768264b9e435e319db18f3}

<MemberDefinition
  prototype={<>static InstructionCost computeDomSubtreeCost (<a href="/docs/api/namespaces/llvm/#a58b9df85470fc4e2a8066ff6a62e5a34">DomTreeNode</a> &amp; N, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap</a>&lt; <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;, <a href="/docs/api/classes/llvm/instructioncost">InstructionCost</a>, 4 &gt; &amp; BBCostMap, <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap</a>&lt; <a href="/docs/api/namespaces/llvm/#a58b9df85470fc4e2a8066ff6a62e5a34">DomTreeNode</a> &#42;, <a href="/docs/api/classes/llvm/instructioncost">InstructionCost</a>, 4 &gt; &amp; DTCostMap)</>}
  labels = {["static"]}>
Recursively compute the cost of a dominator subtree based on the per-block cost map provided.

The recursive computation is memozied into the provided DT-indexed cost map to allow querying it for most nodes in the domtree without it becoming quadratic.

Definition at line <a href="#l02660">2660</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### deleteDeadBlocksFromLoop() {#aeabcdff1c388af9ac5a98f1ec4ba2471}

<MemberDefinition
  prototype={<>static void deleteDeadBlocksFromLoop (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt; <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; &gt; &amp; ExitBlocks, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42; MSSAU, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42; SE, <a href="/docs/api/classes/llvm/lpmupdater">LPMUpdater</a> &amp; LoopUpdater)</>}
  labels = {["static"]}>

Definition at line <a href="#l01701">1701</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### deleteDeadClonedBlocks() {#a13971a178ec8248ecf4b0a903c4db1c6}

<MemberDefinition
  prototype={<>static void deleteDeadClonedBlocks (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/arrayref">ArrayRef</a>&lt; <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; &gt; ExitBlocks, <a href="/docs/api/classes/llvm/arrayref">ArrayRef</a>&lt; std::unique&#95;ptr&lt; <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &gt; &gt; VMaps, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42; MSSAU)</>}
  labels = {["static"]}>

Definition at line <a href="#l01672">1672</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### findBestNonTrivialUnswitchCandidate() {#a52374e76082ee94158724e5695a88a02}

<MemberDefinition
  prototype={<>static NonTrivialUnswitchCandidate findBestNonTrivialUnswitchCandidate (<a href="/docs/api/classes/llvm/arrayref">ArrayRef</a>&lt; NonTrivialUnswitchCandidate &gt; UnswitchCandidates, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI, <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &amp; AC, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/targettransforminfo">TargetTransformInfo</a> &amp; TTI, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/structs/llvm/ivconditioninfo">IVConditionInfo</a> &amp; PartialIVInfo)</>}
  labels = {["static"]}>

Definition at line <a href="#l03317">3317</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### getTopMostExitingLoop() {#a5e771bd40bbd3121ec36a96aa44ef46a}

<MemberDefinition
  prototype={<>static Loop &#42; getTopMostExitingLoop (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; ExitBB, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI)</>}
  labels = {["static"]}>

Definition at line <a href="#l00480">480</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### hoistLoopToNewParent() {#afa8d35023dc30883011a5641eac69d38}

<MemberDefinition
  prototype={<>static void hoistLoopToNewParent (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp; Preheader, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42; MSSAU, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42; SE)</>}
  labels = {["static"]}>
Hoist the current loop up to the innermost loop containing a remaining exit.

Because we&#39;ve removed an exit from the loop, we may have changed the set of loops reachable and need to move the current loop up the loop nest or even to an entirely separate nest.

Definition at line <a href="#l00409">409</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### injectPendingInvariantConditions() {#aa8f270ce4d001ee9e7839aa11c607931}

<MemberDefinition
  prototype={<>static NonTrivialUnswitchCandidate injectPendingInvariantConditions (NonTrivialUnswitchCandidate Candidate, <a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI, <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &amp; AC, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42; MSSAU)</>}
  labels = {["static"]}>
Materialize pending invariant condition of the given candidate into IR.

The injected loop-invariant condition implies the original loop-variant branch condition, so the materialization turns

loop&#95;block: ... br i1 variant&#95;cond, label InLoopSucc, label OutOfLoopSucc

into

preheader: invariant&#95;cond = LHS pred RHS ... loop&#95;block: br i1 invariant&#95;cond, label InLoopSucc, label OriginalCheck OriginalCheck: br i1 variant&#95;cond, label InLoopSucc, label OutOfLoopSucc ...

Definition at line <a href="#l03083">3083</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### insertCandidatesWithPendingInjections() {#a9ba70601e2398b462375dd8f3e9bc1b2}

<MemberDefinition
  prototype={<>static bool insertCandidatesWithPendingInjections (<a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt; NonTrivialUnswitchCandidate &gt; &amp; UnswitchCandidates, <a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, ICmpInst::Predicate Pred, <a href="/docs/api/classes/llvm/arrayref">ArrayRef</a>&lt; CompareDesc &gt; Compares, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT)</>}
  labels = {["static"]}>
Given chain of loop branch conditions looking like: br (Variant &lt; Invariant1) br (Variant &lt; Invariant2) br (Variant &lt; Invariant3) ... collect set of invariant conditions on which we want to unswitch, which look like: Invariant1 &lt;= Invariant2 Invariant2 &lt;= Invariant3 ... Though they might not immediately exist in the IR, we can still inject them.

Definition at line <a href="#l03181">3181</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### isSafeForNoNTrivialUnswitching() {#a41cbe08b01edbedddb8d8706d13c5270}

<MemberDefinition
  prototype={<>static bool isSafeForNoNTrivialUnswitching (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI)</>}
  labels = {["static"]}>

Definition at line <a href="#l03274">3274</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### postUnswitch() {#a45007554e260296266b8ae927dde223f}

<MemberDefinition
  prototype={<>void postUnswitch (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/lpmupdater">LPMUpdater</a> &amp; U, <a href="/docs/api/classes/llvm/stringref">StringRef</a> LoopName, bool CurrentLoopValid, bool PartiallyInvariant, bool InjectedCondition, <a href="/docs/api/classes/llvm/arrayref">ArrayRef</a>&lt; <a href="/docs/api/classes/llvm/loop">Loop</a> &#42; &gt; NewLoops)</>}>

Definition at line <a href="#l02138">2138</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### rebuildLoopAfterUnswitch() {#ab79f3dcf9607c6a8908cda57cc964f49}

<MemberDefinition
  prototype={<>static bool rebuildLoopAfterUnswitch (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/arrayref">ArrayRef</a>&lt; <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; &gt; ExitBlocks, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI, <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt; <a href="/docs/api/classes/llvm/loop">Loop</a> &#42; &gt; &amp; HoistedLoops, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42; SE)</>}
  labels = {["static"]}>
Rebuild a loop after unswitching removes some subset of blocks and edges.

The removal may have removed some child loops entirely but cannot have disturbed any remaining child loops. However, they may need to be hoisted to the parent loop (or to be top-level loops). The original loop may be completely removed.

The sibling loops resulting from this update are returned. If the original loop remains a valid loop, it will be the first entry in this list with all of the newly sibling loops following it.

Returns true if the loop remains a loop after unswitching, and false if it is no longer a loop after unswitching (and should not continue to be referenced).

Definition at line <a href="#l01906">1906</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### recomputeLoopBlockSet() {#a0c9b0aa6fff67d00a95f47fc121491e5}

<MemberDefinition
  prototype={<>static SmallPtrSet&lt; const BasicBlock &#42;, 16 &gt; recomputeLoopBlockSet (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI)</>}
  labels = {["static"]}>
Recompute the set of blocks in a loop after unswitching.

This walks from the original headers predecessors to rebuild the loop. We take advantage of the fact that new blocks can&#39;t have been added, and so we filter by the original loop&#39;s blocks. This also handles potentially unreachable code that we don&#39;t want to explore but might be found examining the predecessors of the header.

If the original loop is no longer a loop, this will return an empty set. If it remains a loop, all the blocks within it will be added to the set (including those blocks in inner loops).

Definition at line <a href="#l01795">1795</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### replaceLoopInvariantUses() {#a669b909f685098d484bb789192620885}

<MemberDefinition
  prototype={<>static void replaceLoopInvariantUses (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/value">Value</a> &#42; Invariant, <a href="/docs/api/classes/llvm/constant">Constant</a> &amp; Replacement)</>}
  labels = {["static"]}>

Definition at line <a href="#l00235">235</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### rewritePHINodesForExitAndUnswitchedBlocks() {#a9a1db01205f9a51a14b99e53e3068da1}

<MemberDefinition
  prototype={<>static void rewritePHINodesForExitAndUnswitchedBlocks (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp; ExitBB, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp; UnswitchedBB, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp; OldExitingBB, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp; OldPH, bool FullUnswitch)</>}
  labels = {["static"]}>
Rewrite the PHI nodes in the loop exit basic block and the split off unswitched block.

Because the exit block remains an exit from the loop, this rewrites the LCSSA PHI nodes in it to remove the unswitched edge and introduces PHI nodes into the unswitched basic block to select between the value in the old preheader and the loop exit.

Definition at line <a href="#l00363">363</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### rewritePHINodesForUnswitchedExitBlock() {#a003a854484a7b23c151bc0b3d684e5d9}

<MemberDefinition
  prototype={<>static void rewritePHINodesForUnswitchedExitBlock (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp; UnswitchedBB, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp; OldExitingBB, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp; OldPH)</>}
  labels = {["static"]}>
Rewrite the PHI nodes in an unswitched loop exit basic block.

Requires that the loop exit and unswitched basic block are the same, and that the exiting block was a unique predecessor of that block. Rewrites the PHI nodes in that block such that what were LCSSA PHI nodes become trivial PHI nodes from the old preheader that now contains the unswitched terminator.

Definition at line <a href="#l00341">341</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### shouldInsertFreeze() {#a81f9271273f74a220003075573119a05}

<MemberDefinition
  prototype={<>static bool shouldInsertFreeze (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp; TI, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &amp; AC)</>}
  labels = {["static"]}>

Definition at line <a href="#l03474">3474</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### shouldTryInjectBasingOnMetadata() {#af08d593d99b84298decf28611dd32f50}

<MemberDefinition
  prototype={<>bool shouldTryInjectBasingOnMetadata (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42; BI, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; TakenSucc)</>}>
Returns true, if metadata on <code>BI</code> allows us to optimize branching into <code>TakenSucc</code> via injection of invariant conditions.

The branch should be not enough and not previously unswitched, the information about this comes from the metadata.

Definition at line <a href="#l03043">3043</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### shouldTryInjectInvariantCondition() {#a4cbb86574a065a122292322ed4e27b0e}

<MemberDefinition
  prototype={<>static bool shouldTryInjectInvariantCondition (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> ICmpInst::Predicate Pred, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/value">Value</a> &#42; LHS, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/value">Value</a> &#42; RHS, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; IfTrue, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; IfFalse, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L)</>}
  labels = {["static"]}>
Returns true, if predicate described by ( <code>Pred</code>, <code>LHS</code>, <code>RHS</code> ) succeeding into blocks ( <code>IfTrue</code>, <code>IfFalse</code>) can be optimized by injecting a loop-invariant condition.

Definition at line <a href="#l03021">3021</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### skipTrivialSelect() {#a5ca2e820d1b5a49dcaad5e6873917198}

<MemberDefinition
  prototype={<>static Value &#42; skipTrivialSelect (<a href="/docs/api/classes/llvm/value">Value</a> &#42; Cond)</>}
  labels = {["static"]}>

Definition at line <a href="#l00178">178</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### STATISTIC() {#ad5b466cbd242079ab18347e5248fd1b9}

<MemberDefinition
  prototype={<>STATISTIC (NumBranches, &quot;Number of <a href="/docs/api/files/lib/lib/target/lib/target/arc/arcbranchfinalize-cpp/#a14311558a7445776def2d5bc13161ba3">branches</a> unswitched&quot;)</>}>

Definition at line <a href="#l00074">74</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### STATISTIC() {#ab3ab9463ab2f6721ceff43efa0ba37e5}

<MemberDefinition
  prototype={<>STATISTIC (NumSwitches, &quot;Number of switches unswitched&quot;)</>}>

Definition at line <a href="#l00075">75</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### STATISTIC() {#a5b42a29a9e74c94c6d7826358ff0cf51}

<MemberDefinition
  prototype={<>STATISTIC (NumSelects, &quot;Number of <a href="/docs/api/files/lib/lib/codegen/selectoptimize-cpp/#a3d495d9a0daf7fe32f1b1fb0aa153929">selects</a> turned into <a href="/docs/api/files/lib/lib/target/lib/target/arc/arcbranchfinalize-cpp/#a14311558a7445776def2d5bc13161ba3">branches</a> <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a4cfc8b177e8521a4b496ae2edff6244f">for</a> unswitching&quot;)</>}>

Definition at line <a href="#l00076">76</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### STATISTIC() {#a825e9b46eaa40a5853a43f520d9b3a9d}

<MemberDefinition
  prototype={<>STATISTIC (NumGuards, &quot;Number of guards turned into <a href="/docs/api/files/lib/lib/target/lib/target/arc/arcbranchfinalize-cpp/#a14311558a7445776def2d5bc13161ba3">branches</a> <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a4cfc8b177e8521a4b496ae2edff6244f">for</a> unswitching&quot;)</>}>

Definition at line <a href="#l00077">77</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### STATISTIC() {#aa6e446decc15b9df1996f94f20798fbf}

<MemberDefinition
  prototype={<>STATISTIC (NumTrivial, &quot;Number of unswitches that are trivial&quot;)</>}>

Definition at line <a href="#l00078">78</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### STATISTIC() {#a91923c5ac786f070c692a9ae19983ecb}

<MemberDefinition
  prototype={<>STATISTIC (NumCostMultiplierSkipped, &quot;Number of unswitch candidates that had their cost multiplier skipped&quot;)</>}>

Definition at line <a href="#l00079">79</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### STATISTIC() {#ab781a25844101ae293fa4d6e9f27902f}

<MemberDefinition
  prototype={<>STATISTIC (NumInvariantConditionsInjected, &quot;Number of invariant conditions injected and unswitched&quot;)</>}>

Definition at line <a href="#l00082">82</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### turnGuardIntoBranch() {#af3ac46dde637293a34d0ff7b619a656b}

<MemberDefinition
  prototype={<>static BranchInst &#42; turnGuardIntoBranch (<a href="/docs/api/classes/llvm/intrinsicinst">IntrinsicInst</a> &#42; GI, <a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42; MSSAU)</>}
  labels = {["static"]}>
Turns a llvm.experimental.guard intrinsic into implicit control flow branch, making the following replacement:

â€“code before guardâ€“ call void (i1, ...) @llvm.experimental.guard(i1 cond) &#91; &quot;deopt&quot;() &#93; â€“code after guardâ€“

into

â€“code before guardâ€“ br i1 cond, label guarded, label deopt

guarded: â€“code after guardâ€“

deopt: call void (i1, ...) @llvm.experimental.guard(i1 false) &#91; &quot;deopt&quot;() &#93; unreachable

It also makes all relevant DT and LI updates, so that all structures are in valid state after this transform.

Definition at line <a href="#l02762">2762</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### turnSelectIntoBranch() {#a2e6301db15e4516c92e21f33761886c6}

<MemberDefinition
  prototype={<>static BranchInst &#42; turnSelectIntoBranch (<a href="/docs/api/classes/llvm/selectinst">SelectInst</a> &#42; SI, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42; MSSAU, <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &#42; AC)</>}
  labels = {["static"]}>
Turns a select instruction into implicit control flow branch, making the following replacement:

head: â€“code before selectâ€“ select cond, trueval, falseval â€“code after selectâ€“

into

head: â€“code before selectâ€“ br i1 cond, label then, label tail

then: br tail

tail: phi &#91; trueval, then &#93;, &#91; falseval, head&#93; unreachable

It also makes all relevant DT and LI updates, so that all structures are in valid state after this transform.

Definition at line <a href="#l02711">2711</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### unswitchAllTrivialConditions() {#a050cc2b2d1467ffcad6a825f1141424c}

<MemberDefinition
  prototype={<>static bool unswitchAllTrivialConditions (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42; SE, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42; MSSAU)</>}
  labels = {["static"]}>
This routine scans the loop to find a branch or switch which occurs before any side effects occur.

These can potentially be unswitched without duplicating the loop. If a branch or switch is successfully unswitched the scanning continues to see if subsequent branches or switches have become trivial. Once all trivial candidates have been unswitched, this routine returns.

The return value indicates whether anything was unswitched (and therefore changed).

If <code>SE</code> is not null, it will be updated based on the potential loop SCEVs invalidated by this.

Definition at line <a href="#l01047">1047</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### unswitchBestCondition() {#acc20b8effcbe869069ff973354344872}

<MemberDefinition
  prototype={<>static bool unswitchBestCondition (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI, <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &amp; AC, <a href="/docs/api/classes/llvm/aaresults">AAResults</a> &amp; AA, <a href="/docs/api/classes/llvm/targettransforminfo">TargetTransformInfo</a> &amp; TTI, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42; SE, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42; MSSAU, <a href="/docs/api/classes/llvm/lpmupdater">LPMUpdater</a> &amp; LoopUpdater)</>}
  labels = {["static"]}>

Definition at line <a href="#l03494">3494</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### unswitchLoop() {#a00b3b7cedd83de61be0312c6535f3f37}

<MemberDefinition
  prototype={<>static bool unswitchLoop (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI, <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &amp; AC, <a href="/docs/api/classes/llvm/aaresults">AAResults</a> &amp; AA, <a href="/docs/api/classes/llvm/targettransforminfo">TargetTransformInfo</a> &amp; TTI, bool Trivial, bool NonTrivial, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42; SE, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42; MSSAU, <a href="/docs/api/classes/llvm/profilesummaryinfo">ProfileSummaryInfo</a> &#42; PSI, <a href="/docs/api/classes/llvm/blockfrequencyinfo">BlockFrequencyInfo</a> &#42; BFI, <a href="/docs/api/classes/llvm/lpmupdater">LPMUpdater</a> &amp; LoopUpdater)</>}
  labels = {["static"]}>
Unswitch control flow predicated on loop invariant conditions.

This first hoists all branches or switches which are trivial (IE, do not require duplicating any part of the loop) out of the loop body. It then looks at other loop invariant control flows and tries to unswitch those as well by cloning the loop if the result is small enough.

The <code>DT</code>, <code>LI</code>, <code>AC</code>, <code><a href="/docs/api/namespaces/llvm/aa">AA</a></code>, <code><a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a></code> parameters are required analyses that are also updated based on the unswitch. The <code>MSSA</code> analysis is also updated if valid (i.e. its use is enabled).

If either <code>NonTrivial</code> is true or the flag <code>EnableNonTrivialUnswitch</code> is true, we will attempt to do non-trivial unswitching as well as trivial unswitching.

The <code>postUnswitch</code> function will be run after unswitching is complete with information on whether or not the provided loop remains a loop and a list of new sibling loops created.

If <code>SE</code> is non-null, we will update that analysis based on the unswitching done.

Definition at line <a href="#l03587">3587</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### unswitchNontrivialInvariants() {#aae4261fb86bc9023c3383785afa66b9a}

<MemberDefinition
  prototype={<>static void unswitchNontrivialInvariants (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp; TI, <a href="/docs/api/classes/llvm/arrayref">ArrayRef</a>&lt; <a href="/docs/api/classes/llvm/value">Value</a> &#42; &gt; Invariants, <a href="/docs/api/structs/llvm/ivconditioninfo">IVConditionInfo</a> &amp; PartialIVInfo, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI, <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &amp; AC, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42; SE, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42; MSSAU, <a href="/docs/api/classes/llvm/lpmupdater">LPMUpdater</a> &amp; LoopUpdater, bool InsertFreeze, bool InjectedCondition)</>}
  labels = {["static"]}>

Definition at line <a href="#l02175">2175</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### unswitchTrivialBranch() {#a6a082aa2e05f44f7dab89e2ff8c582ff}

<MemberDefinition
  prototype={<>static bool unswitchTrivialBranch (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &amp; BI, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42; SE, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42; MSSAU)</>}
  labels = {["static"]}>
Unswitch a trivial branch if the condition is loop invariant.

This routine should only be called when loop code leading to the branch has been validated as trivial (no side effects). This routine checks if the condition is invariant and one of the successors is a loop exit. This allows us to unswitch without duplicating the loop, making it trivial.

If this routine fails to unswitch the branch it returns false.

If the branch can be unswitched, this routine splits the preheader and hoists the branch above that split. Preserves loop simplified form (splitting the exit block as necessary). It simplifies the branch within the loop to an unconditional branch but doesn&#39;t remove it entirely. Further cleanup can be done with some simplifycfg like pass.

If <code>SE</code> is not null, it will be updated based on the potential loop SCEVs invalidated by this.

Definition at line <a href="#l00509">509</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### unswitchTrivialSwitch() {#aadf6036e1d19c8ba91242af6ec48d40b}

<MemberDefinition
  prototype={<>static bool unswitchTrivialSwitch (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/switchinst">SwitchInst</a> &amp; SI, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp; LI, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42; SE, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42; MSSAU)</>}
  labels = {["static"]}>
Unswitch a trivial switch if the condition is loop invariant.

This routine should only be called when loop code leading to the switch has been validated as trivial (no side effects). This routine checks if the condition is invariant and that at least one of the successors is a loop exit. This allows us to unswitch without duplicating the loop, making it trivial.

If this routine fails to unswitch the switch it returns false.

If the switch can be unswitched, this routine splits the preheader and copies the switch above that split. If the default case is one of the exiting cases, it copies the non-exiting cases and points them at the new preheader. If the default case is not exiting, it copies the exiting cases and points the default at the preheader. It preserves loop simplified form (splitting the exit blocks as necessary). It simplifies the switch within the loop by removing now-dead cases. If the default case is one of those unswitched, it replaces its destination with a new basic block containing only unreachable. Such basic blocks, while technically loop exits, are not considered for unswitching so this is a stable transform and the same switch will not be revisited. If after unswitching there is only a single in-loop successor, the switch is further simplified to an unconditional branch. Still more cleanup can be done with some simplifycfg like pass.

If <code>SE</code> is not null, it will be updated based on the potential loop SCEVs invalidated by this.

Definition at line <a href="#l00743">743</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### visitDomSubTree() {#a18b0f192065386f9e0bc793a08bbf3ff}

<MemberDefinition
  template={<>template &lt;typename CallableT&gt;</>}
  prototype={<>void visitDomSubTree (<a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; BB, CallableT Callable)</>}>
Helper to visit a dominator subtree, invoking a callable on each node.

Returning false at any point will stop walking past that node of the tree.

Definition at line <a href="#l02115">2115</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Variables

### DropNonTrivialImplicitNullChecks {#aab1355fa0b9b124a5424d170db011c9e}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; DropNonTrivialImplicitNullChecks(&quot;simple-loop-unswitch-drop-non-trivial-implicit-null-checks&quot;, cl::init(false), cl::Hidden, cl::desc(&quot;If enabled, drop make.implicit metadata in unswitched implicit &quot; &quot;null checks to save time analyzing if we can keep it.&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00109">109</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### EnableNonTrivialUnswitch {#a08f48517d908cdf7a21eed936deb7f7c}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; EnableNonTrivialUnswitch(&quot;enable-nontrivial-unswitch&quot;, cl::init(false), cl::Hidden, cl::desc(&quot;Forcibly enables non-trivial loop unswitching rather than &quot; &quot;following the configuration passed into the pass.&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00085">85</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### EnableUnswitchCostMultiplier {#a58389dda20e5bd529f3fb18c6531c7ce}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; EnableUnswitchCostMultiplier(&quot;enable-unswitch-cost-multiplier&quot;, cl::init(true), cl::Hidden, cl::desc(&quot;Enable unswitch cost multiplier that prohibits exponential &quot; &quot;explosion in nontrivial unswitch.&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00094">94</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### FreezeLoopUnswitchCond {#a777551c6c08e4e3588b36665a8572414}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; FreezeLoopUnswitchCond(&quot;freeze-loop-unswitch-cond&quot;, cl::init(true), cl::Hidden, cl::desc(&quot;If enabled, the freeze instruction will be added to condition &quot; &quot;of loop unswitch to prevent miscompilation.&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00119">119</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### InjectInvariantConditionHotnesThreshold {#aad5d88dba5221d4277024edf98cec9ac}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; InjectInvariantConditionHotnesThreshold(&quot;simple-loop-unswitch-inject-invariant-condition-hotness-threshold&quot;, cl::Hidden, cl::desc(&quot;Only try to inject loop invariant conditions and &quot; &quot;unswitch on them to eliminate branches that are &quot; &quot;not-taken 1/&lt;this option&gt; times or less.&quot;), cl::init(16))</>}
  labels = {["static"]}>

Definition at line <a href="#l00130">130</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### InjectInvariantConditions {#a777260b6a90536fc8e2d844a891eddb5}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; InjectInvariantConditions(&quot;simple-loop-unswitch-inject-invariant-conditions&quot;, cl::Hidden, cl::desc(&quot;Whether we should inject new invariants and unswitch them to &quot; &quot;eliminate some existing (non-invariant) conditions.&quot;), cl::init(true))</>}
  labels = {["static"]}>

Definition at line <a href="#l00124">124</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### MSSAThreshold {#a93f97c549049a827518c9bce17a53833}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; MSSAThreshold(&quot;simple-loop-unswitch-memoryssa-threshold&quot;, cl::desc(&quot;Max number of memory uses to explore during &quot; &quot;partial unswitching analysis&quot;), cl::init(100), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00115">115</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### UnswitchGuards {#a0986070d3233b98011a6bd838a65f1cb}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; UnswitchGuards(&quot;simple-loop-unswitch-guards&quot;, cl::init(true), cl::Hidden, cl::desc(&quot;If enabled, simple loop unswitching will also consider &quot; &quot;llvm.experimental.guard intrinsics as unswitch candidates.&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00105">105</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### UnswitchNumInitialUnscaledCandidates {#a49834115bcfb38ad510305e2e587f67a}

<MemberDefinition
  prototype={<>cl::opt&lt; int &gt; UnswitchNumInitialUnscaledCandidates(&quot;unswitch-num-initial-unscaled-candidates&quot;, cl::init(8), cl::Hidden, cl::desc(&quot;Number of unswitch candidates that are ignored when calculating &quot; &quot;cost multiplier.&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00101">101</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### UnswitchSiblingsToplevelDiv {#a8ec915a44f00522e05af0372fe598372}

<MemberDefinition
  prototype={<>cl::opt&lt; int &gt; UnswitchSiblingsToplevelDiv(&quot;unswitch-siblings-toplevel-div&quot;, cl::init(2), cl::Hidden, cl::desc(&quot;Toplevel siblings divisor for cost multiplier.&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00098">98</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

### UnswitchThreshold {#a639210c26d1952e9108bcdbb0353443b}

<MemberDefinition
  prototype={<>cl::opt&lt; int &gt; UnswitchThreshold(&quot;unswitch-threshold&quot;, cl::init(50), cl::Hidden, cl::desc(&quot;The cost threshold for unswitching a loop.&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00091">91</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Defines

### DEBUG&#95;TYPE {#ad78e062f62e0d6e453941fb4ca843e4d}

<MemberDefinition
  prototype={<>#define DEBUG&#95;TYPE&nbsp;&nbsp;&nbsp;&quot;simple-loop-unswitch&quot;</>}>
===- <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a> - Hoist loop-invariant control flow ------â€”===//

Definition at line <a href="#l00069">69</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/simpleloopunswitch-cpp">SimpleLoopUnswitch.cpp</a>.
</MemberDefinition>

</SectionDefinition>

## File Listing

The file content with the documentation metadata removed is:

<ProgramListing>

<Link id="l00001" /><CodeLine lineNumber="1"><Highlight kind="comment">///===- SimpleLoopUnswitch.cpp - Hoist loop-invariant control flow ---------===//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00002" /><CodeLine lineNumber="2"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00003" /><CodeLine lineNumber="3"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00004" /><CodeLine lineNumber="4"><Highlight kind="normal"></Highlight><Highlight kind="comment">// See https://llvm.org/LICENSE.txt for license information.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00005" /><CodeLine lineNumber="5"><Highlight kind="normal"></Highlight><Highlight kind="comment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00006" /><CodeLine lineNumber="6"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00007" /><CodeLine lineNumber="7"><Highlight kind="normal"></Highlight><Highlight kind="comment">//===----------------------------------------------------------------------===//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00008" /><CodeLine lineNumber="8"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00009" /><CodeLine lineNumber="9"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/scalar/simpleloopunswitch-h">llvm/Transforms/Scalar/SimpleLoopUnswitch.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00010" /><CodeLine lineNumber="10"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/densemap-h">llvm/ADT/DenseMap.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00011" /><CodeLine lineNumber="11"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/stlextras-h">llvm/ADT/STLExtras.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00012" /><CodeLine lineNumber="12"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/sequence-h">llvm/ADT/Sequence.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00013" /><CodeLine lineNumber="13"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/setvector-h">llvm/ADT/SetVector.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00014" /><CodeLine lineNumber="14"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/smallptrset-h">llvm/ADT/SmallPtrSet.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00015" /><CodeLine lineNumber="15"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/smallvector-h">llvm/ADT/SmallVector.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00016" /><CodeLine lineNumber="16"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h">llvm/ADT/Statistic.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00017" /><CodeLine lineNumber="17"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/twine-h">llvm/ADT/Twine.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00018" /><CodeLine lineNumber="18"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/assumptioncache-h">llvm/Analysis/AssumptionCache.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00019" /><CodeLine lineNumber="19"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/blockfrequencyinfo-h">llvm/Analysis/BlockFrequencyInfo.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00020" /><CodeLine lineNumber="20"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/cfg-h">llvm/Analysis/CFG.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00021" /><CodeLine lineNumber="21"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/codemetrics-h">llvm/Analysis/CodeMetrics.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00022" /><CodeLine lineNumber="22"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/domtreeupdater-h">llvm/Analysis/DomTreeUpdater.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00023" /><CodeLine lineNumber="23"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/guardutils-h">llvm/Analysis/GuardUtils.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00024" /><CodeLine lineNumber="24"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/loopanalysismanager-h">llvm/Analysis/LoopAnalysisManager.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00025" /><CodeLine lineNumber="25"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/loopinfo-h">llvm/Analysis/LoopInfo.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00026" /><CodeLine lineNumber="26"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/loopiterator-h">llvm/Analysis/LoopIterator.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00027" /><CodeLine lineNumber="27"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/memoryssa-h">llvm/Analysis/MemorySSA.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00028" /><CodeLine lineNumber="28"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/memoryssaupdater-h">llvm/Analysis/MemorySSAUpdater.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00029" /><CodeLine lineNumber="29"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/mustexecute-h">llvm/Analysis/MustExecute.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00030" /><CodeLine lineNumber="30"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/profilesummaryinfo-h">llvm/Analysis/ProfileSummaryInfo.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00031" /><CodeLine lineNumber="31"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/scalarevolution-h">llvm/Analysis/ScalarEvolution.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00032" /><CodeLine lineNumber="32"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/targettransforminfo-h">llvm/Analysis/TargetTransformInfo.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00033" /><CodeLine lineNumber="33"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/valuetracking-h">llvm/Analysis/ValueTracking.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00034" /><CodeLine lineNumber="34"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/basicblock-h">llvm/IR/BasicBlock.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00035" /><CodeLine lineNumber="35"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/constant-h">llvm/IR/Constant.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00036" /><CodeLine lineNumber="36"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/constants-h">llvm/IR/Constants.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00037" /><CodeLine lineNumber="37"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/dominators-h">llvm/IR/Dominators.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00038" /><CodeLine lineNumber="38"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/function-h">llvm/IR/Function.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00039" /><CodeLine lineNumber="39"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/irbuilder-h">llvm/IR/IRBuilder.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00040" /><CodeLine lineNumber="40"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/instrtypes-h">llvm/IR/InstrTypes.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00041" /><CodeLine lineNumber="41"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/instruction-h">llvm/IR/Instruction.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00042" /><CodeLine lineNumber="42"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/instructions-h">llvm/IR/Instructions.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00043" /><CodeLine lineNumber="43"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/intrinsicinst-h">llvm/IR/IntrinsicInst.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00044" /><CodeLine lineNumber="44"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/module-h">llvm/IR/Module.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00045" /><CodeLine lineNumber="45"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/patternmatch-h">llvm/IR/PatternMatch.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00046" /><CodeLine lineNumber="46"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/profdatautils-h">llvm/IR/ProfDataUtils.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00047" /><CodeLine lineNumber="47"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/use-h">llvm/IR/Use.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00048" /><CodeLine lineNumber="48"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/value-h">llvm/IR/Value.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00049" /><CodeLine lineNumber="49"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/casting-h">llvm/Support/Casting.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00050" /><CodeLine lineNumber="50"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h">llvm/Support/CommandLine.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00051" /><CodeLine lineNumber="51"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h">llvm/Support/Debug.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00052" /><CodeLine lineNumber="52"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/errorhandling-h">llvm/Support/ErrorHandling.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00053" /><CodeLine lineNumber="53"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/genericdomtree-h">llvm/Support/GenericDomTree.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00054" /><CodeLine lineNumber="54"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/instructioncost-h">llvm/Support/InstructionCost.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00055" /><CodeLine lineNumber="55"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/raw-ostream-h">llvm/Support/raw&#95;ostream.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00056" /><CodeLine lineNumber="56"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/scalar/looppassmanager-h">llvm/Transforms/Scalar/LoopPassManager.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00057" /><CodeLine lineNumber="57"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/basicblockutils-h">llvm/Transforms/Utils/BasicBlockUtils.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00058" /><CodeLine lineNumber="58"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/cloning-h">llvm/Transforms/Utils/Cloning.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00059" /><CodeLine lineNumber="59"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/local-h">llvm/Transforms/Utils/Local.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00060" /><CodeLine lineNumber="60"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/looputils-h">llvm/Transforms/Utils/LoopUtils.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00061" /><CodeLine lineNumber="61"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/valuemapper-h">llvm/Transforms/Utils/ValueMapper.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00062" /><CodeLine lineNumber="62"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &lt;algorithm&gt;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00063" /><CodeLine lineNumber="63"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &lt;cassert&gt;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00064" /><CodeLine lineNumber="64"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &lt;iterator&gt;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00065" /><CodeLine lineNumber="65"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &lt;numeric&gt;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00066" /><CodeLine lineNumber="66"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &lt;optional&gt;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00067" /><CodeLine lineNumber="67"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &lt;utility&gt;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00068" /><CodeLine lineNumber="68"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00069" /><CodeLine lineNumber="69" lineLink="#ad78e062f62e0d6e453941fb4ca843e4d"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#define DEBUG&#95;TYPE &quot;simple-loop-unswitch&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00070" /><CodeLine lineNumber="70"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00071" /><CodeLine lineNumber="71"><Highlight kind="normal"></Highlight><Highlight kind="keyword">using namespace </Highlight><Highlight kind="normal"><a href="/docs/api/namespaces/llvm">llvm</a>;</Highlight></CodeLine>
<Link id="l00072" /><CodeLine lineNumber="72"><Highlight kind="normal"></Highlight><Highlight kind="keyword">using namespace </Highlight><Highlight kind="normal"><a href="/docs/api/namespaces/llvm/patternmatch">llvm::PatternMatch</a>;</Highlight></CodeLine>
<Link id="l00073" /><CodeLine lineNumber="73"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00074" /><CodeLine lineNumber="74" lineLink="#ad5b466cbd242079ab18347e5248fd1b9"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumBranches, </Highlight><Highlight kind="stringliteral">&quot;Number of branches unswitched&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00075" /><CodeLine lineNumber="75" lineLink="#ab3ab9463ab2f6721ceff43efa0ba37e5"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumSwitches, </Highlight><Highlight kind="stringliteral">&quot;Number of switches unswitched&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00076" /><CodeLine lineNumber="76" lineLink="#a5b42a29a9e74c94c6d7826358ff0cf51"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumSelects, </Highlight><Highlight kind="stringliteral">&quot;Number of selects turned into branches for unswitching&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00077" /><CodeLine lineNumber="77" lineLink="#a825e9b46eaa40a5853a43f520d9b3a9d"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumGuards, </Highlight><Highlight kind="stringliteral">&quot;Number of guards turned into branches for unswitching&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00078" /><CodeLine lineNumber="78" lineLink="#aa6e446decc15b9df1996f94f20798fbf"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumTrivial, </Highlight><Highlight kind="stringliteral">&quot;Number of unswitches that are trivial&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00079" /><CodeLine lineNumber="79" lineLink="#a91923c5ac786f070c692a9ae19983ecb"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(</Highlight></CodeLine>
<Link id="l00080" /><CodeLine lineNumber="80"><Highlight kind="normal">    NumCostMultiplierSkipped,</Highlight></CodeLine>
<Link id="l00081" /><CodeLine lineNumber="81"><Highlight kind="normal">    </Highlight><Highlight kind="stringliteral">&quot;Number of unswitch candidates that had their cost multiplier skipped&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00082" /><CodeLine lineNumber="82" lineLink="#ab781a25844101ae293fa4d6e9f27902f"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumInvariantConditionsInjected,</Highlight></CodeLine>
<Link id="l00083" /><CodeLine lineNumber="83"><Highlight kind="normal">          </Highlight><Highlight kind="stringliteral">&quot;Number of invariant conditions injected and unswitched&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00084" /><CodeLine lineNumber="84"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00085" /><CodeLine lineNumber="85" lineLink="#a08f48517d908cdf7a21eed936deb7f7c"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a08f48517d908cdf7a21eed936deb7f7c">EnableNonTrivialUnswitch</a>(</Highlight></CodeLine>
<Link id="l00086" /><CodeLine lineNumber="86"><Highlight kind="normal">    </Highlight><Highlight kind="stringliteral">&quot;enable-nontrivial-unswitch&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</Highlight></CodeLine>
<Link id="l00087" /><CodeLine lineNumber="87"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Forcibly enables non-trivial loop unswitching rather than &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00088" /><CodeLine lineNumber="88"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;following the configuration passed into the pass.&quot;</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00089" /><CodeLine lineNumber="89"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00090" /><CodeLine lineNumber="90"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;int&gt;</a></Highlight></CodeLine>
<Link id="l00091" /><CodeLine lineNumber="91" lineLink="#a639210c26d1952e9108bcdbb0353443b"><Highlight kind="normal">    <a href="#a639210c26d1952e9108bcdbb0353443b">UnswitchThreshold</a>(</Highlight><Highlight kind="stringliteral">&quot;unswitch-threshold&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(50), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</Highlight></CodeLine>
<Link id="l00092" /><CodeLine lineNumber="92"><Highlight kind="normal">                      <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;The cost threshold for unswitching a loop.&quot;</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00093" /><CodeLine lineNumber="93"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00094" /><CodeLine lineNumber="94" lineLink="#a58389dda20e5bd529f3fb18c6531c7ce"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a58389dda20e5bd529f3fb18c6531c7ce">EnableUnswitchCostMultiplier</a>(</Highlight></CodeLine>
<Link id="l00095" /><CodeLine lineNumber="95"><Highlight kind="normal">    </Highlight><Highlight kind="stringliteral">&quot;enable-unswitch-cost-multiplier&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</Highlight></CodeLine>
<Link id="l00096" /><CodeLine lineNumber="96"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Enable unswitch cost multiplier that prohibits exponential &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00097" /><CodeLine lineNumber="97"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;explosion in nontrivial unswitch.&quot;</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00098" /><CodeLine lineNumber="98" lineLink="#a8ec915a44f00522e05af0372fe598372"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;int&gt;</a> <a href="#a8ec915a44f00522e05af0372fe598372">UnswitchSiblingsToplevelDiv</a>(</Highlight></CodeLine>
<Link id="l00099" /><CodeLine lineNumber="99"><Highlight kind="normal">    </Highlight><Highlight kind="stringliteral">&quot;unswitch-siblings-toplevel-div&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(2), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</Highlight></CodeLine>
<Link id="l00100" /><CodeLine lineNumber="100"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Toplevel siblings divisor for cost multiplier.&quot;</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00101" /><CodeLine lineNumber="101" lineLink="#a49834115bcfb38ad510305e2e587f67a"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;int&gt;</a> <a href="#a49834115bcfb38ad510305e2e587f67a">UnswitchNumInitialUnscaledCandidates</a>(</Highlight></CodeLine>
<Link id="l00102" /><CodeLine lineNumber="102"><Highlight kind="normal">    </Highlight><Highlight kind="stringliteral">&quot;unswitch-num-initial-unscaled-candidates&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(8), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</Highlight></CodeLine>
<Link id="l00103" /><CodeLine lineNumber="103"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Number of unswitch candidates that are ignored when calculating &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00104" /><CodeLine lineNumber="104"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;cost multiplier.&quot;</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00105" /><CodeLine lineNumber="105" lineLink="#a0986070d3233b98011a6bd838a65f1cb"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a0986070d3233b98011a6bd838a65f1cb">UnswitchGuards</a>(</Highlight></CodeLine>
<Link id="l00106" /><CodeLine lineNumber="106"><Highlight kind="normal">    </Highlight><Highlight kind="stringliteral">&quot;simple-loop-unswitch-guards&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</Highlight></CodeLine>
<Link id="l00107" /><CodeLine lineNumber="107"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;If enabled, simple loop unswitching will also consider &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00108" /><CodeLine lineNumber="108"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;llvm.experimental.guard intrinsics as unswitch candidates.&quot;</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00109" /><CodeLine lineNumber="109" lineLink="#aab1355fa0b9b124a5424d170db011c9e"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#aab1355fa0b9b124a5424d170db011c9e">DropNonTrivialImplicitNullChecks</a>(</Highlight></CodeLine>
<Link id="l00110" /><CodeLine lineNumber="110"><Highlight kind="normal">    </Highlight><Highlight kind="stringliteral">&quot;simple-loop-unswitch-drop-non-trivial-implicit-null-checks&quot;</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l00111" /><CodeLine lineNumber="111"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</Highlight></CodeLine>
<Link id="l00112" /><CodeLine lineNumber="112"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;If enabled, drop make.implicit metadata in unswitched implicit &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00113" /><CodeLine lineNumber="113"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;null checks to save time analyzing if we can keep it.&quot;</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00114" /><CodeLine lineNumber="114"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a></Highlight></CodeLine>
<Link id="l00115" /><CodeLine lineNumber="115" lineLink="#a93f97c549049a827518c9bce17a53833"><Highlight kind="normal">    <a href="#a93f97c549049a827518c9bce17a53833">MSSAThreshold</a>(</Highlight><Highlight kind="stringliteral">&quot;simple-loop-unswitch-memoryssa-threshold&quot;</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l00116" /><CodeLine lineNumber="116"><Highlight kind="normal">                  <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Max number of memory uses to explore during &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00117" /><CodeLine lineNumber="117"><Highlight kind="normal">                           </Highlight><Highlight kind="stringliteral">&quot;partial unswitching analysis&quot;</Highlight><Highlight kind="normal">),</Highlight></CodeLine>
<Link id="l00118" /><CodeLine lineNumber="118"><Highlight kind="normal">                  <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(100), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</Highlight></CodeLine>
<Link id="l00119" /><CodeLine lineNumber="119" lineLink="#a777551c6c08e4e3588b36665a8572414"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a777551c6c08e4e3588b36665a8572414">FreezeLoopUnswitchCond</a>(</Highlight></CodeLine>
<Link id="l00120" /><CodeLine lineNumber="120"><Highlight kind="normal">    </Highlight><Highlight kind="stringliteral">&quot;freeze-loop-unswitch-cond&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</Highlight></CodeLine>
<Link id="l00121" /><CodeLine lineNumber="121"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;If enabled, the freeze instruction will be added to condition &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00122" /><CodeLine lineNumber="122"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;of loop unswitch to prevent miscompilation.&quot;</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00123" /><CodeLine lineNumber="123"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00124" /><CodeLine lineNumber="124" lineLink="#a777260b6a90536fc8e2d844a891eddb5"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a777260b6a90536fc8e2d844a891eddb5">InjectInvariantConditions</a>(</Highlight></CodeLine>
<Link id="l00125" /><CodeLine lineNumber="125"><Highlight kind="normal">    </Highlight><Highlight kind="stringliteral">&quot;simple-loop-unswitch-inject-invariant-conditions&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</Highlight></CodeLine>
<Link id="l00126" /><CodeLine lineNumber="126"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Whether we should inject new invariants and unswitch them to &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00127" /><CodeLine lineNumber="127"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;eliminate some existing (non-invariant) conditions.&quot;</Highlight><Highlight kind="normal">),</Highlight></CodeLine>
<Link id="l00128" /><CodeLine lineNumber="128"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00129" /><CodeLine lineNumber="129"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00130" /><CodeLine lineNumber="130" lineLink="#aad5d88dba5221d4277024edf98cec9ac"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="#aad5d88dba5221d4277024edf98cec9ac">InjectInvariantConditionHotnesThreshold</a>(</Highlight></CodeLine>
<Link id="l00131" /><CodeLine lineNumber="131"><Highlight kind="normal">    </Highlight><Highlight kind="stringliteral">&quot;simple-loop-unswitch-inject-invariant-condition-hotness-threshold&quot;</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l00132" /><CodeLine lineNumber="132"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>, <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Only try to inject loop invariant conditions and &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00133" /><CodeLine lineNumber="133"><Highlight kind="normal">                         </Highlight><Highlight kind="stringliteral">&quot;unswitch on them to eliminate branches that are &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00134" /><CodeLine lineNumber="134"><Highlight kind="normal">                         </Highlight><Highlight kind="stringliteral">&quot;not-taken 1/&lt;this option&gt; times or less.&quot;</Highlight><Highlight kind="normal">),</Highlight></CodeLine>
<Link id="l00135" /><CodeLine lineNumber="135"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(16));</Highlight></CodeLine>
<Link id="l00136" /><CodeLine lineNumber="136"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00137" /><CodeLine lineNumber="137"><Highlight kind="normal"><a href="/docs/api/structs/llvm/analysiskey">AnalysisKey</a> <a href="/docs/api/structs/llvm/shouldrunextrasimpleloopunswitch/#ad167c35ef09cd4bf5f50759c7c475177">ShouldRunExtraSimpleLoopUnswitch::Key</a>;</Highlight></CodeLine>
<Link id="l00138" /><CodeLine lineNumber="138" lineLink="/docs/api/namespaces/anonymous-simpleloopunswitch-cpp-"><Highlight kind="normal"></Highlight><Highlight kind="keyword">namespace </Highlight><Highlight kind="normal">&#123;</Highlight></CodeLine>
<Link id="l00139" /><CodeLine lineNumber="139" lineLink="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc"><Highlight kind="normal"></Highlight><Highlight kind="keyword">struct </Highlight><Highlight kind="normal"><a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc/#ade23e38371e46b268eb92542813f53bc">CompareDesc</a> &#123;</Highlight></CodeLine>
<Link id="l00140" /><CodeLine lineNumber="140" lineLink="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc/#a63d34787c0fdc8e70c42fd9421207d18"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc/#a63d34787c0fdc8e70c42fd9421207d18">Term</a>;</Highlight></CodeLine>
<Link id="l00141" /><CodeLine lineNumber="141" lineLink="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc/#a441306fc894c73951d99fdc2ae68a877"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc/#a441306fc894c73951d99fdc2ae68a877">Invariant</a>;</Highlight></CodeLine>
<Link id="l00142" /><CodeLine lineNumber="142" lineLink="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc/#a8442cbc93985615112e8a509ea93e054"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc/#a8442cbc93985615112e8a509ea93e054">InLoopSucc</a>;</Highlight></CodeLine>
<Link id="l00143" /><CodeLine lineNumber="143"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00144" /><CodeLine lineNumber="144" lineLink="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc/#ade23e38371e46b268eb92542813f53bc"><Highlight kind="normal">  <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc/#ade23e38371e46b268eb92542813f53bc">CompareDesc</a>(<a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc/#a63d34787c0fdc8e70c42fd9421207d18">Term</a>, <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc/#a441306fc894c73951d99fdc2ae68a877">Invariant</a>, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc/#a8442cbc93985615112e8a509ea93e054">InLoopSucc</a>)</Highlight></CodeLine>
<Link id="l00145" /><CodeLine lineNumber="145"><Highlight kind="normal">      : <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc/#a63d34787c0fdc8e70c42fd9421207d18">Term</a>(<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc/#a63d34787c0fdc8e70c42fd9421207d18">Term</a>), <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc/#a441306fc894c73951d99fdc2ae68a877">Invariant</a>(<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc/#a441306fc894c73951d99fdc2ae68a877">Invariant</a>), <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc/#a8442cbc93985615112e8a509ea93e054">InLoopSucc</a>(<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc/#a8442cbc93985615112e8a509ea93e054">InLoopSucc</a>) &#123;&#125;</Highlight></CodeLine>
<Link id="l00146" /><CodeLine lineNumber="146"><Highlight kind="normal">&#125;;</Highlight></CodeLine>
<Link id="l00147" /><CodeLine lineNumber="147"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00148" /><CodeLine lineNumber="148" lineLink="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant"><Highlight kind="normal"></Highlight><Highlight kind="keyword">struct </Highlight><Highlight kind="normal"><a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#a9851d6d92871b3a0d2fc4b4f5c205b97">InjectedInvariant</a> &#123;</Highlight></CodeLine>
<Link id="l00149" /><CodeLine lineNumber="149" lineLink="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#ac5913fcbbe8d64d02344d8c0913ed4f9"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78b">ICmpInst::Predicate</a> <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#ac5913fcbbe8d64d02344d8c0913ed4f9">Pred</a>;</Highlight></CodeLine>
<Link id="l00150" /><CodeLine lineNumber="150" lineLink="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#a3f8dc46afb574b914dfa6c76993e46c7"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#a3f8dc46afb574b914dfa6c76993e46c7">LHS</a>;</Highlight></CodeLine>
<Link id="l00151" /><CodeLine lineNumber="151" lineLink="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#a770cc9bc6c308a65982eea62dfa6c7a3"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#a770cc9bc6c308a65982eea62dfa6c7a3">RHS</a>;</Highlight></CodeLine>
<Link id="l00152" /><CodeLine lineNumber="152" lineLink="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#aacb48e786feb9f17050c3aa0243c23d8"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#aacb48e786feb9f17050c3aa0243c23d8">InLoopSucc</a>;</Highlight></CodeLine>
<Link id="l00153" /><CodeLine lineNumber="153"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00154" /><CodeLine lineNumber="154" lineLink="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#a9851d6d92871b3a0d2fc4b4f5c205b97"><Highlight kind="normal">  <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#a9851d6d92871b3a0d2fc4b4f5c205b97">InjectedInvariant</a>(<a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78b">ICmpInst::Predicate</a> <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#ac5913fcbbe8d64d02344d8c0913ed4f9">Pred</a>, <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#a3f8dc46afb574b914dfa6c76993e46c7">LHS</a>, <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#a770cc9bc6c308a65982eea62dfa6c7a3">RHS</a>,</Highlight></CodeLine>
<Link id="l00155" /><CodeLine lineNumber="155"><Highlight kind="normal">                    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#aacb48e786feb9f17050c3aa0243c23d8">InLoopSucc</a>)</Highlight></CodeLine>
<Link id="l00156" /><CodeLine lineNumber="156"><Highlight kind="normal">      : <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#ac5913fcbbe8d64d02344d8c0913ed4f9">Pred</a>(<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#ac5913fcbbe8d64d02344d8c0913ed4f9">Pred</a>), <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#a3f8dc46afb574b914dfa6c76993e46c7">LHS</a>(<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#a3f8dc46afb574b914dfa6c76993e46c7">LHS</a>), <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#a770cc9bc6c308a65982eea62dfa6c7a3">RHS</a>(<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#a770cc9bc6c308a65982eea62dfa6c7a3">RHS</a>), <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#aacb48e786feb9f17050c3aa0243c23d8">InLoopSucc</a>(<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#aacb48e786feb9f17050c3aa0243c23d8">InLoopSucc</a>) &#123;&#125;</Highlight></CodeLine>
<Link id="l00157" /><CodeLine lineNumber="157"><Highlight kind="normal">&#125;;</Highlight></CodeLine>
<Link id="l00158" /><CodeLine lineNumber="158"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00159" /><CodeLine lineNumber="159" lineLink="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate"><Highlight kind="normal"></Highlight><Highlight kind="keyword">struct </Highlight><Highlight kind="normal"><a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a428fcbe432c0149594a5fe987bafd318">NonTrivialUnswitchCandidate</a> &#123;</Highlight></CodeLine>
<Link id="l00160" /><CodeLine lineNumber="160" lineLink="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a695f3bf5e2bba01665de74141bfb6655"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a695f3bf5e2bba01665de74141bfb6655">TI</a> = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00161" /><CodeLine lineNumber="161" lineLink="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a12ce4b1dbb1250c62fca0e4b6a580a14"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/tinyptrvector">TinyPtrVector&lt;Value &#42;&gt;</a> <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a12ce4b1dbb1250c62fca0e4b6a580a14">Invariants</a>;</Highlight></CodeLine>
<Link id="l00162" /><CodeLine lineNumber="162" lineLink="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a1f60bd27f2a0a661d2af174a13bb257c"><Highlight kind="normal">  std::optional&lt;InstructionCost&gt; <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a1f60bd27f2a0a661d2af174a13bb257c">Cost</a>;</Highlight></CodeLine>
<Link id="l00163" /><CodeLine lineNumber="163" lineLink="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a929ea50c0f49f2b80e471c99d108c2cf"><Highlight kind="normal">  std::optional&lt;InjectedInvariant&gt; <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a929ea50c0f49f2b80e471c99d108c2cf">PendingInjection</a>;</Highlight></CodeLine>
<Link id="l00164" /><CodeLine lineNumber="164" lineLink="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a428fcbe432c0149594a5fe987bafd318"><Highlight kind="normal">  <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a428fcbe432c0149594a5fe987bafd318">NonTrivialUnswitchCandidate</a>(</Highlight></CodeLine>
<Link id="l00165" /><CodeLine lineNumber="165"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a695f3bf5e2bba01665de74141bfb6655">TI</a>, <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;Value &#42;&gt;</a> <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a12ce4b1dbb1250c62fca0e4b6a580a14">Invariants</a>,</Highlight></CodeLine>
<Link id="l00166" /><CodeLine lineNumber="166"><Highlight kind="normal">      std::optional&lt;InstructionCost&gt; <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a1f60bd27f2a0a661d2af174a13bb257c">Cost</a> = std::nullopt,</Highlight></CodeLine>
<Link id="l00167" /><CodeLine lineNumber="167"><Highlight kind="normal">      std::optional&lt;InjectedInvariant&gt; <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a929ea50c0f49f2b80e471c99d108c2cf">PendingInjection</a> = std::nullopt)</Highlight></CodeLine>
<Link id="l00168" /><CodeLine lineNumber="168"><Highlight kind="normal">      : <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a695f3bf5e2bba01665de74141bfb6655">TI</a>(<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a695f3bf5e2bba01665de74141bfb6655">TI</a>), <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a12ce4b1dbb1250c62fca0e4b6a580a14">Invariants</a>(<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a12ce4b1dbb1250c62fca0e4b6a580a14">Invariants</a>), <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a1f60bd27f2a0a661d2af174a13bb257c">Cost</a>(<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a1f60bd27f2a0a661d2af174a13bb257c">Cost</a>),</Highlight></CodeLine>
<Link id="l00169" /><CodeLine lineNumber="169"><Highlight kind="normal">        <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a929ea50c0f49f2b80e471c99d108c2cf">PendingInjection</a>(<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a929ea50c0f49f2b80e471c99d108c2cf">PendingInjection</a>) &#123;&#125;;</Highlight></CodeLine>
<Link id="l00170" /><CodeLine lineNumber="170"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00171" /><CodeLine lineNumber="171" lineLink="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#ae121300fe93703e0c8825f724025f2a2"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#ae121300fe93703e0c8825f724025f2a2">hasPendingInjection</a>()</Highlight><Highlight kind="keyword"> const </Highlight><Highlight kind="normal">&#123; </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a929ea50c0f49f2b80e471c99d108c2cf">PendingInjection</a>.has&#95;value(); &#125;</Highlight></CodeLine>
<Link id="l00172" /><CodeLine lineNumber="172"><Highlight kind="normal">&#125;;</Highlight></CodeLine>
<Link id="l00173" /><CodeLine lineNumber="173"><Highlight kind="normal">&#125; </Highlight><Highlight kind="comment">// end anonymous namespace.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00174" /><CodeLine lineNumber="174"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00175" /><CodeLine lineNumber="175"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Helper to skip (select x, true, false), which matches both a logical AND and</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00176" /><CodeLine lineNumber="176"><Highlight kind="normal"></Highlight><Highlight kind="comment">// OR and can confuse code that tries to determine if \\p Cond is either a</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00177" /><CodeLine lineNumber="177"><Highlight kind="normal"></Highlight><Highlight kind="comment">// logical AND or OR but not both.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00178" /><CodeLine lineNumber="178" lineLink="#a5ca2e820d1b5a49dcaad5e6873917198"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="#a5ca2e820d1b5a49dcaad5e6873917198">skipTrivialSelect</a>(<a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>) &#123;</Highlight></CodeLine>
<Link id="l00179" /><CodeLine lineNumber="179"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;CondNext;</Highlight></CodeLine>
<Link id="l00180" /><CodeLine lineNumber="180"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, <a href="/docs/api/namespaces/llvm/patternmatch/#a3ccd94f6a7507492b47c7351e3fb78c6">m&#95;Select</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(CondNext), <a href="/docs/api/namespaces/llvm/patternmatch/#a3b3d2d8c64a7881acb82bc7467569aa9">m&#95;One</a>(), <a href="/docs/api/namespaces/llvm/patternmatch/#ae77be336e228cf9aa00709a8606dfb98">m&#95;Zero</a>())))</Highlight></CodeLine>
<Link id="l00181" /><CodeLine lineNumber="181"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a> = CondNext;</Highlight></CodeLine>
<Link id="l00182" /><CodeLine lineNumber="182"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>;</Highlight></CodeLine>
<Link id="l00183" /><CodeLine lineNumber="183"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00184" /><CodeLine lineNumber="184"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00185" /><CodeLine lineNumber="185"><Highlight kind="comment">/// Collect all of the loop invariant input values transitively used by the</Highlight></CodeLine>
<Link id="l00186" /><CodeLine lineNumber="186"><Highlight kind="comment">/// homogeneous instruction graph from a given root.</Highlight></CodeLine>
<Link id="l00187" /><CodeLine lineNumber="187"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00188" /><CodeLine lineNumber="188"><Highlight kind="comment">/// This essentially walks from a root recursively through loop variant operands</Highlight></CodeLine>
<Link id="l00189" /><CodeLine lineNumber="189"><Highlight kind="comment">/// which have perform the same logical operation (AND or OR) and finds all</Highlight></CodeLine>
<Link id="l00190" /><CodeLine lineNumber="190"><Highlight kind="comment">/// inputs which are loop invariant. For some operations these can be</Highlight></CodeLine>
<Link id="l00191" /><CodeLine lineNumber="191"><Highlight kind="comment">/// re-associated and unswitched out of the loop entirely.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00192" /><CodeLine lineNumber="192"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/tinyptrvector">TinyPtrVector&lt;Value &#42;&gt;</a></Highlight></CodeLine>
<Link id="l00193" /><CodeLine lineNumber="193" lineLink="#a1061b839196c8068b89d05aced41de29"><Highlight kind="normal"><a href="#a1061b839196c8068b89d05aced41de29">collectHomogenousInstGraphLoopInvariants</a>(</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;Root,</Highlight></CodeLine>
<Link id="l00194" /><CodeLine lineNumber="194"><Highlight kind="normal">                                         </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI) &#123;</Highlight></CodeLine>
<Link id="l00195" /><CodeLine lineNumber="195"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!L.isLoopInvariant(&amp;Root) &amp;&amp;</Highlight></CodeLine>
<Link id="l00196" /><CodeLine lineNumber="196"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;Only need to walk the graph if root itself is not invariant.&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00197" /><CodeLine lineNumber="197"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/tinyptrvector">TinyPtrVector&lt;Value &#42;&gt;</a> Invariants;</Highlight></CodeLine>
<Link id="l00198" /><CodeLine lineNumber="198"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00199" /><CodeLine lineNumber="199"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> IsRootAnd = <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(&amp;Root, <a href="/docs/api/namespaces/llvm/patternmatch/#acf8c16eed89e5ee1a10b6dfc08a33b3a">m&#95;LogicalAnd</a>());</Highlight></CodeLine>
<Link id="l00200" /><CodeLine lineNumber="200"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> IsRootOr  = <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(&amp;Root, <a href="/docs/api/namespaces/llvm/patternmatch/#a5cce7a41c7581ff15a23ab90eb3b403a">m&#95;LogicalOr</a>());</Highlight></CodeLine>
<Link id="l00201" /><CodeLine lineNumber="201"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00202" /><CodeLine lineNumber="202"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Build a worklist and recurse through operators collecting invariants.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00203" /><CodeLine lineNumber="203"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Instruction &#42;, 4&gt;</a> Worklist;</Highlight></CodeLine>
<Link id="l00204" /><CodeLine lineNumber="204"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;Instruction &#42;, 8&gt;</a> Visited;</Highlight></CodeLine>
<Link id="l00205" /><CodeLine lineNumber="205"><Highlight kind="normal">  Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&amp;Root);</Highlight></CodeLine>
<Link id="l00206" /><CodeLine lineNumber="206"><Highlight kind="normal">  Visited.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(&amp;Root);</Highlight></CodeLine>
<Link id="l00207" /><CodeLine lineNumber="207"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">do</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00208" /><CodeLine lineNumber="208"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = &#42;Worklist.<a href="/docs/api/classes/llvm/smallvectorimpl/#a0c8ffe664a36e30d49c84d0aded2fe08">pop&#95;back&#95;val</a>();</Highlight></CodeLine>
<Link id="l00209" /><CodeLine lineNumber="209"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/value">Value</a> &#42;OpV : <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.operand&#95;values()) &#123;</Highlight></CodeLine>
<Link id="l00210" /><CodeLine lineNumber="210"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Skip constants as unswitching isn&#39;t interesting for them.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00211" /><CodeLine lineNumber="211"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;Constant&gt;</a>(OpV))</Highlight></CodeLine>
<Link id="l00212" /><CodeLine lineNumber="212"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00213" /><CodeLine lineNumber="213"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00214" /><CodeLine lineNumber="214"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Add it to our result if loop invariant.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00215" /><CodeLine lineNumber="215"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L.isLoopInvariant(OpV)) &#123;</Highlight></CodeLine>
<Link id="l00216" /><CodeLine lineNumber="216"><Highlight kind="normal">        Invariants.<a href="/docs/api/classes/llvm/tinyptrvector/#a1437e12220a4cd03b10656dcb607c642">push&#95;back</a>(OpV);</Highlight></CodeLine>
<Link id="l00217" /><CodeLine lineNumber="217"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00218" /><CodeLine lineNumber="218"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00219" /><CodeLine lineNumber="219"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00220" /><CodeLine lineNumber="220"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// If not an instruction with the same opcode, nothing we can do.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00221" /><CodeLine lineNumber="221"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;OpI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(<a href="#a5ca2e820d1b5a49dcaad5e6873917198">skipTrivialSelect</a>(OpV));</Highlight></CodeLine>
<Link id="l00222" /><CodeLine lineNumber="222"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00223" /><CodeLine lineNumber="223"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (OpI &amp;&amp; ((IsRootAnd &amp;&amp; <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(OpI, <a href="/docs/api/namespaces/llvm/patternmatch/#acf8c16eed89e5ee1a10b6dfc08a33b3a">m&#95;LogicalAnd</a>())) ||</Highlight></CodeLine>
<Link id="l00224" /><CodeLine lineNumber="224"><Highlight kind="normal">                  (IsRootOr  &amp;&amp; <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(OpI, <a href="/docs/api/namespaces/llvm/patternmatch/#a5cce7a41c7581ff15a23ab90eb3b403a">m&#95;LogicalOr</a>())))) &#123;</Highlight></CodeLine>
<Link id="l00225" /><CodeLine lineNumber="225"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Visit this operand.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00226" /><CodeLine lineNumber="226"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Visited.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(OpI).second)</Highlight></CodeLine>
<Link id="l00227" /><CodeLine lineNumber="227"><Highlight kind="normal">          Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(OpI);</Highlight></CodeLine>
<Link id="l00228" /><CodeLine lineNumber="228"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00229" /><CodeLine lineNumber="229"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00230" /><CodeLine lineNumber="230"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (!Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>());</Highlight></CodeLine>
<Link id="l00231" /><CodeLine lineNumber="231"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00232" /><CodeLine lineNumber="232"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> Invariants;</Highlight></CodeLine>
<Link id="l00233" /><CodeLine lineNumber="233"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00234" /><CodeLine lineNumber="234"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00235" /><CodeLine lineNumber="235" lineLink="#a669b909f685098d484bb789192620885"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#a669b909f685098d484bb789192620885">replaceLoopInvariantUses</a>(</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, <a href="/docs/api/classes/llvm/value">Value</a> &#42;Invariant,</Highlight></CodeLine>
<Link id="l00236" /><CodeLine lineNumber="236"><Highlight kind="normal">                                     <a href="/docs/api/classes/llvm/constant">Constant</a> &amp;Replacement) &#123;</Highlight></CodeLine>
<Link id="l00237" /><CodeLine lineNumber="237"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;Constant&gt;</a>(Invariant) &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Why are we unswitching on a constant?&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00238" /><CodeLine lineNumber="238"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00239" /><CodeLine lineNumber="239"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Replace uses of LIC in the loop with the given constant.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00240" /><CodeLine lineNumber="240"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We use make&#95;early&#95;inc&#95;range as set invalidates the iterator.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00241" /><CodeLine lineNumber="241"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/use">Use</a> &amp;U : <a href="/docs/api/namespaces/llvm/#a3d2cdc4a0db233678e7141c9d6ea3419">llvm::make&#95;early&#95;inc&#95;range</a>(Invariant-&gt;<a href="/docs/api/classes/llvm/value/#abf855b7cd63a0cd7f73759e396f280c9">uses</a>())) &#123;</Highlight></CodeLine>
<Link id="l00242" /><CodeLine lineNumber="242"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;UserI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(U.getUser());</Highlight></CodeLine>
<Link id="l00243" /><CodeLine lineNumber="243"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00244" /><CodeLine lineNumber="244"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Replace this use within the loop body.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00245" /><CodeLine lineNumber="245"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UserI &amp;&amp; L.contains(UserI))</Highlight></CodeLine>
<Link id="l00246" /><CodeLine lineNumber="246"><Highlight kind="normal">      U.set(&amp;Replacement);</Highlight></CodeLine>
<Link id="l00247" /><CodeLine lineNumber="247"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00248" /><CodeLine lineNumber="248"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00249" /><CodeLine lineNumber="249"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00250" /><CodeLine lineNumber="250"><Highlight kind="comment">/// Check that all the LCSSA PHI nodes in the loop exit block have trivial</Highlight></CodeLine>
<Link id="l00251" /><CodeLine lineNumber="251"><Highlight kind="comment">/// incoming values along this edge.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00252" /><CodeLine lineNumber="252" lineLink="#a98ebfee3c290028ee7875184aac567ce"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a98ebfee3c290028ee7875184aac567ce">areLoopExitPHIsLoopInvariant</a>(</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L,</Highlight></CodeLine>
<Link id="l00253" /><CodeLine lineNumber="253"><Highlight kind="normal">                                         </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;ExitingBB,</Highlight></CodeLine>
<Link id="l00254" /><CodeLine lineNumber="254"><Highlight kind="normal">                                         </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;ExitBB) &#123;</Highlight></CodeLine>
<Link id="l00255" /><CodeLine lineNumber="255"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : ExitBB) &#123;</Highlight></CodeLine>
<Link id="l00256" /><CodeLine lineNumber="256"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;PN = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;PHINode&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</Highlight></CodeLine>
<Link id="l00257" /><CodeLine lineNumber="257"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!PN)</Highlight></CodeLine>
<Link id="l00258" /><CodeLine lineNumber="258"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// No more PHIs to check.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00259" /><CodeLine lineNumber="259"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00260" /><CodeLine lineNumber="260"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00261" /><CodeLine lineNumber="261"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If the incoming value for this edge isn&#39;t loop invariant the unswitch</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00262" /><CodeLine lineNumber="262"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// won&#39;t be trivial.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00263" /><CodeLine lineNumber="263"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!L.isLoopInvariant(PN-&gt;getIncomingValueForBlock(&amp;ExitingBB)))</Highlight></CodeLine>
<Link id="l00264" /><CodeLine lineNumber="264"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00265" /><CodeLine lineNumber="265"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00266" /><CodeLine lineNumber="266"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/errorhandling-h/#ace243f5c25697a1107cce46626b3dc94">llvm&#95;unreachable</a>(</Highlight><Highlight kind="stringliteral">&quot;Basic blocks should never be empty!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00267" /><CodeLine lineNumber="267"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00268" /><CodeLine lineNumber="268"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00269" /><CodeLine lineNumber="269"><Highlight kind="comment">/// Copy a set of loop invariant values \\p ToDuplicate and insert them at the</Highlight></CodeLine>
<Link id="l00270" /><CodeLine lineNumber="270"><Highlight kind="comment">/// end of \\p BB and conditionally branch on the copied condition. We only</Highlight></CodeLine>
<Link id="l00271" /><CodeLine lineNumber="271"><Highlight kind="comment">/// branch on a single value.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00272" /><CodeLine lineNumber="272" lineLink="#a45b06cc0aa3a6fcbace0aacf3b25a9e6"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#a45b06cc0aa3a6fcbace0aacf3b25a9e6">buildPartialUnswitchConditionalBranch</a>(</Highlight></CodeLine>
<Link id="l00273" /><CodeLine lineNumber="273"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;BB, <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;Value &#42;&gt;</a> Invariants, </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="/docs/api/files/lib/lib/analysis/loopinfo-cpp/#ab4c7e3039b29b12e4dc97bcae93d79c3">Direction</a>,</Highlight></CodeLine>
<Link id="l00274" /><CodeLine lineNumber="274"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;UnswitchedSucc, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;NormalSucc, </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> InsertFreeze,</Highlight></CodeLine>
<Link id="l00275" /><CodeLine lineNumber="275"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &#42;AC, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT) &#123;</Highlight></CodeLine>
<Link id="l00276" /><CodeLine lineNumber="276"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> IRB(&amp;BB);</Highlight></CodeLine>
<Link id="l00277" /><CodeLine lineNumber="277"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00278" /><CodeLine lineNumber="278"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Value &#42;&gt;</a> FrozenInvariants;</Highlight></CodeLine>
<Link id="l00279" /><CodeLine lineNumber="279"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/value">Value</a> &#42;Inv : Invariants) &#123;</Highlight></CodeLine>
<Link id="l00280" /><CodeLine lineNumber="280"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (InsertFreeze &amp;&amp; !<a href="/docs/api/namespaces/llvm/#ab8a7ef433279aabf7f30fa5504a4d4ef">isGuaranteedNotToBeUndefOrPoison</a>(Inv, AC, <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, &amp;DT))</Highlight></CodeLine>
<Link id="l00281" /><CodeLine lineNumber="281"><Highlight kind="normal">      Inv = IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#a563ec77bbc82ad22aab9621dd14c01cd">CreateFreeze</a>(Inv, Inv-&gt;getName() + </Highlight><Highlight kind="stringliteral">&quot;.fr&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00282" /><CodeLine lineNumber="282"><Highlight kind="normal">    FrozenInvariants.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(Inv);</Highlight></CodeLine>
<Link id="l00283" /><CodeLine lineNumber="283"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00284" /><CodeLine lineNumber="284"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00285" /><CodeLine lineNumber="285"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a> = <a href="/docs/api/files/lib/lib/analysis/loopinfo-cpp/#ab4c7e3039b29b12e4dc97bcae93d79c3">Direction</a> ? IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#ab61be8e3cf17e9848aeeeabacfa1b09a">CreateOr</a>(FrozenInvariants)</Highlight></CodeLine>
<Link id="l00286" /><CodeLine lineNumber="286"><Highlight kind="normal">                          : IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#aa4f2cec52a8e17a4c72319334fbef771">CreateAnd</a>(FrozenInvariants);</Highlight></CodeLine>
<Link id="l00287" /><CodeLine lineNumber="287"><Highlight kind="normal">  IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#a972c30f044db799668bdcace5544edeb">CreateCondBr</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, <a href="/docs/api/files/lib/lib/analysis/loopinfo-cpp/#ab4c7e3039b29b12e4dc97bcae93d79c3">Direction</a> ? &amp;UnswitchedSucc : &amp;NormalSucc,</Highlight></CodeLine>
<Link id="l00288" /><CodeLine lineNumber="288"><Highlight kind="normal">                   <a href="/docs/api/files/lib/lib/analysis/loopinfo-cpp/#ab4c7e3039b29b12e4dc97bcae93d79c3">Direction</a> ? &amp;NormalSucc : &amp;UnswitchedSucc);</Highlight></CodeLine>
<Link id="l00289" /><CodeLine lineNumber="289"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00290" /><CodeLine lineNumber="290"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00291" /><CodeLine lineNumber="291"><Highlight kind="comment">/// Copy a set of loop invariant values, and conditionally branch on them.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00292" /><CodeLine lineNumber="292" lineLink="#a0eaf12b7854445670a7b0af3fe87b86c"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#a0eaf12b7854445670a7b0af3fe87b86c">buildPartialInvariantUnswitchConditionalBranch</a>(</Highlight></CodeLine>
<Link id="l00293" /><CodeLine lineNumber="293"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;BB, <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;Value &#42;&gt;</a> ToDuplicate, </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="/docs/api/files/lib/lib/analysis/loopinfo-cpp/#ab4c7e3039b29b12e4dc97bcae93d79c3">Direction</a>,</Highlight></CodeLine>
<Link id="l00294" /><CodeLine lineNumber="294"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;UnswitchedSucc, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;NormalSucc, <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L,</Highlight></CodeLine>
<Link id="l00295" /><CodeLine lineNumber="295"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42;MSSAU) &#123;</Highlight></CodeLine>
<Link id="l00296" /><CodeLine lineNumber="296"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> VMap;</Highlight></CodeLine>
<Link id="l00297" /><CodeLine lineNumber="297"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;Val : <a href="/docs/api/namespaces/llvm/#a6b0ac1fa4f05de76413c5e0ca6334035">reverse</a>(ToDuplicate)) &#123;</Highlight></CodeLine>
<Link id="l00298" /><CodeLine lineNumber="298"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Inst = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Instruction&gt;</a>(Val);</Highlight></CodeLine>
<Link id="l00299" /><CodeLine lineNumber="299"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;NewInst = Inst-&gt;<a href="/docs/api/classes/llvm/instruction/#a0a4d51e372293abe5e5f6dac133e80a6">clone</a>();</Highlight></CodeLine>
<Link id="l00300" /><CodeLine lineNumber="300"><Highlight kind="normal">    NewInst-&gt;<a href="/docs/api/classes/llvm/instruction/#afcd9d2ea284c4d90541291ff9c47d332">insertInto</a>(&amp;BB, BB.<a href="/docs/api/classes/llvm/basicblock/#a0b4e7bee9b8575cc7db73329f1a561bd">end</a>());</Highlight></CodeLine>
<Link id="l00301" /><CodeLine lineNumber="301"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a7da684e1cead3524bdd9b0d171aad161">RemapInstruction</a>(NewInst, VMap,</Highlight></CodeLine>
<Link id="l00302" /><CodeLine lineNumber="302"><Highlight kind="normal">                     <a href="/docs/api/namespaces/llvm/#a77724415203930efd07d7098cb1e437da9a24bd8dba1bef2753bc3f087435ae7f">RF&#95;NoModuleLevelChanges</a> | <a href="/docs/api/namespaces/llvm/#a77724415203930efd07d7098cb1e437da5633028bc27ffa8eab39cc5de65b3108">RF&#95;IgnoreMissingLocals</a>);</Highlight></CodeLine>
<Link id="l00303" /><CodeLine lineNumber="303"><Highlight kind="normal">    VMap&#91;Val&#93; = NewInst;</Highlight></CodeLine>
<Link id="l00304" /><CodeLine lineNumber="304"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00305" /><CodeLine lineNumber="305"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!MSSAU)</Highlight></CodeLine>
<Link id="l00306" /><CodeLine lineNumber="306"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00307" /><CodeLine lineNumber="307"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00308" /><CodeLine lineNumber="308"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/memoryssa">MemorySSA</a> &#42;MSSA = MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a01a350909e784d6fa43181a72de61529">getMemorySSA</a>();</Highlight></CodeLine>
<Link id="l00309" /><CodeLine lineNumber="309"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;MemUse =</Highlight></CodeLine>
<Link id="l00310" /><CodeLine lineNumber="310"><Highlight kind="normal">            <a href="/docs/api/namespaces/llvm/#a5f6182886dc2f96c204299e92c1565d5">dyn&#95;cast&#95;or&#95;null&lt;MemoryUse&gt;</a>(MSSA-&gt;<a href="/docs/api/classes/llvm/memoryssa/#ab15de610fca1c900038bf3c333919e45">getMemoryAccess</a>(Inst))) &#123;</Highlight></CodeLine>
<Link id="l00311" /><CodeLine lineNumber="311"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;DefiningAccess = MemUse-&gt;getDefiningAccess();</Highlight></CodeLine>
<Link id="l00312" /><CodeLine lineNumber="312"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Get the first defining access before the loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00313" /><CodeLine lineNumber="313"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (L.contains(DefiningAccess-&gt;getBlock())) &#123;</Highlight></CodeLine>
<Link id="l00314" /><CodeLine lineNumber="314"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// If the defining access is a MemoryPhi, get the incoming</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00315" /><CodeLine lineNumber="315"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// value for the pre-header as defining access.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00316" /><CodeLine lineNumber="316"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;MemPhi = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;MemoryPhi&gt;</a>(DefiningAccess))</Highlight></CodeLine>
<Link id="l00317" /><CodeLine lineNumber="317"><Highlight kind="normal">          DefiningAccess =</Highlight></CodeLine>
<Link id="l00318" /><CodeLine lineNumber="318"><Highlight kind="normal">              MemPhi-&gt;getIncomingValueForBlock(L.getLoopPreheader());</Highlight></CodeLine>
<Link id="l00319" /><CodeLine lineNumber="319"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00320" /><CodeLine lineNumber="320"><Highlight kind="normal">          DefiningAccess = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;MemoryDef&gt;</a>(DefiningAccess)-&gt;getDefiningAccess();</Highlight></CodeLine>
<Link id="l00321" /><CodeLine lineNumber="321"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00322" /><CodeLine lineNumber="322"><Highlight kind="normal">      MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#ab23ba05c48e8be4a29c36d83deba9146">createMemoryAccessInBB</a>(NewInst, DefiningAccess,</Highlight></CodeLine>
<Link id="l00323" /><CodeLine lineNumber="323"><Highlight kind="normal">                                    NewInst-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>(),</Highlight></CodeLine>
<Link id="l00324" /><CodeLine lineNumber="324"><Highlight kind="normal">                                    <a href="/docs/api/classes/llvm/memoryssa/#a9773fde54683945b9e34a0f2e5c1a5a5a7806c120eb87aea9fbb52fed327e09de">MemorySSA::BeforeTerminator</a>);</Highlight></CodeLine>
<Link id="l00325" /><CodeLine lineNumber="325"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00326" /><CodeLine lineNumber="326"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00327" /><CodeLine lineNumber="327"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00328" /><CodeLine lineNumber="328"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> IRB(&amp;BB);</Highlight></CodeLine>
<Link id="l00329" /><CodeLine lineNumber="329"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a> = VMap&#91;ToDuplicate&#91;0&#93;&#93;;</Highlight></CodeLine>
<Link id="l00330" /><CodeLine lineNumber="330"><Highlight kind="normal">  IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#a972c30f044db799668bdcace5544edeb">CreateCondBr</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, <a href="/docs/api/files/lib/lib/analysis/loopinfo-cpp/#ab4c7e3039b29b12e4dc97bcae93d79c3">Direction</a> ? &amp;UnswitchedSucc : &amp;NormalSucc,</Highlight></CodeLine>
<Link id="l00331" /><CodeLine lineNumber="331"><Highlight kind="normal">                   <a href="/docs/api/files/lib/lib/analysis/loopinfo-cpp/#ab4c7e3039b29b12e4dc97bcae93d79c3">Direction</a> ? &amp;NormalSucc : &amp;UnswitchedSucc);</Highlight></CodeLine>
<Link id="l00332" /><CodeLine lineNumber="332"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00333" /><CodeLine lineNumber="333"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00334" /><CodeLine lineNumber="334"><Highlight kind="comment">/// Rewrite the PHI nodes in an unswitched loop exit basic block.</Highlight></CodeLine>
<Link id="l00335" /><CodeLine lineNumber="335"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00336" /><CodeLine lineNumber="336"><Highlight kind="comment">/// Requires that the loop exit and unswitched basic block are the same, and</Highlight></CodeLine>
<Link id="l00337" /><CodeLine lineNumber="337"><Highlight kind="comment">/// that the exiting block was a unique predecessor of that block. Rewrites the</Highlight></CodeLine>
<Link id="l00338" /><CodeLine lineNumber="338"><Highlight kind="comment">/// PHI nodes in that block such that what were LCSSA PHI nodes become trivial</Highlight></CodeLine>
<Link id="l00339" /><CodeLine lineNumber="339"><Highlight kind="comment">/// PHI nodes from the old preheader that now contains the unswitched</Highlight></CodeLine>
<Link id="l00340" /><CodeLine lineNumber="340"><Highlight kind="comment">/// terminator.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00341" /><CodeLine lineNumber="341" lineLink="#a003a854484a7b23c151bc0b3d684e5d9"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#a003a854484a7b23c151bc0b3d684e5d9">rewritePHINodesForUnswitchedExitBlock</a>(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;UnswitchedBB,</Highlight></CodeLine>
<Link id="l00342" /><CodeLine lineNumber="342"><Highlight kind="normal">                                                  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;OldExitingBB,</Highlight></CodeLine>
<Link id="l00343" /><CodeLine lineNumber="343"><Highlight kind="normal">                                                  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;OldPH) &#123;</Highlight></CodeLine>
<Link id="l00344" /><CodeLine lineNumber="344"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/phinode">PHINode</a> &amp;PN : UnswitchedBB.<a href="/docs/api/classes/llvm/basicblock/#a13da92d2694197fbcb5b95fd94e7570d">phis</a>()) &#123;</Highlight></CodeLine>
<Link id="l00345" /><CodeLine lineNumber="345"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// When the loop exit is directly unswitched we just need to update the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00346" /><CodeLine lineNumber="346"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// incoming basic block. We loop to handle weird cases with repeated</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00347" /><CodeLine lineNumber="347"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// incoming blocks, but expect to typically only have one operand here.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00348" /><CodeLine lineNumber="348"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> i : <a href="/docs/api/namespaces/llvm/#adc4eb8be6f7a12ede962987fb9cabb47">seq&lt;int&gt;</a>(0, PN.getNumOperands())) &#123;</Highlight></CodeLine>
<Link id="l00349" /><CodeLine lineNumber="349"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(PN.getIncomingBlock(i) == &amp;OldExitingBB &amp;&amp;</Highlight></CodeLine>
<Link id="l00350" /><CodeLine lineNumber="350"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;Found incoming block different from unique predecessor!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00351" /><CodeLine lineNumber="351"><Highlight kind="normal">      PN.setIncomingBlock(i, &amp;OldPH);</Highlight></CodeLine>
<Link id="l00352" /><CodeLine lineNumber="352"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00353" /><CodeLine lineNumber="353"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00354" /><CodeLine lineNumber="354"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00355" /><CodeLine lineNumber="355"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00356" /><CodeLine lineNumber="356"><Highlight kind="comment">/// Rewrite the PHI nodes in the loop exit basic block and the split off</Highlight></CodeLine>
<Link id="l00357" /><CodeLine lineNumber="357"><Highlight kind="comment">/// unswitched block.</Highlight></CodeLine>
<Link id="l00358" /><CodeLine lineNumber="358"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00359" /><CodeLine lineNumber="359"><Highlight kind="comment">/// Because the exit block remains an exit from the loop, this rewrites the</Highlight></CodeLine>
<Link id="l00360" /><CodeLine lineNumber="360"><Highlight kind="comment">/// LCSSA PHI nodes in it to remove the unswitched edge and introduces PHI</Highlight></CodeLine>
<Link id="l00361" /><CodeLine lineNumber="361"><Highlight kind="comment">/// nodes into the unswitched basic block to select between the value in the</Highlight></CodeLine>
<Link id="l00362" /><CodeLine lineNumber="362"><Highlight kind="comment">/// old preheader and the loop exit.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00363" /><CodeLine lineNumber="363" lineLink="#a9a1db01205f9a51a14b99e53e3068da1"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#a9a1db01205f9a51a14b99e53e3068da1">rewritePHINodesForExitAndUnswitchedBlocks</a>(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;ExitBB,</Highlight></CodeLine>
<Link id="l00364" /><CodeLine lineNumber="364"><Highlight kind="normal">                                                      <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;UnswitchedBB,</Highlight></CodeLine>
<Link id="l00365" /><CodeLine lineNumber="365"><Highlight kind="normal">                                                      <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;OldExitingBB,</Highlight></CodeLine>
<Link id="l00366" /><CodeLine lineNumber="366"><Highlight kind="normal">                                                      <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;OldPH,</Highlight></CodeLine>
<Link id="l00367" /><CodeLine lineNumber="367"><Highlight kind="normal">                                                      </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> FullUnswitch) &#123;</Highlight></CodeLine>
<Link id="l00368" /><CodeLine lineNumber="368"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(&amp;ExitBB != &amp;UnswitchedBB &amp;&amp;</Highlight></CodeLine>
<Link id="l00369" /><CodeLine lineNumber="369"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;Must have different loop exit and unswitched blocks!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00370" /><CodeLine lineNumber="370"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> InsertPt = UnswitchedBB.<a href="/docs/api/classes/llvm/basicblock/#a0ed5f3ab3c2e4196ee0cffffa080c062">begin</a>();</Highlight></CodeLine>
<Link id="l00371" /><CodeLine lineNumber="371"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/phinode">PHINode</a> &amp;PN : ExitBB.<a href="/docs/api/classes/llvm/basicblock/#a13da92d2694197fbcb5b95fd94e7570d">phis</a>()) &#123;</Highlight></CodeLine>
<Link id="l00372" /><CodeLine lineNumber="372"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;NewPN = <a href="/docs/api/classes/llvm/phinode/#af4aba918a76ca15bde1be3e14572e475">PHINode::Create</a>(PN.getType(), </Highlight><Highlight kind="comment">/&#42;NumReservedValues&#42;/</Highlight><Highlight kind="normal"> 2,</Highlight></CodeLine>
<Link id="l00373" /><CodeLine lineNumber="373"><Highlight kind="normal">                                  PN.getName() + </Highlight><Highlight kind="stringliteral">&quot;.split&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00374" /><CodeLine lineNumber="374"><Highlight kind="normal">    NewPN-&gt;insertBefore(InsertPt);</Highlight></CodeLine>
<Link id="l00375" /><CodeLine lineNumber="375"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00376" /><CodeLine lineNumber="376"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Walk backwards over the old PHI node&#39;s inputs to minimize the cost of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00377" /><CodeLine lineNumber="377"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// removing each one. We have to do this weird loop manually so that we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00378" /><CodeLine lineNumber="378"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// create the same number of new incoming edges in the new PHI as we expect</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00379" /><CodeLine lineNumber="379"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// each case-based edge to be included in the unswitched switch in some</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00380" /><CodeLine lineNumber="380"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// cases.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00381" /><CodeLine lineNumber="381"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// FIXME: This is really, really gross. It would be much cleaner if LLVM</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00382" /><CodeLine lineNumber="382"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// allowed us to create a single entry for a predecessor block without</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00383" /><CodeLine lineNumber="383"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// having separate entries for each &quot;edge&quot; even though these edges are</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00384" /><CodeLine lineNumber="384"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// required to produce identical results.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00385" /><CodeLine lineNumber="385"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> i = PN.getNumIncomingValues() - 1; i &gt;= 0; --i) &#123;</Highlight></CodeLine>
<Link id="l00386" /><CodeLine lineNumber="386"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (PN.getIncomingBlock(i) != &amp;OldExitingBB)</Highlight></CodeLine>
<Link id="l00387" /><CodeLine lineNumber="387"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00388" /><CodeLine lineNumber="388"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00389" /><CodeLine lineNumber="389"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/structs/llvm/incoming">Incoming</a> = PN.getIncomingValue(i);</Highlight></CodeLine>
<Link id="l00390" /><CodeLine lineNumber="390"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (FullUnswitch)</Highlight></CodeLine>
<Link id="l00391" /><CodeLine lineNumber="391"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// No more edge from the old exiting block to the exit block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00392" /><CodeLine lineNumber="392"><Highlight kind="normal">        PN.removeIncomingValue(i);</Highlight></CodeLine>
<Link id="l00393" /><CodeLine lineNumber="393"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00394" /><CodeLine lineNumber="394"><Highlight kind="normal">      NewPN-&gt;addIncoming(<a href="/docs/api/structs/llvm/incoming">Incoming</a>, &amp;OldPH);</Highlight></CodeLine>
<Link id="l00395" /><CodeLine lineNumber="395"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00396" /><CodeLine lineNumber="396"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00397" /><CodeLine lineNumber="397"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Now replace the old PHI with the new one and wire the old one in as an</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00398" /><CodeLine lineNumber="398"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// input to the new one.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00399" /><CodeLine lineNumber="399"><Highlight kind="normal">    PN.replaceAllUsesWith(NewPN);</Highlight></CodeLine>
<Link id="l00400" /><CodeLine lineNumber="400"><Highlight kind="normal">    NewPN-&gt;addIncoming(&amp;PN, &amp;ExitBB);</Highlight></CodeLine>
<Link id="l00401" /><CodeLine lineNumber="401"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00402" /><CodeLine lineNumber="402"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00403" /><CodeLine lineNumber="403"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00404" /><CodeLine lineNumber="404"><Highlight kind="comment">/// Hoist the current loop up to the innermost loop containing a remaining exit.</Highlight></CodeLine>
<Link id="l00405" /><CodeLine lineNumber="405"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00406" /><CodeLine lineNumber="406"><Highlight kind="comment">/// Because we&#39;ve removed an exit from the loop, we may have changed the set of</Highlight></CodeLine>
<Link id="l00407" /><CodeLine lineNumber="407"><Highlight kind="comment">/// loops reachable and need to move the current loop up the loop nest or even</Highlight></CodeLine>
<Link id="l00408" /><CodeLine lineNumber="408"><Highlight kind="comment">/// to an entirely separate nest.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00409" /><CodeLine lineNumber="409" lineLink="#afa8d35023dc30883011a5641eac69d38"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#afa8d35023dc30883011a5641eac69d38">hoistLoopToNewParent</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;Preheader,</Highlight></CodeLine>
<Link id="l00410" /><CodeLine lineNumber="410"><Highlight kind="normal">                                 <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI,</Highlight></CodeLine>
<Link id="l00411" /><CodeLine lineNumber="411"><Highlight kind="normal">                                 <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42;MSSAU, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42;SE) &#123;</Highlight></CodeLine>
<Link id="l00412" /><CodeLine lineNumber="412"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If the loop is already at the top level, we can&#39;t hoist it anywhere.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00413" /><CodeLine lineNumber="413"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;OldParentL = L.getParentLoop();</Highlight></CodeLine>
<Link id="l00414" /><CodeLine lineNumber="414"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!OldParentL)</Highlight></CodeLine>
<Link id="l00415" /><CodeLine lineNumber="415"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00416" /><CodeLine lineNumber="416"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00417" /><CodeLine lineNumber="417"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 4&gt;</a> Exits;</Highlight></CodeLine>
<Link id="l00418" /><CodeLine lineNumber="418"><Highlight kind="normal">  L.getExitBlocks(Exits);</Highlight></CodeLine>
<Link id="l00419" /><CodeLine lineNumber="419"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;NewParentL = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00420" /><CodeLine lineNumber="420"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ExitBB : Exits)</Highlight></CodeLine>
<Link id="l00421" /><CodeLine lineNumber="421"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ExitL = LI.<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(ExitBB))</Highlight></CodeLine>
<Link id="l00422" /><CodeLine lineNumber="422"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!NewParentL || NewParentL-&gt;<a href="/docs/api/classes/llvm/loopbase/#a04337b572d34ea413c35dbac5d75530b">contains</a>(ExitL))</Highlight></CodeLine>
<Link id="l00423" /><CodeLine lineNumber="423"><Highlight kind="normal">        NewParentL = ExitL;</Highlight></CodeLine>
<Link id="l00424" /><CodeLine lineNumber="424"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00425" /><CodeLine lineNumber="425"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (NewParentL == OldParentL)</Highlight></CodeLine>
<Link id="l00426" /><CodeLine lineNumber="426"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00427" /><CodeLine lineNumber="427"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00428" /><CodeLine lineNumber="428"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The new parent loop (if different) should always contain the old one.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00429" /><CodeLine lineNumber="429"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (NewParentL)</Highlight></CodeLine>
<Link id="l00430" /><CodeLine lineNumber="430"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(NewParentL-&gt;<a href="/docs/api/classes/llvm/loopbase/#a04337b572d34ea413c35dbac5d75530b">contains</a>(OldParentL) &amp;&amp;</Highlight></CodeLine>
<Link id="l00431" /><CodeLine lineNumber="431"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;Can only hoist this loop up the nest!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00432" /><CodeLine lineNumber="432"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00433" /><CodeLine lineNumber="433"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The preheader will need to move with the body of this loop. However,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00434" /><CodeLine lineNumber="434"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// because it isn&#39;t in this loop we also need to update the primary loop map.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00435" /><CodeLine lineNumber="435"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(OldParentL == LI.<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(&amp;Preheader) &amp;&amp;</Highlight></CodeLine>
<Link id="l00436" /><CodeLine lineNumber="436"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;Parent loop of this loop should contain this loop&#39;s preheader!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00437" /><CodeLine lineNumber="437"><Highlight kind="normal">  LI.<a href="/docs/api/classes/llvm/loopinfobase/#a97de9fb6fdce68e4e31300fcf0e5a20c">changeLoopFor</a>(&amp;Preheader, NewParentL);</Highlight></CodeLine>
<Link id="l00438" /><CodeLine lineNumber="438"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00439" /><CodeLine lineNumber="439"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Remove this loop from its old parent.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00440" /><CodeLine lineNumber="440"><Highlight kind="normal">  OldParentL-&gt;<a href="/docs/api/classes/llvm/loopbase/#afd824d78def66604189ab07c6266572d">removeChildLoop</a>(&amp;L);</Highlight></CodeLine>
<Link id="l00441" /><CodeLine lineNumber="441"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00442" /><CodeLine lineNumber="442"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Add the loop either to the new parent or as a top-level loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00443" /><CodeLine lineNumber="443"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (NewParentL)</Highlight></CodeLine>
<Link id="l00444" /><CodeLine lineNumber="444"><Highlight kind="normal">    NewParentL-&gt;<a href="/docs/api/classes/llvm/loopbase/#a990a86b0de7a84a9f489d2034878e330">addChildLoop</a>(&amp;L);</Highlight></CodeLine>
<Link id="l00445" /><CodeLine lineNumber="445"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00446" /><CodeLine lineNumber="446"><Highlight kind="normal">    LI.<a href="/docs/api/classes/llvm/loopinfobase/#a1e4ac7b073d744d43f3cb1a3660c03c3">addTopLevelLoop</a>(&amp;L);</Highlight></CodeLine>
<Link id="l00447" /><CodeLine lineNumber="447"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00448" /><CodeLine lineNumber="448"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Remove this loops blocks from the old parent and every other loop up the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00449" /><CodeLine lineNumber="449"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// nest until reaching the new parent. Also update all of these</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00450" /><CodeLine lineNumber="450"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// no-longer-containing loops to reflect the nesting change.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00451" /><CodeLine lineNumber="451"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;OldContainingL = OldParentL; OldContainingL != NewParentL;</Highlight></CodeLine>
<Link id="l00452" /><CodeLine lineNumber="452"><Highlight kind="normal">       OldContainingL = OldContainingL-&gt;<a href="/docs/api/classes/llvm/loopbase/#ae34bcd53f75fab0c03b509ecccb4cfaf">getParentLoop</a>()) &#123;</Highlight></CodeLine>
<Link id="l00453" /><CodeLine lineNumber="453"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#ac9a7de5a04920954ac964059cfc428ad">llvm::erase&#95;if</a>(OldContainingL-&gt;getBlocksVector(),</Highlight></CodeLine>
<Link id="l00454" /><CodeLine lineNumber="454"><Highlight kind="normal">                   &#91;&amp;&#93;(</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB) &#123;</Highlight></CodeLine>
<Link id="l00455" /><CodeLine lineNumber="455"><Highlight kind="normal">                     return BB == &amp;Preheader || L.contains(BB);</Highlight></CodeLine>
<Link id="l00456" /><CodeLine lineNumber="456"><Highlight kind="normal">                   &#125;);</Highlight></CodeLine>
<Link id="l00457" /><CodeLine lineNumber="457"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00458" /><CodeLine lineNumber="458"><Highlight kind="normal">    OldContainingL-&gt;getBlocksSet().erase(&amp;Preheader);</Highlight></CodeLine>
<Link id="l00459" /><CodeLine lineNumber="459"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB : L.blocks())</Highlight></CodeLine>
<Link id="l00460" /><CodeLine lineNumber="460"><Highlight kind="normal">      OldContainingL-&gt;getBlocksSet().erase(BB);</Highlight></CodeLine>
<Link id="l00461" /><CodeLine lineNumber="461"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00462" /><CodeLine lineNumber="462"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Because we just hoisted a loop out of this one, we have essentially</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00463" /><CodeLine lineNumber="463"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// created new exit paths from it. That means we need to form LCSSA PHI</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00464" /><CodeLine lineNumber="464"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// nodes for values used in the no-longer-nested loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00465" /><CodeLine lineNumber="465"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#ae852af0cb2b1bee6f725a552cf7cfdea">formLCSSA</a>(&#42;OldContainingL, DT, &amp;LI, SE);</Highlight></CodeLine>
<Link id="l00466" /><CodeLine lineNumber="466"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00467" /><CodeLine lineNumber="467"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We shouldn&#39;t need to form dedicated exits because the exit introduced</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00468" /><CodeLine lineNumber="468"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// here is the (just split by unswitching) preheader. However, after trivial</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00469" /><CodeLine lineNumber="469"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// unswitching it is possible to get new non-dedicated exits out of parent</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00470" /><CodeLine lineNumber="470"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// loop so let&#39;s conservatively form dedicated exit blocks and figure out</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00471" /><CodeLine lineNumber="471"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// if we can optimize later.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00472" /><CodeLine lineNumber="472"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#ab1f7831449cd72e78894e3dcda705cd8">formDedicatedExitBlocks</a>(OldContainingL, &amp;DT, &amp;LI, MSSAU,</Highlight></CodeLine>
<Link id="l00473" /><CodeLine lineNumber="473"><Highlight kind="normal">                            </Highlight><Highlight kind="comment">/&#42;PreserveLCSSA&#42;/</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00474" /><CodeLine lineNumber="474"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00475" /><CodeLine lineNumber="475"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00476" /><CodeLine lineNumber="476"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00477" /><CodeLine lineNumber="477"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Return the top-most loop containing ExitBB and having ExitBB as exiting block</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00478" /><CodeLine lineNumber="478"><Highlight kind="normal"></Highlight><Highlight kind="comment">// or the loop containing ExitBB, if there is no parent loop containing ExitBB</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00479" /><CodeLine lineNumber="479"><Highlight kind="normal"></Highlight><Highlight kind="comment">// as exiting block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00480" /><CodeLine lineNumber="480" lineLink="#a5e771bd40bbd3121ec36a96aa44ef46a"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;<a href="#a5e771bd40bbd3121ec36a96aa44ef46a">getTopMostExitingLoop</a>(</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ExitBB,</Highlight></CodeLine>
<Link id="l00481" /><CodeLine lineNumber="481"><Highlight kind="normal">                                   </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI) &#123;</Highlight></CodeLine>
<Link id="l00482" /><CodeLine lineNumber="482"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;TopMost = LI.<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(ExitBB);</Highlight></CodeLine>
<Link id="l00483" /><CodeLine lineNumber="483"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;Current = TopMost;</Highlight></CodeLine>
<Link id="l00484" /><CodeLine lineNumber="484"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (Current) &#123;</Highlight></CodeLine>
<Link id="l00485" /><CodeLine lineNumber="485"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Current-&gt;<a href="/docs/api/classes/llvm/loopbase/#af691775d5a45e28afbdb3e97cab22eee">isLoopExiting</a>(ExitBB))</Highlight></CodeLine>
<Link id="l00486" /><CodeLine lineNumber="486"><Highlight kind="normal">      TopMost = Current;</Highlight></CodeLine>
<Link id="l00487" /><CodeLine lineNumber="487"><Highlight kind="normal">    Current = Current-&gt;<a href="/docs/api/classes/llvm/loopbase/#ae34bcd53f75fab0c03b509ecccb4cfaf">getParentLoop</a>();</Highlight></CodeLine>
<Link id="l00488" /><CodeLine lineNumber="488"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00489" /><CodeLine lineNumber="489"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> TopMost;</Highlight></CodeLine>
<Link id="l00490" /><CodeLine lineNumber="490"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00491" /><CodeLine lineNumber="491"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00492" /><CodeLine lineNumber="492"><Highlight kind="comment">/// Unswitch a trivial branch if the condition is loop invariant.</Highlight></CodeLine>
<Link id="l00493" /><CodeLine lineNumber="493"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00494" /><CodeLine lineNumber="494"><Highlight kind="comment">/// This routine should only be called when loop code leading to the branch has</Highlight></CodeLine>
<Link id="l00495" /><CodeLine lineNumber="495"><Highlight kind="comment">/// been validated as trivial (no side effects). This routine checks if the</Highlight></CodeLine>
<Link id="l00496" /><CodeLine lineNumber="496"><Highlight kind="comment">/// condition is invariant and one of the successors is a loop exit. This</Highlight></CodeLine>
<Link id="l00497" /><CodeLine lineNumber="497"><Highlight kind="comment">/// allows us to unswitch without duplicating the loop, making it trivial.</Highlight></CodeLine>
<Link id="l00498" /><CodeLine lineNumber="498"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00499" /><CodeLine lineNumber="499"><Highlight kind="comment">/// If this routine fails to unswitch the branch it returns false.</Highlight></CodeLine>
<Link id="l00500" /><CodeLine lineNumber="500"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00501" /><CodeLine lineNumber="501"><Highlight kind="comment">/// If the branch can be unswitched, this routine splits the preheader and</Highlight></CodeLine>
<Link id="l00502" /><CodeLine lineNumber="502"><Highlight kind="comment">/// hoists the branch above that split. Preserves loop simplified form</Highlight></CodeLine>
<Link id="l00503" /><CodeLine lineNumber="503"><Highlight kind="comment">/// (splitting the exit block as necessary). It simplifies the branch within</Highlight></CodeLine>
<Link id="l00504" /><CodeLine lineNumber="504"><Highlight kind="comment">/// the loop to an unconditional branch but doesn&#39;t remove it entirely. Further</Highlight></CodeLine>
<Link id="l00505" /><CodeLine lineNumber="505"><Highlight kind="comment">/// cleanup can be done with some simplifycfg like pass.</Highlight></CodeLine>
<Link id="l00506" /><CodeLine lineNumber="506"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00507" /><CodeLine lineNumber="507"><Highlight kind="comment">/// If &#96;SE&#96; is not null, it will be updated based on the potential loop SCEVs</Highlight></CodeLine>
<Link id="l00508" /><CodeLine lineNumber="508"><Highlight kind="comment">/// invalidated by this.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00509" /><CodeLine lineNumber="509" lineLink="#a6a082aa2e05f44f7dab89e2ff8c582ff"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a6a082aa2e05f44f7dab89e2ff8c582ff">unswitchTrivialBranch</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &amp;BI, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT,</Highlight></CodeLine>
<Link id="l00510" /><CodeLine lineNumber="510"><Highlight kind="normal">                                  <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42;SE,</Highlight></CodeLine>
<Link id="l00511" /><CodeLine lineNumber="511"><Highlight kind="normal">                                  <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42;MSSAU) &#123;</Highlight></CodeLine>
<Link id="l00512" /><CodeLine lineNumber="512"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BI.<a href="/docs/api/classes/llvm/branchinst/#a7e4be8b16fbd68c9045a388904044e01">isConditional</a>() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Can only unswitch a conditional branch!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00513" /><CodeLine lineNumber="513"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Trying to unswitch branch: &quot;</Highlight><Highlight kind="normal"> &lt;&lt; BI &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00514" /><CodeLine lineNumber="514"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00515" /><CodeLine lineNumber="515"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The loop invariant values that we want to unswitch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00516" /><CodeLine lineNumber="516"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/tinyptrvector">TinyPtrVector&lt;Value &#42;&gt;</a> Invariants;</Highlight></CodeLine>
<Link id="l00517" /><CodeLine lineNumber="517"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00518" /><CodeLine lineNumber="518"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// When true, we&#39;re fully unswitching the branch rather than just unswitching</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00519" /><CodeLine lineNumber="519"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// some input conditions to the branch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00520" /><CodeLine lineNumber="520"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> FullUnswitch = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00521" /><CodeLine lineNumber="521"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00522" /><CodeLine lineNumber="522"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a> = <a href="#a5ca2e820d1b5a49dcaad5e6873917198">skipTrivialSelect</a>(BI.<a href="/docs/api/classes/llvm/branchinst/#aebd4af5642453ce3169094f08dd3d7b8">getCondition</a>());</Highlight></CodeLine>
<Link id="l00523" /><CodeLine lineNumber="523"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L.isLoopInvariant(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>)) &#123;</Highlight></CodeLine>
<Link id="l00524" /><CodeLine lineNumber="524"><Highlight kind="normal">    Invariants.<a href="/docs/api/classes/llvm/tinyptrvector/#a1437e12220a4cd03b10656dcb607c642">push&#95;back</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>);</Highlight></CodeLine>
<Link id="l00525" /><CodeLine lineNumber="525"><Highlight kind="normal">    FullUnswitch = </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00526" /><CodeLine lineNumber="526"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00527" /><CodeLine lineNumber="527"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;CondInst = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>))</Highlight></CodeLine>
<Link id="l00528" /><CodeLine lineNumber="528"><Highlight kind="normal">      Invariants = <a href="#a1061b839196c8068b89d05aced41de29">collectHomogenousInstGraphLoopInvariants</a>(L, &#42;CondInst, LI);</Highlight></CodeLine>
<Link id="l00529" /><CodeLine lineNumber="529"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Invariants.<a href="/docs/api/classes/llvm/tinyptrvector/#a9dc659b723e6725130ad354ed821d400">empty</a>()) &#123;</Highlight></CodeLine>
<Link id="l00530" /><CodeLine lineNumber="530"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;   Couldn&#39;t find invariant inputs!\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00531" /><CodeLine lineNumber="531"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00532" /><CodeLine lineNumber="532"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00533" /><CodeLine lineNumber="533"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00534" /><CodeLine lineNumber="534"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00535" /><CodeLine lineNumber="535"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Check that one of the branch&#39;s successors exits, and which one.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00536" /><CodeLine lineNumber="536"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> ExitDirection = </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00537" /><CodeLine lineNumber="537"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> LoopExitSuccIdx = 0;</Highlight></CodeLine>
<Link id="l00538" /><CodeLine lineNumber="538"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;LoopExitBB = BI.<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(0);</Highlight></CodeLine>
<Link id="l00539" /><CodeLine lineNumber="539"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L.contains(LoopExitBB)) &#123;</Highlight></CodeLine>
<Link id="l00540" /><CodeLine lineNumber="540"><Highlight kind="normal">    ExitDirection = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00541" /><CodeLine lineNumber="541"><Highlight kind="normal">    LoopExitSuccIdx = 1;</Highlight></CodeLine>
<Link id="l00542" /><CodeLine lineNumber="542"><Highlight kind="normal">    LoopExitBB = BI.<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(1);</Highlight></CodeLine>
<Link id="l00543" /><CodeLine lineNumber="543"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L.contains(LoopExitBB)) &#123;</Highlight></CodeLine>
<Link id="l00544" /><CodeLine lineNumber="544"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;   Branch doesn&#39;t exit the loop!\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00545" /><CodeLine lineNumber="545"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00546" /><CodeLine lineNumber="546"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00547" /><CodeLine lineNumber="547"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00548" /><CodeLine lineNumber="548"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ContinueBB = BI.<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(1 - LoopExitSuccIdx);</Highlight></CodeLine>
<Link id="l00549" /><CodeLine lineNumber="549"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ParentBB = BI.<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>();</Highlight></CodeLine>
<Link id="l00550" /><CodeLine lineNumber="550"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="#a98ebfee3c290028ee7875184aac567ce">areLoopExitPHIsLoopInvariant</a>(L, &#42;ParentBB, &#42;LoopExitBB)) &#123;</Highlight></CodeLine>
<Link id="l00551" /><CodeLine lineNumber="551"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;   Loop exit PHI&#39;s aren&#39;t loop-invariant!\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00552" /><CodeLine lineNumber="552"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00553" /><CodeLine lineNumber="553"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00554" /><CodeLine lineNumber="554"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00555" /><CodeLine lineNumber="555"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// When unswitching only part of the branch&#39;s condition, we need the exit</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00556" /><CodeLine lineNumber="556"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// block to be reached directly from the partially unswitched input. This can</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00557" /><CodeLine lineNumber="557"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// be done when the exit block is along the true edge and the branch condition</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00558" /><CodeLine lineNumber="558"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// is a graph of &#96;or&#96; operations, or the exit block is along the false edge</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00559" /><CodeLine lineNumber="559"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// and the condition is a graph of &#96;and&#96; operations.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00560" /><CodeLine lineNumber="560"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!FullUnswitch) &#123;</Highlight></CodeLine>
<Link id="l00561" /><CodeLine lineNumber="561"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (ExitDirection ? !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, <a href="/docs/api/namespaces/llvm/patternmatch/#a5cce7a41c7581ff15a23ab90eb3b403a">m&#95;LogicalOr</a>())</Highlight></CodeLine>
<Link id="l00562" /><CodeLine lineNumber="562"><Highlight kind="normal">                      : !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, <a href="/docs/api/namespaces/llvm/patternmatch/#acf8c16eed89e5ee1a10b6dfc08a33b3a">m&#95;LogicalAnd</a>())) &#123;</Highlight></CodeLine>
<Link id="l00563" /><CodeLine lineNumber="563"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;   Branch condition is in improper form for &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00564" /><CodeLine lineNumber="564"><Highlight kind="normal">                           </Highlight><Highlight kind="stringliteral">&quot;non-full unswitch!\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00565" /><CodeLine lineNumber="565"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00566" /><CodeLine lineNumber="566"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00567" /><CodeLine lineNumber="567"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00568" /><CodeLine lineNumber="568"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00569" /><CodeLine lineNumber="569"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(&#123;</Highlight></CodeLine>
<Link id="l00570" /><CodeLine lineNumber="570"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;    unswitching trivial invariant conditions for: &quot;</Highlight><Highlight kind="normal"> &lt;&lt; BI</Highlight></CodeLine>
<Link id="l00571" /><CodeLine lineNumber="571"><Highlight kind="normal">           &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00572" /><CodeLine lineNumber="572"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/value">Value</a> &#42;Invariant : Invariants) &#123;</Highlight></CodeLine>
<Link id="l00573" /><CodeLine lineNumber="573"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;      &quot;</Highlight><Highlight kind="normal"> &lt;&lt; &#42;Invariant &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; == true&quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00574" /><CodeLine lineNumber="574"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Invariant != Invariants.back())</Highlight></CodeLine>
<Link id="l00575" /><CodeLine lineNumber="575"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; ||&quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00576" /><CodeLine lineNumber="576"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00577" /><CodeLine lineNumber="577"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00578" /><CodeLine lineNumber="578"><Highlight kind="normal">  &#125;);</Highlight></CodeLine>
<Link id="l00579" /><CodeLine lineNumber="579"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00580" /><CodeLine lineNumber="580"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If we have scalar evolutions, we need to invalidate them including this</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00581" /><CodeLine lineNumber="581"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// loop, the loop containing the exit block and the topmost parent loop</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00582" /><CodeLine lineNumber="582"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// exiting via LoopExitBB.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00583" /><CodeLine lineNumber="583"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SE) &#123;</Highlight></CodeLine>
<Link id="l00584" /><CodeLine lineNumber="584"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ExitL = <a href="#a5e771bd40bbd3121ec36a96aa44ef46a">getTopMostExitingLoop</a>(LoopExitBB, LI))</Highlight></CodeLine>
<Link id="l00585" /><CodeLine lineNumber="585"><Highlight kind="normal">      SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a592bdd7731b14ff4ff5d646f6f399900">forgetLoop</a>(ExitL);</Highlight></CodeLine>
<Link id="l00586" /><CodeLine lineNumber="586"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00587" /><CodeLine lineNumber="587"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Forget the entire nest as this exits the entire nest.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00588" /><CodeLine lineNumber="588"><Highlight kind="normal">      SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a7d5bfa1ac3c7c096af6b26fb95cd699d">forgetTopmostLoop</a>(&amp;L);</Highlight></CodeLine>
<Link id="l00589" /><CodeLine lineNumber="589"><Highlight kind="normal">    SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a830ba09d5969cd66878b05c17fdf66b6">forgetBlockAndLoopDispositions</a>();</Highlight></CodeLine>
<Link id="l00590" /><CodeLine lineNumber="590"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00591" /><CodeLine lineNumber="591"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00592" /><CodeLine lineNumber="592"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU &amp;&amp; <a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l00593" /><CodeLine lineNumber="593"><Highlight kind="normal">    MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a01a350909e784d6fa43181a72de61529">getMemorySSA</a>()-&gt;<a href="/docs/api/classes/llvm/memoryssa/#a88b10d37f671e58cf138ac84a8257c17">verifyMemorySSA</a>();</Highlight></CodeLine>
<Link id="l00594" /><CodeLine lineNumber="594"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00595" /><CodeLine lineNumber="595"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Split the preheader, so that we know that there is a safe place to insert</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00596" /><CodeLine lineNumber="596"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the conditional branch. We will change the preheader to have a conditional</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00597" /><CodeLine lineNumber="597"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// branch on LoopCond.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00598" /><CodeLine lineNumber="598"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;OldPH = L.getLoopPreheader();</Highlight></CodeLine>
<Link id="l00599" /><CodeLine lineNumber="599"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewPH = <a href="/docs/api/namespaces/llvm/#adf83581f514774264d616eef5706cf6e">SplitEdge</a>(OldPH, L.getHeader(), &amp;DT, &amp;LI, MSSAU);</Highlight></CodeLine>
<Link id="l00600" /><CodeLine lineNumber="600"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00601" /><CodeLine lineNumber="601"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now that we have a place to insert the conditional branch, create a place</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00602" /><CodeLine lineNumber="602"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// to branch to: this is the exit block out of the loop that we are</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00603" /><CodeLine lineNumber="603"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// unswitching. We need to split this if there are other loop predecessors.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00604" /><CodeLine lineNumber="604"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Because the loop is in simplified form, &#42;any&#42; other predecessor is enough.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00605" /><CodeLine lineNumber="605"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;UnswitchedBB;</Highlight></CodeLine>
<Link id="l00606" /><CodeLine lineNumber="606"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (FullUnswitch &amp;&amp; LoopExitBB-&gt;getUniquePredecessor()) &#123;</Highlight></CodeLine>
<Link id="l00607" /><CodeLine lineNumber="607"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(LoopExitBB-&gt;getUniquePredecessor() == BI.<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>() &amp;&amp;</Highlight></CodeLine>
<Link id="l00608" /><CodeLine lineNumber="608"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;A branch&#39;s parent isn&#39;t a predecessor!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00609" /><CodeLine lineNumber="609"><Highlight kind="normal">    UnswitchedBB = LoopExitBB;</Highlight></CodeLine>
<Link id="l00610" /><CodeLine lineNumber="610"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00611" /><CodeLine lineNumber="611"><Highlight kind="normal">    UnswitchedBB =</Highlight></CodeLine>
<Link id="l00612" /><CodeLine lineNumber="612"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#ac6c9ffe7979754415f4ca0d677174bc2">SplitBlock</a>(LoopExitBB, LoopExitBB-&gt;begin(), &amp;DT, &amp;LI, MSSAU, </Highlight><Highlight kind="stringliteral">&quot;&quot;</Highlight><Highlight kind="normal">, </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00613" /><CodeLine lineNumber="613"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00614" /><CodeLine lineNumber="614"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00615" /><CodeLine lineNumber="615"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU &amp;&amp; <a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l00616" /><CodeLine lineNumber="616"><Highlight kind="normal">    MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a01a350909e784d6fa43181a72de61529">getMemorySSA</a>()-&gt;<a href="/docs/api/classes/llvm/memoryssa/#a88b10d37f671e58cf138ac84a8257c17">verifyMemorySSA</a>();</Highlight></CodeLine>
<Link id="l00617" /><CodeLine lineNumber="617"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00618" /><CodeLine lineNumber="618"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Actually move the invariant uses into the unswitched position. If possible,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00619" /><CodeLine lineNumber="619"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// we do this by moving the instructions, but when doing partial unswitching</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00620" /><CodeLine lineNumber="620"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// we do it by building a new merge of the values in the unswitched position.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00621" /><CodeLine lineNumber="621"><Highlight kind="normal">  OldPH-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>()-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</Highlight></CodeLine>
<Link id="l00622" /><CodeLine lineNumber="622"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (FullUnswitch) &#123;</Highlight></CodeLine>
<Link id="l00623" /><CodeLine lineNumber="623"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If fully unswitching, we can use the existing branch instruction.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00624" /><CodeLine lineNumber="624"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Splice it into the old PH to gate reaching the new preheader and re-point</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00625" /><CodeLine lineNumber="625"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// its successors.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00626" /><CodeLine lineNumber="626"><Highlight kind="normal">    BI.<a href="/docs/api/classes/llvm/instruction/#af67d1f3a518964d80a109bb3d9d5cf1e">moveBefore</a>(&#42;OldPH, OldPH-&gt;<a href="/docs/api/classes/llvm/basicblock/#a0b4e7bee9b8575cc7db73329f1a561bd">end</a>());</Highlight></CodeLine>
<Link id="l00627" /><CodeLine lineNumber="627"><Highlight kind="normal">    BI.<a href="/docs/api/classes/llvm/branchinst/#a3505dab06f59c36142a234321cdc3411">setCondition</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>);</Highlight></CodeLine>
<Link id="l00628" /><CodeLine lineNumber="628"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU) &#123;</Highlight></CodeLine>
<Link id="l00629" /><CodeLine lineNumber="629"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Temporarily clone the terminator, to make MSSA update cheaper by</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00630" /><CodeLine lineNumber="630"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// separating &quot;insert edge&quot; updates from &quot;remove edge&quot; ones.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00631" /><CodeLine lineNumber="631"><Highlight kind="normal">      BI.<a href="/docs/api/classes/llvm/instruction/#a0a4d51e372293abe5e5f6dac133e80a6">clone</a>()-&gt;<a href="/docs/api/classes/llvm/instruction/#afcd9d2ea284c4d90541291ff9c47d332">insertInto</a>(ParentBB, ParentBB-&gt;end());</Highlight></CodeLine>
<Link id="l00632" /><CodeLine lineNumber="632"><Highlight kind="normal">    &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00633" /><CodeLine lineNumber="633"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Create a new unconditional branch that will continue the loop as a new</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00634" /><CodeLine lineNumber="634"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// terminator.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00635" /><CodeLine lineNumber="635"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;NewBI = <a href="/docs/api/classes/llvm/branchinst/#a9f40e42226cee617c16cb1c447b115c5">BranchInst::Create</a>(ContinueBB, ParentBB);</Highlight></CodeLine>
<Link id="l00636" /><CodeLine lineNumber="636"><Highlight kind="normal">      NewBI-&gt;<a href="/docs/api/classes/llvm/instruction/#ae8f5bf5cc06f696b52c709677df00fbf">setDebugLoc</a>(BI.<a href="/docs/api/classes/llvm/instruction/#a4b8faae4ff9e7434a1d226d03d15dcd2">getDebugLoc</a>());</Highlight></CodeLine>
<Link id="l00637" /><CodeLine lineNumber="637"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00638" /><CodeLine lineNumber="638"><Highlight kind="normal">    BI.<a href="/docs/api/classes/llvm/branchinst/#adc5e7f9c460c68455e826783d77f9a99">setSuccessor</a>(LoopExitSuccIdx, UnswitchedBB);</Highlight></CodeLine>
<Link id="l00639" /><CodeLine lineNumber="639"><Highlight kind="normal">    BI.<a href="/docs/api/classes/llvm/branchinst/#adc5e7f9c460c68455e826783d77f9a99">setSuccessor</a>(1 - LoopExitSuccIdx, NewPH);</Highlight></CodeLine>
<Link id="l00640" /><CodeLine lineNumber="640"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00641" /><CodeLine lineNumber="641"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Only unswitching a subset of inputs to the condition, so we will need to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00642" /><CodeLine lineNumber="642"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// build a new branch that merges the invariant inputs.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00643" /><CodeLine lineNumber="643"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (ExitDirection)</Highlight></CodeLine>
<Link id="l00644" /><CodeLine lineNumber="644"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(<a href="#a5ca2e820d1b5a49dcaad5e6873917198">skipTrivialSelect</a>(BI.<a href="/docs/api/classes/llvm/branchinst/#aebd4af5642453ce3169094f08dd3d7b8">getCondition</a>()), <a href="/docs/api/namespaces/llvm/patternmatch/#ad4d070a596ae37b8e01f15e4f759fc07">m&#95;LogicalOr</a>()) &amp;&amp;</Highlight></CodeLine>
<Link id="l00645" /><CodeLine lineNumber="645"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;Must have an &#96;or&#96; of &#96;i1&#96;s or &#96;select i1 X, true, Y&#96;s for the &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00646" /><CodeLine lineNumber="646"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;condition!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00647" /><CodeLine lineNumber="647"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00648" /><CodeLine lineNumber="648"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(<a href="#a5ca2e820d1b5a49dcaad5e6873917198">skipTrivialSelect</a>(BI.<a href="/docs/api/classes/llvm/branchinst/#aebd4af5642453ce3169094f08dd3d7b8">getCondition</a>()), <a href="/docs/api/namespaces/llvm/patternmatch/#a2276d81e0e6e31d0a69c4352a066ef73">m&#95;LogicalAnd</a>()) &amp;&amp;</Highlight></CodeLine>
<Link id="l00649" /><CodeLine lineNumber="649"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;Must have an &#96;and&#96; of &#96;i1&#96;s or &#96;select i1 X, Y, false&#96;s for the&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00650" /><CodeLine lineNumber="650"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot; condition!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00651" /><CodeLine lineNumber="651"><Highlight kind="normal">    <a href="#a45b06cc0aa3a6fcbace0aacf3b25a9e6">buildPartialUnswitchConditionalBranch</a>(</Highlight></CodeLine>
<Link id="l00652" /><CodeLine lineNumber="652"><Highlight kind="normal">        &#42;OldPH, Invariants, ExitDirection, &#42;UnswitchedBB, &#42;NewPH,</Highlight></CodeLine>
<Link id="l00653" /><CodeLine lineNumber="653"><Highlight kind="normal">        <a href="#a777551c6c08e4e3588b36665a8572414">FreezeLoopUnswitchCond</a>, OldPH-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>(), </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">, DT);</Highlight></CodeLine>
<Link id="l00654" /><CodeLine lineNumber="654"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00655" /><CodeLine lineNumber="655"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00656" /><CodeLine lineNumber="656"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Update the dominator tree with the added edge.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00657" /><CodeLine lineNumber="657"><Highlight kind="normal">  DT.<a href="/docs/api/classes/llvm/dominatortreebase/#a51145a3ae24ea73b3692a17088edea7b">insertEdge</a>(OldPH, UnswitchedBB);</Highlight></CodeLine>
<Link id="l00658" /><CodeLine lineNumber="658"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00659" /><CodeLine lineNumber="659"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// After the dominator tree was updated with the added edge, update MemorySSA</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00660" /><CodeLine lineNumber="660"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// if available.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00661" /><CodeLine lineNumber="661"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU) &#123;</Highlight></CodeLine>
<Link id="l00662" /><CodeLine lineNumber="662"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;CFGUpdate, 1&gt;</a> Updates;</Highlight></CodeLine>
<Link id="l00663" /><CodeLine lineNumber="663"><Highlight kind="normal">    Updates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;<a href="/docs/api/namespaces/llvm/cfg/#a90f12723ad8d5cff45b6f06408a33da8aa458be0f08b7e4ff3c0f633c100176c0">cfg::UpdateKind::Insert</a>, OldPH, UnswitchedBB&#125;);</Highlight></CodeLine>
<Link id="l00664" /><CodeLine lineNumber="664"><Highlight kind="normal">    MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#ac0404328e9e4f5d3c565daabf46fffac">applyInsertUpdates</a>(Updates, DT);</Highlight></CodeLine>
<Link id="l00665" /><CodeLine lineNumber="665"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00666" /><CodeLine lineNumber="666"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00667" /><CodeLine lineNumber="667"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Finish updating dominator tree and memory ssa for full unswitch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00668" /><CodeLine lineNumber="668"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (FullUnswitch) &#123;</Highlight></CodeLine>
<Link id="l00669" /><CodeLine lineNumber="669"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU) &#123;</Highlight></CodeLine>
<Link id="l00670" /><CodeLine lineNumber="670"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Term = ParentBB-&gt;getTerminator();</Highlight></CodeLine>
<Link id="l00671" /><CodeLine lineNumber="671"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Remove the cloned branch instruction and create unconditional branch</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00672" /><CodeLine lineNumber="672"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// now.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00673" /><CodeLine lineNumber="673"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;NewBI = <a href="/docs/api/classes/llvm/branchinst/#a9f40e42226cee617c16cb1c447b115c5">BranchInst::Create</a>(ContinueBB, ParentBB);</Highlight></CodeLine>
<Link id="l00674" /><CodeLine lineNumber="674"><Highlight kind="normal">      NewBI-&gt;<a href="/docs/api/classes/llvm/instruction/#ae8f5bf5cc06f696b52c709677df00fbf">setDebugLoc</a>(Term-&gt;getDebugLoc());</Highlight></CodeLine>
<Link id="l00675" /><CodeLine lineNumber="675"><Highlight kind="normal">      Term-&gt;eraseFromParent();</Highlight></CodeLine>
<Link id="l00676" /><CodeLine lineNumber="676"><Highlight kind="normal">      MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a4953231268ee21e95c3740e51ab37a96">removeEdge</a>(ParentBB, LoopExitBB);</Highlight></CodeLine>
<Link id="l00677" /><CodeLine lineNumber="677"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00678" /><CodeLine lineNumber="678"><Highlight kind="normal">    DT.<a href="/docs/api/classes/llvm/dominatortreebase/#ab0f09aefdf088f84a0bff7cba86454b4">deleteEdge</a>(ParentBB, LoopExitBB);</Highlight></CodeLine>
<Link id="l00679" /><CodeLine lineNumber="679"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00680" /><CodeLine lineNumber="680"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00681" /><CodeLine lineNumber="681"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU &amp;&amp; <a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l00682" /><CodeLine lineNumber="682"><Highlight kind="normal">    MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a01a350909e784d6fa43181a72de61529">getMemorySSA</a>()-&gt;<a href="/docs/api/classes/llvm/memoryssa/#a88b10d37f671e58cf138ac84a8257c17">verifyMemorySSA</a>();</Highlight></CodeLine>
<Link id="l00683" /><CodeLine lineNumber="683"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00684" /><CodeLine lineNumber="684"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Rewrite the relevant PHI nodes.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00685" /><CodeLine lineNumber="685"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UnswitchedBB == LoopExitBB)</Highlight></CodeLine>
<Link id="l00686" /><CodeLine lineNumber="686"><Highlight kind="normal">    <a href="#a003a854484a7b23c151bc0b3d684e5d9">rewritePHINodesForUnswitchedExitBlock</a>(&#42;UnswitchedBB, &#42;ParentBB, &#42;OldPH);</Highlight></CodeLine>
<Link id="l00687" /><CodeLine lineNumber="687"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00688" /><CodeLine lineNumber="688"><Highlight kind="normal">    <a href="#a9a1db01205f9a51a14b99e53e3068da1">rewritePHINodesForExitAndUnswitchedBlocks</a>(&#42;LoopExitBB, &#42;UnswitchedBB,</Highlight></CodeLine>
<Link id="l00689" /><CodeLine lineNumber="689"><Highlight kind="normal">                                              &#42;ParentBB, &#42;OldPH, FullUnswitch);</Highlight></CodeLine>
<Link id="l00690" /><CodeLine lineNumber="690"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00691" /><CodeLine lineNumber="691"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The constant we can replace all of our invariants with inside the loop</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00692" /><CodeLine lineNumber="692"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// body. If any of the invariants have a value other than this the loop won&#39;t</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00693" /><CodeLine lineNumber="693"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// be entered.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00694" /><CodeLine lineNumber="694"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;Replacement = ExitDirection</Highlight></CodeLine>
<Link id="l00695" /><CodeLine lineNumber="695"><Highlight kind="normal">                                 ? <a href="/docs/api/classes/llvm/constantint/#aa7cce62ac5cc6df09cce0535874336b7">ConstantInt::getFalse</a>(BI.<a href="/docs/api/classes/llvm/value/#ab3fc0225d8aaf8434026c3573f961f2c">getContext</a>())</Highlight></CodeLine>
<Link id="l00696" /><CodeLine lineNumber="696"><Highlight kind="normal">                                 : <a href="/docs/api/classes/llvm/constantint/#a82dbbd8e3688b0bc1eedb338864d0d0c">ConstantInt::getTrue</a>(BI.<a href="/docs/api/classes/llvm/value/#ab3fc0225d8aaf8434026c3573f961f2c">getContext</a>());</Highlight></CodeLine>
<Link id="l00697" /><CodeLine lineNumber="697"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00698" /><CodeLine lineNumber="698"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Since this is an i1 condition we can also trivially replace uses of it</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00699" /><CodeLine lineNumber="699"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// within the loop with a constant.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00700" /><CodeLine lineNumber="700"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/value">Value</a> &#42;Invariant : Invariants)</Highlight></CodeLine>
<Link id="l00701" /><CodeLine lineNumber="701"><Highlight kind="normal">    <a href="#a669b909f685098d484bb789192620885">replaceLoopInvariantUses</a>(L, Invariant, &#42;Replacement);</Highlight></CodeLine>
<Link id="l00702" /><CodeLine lineNumber="702"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00703" /><CodeLine lineNumber="703"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If this was full unswitching, we may have changed the nesting relationship</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00704" /><CodeLine lineNumber="704"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// for this loop so hoist it to its correct parent if needed.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00705" /><CodeLine lineNumber="705"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (FullUnswitch)</Highlight></CodeLine>
<Link id="l00706" /><CodeLine lineNumber="706"><Highlight kind="normal">    <a href="#afa8d35023dc30883011a5641eac69d38">hoistLoopToNewParent</a>(L, &#42;NewPH, DT, LI, MSSAU, SE);</Highlight></CodeLine>
<Link id="l00707" /><CodeLine lineNumber="707"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00708" /><CodeLine lineNumber="708"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU &amp;&amp; <a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l00709" /><CodeLine lineNumber="709"><Highlight kind="normal">    MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a01a350909e784d6fa43181a72de61529">getMemorySSA</a>()-&gt;<a href="/docs/api/classes/llvm/memoryssa/#a88b10d37f671e58cf138ac84a8257c17">verifyMemorySSA</a>();</Highlight></CodeLine>
<Link id="l00710" /><CodeLine lineNumber="710"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00711" /><CodeLine lineNumber="711"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;    done: unswitching trivial branch...\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00712" /><CodeLine lineNumber="712"><Highlight kind="normal">  ++NumTrivial;</Highlight></CodeLine>
<Link id="l00713" /><CodeLine lineNumber="713"><Highlight kind="normal">  ++NumBranches;</Highlight></CodeLine>
<Link id="l00714" /><CodeLine lineNumber="714"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00715" /><CodeLine lineNumber="715"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00716" /><CodeLine lineNumber="716"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00717" /><CodeLine lineNumber="717"><Highlight kind="comment">/// Unswitch a trivial switch if the condition is loop invariant.</Highlight></CodeLine>
<Link id="l00718" /><CodeLine lineNumber="718"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00719" /><CodeLine lineNumber="719"><Highlight kind="comment">/// This routine should only be called when loop code leading to the switch has</Highlight></CodeLine>
<Link id="l00720" /><CodeLine lineNumber="720"><Highlight kind="comment">/// been validated as trivial (no side effects). This routine checks if the</Highlight></CodeLine>
<Link id="l00721" /><CodeLine lineNumber="721"><Highlight kind="comment">/// condition is invariant and that at least one of the successors is a loop</Highlight></CodeLine>
<Link id="l00722" /><CodeLine lineNumber="722"><Highlight kind="comment">/// exit. This allows us to unswitch without duplicating the loop, making it</Highlight></CodeLine>
<Link id="l00723" /><CodeLine lineNumber="723"><Highlight kind="comment">/// trivial.</Highlight></CodeLine>
<Link id="l00724" /><CodeLine lineNumber="724"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00725" /><CodeLine lineNumber="725"><Highlight kind="comment">/// If this routine fails to unswitch the switch it returns false.</Highlight></CodeLine>
<Link id="l00726" /><CodeLine lineNumber="726"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00727" /><CodeLine lineNumber="727"><Highlight kind="comment">/// If the switch can be unswitched, this routine splits the preheader and</Highlight></CodeLine>
<Link id="l00728" /><CodeLine lineNumber="728"><Highlight kind="comment">/// copies the switch above that split. If the default case is one of the</Highlight></CodeLine>
<Link id="l00729" /><CodeLine lineNumber="729"><Highlight kind="comment">/// exiting cases, it copies the non-exiting cases and points them at the new</Highlight></CodeLine>
<Link id="l00730" /><CodeLine lineNumber="730"><Highlight kind="comment">/// preheader. If the default case is not exiting, it copies the exiting cases</Highlight></CodeLine>
<Link id="l00731" /><CodeLine lineNumber="731"><Highlight kind="comment">/// and points the default at the preheader. It preserves loop simplified form</Highlight></CodeLine>
<Link id="l00732" /><CodeLine lineNumber="732"><Highlight kind="comment">/// (splitting the exit blocks as necessary). It simplifies the switch within</Highlight></CodeLine>
<Link id="l00733" /><CodeLine lineNumber="733"><Highlight kind="comment">/// the loop by removing now-dead cases. If the default case is one of those</Highlight></CodeLine>
<Link id="l00734" /><CodeLine lineNumber="734"><Highlight kind="comment">/// unswitched, it replaces its destination with a new basic block containing</Highlight></CodeLine>
<Link id="l00735" /><CodeLine lineNumber="735"><Highlight kind="comment">/// only unreachable. Such basic blocks, while technically loop exits, are not</Highlight></CodeLine>
<Link id="l00736" /><CodeLine lineNumber="736"><Highlight kind="comment">/// considered for unswitching so this is a stable transform and the same</Highlight></CodeLine>
<Link id="l00737" /><CodeLine lineNumber="737"><Highlight kind="comment">/// switch will not be revisited. If after unswitching there is only a single</Highlight></CodeLine>
<Link id="l00738" /><CodeLine lineNumber="738"><Highlight kind="comment">/// in-loop successor, the switch is further simplified to an unconditional</Highlight></CodeLine>
<Link id="l00739" /><CodeLine lineNumber="739"><Highlight kind="comment">/// branch. Still more cleanup can be done with some simplifycfg like pass.</Highlight></CodeLine>
<Link id="l00740" /><CodeLine lineNumber="740"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00741" /><CodeLine lineNumber="741"><Highlight kind="comment">/// If &#96;SE&#96; is not null, it will be updated based on the potential loop SCEVs</Highlight></CodeLine>
<Link id="l00742" /><CodeLine lineNumber="742"><Highlight kind="comment">/// invalidated by this.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00743" /><CodeLine lineNumber="743" lineLink="#aadf6036e1d19c8ba91242af6ec48d40b"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#aadf6036e1d19c8ba91242af6ec48d40b">unswitchTrivialSwitch</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, <a href="/docs/api/classes/llvm/switchinst">SwitchInst</a> &amp;<a href="/docs/api/namespaces/llvm/si">SI</a>, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT,</Highlight></CodeLine>
<Link id="l00744" /><CodeLine lineNumber="744"><Highlight kind="normal">                                  <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42;SE,</Highlight></CodeLine>
<Link id="l00745" /><CodeLine lineNumber="745"><Highlight kind="normal">                                  <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42;MSSAU) &#123;</Highlight></CodeLine>
<Link id="l00746" /><CodeLine lineNumber="746"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Trying to unswitch switch: &quot;</Highlight><Highlight kind="normal"> &lt;&lt; <a href="/docs/api/namespaces/llvm/si">SI</a> &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00747" /><CodeLine lineNumber="747"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;LoopCond = <a href="/docs/api/namespaces/llvm/si">SI</a>.getCondition();</Highlight></CodeLine>
<Link id="l00748" /><CodeLine lineNumber="748"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00749" /><CodeLine lineNumber="749"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If this isn&#39;t switching on an invariant condition, we can&#39;t unswitch it.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00750" /><CodeLine lineNumber="750"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!L.isLoopInvariant(LoopCond))</Highlight></CodeLine>
<Link id="l00751" /><CodeLine lineNumber="751"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00752" /><CodeLine lineNumber="752"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00753" /><CodeLine lineNumber="753"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ParentBB = <a href="/docs/api/namespaces/llvm/si">SI</a>.getParent();</Highlight></CodeLine>
<Link id="l00754" /><CodeLine lineNumber="754"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00755" /><CodeLine lineNumber="755"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The same check must be used both for the default and the exit cases. We</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00756" /><CodeLine lineNumber="756"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// should never leave edges from the switch instruction to a basic block that</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00757" /><CodeLine lineNumber="757"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// we are unswitching, hence the condition used to determine the default case</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00758" /><CodeLine lineNumber="758"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// needs to also be used to populate ExitCaseIndices, which is then used to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00759" /><CodeLine lineNumber="759"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// remove cases from the switch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00760" /><CodeLine lineNumber="760"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> IsTriviallyUnswitchableExitBlock = &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;BBToCheck) &#123;</Highlight></CodeLine>
<Link id="l00761" /><CodeLine lineNumber="761"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// BBToCheck is not an exit block if it is inside loop L.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00762" /><CodeLine lineNumber="762"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L.contains(&amp;BBToCheck))</Highlight></CodeLine>
<Link id="l00763" /><CodeLine lineNumber="763"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00764" /><CodeLine lineNumber="764"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// BBToCheck is not trivial to unswitch if its phis aren&#39;t loop invariant.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00765" /><CodeLine lineNumber="765"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="#a98ebfee3c290028ee7875184aac567ce">areLoopExitPHIsLoopInvariant</a>(L, &#42;ParentBB, BBToCheck))</Highlight></CodeLine>
<Link id="l00766" /><CodeLine lineNumber="766"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00767" /><CodeLine lineNumber="767"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We do not unswitch a block that only has an unreachable statement, as</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00768" /><CodeLine lineNumber="768"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// it&#39;s possible this is a previously unswitched block. Only unswitch if</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00769" /><CodeLine lineNumber="769"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// either the terminator is not unreachable, or, if it is, it&#39;s not the only</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00770" /><CodeLine lineNumber="770"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// instruction in the block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00771" /><CodeLine lineNumber="771"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;TI = BBToCheck.getTerminator();</Highlight></CodeLine>
<Link id="l00772" /><CodeLine lineNumber="772"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> isUnreachable = <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;UnreachableInst&gt;</a>(TI);</Highlight></CodeLine>
<Link id="l00773" /><CodeLine lineNumber="773"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> !isUnreachable || &amp;&#42;BBToCheck.getFirstNonPHIOrDbg() != TI;</Highlight></CodeLine>
<Link id="l00774" /><CodeLine lineNumber="774"><Highlight kind="normal">  &#125;;</Highlight></CodeLine>
<Link id="l00775" /><CodeLine lineNumber="775"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00776" /><CodeLine lineNumber="776"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;int, 4&gt;</a> ExitCaseIndices;</Highlight></CodeLine>
<Link id="l00777" /><CodeLine lineNumber="777"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> Case : <a href="/docs/api/namespaces/llvm/si">SI</a>.cases())</Highlight></CodeLine>
<Link id="l00778" /><CodeLine lineNumber="778"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (IsTriviallyUnswitchableExitBlock(&#42;Case.getCaseSuccessor()))</Highlight></CodeLine>
<Link id="l00779" /><CodeLine lineNumber="779"><Highlight kind="normal">      ExitCaseIndices.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(Case.getCaseIndex());</Highlight></CodeLine>
<Link id="l00780" /><CodeLine lineNumber="780"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;DefaultExitBB = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00781" /><CodeLine lineNumber="781"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/switchinstprofupdatewrapper/#acf60dfe9415b02d8da94b723e1ce87f8">SwitchInstProfUpdateWrapper::CaseWeightOpt</a> DefaultCaseWeight =</Highlight></CodeLine>
<Link id="l00782" /><CodeLine lineNumber="782"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/switchinstprofupdatewrapper/#aa78ac7cc796c2905e31c1ef6de35087d">SwitchInstProfUpdateWrapper::getSuccessorWeight</a>(<a href="/docs/api/namespaces/llvm/si">SI</a>, 0);</Highlight></CodeLine>
<Link id="l00783" /><CodeLine lineNumber="783"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (IsTriviallyUnswitchableExitBlock(&#42;<a href="/docs/api/namespaces/llvm/si">SI</a>.getDefaultDest())) &#123;</Highlight></CodeLine>
<Link id="l00784" /><CodeLine lineNumber="784"><Highlight kind="normal">    DefaultExitBB = <a href="/docs/api/namespaces/llvm/si">SI</a>.getDefaultDest();</Highlight></CodeLine>
<Link id="l00785" /><CodeLine lineNumber="785"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (ExitCaseIndices.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>())</Highlight></CodeLine>
<Link id="l00786" /><CodeLine lineNumber="786"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00787" /><CodeLine lineNumber="787"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00788" /><CodeLine lineNumber="788"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;    unswitching trivial switch...\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00789" /><CodeLine lineNumber="789"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00790" /><CodeLine lineNumber="790"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU &amp;&amp; <a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l00791" /><CodeLine lineNumber="791"><Highlight kind="normal">    MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a01a350909e784d6fa43181a72de61529">getMemorySSA</a>()-&gt;<a href="/docs/api/classes/llvm/memoryssa/#a88b10d37f671e58cf138ac84a8257c17">verifyMemorySSA</a>();</Highlight></CodeLine>
<Link id="l00792" /><CodeLine lineNumber="792"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00793" /><CodeLine lineNumber="793"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We may need to invalidate SCEVs for the outermost loop reached by any of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00794" /><CodeLine lineNumber="794"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the exits.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00795" /><CodeLine lineNumber="795"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;OuterL = &amp;L;</Highlight></CodeLine>
<Link id="l00796" /><CodeLine lineNumber="796"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00797" /><CodeLine lineNumber="797"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DefaultExitBB) &#123;</Highlight></CodeLine>
<Link id="l00798" /><CodeLine lineNumber="798"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Check the loop containing this exit.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00799" /><CodeLine lineNumber="799"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ExitL = <a href="#a5e771bd40bbd3121ec36a96aa44ef46a">getTopMostExitingLoop</a>(DefaultExitBB, LI);</Highlight></CodeLine>
<Link id="l00800" /><CodeLine lineNumber="800"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!ExitL || ExitL-&gt;<a href="/docs/api/classes/llvm/loopbase/#a04337b572d34ea413c35dbac5d75530b">contains</a>(OuterL))</Highlight></CodeLine>
<Link id="l00801" /><CodeLine lineNumber="801"><Highlight kind="normal">      OuterL = ExitL;</Highlight></CodeLine>
<Link id="l00802" /><CodeLine lineNumber="802"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00803" /><CodeLine lineNumber="803"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> Index : ExitCaseIndices) &#123;</Highlight></CodeLine>
<Link id="l00804" /><CodeLine lineNumber="804"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> CaseI = <a href="/docs/api/namespaces/llvm/si">SI</a>.case&#95;begin() + Index;</Highlight></CodeLine>
<Link id="l00805" /><CodeLine lineNumber="805"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Compute the outer loop from this exit.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00806" /><CodeLine lineNumber="806"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ExitL = <a href="#a5e771bd40bbd3121ec36a96aa44ef46a">getTopMostExitingLoop</a>(CaseI-&gt;getCaseSuccessor(), LI);</Highlight></CodeLine>
<Link id="l00807" /><CodeLine lineNumber="807"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!ExitL || ExitL-&gt;<a href="/docs/api/classes/llvm/loopbase/#a04337b572d34ea413c35dbac5d75530b">contains</a>(OuterL))</Highlight></CodeLine>
<Link id="l00808" /><CodeLine lineNumber="808"><Highlight kind="normal">      OuterL = ExitL;</Highlight></CodeLine>
<Link id="l00809" /><CodeLine lineNumber="809"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00810" /><CodeLine lineNumber="810"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00811" /><CodeLine lineNumber="811"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SE) &#123;</Highlight></CodeLine>
<Link id="l00812" /><CodeLine lineNumber="812"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (OuterL)</Highlight></CodeLine>
<Link id="l00813" /><CodeLine lineNumber="813"><Highlight kind="normal">      SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a592bdd7731b14ff4ff5d646f6f399900">forgetLoop</a>(OuterL);</Highlight></CodeLine>
<Link id="l00814" /><CodeLine lineNumber="814"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00815" /><CodeLine lineNumber="815"><Highlight kind="normal">      SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a7d5bfa1ac3c7c096af6b26fb95cd699d">forgetTopmostLoop</a>(&amp;L);</Highlight></CodeLine>
<Link id="l00816" /><CodeLine lineNumber="816"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00817" /><CodeLine lineNumber="817"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00818" /><CodeLine lineNumber="818"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DefaultExitBB) &#123;</Highlight></CodeLine>
<Link id="l00819" /><CodeLine lineNumber="819"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Clear out the default destination temporarily to allow accurate</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00820" /><CodeLine lineNumber="820"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// predecessor lists to be examined below.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00821" /><CodeLine lineNumber="821"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/si">SI</a>.setDefaultDest(</Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00822" /><CodeLine lineNumber="822"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00823" /><CodeLine lineNumber="823"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00824" /><CodeLine lineNumber="824"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Store the exit cases into a separate data structure and remove them from</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00825" /><CodeLine lineNumber="825"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the switch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00826" /><CodeLine lineNumber="826"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector</a>&lt;std::tuple&lt;<a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;,</Highlight></CodeLine>
<Link id="l00827" /><CodeLine lineNumber="827"><Highlight kind="normal">                         <a href="/docs/api/classes/llvm/switchinstprofupdatewrapper/#acf60dfe9415b02d8da94b723e1ce87f8">SwitchInstProfUpdateWrapper::CaseWeightOpt</a>&gt;,</Highlight></CodeLine>
<Link id="l00828" /><CodeLine lineNumber="828"><Highlight kind="normal">              4&gt; ExitCases;</Highlight></CodeLine>
<Link id="l00829" /><CodeLine lineNumber="829"><Highlight kind="normal">  ExitCases.reserve(ExitCaseIndices.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>());</Highlight></CodeLine>
<Link id="l00830" /><CodeLine lineNumber="830"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/switchinstprofupdatewrapper">SwitchInstProfUpdateWrapper</a> SIW(<a href="/docs/api/namespaces/llvm/si">SI</a>);</Highlight></CodeLine>
<Link id="l00831" /><CodeLine lineNumber="831"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We walk the case indices backwards so that we remove the last case first</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00832" /><CodeLine lineNumber="832"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// and don&#39;t disrupt the earlier indices.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00833" /><CodeLine lineNumber="833"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> Index : <a href="/docs/api/namespaces/llvm/#a6b0ac1fa4f05de76413c5e0ca6334035">reverse</a>(ExitCaseIndices)) &#123;</Highlight></CodeLine>
<Link id="l00834" /><CodeLine lineNumber="834"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> CaseI = <a href="/docs/api/namespaces/llvm/si">SI</a>.case&#95;begin() + Index;</Highlight></CodeLine>
<Link id="l00835" /><CodeLine lineNumber="835"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Save the value of this case.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00836" /><CodeLine lineNumber="836"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> W = SIW.<a href="/docs/api/classes/llvm/switchinstprofupdatewrapper/#aa78ac7cc796c2905e31c1ef6de35087d">getSuccessorWeight</a>(CaseI-&gt;getSuccessorIndex());</Highlight></CodeLine>
<Link id="l00837" /><CodeLine lineNumber="837"><Highlight kind="normal">    ExitCases.emplace&#95;back(CaseI-&gt;getCaseValue(), CaseI-&gt;getCaseSuccessor(), W);</Highlight></CodeLine>
<Link id="l00838" /><CodeLine lineNumber="838"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Delete the unswitched cases.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00839" /><CodeLine lineNumber="839"><Highlight kind="normal">    SIW.<a href="/docs/api/classes/llvm/switchinstprofupdatewrapper/#adf90515665080eadf537aff00bbf0594">removeCase</a>(CaseI);</Highlight></CodeLine>
<Link id="l00840" /><CodeLine lineNumber="840"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00841" /><CodeLine lineNumber="841"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00842" /><CodeLine lineNumber="842"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Check if after this all of the remaining cases point at the same</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00843" /><CodeLine lineNumber="843"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// successor.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00844" /><CodeLine lineNumber="844"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;CommonSuccBB = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00845" /><CodeLine lineNumber="845"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/si">SI</a>.getNumCases() &gt; 0 &amp;&amp;</Highlight></CodeLine>
<Link id="l00846" /><CodeLine lineNumber="846"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a0d10fe510ced2849a8074fe81e5d04ce">all&#95;of</a>(<a href="/docs/api/namespaces/llvm/#a02981de53fb6ffd384d39addc4d25f37">drop&#95;begin</a>(<a href="/docs/api/namespaces/llvm/si">SI</a>.cases()), &#91;&amp;<a href="/docs/api/namespaces/llvm/si">SI</a>&#93;(</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/switchinst/casehandle">SwitchInst::CaseHandle</a> &amp;Case) &#123;</Highlight></CodeLine>
<Link id="l00847" /><CodeLine lineNumber="847"><Highlight kind="normal">        return Case.getCaseSuccessor() == SI.case&#95;begin()-&gt;getCaseSuccessor();</Highlight></CodeLine>
<Link id="l00848" /><CodeLine lineNumber="848"><Highlight kind="normal">      &#125;))</Highlight></CodeLine>
<Link id="l00849" /><CodeLine lineNumber="849"><Highlight kind="normal">    CommonSuccBB = <a href="/docs/api/namespaces/llvm/si">SI</a>.case&#95;begin()-&gt;getCaseSuccessor();</Highlight></CodeLine>
<Link id="l00850" /><CodeLine lineNumber="850"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!DefaultExitBB) &#123;</Highlight></CodeLine>
<Link id="l00851" /><CodeLine lineNumber="851"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If we&#39;re not unswitching the default, we need it to match any cases to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00852" /><CodeLine lineNumber="852"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// have a common successor or if we have no cases it is the common</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00853" /><CodeLine lineNumber="853"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// successor.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00854" /><CodeLine lineNumber="854"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/si">SI</a>.getNumCases() == 0)</Highlight></CodeLine>
<Link id="l00855" /><CodeLine lineNumber="855"><Highlight kind="normal">      CommonSuccBB = <a href="/docs/api/namespaces/llvm/si">SI</a>.getDefaultDest();</Highlight></CodeLine>
<Link id="l00856" /><CodeLine lineNumber="856"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/si">SI</a>.getDefaultDest() != CommonSuccBB)</Highlight></CodeLine>
<Link id="l00857" /><CodeLine lineNumber="857"><Highlight kind="normal">      CommonSuccBB = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00858" /><CodeLine lineNumber="858"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00859" /><CodeLine lineNumber="859"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00860" /><CodeLine lineNumber="860"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Split the preheader, so that we know that there is a safe place to insert</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00861" /><CodeLine lineNumber="861"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the switch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00862" /><CodeLine lineNumber="862"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;OldPH = L.getLoopPreheader();</Highlight></CodeLine>
<Link id="l00863" /><CodeLine lineNumber="863"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewPH = <a href="/docs/api/namespaces/llvm/#adf83581f514774264d616eef5706cf6e">SplitEdge</a>(OldPH, L.getHeader(), &amp;DT, &amp;LI, MSSAU);</Highlight></CodeLine>
<Link id="l00864" /><CodeLine lineNumber="864"><Highlight kind="normal">  OldPH-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>()-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</Highlight></CodeLine>
<Link id="l00865" /><CodeLine lineNumber="865"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00866" /><CodeLine lineNumber="866"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now add the unswitched switch. This new switch instruction inherits the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00867" /><CodeLine lineNumber="867"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// debug location of the old switch, because it semantically replace the old</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00868" /><CodeLine lineNumber="868"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// one.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00869" /><CodeLine lineNumber="869"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;NewSI = <a href="/docs/api/classes/llvm/switchinst/#a3c1416226bed5e92acb74aebe8e20f5a">SwitchInst::Create</a>(LoopCond, NewPH, ExitCases.<a href="/docs/api/classes/llvm/basicblock/#ab9f68be0e2bcdf14f503f45edea63023">size</a>(), OldPH);</Highlight></CodeLine>
<Link id="l00870" /><CodeLine lineNumber="870"><Highlight kind="normal">  NewSI-&gt;setDebugLoc(SIW-&gt;<a href="/docs/api/classes/llvm/instruction/#a4b8faae4ff9e7434a1d226d03d15dcd2">getDebugLoc</a>());</Highlight></CodeLine>
<Link id="l00871" /><CodeLine lineNumber="871"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/switchinstprofupdatewrapper">SwitchInstProfUpdateWrapper</a> NewSIW(&#42;NewSI);</Highlight></CodeLine>
<Link id="l00872" /><CodeLine lineNumber="872"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00873" /><CodeLine lineNumber="873"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Rewrite the IR for the unswitched basic blocks. This requires two steps.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00874" /><CodeLine lineNumber="874"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// First, we split any exit blocks with remaining in-loop predecessors. Then</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00875" /><CodeLine lineNumber="875"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// we update the PHIs in one of two ways depending on if there was a split.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00876" /><CodeLine lineNumber="876"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We walk in reverse so that we split in the same order as the cases</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00877" /><CodeLine lineNumber="877"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// appeared. This is purely for convenience of reading the resulting IR, but</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00878" /><CodeLine lineNumber="878"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// it doesn&#39;t cost anything really.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00879" /><CodeLine lineNumber="879"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;BasicBlock &#42;, 2&gt;</a> UnswitchedExitBBs;</Highlight></CodeLine>
<Link id="l00880" /><CodeLine lineNumber="880"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;BasicBlock &#42;, BasicBlock &#42;, 2&gt;</a> SplitExitBBMap;</Highlight></CodeLine>
<Link id="l00881" /><CodeLine lineNumber="881"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Handle the default exit if necessary.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00882" /><CodeLine lineNumber="882"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// FIXME: It&#39;d be great if we could merge this with the loop below but LLVM&#39;s</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00883" /><CodeLine lineNumber="883"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// ranges aren&#39;t quite powerful enough yet.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00884" /><CodeLine lineNumber="884"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DefaultExitBB) &#123;</Highlight></CodeLine>
<Link id="l00885" /><CodeLine lineNumber="885"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#ad66c4759666aab78529658362b498c74">pred&#95;empty</a>(DefaultExitBB)) &#123;</Highlight></CodeLine>
<Link id="l00886" /><CodeLine lineNumber="886"><Highlight kind="normal">      UnswitchedExitBBs.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(DefaultExitBB);</Highlight></CodeLine>
<Link id="l00887" /><CodeLine lineNumber="887"><Highlight kind="normal">      <a href="#a003a854484a7b23c151bc0b3d684e5d9">rewritePHINodesForUnswitchedExitBlock</a>(&#42;DefaultExitBB, &#42;ParentBB, &#42;OldPH);</Highlight></CodeLine>
<Link id="l00888" /><CodeLine lineNumber="888"><Highlight kind="normal">    &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00889" /><CodeLine lineNumber="889"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;SplitBB =</Highlight></CodeLine>
<Link id="l00890" /><CodeLine lineNumber="890"><Highlight kind="normal">          <a href="/docs/api/namespaces/llvm/#ac6c9ffe7979754415f4ca0d677174bc2">SplitBlock</a>(DefaultExitBB, DefaultExitBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a0ed5f3ab3c2e4196ee0cffffa080c062">begin</a>(), &amp;DT, &amp;LI, MSSAU);</Highlight></CodeLine>
<Link id="l00891" /><CodeLine lineNumber="891"><Highlight kind="normal">      <a href="#a9a1db01205f9a51a14b99e53e3068da1">rewritePHINodesForExitAndUnswitchedBlocks</a>(&#42;DefaultExitBB, &#42;SplitBB,</Highlight></CodeLine>
<Link id="l00892" /><CodeLine lineNumber="892"><Highlight kind="normal">                                                &#42;ParentBB, &#42;OldPH,</Highlight></CodeLine>
<Link id="l00893" /><CodeLine lineNumber="893"><Highlight kind="normal">                                                </Highlight><Highlight kind="comment">/&#42;FullUnswitch&#42;/</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00894" /><CodeLine lineNumber="894"><Highlight kind="normal">      DefaultExitBB = SplitExitBBMap&#91;DefaultExitBB&#93; = SplitBB;</Highlight></CodeLine>
<Link id="l00895" /><CodeLine lineNumber="895"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00896" /><CodeLine lineNumber="896"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00897" /><CodeLine lineNumber="897"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Note that we must use a reference in the for loop so that we update the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00898" /><CodeLine lineNumber="898"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// container.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00899" /><CodeLine lineNumber="899"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;ExitCase : <a href="/docs/api/namespaces/llvm/#a6b0ac1fa4f05de76413c5e0ca6334035">reverse</a>(ExitCases)) &#123;</Highlight></CodeLine>
<Link id="l00900" /><CodeLine lineNumber="900"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Grab a reference to the exit block in the pair so that we can update it.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00901" /><CodeLine lineNumber="901"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ExitBB = std::get&lt;1&gt;(ExitCase);</Highlight></CodeLine>
<Link id="l00902" /><CodeLine lineNumber="902"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00903" /><CodeLine lineNumber="903"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If this case is the last edge into the exit block, we can simply reuse it</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00904" /><CodeLine lineNumber="904"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// as it will no longer be a loop exit. No mapping necessary.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00905" /><CodeLine lineNumber="905"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#ad66c4759666aab78529658362b498c74">pred&#95;empty</a>(ExitBB)) &#123;</Highlight></CodeLine>
<Link id="l00906" /><CodeLine lineNumber="906"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Only rewrite once.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00907" /><CodeLine lineNumber="907"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UnswitchedExitBBs.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(ExitBB).second)</Highlight></CodeLine>
<Link id="l00908" /><CodeLine lineNumber="908"><Highlight kind="normal">        <a href="#a003a854484a7b23c151bc0b3d684e5d9">rewritePHINodesForUnswitchedExitBlock</a>(&#42;ExitBB, &#42;ParentBB, &#42;OldPH);</Highlight></CodeLine>
<Link id="l00909" /><CodeLine lineNumber="909"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00910" /><CodeLine lineNumber="910"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00911" /><CodeLine lineNumber="911"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00912" /><CodeLine lineNumber="912"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Otherwise we need to split the exit block so that we retain an exit</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00913" /><CodeLine lineNumber="913"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// block from the loop and a target for the unswitched condition.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00914" /><CodeLine lineNumber="914"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;&amp;SplitExitBB = SplitExitBBMap&#91;ExitBB&#93;;</Highlight></CodeLine>
<Link id="l00915" /><CodeLine lineNumber="915"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!SplitExitBB) &#123;</Highlight></CodeLine>
<Link id="l00916" /><CodeLine lineNumber="916"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// If this is the first time we see this, do the split and remember it.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00917" /><CodeLine lineNumber="917"><Highlight kind="normal">      SplitExitBB = <a href="/docs/api/namespaces/llvm/#ac6c9ffe7979754415f4ca0d677174bc2">SplitBlock</a>(ExitBB, ExitBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a0ed5f3ab3c2e4196ee0cffffa080c062">begin</a>(), &amp;DT, &amp;LI, MSSAU);</Highlight></CodeLine>
<Link id="l00918" /><CodeLine lineNumber="918"><Highlight kind="normal">      <a href="#a9a1db01205f9a51a14b99e53e3068da1">rewritePHINodesForExitAndUnswitchedBlocks</a>(&#42;ExitBB, &#42;SplitExitBB,</Highlight></CodeLine>
<Link id="l00919" /><CodeLine lineNumber="919"><Highlight kind="normal">                                                &#42;ParentBB, &#42;OldPH,</Highlight></CodeLine>
<Link id="l00920" /><CodeLine lineNumber="920"><Highlight kind="normal">                                                </Highlight><Highlight kind="comment">/&#42;FullUnswitch&#42;/</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00921" /><CodeLine lineNumber="921"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00922" /><CodeLine lineNumber="922"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Update the case pair to point to the split block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00923" /><CodeLine lineNumber="923"><Highlight kind="normal">    std::get&lt;1&gt;(ExitCase) = SplitExitBB;</Highlight></CodeLine>
<Link id="l00924" /><CodeLine lineNumber="924"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00925" /><CodeLine lineNumber="925"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00926" /><CodeLine lineNumber="926"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now add the unswitched cases. We do this in reverse order as we built them</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00927" /><CodeLine lineNumber="927"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// in reverse order.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00928" /><CodeLine lineNumber="928"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;ExitCase : <a href="/docs/api/namespaces/llvm/#a6b0ac1fa4f05de76413c5e0ca6334035">reverse</a>(ExitCases)) &#123;</Highlight></CodeLine>
<Link id="l00929" /><CodeLine lineNumber="929"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;CaseVal = std::get&lt;0&gt;(ExitCase);</Highlight></CodeLine>
<Link id="l00930" /><CodeLine lineNumber="930"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;UnswitchedBB = std::get&lt;1&gt;(ExitCase);</Highlight></CodeLine>
<Link id="l00931" /><CodeLine lineNumber="931"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00932" /><CodeLine lineNumber="932"><Highlight kind="normal">    NewSIW.<a href="/docs/api/classes/llvm/switchinstprofupdatewrapper/#a722eca444a919e1bc6af18b07941aad9">addCase</a>(CaseVal, UnswitchedBB, std::get&lt;2&gt;(ExitCase));</Highlight></CodeLine>
<Link id="l00933" /><CodeLine lineNumber="933"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00934" /><CodeLine lineNumber="934"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00935" /><CodeLine lineNumber="935"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If the default was unswitched, re-point it and add explicit cases for</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00936" /><CodeLine lineNumber="936"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// entering the loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00937" /><CodeLine lineNumber="937"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DefaultExitBB) &#123;</Highlight></CodeLine>
<Link id="l00938" /><CodeLine lineNumber="938"><Highlight kind="normal">    NewSIW-&gt;<a href="/docs/api/classes/llvm/switchinst/#aa22bdae1cee3c836f2b4cf8307fc7598">setDefaultDest</a>(DefaultExitBB);</Highlight></CodeLine>
<Link id="l00939" /><CodeLine lineNumber="939"><Highlight kind="normal">    NewSIW.<a href="/docs/api/classes/llvm/switchinstprofupdatewrapper/#a1a01b0843bc5ed009f7fdb2c8b8a41a5">setSuccessorWeight</a>(0, DefaultCaseWeight);</Highlight></CodeLine>
<Link id="l00940" /><CodeLine lineNumber="940"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00941" /><CodeLine lineNumber="941"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We removed all the exit cases, so we just copy the cases to the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00942" /><CodeLine lineNumber="942"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// unswitched switch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00943" /><CodeLine lineNumber="943"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;Case : <a href="/docs/api/namespaces/llvm/si">SI</a>.cases())</Highlight></CodeLine>
<Link id="l00944" /><CodeLine lineNumber="944"><Highlight kind="normal">      NewSIW.<a href="/docs/api/classes/llvm/switchinstprofupdatewrapper/#a722eca444a919e1bc6af18b07941aad9">addCase</a>(Case.<a href="/docs/api/classes/llvm/switchinst/casehandleimpl/#ad2b4cf1b26b0b142b243bcdcf300eafa">getCaseValue</a>(), NewPH,</Highlight></CodeLine>
<Link id="l00945" /><CodeLine lineNumber="945"><Highlight kind="normal">                     SIW.<a href="/docs/api/classes/llvm/switchinstprofupdatewrapper/#aa78ac7cc796c2905e31c1ef6de35087d">getSuccessorWeight</a>(Case.<a href="/docs/api/classes/llvm/switchinst/casehandleimpl/#a80c8a3151e9ef04b1595e222bdfe1cf9">getSuccessorIndex</a>()));</Highlight></CodeLine>
<Link id="l00946" /><CodeLine lineNumber="946"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DefaultCaseWeight) &#123;</Highlight></CodeLine>
<Link id="l00947" /><CodeLine lineNumber="947"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We have to set branch weight of the default case.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00948" /><CodeLine lineNumber="948"><Highlight kind="normal">    uint64&#95;t SW = &#42;DefaultCaseWeight;</Highlight></CodeLine>
<Link id="l00949" /><CodeLine lineNumber="949"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;Case : <a href="/docs/api/namespaces/llvm/si">SI</a>.cases()) &#123;</Highlight></CodeLine>
<Link id="l00950" /><CodeLine lineNumber="950"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> W = SIW.<a href="/docs/api/classes/llvm/switchinstprofupdatewrapper/#aa78ac7cc796c2905e31c1ef6de35087d">getSuccessorWeight</a>(Case.<a href="/docs/api/classes/llvm/switchinst/casehandleimpl/#a80c8a3151e9ef04b1595e222bdfe1cf9">getSuccessorIndex</a>());</Highlight></CodeLine>
<Link id="l00951" /><CodeLine lineNumber="951"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(W &amp;&amp;</Highlight></CodeLine>
<Link id="l00952" /><CodeLine lineNumber="952"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;case weight must be defined as default case weight is defined&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00953" /><CodeLine lineNumber="953"><Highlight kind="normal">      SW += &#42;W;</Highlight></CodeLine>
<Link id="l00954" /><CodeLine lineNumber="954"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00955" /><CodeLine lineNumber="955"><Highlight kind="normal">    NewSIW.<a href="/docs/api/classes/llvm/switchinstprofupdatewrapper/#a1a01b0843bc5ed009f7fdb2c8b8a41a5">setSuccessorWeight</a>(0, SW);</Highlight></CodeLine>
<Link id="l00956" /><CodeLine lineNumber="956"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00957" /><CodeLine lineNumber="957"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00958" /><CodeLine lineNumber="958"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If we ended up with a common successor for every path through the switch</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00959" /><CodeLine lineNumber="959"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// after unswitching, rewrite it to an unconditional branch to make it easy</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00960" /><CodeLine lineNumber="960"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// to recognize. Otherwise we potentially have to recognize the default case</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00961" /><CodeLine lineNumber="961"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// pointing at unreachable and other complexity.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00962" /><CodeLine lineNumber="962"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (CommonSuccBB) &#123;</Highlight></CodeLine>
<Link id="l00963" /><CodeLine lineNumber="963"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB = <a href="/docs/api/namespaces/llvm/si">SI</a>.getParent();</Highlight></CodeLine>
<Link id="l00964" /><CodeLine lineNumber="964"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We may have had multiple edges to this common successor block, so remove</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00965" /><CodeLine lineNumber="965"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// them as predecessors. We skip the first one, either the default or the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00966" /><CodeLine lineNumber="966"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// actual first case.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00967" /><CodeLine lineNumber="967"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> SkippedFirst = DefaultExitBB == </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00968" /><CodeLine lineNumber="968"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> Case : <a href="/docs/api/namespaces/llvm/si">SI</a>.cases()) &#123;</Highlight></CodeLine>
<Link id="l00969" /><CodeLine lineNumber="969"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Case.<a href="/docs/api/classes/llvm/switchinst/casehandleimpl/#aa832438a6843b75f7d0ef2cc563153f6">getCaseSuccessor</a>() == CommonSuccBB &amp;&amp;</Highlight></CodeLine>
<Link id="l00970" /><CodeLine lineNumber="970"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;Non-common successor!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00971" /><CodeLine lineNumber="971"><Highlight kind="normal">      (void)Case;</Highlight></CodeLine>
<Link id="l00972" /><CodeLine lineNumber="972"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!SkippedFirst) &#123;</Highlight></CodeLine>
<Link id="l00973" /><CodeLine lineNumber="973"><Highlight kind="normal">        SkippedFirst = </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00974" /><CodeLine lineNumber="974"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00975" /><CodeLine lineNumber="975"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00976" /><CodeLine lineNumber="976"><Highlight kind="normal">      CommonSuccBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#afe7af0c3ec2ef1f525173acd2ea4ba60">removePredecessor</a>(BB,</Highlight></CodeLine>
<Link id="l00977" /><CodeLine lineNumber="977"><Highlight kind="normal">                                      </Highlight><Highlight kind="comment">/&#42;KeepOneInputPHIs&#42;/</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00978" /><CodeLine lineNumber="978"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00979" /><CodeLine lineNumber="979"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Now nuke the switch and replace it with a direct branch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00980" /><CodeLine lineNumber="980"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;NewBI = <a href="/docs/api/classes/llvm/branchinst/#a9f40e42226cee617c16cb1c447b115c5">BranchInst::Create</a>(CommonSuccBB, BB);</Highlight></CodeLine>
<Link id="l00981" /><CodeLine lineNumber="981"><Highlight kind="normal">    NewBI-&gt;<a href="/docs/api/classes/llvm/instruction/#ae8f5bf5cc06f696b52c709677df00fbf">setDebugLoc</a>(SIW-&gt;<a href="/docs/api/classes/llvm/instruction/#a4b8faae4ff9e7434a1d226d03d15dcd2">getDebugLoc</a>());</Highlight></CodeLine>
<Link id="l00982" /><CodeLine lineNumber="982"><Highlight kind="normal">    SIW.<a href="/docs/api/classes/llvm/switchinstprofupdatewrapper/#a241eb312f38b46a95df18ba8a6250636">eraseFromParent</a>();</Highlight></CodeLine>
<Link id="l00983" /><CodeLine lineNumber="983"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DefaultExitBB) &#123;</Highlight></CodeLine>
<Link id="l00984" /><CodeLine lineNumber="984"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/si">SI</a>.getNumCases() &gt; 0 &amp;&amp;</Highlight></CodeLine>
<Link id="l00985" /><CodeLine lineNumber="985"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;If we had no cases we&#39;d have a common successor!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00986" /><CodeLine lineNumber="986"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Move the last case to the default successor. This is valid as if the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00987" /><CodeLine lineNumber="987"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// default got unswitched it cannot be reached. This has the advantage of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00988" /><CodeLine lineNumber="988"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// being simple and keeping the number of edges from this switch to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00989" /><CodeLine lineNumber="989"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// successors the same, and avoiding any PHI update complexity.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00990" /><CodeLine lineNumber="990"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> LastCaseI = std::prev(<a href="/docs/api/namespaces/llvm/si">SI</a>.case&#95;end());</Highlight></CodeLine>
<Link id="l00991" /><CodeLine lineNumber="991"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00992" /><CodeLine lineNumber="992"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/si">SI</a>.setDefaultDest(LastCaseI-&gt;getCaseSuccessor());</Highlight></CodeLine>
<Link id="l00993" /><CodeLine lineNumber="993"><Highlight kind="normal">    SIW.<a href="/docs/api/classes/llvm/switchinstprofupdatewrapper/#a1a01b0843bc5ed009f7fdb2c8b8a41a5">setSuccessorWeight</a>(</Highlight></CodeLine>
<Link id="l00994" /><CodeLine lineNumber="994"><Highlight kind="normal">        0, SIW.<a href="/docs/api/classes/llvm/switchinstprofupdatewrapper/#aa78ac7cc796c2905e31c1ef6de35087d">getSuccessorWeight</a>(LastCaseI-&gt;getSuccessorIndex()));</Highlight></CodeLine>
<Link id="l00995" /><CodeLine lineNumber="995"><Highlight kind="normal">    SIW.<a href="/docs/api/classes/llvm/switchinstprofupdatewrapper/#adf90515665080eadf537aff00bbf0594">removeCase</a>(LastCaseI);</Highlight></CodeLine>
<Link id="l00996" /><CodeLine lineNumber="996"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00997" /><CodeLine lineNumber="997"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00998" /><CodeLine lineNumber="998"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Walk the unswitched exit blocks and the unswitched split blocks and update</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00999" /><CodeLine lineNumber="999"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the dominator tree based on the CFG edits. While we are walking unordered</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01000" /><CodeLine lineNumber="1000"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// containers here, the API for applyUpdates takes an unordered list of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01001" /><CodeLine lineNumber="1001"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// updates and requires them to not contain duplicates.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01002" /><CodeLine lineNumber="1002"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;DominatorTree::UpdateType, 4&gt;</a> DTUpdates;</Highlight></CodeLine>
<Link id="l01003" /><CodeLine lineNumber="1003"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;UnswitchedExitBB : UnswitchedExitBBs) &#123;</Highlight></CodeLine>
<Link id="l01004" /><CodeLine lineNumber="1004"><Highlight kind="normal">    DTUpdates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;DT.<a href="/docs/api/classes/llvm/dominatortreebase/#a71c91cbbfc1c0ecf9a69e10ccf739bd7">Delete</a>, ParentBB, UnswitchedExitBB&#125;);</Highlight></CodeLine>
<Link id="l01005" /><CodeLine lineNumber="1005"><Highlight kind="normal">    DTUpdates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;DT.<a href="/docs/api/classes/llvm/dominatortreebase/#a9aeeca2833810f01b20545a46fe22503">Insert</a>, OldPH, UnswitchedExitBB&#125;);</Highlight></CodeLine>
<Link id="l01006" /><CodeLine lineNumber="1006"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01007" /><CodeLine lineNumber="1007"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> SplitUnswitchedPair : SplitExitBBMap) &#123;</Highlight></CodeLine>
<Link id="l01008" /><CodeLine lineNumber="1008"><Highlight kind="normal">    DTUpdates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;DT.<a href="/docs/api/classes/llvm/dominatortreebase/#a71c91cbbfc1c0ecf9a69e10ccf739bd7">Delete</a>, ParentBB, SplitUnswitchedPair.first&#125;);</Highlight></CodeLine>
<Link id="l01009" /><CodeLine lineNumber="1009"><Highlight kind="normal">    DTUpdates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;DT.<a href="/docs/api/classes/llvm/dominatortreebase/#a9aeeca2833810f01b20545a46fe22503">Insert</a>, OldPH, SplitUnswitchedPair.second&#125;);</Highlight></CodeLine>
<Link id="l01010" /><CodeLine lineNumber="1010"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01011" /><CodeLine lineNumber="1011"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01012" /><CodeLine lineNumber="1012"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU) &#123;</Highlight></CodeLine>
<Link id="l01013" /><CodeLine lineNumber="1013"><Highlight kind="normal">    MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#ad89ca302de455d3971f751c8d1a5bd58">applyUpdates</a>(DTUpdates, DT, </Highlight><Highlight kind="comment">/&#42;UpdateDT=&#42;/</Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01014" /><CodeLine lineNumber="1014"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l01015" /><CodeLine lineNumber="1015"><Highlight kind="normal">      MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a01a350909e784d6fa43181a72de61529">getMemorySSA</a>()-&gt;<a href="/docs/api/classes/llvm/memoryssa/#a88b10d37f671e58cf138ac84a8257c17">verifyMemorySSA</a>();</Highlight></CodeLine>
<Link id="l01016" /><CodeLine lineNumber="1016"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l01017" /><CodeLine lineNumber="1017"><Highlight kind="normal">    DT.<a href="/docs/api/classes/llvm/dominatortreebase/#a470b5b573c7915fe13bd529b22c9adbc">applyUpdates</a>(DTUpdates);</Highlight></CodeLine>
<Link id="l01018" /><CodeLine lineNumber="1018"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01019" /><CodeLine lineNumber="1019"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01020" /><CodeLine lineNumber="1020"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(DT.<a href="/docs/api/classes/llvm/dominatortreebase/#a1f08f2925fec05b265e540d29066b9c8">verify</a>(DominatorTree::VerificationLevel::Fast));</Highlight></CodeLine>
<Link id="l01021" /><CodeLine lineNumber="1021"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01022" /><CodeLine lineNumber="1022"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We may have changed the nesting relationship for this loop so hoist it to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01023" /><CodeLine lineNumber="1023"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// its correct parent if needed.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01024" /><CodeLine lineNumber="1024"><Highlight kind="normal">  <a href="#afa8d35023dc30883011a5641eac69d38">hoistLoopToNewParent</a>(L, &#42;NewPH, DT, LI, MSSAU, SE);</Highlight></CodeLine>
<Link id="l01025" /><CodeLine lineNumber="1025"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01026" /><CodeLine lineNumber="1026"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU &amp;&amp; <a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l01027" /><CodeLine lineNumber="1027"><Highlight kind="normal">    MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a01a350909e784d6fa43181a72de61529">getMemorySSA</a>()-&gt;<a href="/docs/api/classes/llvm/memoryssa/#a88b10d37f671e58cf138ac84a8257c17">verifyMemorySSA</a>();</Highlight></CodeLine>
<Link id="l01028" /><CodeLine lineNumber="1028"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01029" /><CodeLine lineNumber="1029"><Highlight kind="normal">  ++NumTrivial;</Highlight></CodeLine>
<Link id="l01030" /><CodeLine lineNumber="1030"><Highlight kind="normal">  ++NumSwitches;</Highlight></CodeLine>
<Link id="l01031" /><CodeLine lineNumber="1031"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;    done: unswitching trivial switch...\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01032" /><CodeLine lineNumber="1032"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01033" /><CodeLine lineNumber="1033"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01034" /><CodeLine lineNumber="1034"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l01035" /><CodeLine lineNumber="1035"><Highlight kind="comment">/// This routine scans the loop to find a branch or switch which occurs before</Highlight></CodeLine>
<Link id="l01036" /><CodeLine lineNumber="1036"><Highlight kind="comment">/// any side effects occur. These can potentially be unswitched without</Highlight></CodeLine>
<Link id="l01037" /><CodeLine lineNumber="1037"><Highlight kind="comment">/// duplicating the loop. If a branch or switch is successfully unswitched the</Highlight></CodeLine>
<Link id="l01038" /><CodeLine lineNumber="1038"><Highlight kind="comment">/// scanning continues to see if subsequent branches or switches have become</Highlight></CodeLine>
<Link id="l01039" /><CodeLine lineNumber="1039"><Highlight kind="comment">/// trivial. Once all trivial candidates have been unswitched, this routine</Highlight></CodeLine>
<Link id="l01040" /><CodeLine lineNumber="1040"><Highlight kind="comment">/// returns.</Highlight></CodeLine>
<Link id="l01041" /><CodeLine lineNumber="1041"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01042" /><CodeLine lineNumber="1042"><Highlight kind="comment">/// The return value indicates whether anything was unswitched (and therefore</Highlight></CodeLine>
<Link id="l01043" /><CodeLine lineNumber="1043"><Highlight kind="comment">/// changed).</Highlight></CodeLine>
<Link id="l01044" /><CodeLine lineNumber="1044"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01045" /><CodeLine lineNumber="1045"><Highlight kind="comment">/// If &#96;SE&#96; is not null, it will be updated based on the potential loop SCEVs</Highlight></CodeLine>
<Link id="l01046" /><CodeLine lineNumber="1046"><Highlight kind="comment">/// invalidated by this.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01047" /><CodeLine lineNumber="1047" lineLink="#a050cc2b2d1467ffcad6a825f1141424c"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a050cc2b2d1467ffcad6a825f1141424c">unswitchAllTrivialConditions</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT,</Highlight></CodeLine>
<Link id="l01048" /><CodeLine lineNumber="1048"><Highlight kind="normal">                                         <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42;SE,</Highlight></CodeLine>
<Link id="l01049" /><CodeLine lineNumber="1049"><Highlight kind="normal">                                         <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42;MSSAU) &#123;</Highlight></CodeLine>
<Link id="l01050" /><CodeLine lineNumber="1050"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a> = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01051" /><CodeLine lineNumber="1051"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01052" /><CodeLine lineNumber="1052"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If loop header has only one reachable successor we should keep looking for</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01053" /><CodeLine lineNumber="1053"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// trivial condition candidates in the successor as well. An alternative is</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01054" /><CodeLine lineNumber="1054"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// to constant fold conditions and merge successors into loop header (then we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01055" /><CodeLine lineNumber="1055"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// only need to check header&#39;s terminator). The reason for not doing this in</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01056" /><CodeLine lineNumber="1056"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// LoopUnswitch pass is that it could potentially break LoopPassManager&#39;s</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01057" /><CodeLine lineNumber="1057"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// invariants. Folding dead branches could either eliminate the current loop</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01058" /><CodeLine lineNumber="1058"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// or make other loops unreachable. LCSSA form might also not be preserved</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01059" /><CodeLine lineNumber="1059"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// after deleting branches. The following code keeps traversing loop header&#39;s</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01060" /><CodeLine lineNumber="1060"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// successors until it finds the trivial condition candidate (condition that</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01061" /><CodeLine lineNumber="1061"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// is not a constant). Since unswitching generates branches with constant</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01062" /><CodeLine lineNumber="1062"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// conditions, this scenario could be very common in practice.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01063" /><CodeLine lineNumber="1063"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;CurrentBB = L.getHeader();</Highlight></CodeLine>
<Link id="l01064" /><CodeLine lineNumber="1064"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;BasicBlock &#42;, 8&gt;</a> Visited;</Highlight></CodeLine>
<Link id="l01065" /><CodeLine lineNumber="1065"><Highlight kind="normal">  Visited.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(CurrentBB);</Highlight></CodeLine>
<Link id="l01066" /><CodeLine lineNumber="1066"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">do</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l01067" /><CodeLine lineNumber="1067"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Check if there are any side-effecting instructions (e.g. stores, calls,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01068" /><CodeLine lineNumber="1068"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// volatile loads) in the part of the loop that the code &#42;would&#42; execute</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01069" /><CodeLine lineNumber="1069"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// without unswitching.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01070" /><CodeLine lineNumber="1070"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU) </Highlight><Highlight kind="comment">// Possible early exit with MSSA</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01071" /><CodeLine lineNumber="1071"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;Defs = MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a01a350909e784d6fa43181a72de61529">getMemorySSA</a>()-&gt;<a href="/docs/api/classes/llvm/memoryssa/#ad586af665c013c65c83a31294555f996">getBlockDefs</a>(CurrentBB))</Highlight></CodeLine>
<Link id="l01072" /><CodeLine lineNumber="1072"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;MemoryPhi&gt;</a>(&#42;Defs-&gt;begin()) || (++Defs-&gt;begin() != Defs-&gt;end()))</Highlight></CodeLine>
<Link id="l01073" /><CodeLine lineNumber="1073"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a>;</Highlight></CodeLine>
<Link id="l01074" /><CodeLine lineNumber="1074"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a61d13d6824ec46c31260a4fd0997eda0">llvm::any&#95;of</a>(&#42;CurrentBB,</Highlight></CodeLine>
<Link id="l01075" /><CodeLine lineNumber="1075"><Highlight kind="normal">                     &#91;&#93;(<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &#123; </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.mayHaveSideEffects(); &#125;))</Highlight></CodeLine>
<Link id="l01076" /><CodeLine lineNumber="1076"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a>;</Highlight></CodeLine>
<Link id="l01077" /><CodeLine lineNumber="1077"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01078" /><CodeLine lineNumber="1078"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;CurrentTerm = CurrentBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>();</Highlight></CodeLine>
<Link id="l01079" /><CodeLine lineNumber="1079"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01080" /><CodeLine lineNumber="1080"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;<a href="/docs/api/namespaces/llvm/si">SI</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;SwitchInst&gt;</a>(CurrentTerm)) &#123;</Highlight></CodeLine>
<Link id="l01081" /><CodeLine lineNumber="1081"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Don&#39;t bother trying to unswitch past a switch with a constant</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01082" /><CodeLine lineNumber="1082"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// condition. This should be removed prior to running this pass by</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01083" /><CodeLine lineNumber="1083"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// simplifycfg.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01084" /><CodeLine lineNumber="1084"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;Constant&gt;</a>(<a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getCondition()))</Highlight></CodeLine>
<Link id="l01085" /><CodeLine lineNumber="1085"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a>;</Highlight></CodeLine>
<Link id="l01086" /><CodeLine lineNumber="1086"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01087" /><CodeLine lineNumber="1087"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="#aadf6036e1d19c8ba91242af6ec48d40b">unswitchTrivialSwitch</a>(L, &#42;<a href="/docs/api/namespaces/llvm/si">SI</a>, DT, LI, SE, MSSAU))</Highlight></CodeLine>
<Link id="l01088" /><CodeLine lineNumber="1088"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Couldn&#39;t unswitch this one so we&#39;re done.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01089" /><CodeLine lineNumber="1089"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a>;</Highlight></CodeLine>
<Link id="l01090" /><CodeLine lineNumber="1090"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01091" /><CodeLine lineNumber="1091"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Mark that we managed to unswitch something.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01092" /><CodeLine lineNumber="1092"><Highlight kind="normal">      <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a> = </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01093" /><CodeLine lineNumber="1093"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01094" /><CodeLine lineNumber="1094"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// If unswitching turned the terminator into an unconditional branch then</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01095" /><CodeLine lineNumber="1095"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// we can continue. The unswitching logic specifically works to fold any</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01096" /><CodeLine lineNumber="1096"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// cases it can into an unconditional branch to make it easier to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01097" /><CodeLine lineNumber="1097"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// recognize here.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01098" /><CodeLine lineNumber="1098"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BranchInst&gt;</a>(CurrentBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l01099" /><CodeLine lineNumber="1099"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!BI || BI-&gt;isConditional())</Highlight></CodeLine>
<Link id="l01100" /><CodeLine lineNumber="1100"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a>;</Highlight></CodeLine>
<Link id="l01101" /><CodeLine lineNumber="1101"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01102" /><CodeLine lineNumber="1102"><Highlight kind="normal">      CurrentBB = BI-&gt;getSuccessor(0);</Highlight></CodeLine>
<Link id="l01103" /><CodeLine lineNumber="1103"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01104" /><CodeLine lineNumber="1104"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01105" /><CodeLine lineNumber="1105"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01106" /><CodeLine lineNumber="1106"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BranchInst&gt;</a>(CurrentTerm);</Highlight></CodeLine>
<Link id="l01107" /><CodeLine lineNumber="1107"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!BI)</Highlight></CodeLine>
<Link id="l01108" /><CodeLine lineNumber="1108"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We do not understand other terminator instructions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01109" /><CodeLine lineNumber="1109"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a>;</Highlight></CodeLine>
<Link id="l01110" /><CodeLine lineNumber="1110"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01111" /><CodeLine lineNumber="1111"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Don&#39;t bother trying to unswitch past an unconditional branch or a branch</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01112" /><CodeLine lineNumber="1112"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// with a constant value. These should be removed by simplifycfg prior to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01113" /><CodeLine lineNumber="1113"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// running this pass.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01114" /><CodeLine lineNumber="1114"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!BI-&gt;isConditional() ||</Highlight></CodeLine>
<Link id="l01115" /><CodeLine lineNumber="1115"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;Constant&gt;</a>(<a href="#a5ca2e820d1b5a49dcaad5e6873917198">skipTrivialSelect</a>(BI-&gt;getCondition())))</Highlight></CodeLine>
<Link id="l01116" /><CodeLine lineNumber="1116"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a>;</Highlight></CodeLine>
<Link id="l01117" /><CodeLine lineNumber="1117"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01118" /><CodeLine lineNumber="1118"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Found a trivial condition candidate: non-foldable conditional branch. If</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01119" /><CodeLine lineNumber="1119"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// we fail to unswitch this, we can&#39;t do anything else that is trivial.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01120" /><CodeLine lineNumber="1120"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="#a6a082aa2e05f44f7dab89e2ff8c582ff">unswitchTrivialBranch</a>(L, &#42;BI, DT, LI, SE, MSSAU))</Highlight></CodeLine>
<Link id="l01121" /><CodeLine lineNumber="1121"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a>;</Highlight></CodeLine>
<Link id="l01122" /><CodeLine lineNumber="1122"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01123" /><CodeLine lineNumber="1123"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Mark that we managed to unswitch something.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01124" /><CodeLine lineNumber="1124"><Highlight kind="normal">    <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a> = </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01125" /><CodeLine lineNumber="1125"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01126" /><CodeLine lineNumber="1126"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If we only unswitched some of the conditions feeding the branch, we won&#39;t</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01127" /><CodeLine lineNumber="1127"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// have collapsed it to a single successor.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01128" /><CodeLine lineNumber="1128"><Highlight kind="normal">    BI = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BranchInst&gt;</a>(CurrentBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l01129" /><CodeLine lineNumber="1129"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BI-&gt;isConditional())</Highlight></CodeLine>
<Link id="l01130" /><CodeLine lineNumber="1130"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a>;</Highlight></CodeLine>
<Link id="l01131" /><CodeLine lineNumber="1131"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01132" /><CodeLine lineNumber="1132"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Follow the newly unconditional branch into its successor.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01133" /><CodeLine lineNumber="1133"><Highlight kind="normal">    CurrentBB = BI-&gt;getSuccessor(0);</Highlight></CodeLine>
<Link id="l01134" /><CodeLine lineNumber="1134"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01135" /><CodeLine lineNumber="1135"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// When continuing, if we exit the loop or reach a previous visited block,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01136" /><CodeLine lineNumber="1136"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// then we can not reach any trivial condition candidates (unfoldable</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01137" /><CodeLine lineNumber="1137"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// branch instructions or switch instructions) and no unswitch can happen.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01138" /><CodeLine lineNumber="1138"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (L.contains(CurrentBB) &amp;&amp; Visited.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(CurrentBB).second);</Highlight></CodeLine>
<Link id="l01139" /><CodeLine lineNumber="1139"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01140" /><CodeLine lineNumber="1140"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a>;</Highlight></CodeLine>
<Link id="l01141" /><CodeLine lineNumber="1141"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01142" /><CodeLine lineNumber="1142"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l01143" /><CodeLine lineNumber="1143"><Highlight kind="comment">/// Build the cloned blocks for an unswitched copy of the given loop.</Highlight></CodeLine>
<Link id="l01144" /><CodeLine lineNumber="1144"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01145" /><CodeLine lineNumber="1145"><Highlight kind="comment">/// The cloned blocks are inserted before the loop preheader (&#96;LoopPH&#96;) and</Highlight></CodeLine>
<Link id="l01146" /><CodeLine lineNumber="1146"><Highlight kind="comment">/// after the split block (&#96;SplitBB&#96;) that will be used to select between the</Highlight></CodeLine>
<Link id="l01147" /><CodeLine lineNumber="1147"><Highlight kind="comment">/// cloned and original loop.</Highlight></CodeLine>
<Link id="l01148" /><CodeLine lineNumber="1148"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01149" /><CodeLine lineNumber="1149"><Highlight kind="comment">/// This routine handles cloning all of the necessary loop blocks and exit</Highlight></CodeLine>
<Link id="l01150" /><CodeLine lineNumber="1150"><Highlight kind="comment">/// blocks including rewriting their instructions and the relevant PHI nodes.</Highlight></CodeLine>
<Link id="l01151" /><CodeLine lineNumber="1151"><Highlight kind="comment">/// Any loop blocks or exit blocks which are dominated by a different successor</Highlight></CodeLine>
<Link id="l01152" /><CodeLine lineNumber="1152"><Highlight kind="comment">/// than the one for this clone of the loop blocks can be trivially skipped. We</Highlight></CodeLine>
<Link id="l01153" /><CodeLine lineNumber="1153"><Highlight kind="comment">/// use the &#96;DominatingSucc&#96; map to determine whether a block satisfies that</Highlight></CodeLine>
<Link id="l01154" /><CodeLine lineNumber="1154"><Highlight kind="comment">/// property with a simple map lookup.</Highlight></CodeLine>
<Link id="l01155" /><CodeLine lineNumber="1155"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01156" /><CodeLine lineNumber="1156"><Highlight kind="comment">/// It also correctly creates the unconditional branch in the cloned</Highlight></CodeLine>
<Link id="l01157" /><CodeLine lineNumber="1157"><Highlight kind="comment">/// unswitched parent block to only point at the unswitched successor.</Highlight></CodeLine>
<Link id="l01158" /><CodeLine lineNumber="1158"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01159" /><CodeLine lineNumber="1159"><Highlight kind="comment">/// This does not handle most of the necessary updates to &#96;LoopInfo&#96;. Only exit</Highlight></CodeLine>
<Link id="l01160" /><CodeLine lineNumber="1160"><Highlight kind="comment">/// block splitting is correctly reflected in &#96;LoopInfo&#96;, essentially all of</Highlight></CodeLine>
<Link id="l01161" /><CodeLine lineNumber="1161"><Highlight kind="comment">/// the cloned blocks (and their loops) are left without full &#96;LoopInfo&#96;</Highlight></CodeLine>
<Link id="l01162" /><CodeLine lineNumber="1162"><Highlight kind="comment">/// updates. This also doesn&#39;t fully update &#96;DominatorTree&#96;. It adds the cloned</Highlight></CodeLine>
<Link id="l01163" /><CodeLine lineNumber="1163"><Highlight kind="comment">/// blocks to them but doesn&#39;t create the cloned &#96;DominatorTree&#96; structure and</Highlight></CodeLine>
<Link id="l01164" /><CodeLine lineNumber="1164"><Highlight kind="comment">/// instead the caller must recompute an accurate DT. It &#42;does&#42; correctly</Highlight></CodeLine>
<Link id="l01165" /><CodeLine lineNumber="1165"><Highlight kind="comment">/// update the &#96;AssumptionCache&#96; provided in &#96;AC&#96;.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01166" /><CodeLine lineNumber="1166" lineLink="#aea49493e2ae224d30cda2b3235d180b0"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;<a href="#aea49493e2ae224d30cda2b3235d180b0">buildClonedLoopBlocks</a>(</Highlight></CodeLine>
<Link id="l01167" /><CodeLine lineNumber="1167"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;LoopPH, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;SplitBB,</Highlight></CodeLine>
<Link id="l01168" /><CodeLine lineNumber="1168"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;BasicBlock &#42;&gt;</a> ExitBlocks, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ParentBB,</Highlight></CodeLine>
<Link id="l01169" /><CodeLine lineNumber="1169"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;UnswitchedSuccBB, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ContinueSuccBB,</Highlight></CodeLine>
<Link id="l01170" /><CodeLine lineNumber="1170"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;BasicBlock &#42;, BasicBlock &#42;, 16&gt;</a> &amp;DominatingSucc,</Highlight></CodeLine>
<Link id="l01171" /><CodeLine lineNumber="1171"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp;VMap,</Highlight></CodeLine>
<Link id="l01172" /><CodeLine lineNumber="1172"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;DominatorTree::UpdateType&gt;</a> &amp;DTUpdates, <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &amp;AC,</Highlight></CodeLine>
<Link id="l01173" /><CodeLine lineNumber="1173"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42;MSSAU,</Highlight></CodeLine>
<Link id="l01174" /><CodeLine lineNumber="1174"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42;SE) &#123;</Highlight></CodeLine>
<Link id="l01175" /><CodeLine lineNumber="1175"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 4&gt;</a> NewBlocks;</Highlight></CodeLine>
<Link id="l01176" /><CodeLine lineNumber="1176"><Highlight kind="normal">  NewBlocks.<a href="/docs/api/classes/llvm/smallvectorimpl/#a499ea32ca1b8d16cedfe01d1e5b08f29">reserve</a>(L.getNumBlocks() + ExitBlocks.<a href="/docs/api/classes/llvm/arrayref/#a85ffb6531d4cda988ea81f18d4e56fb7">size</a>());</Highlight></CodeLine>
<Link id="l01177" /><CodeLine lineNumber="1177"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01178" /><CodeLine lineNumber="1178"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We will need to clone a bunch of blocks, wrap up the clone operation in</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01179" /><CodeLine lineNumber="1179"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// a helper.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01180" /><CodeLine lineNumber="1180"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> CloneBlock = &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;OldBB) &#123;</Highlight></CodeLine>
<Link id="l01181" /><CodeLine lineNumber="1181"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Clone the basic block and insert it before the new preheader.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01182" /><CodeLine lineNumber="1182"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewBB = <a href="/docs/api/namespaces/llvm/#aa1c8d384f90fc9d69d7fcdf920138cf2">CloneBasicBlock</a>(OldBB, VMap, </Highlight><Highlight kind="stringliteral">&quot;.us&quot;</Highlight><Highlight kind="normal">, OldBB-&gt;getParent());</Highlight></CodeLine>
<Link id="l01183" /><CodeLine lineNumber="1183"><Highlight kind="normal">    NewBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#ac1fd6437bbfce263b87f01767d950ce5">moveBefore</a>(LoopPH);</Highlight></CodeLine>
<Link id="l01184" /><CodeLine lineNumber="1184"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01185" /><CodeLine lineNumber="1185"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Record this block and the mapping.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01186" /><CodeLine lineNumber="1186"><Highlight kind="normal">    NewBlocks.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(NewBB);</Highlight></CodeLine>
<Link id="l01187" /><CodeLine lineNumber="1187"><Highlight kind="normal">    VMap&#91;OldBB&#93; = NewBB;</Highlight></CodeLine>
<Link id="l01188" /><CodeLine lineNumber="1188"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01189" /><CodeLine lineNumber="1189"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> NewBB;</Highlight></CodeLine>
<Link id="l01190" /><CodeLine lineNumber="1190"><Highlight kind="normal">  &#125;;</Highlight></CodeLine>
<Link id="l01191" /><CodeLine lineNumber="1191"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01192" /><CodeLine lineNumber="1192"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We skip cloning blocks when they have a dominating succ that is not the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01193" /><CodeLine lineNumber="1193"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// succ we are cloning for.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01194" /><CodeLine lineNumber="1194"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> SkipBlock = &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB) &#123;</Highlight></CodeLine>
<Link id="l01195" /><CodeLine lineNumber="1195"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> It = DominatingSucc.<a href="/docs/api/classes/llvm/densemapbase/#a0c047f127ed4380a6f383d70bec4eb94">find</a>(BB);</Highlight></CodeLine>
<Link id="l01196" /><CodeLine lineNumber="1196"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> It != DominatingSucc.<a href="/docs/api/classes/llvm/densemapbase/#a65520b9c67759099e313d0f4e7b5ff9e">end</a>() &amp;&amp; It-&gt;second != UnswitchedSuccBB;</Highlight></CodeLine>
<Link id="l01197" /><CodeLine lineNumber="1197"><Highlight kind="normal">  &#125;;</Highlight></CodeLine>
<Link id="l01198" /><CodeLine lineNumber="1198"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01199" /><CodeLine lineNumber="1199"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// First, clone the preheader.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01200" /><CodeLine lineNumber="1200"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ClonedPH = CloneBlock(LoopPH);</Highlight></CodeLine>
<Link id="l01201" /><CodeLine lineNumber="1201"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01202" /><CodeLine lineNumber="1202"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Then clone all the loop blocks, skipping the ones that aren&#39;t necessary.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01203" /><CodeLine lineNumber="1203"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;LoopBB : L.blocks())</Highlight></CodeLine>
<Link id="l01204" /><CodeLine lineNumber="1204"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!SkipBlock(LoopBB))</Highlight></CodeLine>
<Link id="l01205" /><CodeLine lineNumber="1205"><Highlight kind="normal">      CloneBlock(LoopBB);</Highlight></CodeLine>
<Link id="l01206" /><CodeLine lineNumber="1206"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01207" /><CodeLine lineNumber="1207"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Split all the loop exit edges so that when we clone the exit blocks, if</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01208" /><CodeLine lineNumber="1208"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// any of the exit blocks are &#42;also&#42; a preheader for some other loop, we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01209" /><CodeLine lineNumber="1209"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// don&#39;t create multiple predecessors entering the loop header.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01210" /><CodeLine lineNumber="1210"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ExitBB : ExitBlocks) &#123;</Highlight></CodeLine>
<Link id="l01211" /><CodeLine lineNumber="1211"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SkipBlock(ExitBB))</Highlight></CodeLine>
<Link id="l01212" /><CodeLine lineNumber="1212"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01213" /><CodeLine lineNumber="1213"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01214" /><CodeLine lineNumber="1214"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// When we are going to clone an exit, we don&#39;t need to clone all the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01215" /><CodeLine lineNumber="1215"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// instructions in the exit block and we want to ensure we have an easy</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01216" /><CodeLine lineNumber="1216"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// place to merge the CFG, so split the exit first. This is always safe to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01217" /><CodeLine lineNumber="1217"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// do because there cannot be any non-loop predecessors of a loop exit in</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01218" /><CodeLine lineNumber="1218"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// loop simplified form.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01219" /><CodeLine lineNumber="1219"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;MergeBB = <a href="/docs/api/namespaces/llvm/#ac6c9ffe7979754415f4ca0d677174bc2">SplitBlock</a>(ExitBB, ExitBB-&gt;begin(), &amp;DT, &amp;LI, MSSAU);</Highlight></CodeLine>
<Link id="l01220" /><CodeLine lineNumber="1220"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01221" /><CodeLine lineNumber="1221"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Rearrange the names to make it easier to write test cases by having the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01222" /><CodeLine lineNumber="1222"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// exit block carry the suffix rather than the merge block carrying the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01223" /><CodeLine lineNumber="1223"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// suffix.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01224" /><CodeLine lineNumber="1224"><Highlight kind="normal">    MergeBB-&gt;takeName(ExitBB);</Highlight></CodeLine>
<Link id="l01225" /><CodeLine lineNumber="1225"><Highlight kind="normal">    ExitBB-&gt;setName(<a href="/docs/api/classes/llvm/twine">Twine</a>(MergeBB-&gt;getName()) + </Highlight><Highlight kind="stringliteral">&quot;.split&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01226" /><CodeLine lineNumber="1226"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01227" /><CodeLine lineNumber="1227"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Now clone the original exit block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01228" /><CodeLine lineNumber="1228"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ClonedExitBB = CloneBlock(ExitBB);</Highlight></CodeLine>
<Link id="l01229" /><CodeLine lineNumber="1229"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(ClonedExitBB-&gt;getTerminator()-&gt;getNumSuccessors() == 1 &amp;&amp;</Highlight></CodeLine>
<Link id="l01230" /><CodeLine lineNumber="1230"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;Exit block should have been split to have one successor!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01231" /><CodeLine lineNumber="1231"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(ClonedExitBB-&gt;getTerminator()-&gt;getSuccessor(0) == MergeBB &amp;&amp;</Highlight></CodeLine>
<Link id="l01232" /><CodeLine lineNumber="1232"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;Cloned exit block has the wrong successor!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01233" /><CodeLine lineNumber="1233"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01234" /><CodeLine lineNumber="1234"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Remap any cloned instructions and create a merge phi node for them.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01235" /><CodeLine lineNumber="1235"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> ZippedInsts : <a href="/docs/api/namespaces/llvm/#a740d35e0d3e2f7601f845b641fe58971">llvm::zip&#95;first</a>(</Highlight></CodeLine>
<Link id="l01236" /><CodeLine lineNumber="1236"><Highlight kind="normal">             <a href="/docs/api/namespaces/llvm/#a341215803e83773a3e97860dc291f121">llvm::make&#95;range</a>(ExitBB-&gt;begin(), std::prev(ExitBB-&gt;end())),</Highlight></CodeLine>
<Link id="l01237" /><CodeLine lineNumber="1237"><Highlight kind="normal">             <a href="/docs/api/namespaces/llvm/#a341215803e83773a3e97860dc291f121">llvm::make&#95;range</a>(ClonedExitBB-&gt;begin(),</Highlight></CodeLine>
<Link id="l01238" /><CodeLine lineNumber="1238"><Highlight kind="normal">                              std::prev(ClonedExitBB-&gt;end())))) &#123;</Highlight></CodeLine>
<Link id="l01239" /><CodeLine lineNumber="1239"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = std::get&lt;0&gt;(ZippedInsts);</Highlight></CodeLine>
<Link id="l01240" /><CodeLine lineNumber="1240"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;ClonedI = std::get&lt;1&gt;(ZippedInsts);</Highlight></CodeLine>
<Link id="l01241" /><CodeLine lineNumber="1241"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01242" /><CodeLine lineNumber="1242"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// The only instructions in the exit block should be PHI nodes and</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01243" /><CodeLine lineNumber="1243"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// potentially a landing pad.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01244" /><CodeLine lineNumber="1244"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(</Highlight></CodeLine>
<Link id="l01245" /><CodeLine lineNumber="1245"><Highlight kind="normal">          (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;PHINode&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) || <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;LandingPadInst&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) || <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;CatchPadInst&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) &amp;&amp;</Highlight></CodeLine>
<Link id="l01246" /><CodeLine lineNumber="1246"><Highlight kind="normal">          </Highlight><Highlight kind="stringliteral">&quot;Bad instruction in exit block!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01247" /><CodeLine lineNumber="1247"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We should have a value map between the instruction and its clone.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01248" /><CodeLine lineNumber="1248"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(VMap.<a href="/docs/api/classes/llvm/valuemap/#a15f92579a5fc316dab8cd1fad51015ef">lookup</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) == &amp;ClonedI &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Mismatch in the value map!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01249" /><CodeLine lineNumber="1249"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01250" /><CodeLine lineNumber="1250"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Forget SCEVs based on exit phis in case SCEV looked through the phi.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01251" /><CodeLine lineNumber="1251"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SE)</Highlight></CodeLine>
<Link id="l01252" /><CodeLine lineNumber="1252"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;PN = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;PHINode&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</Highlight></CodeLine>
<Link id="l01253" /><CodeLine lineNumber="1253"><Highlight kind="normal">          SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#aa6dc58a1259941c7a17142e6103d059e">forgetLcssaPhiWithNewPredecessor</a>(&amp;L, PN);</Highlight></CodeLine>
<Link id="l01254" /><CodeLine lineNumber="1254"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01255" /><CodeLine lineNumber="1255"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> InsertPt = MergeBB-&gt;getFirstInsertionPt();</Highlight></CodeLine>
<Link id="l01256" /><CodeLine lineNumber="1256"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01257" /><CodeLine lineNumber="1257"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;MergePN =</Highlight></CodeLine>
<Link id="l01258" /><CodeLine lineNumber="1258"><Highlight kind="normal">          <a href="/docs/api/classes/llvm/phinode/#af4aba918a76ca15bde1be3e14572e475">PHINode::Create</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getType(), </Highlight><Highlight kind="comment">/&#42;NumReservedValues&#42;/</Highlight><Highlight kind="normal"> 2, </Highlight><Highlight kind="stringliteral">&quot;.us-phi&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01259" /><CodeLine lineNumber="1259"><Highlight kind="normal">      MergePN-&gt;insertBefore(InsertPt);</Highlight></CodeLine>
<Link id="l01260" /><CodeLine lineNumber="1260"><Highlight kind="normal">      MergePN-&gt;setDebugLoc(InsertPt-&gt;getDebugLoc());</Highlight></CodeLine>
<Link id="l01261" /><CodeLine lineNumber="1261"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.replaceAllUsesWith(MergePN);</Highlight></CodeLine>
<Link id="l01262" /><CodeLine lineNumber="1262"><Highlight kind="normal">      MergePN-&gt;addIncoming(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, ExitBB);</Highlight></CodeLine>
<Link id="l01263" /><CodeLine lineNumber="1263"><Highlight kind="normal">      MergePN-&gt;addIncoming(&amp;ClonedI, ClonedExitBB);</Highlight></CodeLine>
<Link id="l01264" /><CodeLine lineNumber="1264"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01265" /><CodeLine lineNumber="1265"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01266" /><CodeLine lineNumber="1266"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01267" /><CodeLine lineNumber="1267"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Rewrite the instructions in the cloned blocks to refer to the instructions</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01268" /><CodeLine lineNumber="1268"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// in the cloned blocks. We have to do this as a second pass so that we have</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01269" /><CodeLine lineNumber="1269"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// everything available. Also, we have inserted new instructions which may</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01270" /><CodeLine lineNumber="1270"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// include assume intrinsics, so we update the assumption cache while</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01271" /><CodeLine lineNumber="1271"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// processing this.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01272" /><CodeLine lineNumber="1272"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/module">Module</a> &#42;M = ClonedPH-&gt;getParent()-&gt;getParent();</Highlight></CodeLine>
<Link id="l01273" /><CodeLine lineNumber="1273"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ClonedBB : NewBlocks)</Highlight></CodeLine>
<Link id="l01274" /><CodeLine lineNumber="1274"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : &#42;ClonedBB) &#123;</Highlight></CodeLine>
<Link id="l01275" /><CodeLine lineNumber="1275"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a3c6de822ccc920e435932d6cb73ac146">RemapDbgRecordRange</a>(M, <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getDbgRecordRange(), VMap,</Highlight></CodeLine>
<Link id="l01276" /><CodeLine lineNumber="1276"><Highlight kind="normal">                          <a href="/docs/api/namespaces/llvm/#a77724415203930efd07d7098cb1e437da9a24bd8dba1bef2753bc3f087435ae7f">RF&#95;NoModuleLevelChanges</a> | <a href="/docs/api/namespaces/llvm/#a77724415203930efd07d7098cb1e437da5633028bc27ffa8eab39cc5de65b3108">RF&#95;IgnoreMissingLocals</a>);</Highlight></CodeLine>
<Link id="l01277" /><CodeLine lineNumber="1277"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a7da684e1cead3524bdd9b0d171aad161">RemapInstruction</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, VMap,</Highlight></CodeLine>
<Link id="l01278" /><CodeLine lineNumber="1278"><Highlight kind="normal">                       <a href="/docs/api/namespaces/llvm/#a77724415203930efd07d7098cb1e437da9a24bd8dba1bef2753bc3f087435ae7f">RF&#95;NoModuleLevelChanges</a> | <a href="/docs/api/namespaces/llvm/#a77724415203930efd07d7098cb1e437da5633028bc27ffa8eab39cc5de65b3108">RF&#95;IgnoreMissingLocals</a>);</Highlight></CodeLine>
<Link id="l01279" /><CodeLine lineNumber="1279"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;AssumeInst&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</Highlight></CodeLine>
<Link id="l01280" /><CodeLine lineNumber="1280"><Highlight kind="normal">        AC.<a href="/docs/api/classes/llvm/assumptioncache/#a23187618f079555e127ba0e7b4581530">registerAssumption</a>(<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a>);</Highlight></CodeLine>
<Link id="l01281" /><CodeLine lineNumber="1281"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01282" /><CodeLine lineNumber="1282"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01283" /><CodeLine lineNumber="1283"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Update any PHI nodes in the cloned successors of the skipped blocks to not</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01284" /><CodeLine lineNumber="1284"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// have spurious incoming values.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01285" /><CodeLine lineNumber="1285"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;LoopBB : L.blocks())</Highlight></CodeLine>
<Link id="l01286" /><CodeLine lineNumber="1286"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SkipBlock(LoopBB))</Highlight></CodeLine>
<Link id="l01287" /><CodeLine lineNumber="1287"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;SuccBB : <a href="/docs/api/namespaces/llvm/#a26e2a938b431eaa6eca2beaa96410c9d">successors</a>(LoopBB))</Highlight></CodeLine>
<Link id="l01288" /><CodeLine lineNumber="1288"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ClonedSuccBB = <a href="/docs/api/namespaces/llvm/#a3e627c32543ca70720c4270a8b11da3f">cast&#95;or&#95;null&lt;BasicBlock&gt;</a>(VMap.<a href="/docs/api/classes/llvm/valuemap/#a15f92579a5fc316dab8cd1fad51015ef">lookup</a>(SuccBB)))</Highlight></CodeLine>
<Link id="l01289" /><CodeLine lineNumber="1289"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/phinode">PHINode</a> &amp;PN : ClonedSuccBB-&gt;phis())</Highlight></CodeLine>
<Link id="l01290" /><CodeLine lineNumber="1290"><Highlight kind="normal">            PN.removeIncomingValue(LoopBB, </Highlight><Highlight kind="comment">/&#42;DeletePHIIfEmpty&#42;/</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01291" /><CodeLine lineNumber="1291"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01292" /><CodeLine lineNumber="1292"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Remove the cloned parent as a predecessor of any successor we ended up</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01293" /><CodeLine lineNumber="1293"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// cloning other than the unswitched one.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01294" /><CodeLine lineNumber="1294"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ClonedParentBB = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(VMap.<a href="/docs/api/classes/llvm/valuemap/#a15f92579a5fc316dab8cd1fad51015ef">lookup</a>(ParentBB));</Highlight></CodeLine>
<Link id="l01295" /><CodeLine lineNumber="1295"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;SuccBB : <a href="/docs/api/namespaces/llvm/#a26e2a938b431eaa6eca2beaa96410c9d">successors</a>(ParentBB)) &#123;</Highlight></CodeLine>
<Link id="l01296" /><CodeLine lineNumber="1296"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SuccBB == UnswitchedSuccBB)</Highlight></CodeLine>
<Link id="l01297" /><CodeLine lineNumber="1297"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01298" /><CodeLine lineNumber="1298"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01299" /><CodeLine lineNumber="1299"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ClonedSuccBB = <a href="/docs/api/namespaces/llvm/#a3e627c32543ca70720c4270a8b11da3f">cast&#95;or&#95;null&lt;BasicBlock&gt;</a>(VMap.<a href="/docs/api/classes/llvm/valuemap/#a15f92579a5fc316dab8cd1fad51015ef">lookup</a>(SuccBB));</Highlight></CodeLine>
<Link id="l01300" /><CodeLine lineNumber="1300"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!ClonedSuccBB)</Highlight></CodeLine>
<Link id="l01301" /><CodeLine lineNumber="1301"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01302" /><CodeLine lineNumber="1302"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01303" /><CodeLine lineNumber="1303"><Highlight kind="normal">    ClonedSuccBB-&gt;removePredecessor(ClonedParentBB,</Highlight></CodeLine>
<Link id="l01304" /><CodeLine lineNumber="1304"><Highlight kind="normal">                                    </Highlight><Highlight kind="comment">/&#42;KeepOneInputPHIs&#42;/</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01305" /><CodeLine lineNumber="1305"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01306" /><CodeLine lineNumber="1306"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01307" /><CodeLine lineNumber="1307"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Replace the cloned branch with an unconditional branch to the cloned</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01308" /><CodeLine lineNumber="1308"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// unswitched successor.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01309" /><CodeLine lineNumber="1309"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ClonedSuccBB = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(VMap.<a href="/docs/api/classes/llvm/valuemap/#a15f92579a5fc316dab8cd1fad51015ef">lookup</a>(UnswitchedSuccBB));</Highlight></CodeLine>
<Link id="l01310" /><CodeLine lineNumber="1310"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;ClonedTerminator = ClonedParentBB-&gt;getTerminator();</Highlight></CodeLine>
<Link id="l01311" /><CodeLine lineNumber="1311"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Trivial Simplification. If Terminator is a conditional branch and</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01312" /><CodeLine lineNumber="1312"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// condition becomes dead - erase it.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01313" /><CodeLine lineNumber="1313"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;ClonedConditionToErase = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01314" /><CodeLine lineNumber="1314"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BranchInst&gt;</a>(ClonedTerminator))</Highlight></CodeLine>
<Link id="l01315" /><CodeLine lineNumber="1315"><Highlight kind="normal">    ClonedConditionToErase = BI-&gt;getCondition();</Highlight></CodeLine>
<Link id="l01316" /><CodeLine lineNumber="1316"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;<a href="/docs/api/namespaces/llvm/si">SI</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;SwitchInst&gt;</a>(ClonedTerminator))</Highlight></CodeLine>
<Link id="l01317" /><CodeLine lineNumber="1317"><Highlight kind="normal">    ClonedConditionToErase = <a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getCondition();</Highlight></CodeLine>
<Link id="l01318" /><CodeLine lineNumber="1318"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01319" /><CodeLine lineNumber="1319"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;BI = <a href="/docs/api/classes/llvm/branchinst/#a9f40e42226cee617c16cb1c447b115c5">BranchInst::Create</a>(ClonedSuccBB, ClonedParentBB);</Highlight></CodeLine>
<Link id="l01320" /><CodeLine lineNumber="1320"><Highlight kind="normal">  BI-&gt;<a href="/docs/api/classes/llvm/instruction/#ae8f5bf5cc06f696b52c709677df00fbf">setDebugLoc</a>(ClonedTerminator-&gt;<a href="/docs/api/classes/llvm/instruction/#a4b8faae4ff9e7434a1d226d03d15dcd2">getDebugLoc</a>());</Highlight></CodeLine>
<Link id="l01321" /><CodeLine lineNumber="1321"><Highlight kind="normal">  ClonedTerminator-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</Highlight></CodeLine>
<Link id="l01322" /><CodeLine lineNumber="1322"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01323" /><CodeLine lineNumber="1323"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (ClonedConditionToErase)</Highlight></CodeLine>
<Link id="l01324" /><CodeLine lineNumber="1324"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a1106b8a15061e8494873e10bb8a364e5">RecursivelyDeleteTriviallyDeadInstructions</a>(ClonedConditionToErase, </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l01325" /><CodeLine lineNumber="1325"><Highlight kind="normal">                                               MSSAU);</Highlight></CodeLine>
<Link id="l01326" /><CodeLine lineNumber="1326"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01327" /><CodeLine lineNumber="1327"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If there are duplicate entries in the PHI nodes because of multiple edges</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01328" /><CodeLine lineNumber="1328"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// to the unswitched successor, we need to nuke all but one as we replaced it</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01329" /><CodeLine lineNumber="1329"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// with a direct branch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01330" /><CodeLine lineNumber="1330"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/phinode">PHINode</a> &amp;PN : ClonedSuccBB-&gt;phis()) &#123;</Highlight></CodeLine>
<Link id="l01331" /><CodeLine lineNumber="1331"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> Found = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01332" /><CodeLine lineNumber="1332"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Loop over the incoming operands backwards so we can easily delete as we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01333" /><CodeLine lineNumber="1333"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// go without invalidating the index.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01334" /><CodeLine lineNumber="1334"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> i = PN.getNumOperands() - 1; i &gt;= 0; --i) &#123;</Highlight></CodeLine>
<Link id="l01335" /><CodeLine lineNumber="1335"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (PN.getIncomingBlock(i) != ClonedParentBB)</Highlight></CodeLine>
<Link id="l01336" /><CodeLine lineNumber="1336"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01337" /><CodeLine lineNumber="1337"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!Found) &#123;</Highlight></CodeLine>
<Link id="l01338" /><CodeLine lineNumber="1338"><Highlight kind="normal">        Found = </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01339" /><CodeLine lineNumber="1339"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01340" /><CodeLine lineNumber="1340"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l01341" /><CodeLine lineNumber="1341"><Highlight kind="normal">      PN.removeIncomingValue(i, </Highlight><Highlight kind="comment">/&#42;DeletePHIIfEmpty&#42;/</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01342" /><CodeLine lineNumber="1342"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01343" /><CodeLine lineNumber="1343"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01344" /><CodeLine lineNumber="1344"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01345" /><CodeLine lineNumber="1345"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Record the domtree updates for the new blocks.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01346" /><CodeLine lineNumber="1346"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;BasicBlock &#42;, 4&gt;</a> SuccSet;</Highlight></CodeLine>
<Link id="l01347" /><CodeLine lineNumber="1347"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ClonedBB : NewBlocks) &#123;</Highlight></CodeLine>
<Link id="l01348" /><CodeLine lineNumber="1348"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;SuccBB : <a href="/docs/api/namespaces/llvm/#a26e2a938b431eaa6eca2beaa96410c9d">successors</a>(ClonedBB))</Highlight></CodeLine>
<Link id="l01349" /><CodeLine lineNumber="1349"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SuccSet.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(SuccBB).second)</Highlight></CodeLine>
<Link id="l01350" /><CodeLine lineNumber="1350"><Highlight kind="normal">        DTUpdates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;<a href="/docs/api/classes/llvm/dominatortreebase/#a9aeeca2833810f01b20545a46fe22503">DominatorTree::Insert</a>, ClonedBB, SuccBB&#125;);</Highlight></CodeLine>
<Link id="l01351" /><CodeLine lineNumber="1351"><Highlight kind="normal">    SuccSet.<a href="/docs/api/classes/llvm/smallptrsetimplbase/#a16413f1a88d8baca228d0a1b4cc0bfc6">clear</a>();</Highlight></CodeLine>
<Link id="l01352" /><CodeLine lineNumber="1352"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01353" /><CodeLine lineNumber="1353"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01354" /><CodeLine lineNumber="1354"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> ClonedPH;</Highlight></CodeLine>
<Link id="l01355" /><CodeLine lineNumber="1355"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01356" /><CodeLine lineNumber="1356"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l01357" /><CodeLine lineNumber="1357"><Highlight kind="comment">/// Recursively clone the specified loop and all of its children.</Highlight></CodeLine>
<Link id="l01358" /><CodeLine lineNumber="1358"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01359" /><CodeLine lineNumber="1359"><Highlight kind="comment">/// The target parent loop for the clone should be provided, or can be null if</Highlight></CodeLine>
<Link id="l01360" /><CodeLine lineNumber="1360"><Highlight kind="comment">/// the clone is a top-level loop. While cloning, all the blocks are mapped</Highlight></CodeLine>
<Link id="l01361" /><CodeLine lineNumber="1361"><Highlight kind="comment">/// with the provided value map. The entire original loop must be present in</Highlight></CodeLine>
<Link id="l01362" /><CodeLine lineNumber="1362"><Highlight kind="comment">/// the value map. The cloned loop is returned.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01363" /><CodeLine lineNumber="1363" lineLink="#af747cc9f106d837a03d08bd395ede216"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;<a href="#af747cc9f106d837a03d08bd395ede216">cloneLoopNest</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;OrigRootL, <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;RootParentL,</Highlight></CodeLine>
<Link id="l01364" /><CodeLine lineNumber="1364"><Highlight kind="normal">                           </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp;VMap, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI) &#123;</Highlight></CodeLine>
<Link id="l01365" /><CodeLine lineNumber="1365"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> AddClonedBlocksToLoop = &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;OrigL, <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;ClonedL) &#123;</Highlight></CodeLine>
<Link id="l01366" /><CodeLine lineNumber="1366"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(ClonedL.getBlocks().empty() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Must start with an empty loop!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01367" /><CodeLine lineNumber="1367"><Highlight kind="normal">    ClonedL.reserveBlocks(OrigL.<a href="/docs/api/classes/llvm/loopbase/#a261ee3c4745564c7be9283984c9af06b">getNumBlocks</a>());</Highlight></CodeLine>
<Link id="l01368" /><CodeLine lineNumber="1368"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB : OrigL.<a href="/docs/api/classes/llvm/loopbase/#a78bec3084b9a47ee11cc2e56f9004717">blocks</a>()) &#123;</Highlight></CodeLine>
<Link id="l01369" /><CodeLine lineNumber="1369"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ClonedBB = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(VMap.<a href="/docs/api/classes/llvm/valuemap/#a15f92579a5fc316dab8cd1fad51015ef">lookup</a>(BB));</Highlight></CodeLine>
<Link id="l01370" /><CodeLine lineNumber="1370"><Highlight kind="normal">      ClonedL.addBlockEntry(ClonedBB);</Highlight></CodeLine>
<Link id="l01371" /><CodeLine lineNumber="1371"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (LI.<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(BB) == &amp;OrigL)</Highlight></CodeLine>
<Link id="l01372" /><CodeLine lineNumber="1372"><Highlight kind="normal">        LI.<a href="/docs/api/classes/llvm/loopinfobase/#a97de9fb6fdce68e4e31300fcf0e5a20c">changeLoopFor</a>(ClonedBB, &amp;ClonedL);</Highlight></CodeLine>
<Link id="l01373" /><CodeLine lineNumber="1373"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01374" /><CodeLine lineNumber="1374"><Highlight kind="normal">  &#125;;</Highlight></CodeLine>
<Link id="l01375" /><CodeLine lineNumber="1375"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01376" /><CodeLine lineNumber="1376"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We specially handle the first loop because it may get cloned into</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01377" /><CodeLine lineNumber="1377"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// a different parent and because we most commonly are cloning leaf loops.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01378" /><CodeLine lineNumber="1378"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ClonedRootL = LI.<a href="/docs/api/classes/llvm/loopinfobase/#a5a0ae49bf720341774a25029fd23bf59">AllocateLoop</a>();</Highlight></CodeLine>
<Link id="l01379" /><CodeLine lineNumber="1379"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (RootParentL)</Highlight></CodeLine>
<Link id="l01380" /><CodeLine lineNumber="1380"><Highlight kind="normal">    RootParentL-&gt;<a href="/docs/api/classes/llvm/loopbase/#a990a86b0de7a84a9f489d2034878e330">addChildLoop</a>(ClonedRootL);</Highlight></CodeLine>
<Link id="l01381" /><CodeLine lineNumber="1381"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01382" /><CodeLine lineNumber="1382"><Highlight kind="normal">    LI.<a href="/docs/api/classes/llvm/loopinfobase/#a1e4ac7b073d744d43f3cb1a3660c03c3">addTopLevelLoop</a>(ClonedRootL);</Highlight></CodeLine>
<Link id="l01383" /><CodeLine lineNumber="1383"><Highlight kind="normal">  AddClonedBlocksToLoop(OrigRootL, &#42;ClonedRootL);</Highlight></CodeLine>
<Link id="l01384" /><CodeLine lineNumber="1384"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01385" /><CodeLine lineNumber="1385"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (OrigRootL.<a href="/docs/api/classes/llvm/loopbase/#a16165c1e5da45acaa086c3a54a188d34">isInnermost</a>())</Highlight></CodeLine>
<Link id="l01386" /><CodeLine lineNumber="1386"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> ClonedRootL;</Highlight></CodeLine>
<Link id="l01387" /><CodeLine lineNumber="1387"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01388" /><CodeLine lineNumber="1388"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If we have a nest, we can quickly clone the entire loop nest using an</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01389" /><CodeLine lineNumber="1389"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// iterative approach because it is a tree. We keep the cloned parent in the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01390" /><CodeLine lineNumber="1390"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// data structure to avoid repeatedly querying through a map to find it.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01391" /><CodeLine lineNumber="1391"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;std::pair&lt;Loop &#42;, Loop &#42;&gt;</a>, 16&gt; LoopsToClone;</Highlight></CodeLine>
<Link id="l01392" /><CodeLine lineNumber="1392"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Build up the loops to clone in reverse order as we&#39;ll clone them from the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01393" /><CodeLine lineNumber="1393"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// back.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01394" /><CodeLine lineNumber="1394"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ChildL : <a href="/docs/api/namespaces/llvm/#a6b0ac1fa4f05de76413c5e0ca6334035">llvm::reverse</a>(OrigRootL))</Highlight></CodeLine>
<Link id="l01395" /><CodeLine lineNumber="1395"><Highlight kind="normal">    LoopsToClone.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;ClonedRootL, ChildL&#125;);</Highlight></CodeLine>
<Link id="l01396" /><CodeLine lineNumber="1396"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">do</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l01397" /><CodeLine lineNumber="1397"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ClonedParentL, &#42;L;</Highlight></CodeLine>
<Link id="l01398" /><CodeLine lineNumber="1398"><Highlight kind="normal">    std::tie(ClonedParentL, L) = LoopsToClone.<a href="/docs/api/classes/llvm/smallvectorimpl/#a0c8ffe664a36e30d49c84d0aded2fe08">pop&#95;back&#95;val</a>();</Highlight></CodeLine>
<Link id="l01399" /><CodeLine lineNumber="1399"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ClonedL = LI.<a href="/docs/api/classes/llvm/loopinfobase/#a5a0ae49bf720341774a25029fd23bf59">AllocateLoop</a>();</Highlight></CodeLine>
<Link id="l01400" /><CodeLine lineNumber="1400"><Highlight kind="normal">    ClonedParentL-&gt;<a href="/docs/api/classes/llvm/loopbase/#a990a86b0de7a84a9f489d2034878e330">addChildLoop</a>(ClonedL);</Highlight></CodeLine>
<Link id="l01401" /><CodeLine lineNumber="1401"><Highlight kind="normal">    AddClonedBlocksToLoop(&#42;L, &#42;ClonedL);</Highlight></CodeLine>
<Link id="l01402" /><CodeLine lineNumber="1402"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ChildL : <a href="/docs/api/namespaces/llvm/#a6b0ac1fa4f05de76413c5e0ca6334035">llvm::reverse</a>(&#42;L))</Highlight></CodeLine>
<Link id="l01403" /><CodeLine lineNumber="1403"><Highlight kind="normal">      LoopsToClone.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;ClonedL, ChildL&#125;);</Highlight></CodeLine>
<Link id="l01404" /><CodeLine lineNumber="1404"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (!LoopsToClone.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>());</Highlight></CodeLine>
<Link id="l01405" /><CodeLine lineNumber="1405"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01406" /><CodeLine lineNumber="1406"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> ClonedRootL;</Highlight></CodeLine>
<Link id="l01407" /><CodeLine lineNumber="1407"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01408" /><CodeLine lineNumber="1408"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l01409" /><CodeLine lineNumber="1409"><Highlight kind="comment">/// Build the cloned loops of an original loop from unswitching.</Highlight></CodeLine>
<Link id="l01410" /><CodeLine lineNumber="1410"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01411" /><CodeLine lineNumber="1411"><Highlight kind="comment">/// Because unswitching simplifies the CFG of the loop, this isn&#39;t a trivial</Highlight></CodeLine>
<Link id="l01412" /><CodeLine lineNumber="1412"><Highlight kind="comment">/// operation. We need to re-verify that there even is a loop (as the backedge</Highlight></CodeLine>
<Link id="l01413" /><CodeLine lineNumber="1413"><Highlight kind="comment">/// may not have been cloned), and even if there are remaining backedges the</Highlight></CodeLine>
<Link id="l01414" /><CodeLine lineNumber="1414"><Highlight kind="comment">/// backedge set may be different. However, we know that each child loop is</Highlight></CodeLine>
<Link id="l01415" /><CodeLine lineNumber="1415"><Highlight kind="comment">/// undisturbed, we only need to find where to place each child loop within</Highlight></CodeLine>
<Link id="l01416" /><CodeLine lineNumber="1416"><Highlight kind="comment">/// either any parent loop or within a cloned version of the original loop.</Highlight></CodeLine>
<Link id="l01417" /><CodeLine lineNumber="1417"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01418" /><CodeLine lineNumber="1418"><Highlight kind="comment">/// Because child loops may end up cloned outside of any cloned version of the</Highlight></CodeLine>
<Link id="l01419" /><CodeLine lineNumber="1419"><Highlight kind="comment">/// original loop, multiple cloned sibling loops may be created. All of them</Highlight></CodeLine>
<Link id="l01420" /><CodeLine lineNumber="1420"><Highlight kind="comment">/// are returned so that the newly introduced loop nest roots can be</Highlight></CodeLine>
<Link id="l01421" /><CodeLine lineNumber="1421"><Highlight kind="comment">/// identified.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01422" /><CodeLine lineNumber="1422" lineLink="#afe5225e90ea8896cab9cda7246af413d"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#afe5225e90ea8896cab9cda7246af413d">buildClonedLoops</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;OrigL, <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;BasicBlock &#42;&gt;</a> ExitBlocks,</Highlight></CodeLine>
<Link id="l01423" /><CodeLine lineNumber="1423"><Highlight kind="normal">                             </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp;VMap, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI,</Highlight></CodeLine>
<Link id="l01424" /><CodeLine lineNumber="1424"><Highlight kind="normal">                             <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;Loop &#42;&gt;</a> &amp;NonChildClonedLoops) &#123;</Highlight></CodeLine>
<Link id="l01425" /><CodeLine lineNumber="1425"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ClonedL = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01426" /><CodeLine lineNumber="1426"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01427" /><CodeLine lineNumber="1427"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;OrigPH = OrigL.<a href="/docs/api/classes/llvm/loopbase/#ac3280e7f76f955403fe17eacf126b90d">getLoopPreheader</a>();</Highlight></CodeLine>
<Link id="l01428" /><CodeLine lineNumber="1428"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;OrigHeader = OrigL.<a href="/docs/api/classes/llvm/loopbase/#a4a75755081e9a3803d2f4ccf6f0cb1f8">getHeader</a>();</Highlight></CodeLine>
<Link id="l01429" /><CodeLine lineNumber="1429"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01430" /><CodeLine lineNumber="1430"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ClonedPH = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(VMap.<a href="/docs/api/classes/llvm/valuemap/#a15f92579a5fc316dab8cd1fad51015ef">lookup</a>(OrigPH));</Highlight></CodeLine>
<Link id="l01431" /><CodeLine lineNumber="1431"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ClonedHeader = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(VMap.<a href="/docs/api/classes/llvm/valuemap/#a15f92579a5fc316dab8cd1fad51015ef">lookup</a>(OrigHeader));</Highlight></CodeLine>
<Link id="l01432" /><CodeLine lineNumber="1432"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01433" /><CodeLine lineNumber="1433"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We need to know the loops of the cloned exit blocks to even compute the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01434" /><CodeLine lineNumber="1434"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// accurate parent loop. If we only clone exits to some parent of the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01435" /><CodeLine lineNumber="1435"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// original parent, we want to clone into that outer loop. We also keep track</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01436" /><CodeLine lineNumber="1436"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// of the loops that our cloned exit blocks participate in.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01437" /><CodeLine lineNumber="1437"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ParentL = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01438" /><CodeLine lineNumber="1438"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 4&gt;</a> ClonedExitsInLoops;</Highlight></CodeLine>
<Link id="l01439" /><CodeLine lineNumber="1439"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;BasicBlock &#42;, Loop &#42;, 16&gt;</a> ExitLoopMap;</Highlight></CodeLine>
<Link id="l01440" /><CodeLine lineNumber="1440"><Highlight kind="normal">  ClonedExitsInLoops.<a href="/docs/api/classes/llvm/smallvectorimpl/#a499ea32ca1b8d16cedfe01d1e5b08f29">reserve</a>(ExitBlocks.<a href="/docs/api/classes/llvm/arrayref/#a85ffb6531d4cda988ea81f18d4e56fb7">size</a>());</Highlight></CodeLine>
<Link id="l01441" /><CodeLine lineNumber="1441"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ExitBB : ExitBlocks)</Highlight></CodeLine>
<Link id="l01442" /><CodeLine lineNumber="1442"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ClonedExitBB = <a href="/docs/api/namespaces/llvm/#a3e627c32543ca70720c4270a8b11da3f">cast&#95;or&#95;null&lt;BasicBlock&gt;</a>(VMap.<a href="/docs/api/classes/llvm/valuemap/#a15f92579a5fc316dab8cd1fad51015ef">lookup</a>(ExitBB)))</Highlight></CodeLine>
<Link id="l01443" /><CodeLine lineNumber="1443"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ExitL = LI.<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(ExitBB)) &#123;</Highlight></CodeLine>
<Link id="l01444" /><CodeLine lineNumber="1444"><Highlight kind="normal">        ExitLoopMap&#91;ClonedExitBB&#93; = ExitL;</Highlight></CodeLine>
<Link id="l01445" /><CodeLine lineNumber="1445"><Highlight kind="normal">        ClonedExitsInLoops.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(ClonedExitBB);</Highlight></CodeLine>
<Link id="l01446" /><CodeLine lineNumber="1446"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!ParentL || (ParentL != ExitL &amp;&amp; ParentL-&gt;<a href="/docs/api/classes/llvm/loopbase/#a04337b572d34ea413c35dbac5d75530b">contains</a>(ExitL)))</Highlight></CodeLine>
<Link id="l01447" /><CodeLine lineNumber="1447"><Highlight kind="normal">          ParentL = ExitL;</Highlight></CodeLine>
<Link id="l01448" /><CodeLine lineNumber="1448"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l01449" /><CodeLine lineNumber="1449"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((!ParentL || ParentL == OrigL.<a href="/docs/api/classes/llvm/loopbase/#ae34bcd53f75fab0c03b509ecccb4cfaf">getParentLoop</a>() ||</Highlight></CodeLine>
<Link id="l01450" /><CodeLine lineNumber="1450"><Highlight kind="normal">          ParentL-&gt;<a href="/docs/api/classes/llvm/loopbase/#a04337b572d34ea413c35dbac5d75530b">contains</a>(OrigL.<a href="/docs/api/classes/llvm/loopbase/#ae34bcd53f75fab0c03b509ecccb4cfaf">getParentLoop</a>())) &amp;&amp;</Highlight></CodeLine>
<Link id="l01451" /><CodeLine lineNumber="1451"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;The computed parent loop should always contain (or be) the parent of &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01452" /><CodeLine lineNumber="1452"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;the original loop.&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01453" /><CodeLine lineNumber="1453"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01454" /><CodeLine lineNumber="1454"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We build the set of blocks dominated by the cloned header from the set of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01455" /><CodeLine lineNumber="1455"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// cloned blocks out of the original loop. While not all of these will</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01456" /><CodeLine lineNumber="1456"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// necessarily be in the cloned loop, it is enough to establish that they</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01457" /><CodeLine lineNumber="1457"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// aren&#39;t in unreachable cycles, etc.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01458" /><CodeLine lineNumber="1458"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallsetvector">SmallSetVector&lt;BasicBlock &#42;, 16&gt;</a> ClonedLoopBlocks;</Highlight></CodeLine>
<Link id="l01459" /><CodeLine lineNumber="1459"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB : OrigL.<a href="/docs/api/classes/llvm/loopbase/#a78bec3084b9a47ee11cc2e56f9004717">blocks</a>())</Highlight></CodeLine>
<Link id="l01460" /><CodeLine lineNumber="1460"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ClonedBB = <a href="/docs/api/namespaces/llvm/#a3e627c32543ca70720c4270a8b11da3f">cast&#95;or&#95;null&lt;BasicBlock&gt;</a>(VMap.<a href="/docs/api/classes/llvm/valuemap/#a15f92579a5fc316dab8cd1fad51015ef">lookup</a>(BB)))</Highlight></CodeLine>
<Link id="l01461" /><CodeLine lineNumber="1461"><Highlight kind="normal">      ClonedLoopBlocks.<a href="/docs/api/classes/llvm/setvector/#af34eb71cc483e84d2eca80575cb9ccde">insert</a>(ClonedBB);</Highlight></CodeLine>
<Link id="l01462" /><CodeLine lineNumber="1462"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01463" /><CodeLine lineNumber="1463"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Rebuild the set of blocks that will end up in the cloned loop. We may have</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01464" /><CodeLine lineNumber="1464"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// skipped cloning some region of this loop which can in turn skip some of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01465" /><CodeLine lineNumber="1465"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the backedges so we have to rebuild the blocks in the loop based on the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01466" /><CodeLine lineNumber="1466"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// backedges that remain after cloning.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01467" /><CodeLine lineNumber="1467"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 16&gt;</a> Worklist;</Highlight></CodeLine>
<Link id="l01468" /><CodeLine lineNumber="1468"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;BasicBlock &#42;, 16&gt;</a> BlocksInClonedLoop;</Highlight></CodeLine>
<Link id="l01469" /><CodeLine lineNumber="1469"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;Pred : <a href="/docs/api/namespaces/llvm/#acb22fb04083152eee862457e42e8dc31">predecessors</a>(ClonedHeader)) &#123;</Highlight></CodeLine>
<Link id="l01470" /><CodeLine lineNumber="1470"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// The only possible non-loop header predecessor is the preheader because</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01471" /><CodeLine lineNumber="1471"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// we know we cloned the loop in simplified form.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01472" /><CodeLine lineNumber="1472"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Pred == ClonedPH)</Highlight></CodeLine>
<Link id="l01473" /><CodeLine lineNumber="1473"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01474" /><CodeLine lineNumber="1474"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01475" /><CodeLine lineNumber="1475"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Because the loop was in simplified form, the only non-loop predecessor</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01476" /><CodeLine lineNumber="1476"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// should be the preheader.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01477" /><CodeLine lineNumber="1477"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(ClonedLoopBlocks.<a href="/docs/api/classes/llvm/setvector/#abb03e3b6c4fd937936a13afe4f60d291">count</a>(Pred) &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Found a predecessor of the loop &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01478" /><CodeLine lineNumber="1478"><Highlight kind="normal">                                           </Highlight><Highlight kind="stringliteral">&quot;header other than the preheader &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01479" /><CodeLine lineNumber="1479"><Highlight kind="normal">                                           </Highlight><Highlight kind="stringliteral">&quot;that is not part of the loop!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01480" /><CodeLine lineNumber="1480"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01481" /><CodeLine lineNumber="1481"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Insert this block into the loop set and on the first visit (and if it</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01482" /><CodeLine lineNumber="1482"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// isn&#39;t the header we&#39;re currently walking) put it into the worklist to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01483" /><CodeLine lineNumber="1483"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// recurse through.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01484" /><CodeLine lineNumber="1484"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BlocksInClonedLoop.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(Pred).second &amp;&amp; Pred != ClonedHeader)</Highlight></CodeLine>
<Link id="l01485" /><CodeLine lineNumber="1485"><Highlight kind="normal">      Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(Pred);</Highlight></CodeLine>
<Link id="l01486" /><CodeLine lineNumber="1486"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01487" /><CodeLine lineNumber="1487"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01488" /><CodeLine lineNumber="1488"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If we had any backedges then there &#42;is&#42; a cloned loop. Put the header into</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01489" /><CodeLine lineNumber="1489"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the loop set and then walk the worklist backwards to find all the blocks</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01490" /><CodeLine lineNumber="1490"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// that remain within the loop after cloning.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01491" /><CodeLine lineNumber="1491"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!BlocksInClonedLoop.<a href="/docs/api/classes/llvm/smallptrsetimplbase/#af8a50544090e81ac83601aff8f4b0142">empty</a>()) &#123;</Highlight></CodeLine>
<Link id="l01492" /><CodeLine lineNumber="1492"><Highlight kind="normal">    BlocksInClonedLoop.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(ClonedHeader);</Highlight></CodeLine>
<Link id="l01493" /><CodeLine lineNumber="1493"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01494" /><CodeLine lineNumber="1494"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (!Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>()) &#123;</Highlight></CodeLine>
<Link id="l01495" /><CodeLine lineNumber="1495"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB = Worklist.<a href="/docs/api/classes/llvm/smallvectorimpl/#a0c8ffe664a36e30d49c84d0aded2fe08">pop&#95;back&#95;val</a>();</Highlight></CodeLine>
<Link id="l01496" /><CodeLine lineNumber="1496"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BlocksInClonedLoop.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(BB) &amp;&amp;</Highlight></CodeLine>
<Link id="l01497" /><CodeLine lineNumber="1497"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;Didn&#39;t put block into the loop set!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01498" /><CodeLine lineNumber="1498"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01499" /><CodeLine lineNumber="1499"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Insert any predecessors that are in the possible set into the cloned</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01500" /><CodeLine lineNumber="1500"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// set, and if the insert is successful, add them to the worklist. Note</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01501" /><CodeLine lineNumber="1501"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// that we filter on the blocks that are definitely reachable via the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01502" /><CodeLine lineNumber="1502"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// backedge to the loop header so we may prune out dead code within the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01503" /><CodeLine lineNumber="1503"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// cloned loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01504" /><CodeLine lineNumber="1504"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;Pred : <a href="/docs/api/namespaces/llvm/#acb22fb04083152eee862457e42e8dc31">predecessors</a>(BB))</Highlight></CodeLine>
<Link id="l01505" /><CodeLine lineNumber="1505"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (ClonedLoopBlocks.<a href="/docs/api/classes/llvm/setvector/#abb03e3b6c4fd937936a13afe4f60d291">count</a>(Pred) &amp;&amp;</Highlight></CodeLine>
<Link id="l01506" /><CodeLine lineNumber="1506"><Highlight kind="normal">            BlocksInClonedLoop.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(Pred).second)</Highlight></CodeLine>
<Link id="l01507" /><CodeLine lineNumber="1507"><Highlight kind="normal">          Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(Pred);</Highlight></CodeLine>
<Link id="l01508" /><CodeLine lineNumber="1508"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01509" /><CodeLine lineNumber="1509"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01510" /><CodeLine lineNumber="1510"><Highlight kind="normal">    ClonedL = LI.<a href="/docs/api/classes/llvm/loopinfobase/#a5a0ae49bf720341774a25029fd23bf59">AllocateLoop</a>();</Highlight></CodeLine>
<Link id="l01511" /><CodeLine lineNumber="1511"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (ParentL) &#123;</Highlight></CodeLine>
<Link id="l01512" /><CodeLine lineNumber="1512"><Highlight kind="normal">      ParentL-&gt;<a href="/docs/api/classes/llvm/loopbase/#a63f099d3bf7cf97eb3ae2d630e3d1afc">addBasicBlockToLoop</a>(ClonedPH, LI);</Highlight></CodeLine>
<Link id="l01513" /><CodeLine lineNumber="1513"><Highlight kind="normal">      ParentL-&gt;<a href="/docs/api/classes/llvm/loopbase/#a990a86b0de7a84a9f489d2034878e330">addChildLoop</a>(ClonedL);</Highlight></CodeLine>
<Link id="l01514" /><CodeLine lineNumber="1514"><Highlight kind="normal">    &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l01515" /><CodeLine lineNumber="1515"><Highlight kind="normal">      LI.<a href="/docs/api/classes/llvm/loopinfobase/#a1e4ac7b073d744d43f3cb1a3660c03c3">addTopLevelLoop</a>(ClonedL);</Highlight></CodeLine>
<Link id="l01516" /><CodeLine lineNumber="1516"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01517" /><CodeLine lineNumber="1517"><Highlight kind="normal">    NonChildClonedLoops.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(ClonedL);</Highlight></CodeLine>
<Link id="l01518" /><CodeLine lineNumber="1518"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01519" /><CodeLine lineNumber="1519"><Highlight kind="normal">    ClonedL-&gt;<a href="/docs/api/classes/llvm/loopbase/#a756142b56356b7a9083d52a88c7bd3af">reserveBlocks</a>(BlocksInClonedLoop.<a href="/docs/api/classes/llvm/smallptrsetimplbase/#a0e1c3175b0ac22fe3853651c28e1ecb8">size</a>());</Highlight></CodeLine>
<Link id="l01520" /><CodeLine lineNumber="1520"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We don&#39;t want to just add the cloned loop blocks based on how we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01521" /><CodeLine lineNumber="1521"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// discovered them. The original order of blocks was carefully built in</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01522" /><CodeLine lineNumber="1522"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// a way that doesn&#39;t rely on predecessor ordering. Rather than re-invent</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01523" /><CodeLine lineNumber="1523"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// that logic, we just re-walk the original blocks (and those of the child</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01524" /><CodeLine lineNumber="1524"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// loops) and filter them as we add them into the cloned loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01525" /><CodeLine lineNumber="1525"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB : OrigL.<a href="/docs/api/classes/llvm/loopbase/#a78bec3084b9a47ee11cc2e56f9004717">blocks</a>()) &#123;</Highlight></CodeLine>
<Link id="l01526" /><CodeLine lineNumber="1526"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ClonedBB = <a href="/docs/api/namespaces/llvm/#a3e627c32543ca70720c4270a8b11da3f">cast&#95;or&#95;null&lt;BasicBlock&gt;</a>(VMap.<a href="/docs/api/classes/llvm/valuemap/#a15f92579a5fc316dab8cd1fad51015ef">lookup</a>(BB));</Highlight></CodeLine>
<Link id="l01527" /><CodeLine lineNumber="1527"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!ClonedBB || !BlocksInClonedLoop.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(ClonedBB))</Highlight></CodeLine>
<Link id="l01528" /><CodeLine lineNumber="1528"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01529" /><CodeLine lineNumber="1529"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01530" /><CodeLine lineNumber="1530"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Directly add the blocks that are only in this loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01531" /><CodeLine lineNumber="1531"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (LI.<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(BB) == &amp;OrigL) &#123;</Highlight></CodeLine>
<Link id="l01532" /><CodeLine lineNumber="1532"><Highlight kind="normal">        ClonedL-&gt;<a href="/docs/api/classes/llvm/loopbase/#a63f099d3bf7cf97eb3ae2d630e3d1afc">addBasicBlockToLoop</a>(ClonedBB, LI);</Highlight></CodeLine>
<Link id="l01533" /><CodeLine lineNumber="1533"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01534" /><CodeLine lineNumber="1534"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l01535" /><CodeLine lineNumber="1535"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01536" /><CodeLine lineNumber="1536"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We want to manually add it to this loop and parents.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01537" /><CodeLine lineNumber="1537"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Registering it with LoopInfo will happen when we clone the top</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01538" /><CodeLine lineNumber="1538"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// loop for this block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01539" /><CodeLine lineNumber="1539"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;PL = ClonedL; PL; PL = PL-&gt;getParentLoop())</Highlight></CodeLine>
<Link id="l01540" /><CodeLine lineNumber="1540"><Highlight kind="normal">        PL-&gt;addBlockEntry(ClonedBB);</Highlight></CodeLine>
<Link id="l01541" /><CodeLine lineNumber="1541"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01542" /><CodeLine lineNumber="1542"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01543" /><CodeLine lineNumber="1543"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Now add each child loop whose header remains within the cloned loop. All</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01544" /><CodeLine lineNumber="1544"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// of the blocks within the loop must satisfy the same constraints as the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01545" /><CodeLine lineNumber="1545"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// header so once we pass the header checks we can just clone the entire</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01546" /><CodeLine lineNumber="1546"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// child loop nest.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01547" /><CodeLine lineNumber="1547"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ChildL : OrigL) &#123;</Highlight></CodeLine>
<Link id="l01548" /><CodeLine lineNumber="1548"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ClonedChildHeader =</Highlight></CodeLine>
<Link id="l01549" /><CodeLine lineNumber="1549"><Highlight kind="normal">          <a href="/docs/api/namespaces/llvm/#a3e627c32543ca70720c4270a8b11da3f">cast&#95;or&#95;null&lt;BasicBlock&gt;</a>(VMap.<a href="/docs/api/classes/llvm/valuemap/#a15f92579a5fc316dab8cd1fad51015ef">lookup</a>(ChildL-&gt;getHeader()));</Highlight></CodeLine>
<Link id="l01550" /><CodeLine lineNumber="1550"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!ClonedChildHeader || !BlocksInClonedLoop.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(ClonedChildHeader))</Highlight></CodeLine>
<Link id="l01551" /><CodeLine lineNumber="1551"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01552" /><CodeLine lineNumber="1552"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01553" /><CodeLine lineNumber="1553"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#ifndef NDEBUG</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01554" /><CodeLine lineNumber="1554"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We should never have a cloned child loop header but fail to have</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01555" /><CodeLine lineNumber="1555"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// all of the blocks for that child loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01556" /><CodeLine lineNumber="1556"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ChildLoopBB : ChildL-&gt;blocks())</Highlight></CodeLine>
<Link id="l01557" /><CodeLine lineNumber="1557"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BlocksInClonedLoop.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(</Highlight></CodeLine>
<Link id="l01558" /><CodeLine lineNumber="1558"><Highlight kind="normal">                   <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(VMap.<a href="/docs/api/classes/llvm/valuemap/#a15f92579a5fc316dab8cd1fad51015ef">lookup</a>(ChildLoopBB))) &amp;&amp;</Highlight></CodeLine>
<Link id="l01559" /><CodeLine lineNumber="1559"><Highlight kind="normal">               </Highlight><Highlight kind="stringliteral">&quot;Child cloned loop has a header within the cloned outer &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01560" /><CodeLine lineNumber="1560"><Highlight kind="normal">               </Highlight><Highlight kind="stringliteral">&quot;loop but not all of its blocks!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01561" /><CodeLine lineNumber="1561"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#endif</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01562" /><CodeLine lineNumber="1562"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01563" /><CodeLine lineNumber="1563"><Highlight kind="normal">      <a href="#af747cc9f106d837a03d08bd395ede216">cloneLoopNest</a>(&#42;ChildL, ClonedL, VMap, LI);</Highlight></CodeLine>
<Link id="l01564" /><CodeLine lineNumber="1564"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01565" /><CodeLine lineNumber="1565"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01566" /><CodeLine lineNumber="1566"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01567" /><CodeLine lineNumber="1567"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now that we&#39;ve handled all the components of the original loop that were</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01568" /><CodeLine lineNumber="1568"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// cloned into a new loop, we still need to handle anything from the original</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01569" /><CodeLine lineNumber="1569"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// loop that wasn&#39;t in a cloned loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01570" /><CodeLine lineNumber="1570"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01571" /><CodeLine lineNumber="1571"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Figure out what blocks are left to place within any loop nest containing</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01572" /><CodeLine lineNumber="1572"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the unswitched loop. If we never formed a loop, the cloned PH is one of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01573" /><CodeLine lineNumber="1573"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// them.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01574" /><CodeLine lineNumber="1574"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;BasicBlock &#42;, 16&gt;</a> UnloopedBlockSet;</Highlight></CodeLine>
<Link id="l01575" /><CodeLine lineNumber="1575"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BlocksInClonedLoop.<a href="/docs/api/classes/llvm/smallptrsetimplbase/#af8a50544090e81ac83601aff8f4b0142">empty</a>())</Highlight></CodeLine>
<Link id="l01576" /><CodeLine lineNumber="1576"><Highlight kind="normal">    UnloopedBlockSet.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(ClonedPH);</Highlight></CodeLine>
<Link id="l01577" /><CodeLine lineNumber="1577"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ClonedBB : ClonedLoopBlocks)</Highlight></CodeLine>
<Link id="l01578" /><CodeLine lineNumber="1578"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!BlocksInClonedLoop.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(ClonedBB))</Highlight></CodeLine>
<Link id="l01579" /><CodeLine lineNumber="1579"><Highlight kind="normal">      UnloopedBlockSet.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(ClonedBB);</Highlight></CodeLine>
<Link id="l01580" /><CodeLine lineNumber="1580"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01581" /><CodeLine lineNumber="1581"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Copy the cloned exits and sort them in ascending loop depth, we&#39;ll work</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01582" /><CodeLine lineNumber="1582"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// backwards across these to process them inside out. The order shouldn&#39;t</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01583" /><CodeLine lineNumber="1583"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// matter as we&#39;re just trying to build up the map from inside-out; we use</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01584" /><CodeLine lineNumber="1584"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the map in a more stably ordered way below.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01585" /><CodeLine lineNumber="1585"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> OrderedClonedExitsInLoops = ClonedExitsInLoops;</Highlight></CodeLine>
<Link id="l01586" /><CodeLine lineNumber="1586"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#a74cdbd1e4f731e7d7cd83461b8b1de0b">llvm::sort</a>(OrderedClonedExitsInLoops, &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>) &#123;</Highlight></CodeLine>
<Link id="l01587" /><CodeLine lineNumber="1587"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> ExitLoopMap.<a href="/docs/api/classes/llvm/densemapbase/#a0b2ca98dc28c61793ff5c90d23e5f14e">lookup</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>)-&gt;getLoopDepth() &lt;</Highlight></CodeLine>
<Link id="l01588" /><CodeLine lineNumber="1588"><Highlight kind="normal">           ExitLoopMap.<a href="/docs/api/classes/llvm/densemapbase/#a0b2ca98dc28c61793ff5c90d23e5f14e">lookup</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>)-&gt;getLoopDepth();</Highlight></CodeLine>
<Link id="l01589" /><CodeLine lineNumber="1589"><Highlight kind="normal">  &#125;);</Highlight></CodeLine>
<Link id="l01590" /><CodeLine lineNumber="1590"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01591" /><CodeLine lineNumber="1591"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Populate the existing ExitLoopMap with everything reachable from each</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01592" /><CodeLine lineNumber="1592"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// exit, starting from the inner most exit.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01593" /><CodeLine lineNumber="1593"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (!UnloopedBlockSet.<a href="/docs/api/classes/llvm/smallptrsetimplbase/#af8a50544090e81ac83601aff8f4b0142">empty</a>() &amp;&amp; !OrderedClonedExitsInLoops.empty()) &#123;</Highlight></CodeLine>
<Link id="l01594" /><CodeLine lineNumber="1594"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Didn&#39;t clear worklist!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01595" /><CodeLine lineNumber="1595"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01596" /><CodeLine lineNumber="1596"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ExitBB = OrderedClonedExitsInLoops.pop&#95;back&#95;val();</Highlight></CodeLine>
<Link id="l01597" /><CodeLine lineNumber="1597"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ExitL = ExitLoopMap.<a href="/docs/api/classes/llvm/densemapbase/#a0b2ca98dc28c61793ff5c90d23e5f14e">lookup</a>(ExitBB);</Highlight></CodeLine>
<Link id="l01598" /><CodeLine lineNumber="1598"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01599" /><CodeLine lineNumber="1599"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Walk the CFG back until we hit the cloned PH adding everything reachable</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01600" /><CodeLine lineNumber="1600"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// and in the unlooped set to this exit block&#39;s loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01601" /><CodeLine lineNumber="1601"><Highlight kind="normal">    Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(ExitBB);</Highlight></CodeLine>
<Link id="l01602" /><CodeLine lineNumber="1602"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">do</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l01603" /><CodeLine lineNumber="1603"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB = Worklist.<a href="/docs/api/classes/llvm/smallvectorimpl/#a0c8ffe664a36e30d49c84d0aded2fe08">pop&#95;back&#95;val</a>();</Highlight></CodeLine>
<Link id="l01604" /><CodeLine lineNumber="1604"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We can stop recursing at the cloned preheader (if we get there).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01605" /><CodeLine lineNumber="1605"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BB == ClonedPH)</Highlight></CodeLine>
<Link id="l01606" /><CodeLine lineNumber="1606"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01607" /><CodeLine lineNumber="1607"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01608" /><CodeLine lineNumber="1608"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;PredBB : <a href="/docs/api/namespaces/llvm/#acb22fb04083152eee862457e42e8dc31">predecessors</a>(BB)) &#123;</Highlight></CodeLine>
<Link id="l01609" /><CodeLine lineNumber="1609"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// If this pred has already been moved to our set or is part of some</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01610" /><CodeLine lineNumber="1610"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// (inner) loop, no update needed.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01611" /><CodeLine lineNumber="1611"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!UnloopedBlockSet.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a11045c7973ab24a8d6315b61fa337d4e">erase</a>(PredBB)) &#123;</Highlight></CodeLine>
<Link id="l01612" /><CodeLine lineNumber="1612"><Highlight kind="normal">          <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(</Highlight></CodeLine>
<Link id="l01613" /><CodeLine lineNumber="1613"><Highlight kind="normal">              (BlocksInClonedLoop.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(PredBB) || ExitLoopMap.<a href="/docs/api/classes/llvm/densemapbase/#a53408c95a7bfb5443b43fb2134c3eb23">count</a>(PredBB)) &amp;&amp;</Highlight></CodeLine>
<Link id="l01614" /><CodeLine lineNumber="1614"><Highlight kind="normal">              </Highlight><Highlight kind="stringliteral">&quot;Predecessor not mapped to a loop!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01615" /><CodeLine lineNumber="1615"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01616" /><CodeLine lineNumber="1616"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l01617" /><CodeLine lineNumber="1617"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01618" /><CodeLine lineNumber="1618"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// We just insert into the loop set here. We&#39;ll add these blocks to the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01619" /><CodeLine lineNumber="1619"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// exit loop after we build up the set in an order that doesn&#39;t rely on</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01620" /><CodeLine lineNumber="1620"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// predecessor order (which in turn relies on use list order).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01621" /><CodeLine lineNumber="1621"><Highlight kind="normal">        </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> Inserted = ExitLoopMap.<a href="/docs/api/classes/llvm/densemapbase/#adb33f3ede2f5bfc9b3ee658aaf648492">insert</a>(&#123;PredBB, ExitL&#125;).second;</Highlight></CodeLine>
<Link id="l01622" /><CodeLine lineNumber="1622"><Highlight kind="normal">        (void)Inserted;</Highlight></CodeLine>
<Link id="l01623" /><CodeLine lineNumber="1623"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Inserted &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Should only visit an unlooped block once!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01624" /><CodeLine lineNumber="1624"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01625" /><CodeLine lineNumber="1625"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// And recurse through to its predecessors.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01626" /><CodeLine lineNumber="1626"><Highlight kind="normal">        Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(PredBB);</Highlight></CodeLine>
<Link id="l01627" /><CodeLine lineNumber="1627"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l01628" /><CodeLine lineNumber="1628"><Highlight kind="normal">    &#125; </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (!Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>());</Highlight></CodeLine>
<Link id="l01629" /><CodeLine lineNumber="1629"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01630" /><CodeLine lineNumber="1630"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01631" /><CodeLine lineNumber="1631"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now that the ExitLoopMap gives as  mapping for all the non-looping cloned</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01632" /><CodeLine lineNumber="1632"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// blocks to their outer loops, walk the cloned blocks and the cloned exits</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01633" /><CodeLine lineNumber="1633"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// in their original order adding them to the correct loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01634" /><CodeLine lineNumber="1634"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01635" /><CodeLine lineNumber="1635"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We need a stable insertion order. We use the order of the original loop</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01636" /><CodeLine lineNumber="1636"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// order and map into the correct parent loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01637" /><CodeLine lineNumber="1637"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB : <a href="/docs/api/namespaces/llvm/#a52ff73f5c87e0fb78fbdca0465300c95">llvm::concat&lt;BasicBlock &#42;const&gt;</a>(</Highlight></CodeLine>
<Link id="l01638" /><CodeLine lineNumber="1638"><Highlight kind="normal">           <a href="/docs/api/namespaces/llvm/#ab9c6b351507d3c0730f4290919d43a12">ArrayRef</a>(ClonedPH), ClonedLoopBlocks, ClonedExitsInLoops))</Highlight></CodeLine>
<Link id="l01639" /><CodeLine lineNumber="1639"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;OuterL = ExitLoopMap.<a href="/docs/api/classes/llvm/densemapbase/#a0b2ca98dc28c61793ff5c90d23e5f14e">lookup</a>(BB))</Highlight></CodeLine>
<Link id="l01640" /><CodeLine lineNumber="1640"><Highlight kind="normal">      OuterL-&gt;addBasicBlockToLoop(BB, LI);</Highlight></CodeLine>
<Link id="l01641" /><CodeLine lineNumber="1641"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01642" /><CodeLine lineNumber="1642"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#ifndef NDEBUG</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01643" /><CodeLine lineNumber="1643"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;BBAndL : ExitLoopMap) &#123;</Highlight></CodeLine>
<Link id="l01644" /><CodeLine lineNumber="1644"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB = BBAndL.first;</Highlight></CodeLine>
<Link id="l01645" /><CodeLine lineNumber="1645"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;OuterL = BBAndL.second;</Highlight></CodeLine>
<Link id="l01646" /><CodeLine lineNumber="1646"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(LI.<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(BB) == OuterL &amp;&amp;</Highlight></CodeLine>
<Link id="l01647" /><CodeLine lineNumber="1647"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;Failed to put all blocks into outer loops!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01648" /><CodeLine lineNumber="1648"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01649" /><CodeLine lineNumber="1649"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#endif</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01650" /><CodeLine lineNumber="1650"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01651" /><CodeLine lineNumber="1651"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now that all the blocks are placed into the correct containing loop in the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01652" /><CodeLine lineNumber="1652"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// absence of child loops, find all the potentially cloned child loops and</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01653" /><CodeLine lineNumber="1653"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// clone them into whatever outer loop we placed their header into.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01654" /><CodeLine lineNumber="1654"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ChildL : OrigL) &#123;</Highlight></CodeLine>
<Link id="l01655" /><CodeLine lineNumber="1655"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ClonedChildHeader =</Highlight></CodeLine>
<Link id="l01656" /><CodeLine lineNumber="1656"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#a3e627c32543ca70720c4270a8b11da3f">cast&#95;or&#95;null&lt;BasicBlock&gt;</a>(VMap.<a href="/docs/api/classes/llvm/valuemap/#a15f92579a5fc316dab8cd1fad51015ef">lookup</a>(ChildL-&gt;getHeader()));</Highlight></CodeLine>
<Link id="l01657" /><CodeLine lineNumber="1657"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!ClonedChildHeader || BlocksInClonedLoop.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(ClonedChildHeader))</Highlight></CodeLine>
<Link id="l01658" /><CodeLine lineNumber="1658"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01659" /><CodeLine lineNumber="1659"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01660" /><CodeLine lineNumber="1660"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#ifndef NDEBUG</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01661" /><CodeLine lineNumber="1661"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ChildLoopBB : ChildL-&gt;blocks())</Highlight></CodeLine>
<Link id="l01662" /><CodeLine lineNumber="1662"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(VMap.<a href="/docs/api/classes/llvm/valuemap/#a3b82484785487f544dc6ef1c2b6a0ffd">count</a>(ChildLoopBB) &amp;&amp;</Highlight></CodeLine>
<Link id="l01663" /><CodeLine lineNumber="1663"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;Cloned a child loop header but not all of that loops blocks!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01664" /><CodeLine lineNumber="1664"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#endif</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01665" /><CodeLine lineNumber="1665"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01666" /><CodeLine lineNumber="1666"><Highlight kind="normal">    NonChildClonedLoops.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(<a href="#af747cc9f106d837a03d08bd395ede216">cloneLoopNest</a>(</Highlight></CodeLine>
<Link id="l01667" /><CodeLine lineNumber="1667"><Highlight kind="normal">        &#42;ChildL, ExitLoopMap.<a href="/docs/api/classes/llvm/densemapbase/#a0b2ca98dc28c61793ff5c90d23e5f14e">lookup</a>(ClonedChildHeader), VMap, LI));</Highlight></CodeLine>
<Link id="l01668" /><CodeLine lineNumber="1668"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01669" /><CodeLine lineNumber="1669"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01670" /><CodeLine lineNumber="1670"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01671" /><CodeLine lineNumber="1671"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01672" /><CodeLine lineNumber="1672" lineLink="#a13971a178ec8248ecf4b0a903c4db1c6"><Highlight kind="normal"><a href="#a13971a178ec8248ecf4b0a903c4db1c6">deleteDeadClonedBlocks</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;BasicBlock &#42;&gt;</a> ExitBlocks,</Highlight></CodeLine>
<Link id="l01673" /><CodeLine lineNumber="1673"><Highlight kind="normal">                       <a href="/docs/api/classes/llvm/arrayref">ArrayRef</a>&lt;std::unique&#95;ptr&lt;ValueToValueMapTy&gt;&gt; VMaps,</Highlight></CodeLine>
<Link id="l01674" /><CodeLine lineNumber="1674"><Highlight kind="normal">                       <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42;MSSAU) &#123;</Highlight></CodeLine>
<Link id="l01675" /><CodeLine lineNumber="1675"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Find all the dead clones, and remove them from their successors.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01676" /><CodeLine lineNumber="1676"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 16&gt;</a> DeadBlocks;</Highlight></CodeLine>
<Link id="l01677" /><CodeLine lineNumber="1677"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB : <a href="/docs/api/namespaces/llvm/#a52ff73f5c87e0fb78fbdca0465300c95">llvm::concat&lt;BasicBlock &#42;const&gt;</a>(L.blocks(), ExitBlocks))</Highlight></CodeLine>
<Link id="l01678" /><CodeLine lineNumber="1678"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;VMap : VMaps)</Highlight></CodeLine>
<Link id="l01679" /><CodeLine lineNumber="1679"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ClonedBB = <a href="/docs/api/namespaces/llvm/#a3e627c32543ca70720c4270a8b11da3f">cast&#95;or&#95;null&lt;BasicBlock&gt;</a>(VMap-&gt;lookup(BB)))</Highlight></CodeLine>
<Link id="l01680" /><CodeLine lineNumber="1680"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!DT.<a href="/docs/api/classes/llvm/dominatortree/#a1a70f2c359aadd76a72aaaede16aca4a">isReachableFromEntry</a>(ClonedBB)) &#123;</Highlight></CodeLine>
<Link id="l01681" /><CodeLine lineNumber="1681"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;SuccBB : <a href="/docs/api/namespaces/llvm/#a26e2a938b431eaa6eca2beaa96410c9d">successors</a>(ClonedBB))</Highlight></CodeLine>
<Link id="l01682" /><CodeLine lineNumber="1682"><Highlight kind="normal">            SuccBB-&gt;removePredecessor(ClonedBB);</Highlight></CodeLine>
<Link id="l01683" /><CodeLine lineNumber="1683"><Highlight kind="normal">          DeadBlocks.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(ClonedBB);</Highlight></CodeLine>
<Link id="l01684" /><CodeLine lineNumber="1684"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l01685" /><CodeLine lineNumber="1685"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01686" /><CodeLine lineNumber="1686"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Remove all MemorySSA in the dead blocks</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01687" /><CodeLine lineNumber="1687"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU) &#123;</Highlight></CodeLine>
<Link id="l01688" /><CodeLine lineNumber="1688"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallsetvector">SmallSetVector&lt;BasicBlock &#42;, 8&gt;</a> DeadBlockSet(DeadBlocks.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a8a045d250952c0867382a9840ee18fdf">begin</a>(),</Highlight></CodeLine>
<Link id="l01689" /><CodeLine lineNumber="1689"><Highlight kind="normal">                                                 DeadBlocks.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a075e34e98605d0e7c289763a104869ac">end</a>());</Highlight></CodeLine>
<Link id="l01690" /><CodeLine lineNumber="1690"><Highlight kind="normal">    MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#aa0c15073f16693ebc44c2410986cacec">removeBlocks</a>(DeadBlockSet);</Highlight></CodeLine>
<Link id="l01691" /><CodeLine lineNumber="1691"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01692" /><CodeLine lineNumber="1692"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01693" /><CodeLine lineNumber="1693"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Drop any remaining references to break cycles.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01694" /><CodeLine lineNumber="1694"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB : DeadBlocks)</Highlight></CodeLine>
<Link id="l01695" /><CodeLine lineNumber="1695"><Highlight kind="normal">    BB-&gt;dropAllReferences();</Highlight></CodeLine>
<Link id="l01696" /><CodeLine lineNumber="1696"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Erase them from the IR.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01697" /><CodeLine lineNumber="1697"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB : DeadBlocks)</Highlight></CodeLine>
<Link id="l01698" /><CodeLine lineNumber="1698"><Highlight kind="normal">    BB-&gt;eraseFromParent();</Highlight></CodeLine>
<Link id="l01699" /><CodeLine lineNumber="1699"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01700" /><CodeLine lineNumber="1700"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01701" /><CodeLine lineNumber="1701" lineLink="#aeabcdff1c388af9ac5a98f1ec4ba2471"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#aeabcdff1c388af9ac5a98f1ec4ba2471">deleteDeadBlocksFromLoop</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L,</Highlight></CodeLine>
<Link id="l01702" /><CodeLine lineNumber="1702"><Highlight kind="normal">                                     <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;BasicBlock &#42;&gt;</a> &amp;ExitBlocks,</Highlight></CodeLine>
<Link id="l01703" /><CodeLine lineNumber="1703"><Highlight kind="normal">                                     <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI,</Highlight></CodeLine>
<Link id="l01704" /><CodeLine lineNumber="1704"><Highlight kind="normal">                                     <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42;MSSAU,</Highlight></CodeLine>
<Link id="l01705" /><CodeLine lineNumber="1705"><Highlight kind="normal">                                     <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42;SE,</Highlight></CodeLine>
<Link id="l01706" /><CodeLine lineNumber="1706"><Highlight kind="normal">                                     <a href="/docs/api/classes/llvm/lpmupdater">LPMUpdater</a> &amp;LoopUpdater) &#123;</Highlight></CodeLine>
<Link id="l01707" /><CodeLine lineNumber="1707"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Find all the dead blocks tied to this loop, and remove them from their</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01708" /><CodeLine lineNumber="1708"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// successors.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01709" /><CodeLine lineNumber="1709"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallsetvector">SmallSetVector&lt;BasicBlock &#42;, 8&gt;</a> DeadBlockSet;</Highlight></CodeLine>
<Link id="l01710" /><CodeLine lineNumber="1710"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01711" /><CodeLine lineNumber="1711"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Start with loop/exit blocks and get a transitive closure of reachable dead</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01712" /><CodeLine lineNumber="1712"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// blocks.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01713" /><CodeLine lineNumber="1713"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 16&gt;</a> DeathCandidates(ExitBlocks.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a8a045d250952c0867382a9840ee18fdf">begin</a>(),</Highlight></CodeLine>
<Link id="l01714" /><CodeLine lineNumber="1714"><Highlight kind="normal">                                                ExitBlocks.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a075e34e98605d0e7c289763a104869ac">end</a>());</Highlight></CodeLine>
<Link id="l01715" /><CodeLine lineNumber="1715"><Highlight kind="normal">  DeathCandidates.<a href="/docs/api/classes/llvm/smallvectorimpl/#a7efd1f0c1206d95e4fe01a9b49a57b82">append</a>(L.blocks().begin(), L.blocks().end());</Highlight></CodeLine>
<Link id="l01716" /><CodeLine lineNumber="1716"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (!DeathCandidates.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>()) &#123;</Highlight></CodeLine>
<Link id="l01717" /><CodeLine lineNumber="1717"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB = DeathCandidates.<a href="/docs/api/classes/llvm/smallvectorimpl/#a0c8ffe664a36e30d49c84d0aded2fe08">pop&#95;back&#95;val</a>();</Highlight></CodeLine>
<Link id="l01718" /><CodeLine lineNumber="1718"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!DeadBlockSet.<a href="/docs/api/classes/llvm/setvector/#abb03e3b6c4fd937936a13afe4f60d291">count</a>(BB) &amp;&amp; !DT.<a href="/docs/api/classes/llvm/dominatortree/#a1a70f2c359aadd76a72aaaede16aca4a">isReachableFromEntry</a>(BB)) &#123;</Highlight></CodeLine>
<Link id="l01719" /><CodeLine lineNumber="1719"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;SuccBB : <a href="/docs/api/namespaces/llvm/#a26e2a938b431eaa6eca2beaa96410c9d">successors</a>(BB)) &#123;</Highlight></CodeLine>
<Link id="l01720" /><CodeLine lineNumber="1720"><Highlight kind="normal">        SuccBB-&gt;removePredecessor(BB);</Highlight></CodeLine>
<Link id="l01721" /><CodeLine lineNumber="1721"><Highlight kind="normal">        DeathCandidates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(SuccBB);</Highlight></CodeLine>
<Link id="l01722" /><CodeLine lineNumber="1722"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l01723" /><CodeLine lineNumber="1723"><Highlight kind="normal">      DeadBlockSet.<a href="/docs/api/classes/llvm/setvector/#af34eb71cc483e84d2eca80575cb9ccde">insert</a>(BB);</Highlight></CodeLine>
<Link id="l01724" /><CodeLine lineNumber="1724"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01725" /><CodeLine lineNumber="1725"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01726" /><CodeLine lineNumber="1726"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01727" /><CodeLine lineNumber="1727"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Remove all MemorySSA in the dead blocks</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01728" /><CodeLine lineNumber="1728"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU)</Highlight></CodeLine>
<Link id="l01729" /><CodeLine lineNumber="1729"><Highlight kind="normal">    MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#aa0c15073f16693ebc44c2410986cacec">removeBlocks</a>(DeadBlockSet);</Highlight></CodeLine>
<Link id="l01730" /><CodeLine lineNumber="1730"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01731" /><CodeLine lineNumber="1731"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Filter out the dead blocks from the exit blocks list so that it can be</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01732" /><CodeLine lineNumber="1732"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// used in the caller.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01733" /><CodeLine lineNumber="1733"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#ac9a7de5a04920954ac964059cfc428ad">llvm::erase&#95;if</a>(ExitBlocks,</Highlight></CodeLine>
<Link id="l01734" /><CodeLine lineNumber="1734"><Highlight kind="normal">                 &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB) &#123; </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> DeadBlockSet.<a href="/docs/api/classes/llvm/setvector/#abb03e3b6c4fd937936a13afe4f60d291">count</a>(BB); &#125;);</Highlight></CodeLine>
<Link id="l01735" /><CodeLine lineNumber="1735"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01736" /><CodeLine lineNumber="1736"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Walk from this loop up through its parents removing all of the dead blocks.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01737" /><CodeLine lineNumber="1737"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ParentL = &amp;L; ParentL; ParentL = ParentL-&gt;getParentLoop()) &#123;</Highlight></CodeLine>
<Link id="l01738" /><CodeLine lineNumber="1738"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB : DeadBlockSet)</Highlight></CodeLine>
<Link id="l01739" /><CodeLine lineNumber="1739"><Highlight kind="normal">      ParentL-&gt;getBlocksSet().erase(BB);</Highlight></CodeLine>
<Link id="l01740" /><CodeLine lineNumber="1740"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#ac9a7de5a04920954ac964059cfc428ad">llvm::erase&#95;if</a>(ParentL-&gt;getBlocksVector(),</Highlight></CodeLine>
<Link id="l01741" /><CodeLine lineNumber="1741"><Highlight kind="normal">                   &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB) &#123; return DeadBlockSet.count(BB); &#125;);</Highlight></CodeLine>
<Link id="l01742" /><CodeLine lineNumber="1742"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01743" /><CodeLine lineNumber="1743"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01744" /><CodeLine lineNumber="1744"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now delete the dead child loops. This raw delete will clear them</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01745" /><CodeLine lineNumber="1745"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// recursively.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01746" /><CodeLine lineNumber="1746"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#ac9a7de5a04920954ac964059cfc428ad">llvm::erase&#95;if</a>(L.getSubLoopsVector(), &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ChildL) &#123;</Highlight></CodeLine>
<Link id="l01747" /><CodeLine lineNumber="1747"><Highlight kind="normal">    if (!DeadBlockSet.count(ChildL-&gt;getHeader()))</Highlight></CodeLine>
<Link id="l01748" /><CodeLine lineNumber="1748"><Highlight kind="normal">      return false;</Highlight></CodeLine>
<Link id="l01749" /><CodeLine lineNumber="1749"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01750" /><CodeLine lineNumber="1750"><Highlight kind="normal">    assert(llvm::all&#95;of(ChildL-&gt;blocks(),</Highlight></CodeLine>
<Link id="l01751" /><CodeLine lineNumber="1751"><Highlight kind="normal">                        &#91;&amp;&#93;(BasicBlock &#42;ChildBB) &#123;</Highlight></CodeLine>
<Link id="l01752" /><CodeLine lineNumber="1752"><Highlight kind="normal">                          return DeadBlockSet.count(ChildBB);</Highlight></CodeLine>
<Link id="l01753" /><CodeLine lineNumber="1753"><Highlight kind="normal">                        &#125;) &amp;&amp;</Highlight></CodeLine>
<Link id="l01754" /><CodeLine lineNumber="1754"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;If the child loop header is dead all blocks in the child loop must &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01755" /><CodeLine lineNumber="1755"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;be dead as well!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01756" /><CodeLine lineNumber="1756"><Highlight kind="normal">    LoopUpdater.<a href="/docs/api/classes/llvm/lpmupdater/#ad898592a9fdc638d33b6b5cf0eba2bbe">markLoopAsDeleted</a>(&#42;ChildL, ChildL-&gt;<a href="/docs/api/classes/llvm/loop/#a917a64b00c1745fd0c78c2b2320cd4ad">getName</a>());</Highlight></CodeLine>
<Link id="l01757" /><CodeLine lineNumber="1757"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SE)</Highlight></CodeLine>
<Link id="l01758" /><CodeLine lineNumber="1758"><Highlight kind="normal">      SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a830ba09d5969cd66878b05c17fdf66b6">forgetBlockAndLoopDispositions</a>();</Highlight></CodeLine>
<Link id="l01759" /><CodeLine lineNumber="1759"><Highlight kind="normal">    LI.<a href="/docs/api/classes/llvm/loopinfobase/#ae98a33be737ade7a1f27130477b003f2">destroy</a>(ChildL);</Highlight></CodeLine>
<Link id="l01760" /><CodeLine lineNumber="1760"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01761" /><CodeLine lineNumber="1761"><Highlight kind="normal">  &#125;);</Highlight></CodeLine>
<Link id="l01762" /><CodeLine lineNumber="1762"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01763" /><CodeLine lineNumber="1763"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Remove the loop mappings for the dead blocks and drop all the references</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01764" /><CodeLine lineNumber="1764"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// from these blocks to others to handle cyclic references as we start</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01765" /><CodeLine lineNumber="1765"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// deleting the blocks themselves.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01766" /><CodeLine lineNumber="1766"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB : DeadBlockSet) &#123;</Highlight></CodeLine>
<Link id="l01767" /><CodeLine lineNumber="1767"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Check that the dominator tree has already been updated.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01768" /><CodeLine lineNumber="1768"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!DT.getNode(BB) &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Should already have cleared domtree!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01769" /><CodeLine lineNumber="1769"><Highlight kind="normal">    LI.changeLoopFor(BB, </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01770" /><CodeLine lineNumber="1770"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Drop all uses of the instructions to make sure we won&#39;t have dangling</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01771" /><CodeLine lineNumber="1771"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// uses in other blocks.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01772" /><CodeLine lineNumber="1772"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : &#42;BB)</Highlight></CodeLine>
<Link id="l01773" /><CodeLine lineNumber="1773"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.use&#95;empty())</Highlight></CodeLine>
<Link id="l01774" /><CodeLine lineNumber="1774"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.replaceAllUsesWith(<a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getType()));</Highlight></CodeLine>
<Link id="l01775" /><CodeLine lineNumber="1775"><Highlight kind="normal">    BB-&gt;dropAllReferences();</Highlight></CodeLine>
<Link id="l01776" /><CodeLine lineNumber="1776"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01777" /><CodeLine lineNumber="1777"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01778" /><CodeLine lineNumber="1778"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Actually delete the blocks now that they&#39;ve been fully unhooked from the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01779" /><CodeLine lineNumber="1779"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// IR.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01780" /><CodeLine lineNumber="1780"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB : DeadBlockSet)</Highlight></CodeLine>
<Link id="l01781" /><CodeLine lineNumber="1781"><Highlight kind="normal">    BB-&gt;eraseFromParent();</Highlight></CodeLine>
<Link id="l01782" /><CodeLine lineNumber="1782"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01783" /><CodeLine lineNumber="1783"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l01784" /><CodeLine lineNumber="1784"><Highlight kind="comment">/// Recompute the set of blocks in a loop after unswitching.</Highlight></CodeLine>
<Link id="l01785" /><CodeLine lineNumber="1785"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01786" /><CodeLine lineNumber="1786"><Highlight kind="comment">/// This walks from the original headers predecessors to rebuild the loop. We</Highlight></CodeLine>
<Link id="l01787" /><CodeLine lineNumber="1787"><Highlight kind="comment">/// take advantage of the fact that new blocks can&#39;t have been added, and so we</Highlight></CodeLine>
<Link id="l01788" /><CodeLine lineNumber="1788"><Highlight kind="comment">/// filter by the original loop&#39;s blocks. This also handles potentially</Highlight></CodeLine>
<Link id="l01789" /><CodeLine lineNumber="1789"><Highlight kind="comment">/// unreachable code that we don&#39;t want to explore but might be found examining</Highlight></CodeLine>
<Link id="l01790" /><CodeLine lineNumber="1790"><Highlight kind="comment">/// the predecessors of the header.</Highlight></CodeLine>
<Link id="l01791" /><CodeLine lineNumber="1791"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01792" /><CodeLine lineNumber="1792"><Highlight kind="comment">/// If the original loop is no longer a loop, this will return an empty set. If</Highlight></CodeLine>
<Link id="l01793" /><CodeLine lineNumber="1793"><Highlight kind="comment">/// it remains a loop, all the blocks within it will be added to the set</Highlight></CodeLine>
<Link id="l01794" /><CodeLine lineNumber="1794"><Highlight kind="comment">/// (including those blocks in inner loops).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01795" /><CodeLine lineNumber="1795" lineLink="#a0c9b0aa6fff67d00a95f47fc121491e5"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;const BasicBlock &#42;, 16&gt;</a> <a href="#a0c9b0aa6fff67d00a95f47fc121491e5">recomputeLoopBlockSet</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L,</Highlight></CodeLine>
<Link id="l01796" /><CodeLine lineNumber="1796"><Highlight kind="normal">                                                                 <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI) &#123;</Highlight></CodeLine>
<Link id="l01797" /><CodeLine lineNumber="1797"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;const BasicBlock &#42;, 16&gt;</a> LoopBlockSet;</Highlight></CodeLine>
<Link id="l01798" /><CodeLine lineNumber="1798"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01799" /><CodeLine lineNumber="1799"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;PH = L.getLoopPreheader();</Highlight></CodeLine>
<Link id="l01800" /><CodeLine lineNumber="1800"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;Header = L.getHeader();</Highlight></CodeLine>
<Link id="l01801" /><CodeLine lineNumber="1801"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01802" /><CodeLine lineNumber="1802"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// A worklist to use while walking backwards from the header.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01803" /><CodeLine lineNumber="1803"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 16&gt;</a> Worklist;</Highlight></CodeLine>
<Link id="l01804" /><CodeLine lineNumber="1804"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01805" /><CodeLine lineNumber="1805"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// First walk the predecessors of the header to find the backedges. This will</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01806" /><CodeLine lineNumber="1806"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// form the basis of our walk.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01807" /><CodeLine lineNumber="1807"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;Pred : <a href="/docs/api/namespaces/llvm/#acb22fb04083152eee862457e42e8dc31">predecessors</a>(Header)) &#123;</Highlight></CodeLine>
<Link id="l01808" /><CodeLine lineNumber="1808"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Skip the preheader.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01809" /><CodeLine lineNumber="1809"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Pred == PH)</Highlight></CodeLine>
<Link id="l01810" /><CodeLine lineNumber="1810"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01811" /><CodeLine lineNumber="1811"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01812" /><CodeLine lineNumber="1812"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Because the loop was in simplified form, the only non-loop predecessor</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01813" /><CodeLine lineNumber="1813"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// is the preheader.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01814" /><CodeLine lineNumber="1814"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(L.contains(Pred) &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Found a predecessor of the loop header other &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01815" /><CodeLine lineNumber="1815"><Highlight kind="normal">                               </Highlight><Highlight kind="stringliteral">&quot;than the preheader that is not part of the &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01816" /><CodeLine lineNumber="1816"><Highlight kind="normal">                               </Highlight><Highlight kind="stringliteral">&quot;loop!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01817" /><CodeLine lineNumber="1817"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01818" /><CodeLine lineNumber="1818"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Insert this block into the loop set and on the first visit and, if it</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01819" /><CodeLine lineNumber="1819"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// isn&#39;t the header we&#39;re currently walking, put it into the worklist to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01820" /><CodeLine lineNumber="1820"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// recurse through.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01821" /><CodeLine lineNumber="1821"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (LoopBlockSet.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(Pred).second &amp;&amp; Pred != Header)</Highlight></CodeLine>
<Link id="l01822" /><CodeLine lineNumber="1822"><Highlight kind="normal">      Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(Pred);</Highlight></CodeLine>
<Link id="l01823" /><CodeLine lineNumber="1823"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01824" /><CodeLine lineNumber="1824"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01825" /><CodeLine lineNumber="1825"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If no backedges were found, we&#39;re done.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01826" /><CodeLine lineNumber="1826"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (LoopBlockSet.<a href="/docs/api/classes/llvm/smallptrsetimplbase/#af8a50544090e81ac83601aff8f4b0142">empty</a>())</Highlight></CodeLine>
<Link id="l01827" /><CodeLine lineNumber="1827"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> LoopBlockSet;</Highlight></CodeLine>
<Link id="l01828" /><CodeLine lineNumber="1828"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01829" /><CodeLine lineNumber="1829"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We found backedges, recurse through them to identify the loop blocks.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01830" /><CodeLine lineNumber="1830"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (!Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>()) &#123;</Highlight></CodeLine>
<Link id="l01831" /><CodeLine lineNumber="1831"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB = Worklist.<a href="/docs/api/classes/llvm/smallvectorimpl/#a0c8ffe664a36e30d49c84d0aded2fe08">pop&#95;back&#95;val</a>();</Highlight></CodeLine>
<Link id="l01832" /><CodeLine lineNumber="1832"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(LoopBlockSet.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(BB) &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Didn&#39;t put block into the loop set!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01833" /><CodeLine lineNumber="1833"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01834" /><CodeLine lineNumber="1834"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// No need to walk past the header.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01835" /><CodeLine lineNumber="1835"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BB == Header)</Highlight></CodeLine>
<Link id="l01836" /><CodeLine lineNumber="1836"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01837" /><CodeLine lineNumber="1837"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01838" /><CodeLine lineNumber="1838"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Because we know the inner loop structure remains valid we can use the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01839" /><CodeLine lineNumber="1839"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// loop structure to jump immediately across the entire nested loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01840" /><CodeLine lineNumber="1840"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Further, because it is in loop simplified form, we can directly jump</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01841" /><CodeLine lineNumber="1841"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// to its preheader afterward.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01842" /><CodeLine lineNumber="1842"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;InnerL = LI.<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(BB))</Highlight></CodeLine>
<Link id="l01843" /><CodeLine lineNumber="1843"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (InnerL != &amp;L) &#123;</Highlight></CodeLine>
<Link id="l01844" /><CodeLine lineNumber="1844"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(L.contains(InnerL) &amp;&amp;</Highlight></CodeLine>
<Link id="l01845" /><CodeLine lineNumber="1845"><Highlight kind="normal">               </Highlight><Highlight kind="stringliteral">&quot;Should not reach a loop &#42;outside&#42; this loop!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01846" /><CodeLine lineNumber="1846"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// The preheader is the only possible predecessor of the loop so</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01847" /><CodeLine lineNumber="1847"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// insert it into the set and check whether it was already handled.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01848" /><CodeLine lineNumber="1848"><Highlight kind="normal">        </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;InnerPH = InnerL-&gt;getLoopPreheader();</Highlight></CodeLine>
<Link id="l01849" /><CodeLine lineNumber="1849"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(L.contains(InnerPH) &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Cannot contain an inner loop block &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01850" /><CodeLine lineNumber="1850"><Highlight kind="normal">                                      </Highlight><Highlight kind="stringliteral">&quot;but not contain the inner loop &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01851" /><CodeLine lineNumber="1851"><Highlight kind="normal">                                      </Highlight><Highlight kind="stringliteral">&quot;preheader!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01852" /><CodeLine lineNumber="1852"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!LoopBlockSet.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(InnerPH).second)</Highlight></CodeLine>
<Link id="l01853" /><CodeLine lineNumber="1853"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// The only way to reach the preheader is through the loop body</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01854" /><CodeLine lineNumber="1854"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// itself so if it has been visited the loop is already handled.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01855" /><CodeLine lineNumber="1855"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01856" /><CodeLine lineNumber="1856"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01857" /><CodeLine lineNumber="1857"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Insert all of the blocks (other than those already present) into</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01858" /><CodeLine lineNumber="1858"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// the loop set. We expect at least the block that led us to find the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01859" /><CodeLine lineNumber="1859"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// inner loop to be in the block set, but we may also have other loop</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01860" /><CodeLine lineNumber="1860"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// blocks if they were already enqueued as predecessors of some other</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01861" /><CodeLine lineNumber="1861"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// outer loop block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01862" /><CodeLine lineNumber="1862"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;InnerBB : InnerL-&gt;blocks()) &#123;</Highlight></CodeLine>
<Link id="l01863" /><CodeLine lineNumber="1863"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (InnerBB == BB) &#123;</Highlight></CodeLine>
<Link id="l01864" /><CodeLine lineNumber="1864"><Highlight kind="normal">            <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(LoopBlockSet.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(InnerBB) &amp;&amp;</Highlight></CodeLine>
<Link id="l01865" /><CodeLine lineNumber="1865"><Highlight kind="normal">                   </Highlight><Highlight kind="stringliteral">&quot;Block should already be in the set!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01866" /><CodeLine lineNumber="1866"><Highlight kind="normal">            </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01867" /><CodeLine lineNumber="1867"><Highlight kind="normal">          &#125;</Highlight></CodeLine>
<Link id="l01868" /><CodeLine lineNumber="1868"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01869" /><CodeLine lineNumber="1869"><Highlight kind="normal">          LoopBlockSet.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(InnerBB);</Highlight></CodeLine>
<Link id="l01870" /><CodeLine lineNumber="1870"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l01871" /><CodeLine lineNumber="1871"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01872" /><CodeLine lineNumber="1872"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Add the preheader to the worklist so we will continue past the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01873" /><CodeLine lineNumber="1873"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// loop body.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01874" /><CodeLine lineNumber="1874"><Highlight kind="normal">        Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(InnerPH);</Highlight></CodeLine>
<Link id="l01875" /><CodeLine lineNumber="1875"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01876" /><CodeLine lineNumber="1876"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l01877" /><CodeLine lineNumber="1877"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01878" /><CodeLine lineNumber="1878"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Insert any predecessors that were in the original loop into the new</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01879" /><CodeLine lineNumber="1879"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// set, and if the insert is successful, add them to the worklist.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01880" /><CodeLine lineNumber="1880"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;Pred : <a href="/docs/api/namespaces/llvm/#acb22fb04083152eee862457e42e8dc31">predecessors</a>(BB))</Highlight></CodeLine>
<Link id="l01881" /><CodeLine lineNumber="1881"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L.contains(Pred) &amp;&amp; LoopBlockSet.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(Pred).second)</Highlight></CodeLine>
<Link id="l01882" /><CodeLine lineNumber="1882"><Highlight kind="normal">        Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(Pred);</Highlight></CodeLine>
<Link id="l01883" /><CodeLine lineNumber="1883"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01884" /><CodeLine lineNumber="1884"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01885" /><CodeLine lineNumber="1885"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(LoopBlockSet.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(Header) &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Cannot fail to add the header!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01886" /><CodeLine lineNumber="1886"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01887" /><CodeLine lineNumber="1887"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We&#39;ve found all the blocks participating in the loop, return our completed</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01888" /><CodeLine lineNumber="1888"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// set.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01889" /><CodeLine lineNumber="1889"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> LoopBlockSet;</Highlight></CodeLine>
<Link id="l01890" /><CodeLine lineNumber="1890"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01891" /><CodeLine lineNumber="1891"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l01892" /><CodeLine lineNumber="1892"><Highlight kind="comment">/// Rebuild a loop after unswitching removes some subset of blocks and edges.</Highlight></CodeLine>
<Link id="l01893" /><CodeLine lineNumber="1893"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01894" /><CodeLine lineNumber="1894"><Highlight kind="comment">/// The removal may have removed some child loops entirely but cannot have</Highlight></CodeLine>
<Link id="l01895" /><CodeLine lineNumber="1895"><Highlight kind="comment">/// disturbed any remaining child loops. However, they may need to be hoisted</Highlight></CodeLine>
<Link id="l01896" /><CodeLine lineNumber="1896"><Highlight kind="comment">/// to the parent loop (or to be top-level loops). The original loop may be</Highlight></CodeLine>
<Link id="l01897" /><CodeLine lineNumber="1897"><Highlight kind="comment">/// completely removed.</Highlight></CodeLine>
<Link id="l01898" /><CodeLine lineNumber="1898"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01899" /><CodeLine lineNumber="1899"><Highlight kind="comment">/// The sibling loops resulting from this update are returned. If the original</Highlight></CodeLine>
<Link id="l01900" /><CodeLine lineNumber="1900"><Highlight kind="comment">/// loop remains a valid loop, it will be the first entry in this list with all</Highlight></CodeLine>
<Link id="l01901" /><CodeLine lineNumber="1901"><Highlight kind="comment">/// of the newly sibling loops following it.</Highlight></CodeLine>
<Link id="l01902" /><CodeLine lineNumber="1902"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01903" /><CodeLine lineNumber="1903"><Highlight kind="comment">/// Returns true if the loop remains a loop after unswitching, and false if it</Highlight></CodeLine>
<Link id="l01904" /><CodeLine lineNumber="1904"><Highlight kind="comment">/// is no longer a loop after unswitching (and should not continue to be</Highlight></CodeLine>
<Link id="l01905" /><CodeLine lineNumber="1905"><Highlight kind="comment">/// referenced).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01906" /><CodeLine lineNumber="1906" lineLink="#ab79f3dcf9607c6a8908cda57cc964f49"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#ab79f3dcf9607c6a8908cda57cc964f49">rebuildLoopAfterUnswitch</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;BasicBlock &#42;&gt;</a> ExitBlocks,</Highlight></CodeLine>
<Link id="l01907" /><CodeLine lineNumber="1907"><Highlight kind="normal">                                     <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI,</Highlight></CodeLine>
<Link id="l01908" /><CodeLine lineNumber="1908"><Highlight kind="normal">                                     <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;Loop &#42;&gt;</a> &amp;HoistedLoops,</Highlight></CodeLine>
<Link id="l01909" /><CodeLine lineNumber="1909"><Highlight kind="normal">                                     <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42;SE) &#123;</Highlight></CodeLine>
<Link id="l01910" /><CodeLine lineNumber="1910"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;PH = L.getLoopPreheader();</Highlight></CodeLine>
<Link id="l01911" /><CodeLine lineNumber="1911"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01912" /><CodeLine lineNumber="1912"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Compute the actual parent loop from the exit blocks. Because we may have</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01913" /><CodeLine lineNumber="1913"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// pruned some exits the loop may be different from the original parent.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01914" /><CodeLine lineNumber="1914"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ParentL = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01915" /><CodeLine lineNumber="1915"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Loop &#42;, 4&gt;</a> ExitLoops;</Highlight></CodeLine>
<Link id="l01916" /><CodeLine lineNumber="1916"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 4&gt;</a> ExitsInLoops;</Highlight></CodeLine>
<Link id="l01917" /><CodeLine lineNumber="1917"><Highlight kind="normal">  ExitsInLoops.<a href="/docs/api/classes/llvm/smallvectorimpl/#a499ea32ca1b8d16cedfe01d1e5b08f29">reserve</a>(ExitBlocks.<a href="/docs/api/classes/llvm/arrayref/#a85ffb6531d4cda988ea81f18d4e56fb7">size</a>());</Highlight></CodeLine>
<Link id="l01918" /><CodeLine lineNumber="1918"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ExitBB : ExitBlocks)</Highlight></CodeLine>
<Link id="l01919" /><CodeLine lineNumber="1919"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ExitL = LI.<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(ExitBB)) &#123;</Highlight></CodeLine>
<Link id="l01920" /><CodeLine lineNumber="1920"><Highlight kind="normal">      ExitLoops.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(ExitL);</Highlight></CodeLine>
<Link id="l01921" /><CodeLine lineNumber="1921"><Highlight kind="normal">      ExitsInLoops.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(ExitBB);</Highlight></CodeLine>
<Link id="l01922" /><CodeLine lineNumber="1922"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!ParentL || (ParentL != ExitL &amp;&amp; ParentL-&gt;<a href="/docs/api/classes/llvm/loopbase/#a04337b572d34ea413c35dbac5d75530b">contains</a>(ExitL)))</Highlight></CodeLine>
<Link id="l01923" /><CodeLine lineNumber="1923"><Highlight kind="normal">        ParentL = ExitL;</Highlight></CodeLine>
<Link id="l01924" /><CodeLine lineNumber="1924"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01925" /><CodeLine lineNumber="1925"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01926" /><CodeLine lineNumber="1926"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Recompute the blocks participating in this loop. This may be empty if it</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01927" /><CodeLine lineNumber="1927"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// is no longer a loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01928" /><CodeLine lineNumber="1928"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> LoopBlockSet = <a href="#a0c9b0aa6fff67d00a95f47fc121491e5">recomputeLoopBlockSet</a>(L, LI);</Highlight></CodeLine>
<Link id="l01929" /><CodeLine lineNumber="1929"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01930" /><CodeLine lineNumber="1930"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If we still have a loop, we need to re-set the loop&#39;s parent as the exit</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01931" /><CodeLine lineNumber="1931"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// block set changing may have moved it within the loop nest. Note that this</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01932" /><CodeLine lineNumber="1932"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// can only happen when this loop has a parent as it can only hoist the loop</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01933" /><CodeLine lineNumber="1933"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// &#42;up&#42; the nest.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01934" /><CodeLine lineNumber="1934"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!LoopBlockSet.empty() &amp;&amp; L.getParentLoop() != ParentL) &#123;</Highlight></CodeLine>
<Link id="l01935" /><CodeLine lineNumber="1935"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Remove this loop&#39;s (original) blocks from all of the intervening loops.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01936" /><CodeLine lineNumber="1936"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;IL = L.getParentLoop(); IL != ParentL;</Highlight></CodeLine>
<Link id="l01937" /><CodeLine lineNumber="1937"><Highlight kind="normal">         IL = IL-&gt;<a href="/docs/api/classes/llvm/loopbase/#ae34bcd53f75fab0c03b509ecccb4cfaf">getParentLoop</a>()) &#123;</Highlight></CodeLine>
<Link id="l01938" /><CodeLine lineNumber="1938"><Highlight kind="normal">      IL-&gt;getBlocksSet().erase(PH);</Highlight></CodeLine>
<Link id="l01939" /><CodeLine lineNumber="1939"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB : L.blocks())</Highlight></CodeLine>
<Link id="l01940" /><CodeLine lineNumber="1940"><Highlight kind="normal">        IL-&gt;getBlocksSet().erase(BB);</Highlight></CodeLine>
<Link id="l01941" /><CodeLine lineNumber="1941"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#ac9a7de5a04920954ac964059cfc428ad">llvm::erase&#95;if</a>(IL-&gt;getBlocksVector(), &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB) &#123;</Highlight></CodeLine>
<Link id="l01942" /><CodeLine lineNumber="1942"><Highlight kind="normal">        return BB == PH || L.contains(BB);</Highlight></CodeLine>
<Link id="l01943" /><CodeLine lineNumber="1943"><Highlight kind="normal">      &#125;);</Highlight></CodeLine>
<Link id="l01944" /><CodeLine lineNumber="1944"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01945" /><CodeLine lineNumber="1945"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01946" /><CodeLine lineNumber="1946"><Highlight kind="normal">    LI.<a href="/docs/api/classes/llvm/loopinfobase/#a97de9fb6fdce68e4e31300fcf0e5a20c">changeLoopFor</a>(PH, ParentL);</Highlight></CodeLine>
<Link id="l01947" /><CodeLine lineNumber="1947"><Highlight kind="normal">    L.getParentLoop()-&gt;removeChildLoop(&amp;L);</Highlight></CodeLine>
<Link id="l01948" /><CodeLine lineNumber="1948"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (ParentL)</Highlight></CodeLine>
<Link id="l01949" /><CodeLine lineNumber="1949"><Highlight kind="normal">      ParentL-&gt;<a href="/docs/api/classes/llvm/loopbase/#a990a86b0de7a84a9f489d2034878e330">addChildLoop</a>(&amp;L);</Highlight></CodeLine>
<Link id="l01950" /><CodeLine lineNumber="1950"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01951" /><CodeLine lineNumber="1951"><Highlight kind="normal">      LI.<a href="/docs/api/classes/llvm/loopinfobase/#a1e4ac7b073d744d43f3cb1a3660c03c3">addTopLevelLoop</a>(&amp;L);</Highlight></CodeLine>
<Link id="l01952" /><CodeLine lineNumber="1952"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01953" /><CodeLine lineNumber="1953"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01954" /><CodeLine lineNumber="1954"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now we update all the blocks which are no longer within the loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01955" /><CodeLine lineNumber="1955"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;Blocks = L.getBlocksVector();</Highlight></CodeLine>
<Link id="l01956" /><CodeLine lineNumber="1956"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> BlocksSplitI =</Highlight></CodeLine>
<Link id="l01957" /><CodeLine lineNumber="1957"><Highlight kind="normal">      LoopBlockSet.empty()</Highlight></CodeLine>
<Link id="l01958" /><CodeLine lineNumber="1958"><Highlight kind="normal">          ? Blocks.begin()</Highlight></CodeLine>
<Link id="l01959" /><CodeLine lineNumber="1959"><Highlight kind="normal">          : std::stable&#95;partition(</Highlight></CodeLine>
<Link id="l01960" /><CodeLine lineNumber="1960"><Highlight kind="normal">                Blocks.begin(), Blocks.end(),</Highlight></CodeLine>
<Link id="l01961" /><CodeLine lineNumber="1961"><Highlight kind="normal">                &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB) &#123; return LoopBlockSet.count(BB); &#125;);</Highlight></CodeLine>
<Link id="l01962" /><CodeLine lineNumber="1962"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01963" /><CodeLine lineNumber="1963"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Before we erase the list of unlooped blocks, build a set of them.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01964" /><CodeLine lineNumber="1964"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;BasicBlock &#42;, 16&gt;</a> UnloopedBlocks(BlocksSplitI, Blocks.end());</Highlight></CodeLine>
<Link id="l01965" /><CodeLine lineNumber="1965"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (LoopBlockSet.empty())</Highlight></CodeLine>
<Link id="l01966" /><CodeLine lineNumber="1966"><Highlight kind="normal">    UnloopedBlocks.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(PH);</Highlight></CodeLine>
<Link id="l01967" /><CodeLine lineNumber="1967"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01968" /><CodeLine lineNumber="1968"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now erase these blocks from the loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01969" /><CodeLine lineNumber="1969"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB : <a href="/docs/api/namespaces/llvm/#a341215803e83773a3e97860dc291f121">make&#95;range</a>(BlocksSplitI, Blocks.end()))</Highlight></CodeLine>
<Link id="l01970" /><CodeLine lineNumber="1970"><Highlight kind="normal">    L.getBlocksSet().erase(BB);</Highlight></CodeLine>
<Link id="l01971" /><CodeLine lineNumber="1971"><Highlight kind="normal">  Blocks.erase(BlocksSplitI, Blocks.end());</Highlight></CodeLine>
<Link id="l01972" /><CodeLine lineNumber="1972"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01973" /><CodeLine lineNumber="1973"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Sort the exits in ascending loop depth, we&#39;ll work backwards across these</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01974" /><CodeLine lineNumber="1974"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// to process them inside out.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01975" /><CodeLine lineNumber="1975"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#a076f93c387f454f0db13d4bc7d4e7f9c">llvm::stable&#95;sort</a>(ExitsInLoops, &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>) &#123;</Highlight></CodeLine>
<Link id="l01976" /><CodeLine lineNumber="1976"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> LI.<a href="/docs/api/classes/llvm/loopinfobase/#aa4defa64d17f14bd55204cac1b3a0c3a">getLoopDepth</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>) &lt; LI.<a href="/docs/api/classes/llvm/loopinfobase/#aa4defa64d17f14bd55204cac1b3a0c3a">getLoopDepth</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>);</Highlight></CodeLine>
<Link id="l01977" /><CodeLine lineNumber="1977"><Highlight kind="normal">  &#125;);</Highlight></CodeLine>
<Link id="l01978" /><CodeLine lineNumber="1978"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01979" /><CodeLine lineNumber="1979"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We&#39;ll build up a set for each exit loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01980" /><CodeLine lineNumber="1980"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;BasicBlock &#42;, 16&gt;</a> NewExitLoopBlocks;</Highlight></CodeLine>
<Link id="l01981" /><CodeLine lineNumber="1981"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;PrevExitL = L.getParentLoop(); </Highlight><Highlight kind="comment">// The deepest possible exit loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01982" /><CodeLine lineNumber="1982"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01983" /><CodeLine lineNumber="1983"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> RemoveUnloopedBlocksFromLoop =</Highlight></CodeLine>
<Link id="l01984" /><CodeLine lineNumber="1984"><Highlight kind="normal">      &#91;&#93;(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, <a href="/docs/api/classes/llvm/smallptrsetimpl">SmallPtrSetImpl&lt;BasicBlock &#42;&gt;</a> &amp;UnloopedBlocks) &#123;</Highlight></CodeLine>
<Link id="l01985" /><CodeLine lineNumber="1985"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB : UnloopedBlocks)</Highlight></CodeLine>
<Link id="l01986" /><CodeLine lineNumber="1986"><Highlight kind="normal">          L.getBlocksSet().erase(BB);</Highlight></CodeLine>
<Link id="l01987" /><CodeLine lineNumber="1987"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#ac9a7de5a04920954ac964059cfc428ad">llvm::erase&#95;if</a>(L.getBlocksVector(), &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB) &#123;</Highlight></CodeLine>
<Link id="l01988" /><CodeLine lineNumber="1988"><Highlight kind="normal">          return UnloopedBlocks.count(BB);</Highlight></CodeLine>
<Link id="l01989" /><CodeLine lineNumber="1989"><Highlight kind="normal">        &#125;);</Highlight></CodeLine>
<Link id="l01990" /><CodeLine lineNumber="1990"><Highlight kind="normal">      &#125;;</Highlight></CodeLine>
<Link id="l01991" /><CodeLine lineNumber="1991"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01992" /><CodeLine lineNumber="1992"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 16&gt;</a> Worklist;</Highlight></CodeLine>
<Link id="l01993" /><CodeLine lineNumber="1993"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (!UnloopedBlocks.<a href="/docs/api/classes/llvm/smallptrsetimplbase/#af8a50544090e81ac83601aff8f4b0142">empty</a>() &amp;&amp; !ExitsInLoops.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>()) &#123;</Highlight></CodeLine>
<Link id="l01994" /><CodeLine lineNumber="1994"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Didn&#39;t clear worklist!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01995" /><CodeLine lineNumber="1995"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(NewExitLoopBlocks.empty() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Didn&#39;t clear loop set!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01996" /><CodeLine lineNumber="1996"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01997" /><CodeLine lineNumber="1997"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Grab the next exit block, in decreasing loop depth order.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01998" /><CodeLine lineNumber="1998"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ExitBB = ExitsInLoops.<a href="/docs/api/classes/llvm/smallvectorimpl/#a0c8ffe664a36e30d49c84d0aded2fe08">pop&#95;back&#95;val</a>();</Highlight></CodeLine>
<Link id="l01999" /><CodeLine lineNumber="1999"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;ExitL = &#42;LI.<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(ExitBB);</Highlight></CodeLine>
<Link id="l02000" /><CodeLine lineNumber="2000"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(ExitL.<a href="/docs/api/classes/llvm/loopbase/#a04337b572d34ea413c35dbac5d75530b">contains</a>(&amp;L) &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Exit loop must contain the inner loop!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02001" /><CodeLine lineNumber="2001"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02002" /><CodeLine lineNumber="2002"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Erase all of the unlooped blocks from the loops between the previous</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02003" /><CodeLine lineNumber="2003"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// exit loop and this exit loop. This works because the ExitInLoops list is</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02004" /><CodeLine lineNumber="2004"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// sorted in increasing order of loop depth and thus we visit loops in</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02005" /><CodeLine lineNumber="2005"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// decreasing order of loop depth.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02006" /><CodeLine lineNumber="2006"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (; PrevExitL != &amp;ExitL; PrevExitL = PrevExitL-&gt;<a href="/docs/api/classes/llvm/loopbase/#ae34bcd53f75fab0c03b509ecccb4cfaf">getParentLoop</a>())</Highlight></CodeLine>
<Link id="l02007" /><CodeLine lineNumber="2007"><Highlight kind="normal">      RemoveUnloopedBlocksFromLoop(&#42;PrevExitL, UnloopedBlocks);</Highlight></CodeLine>
<Link id="l02008" /><CodeLine lineNumber="2008"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02009" /><CodeLine lineNumber="2009"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Walk the CFG back until we hit the cloned PH adding everything reachable</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02010" /><CodeLine lineNumber="2010"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// and in the unlooped set to this exit block&#39;s loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02011" /><CodeLine lineNumber="2011"><Highlight kind="normal">    Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(ExitBB);</Highlight></CodeLine>
<Link id="l02012" /><CodeLine lineNumber="2012"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">do</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l02013" /><CodeLine lineNumber="2013"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB = Worklist.<a href="/docs/api/classes/llvm/smallvectorimpl/#a0c8ffe664a36e30d49c84d0aded2fe08">pop&#95;back&#95;val</a>();</Highlight></CodeLine>
<Link id="l02014" /><CodeLine lineNumber="2014"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We can stop recursing at the cloned preheader (if we get there).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02015" /><CodeLine lineNumber="2015"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BB == PH)</Highlight></CodeLine>
<Link id="l02016" /><CodeLine lineNumber="2016"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02017" /><CodeLine lineNumber="2017"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02018" /><CodeLine lineNumber="2018"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;PredBB : <a href="/docs/api/namespaces/llvm/#acb22fb04083152eee862457e42e8dc31">predecessors</a>(BB)) &#123;</Highlight></CodeLine>
<Link id="l02019" /><CodeLine lineNumber="2019"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// If this pred has already been moved to our set or is part of some</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02020" /><CodeLine lineNumber="2020"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// (inner) loop, no update needed.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02021" /><CodeLine lineNumber="2021"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!UnloopedBlocks.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a11045c7973ab24a8d6315b61fa337d4e">erase</a>(PredBB)) &#123;</Highlight></CodeLine>
<Link id="l02022" /><CodeLine lineNumber="2022"><Highlight kind="normal">          <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((NewExitLoopBlocks.count(PredBB) ||</Highlight></CodeLine>
<Link id="l02023" /><CodeLine lineNumber="2023"><Highlight kind="normal">                  ExitL.<a href="/docs/api/classes/llvm/loopbase/#a04337b572d34ea413c35dbac5d75530b">contains</a>(LI.<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(PredBB))) &amp;&amp;</Highlight></CodeLine>
<Link id="l02024" /><CodeLine lineNumber="2024"><Highlight kind="normal">                 </Highlight><Highlight kind="stringliteral">&quot;Predecessor not in a nested loop (or already visited)!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02025" /><CodeLine lineNumber="2025"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02026" /><CodeLine lineNumber="2026"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l02027" /><CodeLine lineNumber="2027"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02028" /><CodeLine lineNumber="2028"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// We just insert into the loop set here. We&#39;ll add these blocks to the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02029" /><CodeLine lineNumber="2029"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// exit loop after we build up the set in a deterministic order rather</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02030" /><CodeLine lineNumber="2030"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// than the predecessor-influenced visit order.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02031" /><CodeLine lineNumber="2031"><Highlight kind="normal">        </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> Inserted = NewExitLoopBlocks.insert(PredBB).second;</Highlight></CodeLine>
<Link id="l02032" /><CodeLine lineNumber="2032"><Highlight kind="normal">        (void)Inserted;</Highlight></CodeLine>
<Link id="l02033" /><CodeLine lineNumber="2033"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Inserted &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Should only visit an unlooped block once!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02034" /><CodeLine lineNumber="2034"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02035" /><CodeLine lineNumber="2035"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// And recurse through to its predecessors.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02036" /><CodeLine lineNumber="2036"><Highlight kind="normal">        Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(PredBB);</Highlight></CodeLine>
<Link id="l02037" /><CodeLine lineNumber="2037"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l02038" /><CodeLine lineNumber="2038"><Highlight kind="normal">    &#125; </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (!Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>());</Highlight></CodeLine>
<Link id="l02039" /><CodeLine lineNumber="2039"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02040" /><CodeLine lineNumber="2040"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If blocks in this exit loop were directly part of the original loop (as</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02041" /><CodeLine lineNumber="2041"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// opposed to a child loop) update the map to point to this exit loop. This</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02042" /><CodeLine lineNumber="2042"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// just updates a map and so the fact that the order is unstable is fine.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02043" /><CodeLine lineNumber="2043"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB : NewExitLoopBlocks)</Highlight></CodeLine>
<Link id="l02044" /><CodeLine lineNumber="2044"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;BBL = LI.<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(BB))</Highlight></CodeLine>
<Link id="l02045" /><CodeLine lineNumber="2045"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BBL == &amp;L || !L.contains(BBL))</Highlight></CodeLine>
<Link id="l02046" /><CodeLine lineNumber="2046"><Highlight kind="normal">          LI.<a href="/docs/api/classes/llvm/loopinfobase/#a97de9fb6fdce68e4e31300fcf0e5a20c">changeLoopFor</a>(BB, &amp;ExitL);</Highlight></CodeLine>
<Link id="l02047" /><CodeLine lineNumber="2047"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02048" /><CodeLine lineNumber="2048"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We will remove the remaining unlooped blocks from this loop in the next</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02049" /><CodeLine lineNumber="2049"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// iteration or below.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02050" /><CodeLine lineNumber="2050"><Highlight kind="normal">    NewExitLoopBlocks.clear();</Highlight></CodeLine>
<Link id="l02051" /><CodeLine lineNumber="2051"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02052" /><CodeLine lineNumber="2052"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02053" /><CodeLine lineNumber="2053"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Any remaining unlooped blocks are no longer part of any loop unless they</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02054" /><CodeLine lineNumber="2054"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// are part of some child loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02055" /><CodeLine lineNumber="2055"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (; PrevExitL; PrevExitL = PrevExitL-&gt;<a href="/docs/api/classes/llvm/loopbase/#ae34bcd53f75fab0c03b509ecccb4cfaf">getParentLoop</a>())</Highlight></CodeLine>
<Link id="l02056" /><CodeLine lineNumber="2056"><Highlight kind="normal">    RemoveUnloopedBlocksFromLoop(&#42;PrevExitL, UnloopedBlocks);</Highlight></CodeLine>
<Link id="l02057" /><CodeLine lineNumber="2057"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB : UnloopedBlocks)</Highlight></CodeLine>
<Link id="l02058" /><CodeLine lineNumber="2058"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;BBL = LI.<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(BB))</Highlight></CodeLine>
<Link id="l02059" /><CodeLine lineNumber="2059"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BBL == &amp;L || !L.contains(BBL))</Highlight></CodeLine>
<Link id="l02060" /><CodeLine lineNumber="2060"><Highlight kind="normal">        LI.<a href="/docs/api/classes/llvm/loopinfobase/#a97de9fb6fdce68e4e31300fcf0e5a20c">changeLoopFor</a>(BB, </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02061" /><CodeLine lineNumber="2061"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02062" /><CodeLine lineNumber="2062"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Sink all the child loops whose headers are no longer in the loop set to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02063" /><CodeLine lineNumber="2063"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the parent (or to be top level loops). We reach into the loop and directly</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02064" /><CodeLine lineNumber="2064"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// update its subloop vector to make this batch update efficient.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02065" /><CodeLine lineNumber="2065"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;SubLoops = L.getSubLoopsVector();</Highlight></CodeLine>
<Link id="l02066" /><CodeLine lineNumber="2066"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> SubLoopsSplitI =</Highlight></CodeLine>
<Link id="l02067" /><CodeLine lineNumber="2067"><Highlight kind="normal">      LoopBlockSet.empty()</Highlight></CodeLine>
<Link id="l02068" /><CodeLine lineNumber="2068"><Highlight kind="normal">          ? SubLoops.begin()</Highlight></CodeLine>
<Link id="l02069" /><CodeLine lineNumber="2069"><Highlight kind="normal">          : std::stable&#95;partition(</Highlight></CodeLine>
<Link id="l02070" /><CodeLine lineNumber="2070"><Highlight kind="normal">                SubLoops.begin(), SubLoops.end(), &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;SubL) &#123;</Highlight></CodeLine>
<Link id="l02071" /><CodeLine lineNumber="2071"><Highlight kind="normal">                  return LoopBlockSet.count(SubL-&gt;getHeader());</Highlight></CodeLine>
<Link id="l02072" /><CodeLine lineNumber="2072"><Highlight kind="normal">                &#125;);</Highlight></CodeLine>
<Link id="l02073" /><CodeLine lineNumber="2073"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;HoistedL : <a href="/docs/api/namespaces/llvm/#a341215803e83773a3e97860dc291f121">make&#95;range</a>(SubLoopsSplitI, SubLoops.end())) &#123;</Highlight></CodeLine>
<Link id="l02074" /><CodeLine lineNumber="2074"><Highlight kind="normal">    HoistedLoops.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(HoistedL);</Highlight></CodeLine>
<Link id="l02075" /><CodeLine lineNumber="2075"><Highlight kind="normal">    HoistedL-&gt;setParentLoop(</Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02076" /><CodeLine lineNumber="2076"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02077" /><CodeLine lineNumber="2077"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// To compute the new parent of this hoisted loop we look at where we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02078" /><CodeLine lineNumber="2078"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// placed the preheader above. We can&#39;t lookup the header itself because we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02079" /><CodeLine lineNumber="2079"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// retained the mapping from the header to the hoisted loop. But the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02080" /><CodeLine lineNumber="2080"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// preheader and header should have the exact same new parent computed</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02081" /><CodeLine lineNumber="2081"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// based on the set of exit blocks from the original loop as the preheader</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02082" /><CodeLine lineNumber="2082"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// is a predecessor of the header and so reached in the reverse walk. And</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02083" /><CodeLine lineNumber="2083"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// because the loops were all in simplified form the preheader of the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02084" /><CodeLine lineNumber="2084"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// hoisted loop can&#39;t be part of some &#42;other&#42; loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02085" /><CodeLine lineNumber="2085"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;NewParentL = LI.<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(HoistedL-&gt;getLoopPreheader()))</Highlight></CodeLine>
<Link id="l02086" /><CodeLine lineNumber="2086"><Highlight kind="normal">      NewParentL-&gt;addChildLoop(HoistedL);</Highlight></CodeLine>
<Link id="l02087" /><CodeLine lineNumber="2087"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02088" /><CodeLine lineNumber="2088"><Highlight kind="normal">      LI.<a href="/docs/api/classes/llvm/loopinfobase/#a1e4ac7b073d744d43f3cb1a3660c03c3">addTopLevelLoop</a>(HoistedL);</Highlight></CodeLine>
<Link id="l02089" /><CodeLine lineNumber="2089"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02090" /><CodeLine lineNumber="2090"><Highlight kind="normal">  SubLoops.erase(SubLoopsSplitI, SubLoops.end());</Highlight></CodeLine>
<Link id="l02091" /><CodeLine lineNumber="2091"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02092" /><CodeLine lineNumber="2092"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Actually delete the loop if nothing remained within it.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02093" /><CodeLine lineNumber="2093"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Blocks.empty()) &#123;</Highlight></CodeLine>
<Link id="l02094" /><CodeLine lineNumber="2094"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(SubLoops.empty() &amp;&amp;</Highlight></CodeLine>
<Link id="l02095" /><CodeLine lineNumber="2095"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;Failed to remove all subloops from the original loop!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02096" /><CodeLine lineNumber="2096"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ParentL = L.getParentLoop())</Highlight></CodeLine>
<Link id="l02097" /><CodeLine lineNumber="2097"><Highlight kind="normal">      ParentL-&gt;<a href="/docs/api/classes/llvm/loopbase/#afd824d78def66604189ab07c6266572d">removeChildLoop</a>(<a href="/docs/api/namespaces/llvm/#a086e9fbdb06276db7753101a08a63adf">llvm::find</a>(&#42;ParentL, &amp;L));</Highlight></CodeLine>
<Link id="l02098" /><CodeLine lineNumber="2098"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02099" /><CodeLine lineNumber="2099"><Highlight kind="normal">      LI.<a href="/docs/api/classes/llvm/loopinfobase/#a7bfb10fc99484961d5fac51621793aa6">removeLoop</a>(<a href="/docs/api/namespaces/llvm/#a086e9fbdb06276db7753101a08a63adf">llvm::find</a>(LI, &amp;L));</Highlight></CodeLine>
<Link id="l02100" /><CodeLine lineNumber="2100"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// markLoopAsDeleted for L should be triggered by the caller (it is</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02101" /><CodeLine lineNumber="2101"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// typically done within postUnswitch).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02102" /><CodeLine lineNumber="2102"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SE)</Highlight></CodeLine>
<Link id="l02103" /><CodeLine lineNumber="2103"><Highlight kind="normal">      SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a830ba09d5969cd66878b05c17fdf66b6">forgetBlockAndLoopDispositions</a>();</Highlight></CodeLine>
<Link id="l02104" /><CodeLine lineNumber="2104"><Highlight kind="normal">    LI.<a href="/docs/api/classes/llvm/loopinfobase/#ae98a33be737ade7a1f27130477b003f2">destroy</a>(&amp;L);</Highlight></CodeLine>
<Link id="l02105" /><CodeLine lineNumber="2105"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02106" /><CodeLine lineNumber="2106"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02107" /><CodeLine lineNumber="2107"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02108" /><CodeLine lineNumber="2108"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02109" /><CodeLine lineNumber="2109"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l02110" /><CodeLine lineNumber="2110"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l02111" /><CodeLine lineNumber="2111"><Highlight kind="comment">/// Helper to visit a dominator subtree, invoking a callable on each node.</Highlight></CodeLine>
<Link id="l02112" /><CodeLine lineNumber="2112"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02113" /><CodeLine lineNumber="2113"><Highlight kind="comment">/// Returning false at any point will stop walking past that node of the tree.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02114" /><CodeLine lineNumber="2114"><Highlight kind="normal"></Highlight><Highlight kind="keyword">template</Highlight><Highlight kind="normal"> &lt;</Highlight><Highlight kind="keyword">typename</Highlight><Highlight kind="normal"> CallableT&gt;</Highlight></CodeLine>
<Link id="l02115" /><CodeLine lineNumber="2115" lineLink="#a18b0f192065386f9e0bc793a08bbf3ff"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#a18b0f192065386f9e0bc793a08bbf3ff">visitDomSubTree</a>(<a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB, CallableT Callable) &#123;</Highlight></CodeLine>
<Link id="l02116" /><CodeLine lineNumber="2116"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;DomTreeNode &#42;, 4&gt;</a> DomWorklist;</Highlight></CodeLine>
<Link id="l02117" /><CodeLine lineNumber="2117"><Highlight kind="normal">  DomWorklist.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(DT&#91;BB&#93;);</Highlight></CodeLine>
<Link id="l02118" /><CodeLine lineNumber="2118"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#ifndef NDEBUG</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02119" /><CodeLine lineNumber="2119"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;DomTreeNode &#42;, 4&gt;</a> Visited;</Highlight></CodeLine>
<Link id="l02120" /><CodeLine lineNumber="2120"><Highlight kind="normal">  Visited.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(DT&#91;BB&#93;);</Highlight></CodeLine>
<Link id="l02121" /><CodeLine lineNumber="2121"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#endif</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02122" /><CodeLine lineNumber="2122"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">do</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l02123" /><CodeLine lineNumber="2123"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a58b9df85470fc4e2a8066ff6a62e5a34">DomTreeNode</a> &#42;<a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a> = DomWorklist.<a href="/docs/api/classes/llvm/smallvectorimpl/#a0c8ffe664a36e30d49c84d0aded2fe08">pop&#95;back&#95;val</a>();</Highlight></CodeLine>
<Link id="l02124" /><CodeLine lineNumber="2124"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02125" /><CodeLine lineNumber="2125"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Visit this node.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02126" /><CodeLine lineNumber="2126"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!Callable(<a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>-&gt;getBlock()))</Highlight></CodeLine>
<Link id="l02127" /><CodeLine lineNumber="2127"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02128" /><CodeLine lineNumber="2128"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02129" /><CodeLine lineNumber="2129"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Accumulate the child nodes.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02130" /><CodeLine lineNumber="2130"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a58b9df85470fc4e2a8066ff6a62e5a34">DomTreeNode</a> &#42;ChildN : &#42;<a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>) &#123;</Highlight></CodeLine>
<Link id="l02131" /><CodeLine lineNumber="2131"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Visited.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(ChildN).second &amp;&amp;</Highlight></CodeLine>
<Link id="l02132" /><CodeLine lineNumber="2132"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;Cannot visit a node twice when walking a tree!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02133" /><CodeLine lineNumber="2133"><Highlight kind="normal">      DomWorklist.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(ChildN);</Highlight></CodeLine>
<Link id="l02134" /><CodeLine lineNumber="2134"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l02135" /><CodeLine lineNumber="2135"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (!DomWorklist.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>());</Highlight></CodeLine>
<Link id="l02136" /><CodeLine lineNumber="2136"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l02137" /><CodeLine lineNumber="2137"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02138" /><CodeLine lineNumber="2138" lineLink="#a45007554e260296266b8ae927dde223f"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#a45007554e260296266b8ae927dde223f">postUnswitch</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, <a href="/docs/api/classes/llvm/lpmupdater">LPMUpdater</a> &amp;U, <a href="/docs/api/classes/llvm/stringref">StringRef</a> LoopName,</Highlight></CodeLine>
<Link id="l02139" /><CodeLine lineNumber="2139"><Highlight kind="normal">                  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> CurrentLoopValid, </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> PartiallyInvariant,</Highlight></CodeLine>
<Link id="l02140" /><CodeLine lineNumber="2140"><Highlight kind="normal">                  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> InjectedCondition, <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;Loop &#42;&gt;</a> NewLoops) &#123;</Highlight></CodeLine>
<Link id="l02141" /><CodeLine lineNumber="2141"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If we did a non-trivial unswitch, we have added new (cloned) loops.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02142" /><CodeLine lineNumber="2142"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!NewLoops.<a href="/docs/api/classes/llvm/arrayref/#ac835b8735b1b2faec0efdca236e37d94">empty</a>())</Highlight></CodeLine>
<Link id="l02143" /><CodeLine lineNumber="2143"><Highlight kind="normal">    U.addSiblingLoops(NewLoops);</Highlight></CodeLine>
<Link id="l02144" /><CodeLine lineNumber="2144"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02145" /><CodeLine lineNumber="2145"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If the current loop remains valid, we should revisit it to catch any</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02146" /><CodeLine lineNumber="2146"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// other unswitch opportunities. Otherwise, we need to mark it as deleted.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02147" /><CodeLine lineNumber="2147"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (CurrentLoopValid) &#123;</Highlight></CodeLine>
<Link id="l02148" /><CodeLine lineNumber="2148"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (PartiallyInvariant) &#123;</Highlight></CodeLine>
<Link id="l02149" /><CodeLine lineNumber="2149"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Mark the new loop as partially unswitched, to avoid unswitching on</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02150" /><CodeLine lineNumber="2150"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// the same condition again.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02151" /><CodeLine lineNumber="2151"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;Context = L.getHeader()-&gt;getContext();</Highlight></CodeLine>
<Link id="l02152" /><CodeLine lineNumber="2152"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42;DisableUnswitchMD = <a href="/docs/api/classes/llvm/mdnode/#a7d10a7b9b7f40b04d27ed97c38ea1950">MDNode::get</a>(</Highlight></CodeLine>
<Link id="l02153" /><CodeLine lineNumber="2153"><Highlight kind="normal">          Context,</Highlight></CodeLine>
<Link id="l02154" /><CodeLine lineNumber="2154"><Highlight kind="normal">          <a href="/docs/api/classes/llvm/mdstring/#affbb7e2e9ad8d18114816f2443d672b9">MDString::get</a>(Context, </Highlight><Highlight kind="stringliteral">&quot;llvm.loop.unswitch.partial.disable&quot;</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l02155" /><CodeLine lineNumber="2155"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42;NewLoopID = <a href="/docs/api/namespaces/llvm/#ac8a1ae2e1de53a840bee516d1f5bb173">makePostTransformationMetadata</a>(</Highlight></CodeLine>
<Link id="l02156" /><CodeLine lineNumber="2156"><Highlight kind="normal">          Context, L.getLoopID(), &#123;</Highlight><Highlight kind="stringliteral">&quot;llvm.loop.unswitch.partial&quot;</Highlight><Highlight kind="normal">&#125;,</Highlight></CodeLine>
<Link id="l02157" /><CodeLine lineNumber="2157"><Highlight kind="normal">          &#123;DisableUnswitchMD&#125;);</Highlight></CodeLine>
<Link id="l02158" /><CodeLine lineNumber="2158"><Highlight kind="normal">      L.setLoopID(NewLoopID);</Highlight></CodeLine>
<Link id="l02159" /><CodeLine lineNumber="2159"><Highlight kind="normal">    &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (InjectedCondition) &#123;</Highlight></CodeLine>
<Link id="l02160" /><CodeLine lineNumber="2160"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Do the same for injection of invariant conditions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02161" /><CodeLine lineNumber="2161"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;Context = L.getHeader()-&gt;getContext();</Highlight></CodeLine>
<Link id="l02162" /><CodeLine lineNumber="2162"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42;DisableUnswitchMD = <a href="/docs/api/classes/llvm/mdnode/#a7d10a7b9b7f40b04d27ed97c38ea1950">MDNode::get</a>(</Highlight></CodeLine>
<Link id="l02163" /><CodeLine lineNumber="2163"><Highlight kind="normal">          Context,</Highlight></CodeLine>
<Link id="l02164" /><CodeLine lineNumber="2164"><Highlight kind="normal">          <a href="/docs/api/classes/llvm/mdstring/#affbb7e2e9ad8d18114816f2443d672b9">MDString::get</a>(Context, </Highlight><Highlight kind="stringliteral">&quot;llvm.loop.unswitch.injection.disable&quot;</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l02165" /><CodeLine lineNumber="2165"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42;NewLoopID = <a href="/docs/api/namespaces/llvm/#ac8a1ae2e1de53a840bee516d1f5bb173">makePostTransformationMetadata</a>(</Highlight></CodeLine>
<Link id="l02166" /><CodeLine lineNumber="2166"><Highlight kind="normal">          Context, L.getLoopID(), &#123;</Highlight><Highlight kind="stringliteral">&quot;llvm.loop.unswitch.injection&quot;</Highlight><Highlight kind="normal">&#125;,</Highlight></CodeLine>
<Link id="l02167" /><CodeLine lineNumber="2167"><Highlight kind="normal">          &#123;DisableUnswitchMD&#125;);</Highlight></CodeLine>
<Link id="l02168" /><CodeLine lineNumber="2168"><Highlight kind="normal">      L.setLoopID(NewLoopID);</Highlight></CodeLine>
<Link id="l02169" /><CodeLine lineNumber="2169"><Highlight kind="normal">    &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02170" /><CodeLine lineNumber="2170"><Highlight kind="normal">      U.revisitCurrentLoop();</Highlight></CodeLine>
<Link id="l02171" /><CodeLine lineNumber="2171"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02172" /><CodeLine lineNumber="2172"><Highlight kind="normal">    U.markLoopAsDeleted(L, LoopName);</Highlight></CodeLine>
<Link id="l02173" /><CodeLine lineNumber="2173"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l02174" /><CodeLine lineNumber="2174"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02175" /><CodeLine lineNumber="2175" lineLink="#aae4261fb86bc9023c3383785afa66b9a"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#aae4261fb86bc9023c3383785afa66b9a">unswitchNontrivialInvariants</a>(</Highlight></CodeLine>
<Link id="l02176" /><CodeLine lineNumber="2176"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;TI, <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;Value &#42;&gt;</a> Invariants,</Highlight></CodeLine>
<Link id="l02177" /><CodeLine lineNumber="2177"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/ivconditioninfo">IVConditionInfo</a> &amp;PartialIVInfo, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI,</Highlight></CodeLine>
<Link id="l02178" /><CodeLine lineNumber="2178"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &amp;AC, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42;SE, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42;MSSAU,</Highlight></CodeLine>
<Link id="l02179" /><CodeLine lineNumber="2179"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/lpmupdater">LPMUpdater</a> &amp;LoopUpdater, </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> InsertFreeze, </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> InjectedCondition) &#123;</Highlight></CodeLine>
<Link id="l02180" /><CodeLine lineNumber="2180"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ParentBB = TI.<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>();</Highlight></CodeLine>
<Link id="l02181" /><CodeLine lineNumber="2181"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;BI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BranchInst&gt;</a>(&amp;TI);</Highlight></CodeLine>
<Link id="l02182" /><CodeLine lineNumber="2182"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/switchinst">SwitchInst</a> &#42;<a href="/docs/api/namespaces/llvm/si">SI</a> = BI ? nullptr : <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;SwitchInst&gt;</a>(&amp;TI);</Highlight></CodeLine>
<Link id="l02183" /><CodeLine lineNumber="2183"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02184" /><CodeLine lineNumber="2184"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Save the current loop name in a variable so that we can report it even</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02185" /><CodeLine lineNumber="2185"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// after it has been deleted.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02186" /><CodeLine lineNumber="2186"><Highlight kind="normal">  std::string LoopName(L.getName());</Highlight></CodeLine>
<Link id="l02187" /><CodeLine lineNumber="2187"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02188" /><CodeLine lineNumber="2188"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We can only unswitch switches, conditional branches with an invariant</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02189" /><CodeLine lineNumber="2189"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// condition, or combining invariant conditions with an instruction or</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02190" /><CodeLine lineNumber="2190"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// partially invariant instructions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02191" /><CodeLine lineNumber="2191"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((<a href="/docs/api/namespaces/llvm/si">SI</a> || (BI &amp;&amp; BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#a7e4be8b16fbd68c9045a388904044e01">isConditional</a>())) &amp;&amp;</Highlight></CodeLine>
<Link id="l02192" /><CodeLine lineNumber="2192"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;Can only unswitch switches and conditional branch!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02193" /><CodeLine lineNumber="2193"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> PartiallyInvariant = !PartialIVInfo.<a href="/docs/api/structs/llvm/ivconditioninfo/#a753ed4570ed0ac6d4f264c22b69a8add">InstToDuplicate</a>.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>();</Highlight></CodeLine>
<Link id="l02194" /><CodeLine lineNumber="2194"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> FullUnswitch =</Highlight></CodeLine>
<Link id="l02195" /><CodeLine lineNumber="2195"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/si">SI</a> || (<a href="#a5ca2e820d1b5a49dcaad5e6873917198">skipTrivialSelect</a>(BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aebd4af5642453ce3169094f08dd3d7b8">getCondition</a>()) == Invariants&#91;0&#93; &amp;&amp;</Highlight></CodeLine>
<Link id="l02196" /><CodeLine lineNumber="2196"><Highlight kind="normal">             !PartiallyInvariant);</Highlight></CodeLine>
<Link id="l02197" /><CodeLine lineNumber="2197"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (FullUnswitch)</Highlight></CodeLine>
<Link id="l02198" /><CodeLine lineNumber="2198"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Invariants.<a href="/docs/api/classes/llvm/arrayref/#a85ffb6531d4cda988ea81f18d4e56fb7">size</a>() == 1 &amp;&amp;</Highlight></CodeLine>
<Link id="l02199" /><CodeLine lineNumber="2199"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;Cannot have other invariants with full unswitching!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02200" /><CodeLine lineNumber="2200"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02201" /><CodeLine lineNumber="2201"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;Instruction&gt;</a>(<a href="#a5ca2e820d1b5a49dcaad5e6873917198">skipTrivialSelect</a>(BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aebd4af5642453ce3169094f08dd3d7b8">getCondition</a>())) &amp;&amp;</Highlight></CodeLine>
<Link id="l02202" /><CodeLine lineNumber="2202"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;Partial unswitching requires an instruction as the condition!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02203" /><CodeLine lineNumber="2203"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02204" /><CodeLine lineNumber="2204"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU &amp;&amp; <a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l02205" /><CodeLine lineNumber="2205"><Highlight kind="normal">    MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a01a350909e784d6fa43181a72de61529">getMemorySSA</a>()-&gt;<a href="/docs/api/classes/llvm/memoryssa/#a88b10d37f671e58cf138ac84a8257c17">verifyMemorySSA</a>();</Highlight></CodeLine>
<Link id="l02206" /><CodeLine lineNumber="2206"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02207" /><CodeLine lineNumber="2207"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Constant and BBs tracking the cloned and continuing successor. When we are</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02208" /><CodeLine lineNumber="2208"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// unswitching the entire condition, this can just be trivially chosen to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02209" /><CodeLine lineNumber="2209"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// unswitch towards &#96;true&#96;. However, when we are unswitching a set of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02210" /><CodeLine lineNumber="2210"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// invariants combined with &#96;and&#96; or &#96;or&#96; or partially invariant instructions,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02211" /><CodeLine lineNumber="2211"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the combining operation determines the best direction to unswitch: we want</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02212" /><CodeLine lineNumber="2212"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// to unswitch the direction that will collapse the branch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02213" /><CodeLine lineNumber="2213"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="/docs/api/files/lib/lib/analysis/loopinfo-cpp/#ab4c7e3039b29b12e4dc97bcae93d79c3">Direction</a> = </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02214" /><CodeLine lineNumber="2214"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> ClonedSucc = 0;</Highlight></CodeLine>
<Link id="l02215" /><CodeLine lineNumber="2215"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!FullUnswitch) &#123;</Highlight></CodeLine>
<Link id="l02216" /><CodeLine lineNumber="2216"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a> = <a href="#a5ca2e820d1b5a49dcaad5e6873917198">skipTrivialSelect</a>(BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aebd4af5642453ce3169094f08dd3d7b8">getCondition</a>());</Highlight></CodeLine>
<Link id="l02217" /><CodeLine lineNumber="2217"><Highlight kind="normal">    (void)<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>;</Highlight></CodeLine>
<Link id="l02218" /><CodeLine lineNumber="2218"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(((<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, <a href="/docs/api/namespaces/llvm/patternmatch/#acf8c16eed89e5ee1a10b6dfc08a33b3a">m&#95;LogicalAnd</a>()) ^ <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, <a href="/docs/api/namespaces/llvm/patternmatch/#a5cce7a41c7581ff15a23ab90eb3b403a">m&#95;LogicalOr</a>())) ||</Highlight></CodeLine>
<Link id="l02219" /><CodeLine lineNumber="2219"><Highlight kind="normal">            PartiallyInvariant) &amp;&amp;</Highlight></CodeLine>
<Link id="l02220" /><CodeLine lineNumber="2220"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;Only &#96;or&#96;, &#96;and&#96;, an &#96;select&#96;, partially invariant instructions &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02221" /><CodeLine lineNumber="2221"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;can combine invariants being unswitched.&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02222" /><CodeLine lineNumber="2222"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, <a href="/docs/api/namespaces/llvm/patternmatch/#a5cce7a41c7581ff15a23ab90eb3b403a">m&#95;LogicalOr</a>())) &#123;</Highlight></CodeLine>
<Link id="l02223" /><CodeLine lineNumber="2223"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, <a href="/docs/api/namespaces/llvm/patternmatch/#acf8c16eed89e5ee1a10b6dfc08a33b3a">m&#95;LogicalAnd</a>()) ||</Highlight></CodeLine>
<Link id="l02224" /><CodeLine lineNumber="2224"><Highlight kind="normal">          (PartiallyInvariant &amp;&amp; !PartialIVInfo.<a href="/docs/api/structs/llvm/ivconditioninfo/#a8115811b4523cb1c13e1e32c5dc3bb3d">KnownValue</a>-&gt;<a href="/docs/api/classes/llvm/constant/#a586fb7954fcb7d759a997b3e1e979d30">isOneValue</a>())) &#123;</Highlight></CodeLine>
<Link id="l02225" /><CodeLine lineNumber="2225"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/analysis/loopinfo-cpp/#ab4c7e3039b29b12e4dc97bcae93d79c3">Direction</a> = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02226" /><CodeLine lineNumber="2226"><Highlight kind="normal">        ClonedSucc = 1;</Highlight></CodeLine>
<Link id="l02227" /><CodeLine lineNumber="2227"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l02228" /><CodeLine lineNumber="2228"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l02229" /><CodeLine lineNumber="2229"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02230" /><CodeLine lineNumber="2230"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02231" /><CodeLine lineNumber="2231"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;RetainedSuccBB =</Highlight></CodeLine>
<Link id="l02232" /><CodeLine lineNumber="2232"><Highlight kind="normal">      BI ? BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(1 - ClonedSucc) : <a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getDefaultDest();</Highlight></CodeLine>
<Link id="l02233" /><CodeLine lineNumber="2233"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallsetvector">SmallSetVector&lt;BasicBlock &#42;, 4&gt;</a> UnswitchedSuccBBs;</Highlight></CodeLine>
<Link id="l02234" /><CodeLine lineNumber="2234"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BI)</Highlight></CodeLine>
<Link id="l02235" /><CodeLine lineNumber="2235"><Highlight kind="normal">    UnswitchedSuccBBs.<a href="/docs/api/classes/llvm/setvector/#af34eb71cc483e84d2eca80575cb9ccde">insert</a>(BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(ClonedSucc));</Highlight></CodeLine>
<Link id="l02236" /><CodeLine lineNumber="2236"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02237" /><CodeLine lineNumber="2237"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> Case : <a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;cases())</Highlight></CodeLine>
<Link id="l02238" /><CodeLine lineNumber="2238"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Case.getCaseSuccessor() != RetainedSuccBB)</Highlight></CodeLine>
<Link id="l02239" /><CodeLine lineNumber="2239"><Highlight kind="normal">        UnswitchedSuccBBs.<a href="/docs/api/classes/llvm/setvector/#af34eb71cc483e84d2eca80575cb9ccde">insert</a>(Case.getCaseSuccessor());</Highlight></CodeLine>
<Link id="l02240" /><CodeLine lineNumber="2240"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02241" /><CodeLine lineNumber="2241"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!UnswitchedSuccBBs.<a href="/docs/api/classes/llvm/setvector/#abb03e3b6c4fd937936a13afe4f60d291">count</a>(RetainedSuccBB) &amp;&amp;</Highlight></CodeLine>
<Link id="l02242" /><CodeLine lineNumber="2242"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;Should not unswitch the same successor we are retaining!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02243" /><CodeLine lineNumber="2243"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02244" /><CodeLine lineNumber="2244"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The branch should be in this exact loop. Any inner loop&#39;s invariant branch</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02245" /><CodeLine lineNumber="2245"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// should be handled by unswitching that inner loop. The caller of this</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02246" /><CodeLine lineNumber="2246"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// routine should filter out any candidates that remain (but were skipped for</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02247" /><CodeLine lineNumber="2247"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// whatever reason).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02248" /><CodeLine lineNumber="2248"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(LI.<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(ParentBB) == &amp;L &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Branch in an inner loop!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02249" /><CodeLine lineNumber="2249"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02250" /><CodeLine lineNumber="2250"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Compute the parent loop now before we start hacking on things.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02251" /><CodeLine lineNumber="2251"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ParentL = L.getParentLoop();</Highlight></CodeLine>
<Link id="l02252" /><CodeLine lineNumber="2252"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Get blocks in RPO order for MSSA update, before changing the CFG.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02253" /><CodeLine lineNumber="2253"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loopblocksrpo">LoopBlocksRPO</a> LBRPO(&amp;L);</Highlight></CodeLine>
<Link id="l02254" /><CodeLine lineNumber="2254"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU)</Highlight></CodeLine>
<Link id="l02255" /><CodeLine lineNumber="2255"><Highlight kind="normal">    LBRPO.<a href="/docs/api/classes/llvm/loopblocksrpo/#aeab06fd248333b13725e55754883b570">perform</a>(&amp;LI);</Highlight></CodeLine>
<Link id="l02256" /><CodeLine lineNumber="2256"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02257" /><CodeLine lineNumber="2257"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Compute the outer-most loop containing one of our exit blocks. This is the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02258" /><CodeLine lineNumber="2258"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// furthest up our loopnest which can be mutated, which we will use below to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02259" /><CodeLine lineNumber="2259"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// update things.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02260" /><CodeLine lineNumber="2260"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;OuterExitL = &amp;L;</Highlight></CodeLine>
<Link id="l02261" /><CodeLine lineNumber="2261"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 4&gt;</a> ExitBlocks;</Highlight></CodeLine>
<Link id="l02262" /><CodeLine lineNumber="2262"><Highlight kind="normal">  L.getUniqueExitBlocks(ExitBlocks);</Highlight></CodeLine>
<Link id="l02263" /><CodeLine lineNumber="2263"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ExitBB : ExitBlocks) &#123;</Highlight></CodeLine>
<Link id="l02264" /><CodeLine lineNumber="2264"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// ExitBB can be an exit block for several levels in the loop nest. Make</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02265" /><CodeLine lineNumber="2265"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// sure we find the top most.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02266" /><CodeLine lineNumber="2266"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;NewOuterExitL = <a href="#a5e771bd40bbd3121ec36a96aa44ef46a">getTopMostExitingLoop</a>(ExitBB, LI);</Highlight></CodeLine>
<Link id="l02267" /><CodeLine lineNumber="2267"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!NewOuterExitL) &#123;</Highlight></CodeLine>
<Link id="l02268" /><CodeLine lineNumber="2268"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We exited the entire nest with this block, so we&#39;re done.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02269" /><CodeLine lineNumber="2269"><Highlight kind="normal">      OuterExitL = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02270" /><CodeLine lineNumber="2270"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">break</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02271" /><CodeLine lineNumber="2271"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l02272" /><CodeLine lineNumber="2272"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (NewOuterExitL != OuterExitL &amp;&amp; NewOuterExitL-&gt;<a href="/docs/api/classes/llvm/loopbase/#a04337b572d34ea413c35dbac5d75530b">contains</a>(OuterExitL))</Highlight></CodeLine>
<Link id="l02273" /><CodeLine lineNumber="2273"><Highlight kind="normal">      OuterExitL = NewOuterExitL;</Highlight></CodeLine>
<Link id="l02274" /><CodeLine lineNumber="2274"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02275" /><CodeLine lineNumber="2275"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02276" /><CodeLine lineNumber="2276"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// At this point, we&#39;re definitely going to unswitch something so invalidate</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02277" /><CodeLine lineNumber="2277"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// any cached information in ScalarEvolution for the outer most loop</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02278" /><CodeLine lineNumber="2278"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// containing an exit block and all nested loops.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02279" /><CodeLine lineNumber="2279"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SE) &#123;</Highlight></CodeLine>
<Link id="l02280" /><CodeLine lineNumber="2280"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (OuterExitL)</Highlight></CodeLine>
<Link id="l02281" /><CodeLine lineNumber="2281"><Highlight kind="normal">      SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a592bdd7731b14ff4ff5d646f6f399900">forgetLoop</a>(OuterExitL);</Highlight></CodeLine>
<Link id="l02282" /><CodeLine lineNumber="2282"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02283" /><CodeLine lineNumber="2283"><Highlight kind="normal">      SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a7d5bfa1ac3c7c096af6b26fb95cd699d">forgetTopmostLoop</a>(&amp;L);</Highlight></CodeLine>
<Link id="l02284" /><CodeLine lineNumber="2284"><Highlight kind="normal">    SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a830ba09d5969cd66878b05c17fdf66b6">forgetBlockAndLoopDispositions</a>();</Highlight></CodeLine>
<Link id="l02285" /><CodeLine lineNumber="2285"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02286" /><CodeLine lineNumber="2286"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02287" /><CodeLine lineNumber="2287"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If the edge from this terminator to a successor dominates that successor,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02288" /><CodeLine lineNumber="2288"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// store a map from each block in its dominator subtree to it. This lets us</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02289" /><CodeLine lineNumber="2289"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// tell when cloning for a particular successor if a block is dominated by</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02290" /><CodeLine lineNumber="2290"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// some &#42;other&#42; successor with a single data structure. We use this to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02291" /><CodeLine lineNumber="2291"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// significantly reduce cloning.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02292" /><CodeLine lineNumber="2292"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;BasicBlock &#42;, BasicBlock &#42;, 16&gt;</a> DominatingSucc;</Highlight></CodeLine>
<Link id="l02293" /><CodeLine lineNumber="2293"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;SuccBB : <a href="/docs/api/namespaces/llvm/#a52ff73f5c87e0fb78fbdca0465300c95">llvm::concat&lt;BasicBlock &#42;const&gt;</a>(<a href="/docs/api/namespaces/llvm/#ab9c6b351507d3c0730f4290919d43a12">ArrayRef</a>(RetainedSuccBB),</Highlight></CodeLine>
<Link id="l02294" /><CodeLine lineNumber="2294"><Highlight kind="normal">                                                      UnswitchedSuccBBs))</Highlight></CodeLine>
<Link id="l02295" /><CodeLine lineNumber="2295"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SuccBB-&gt;getUniquePredecessor() ||</Highlight></CodeLine>
<Link id="l02296" /><CodeLine lineNumber="2296"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#a0d10fe510ced2849a8074fe81e5d04ce">llvm::all&#95;of</a>(<a href="/docs/api/namespaces/llvm/#acb22fb04083152eee862457e42e8dc31">predecessors</a>(SuccBB), &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;PredBB) &#123;</Highlight></CodeLine>
<Link id="l02297" /><CodeLine lineNumber="2297"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> PredBB == ParentBB || DT.<a href="/docs/api/classes/llvm/dominatortree/#a5c69311e8d44898dac36a155c3d8691d">dominates</a>(SuccBB, PredBB);</Highlight></CodeLine>
<Link id="l02298" /><CodeLine lineNumber="2298"><Highlight kind="normal">        &#125;))</Highlight></CodeLine>
<Link id="l02299" /><CodeLine lineNumber="2299"><Highlight kind="normal">      <a href="#a18b0f192065386f9e0bc793a08bbf3ff">visitDomSubTree</a>(DT, SuccBB, &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB) &#123;</Highlight></CodeLine>
<Link id="l02300" /><CodeLine lineNumber="2300"><Highlight kind="normal">        DominatingSucc&#91;BB&#93; = SuccBB;</Highlight></CodeLine>
<Link id="l02301" /><CodeLine lineNumber="2301"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02302" /><CodeLine lineNumber="2302"><Highlight kind="normal">      &#125;);</Highlight></CodeLine>
<Link id="l02303" /><CodeLine lineNumber="2303"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02304" /><CodeLine lineNumber="2304"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Split the preheader, so that we know that there is a safe place to insert</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02305" /><CodeLine lineNumber="2305"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the conditional branch. We will change the preheader to have a conditional</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02306" /><CodeLine lineNumber="2306"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// branch on LoopCond. The original preheader will become the split point</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02307" /><CodeLine lineNumber="2307"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// between the unswitched versions, and we will have a new preheader for the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02308" /><CodeLine lineNumber="2308"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// original loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02309" /><CodeLine lineNumber="2309"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;SplitBB = L.getLoopPreheader();</Highlight></CodeLine>
<Link id="l02310" /><CodeLine lineNumber="2310"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;LoopPH = <a href="/docs/api/namespaces/llvm/#adf83581f514774264d616eef5706cf6e">SplitEdge</a>(SplitBB, L.getHeader(), &amp;DT, &amp;LI, MSSAU);</Highlight></CodeLine>
<Link id="l02311" /><CodeLine lineNumber="2311"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02312" /><CodeLine lineNumber="2312"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Keep track of the dominator tree updates needed.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02313" /><CodeLine lineNumber="2313"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;DominatorTree::UpdateType, 4&gt;</a> DTUpdates;</Highlight></CodeLine>
<Link id="l02314" /><CodeLine lineNumber="2314"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02315" /><CodeLine lineNumber="2315"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Clone the loop for each unswitched successor.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02316" /><CodeLine lineNumber="2316"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;std::unique&#95;ptr&lt;ValueToValueMapTy&gt;</a>, 4&gt; VMaps;</Highlight></CodeLine>
<Link id="l02317" /><CodeLine lineNumber="2317"><Highlight kind="normal">  VMaps.<a href="/docs/api/classes/llvm/smallvectorimpl/#a499ea32ca1b8d16cedfe01d1e5b08f29">reserve</a>(UnswitchedSuccBBs.<a href="/docs/api/classes/llvm/setvector/#a1a42c1ba878bd637f374197d05f0a97f">size</a>());</Highlight></CodeLine>
<Link id="l02318" /><CodeLine lineNumber="2318"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;BasicBlock &#42;, BasicBlock &#42;, 4&gt;</a> ClonedPHs;</Highlight></CodeLine>
<Link id="l02319" /><CodeLine lineNumber="2319"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;SuccBB : UnswitchedSuccBBs) &#123;</Highlight></CodeLine>
<Link id="l02320" /><CodeLine lineNumber="2320"><Highlight kind="normal">    VMaps.<a href="/docs/api/classes/llvm/smallvectorimpl/#a396fcfee6914c76974b73c3d203da6a5">emplace&#95;back</a>(</Highlight><Highlight kind="keyword">new</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a>());</Highlight></CodeLine>
<Link id="l02321" /><CodeLine lineNumber="2321"><Highlight kind="normal">    ClonedPHs&#91;SuccBB&#93; = <a href="#aea49493e2ae224d30cda2b3235d180b0">buildClonedLoopBlocks</a>(</Highlight></CodeLine>
<Link id="l02322" /><CodeLine lineNumber="2322"><Highlight kind="normal">        L, LoopPH, SplitBB, ExitBlocks, ParentBB, SuccBB, RetainedSuccBB,</Highlight></CodeLine>
<Link id="l02323" /><CodeLine lineNumber="2323"><Highlight kind="normal">        DominatingSucc, &#42;VMaps.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#acd9e771a3296c6b24146955754620557">back</a>(), DTUpdates, AC, DT, LI, MSSAU, SE);</Highlight></CodeLine>
<Link id="l02324" /><CodeLine lineNumber="2324"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02325" /><CodeLine lineNumber="2325"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02326" /><CodeLine lineNumber="2326"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Drop metadata if we may break its semantics by moving this instr into the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02327" /><CodeLine lineNumber="2327"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// split block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02328" /><CodeLine lineNumber="2328"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (TI.<a href="/docs/api/classes/llvm/instruction/#a6c09737e146b2d816c911a047ac67ba4">getMetadata</a>(LLVMContext::MD&#95;make&#95;implicit)) &#123;</Highlight></CodeLine>
<Link id="l02329" /><CodeLine lineNumber="2329"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#aab1355fa0b9b124a5424d170db011c9e">DropNonTrivialImplicitNullChecks</a>)</Highlight></CodeLine>
<Link id="l02330" /><CodeLine lineNumber="2330"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Do not spend time trying to understand if we can keep it, just drop it</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02331" /><CodeLine lineNumber="2331"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// to save compile time.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02332" /><CodeLine lineNumber="2332"><Highlight kind="normal">      TI.<a href="/docs/api/classes/llvm/instruction/#a9247a212ea89acc9573fa7e7f557eaba">setMetadata</a>(LLVMContext::MD&#95;make&#95;implicit, </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02333" /><CodeLine lineNumber="2333"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l02334" /><CodeLine lineNumber="2334"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// It is only legal to preserve make.implicit metadata if we are</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02335" /><CodeLine lineNumber="2335"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// guaranteed no reach implicit null check after following this branch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02336" /><CodeLine lineNumber="2336"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/icfloopsafetyinfo">ICFLoopSafetyInfo</a> SafetyInfo;</Highlight></CodeLine>
<Link id="l02337" /><CodeLine lineNumber="2337"><Highlight kind="normal">      SafetyInfo.<a href="/docs/api/classes/llvm/icfloopsafetyinfo/#aca2badb4637a1c884bebc80828feac0a">computeLoopSafetyInfo</a>(&amp;L);</Highlight></CodeLine>
<Link id="l02338" /><CodeLine lineNumber="2338"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!SafetyInfo.<a href="/docs/api/classes/llvm/icfloopsafetyinfo/#ab40701961745d6467fa8e23b1e451c12">isGuaranteedToExecute</a>(TI, &amp;DT, &amp;L))</Highlight></CodeLine>
<Link id="l02339" /><CodeLine lineNumber="2339"><Highlight kind="normal">        TI.<a href="/docs/api/classes/llvm/instruction/#a9247a212ea89acc9573fa7e7f557eaba">setMetadata</a>(LLVMContext::MD&#95;make&#95;implicit, </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02340" /><CodeLine lineNumber="2340"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l02341" /><CodeLine lineNumber="2341"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02342" /><CodeLine lineNumber="2342"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02343" /><CodeLine lineNumber="2343"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The stitching of the branched code back together depends on whether we&#39;re</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02344" /><CodeLine lineNumber="2344"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// doing full unswitching or not with the exception that we always want to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02345" /><CodeLine lineNumber="2345"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// nuke the initial terminator placed in the split block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02346" /><CodeLine lineNumber="2346"><Highlight kind="normal">  SplitBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>()-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</Highlight></CodeLine>
<Link id="l02347" /><CodeLine lineNumber="2347"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (FullUnswitch) &#123;</Highlight></CodeLine>
<Link id="l02348" /><CodeLine lineNumber="2348"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Keep a clone of the terminator for MSSA updates.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02349" /><CodeLine lineNumber="2349"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;NewTI = TI.<a href="/docs/api/classes/llvm/instruction/#a0a4d51e372293abe5e5f6dac133e80a6">clone</a>();</Highlight></CodeLine>
<Link id="l02350" /><CodeLine lineNumber="2350"><Highlight kind="normal">    NewTI-&gt;<a href="/docs/api/classes/llvm/instruction/#afcd9d2ea284c4d90541291ff9c47d332">insertInto</a>(ParentBB, ParentBB-&gt;end());</Highlight></CodeLine>
<Link id="l02351" /><CodeLine lineNumber="2351"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02352" /><CodeLine lineNumber="2352"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Splice the terminator from the original loop and rewrite its</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02353" /><CodeLine lineNumber="2353"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// successors.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02354" /><CodeLine lineNumber="2354"><Highlight kind="normal">    TI.<a href="/docs/api/classes/llvm/instruction/#af67d1f3a518964d80a109bb3d9d5cf1e">moveBefore</a>(&#42;SplitBB, SplitBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a0b4e7bee9b8575cc7db73329f1a561bd">end</a>());</Highlight></CodeLine>
<Link id="l02355" /><CodeLine lineNumber="2355"><Highlight kind="normal">    TI.<a href="/docs/api/classes/llvm/instruction/#a4576d69ed1543b06e5c41eb43b630bf1">dropLocation</a>();</Highlight></CodeLine>
<Link id="l02356" /><CodeLine lineNumber="2356"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02357" /><CodeLine lineNumber="2357"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// First wire up the moved terminator to the preheaders.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02358" /><CodeLine lineNumber="2358"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BI) &#123;</Highlight></CodeLine>
<Link id="l02359" /><CodeLine lineNumber="2359"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ClonedPH = ClonedPHs.<a href="/docs/api/classes/llvm/densemapbase/#a50d461a887e200e704e5157d3b21514d">begin</a>()-&gt;second;</Highlight></CodeLine>
<Link id="l02360" /><CodeLine lineNumber="2360"><Highlight kind="normal">      BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#adc5e7f9c460c68455e826783d77f9a99">setSuccessor</a>(ClonedSucc, ClonedPH);</Highlight></CodeLine>
<Link id="l02361" /><CodeLine lineNumber="2361"><Highlight kind="normal">      BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#adc5e7f9c460c68455e826783d77f9a99">setSuccessor</a>(1 - ClonedSucc, LoopPH);</Highlight></CodeLine>
<Link id="l02362" /><CodeLine lineNumber="2362"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a> = <a href="#a5ca2e820d1b5a49dcaad5e6873917198">skipTrivialSelect</a>(BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aebd4af5642453ce3169094f08dd3d7b8">getCondition</a>());</Highlight></CodeLine>
<Link id="l02363" /><CodeLine lineNumber="2363"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (InsertFreeze) &#123;</Highlight></CodeLine>
<Link id="l02364" /><CodeLine lineNumber="2364"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// We don&#39;t give any debug location to the new freeze, because the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02365" /><CodeLine lineNumber="2365"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// BI (&#96;dyn&#95;cast&lt;BranchInst&gt;(TI)&#96;) is an in-loop instruction hoisted</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02366" /><CodeLine lineNumber="2366"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// out of the loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02367" /><CodeLine lineNumber="2367"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a> = </Highlight><Highlight kind="keyword">new</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/freezeinst">FreezeInst</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>-&gt;getName() + </Highlight><Highlight kind="stringliteral">&quot;.fr&quot;</Highlight><Highlight kind="normal">, BI-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>());</Highlight></CodeLine>
<Link id="l02368" /><CodeLine lineNumber="2368"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l02369" /><CodeLine lineNumber="2369"><Highlight kind="normal">      BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#a3505dab06f59c36142a234321cdc3411">setCondition</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>);</Highlight></CodeLine>
<Link id="l02370" /><CodeLine lineNumber="2370"><Highlight kind="normal">      DTUpdates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;<a href="/docs/api/classes/llvm/dominatortreebase/#a9aeeca2833810f01b20545a46fe22503">DominatorTree::Insert</a>, SplitBB, ClonedPH&#125;);</Highlight></CodeLine>
<Link id="l02371" /><CodeLine lineNumber="2371"><Highlight kind="normal">    &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l02372" /><CodeLine lineNumber="2372"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/si">SI</a> &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Must either be a branch or switch!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02373" /><CodeLine lineNumber="2373"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02374" /><CodeLine lineNumber="2374"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Walk the cases and directly update their successors.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02375" /><CodeLine lineNumber="2375"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getDefaultDest() == RetainedSuccBB &amp;&amp;</Highlight></CodeLine>
<Link id="l02376" /><CodeLine lineNumber="2376"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;Not retaining default successor!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02377" /><CodeLine lineNumber="2377"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;setDefaultDest(LoopPH);</Highlight></CodeLine>
<Link id="l02378" /><CodeLine lineNumber="2378"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;Case : <a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;cases())</Highlight></CodeLine>
<Link id="l02379" /><CodeLine lineNumber="2379"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Case.getCaseSuccessor() == RetainedSuccBB)</Highlight></CodeLine>
<Link id="l02380" /><CodeLine lineNumber="2380"><Highlight kind="normal">          Case.setSuccessor(LoopPH);</Highlight></CodeLine>
<Link id="l02381" /><CodeLine lineNumber="2381"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02382" /><CodeLine lineNumber="2382"><Highlight kind="normal">          Case.setSuccessor(ClonedPHs.<a href="/docs/api/classes/llvm/densemapbase/#a0c047f127ed4380a6f383d70bec4eb94">find</a>(Case.getCaseSuccessor())-&gt;second);</Highlight></CodeLine>
<Link id="l02383" /><CodeLine lineNumber="2383"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02384" /><CodeLine lineNumber="2384"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (InsertFreeze)</Highlight></CodeLine>
<Link id="l02385" /><CodeLine lineNumber="2385"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;setCondition(</Highlight><Highlight kind="keyword">new</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/freezeinst">FreezeInst</a>(<a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getCondition(),</Highlight></CodeLine>
<Link id="l02386" /><CodeLine lineNumber="2386"><Highlight kind="normal">                                        <a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getCondition()-&gt;getName() + </Highlight><Highlight kind="stringliteral">&quot;.fr&quot;</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l02387" /><CodeLine lineNumber="2387"><Highlight kind="normal">                                        <a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getIterator()));</Highlight></CodeLine>
<Link id="l02388" /><CodeLine lineNumber="2388"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02389" /><CodeLine lineNumber="2389"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We need to use the set to populate domtree updates as even when there</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02390" /><CodeLine lineNumber="2390"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// are multiple cases pointing at the same successor we only want to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02391" /><CodeLine lineNumber="2391"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// remove and insert one edge in the domtree.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02392" /><CodeLine lineNumber="2392"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;SuccBB : UnswitchedSuccBBs)</Highlight></CodeLine>
<Link id="l02393" /><CodeLine lineNumber="2393"><Highlight kind="normal">        DTUpdates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(</Highlight></CodeLine>
<Link id="l02394" /><CodeLine lineNumber="2394"><Highlight kind="normal">            &#123;<a href="/docs/api/classes/llvm/dominatortreebase/#a9aeeca2833810f01b20545a46fe22503">DominatorTree::Insert</a>, SplitBB, ClonedPHs.<a href="/docs/api/classes/llvm/densemapbase/#a0c047f127ed4380a6f383d70bec4eb94">find</a>(SuccBB)-&gt;second&#125;);</Highlight></CodeLine>
<Link id="l02395" /><CodeLine lineNumber="2395"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l02396" /><CodeLine lineNumber="2396"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02397" /><CodeLine lineNumber="2397"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU) &#123;</Highlight></CodeLine>
<Link id="l02398" /><CodeLine lineNumber="2398"><Highlight kind="normal">      DT.<a href="/docs/api/classes/llvm/dominatortreebase/#a470b5b573c7915fe13bd529b22c9adbc">applyUpdates</a>(DTUpdates);</Highlight></CodeLine>
<Link id="l02399" /><CodeLine lineNumber="2399"><Highlight kind="normal">      DTUpdates.<a href="/docs/api/classes/llvm/smallvectorimpl/#aac0ea55010b7b1a301e65a0baea057aa">clear</a>();</Highlight></CodeLine>
<Link id="l02400" /><CodeLine lineNumber="2400"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02401" /><CodeLine lineNumber="2401"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Remove all but one edge to the retained block and all unswitched</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02402" /><CodeLine lineNumber="2402"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// blocks. This is to avoid having duplicate entries in the cloned Phis,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02403" /><CodeLine lineNumber="2403"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// when we know we only keep a single edge for each case.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02404" /><CodeLine lineNumber="2404"><Highlight kind="normal">      MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a95eeaea882b3c388420da771fe488bbc">removeDuplicatePhiEdgesBetween</a>(ParentBB, RetainedSuccBB);</Highlight></CodeLine>
<Link id="l02405" /><CodeLine lineNumber="2405"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;SuccBB : UnswitchedSuccBBs)</Highlight></CodeLine>
<Link id="l02406" /><CodeLine lineNumber="2406"><Highlight kind="normal">        MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a95eeaea882b3c388420da771fe488bbc">removeDuplicatePhiEdgesBetween</a>(ParentBB, SuccBB);</Highlight></CodeLine>
<Link id="l02407" /><CodeLine lineNumber="2407"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02408" /><CodeLine lineNumber="2408"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;VMap : VMaps)</Highlight></CodeLine>
<Link id="l02409" /><CodeLine lineNumber="2409"><Highlight kind="normal">        MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a667d41d0d3b12af17ccc6c99e3d51e5b">updateForClonedLoop</a>(LBRPO, ExitBlocks, &#42;VMap,</Highlight></CodeLine>
<Link id="l02410" /><CodeLine lineNumber="2410"><Highlight kind="normal">                                   </Highlight><Highlight kind="comment">/&#42;IgnoreIncomingWithNoClones=&#42;/</Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02411" /><CodeLine lineNumber="2411"><Highlight kind="normal">      MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#aeb3964d6e7884c21d8118699062c91df">updateExitBlocksForClonedLoop</a>(ExitBlocks, VMaps, DT);</Highlight></CodeLine>
<Link id="l02412" /><CodeLine lineNumber="2412"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02413" /><CodeLine lineNumber="2413"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Remove all edges to unswitched blocks.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02414" /><CodeLine lineNumber="2414"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;SuccBB : UnswitchedSuccBBs)</Highlight></CodeLine>
<Link id="l02415" /><CodeLine lineNumber="2415"><Highlight kind="normal">        MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a4953231268ee21e95c3740e51ab37a96">removeEdge</a>(ParentBB, SuccBB);</Highlight></CodeLine>
<Link id="l02416" /><CodeLine lineNumber="2416"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l02417" /><CodeLine lineNumber="2417"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02418" /><CodeLine lineNumber="2418"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Now unhook the successor relationship as we&#39;ll be replacing</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02419" /><CodeLine lineNumber="2419"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// the terminator with a direct branch. This is much simpler for branches</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02420" /><CodeLine lineNumber="2420"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// than switches so we handle those first.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02421" /><CodeLine lineNumber="2421"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BI) &#123;</Highlight></CodeLine>
<Link id="l02422" /><CodeLine lineNumber="2422"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Remove the parent as a predecessor of the unswitched successor.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02423" /><CodeLine lineNumber="2423"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(UnswitchedSuccBBs.<a href="/docs/api/classes/llvm/setvector/#a1a42c1ba878bd637f374197d05f0a97f">size</a>() == 1 &amp;&amp;</Highlight></CodeLine>
<Link id="l02424" /><CodeLine lineNumber="2424"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;Only one possible unswitched block for a branch!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02425" /><CodeLine lineNumber="2425"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;UnswitchedSuccBB = &#42;UnswitchedSuccBBs.<a href="/docs/api/classes/llvm/setvector/#ad0bf95396cec46a41371341460d14a1c">begin</a>();</Highlight></CodeLine>
<Link id="l02426" /><CodeLine lineNumber="2426"><Highlight kind="normal">      UnswitchedSuccBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#afe7af0c3ec2ef1f525173acd2ea4ba60">removePredecessor</a>(ParentBB,</Highlight></CodeLine>
<Link id="l02427" /><CodeLine lineNumber="2427"><Highlight kind="normal">                                          </Highlight><Highlight kind="comment">/&#42;KeepOneInputPHIs&#42;/</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02428" /><CodeLine lineNumber="2428"><Highlight kind="normal">      DTUpdates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;<a href="/docs/api/classes/llvm/dominatortreebase/#a71c91cbbfc1c0ecf9a69e10ccf739bd7">DominatorTree::Delete</a>, ParentBB, UnswitchedSuccBB&#125;);</Highlight></CodeLine>
<Link id="l02429" /><CodeLine lineNumber="2429"><Highlight kind="normal">    &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l02430" /><CodeLine lineNumber="2430"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Note that we actually want to remove the parent block as a predecessor</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02431" /><CodeLine lineNumber="2431"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// of &#42;every&#42; case successor. The case successor is either unswitched,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02432" /><CodeLine lineNumber="2432"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// completely eliminating an edge from the parent to that successor, or it</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02433" /><CodeLine lineNumber="2433"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// is a duplicate edge to the retained successor as the retained successor</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02434" /><CodeLine lineNumber="2434"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// is always the default successor and as we&#39;ll replace this with a direct</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02435" /><CodeLine lineNumber="2435"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// branch we no longer need the duplicate entries in the PHI nodes.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02436" /><CodeLine lineNumber="2436"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/switchinst">SwitchInst</a> &#42;NewSI = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;SwitchInst&gt;</a>(NewTI);</Highlight></CodeLine>
<Link id="l02437" /><CodeLine lineNumber="2437"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(NewSI-&gt;<a href="/docs/api/classes/llvm/switchinst/#a0943fb5f399be0ac6ffbe8c977b619c8">getDefaultDest</a>() == RetainedSuccBB &amp;&amp;</Highlight></CodeLine>
<Link id="l02438" /><CodeLine lineNumber="2438"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;Not retaining default successor!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02439" /><CodeLine lineNumber="2439"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;Case : NewSI-&gt;<a href="/docs/api/classes/llvm/switchinst/#aef781db858f88845051c0f2d7310ab07">cases</a>())</Highlight></CodeLine>
<Link id="l02440" /><CodeLine lineNumber="2440"><Highlight kind="normal">        Case.getCaseSuccessor()-&gt;removePredecessor(</Highlight></CodeLine>
<Link id="l02441" /><CodeLine lineNumber="2441"><Highlight kind="normal">            ParentBB,</Highlight></CodeLine>
<Link id="l02442" /><CodeLine lineNumber="2442"><Highlight kind="normal">            </Highlight><Highlight kind="comment">/&#42;KeepOneInputPHIs&#42;/</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02443" /><CodeLine lineNumber="2443"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02444" /><CodeLine lineNumber="2444"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We need to use the set to populate domtree updates as even when there</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02445" /><CodeLine lineNumber="2445"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// are multiple cases pointing at the same successor we only want to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02446" /><CodeLine lineNumber="2446"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// remove and insert one edge in the domtree.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02447" /><CodeLine lineNumber="2447"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;SuccBB : UnswitchedSuccBBs)</Highlight></CodeLine>
<Link id="l02448" /><CodeLine lineNumber="2448"><Highlight kind="normal">        DTUpdates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;<a href="/docs/api/classes/llvm/dominatortreebase/#a71c91cbbfc1c0ecf9a69e10ccf739bd7">DominatorTree::Delete</a>, ParentBB, SuccBB&#125;);</Highlight></CodeLine>
<Link id="l02449" /><CodeLine lineNumber="2449"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l02450" /><CodeLine lineNumber="2450"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02451" /><CodeLine lineNumber="2451"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Create a new unconditional branch to the continuing block (as opposed to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02452" /><CodeLine lineNumber="2452"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// the one cloned).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02453" /><CodeLine lineNumber="2453"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;NewBI = <a href="/docs/api/classes/llvm/branchinst/#a9f40e42226cee617c16cb1c447b115c5">BranchInst::Create</a>(RetainedSuccBB, ParentBB);</Highlight></CodeLine>
<Link id="l02454" /><CodeLine lineNumber="2454"><Highlight kind="normal">    NewBI-&gt;<a href="/docs/api/classes/llvm/instruction/#ae8f5bf5cc06f696b52c709677df00fbf">setDebugLoc</a>(NewTI-&gt;<a href="/docs/api/classes/llvm/instruction/#a4b8faae4ff9e7434a1d226d03d15dcd2">getDebugLoc</a>());</Highlight></CodeLine>
<Link id="l02455" /><CodeLine lineNumber="2455"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02456" /><CodeLine lineNumber="2456"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// After MSSAU update, remove the cloned terminator instruction NewTI.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02457" /><CodeLine lineNumber="2457"><Highlight kind="normal">    NewTI-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</Highlight></CodeLine>
<Link id="l02458" /><CodeLine lineNumber="2458"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l02459" /><CodeLine lineNumber="2459"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BI &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Only branches have partial unswitching.&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02460" /><CodeLine lineNumber="2460"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(UnswitchedSuccBBs.<a href="/docs/api/classes/llvm/setvector/#a1a42c1ba878bd637f374197d05f0a97f">size</a>() == 1 &amp;&amp;</Highlight></CodeLine>
<Link id="l02461" /><CodeLine lineNumber="2461"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;Only one possible unswitched block for a branch!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02462" /><CodeLine lineNumber="2462"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ClonedPH = ClonedPHs.<a href="/docs/api/classes/llvm/densemapbase/#a50d461a887e200e704e5157d3b21514d">begin</a>()-&gt;second;</Highlight></CodeLine>
<Link id="l02463" /><CodeLine lineNumber="2463"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// When doing a partial unswitch, we have to do a bit more work to build up</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02464" /><CodeLine lineNumber="2464"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// the branch in the split block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02465" /><CodeLine lineNumber="2465"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (PartiallyInvariant)</Highlight></CodeLine>
<Link id="l02466" /><CodeLine lineNumber="2466"><Highlight kind="normal">      <a href="#a0eaf12b7854445670a7b0af3fe87b86c">buildPartialInvariantUnswitchConditionalBranch</a>(</Highlight></CodeLine>
<Link id="l02467" /><CodeLine lineNumber="2467"><Highlight kind="normal">          &#42;SplitBB, Invariants, <a href="/docs/api/files/lib/lib/analysis/loopinfo-cpp/#ab4c7e3039b29b12e4dc97bcae93d79c3">Direction</a>, &#42;ClonedPH, &#42;LoopPH, L, MSSAU);</Highlight></CodeLine>
<Link id="l02468" /><CodeLine lineNumber="2468"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l02469" /><CodeLine lineNumber="2469"><Highlight kind="normal">      <a href="#a45b06cc0aa3a6fcbace0aacf3b25a9e6">buildPartialUnswitchConditionalBranch</a>(</Highlight></CodeLine>
<Link id="l02470" /><CodeLine lineNumber="2470"><Highlight kind="normal">          &#42;SplitBB, Invariants, <a href="/docs/api/files/lib/lib/analysis/loopinfo-cpp/#ab4c7e3039b29b12e4dc97bcae93d79c3">Direction</a>, &#42;ClonedPH, &#42;LoopPH,</Highlight></CodeLine>
<Link id="l02471" /><CodeLine lineNumber="2471"><Highlight kind="normal">          <a href="#a777551c6c08e4e3588b36665a8572414">FreezeLoopUnswitchCond</a>, BI, &amp;AC, DT);</Highlight></CodeLine>
<Link id="l02472" /><CodeLine lineNumber="2472"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l02473" /><CodeLine lineNumber="2473"><Highlight kind="normal">    DTUpdates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;<a href="/docs/api/classes/llvm/dominatortreebase/#a9aeeca2833810f01b20545a46fe22503">DominatorTree::Insert</a>, SplitBB, ClonedPH&#125;);</Highlight></CodeLine>
<Link id="l02474" /><CodeLine lineNumber="2474"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02475" /><CodeLine lineNumber="2475"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU) &#123;</Highlight></CodeLine>
<Link id="l02476" /><CodeLine lineNumber="2476"><Highlight kind="normal">      DT.<a href="/docs/api/classes/llvm/dominatortreebase/#a470b5b573c7915fe13bd529b22c9adbc">applyUpdates</a>(DTUpdates);</Highlight></CodeLine>
<Link id="l02477" /><CodeLine lineNumber="2477"><Highlight kind="normal">      DTUpdates.<a href="/docs/api/classes/llvm/smallvectorimpl/#aac0ea55010b7b1a301e65a0baea057aa">clear</a>();</Highlight></CodeLine>
<Link id="l02478" /><CodeLine lineNumber="2478"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02479" /><CodeLine lineNumber="2479"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Perform MSSA cloning updates.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02480" /><CodeLine lineNumber="2480"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;VMap : VMaps)</Highlight></CodeLine>
<Link id="l02481" /><CodeLine lineNumber="2481"><Highlight kind="normal">        MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a667d41d0d3b12af17ccc6c99e3d51e5b">updateForClonedLoop</a>(LBRPO, ExitBlocks, &#42;VMap,</Highlight></CodeLine>
<Link id="l02482" /><CodeLine lineNumber="2482"><Highlight kind="normal">                                   </Highlight><Highlight kind="comment">/&#42;IgnoreIncomingWithNoClones=&#42;/</Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02483" /><CodeLine lineNumber="2483"><Highlight kind="normal">      MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#aeb3964d6e7884c21d8118699062c91df">updateExitBlocksForClonedLoop</a>(ExitBlocks, VMaps, DT);</Highlight></CodeLine>
<Link id="l02484" /><CodeLine lineNumber="2484"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l02485" /><CodeLine lineNumber="2485"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02486" /><CodeLine lineNumber="2486"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02487" /><CodeLine lineNumber="2487"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Apply the updates accumulated above to get an up-to-date dominator tree.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02488" /><CodeLine lineNumber="2488"><Highlight kind="normal">  DT.<a href="/docs/api/classes/llvm/dominatortreebase/#a470b5b573c7915fe13bd529b22c9adbc">applyUpdates</a>(DTUpdates);</Highlight></CodeLine>
<Link id="l02489" /><CodeLine lineNumber="2489"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02490" /><CodeLine lineNumber="2490"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now that we have an accurate dominator tree, first delete the dead cloned</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02491" /><CodeLine lineNumber="2491"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// blocks so that we can accurately build any cloned loops. It is important to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02492" /><CodeLine lineNumber="2492"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// not delete the blocks from the original loop yet because we still want to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02493" /><CodeLine lineNumber="2493"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// reference the original loop to understand the cloned loop&#39;s structure.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02494" /><CodeLine lineNumber="2494"><Highlight kind="normal">  <a href="#a13971a178ec8248ecf4b0a903c4db1c6">deleteDeadClonedBlocks</a>(L, ExitBlocks, VMaps, DT, MSSAU);</Highlight></CodeLine>
<Link id="l02495" /><CodeLine lineNumber="2495"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02496" /><CodeLine lineNumber="2496"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Build the cloned loop structure itself. This may be substantially</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02497" /><CodeLine lineNumber="2497"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// different from the original structure due to the simplified CFG. This also</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02498" /><CodeLine lineNumber="2498"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// handles inserting all the cloned blocks into the correct loops.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02499" /><CodeLine lineNumber="2499"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Loop &#42;, 4&gt;</a> NonChildClonedLoops;</Highlight></CodeLine>
<Link id="l02500" /><CodeLine lineNumber="2500"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (std::unique&#95;ptr&lt;ValueToValueMapTy&gt; &amp;VMap : VMaps)</Highlight></CodeLine>
<Link id="l02501" /><CodeLine lineNumber="2501"><Highlight kind="normal">    <a href="#afe5225e90ea8896cab9cda7246af413d">buildClonedLoops</a>(L, ExitBlocks, &#42;VMap, LI, NonChildClonedLoops);</Highlight></CodeLine>
<Link id="l02502" /><CodeLine lineNumber="2502"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02503" /><CodeLine lineNumber="2503"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now that our cloned loops have been built, we can update the original loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02504" /><CodeLine lineNumber="2504"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// First we delete the dead blocks from it and then we rebuild the loop</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02505" /><CodeLine lineNumber="2505"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// structure taking these deletions into account.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02506" /><CodeLine lineNumber="2506"><Highlight kind="normal">  <a href="#aeabcdff1c388af9ac5a98f1ec4ba2471">deleteDeadBlocksFromLoop</a>(L, ExitBlocks, DT, LI, MSSAU, SE, LoopUpdater);</Highlight></CodeLine>
<Link id="l02507" /><CodeLine lineNumber="2507"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02508" /><CodeLine lineNumber="2508"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU &amp;&amp; <a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l02509" /><CodeLine lineNumber="2509"><Highlight kind="normal">    MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a01a350909e784d6fa43181a72de61529">getMemorySSA</a>()-&gt;<a href="/docs/api/classes/llvm/memoryssa/#a88b10d37f671e58cf138ac84a8257c17">verifyMemorySSA</a>();</Highlight></CodeLine>
<Link id="l02510" /><CodeLine lineNumber="2510"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02511" /><CodeLine lineNumber="2511"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Loop &#42;, 4&gt;</a> HoistedLoops;</Highlight></CodeLine>
<Link id="l02512" /><CodeLine lineNumber="2512"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> IsStillLoop =</Highlight></CodeLine>
<Link id="l02513" /><CodeLine lineNumber="2513"><Highlight kind="normal">      <a href="#ab79f3dcf9607c6a8908cda57cc964f49">rebuildLoopAfterUnswitch</a>(L, ExitBlocks, LI, HoistedLoops, SE);</Highlight></CodeLine>
<Link id="l02514" /><CodeLine lineNumber="2514"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02515" /><CodeLine lineNumber="2515"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU &amp;&amp; <a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l02516" /><CodeLine lineNumber="2516"><Highlight kind="normal">    MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a01a350909e784d6fa43181a72de61529">getMemorySSA</a>()-&gt;<a href="/docs/api/classes/llvm/memoryssa/#a88b10d37f671e58cf138ac84a8257c17">verifyMemorySSA</a>();</Highlight></CodeLine>
<Link id="l02517" /><CodeLine lineNumber="2517"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02518" /><CodeLine lineNumber="2518"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// This transformation has a high risk of corrupting the dominator tree, and</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02519" /><CodeLine lineNumber="2519"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the below steps to rebuild loop structures will result in hard to debug</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02520" /><CodeLine lineNumber="2520"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// errors in that case so verify that the dominator tree is sane first.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02521" /><CodeLine lineNumber="2521"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// FIXME: Remove this when the bugs stop showing up and rely on existing</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02522" /><CodeLine lineNumber="2522"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// verification steps.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02523" /><CodeLine lineNumber="2523"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(DT.<a href="/docs/api/classes/llvm/dominatortreebase/#a1f08f2925fec05b265e540d29066b9c8">verify</a>(DominatorTree::VerificationLevel::Fast));</Highlight></CodeLine>
<Link id="l02524" /><CodeLine lineNumber="2524"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02525" /><CodeLine lineNumber="2525"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BI &amp;&amp; !PartiallyInvariant) &#123;</Highlight></CodeLine>
<Link id="l02526" /><CodeLine lineNumber="2526"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If we unswitched a branch which collapses the condition to a known</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02527" /><CodeLine lineNumber="2527"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// constant we want to replace all the uses of the invariants within both</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02528" /><CodeLine lineNumber="2528"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// the original and cloned blocks. We do this here so that we can use the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02529" /><CodeLine lineNumber="2529"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// now updated dominator tree to identify which side the users are on.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02530" /><CodeLine lineNumber="2530"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(UnswitchedSuccBBs.<a href="/docs/api/classes/llvm/setvector/#a1a42c1ba878bd637f374197d05f0a97f">size</a>() == 1 &amp;&amp;</Highlight></CodeLine>
<Link id="l02531" /><CodeLine lineNumber="2531"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;Only one possible unswitched block for a branch!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02532" /><CodeLine lineNumber="2532"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ClonedPH = ClonedPHs.<a href="/docs/api/classes/llvm/densemapbase/#a50d461a887e200e704e5157d3b21514d">begin</a>()-&gt;second;</Highlight></CodeLine>
<Link id="l02533" /><CodeLine lineNumber="2533"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02534" /><CodeLine lineNumber="2534"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// When considering multiple partially-unswitched invariants</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02535" /><CodeLine lineNumber="2535"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// we cant just go replace them with constants in both branches.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02536" /><CodeLine lineNumber="2536"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02537" /><CodeLine lineNumber="2537"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// For &#39;AND&#39; we infer that true branch (&quot;continue&quot;) means true</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02538" /><CodeLine lineNumber="2538"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// for each invariant operand.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02539" /><CodeLine lineNumber="2539"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// For &#39;OR&#39; we can infer that false branch (&quot;continue&quot;) means false</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02540" /><CodeLine lineNumber="2540"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// for each invariant operand.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02541" /><CodeLine lineNumber="2541"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// So it happens that for multiple-partial case we dont replace</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02542" /><CodeLine lineNumber="2542"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// in the unswitched branch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02543" /><CodeLine lineNumber="2543"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> ReplaceUnswitched =</Highlight></CodeLine>
<Link id="l02544" /><CodeLine lineNumber="2544"><Highlight kind="normal">        FullUnswitch || (Invariants.<a href="/docs/api/classes/llvm/arrayref/#a85ffb6531d4cda988ea81f18d4e56fb7">size</a>() == 1) || PartiallyInvariant;</Highlight></CodeLine>
<Link id="l02545" /><CodeLine lineNumber="2545"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02546" /><CodeLine lineNumber="2546"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;UnswitchedReplacement =</Highlight></CodeLine>
<Link id="l02547" /><CodeLine lineNumber="2547"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/analysis/loopinfo-cpp/#ab4c7e3039b29b12e4dc97bcae93d79c3">Direction</a> ? <a href="/docs/api/classes/llvm/constantint/#a82dbbd8e3688b0bc1eedb338864d0d0c">ConstantInt::getTrue</a>(BI-&gt;<a href="/docs/api/classes/llvm/value/#ab3fc0225d8aaf8434026c3573f961f2c">getContext</a>())</Highlight></CodeLine>
<Link id="l02548" /><CodeLine lineNumber="2548"><Highlight kind="normal">                  : <a href="/docs/api/classes/llvm/constantint/#aa7cce62ac5cc6df09cce0535874336b7">ConstantInt::getFalse</a>(BI-&gt;<a href="/docs/api/classes/llvm/value/#ab3fc0225d8aaf8434026c3573f961f2c">getContext</a>());</Highlight></CodeLine>
<Link id="l02549" /><CodeLine lineNumber="2549"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;ContinueReplacement =</Highlight></CodeLine>
<Link id="l02550" /><CodeLine lineNumber="2550"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/analysis/loopinfo-cpp/#ab4c7e3039b29b12e4dc97bcae93d79c3">Direction</a> ? <a href="/docs/api/classes/llvm/constantint/#aa7cce62ac5cc6df09cce0535874336b7">ConstantInt::getFalse</a>(BI-&gt;<a href="/docs/api/classes/llvm/value/#ab3fc0225d8aaf8434026c3573f961f2c">getContext</a>())</Highlight></CodeLine>
<Link id="l02551" /><CodeLine lineNumber="2551"><Highlight kind="normal">                  : <a href="/docs/api/classes/llvm/constantint/#a82dbbd8e3688b0bc1eedb338864d0d0c">ConstantInt::getTrue</a>(BI-&gt;<a href="/docs/api/classes/llvm/value/#ab3fc0225d8aaf8434026c3573f961f2c">getContext</a>());</Highlight></CodeLine>
<Link id="l02552" /><CodeLine lineNumber="2552"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/value">Value</a> &#42;Invariant : Invariants) &#123;</Highlight></CodeLine>
<Link id="l02553" /><CodeLine lineNumber="2553"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;Constant&gt;</a>(Invariant) &amp;&amp;</Highlight></CodeLine>
<Link id="l02554" /><CodeLine lineNumber="2554"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;Should not be replacing constant values!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02555" /><CodeLine lineNumber="2555"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Use make&#95;early&#95;inc&#95;range here as set invalidates the iterator.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02556" /><CodeLine lineNumber="2556"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/use">Use</a> &amp;U : <a href="/docs/api/namespaces/llvm/#a3d2cdc4a0db233678e7141c9d6ea3419">llvm::make&#95;early&#95;inc&#95;range</a>(Invariant-&gt;uses())) &#123;</Highlight></CodeLine>
<Link id="l02557" /><CodeLine lineNumber="2557"><Highlight kind="normal">        <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;UserI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(U.getUser());</Highlight></CodeLine>
<Link id="l02558" /><CodeLine lineNumber="2558"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!UserI)</Highlight></CodeLine>
<Link id="l02559" /><CodeLine lineNumber="2559"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02560" /><CodeLine lineNumber="2560"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02561" /><CodeLine lineNumber="2561"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Replace it with the &#39;continue&#39; side if in the main loop body, and the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02562" /><CodeLine lineNumber="2562"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// unswitched if in the cloned blocks.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02563" /><CodeLine lineNumber="2563"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DT.<a href="/docs/api/classes/llvm/dominatortree/#a5c69311e8d44898dac36a155c3d8691d">dominates</a>(LoopPH, UserI-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>()))</Highlight></CodeLine>
<Link id="l02564" /><CodeLine lineNumber="2564"><Highlight kind="normal">          U.set(ContinueReplacement);</Highlight></CodeLine>
<Link id="l02565" /><CodeLine lineNumber="2565"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (ReplaceUnswitched &amp;&amp;</Highlight></CodeLine>
<Link id="l02566" /><CodeLine lineNumber="2566"><Highlight kind="normal">                 DT.<a href="/docs/api/classes/llvm/dominatortree/#a5c69311e8d44898dac36a155c3d8691d">dominates</a>(ClonedPH, UserI-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>()))</Highlight></CodeLine>
<Link id="l02567" /><CodeLine lineNumber="2567"><Highlight kind="normal">          U.set(UnswitchedReplacement);</Highlight></CodeLine>
<Link id="l02568" /><CodeLine lineNumber="2568"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l02569" /><CodeLine lineNumber="2569"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l02570" /><CodeLine lineNumber="2570"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02571" /><CodeLine lineNumber="2571"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02572" /><CodeLine lineNumber="2572"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We can change which blocks are exit blocks of all the cloned sibling</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02573" /><CodeLine lineNumber="2573"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// loops, the current loop, and any parent loops which shared exit blocks</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02574" /><CodeLine lineNumber="2574"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// with the current loop. As a consequence, we need to re-form LCSSA for</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02575" /><CodeLine lineNumber="2575"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// them. But we shouldn&#39;t need to re-form LCSSA for any child loops.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02576" /><CodeLine lineNumber="2576"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// FIXME: This could be made more efficient by tracking which exit blocks are</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02577" /><CodeLine lineNumber="2577"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// new, and focusing on them, but that isn&#39;t likely to be necessary.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02578" /><CodeLine lineNumber="2578"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02579" /><CodeLine lineNumber="2579"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// In order to reasonably rebuild LCSSA we need to walk inside-out across the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02580" /><CodeLine lineNumber="2580"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// loop nest and update every loop that could have had its exits changed. We</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02581" /><CodeLine lineNumber="2581"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// also need to cover any intervening loops. We add all of these loops to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02582" /><CodeLine lineNumber="2582"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// a list and sort them by loop depth to achieve this without updating</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02583" /><CodeLine lineNumber="2583"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// unnecessary loops.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02584" /><CodeLine lineNumber="2584"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> UpdateLoop = &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;UpdateL) &#123;</Highlight></CodeLine>
<Link id="l02585" /><CodeLine lineNumber="2585"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#ifndef NDEBUG</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02586" /><CodeLine lineNumber="2586"><Highlight kind="normal">    UpdateL.verifyLoop();</Highlight></CodeLine>
<Link id="l02587" /><CodeLine lineNumber="2587"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ChildL : UpdateL) &#123;</Highlight></CodeLine>
<Link id="l02588" /><CodeLine lineNumber="2588"><Highlight kind="normal">      ChildL-&gt;verifyLoop();</Highlight></CodeLine>
<Link id="l02589" /><CodeLine lineNumber="2589"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(ChildL-&gt;isRecursivelyLCSSAForm(DT, LI) &amp;&amp;</Highlight></CodeLine>
<Link id="l02590" /><CodeLine lineNumber="2590"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;Perturbed a child loop&#39;s LCSSA form!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02591" /><CodeLine lineNumber="2591"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l02592" /><CodeLine lineNumber="2592"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#endif</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02593" /><CodeLine lineNumber="2593"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// First build LCSSA for this loop so that we can preserve it when</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02594" /><CodeLine lineNumber="2594"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// forming dedicated exits. We don&#39;t want to perturb some other loop&#39;s</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02595" /><CodeLine lineNumber="2595"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// LCSSA while doing that CFG edit.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02596" /><CodeLine lineNumber="2596"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#ae852af0cb2b1bee6f725a552cf7cfdea">formLCSSA</a>(UpdateL, DT, &amp;LI, SE);</Highlight></CodeLine>
<Link id="l02597" /><CodeLine lineNumber="2597"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02598" /><CodeLine lineNumber="2598"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// For loops reached by this loop&#39;s original exit blocks we may</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02599" /><CodeLine lineNumber="2599"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// introduced new, non-dedicated exits. At least try to re-form dedicated</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02600" /><CodeLine lineNumber="2600"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// exits for these loops. This may fail if they couldn&#39;t have dedicated</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02601" /><CodeLine lineNumber="2601"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// exits to start with.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02602" /><CodeLine lineNumber="2602"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#ab1f7831449cd72e78894e3dcda705cd8">formDedicatedExitBlocks</a>(&amp;UpdateL, &amp;DT, &amp;LI, MSSAU, </Highlight><Highlight kind="comment">/&#42;PreserveLCSSA&#42;/</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02603" /><CodeLine lineNumber="2603"><Highlight kind="normal">  &#125;;</Highlight></CodeLine>
<Link id="l02604" /><CodeLine lineNumber="2604"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02605" /><CodeLine lineNumber="2605"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// For non-child cloned loops and hoisted loops, we just need to update LCSSA</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02606" /><CodeLine lineNumber="2606"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// and we can do it in any order as they don&#39;t nest relative to each other.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02607" /><CodeLine lineNumber="2607"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02608" /><CodeLine lineNumber="2608"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Also check if any of the loops we have updated have become top-level loops</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02609" /><CodeLine lineNumber="2609"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// as that will necessitate widening the outer loop scope.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02610" /><CodeLine lineNumber="2610"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;UpdatedL :</Highlight></CodeLine>
<Link id="l02611" /><CodeLine lineNumber="2611"><Highlight kind="normal">       <a href="/docs/api/namespaces/llvm/#a52ff73f5c87e0fb78fbdca0465300c95">llvm::concat&lt;Loop &#42;&gt;</a>(NonChildClonedLoops, HoistedLoops)) &#123;</Highlight></CodeLine>
<Link id="l02612" /><CodeLine lineNumber="2612"><Highlight kind="normal">    UpdateLoop(&#42;UpdatedL);</Highlight></CodeLine>
<Link id="l02613" /><CodeLine lineNumber="2613"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UpdatedL-&gt;isOutermost())</Highlight></CodeLine>
<Link id="l02614" /><CodeLine lineNumber="2614"><Highlight kind="normal">      OuterExitL = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02615" /><CodeLine lineNumber="2615"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02616" /><CodeLine lineNumber="2616"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (IsStillLoop) &#123;</Highlight></CodeLine>
<Link id="l02617" /><CodeLine lineNumber="2617"><Highlight kind="normal">    UpdateLoop(L);</Highlight></CodeLine>
<Link id="l02618" /><CodeLine lineNumber="2618"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L.isOutermost())</Highlight></CodeLine>
<Link id="l02619" /><CodeLine lineNumber="2619"><Highlight kind="normal">      OuterExitL = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02620" /><CodeLine lineNumber="2620"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02621" /><CodeLine lineNumber="2621"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02622" /><CodeLine lineNumber="2622"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If the original loop had exit blocks, walk up through the outer most loop</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02623" /><CodeLine lineNumber="2623"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// of those exit blocks to update LCSSA and form updated dedicated exits.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02624" /><CodeLine lineNumber="2624"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (OuterExitL != &amp;L)</Highlight></CodeLine>
<Link id="l02625" /><CodeLine lineNumber="2625"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;OuterL = ParentL; OuterL != OuterExitL;</Highlight></CodeLine>
<Link id="l02626" /><CodeLine lineNumber="2626"><Highlight kind="normal">         OuterL = OuterL-&gt;<a href="/docs/api/classes/llvm/loopbase/#ae34bcd53f75fab0c03b509ecccb4cfaf">getParentLoop</a>())</Highlight></CodeLine>
<Link id="l02627" /><CodeLine lineNumber="2627"><Highlight kind="normal">      UpdateLoop(&#42;OuterL);</Highlight></CodeLine>
<Link id="l02628" /><CodeLine lineNumber="2628"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02629" /><CodeLine lineNumber="2629"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#ifndef NDEBUG</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02630" /><CodeLine lineNumber="2630"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Verify the entire loop structure to catch any incorrect updates before we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02631" /><CodeLine lineNumber="2631"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// progress in the pass pipeline.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02632" /><CodeLine lineNumber="2632"><Highlight kind="normal">  LI.<a href="/docs/api/classes/llvm/loopinfobase/#a17a8f7aba5cca5c7f9faa779a3c4bc37">verify</a>(DT);</Highlight></CodeLine>
<Link id="l02633" /><CodeLine lineNumber="2633"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#endif</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02634" /><CodeLine lineNumber="2634"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02635" /><CodeLine lineNumber="2635"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now that we&#39;ve unswitched something, make callbacks to report the changes.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02636" /><CodeLine lineNumber="2636"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// For that we need to merge together the updated loops and the cloned loops</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02637" /><CodeLine lineNumber="2637"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// and check whether the original loop survived.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02638" /><CodeLine lineNumber="2638"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Loop &#42;, 4&gt;</a> SibLoops;</Highlight></CodeLine>
<Link id="l02639" /><CodeLine lineNumber="2639"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;UpdatedL : <a href="/docs/api/namespaces/llvm/#a52ff73f5c87e0fb78fbdca0465300c95">llvm::concat&lt;Loop &#42;&gt;</a>(NonChildClonedLoops, HoistedLoops))</Highlight></CodeLine>
<Link id="l02640" /><CodeLine lineNumber="2640"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UpdatedL-&gt;getParentLoop() == ParentL)</Highlight></CodeLine>
<Link id="l02641" /><CodeLine lineNumber="2641"><Highlight kind="normal">      SibLoops.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(UpdatedL);</Highlight></CodeLine>
<Link id="l02642" /><CodeLine lineNumber="2642"><Highlight kind="normal">  <a href="#a45007554e260296266b8ae927dde223f">postUnswitch</a>(L, LoopUpdater, LoopName, IsStillLoop, PartiallyInvariant,</Highlight></CodeLine>
<Link id="l02643" /><CodeLine lineNumber="2643"><Highlight kind="normal">               InjectedCondition, SibLoops);</Highlight></CodeLine>
<Link id="l02644" /><CodeLine lineNumber="2644"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02645" /><CodeLine lineNumber="2645"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU &amp;&amp; <a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l02646" /><CodeLine lineNumber="2646"><Highlight kind="normal">    MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a01a350909e784d6fa43181a72de61529">getMemorySSA</a>()-&gt;<a href="/docs/api/classes/llvm/memoryssa/#a88b10d37f671e58cf138ac84a8257c17">verifyMemorySSA</a>();</Highlight></CodeLine>
<Link id="l02647" /><CodeLine lineNumber="2647"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02648" /><CodeLine lineNumber="2648"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BI)</Highlight></CodeLine>
<Link id="l02649" /><CodeLine lineNumber="2649"><Highlight kind="normal">    ++NumBranches;</Highlight></CodeLine>
<Link id="l02650" /><CodeLine lineNumber="2650"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02651" /><CodeLine lineNumber="2651"><Highlight kind="normal">    ++NumSwitches;</Highlight></CodeLine>
<Link id="l02652" /><CodeLine lineNumber="2652"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l02653" /><CodeLine lineNumber="2653"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l02654" /><CodeLine lineNumber="2654"><Highlight kind="comment">/// Recursively compute the cost of a dominator subtree based on the per-block</Highlight></CodeLine>
<Link id="l02655" /><CodeLine lineNumber="2655"><Highlight kind="comment">/// cost map provided.</Highlight></CodeLine>
<Link id="l02656" /><CodeLine lineNumber="2656"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02657" /><CodeLine lineNumber="2657"><Highlight kind="comment">/// The recursive computation is memozied into the provided DT-indexed cost map</Highlight></CodeLine>
<Link id="l02658" /><CodeLine lineNumber="2658"><Highlight kind="comment">/// to allow querying it for most nodes in the domtree without it becoming</Highlight></CodeLine>
<Link id="l02659" /><CodeLine lineNumber="2659"><Highlight kind="comment">/// quadratic.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02660" /><CodeLine lineNumber="2660" lineLink="#a78a15f5bff768264b9e435e319db18f3"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/instructioncost">InstructionCost</a> <a href="#a78a15f5bff768264b9e435e319db18f3">computeDomSubtreeCost</a>(</Highlight></CodeLine>
<Link id="l02661" /><CodeLine lineNumber="2661"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a58b9df85470fc4e2a8066ff6a62e5a34">DomTreeNode</a> &amp;<a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>,</Highlight></CodeLine>
<Link id="l02662" /><CodeLine lineNumber="2662"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;BasicBlock &#42;, InstructionCost, 4&gt;</a> &amp;BBCostMap,</Highlight></CodeLine>
<Link id="l02663" /><CodeLine lineNumber="2663"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;DomTreeNode &#42;, InstructionCost, 4&gt;</a> &amp;DTCostMap) &#123;</Highlight></CodeLine>
<Link id="l02664" /><CodeLine lineNumber="2664"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Don&#39;t accumulate cost (or recurse through) blocks not in our block cost</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02665" /><CodeLine lineNumber="2665"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// map and thus not part of the duplication cost being considered.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02666" /><CodeLine lineNumber="2666"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> BBCostIt = BBCostMap.<a href="/docs/api/classes/llvm/densemapbase/#a0c047f127ed4380a6f383d70bec4eb94">find</a>(<a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>.getBlock());</Highlight></CodeLine>
<Link id="l02667" /><CodeLine lineNumber="2667"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BBCostIt == BBCostMap.<a href="/docs/api/classes/llvm/densemapbase/#a65520b9c67759099e313d0f4e7b5ff9e">end</a>())</Highlight></CodeLine>
<Link id="l02668" /><CodeLine lineNumber="2668"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> 0;</Highlight></CodeLine>
<Link id="l02669" /><CodeLine lineNumber="2669"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02670" /><CodeLine lineNumber="2670"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Lookup this node to see if we already computed its cost.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02671" /><CodeLine lineNumber="2671"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> DTCostIt = DTCostMap.<a href="/docs/api/classes/llvm/densemapbase/#a0c047f127ed4380a6f383d70bec4eb94">find</a>(&amp;<a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>);</Highlight></CodeLine>
<Link id="l02672" /><CodeLine lineNumber="2672"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DTCostIt != DTCostMap.<a href="/docs/api/classes/llvm/densemapbase/#a65520b9c67759099e313d0f4e7b5ff9e">end</a>())</Highlight></CodeLine>
<Link id="l02673" /><CodeLine lineNumber="2673"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> DTCostIt-&gt;second;</Highlight></CodeLine>
<Link id="l02674" /><CodeLine lineNumber="2674"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02675" /><CodeLine lineNumber="2675"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If not, we have to compute it. We can&#39;t use insert above and update</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02676" /><CodeLine lineNumber="2676"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// because computing the cost may insert more things into the map.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02677" /><CodeLine lineNumber="2677"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/instructioncost">InstructionCost</a> <a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a> = std::accumulate(</Highlight></CodeLine>
<Link id="l02678" /><CodeLine lineNumber="2678"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>.begin(), <a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>.end(), BBCostIt-&gt;second,</Highlight></CodeLine>
<Link id="l02679" /><CodeLine lineNumber="2679"><Highlight kind="normal">      &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/instructioncost">InstructionCost</a> Sum, <a href="/docs/api/namespaces/llvm/#a58b9df85470fc4e2a8066ff6a62e5a34">DomTreeNode</a> &#42;ChildN) -&gt; <a href="/docs/api/classes/llvm/instructioncost">InstructionCost</a> &#123;</Highlight></CodeLine>
<Link id="l02680" /><CodeLine lineNumber="2680"><Highlight kind="normal">        return Sum + computeDomSubtreeCost(&#42;ChildN, BBCostMap, DTCostMap);</Highlight></CodeLine>
<Link id="l02681" /><CodeLine lineNumber="2681"><Highlight kind="normal">      &#125;);</Highlight></CodeLine>
<Link id="l02682" /><CodeLine lineNumber="2682"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> Inserted = DTCostMap.<a href="/docs/api/classes/llvm/densemapbase/#adb33f3ede2f5bfc9b3ee658aaf648492">insert</a>(&#123;&amp;<a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>, <a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a>&#125;).second;</Highlight></CodeLine>
<Link id="l02683" /><CodeLine lineNumber="2683"><Highlight kind="normal">  (void)Inserted;</Highlight></CodeLine>
<Link id="l02684" /><CodeLine lineNumber="2684"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Inserted &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Should not insert a node while visiting children!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02685" /><CodeLine lineNumber="2685"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a>;</Highlight></CodeLine>
<Link id="l02686" /><CodeLine lineNumber="2686"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l02687" /><CodeLine lineNumber="2687"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l02688" /><CodeLine lineNumber="2688"><Highlight kind="comment">/// Turns a select instruction into implicit control flow branch,</Highlight></CodeLine>
<Link id="l02689" /><CodeLine lineNumber="2689"><Highlight kind="comment">/// making the following replacement:</Highlight></CodeLine>
<Link id="l02690" /><CodeLine lineNumber="2690"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02691" /><CodeLine lineNumber="2691"><Highlight kind="comment">/// head:</Highlight></CodeLine>
<Link id="l02692" /><CodeLine lineNumber="2692"><Highlight kind="comment">///   --code before select--</Highlight></CodeLine>
<Link id="l02693" /><CodeLine lineNumber="2693"><Highlight kind="comment">///   select %cond, %trueval, %falseval</Highlight></CodeLine>
<Link id="l02694" /><CodeLine lineNumber="2694"><Highlight kind="comment">///   --code after select--</Highlight></CodeLine>
<Link id="l02695" /><CodeLine lineNumber="2695"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02696" /><CodeLine lineNumber="2696"><Highlight kind="comment">/// into</Highlight></CodeLine>
<Link id="l02697" /><CodeLine lineNumber="2697"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02698" /><CodeLine lineNumber="2698"><Highlight kind="comment">/// head:</Highlight></CodeLine>
<Link id="l02699" /><CodeLine lineNumber="2699"><Highlight kind="comment">///   --code before select--</Highlight></CodeLine>
<Link id="l02700" /><CodeLine lineNumber="2700"><Highlight kind="comment">///   br i1 %cond, label %then, label %tail</Highlight></CodeLine>
<Link id="l02701" /><CodeLine lineNumber="2701"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02702" /><CodeLine lineNumber="2702"><Highlight kind="comment">/// then:</Highlight></CodeLine>
<Link id="l02703" /><CodeLine lineNumber="2703"><Highlight kind="comment">///   br %tail</Highlight></CodeLine>
<Link id="l02704" /><CodeLine lineNumber="2704"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02705" /><CodeLine lineNumber="2705"><Highlight kind="comment">/// tail:</Highlight></CodeLine>
<Link id="l02706" /><CodeLine lineNumber="2706"><Highlight kind="comment">///   phi &#91; %trueval, %then &#93;, &#91; %falseval, %head&#93;</Highlight></CodeLine>
<Link id="l02707" /><CodeLine lineNumber="2707"><Highlight kind="comment">///   unreachable</Highlight></CodeLine>
<Link id="l02708" /><CodeLine lineNumber="2708"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02709" /><CodeLine lineNumber="2709"><Highlight kind="comment">/// It also makes all relevant DT and LI updates, so that all structures are in</Highlight></CodeLine>
<Link id="l02710" /><CodeLine lineNumber="2710"><Highlight kind="comment">/// valid state after this transform.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02711" /><CodeLine lineNumber="2711" lineLink="#a2e6301db15e4516c92e21f33761886c6"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;<a href="#a2e6301db15e4516c92e21f33761886c6">turnSelectIntoBranch</a>(<a href="/docs/api/classes/llvm/selectinst">SelectInst</a> &#42;<a href="/docs/api/namespaces/llvm/si">SI</a>, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT,</Highlight></CodeLine>
<Link id="l02712" /><CodeLine lineNumber="2712"><Highlight kind="normal">                                        <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42;MSSAU,</Highlight></CodeLine>
<Link id="l02713" /><CodeLine lineNumber="2713"><Highlight kind="normal">                                        <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &#42;AC) &#123;</Highlight></CodeLine>
<Link id="l02714" /><CodeLine lineNumber="2714"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Turning &quot;</Highlight><Highlight kind="normal"> &lt;&lt; &#42;<a href="/docs/api/namespaces/llvm/si">SI</a> &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; into a branch.\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02715" /><CodeLine lineNumber="2715"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;HeadBB = <a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getParent();</Highlight></CodeLine>
<Link id="l02716" /><CodeLine lineNumber="2716"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02717" /><CodeLine lineNumber="2717"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/domtreeupdater">DomTreeUpdater</a> DTU(DT, DomTreeUpdater::UpdateStrategy::Eager);</Highlight></CodeLine>
<Link id="l02718" /><CodeLine lineNumber="2718"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#ad957413955739c91204c96e33e0cc933">SplitBlockAndInsertIfThen</a>(<a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getCondition(), <a href="/docs/api/namespaces/llvm/si">SI</a>, </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l02719" /><CodeLine lineNumber="2719"><Highlight kind="normal">                            <a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getMetadata(LLVMContext::MD&#95;prof), &amp;DTU, &amp;LI);</Highlight></CodeLine>
<Link id="l02720" /><CodeLine lineNumber="2720"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;CondBr = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BranchInst&gt;</a>(HeadBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l02721" /><CodeLine lineNumber="2721"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ThenBB = CondBr-&gt;getSuccessor(0),</Highlight></CodeLine>
<Link id="l02722" /><CodeLine lineNumber="2722"><Highlight kind="normal">             &#42;TailBB = CondBr-&gt;getSuccessor(1);</Highlight></CodeLine>
<Link id="l02723" /><CodeLine lineNumber="2723"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU)</Highlight></CodeLine>
<Link id="l02724" /><CodeLine lineNumber="2724"><Highlight kind="normal">    MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#aa7518e6d6d74227a56b36eb88cfe26e6">moveAllAfterSpliceBlocks</a>(HeadBB, TailBB, <a href="/docs/api/namespaces/llvm/si">SI</a>);</Highlight></CodeLine>
<Link id="l02725" /><CodeLine lineNumber="2725"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02726" /><CodeLine lineNumber="2726"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;Phi =</Highlight></CodeLine>
<Link id="l02727" /><CodeLine lineNumber="2727"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/phinode/#af4aba918a76ca15bde1be3e14572e475">PHINode::Create</a>(<a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getType(), 2, </Highlight><Highlight kind="stringliteral">&quot;unswitched.select&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getIterator());</Highlight></CodeLine>
<Link id="l02728" /><CodeLine lineNumber="2728"><Highlight kind="normal">  Phi-&gt;addIncoming(<a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getTrueValue(), ThenBB);</Highlight></CodeLine>
<Link id="l02729" /><CodeLine lineNumber="2729"><Highlight kind="normal">  Phi-&gt;addIncoming(<a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getFalseValue(), HeadBB);</Highlight></CodeLine>
<Link id="l02730" /><CodeLine lineNumber="2730"><Highlight kind="normal">  Phi-&gt;setDebugLoc(<a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getDebugLoc());</Highlight></CodeLine>
<Link id="l02731" /><CodeLine lineNumber="2731"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;replaceAllUsesWith(Phi);</Highlight></CodeLine>
<Link id="l02732" /><CodeLine lineNumber="2732"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;eraseFromParent();</Highlight></CodeLine>
<Link id="l02733" /><CodeLine lineNumber="2733"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02734" /><CodeLine lineNumber="2734"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU &amp;&amp; <a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l02735" /><CodeLine lineNumber="2735"><Highlight kind="normal">    MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a01a350909e784d6fa43181a72de61529">getMemorySSA</a>()-&gt;<a href="/docs/api/classes/llvm/memoryssa/#a88b10d37f671e58cf138ac84a8257c17">verifyMemorySSA</a>();</Highlight></CodeLine>
<Link id="l02736" /><CodeLine lineNumber="2736"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02737" /><CodeLine lineNumber="2737"><Highlight kind="normal">  ++NumSelects;</Highlight></CodeLine>
<Link id="l02738" /><CodeLine lineNumber="2738"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> CondBr;</Highlight></CodeLine>
<Link id="l02739" /><CodeLine lineNumber="2739"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l02740" /><CodeLine lineNumber="2740"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l02741" /><CodeLine lineNumber="2741"><Highlight kind="comment">/// Turns a llvm.experimental.guard intrinsic into implicit control flow branch,</Highlight></CodeLine>
<Link id="l02742" /><CodeLine lineNumber="2742"><Highlight kind="comment">/// making the following replacement:</Highlight></CodeLine>
<Link id="l02743" /><CodeLine lineNumber="2743"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02744" /><CodeLine lineNumber="2744"><Highlight kind="comment">///   --code before guard--</Highlight></CodeLine>
<Link id="l02745" /><CodeLine lineNumber="2745"><Highlight kind="comment">///   call void (i1, ...) @llvm.experimental.guard(i1 %cond) &#91; &quot;deopt&quot;() &#93;</Highlight></CodeLine>
<Link id="l02746" /><CodeLine lineNumber="2746"><Highlight kind="comment">///   --code after guard--</Highlight></CodeLine>
<Link id="l02747" /><CodeLine lineNumber="2747"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02748" /><CodeLine lineNumber="2748"><Highlight kind="comment">/// into</Highlight></CodeLine>
<Link id="l02749" /><CodeLine lineNumber="2749"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02750" /><CodeLine lineNumber="2750"><Highlight kind="comment">///   --code before guard--</Highlight></CodeLine>
<Link id="l02751" /><CodeLine lineNumber="2751"><Highlight kind="comment">///   br i1 %cond, label %guarded, label %deopt</Highlight></CodeLine>
<Link id="l02752" /><CodeLine lineNumber="2752"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02753" /><CodeLine lineNumber="2753"><Highlight kind="comment">/// guarded:</Highlight></CodeLine>
<Link id="l02754" /><CodeLine lineNumber="2754"><Highlight kind="comment">///   --code after guard--</Highlight></CodeLine>
<Link id="l02755" /><CodeLine lineNumber="2755"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02756" /><CodeLine lineNumber="2756"><Highlight kind="comment">/// deopt:</Highlight></CodeLine>
<Link id="l02757" /><CodeLine lineNumber="2757"><Highlight kind="comment">///   call void (i1, ...) @llvm.experimental.guard(i1 false) &#91; &quot;deopt&quot;() &#93;</Highlight></CodeLine>
<Link id="l02758" /><CodeLine lineNumber="2758"><Highlight kind="comment">///   unreachable</Highlight></CodeLine>
<Link id="l02759" /><CodeLine lineNumber="2759"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02760" /><CodeLine lineNumber="2760"><Highlight kind="comment">/// It also makes all relevant DT and LI updates, so that all structures are in</Highlight></CodeLine>
<Link id="l02761" /><CodeLine lineNumber="2761"><Highlight kind="comment">/// valid state after this transform.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02762" /><CodeLine lineNumber="2762" lineLink="#af3ac46dde637293a34d0ff7b619a656b"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;<a href="#af3ac46dde637293a34d0ff7b619a656b">turnGuardIntoBranch</a>(<a href="/docs/api/classes/llvm/intrinsicinst">IntrinsicInst</a> &#42;GI, <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L,</Highlight></CodeLine>
<Link id="l02763" /><CodeLine lineNumber="2763"><Highlight kind="normal">                                       <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI,</Highlight></CodeLine>
<Link id="l02764" /><CodeLine lineNumber="2764"><Highlight kind="normal">                                       <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42;MSSAU) &#123;</Highlight></CodeLine>
<Link id="l02765" /><CodeLine lineNumber="2765"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;DominatorTree::UpdateType, 4&gt;</a> DTUpdates;</Highlight></CodeLine>
<Link id="l02766" /><CodeLine lineNumber="2766"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Turning &quot;</Highlight><Highlight kind="normal"> &lt;&lt; &#42;GI &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; into a branch.\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02767" /><CodeLine lineNumber="2767"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;CheckBB = GI-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>();</Highlight></CodeLine>
<Link id="l02768" /><CodeLine lineNumber="2768"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02769" /><CodeLine lineNumber="2769"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU &amp;&amp; <a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l02770" /><CodeLine lineNumber="2770"><Highlight kind="normal">     MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a01a350909e784d6fa43181a72de61529">getMemorySSA</a>()-&gt;<a href="/docs/api/classes/llvm/memoryssa/#a88b10d37f671e58cf138ac84a8257c17">verifyMemorySSA</a>();</Highlight></CodeLine>
<Link id="l02771" /><CodeLine lineNumber="2771"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02772" /><CodeLine lineNumber="2772"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/domtreeupdater">DomTreeUpdater</a> DTU(DT, DomTreeUpdater::UpdateStrategy::Eager);</Highlight></CodeLine>
<Link id="l02773" /><CodeLine lineNumber="2773"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;DeoptBlockTerm =</Highlight></CodeLine>
<Link id="l02774" /><CodeLine lineNumber="2774"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#ad957413955739c91204c96e33e0cc933">SplitBlockAndInsertIfThen</a>(GI-&gt;<a href="/docs/api/classes/llvm/callbase/#aabd76e6a8a23a5af1ce4d3c310d88bcd">getArgOperand</a>(0), GI, </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l02775" /><CodeLine lineNumber="2775"><Highlight kind="normal">                                GI-&gt;<a href="/docs/api/classes/llvm/instruction/#a6c09737e146b2d816c911a047ac67ba4">getMetadata</a>(LLVMContext::MD&#95;prof), &amp;DTU, &amp;LI);</Highlight></CodeLine>
<Link id="l02776" /><CodeLine lineNumber="2776"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;CheckBI = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BranchInst&gt;</a>(CheckBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l02777" /><CodeLine lineNumber="2777"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// SplitBlockAndInsertIfThen inserts control flow that branches to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02778" /><CodeLine lineNumber="2778"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// DeoptBlockTerm if the condition is true.  We want the opposite.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02779" /><CodeLine lineNumber="2779"><Highlight kind="normal">  CheckBI-&gt;<a href="/docs/api/classes/llvm/branchinst/#a6550fe5bd437c1c3c6e237d726e36b90">swapSuccessors</a>();</Highlight></CodeLine>
<Link id="l02780" /><CodeLine lineNumber="2780"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02781" /><CodeLine lineNumber="2781"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;GuardedBlock = CheckBI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(0);</Highlight></CodeLine>
<Link id="l02782" /><CodeLine lineNumber="2782"><Highlight kind="normal">  GuardedBlock-&gt;<a href="/docs/api/classes/llvm/value/#a35ee267850af7c235474a8c46c7ac5af">setName</a>(</Highlight><Highlight kind="stringliteral">&quot;guarded&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02783" /><CodeLine lineNumber="2783"><Highlight kind="normal">  CheckBI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(1)-&gt;<a href="/docs/api/classes/llvm/value/#a35ee267850af7c235474a8c46c7ac5af">setName</a>(</Highlight><Highlight kind="stringliteral">&quot;deopt&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02784" /><CodeLine lineNumber="2784"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;DeoptBlock = CheckBI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(1);</Highlight></CodeLine>
<Link id="l02785" /><CodeLine lineNumber="2785"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02786" /><CodeLine lineNumber="2786"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU)</Highlight></CodeLine>
<Link id="l02787" /><CodeLine lineNumber="2787"><Highlight kind="normal">    MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#aa7518e6d6d74227a56b36eb88cfe26e6">moveAllAfterSpliceBlocks</a>(CheckBB, GuardedBlock, GI);</Highlight></CodeLine>
<Link id="l02788" /><CodeLine lineNumber="2788"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02789" /><CodeLine lineNumber="2789"><Highlight kind="normal">  GI-&gt;<a href="/docs/api/classes/llvm/instruction/#af67d1f3a518964d80a109bb3d9d5cf1e">moveBefore</a>(DeoptBlockTerm-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>());</Highlight></CodeLine>
<Link id="l02790" /><CodeLine lineNumber="2790"><Highlight kind="normal">  GI-&gt;<a href="/docs/api/classes/llvm/callbase/#abc10b887caad109288ffceb230493a85">setArgOperand</a>(0, <a href="/docs/api/classes/llvm/constantint/#aa7cce62ac5cc6df09cce0535874336b7">ConstantInt::getFalse</a>(GI-&gt;<a href="/docs/api/classes/llvm/value/#ab3fc0225d8aaf8434026c3573f961f2c">getContext</a>()));</Highlight></CodeLine>
<Link id="l02791" /><CodeLine lineNumber="2791"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02792" /><CodeLine lineNumber="2792"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU) &#123;</Highlight></CodeLine>
<Link id="l02793" /><CodeLine lineNumber="2793"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/memorydef">MemoryDef</a> &#42;MD = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;MemoryDef&gt;</a>(MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a01a350909e784d6fa43181a72de61529">getMemorySSA</a>()-&gt;<a href="/docs/api/classes/llvm/memoryssa/#ab15de610fca1c900038bf3c333919e45">getMemoryAccess</a>(GI));</Highlight></CodeLine>
<Link id="l02794" /><CodeLine lineNumber="2794"><Highlight kind="normal">    MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#ae26e0fb4a78dc439a03ac42c4ba6e674">moveToPlace</a>(MD, DeoptBlock, <a href="/docs/api/classes/llvm/memoryssa/#a9773fde54683945b9e34a0f2e5c1a5a5a7806c120eb87aea9fbb52fed327e09de">MemorySSA::BeforeTerminator</a>);</Highlight></CodeLine>
<Link id="l02795" /><CodeLine lineNumber="2795"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l02796" /><CodeLine lineNumber="2796"><Highlight kind="normal">      MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a01a350909e784d6fa43181a72de61529">getMemorySSA</a>()-&gt;<a href="/docs/api/classes/llvm/memoryssa/#a88b10d37f671e58cf138ac84a8257c17">verifyMemorySSA</a>();</Highlight></CodeLine>
<Link id="l02797" /><CodeLine lineNumber="2797"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02798" /><CodeLine lineNumber="2798"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02799" /><CodeLine lineNumber="2799"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a8bf0b85d705bf73d1af85056ef77b9c5">VerifyLoopInfo</a>)</Highlight></CodeLine>
<Link id="l02800" /><CodeLine lineNumber="2800"><Highlight kind="normal">    LI.<a href="/docs/api/classes/llvm/loopinfobase/#a17a8f7aba5cca5c7f9faa779a3c4bc37">verify</a>(DT);</Highlight></CodeLine>
<Link id="l02801" /><CodeLine lineNumber="2801"><Highlight kind="normal">  ++NumGuards;</Highlight></CodeLine>
<Link id="l02802" /><CodeLine lineNumber="2802"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> CheckBI;</Highlight></CodeLine>
<Link id="l02803" /><CodeLine lineNumber="2803"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l02804" /><CodeLine lineNumber="2804"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l02805" /><CodeLine lineNumber="2805"><Highlight kind="comment">/// Cost multiplier is a way to limit potentially exponential behavior</Highlight></CodeLine>
<Link id="l02806" /><CodeLine lineNumber="2806"><Highlight kind="comment">/// of loop-unswitch. Cost is multipied in proportion of 2^number of unswitch</Highlight></CodeLine>
<Link id="l02807" /><CodeLine lineNumber="2807"><Highlight kind="comment">/// candidates available. Also accounting for the number of &quot;sibling&quot; loops with</Highlight></CodeLine>
<Link id="l02808" /><CodeLine lineNumber="2808"><Highlight kind="comment">/// the idea to account for previous unswitches that already happened on this</Highlight></CodeLine>
<Link id="l02809" /><CodeLine lineNumber="2809"><Highlight kind="comment">/// cluster of loops. There was an attempt to keep this formula simple,</Highlight></CodeLine>
<Link id="l02810" /><CodeLine lineNumber="2810"><Highlight kind="comment">/// just enough to limit the worst case behavior. Even if it is not that simple</Highlight></CodeLine>
<Link id="l02811" /><CodeLine lineNumber="2811"><Highlight kind="comment">/// now it is still not an attempt to provide a detailed heuristic size</Highlight></CodeLine>
<Link id="l02812" /><CodeLine lineNumber="2812"><Highlight kind="comment">/// prediction.</Highlight></CodeLine>
<Link id="l02813" /><CodeLine lineNumber="2813"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02814" /><CodeLine lineNumber="2814"><Highlight kind="comment">/// TODO: Make a proper accounting of &quot;explosion&quot; effect for all kinds of</Highlight></CodeLine>
<Link id="l02815" /><CodeLine lineNumber="2815"><Highlight kind="comment">/// unswitch candidates, making adequate predictions instead of wild guesses.</Highlight></CodeLine>
<Link id="l02816" /><CodeLine lineNumber="2816"><Highlight kind="comment">/// That requires knowing not just the number of &quot;remaining&quot; candidates but</Highlight></CodeLine>
<Link id="l02817" /><CodeLine lineNumber="2817"><Highlight kind="comment">/// also costs of unswitching for each of these candidates.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02818" /><CodeLine lineNumber="2818" lineLink="#a0e686f0d790f0fd925a036c4cb50199b"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> <a href="#a0e686f0d790f0fd925a036c4cb50199b">CalculateUnswitchCostMultiplier</a>(</Highlight></CodeLine>
<Link id="l02819" /><CodeLine lineNumber="2819"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;TI, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI,</Highlight></CodeLine>
<Link id="l02820" /><CodeLine lineNumber="2820"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT,</Highlight></CodeLine>
<Link id="l02821" /><CodeLine lineNumber="2821"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;NonTrivialUnswitchCandidate&gt;</a> UnswitchCandidates) &#123;</Highlight></CodeLine>
<Link id="l02822" /><CodeLine lineNumber="2822"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02823" /><CodeLine lineNumber="2823"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Guards and other exiting conditions do not contribute to exponential</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02824" /><CodeLine lineNumber="2824"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// explosion as soon as they dominate the latch (otherwise there might be</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02825" /><CodeLine lineNumber="2825"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// another path to the latch remaining that does not allow to eliminate the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02826" /><CodeLine lineNumber="2826"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// loop copy on unswitch).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02827" /><CodeLine lineNumber="2827"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Latch = L.getLoopLatch();</Highlight></CodeLine>
<Link id="l02828" /><CodeLine lineNumber="2828"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;CondBlock = TI.<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>();</Highlight></CodeLine>
<Link id="l02829" /><CodeLine lineNumber="2829"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DT.<a href="/docs/api/classes/llvm/dominatortree/#a5c69311e8d44898dac36a155c3d8691d">dominates</a>(CondBlock, Latch) &amp;&amp;</Highlight></CodeLine>
<Link id="l02830" /><CodeLine lineNumber="2830"><Highlight kind="normal">      (<a href="/docs/api/namespaces/llvm/#a656efdcee3deb029763304d3e741a2d1">isGuard</a>(&amp;TI) ||</Highlight></CodeLine>
<Link id="l02831" /><CodeLine lineNumber="2831"><Highlight kind="normal">       (TI.<a href="/docs/api/classes/llvm/instruction/#a7653277511df1034148a37520a585bb5">isTerminator</a>() &amp;&amp;</Highlight></CodeLine>
<Link id="l02832" /><CodeLine lineNumber="2832"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#ac214df91cdc242f4710ea5a93939c678">llvm::count&#95;if</a>(<a href="/docs/api/namespaces/llvm/#a26e2a938b431eaa6eca2beaa96410c9d">successors</a>(&amp;TI), &#91;&amp;L&#93;(</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;SuccBB) &#123;</Highlight></CodeLine>
<Link id="l02833" /><CodeLine lineNumber="2833"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> L.contains(SuccBB);</Highlight></CodeLine>
<Link id="l02834" /><CodeLine lineNumber="2834"><Highlight kind="normal">        &#125;) &lt;= 1))) &#123;</Highlight></CodeLine>
<Link id="l02835" /><CodeLine lineNumber="2835"><Highlight kind="normal">    NumCostMultiplierSkipped++;</Highlight></CodeLine>
<Link id="l02836" /><CodeLine lineNumber="2836"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> 1;</Highlight></CodeLine>
<Link id="l02837" /><CodeLine lineNumber="2837"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02838" /><CodeLine lineNumber="2838"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02839" /><CodeLine lineNumber="2839"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ParentL = L.getParentLoop();</Highlight></CodeLine>
<Link id="l02840" /><CodeLine lineNumber="2840"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> SiblingsCount = (ParentL ? ParentL-&gt;getSubLoopsVector().<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmreflect-cpp/#ac934769d93af95250952646a3829df4c">size</a>()</Highlight></CodeLine>
<Link id="l02841" /><CodeLine lineNumber="2841"><Highlight kind="normal">                               : std::distance(LI.<a href="/docs/api/classes/llvm/loopinfobase/#ab447b41b9c51151b5c6ef497a60689ae">begin</a>(), LI.<a href="/docs/api/classes/llvm/loopinfobase/#a4f728602e7d377829675f13446cf6647">end</a>()));</Highlight></CodeLine>
<Link id="l02842" /><CodeLine lineNumber="2842"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Count amount of clones that all the candidates might cause during</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02843" /><CodeLine lineNumber="2843"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// unswitching. Branch/guard/select counts as 1, switch counts as log2 of its</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02844" /><CodeLine lineNumber="2844"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// cases.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02845" /><CodeLine lineNumber="2845"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> UnswitchedClones = 0;</Highlight></CodeLine>
<Link id="l02846" /><CodeLine lineNumber="2846"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;Candidate : UnswitchCandidates) &#123;</Highlight></CodeLine>
<Link id="l02847" /><CodeLine lineNumber="2847"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;CI = Candidate.TI;</Highlight></CodeLine>
<Link id="l02848" /><CodeLine lineNumber="2848"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;CondBlock = CI-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>();</Highlight></CodeLine>
<Link id="l02849" /><CodeLine lineNumber="2849"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> SkipExitingSuccessors = DT.<a href="/docs/api/classes/llvm/dominatortree/#a5c69311e8d44898dac36a155c3d8691d">dominates</a>(CondBlock, Latch);</Highlight></CodeLine>
<Link id="l02850" /><CodeLine lineNumber="2850"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;SelectInst&gt;</a>(CI)) &#123;</Highlight></CodeLine>
<Link id="l02851" /><CodeLine lineNumber="2851"><Highlight kind="normal">      UnswitchedClones++;</Highlight></CodeLine>
<Link id="l02852" /><CodeLine lineNumber="2852"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02853" /><CodeLine lineNumber="2853"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l02854" /><CodeLine lineNumber="2854"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a656efdcee3deb029763304d3e741a2d1">isGuard</a>(CI)) &#123;</Highlight></CodeLine>
<Link id="l02855" /><CodeLine lineNumber="2855"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!SkipExitingSuccessors)</Highlight></CodeLine>
<Link id="l02856" /><CodeLine lineNumber="2856"><Highlight kind="normal">        UnswitchedClones++;</Highlight></CodeLine>
<Link id="l02857" /><CodeLine lineNumber="2857"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02858" /><CodeLine lineNumber="2858"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l02859" /><CodeLine lineNumber="2859"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> NonExitingSuccessors =</Highlight></CodeLine>
<Link id="l02860" /><CodeLine lineNumber="2860"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#ac214df91cdc242f4710ea5a93939c678">llvm::count&#95;if</a>(<a href="/docs/api/namespaces/llvm/#a26e2a938b431eaa6eca2beaa96410c9d">successors</a>(CondBlock),</Highlight></CodeLine>
<Link id="l02861" /><CodeLine lineNumber="2861"><Highlight kind="normal">                       &#91;SkipExitingSuccessors, &amp;L&#93;(</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;SuccBB) &#123;</Highlight></CodeLine>
<Link id="l02862" /><CodeLine lineNumber="2862"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> !SkipExitingSuccessors || L.contains(SuccBB);</Highlight></CodeLine>
<Link id="l02863" /><CodeLine lineNumber="2863"><Highlight kind="normal">        &#125;);</Highlight></CodeLine>
<Link id="l02864" /><CodeLine lineNumber="2864"><Highlight kind="normal">    UnswitchedClones += <a href="/docs/api/namespaces/llvm/#a646986783f35e0fef8988f0f28d2589f">Log2&#95;32</a>(NonExitingSuccessors);</Highlight></CodeLine>
<Link id="l02865" /><CodeLine lineNumber="2865"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02866" /><CodeLine lineNumber="2866"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02867" /><CodeLine lineNumber="2867"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Ignore up to the &quot;unscaled candidates&quot; number of unswitch candidates</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02868" /><CodeLine lineNumber="2868"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// when calculating the power-of-two scaling of the cost. The main idea</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02869" /><CodeLine lineNumber="2869"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// with this control is to allow a small number of unswitches to happen</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02870" /><CodeLine lineNumber="2870"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// and rely more on siblings multiplier (see below) when the number</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02871" /><CodeLine lineNumber="2871"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// of candidates is small.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02872" /><CodeLine lineNumber="2872"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> ClonesPower =</Highlight></CodeLine>
<Link id="l02873" /><CodeLine lineNumber="2873"><Highlight kind="normal">      std::max(UnswitchedClones - (</Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal">)<a href="#a49834115bcfb38ad510305e2e587f67a">UnswitchNumInitialUnscaledCandidates</a>, 0);</Highlight></CodeLine>
<Link id="l02874" /><CodeLine lineNumber="2874"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02875" /><CodeLine lineNumber="2875"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Allowing top-level loops to spread a bit more than nested ones.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02876" /><CodeLine lineNumber="2876"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> SiblingsMultiplier =</Highlight></CodeLine>
<Link id="l02877" /><CodeLine lineNumber="2877"><Highlight kind="normal">      std::max((ParentL ? SiblingsCount</Highlight></CodeLine>
<Link id="l02878" /><CodeLine lineNumber="2878"><Highlight kind="normal">                        : SiblingsCount / (</Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal">)<a href="#a8ec915a44f00522e05af0372fe598372">UnswitchSiblingsToplevelDiv</a>),</Highlight></CodeLine>
<Link id="l02879" /><CodeLine lineNumber="2879"><Highlight kind="normal">               1);</Highlight></CodeLine>
<Link id="l02880" /><CodeLine lineNumber="2880"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Compute the cost multiplier in a way that won&#39;t overflow by saturating</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02881" /><CodeLine lineNumber="2881"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// at an upper bound.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02882" /><CodeLine lineNumber="2882"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> CostMultiplier;</Highlight></CodeLine>
<Link id="l02883" /><CodeLine lineNumber="2883"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (ClonesPower &gt; <a href="/docs/api/namespaces/llvm/#a646986783f35e0fef8988f0f28d2589f">Log2&#95;32</a>(<a href="#a639210c26d1952e9108bcdbb0353443b">UnswitchThreshold</a>) ||</Highlight></CodeLine>
<Link id="l02884" /><CodeLine lineNumber="2884"><Highlight kind="normal">      SiblingsMultiplier &gt; <a href="#a639210c26d1952e9108bcdbb0353443b">UnswitchThreshold</a>)</Highlight></CodeLine>
<Link id="l02885" /><CodeLine lineNumber="2885"><Highlight kind="normal">    CostMultiplier = <a href="#a639210c26d1952e9108bcdbb0353443b">UnswitchThreshold</a>;</Highlight></CodeLine>
<Link id="l02886" /><CodeLine lineNumber="2886"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02887" /><CodeLine lineNumber="2887"><Highlight kind="normal">    CostMultiplier = std::min(SiblingsMultiplier &#42; (1 &lt;&lt; ClonesPower),</Highlight></CodeLine>
<Link id="l02888" /><CodeLine lineNumber="2888"><Highlight kind="normal">                              (</Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal">)<a href="#a639210c26d1952e9108bcdbb0353443b">UnswitchThreshold</a>);</Highlight></CodeLine>
<Link id="l02889" /><CodeLine lineNumber="2889"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02890" /><CodeLine lineNumber="2890"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Computed multiplier  &quot;</Highlight><Highlight kind="normal"> &lt;&lt; CostMultiplier</Highlight></CodeLine>
<Link id="l02891" /><CodeLine lineNumber="2891"><Highlight kind="normal">                    &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; (siblings &quot;</Highlight><Highlight kind="normal"> &lt;&lt; SiblingsMultiplier &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; &#42; clones &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02892" /><CodeLine lineNumber="2892"><Highlight kind="normal">                    &lt;&lt; (1 &lt;&lt; ClonesPower) &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;)&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02893" /><CodeLine lineNumber="2893"><Highlight kind="normal">                    &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; for unswitch candidate: &quot;</Highlight><Highlight kind="normal"> &lt;&lt; TI &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02894" /><CodeLine lineNumber="2894"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> CostMultiplier;</Highlight></CodeLine>
<Link id="l02895" /><CodeLine lineNumber="2895"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l02896" /><CodeLine lineNumber="2896"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02897" /><CodeLine lineNumber="2897" lineLink="#a7737deb6a166cd21dc8465bb48f110b2"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a7737deb6a166cd21dc8465bb48f110b2">collectUnswitchCandidates</a>(</Highlight></CodeLine>
<Link id="l02898" /><CodeLine lineNumber="2898"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;NonTrivialUnswitchCandidate&gt;</a> &amp;UnswitchCandidates,</Highlight></CodeLine>
<Link id="l02899" /><CodeLine lineNumber="2899"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/ivconditioninfo">IVConditionInfo</a> &amp;PartialIVInfo, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;&amp;PartialIVCondBranch,</Highlight></CodeLine>
<Link id="l02900" /><CodeLine lineNumber="2900"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI, <a href="/docs/api/classes/llvm/aaresults">AAResults</a> &amp;<a href="/docs/api/namespaces/llvm/aa">AA</a>,</Highlight></CodeLine>
<Link id="l02901" /><CodeLine lineNumber="2901"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42;MSSAU) &#123;</Highlight></CodeLine>
<Link id="l02902" /><CodeLine lineNumber="2902"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(UnswitchCandidates.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Should be!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02903" /><CodeLine lineNumber="2903"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02904" /><CodeLine lineNumber="2904"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> AddUnswitchCandidatesForInst = &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>) &#123;</Highlight></CodeLine>
<Link id="l02905" /><CodeLine lineNumber="2905"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a> = <a href="#a5ca2e820d1b5a49dcaad5e6873917198">skipTrivialSelect</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>);</Highlight></CodeLine>
<Link id="l02906" /><CodeLine lineNumber="2906"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;Constant&gt;</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>))</Highlight></CodeLine>
<Link id="l02907" /><CodeLine lineNumber="2907"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02908" /><CodeLine lineNumber="2908"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L.isLoopInvariant(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>)) &#123;</Highlight></CodeLine>
<Link id="l02909" /><CodeLine lineNumber="2909"><Highlight kind="normal">      UnswitchCandidates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, &#123;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>&#125;&#125;);</Highlight></CodeLine>
<Link id="l02910" /><CodeLine lineNumber="2910"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02911" /><CodeLine lineNumber="2911"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l02912" /><CodeLine lineNumber="2912"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, <a href="/docs/api/namespaces/llvm/patternmatch/#afc43bc5ec4b20c7c5d663bef90da6066">m&#95;CombineOr</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#acf8c16eed89e5ee1a10b6dfc08a33b3a">m&#95;LogicalAnd</a>(), <a href="/docs/api/namespaces/llvm/patternmatch/#a5cce7a41c7581ff15a23ab90eb3b403a">m&#95;LogicalOr</a>()))) &#123;</Highlight></CodeLine>
<Link id="l02913" /><CodeLine lineNumber="2913"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/tinyptrvector">TinyPtrVector&lt;Value &#42;&gt;</a> Invariants =</Highlight></CodeLine>
<Link id="l02914" /><CodeLine lineNumber="2914"><Highlight kind="normal">          <a href="#a1061b839196c8068b89d05aced41de29">collectHomogenousInstGraphLoopInvariants</a>(</Highlight></CodeLine>
<Link id="l02915" /><CodeLine lineNumber="2915"><Highlight kind="normal">              L, &#42;</Highlight><Highlight kind="keyword">static&#95;cast&lt;</Highlight><Highlight kind="normal"><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;</Highlight><Highlight kind="keyword">&gt;</Highlight><Highlight kind="normal">(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>), LI);</Highlight></CodeLine>
<Link id="l02916" /><CodeLine lineNumber="2916"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!Invariants.<a href="/docs/api/classes/llvm/tinyptrvector/#a9dc659b723e6725130ad354ed821d400">empty</a>())</Highlight></CodeLine>
<Link id="l02917" /><CodeLine lineNumber="2917"><Highlight kind="normal">        UnswitchCandidates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, std::move(Invariants)&#125;);</Highlight></CodeLine>
<Link id="l02918" /><CodeLine lineNumber="2918"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l02919" /><CodeLine lineNumber="2919"><Highlight kind="normal">  &#125;;</Highlight></CodeLine>
<Link id="l02920" /><CodeLine lineNumber="2920"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02921" /><CodeLine lineNumber="2921"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Whether or not we should also collect guards in the loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02922" /><CodeLine lineNumber="2922"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> CollectGuards = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02923" /><CodeLine lineNumber="2923"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#a0986070d3233b98011a6bd838a65f1cb">UnswitchGuards</a>) &#123;</Highlight></CodeLine>
<Link id="l02924" /><CodeLine lineNumber="2924"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;GuardDecl = <a href="/docs/api/namespaces/llvm/intrinsic/#aa1731508126b77035ab3ba9d71d5374b">Intrinsic::getDeclarationIfExists</a>(</Highlight></CodeLine>
<Link id="l02925" /><CodeLine lineNumber="2925"><Highlight kind="normal">        L.getHeader()-&gt;getParent()-&gt;getParent(), Intrinsic::experimental&#95;guard);</Highlight></CodeLine>
<Link id="l02926" /><CodeLine lineNumber="2926"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (GuardDecl &amp;&amp; !GuardDecl-&gt;use&#95;empty())</Highlight></CodeLine>
<Link id="l02927" /><CodeLine lineNumber="2927"><Highlight kind="normal">      CollectGuards = </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02928" /><CodeLine lineNumber="2928"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02929" /><CodeLine lineNumber="2929"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02930" /><CodeLine lineNumber="2930"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB : L.blocks()) &#123;</Highlight></CodeLine>
<Link id="l02931" /><CodeLine lineNumber="2931"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (LI.<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(BB) != &amp;L)</Highlight></CodeLine>
<Link id="l02932" /><CodeLine lineNumber="2932"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02933" /><CodeLine lineNumber="2933"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02934" /><CodeLine lineNumber="2934"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : &#42;BB) &#123;</Highlight></CodeLine>
<Link id="l02935" /><CodeLine lineNumber="2935"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;<a href="/docs/api/namespaces/llvm/si">SI</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;SelectInst&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) &#123;</Highlight></CodeLine>
<Link id="l02936" /><CodeLine lineNumber="2936"><Highlight kind="normal">        </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a> = <a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getCondition();</Highlight></CodeLine>
<Link id="l02937" /><CodeLine lineNumber="2937"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Do not unswitch vector selects and logical and/or selects</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02938" /><CodeLine lineNumber="2938"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>-&gt;getType()-&gt;isIntegerTy(1) &amp;&amp; !<a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getType()-&gt;isIntegerTy(1))</Highlight></CodeLine>
<Link id="l02939" /><CodeLine lineNumber="2939"><Highlight kind="normal">          AddUnswitchCandidatesForInst(<a href="/docs/api/namespaces/llvm/si">SI</a>, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>);</Highlight></CodeLine>
<Link id="l02940" /><CodeLine lineNumber="2940"><Highlight kind="normal">      &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (CollectGuards &amp;&amp; <a href="/docs/api/namespaces/llvm/#a656efdcee3deb029763304d3e741a2d1">isGuard</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) &#123;</Highlight></CodeLine>
<Link id="l02941" /><CodeLine lineNumber="2941"><Highlight kind="normal">        </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a> =</Highlight></CodeLine>
<Link id="l02942" /><CodeLine lineNumber="2942"><Highlight kind="normal">            <a href="#a5ca2e820d1b5a49dcaad5e6873917198">skipTrivialSelect</a>(<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;IntrinsicInst&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)-&gt;getArgOperand(0));</Highlight></CodeLine>
<Link id="l02943" /><CodeLine lineNumber="2943"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// TODO: Support AND, OR conditions and partial unswitching.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02944" /><CodeLine lineNumber="2944"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;Constant&gt;</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>) &amp;&amp; L.isLoopInvariant(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>))</Highlight></CodeLine>
<Link id="l02945" /><CodeLine lineNumber="2945"><Highlight kind="normal">          UnswitchCandidates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, &#123;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>&#125;&#125;);</Highlight></CodeLine>
<Link id="l02946" /><CodeLine lineNumber="2946"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l02947" /><CodeLine lineNumber="2947"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l02948" /><CodeLine lineNumber="2948"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02949" /><CodeLine lineNumber="2949"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;<a href="/docs/api/namespaces/llvm/si">SI</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;SwitchInst&gt;</a>(BB-&gt;getTerminator())) &#123;</Highlight></CodeLine>
<Link id="l02950" /><CodeLine lineNumber="2950"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We can only consider fully loop-invariant switch conditions as we need</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02951" /><CodeLine lineNumber="2951"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// to completely eliminate the switch after unswitching.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02952" /><CodeLine lineNumber="2952"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;Constant&gt;</a>(<a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getCondition()) &amp;&amp;</Highlight></CodeLine>
<Link id="l02953" /><CodeLine lineNumber="2953"><Highlight kind="normal">          L.isLoopInvariant(<a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getCondition()) &amp;&amp; !BB-&gt;getUniqueSuccessor())</Highlight></CodeLine>
<Link id="l02954" /><CodeLine lineNumber="2954"><Highlight kind="normal">        UnswitchCandidates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;<a href="/docs/api/namespaces/llvm/si">SI</a>, &#123;<a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getCondition()&#125;&#125;);</Highlight></CodeLine>
<Link id="l02955" /><CodeLine lineNumber="2955"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02956" /><CodeLine lineNumber="2956"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l02957" /><CodeLine lineNumber="2957"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02958" /><CodeLine lineNumber="2958"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BranchInst&gt;</a>(BB-&gt;getTerminator());</Highlight></CodeLine>
<Link id="l02959" /><CodeLine lineNumber="2959"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!BI || !BI-&gt;isConditional() ||</Highlight></CodeLine>
<Link id="l02960" /><CodeLine lineNumber="2960"><Highlight kind="normal">        BI-&gt;getSuccessor(0) == BI-&gt;getSuccessor(1))</Highlight></CodeLine>
<Link id="l02961" /><CodeLine lineNumber="2961"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02962" /><CodeLine lineNumber="2962"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02963" /><CodeLine lineNumber="2963"><Highlight kind="normal">    AddUnswitchCandidatesForInst(BI, BI-&gt;getCondition());</Highlight></CodeLine>
<Link id="l02964" /><CodeLine lineNumber="2964"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02965" /><CodeLine lineNumber="2965"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02966" /><CodeLine lineNumber="2966"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU &amp;&amp; !<a href="/docs/api/namespaces/llvm/#a3f91ce019424451ab50bf348826fa270">findOptionMDForLoop</a>(&amp;L, </Highlight><Highlight kind="stringliteral">&quot;llvm.loop.unswitch.partial.disable&quot;</Highlight><Highlight kind="normal">) &amp;&amp;</Highlight></CodeLine>
<Link id="l02967" /><CodeLine lineNumber="2967"><Highlight kind="normal">      !<a href="/docs/api/namespaces/llvm/#a61d13d6824ec46c31260a4fd0997eda0">any&#95;of</a>(UnswitchCandidates, &#91;&amp;L&#93;(</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;TerminatorAndInvariants) &#123;</Highlight></CodeLine>
<Link id="l02968" /><CodeLine lineNumber="2968"><Highlight kind="normal">         </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> TerminatorAndInvariants.TI == L.getHeader()-&gt;getTerminator();</Highlight></CodeLine>
<Link id="l02969" /><CodeLine lineNumber="2969"><Highlight kind="normal">       &#125;)) &#123;</Highlight></CodeLine>
<Link id="l02970" /><CodeLine lineNumber="2970"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/memoryssa">MemorySSA</a> &#42;MSSA = MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a01a350909e784d6fa43181a72de61529">getMemorySSA</a>();</Highlight></CodeLine>
<Link id="l02971" /><CodeLine lineNumber="2971"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a> = <a href="/docs/api/namespaces/llvm/#ae78f734e49b5ad94836bf32dda101ec6">hasPartialIVCondition</a>(L, <a href="#a93f97c549049a827518c9bce17a53833">MSSAThreshold</a>, &#42;MSSA, <a href="/docs/api/namespaces/llvm/aa">AA</a>)) &#123;</Highlight></CodeLine>
<Link id="l02972" /><CodeLine lineNumber="2972"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(</Highlight></CodeLine>
<Link id="l02973" /><CodeLine lineNumber="2973"><Highlight kind="normal">          <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;simple-loop-unswitch: Found partially invariant condition &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02974" /><CodeLine lineNumber="2974"><Highlight kind="normal">                 &lt;&lt; &#42;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>-&gt;InstToDuplicate&#91;0&#93; &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02975" /><CodeLine lineNumber="2975"><Highlight kind="normal">      PartialIVInfo = &#42;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>;</Highlight></CodeLine>
<Link id="l02976" /><CodeLine lineNumber="2976"><Highlight kind="normal">      PartialIVCondBranch = L.getHeader()-&gt;getTerminator();</Highlight></CodeLine>
<Link id="l02977" /><CodeLine lineNumber="2977"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/tinyptrvector">TinyPtrVector&lt;Value &#42;&gt;</a> ValsToDuplicate;</Highlight></CodeLine>
<Link id="l02978" /><CodeLine lineNumber="2978"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a39d3d23a084c4544ee5903203db10e8a">llvm::append&#95;range</a>(ValsToDuplicate, <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>-&gt;InstToDuplicate);</Highlight></CodeLine>
<Link id="l02979" /><CodeLine lineNumber="2979"><Highlight kind="normal">      UnswitchCandidates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(</Highlight></CodeLine>
<Link id="l02980" /><CodeLine lineNumber="2980"><Highlight kind="normal">          &#123;L.getHeader()-&gt;getTerminator(), std::move(ValsToDuplicate)&#125;);</Highlight></CodeLine>
<Link id="l02981" /><CodeLine lineNumber="2981"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l02982" /><CodeLine lineNumber="2982"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02983" /><CodeLine lineNumber="2983"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> !UnswitchCandidates.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>();</Highlight></CodeLine>
<Link id="l02984" /><CodeLine lineNumber="2984"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l02985" /><CodeLine lineNumber="2985"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l02986" /><CodeLine lineNumber="2986"><Highlight kind="comment">/// Tries to canonicalize condition described by:</Highlight></CodeLine>
<Link id="l02987" /><CodeLine lineNumber="2987"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02988" /><CodeLine lineNumber="2988"><Highlight kind="comment">///   br (LHS pred RHS), label IfTrue, label IfFalse</Highlight></CodeLine>
<Link id="l02989" /><CodeLine lineNumber="2989"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02990" /><CodeLine lineNumber="2990"><Highlight kind="comment">/// into its equivalent where &#96;Pred&#96; is something that we support for injected</Highlight></CodeLine>
<Link id="l02991" /><CodeLine lineNumber="2991"><Highlight kind="comment">/// invariants (so far it is limited to ult), LHS in canonicalized form is</Highlight></CodeLine>
<Link id="l02992" /><CodeLine lineNumber="2992"><Highlight kind="comment">/// non-invariant and RHS is an invariant.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02993" /><CodeLine lineNumber="2993" lineLink="#a94bc2ff14a27583461b207499f426ee2"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#a94bc2ff14a27583461b207499f426ee2">canonicalizeForInvariantConditionInjection</a>(<a href="/docs/api/classes/llvm/cmppredicate">CmpPredicate</a> &amp;Pred,</Highlight></CodeLine>
<Link id="l02994" /><CodeLine lineNumber="2994"><Highlight kind="normal">                                                       <a href="/docs/api/classes/llvm/value">Value</a> &#42;&amp;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>, <a href="/docs/api/classes/llvm/value">Value</a> &#42;&amp;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>,</Highlight></CodeLine>
<Link id="l02995" /><CodeLine lineNumber="2995"><Highlight kind="normal">                                                       <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;&amp;IfTrue,</Highlight></CodeLine>
<Link id="l02996" /><CodeLine lineNumber="2996"><Highlight kind="normal">                                                       <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;&amp;IfFalse,</Highlight></CodeLine>
<Link id="l02997" /><CodeLine lineNumber="2997"><Highlight kind="normal">                                                       </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L) &#123;</Highlight></CodeLine>
<Link id="l02998" /><CodeLine lineNumber="2998"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!L.contains(IfTrue)) &#123;</Highlight></CodeLine>
<Link id="l02999" /><CodeLine lineNumber="2999"><Highlight kind="normal">    Pred = <a href="/docs/api/classes/llvm/cmpinst/#aa2a54b545d237ecfe450fd1292f7675e">ICmpInst::getInversePredicate</a>(Pred);</Highlight></CodeLine>
<Link id="l03000" /><CodeLine lineNumber="3000"><Highlight kind="normal">    <a href="/docs/api/namespaces/std/#ab8424022895aee3e366fb9a32f2883cb">std::swap</a>(IfTrue, IfFalse);</Highlight></CodeLine>
<Link id="l03001" /><CodeLine lineNumber="3001"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l03002" /><CodeLine lineNumber="3002"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03003" /><CodeLine lineNumber="3003"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Move loop-invariant argument to RHS position.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03004" /><CodeLine lineNumber="3004"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L.isLoopInvariant(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>)) &#123;</Highlight></CodeLine>
<Link id="l03005" /><CodeLine lineNumber="3005"><Highlight kind="normal">    Pred = <a href="/docs/api/classes/llvm/cmpinst/#a49a2d8f483ea08a3d6ea75f90c640d76">ICmpInst::getSwappedPredicate</a>(Pred);</Highlight></CodeLine>
<Link id="l03006" /><CodeLine lineNumber="3006"><Highlight kind="normal">    <a href="/docs/api/namespaces/std/#ab8424022895aee3e366fb9a32f2883cb">std::swap</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>);</Highlight></CodeLine>
<Link id="l03007" /><CodeLine lineNumber="3007"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l03008" /><CodeLine lineNumber="3008"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03009" /><CodeLine lineNumber="3009"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Pred == <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78bac1aa7b798ba11d2e497d5cce6ce6d3dc">ICmpInst::ICMP&#95;SGE</a> &amp;&amp; <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>, <a href="/docs/api/namespaces/llvm/patternmatch/#ae77be336e228cf9aa00709a8606dfb98">m&#95;Zero</a>())) &#123;</Highlight></CodeLine>
<Link id="l03010" /><CodeLine lineNumber="3010"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Turn &quot;x &gt;=s 0&quot; into &quot;x &lt;u UMIN&#95;INT&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03011" /><CodeLine lineNumber="3011"><Highlight kind="normal">    Pred = <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78ba91d86a4753c8bd7624e01bf565d87f8e">ICmpInst::ICMP&#95;ULT</a>;</Highlight></CodeLine>
<Link id="l03012" /><CodeLine lineNumber="3012"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a> = ConstantInt::get(</Highlight></CodeLine>
<Link id="l03013" /><CodeLine lineNumber="3013"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>-&gt;getContext(),</Highlight></CodeLine>
<Link id="l03014" /><CodeLine lineNumber="3014"><Highlight kind="normal">        <a href="/docs/api/classes/llvm/apint/#a8f877403433892e14ff0c692cbe9efdf">APInt::getSignedMinValue</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>-&gt;getType()-&gt;getIntegerBitWidth()));</Highlight></CodeLine>
<Link id="l03015" /><CodeLine lineNumber="3015"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l03016" /><CodeLine lineNumber="3016"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l03017" /><CodeLine lineNumber="3017"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l03018" /><CodeLine lineNumber="3018"><Highlight kind="comment">/// Returns true, if predicate described by ( \\p Pred, \\p LHS, \\p RHS )</Highlight></CodeLine>
<Link id="l03019" /><CodeLine lineNumber="3019"><Highlight kind="comment">/// succeeding into blocks ( \\p IfTrue, \\p IfFalse) can be optimized by</Highlight></CodeLine>
<Link id="l03020" /><CodeLine lineNumber="3020"><Highlight kind="comment">/// injecting a loop-invariant condition.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03021" /><CodeLine lineNumber="3021" lineLink="#a4cbb86574a065a122292322ed4e27b0e"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a4cbb86574a065a122292322ed4e27b0e">shouldTryInjectInvariantCondition</a>(</Highlight></CodeLine>
<Link id="l03022" /><CodeLine lineNumber="3022"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78b">ICmpInst::Predicate</a> Pred, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>,</Highlight></CodeLine>
<Link id="l03023" /><CodeLine lineNumber="3023"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;IfTrue, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;IfFalse, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L) &#123;</Highlight></CodeLine>
<Link id="l03024" /><CodeLine lineNumber="3024"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L.isLoopInvariant(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>) || !L.isLoopInvariant(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>))</Highlight></CodeLine>
<Link id="l03025" /><CodeLine lineNumber="3025"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03026" /><CodeLine lineNumber="3026"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// TODO: Support other predicates.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03027" /><CodeLine lineNumber="3027"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Pred != <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78ba91d86a4753c8bd7624e01bf565d87f8e">ICmpInst::ICMP&#95;ULT</a>)</Highlight></CodeLine>
<Link id="l03028" /><CodeLine lineNumber="3028"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03029" /><CodeLine lineNumber="3029"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// TODO: Support non-loop-exiting branches?</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03030" /><CodeLine lineNumber="3030"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!L.contains(IfTrue) || L.contains(IfFalse))</Highlight></CodeLine>
<Link id="l03031" /><CodeLine lineNumber="3031"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03032" /><CodeLine lineNumber="3032"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// FIXME: For some reason this causes problems with MSSA updates, need to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03033" /><CodeLine lineNumber="3033"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// investigate why. So far, just don&#39;t unswitch latch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03034" /><CodeLine lineNumber="3034"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L.getHeader() == IfTrue)</Highlight></CodeLine>
<Link id="l03035" /><CodeLine lineNumber="3035"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03036" /><CodeLine lineNumber="3036"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03037" /><CodeLine lineNumber="3037"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l03038" /><CodeLine lineNumber="3038"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l03039" /><CodeLine lineNumber="3039"><Highlight kind="comment">/// Returns true, if metadata on \\p BI allows us to optimize branching into \\p</Highlight></CodeLine>
<Link id="l03040" /><CodeLine lineNumber="3040"><Highlight kind="comment">/// TakenSucc via injection of invariant conditions. The branch should be not</Highlight></CodeLine>
<Link id="l03041" /><CodeLine lineNumber="3041"><Highlight kind="comment">/// enough and not previously unswitched, the information about this comes from</Highlight></CodeLine>
<Link id="l03042" /><CodeLine lineNumber="3042"><Highlight kind="comment">/// the metadata.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03043" /><CodeLine lineNumber="3043" lineLink="#af08d593d99b84298decf28611dd32f50"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#af08d593d99b84298decf28611dd32f50">shouldTryInjectBasingOnMetadata</a>(</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;BI,</Highlight></CodeLine>
<Link id="l03044" /><CodeLine lineNumber="3044"><Highlight kind="normal">                                     </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;TakenSucc) &#123;</Highlight></CodeLine>
<Link id="l03045" /><CodeLine lineNumber="3045"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;uint32&#95;t&gt;</a> Weights;</Highlight></CodeLine>
<Link id="l03046" /><CodeLine lineNumber="3046"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/namespaces/llvm/#ac19cbbc4935a23e1d44f65e1eaba6b1d">extractBranchWeights</a>(&#42;BI, Weights))</Highlight></CodeLine>
<Link id="l03047" /><CodeLine lineNumber="3047"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03048" /><CodeLine lineNumber="3048"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> <a href="/docs/api/files/lib/lib/target/lib/target/mips/mips16isellowering-cpp/#a0acb682b8260ab1c60b918599864e2e5">T</a> = <a href="#aad5d88dba5221d4277024edf98cec9ac">InjectInvariantConditionHotnesThreshold</a>;</Highlight></CodeLine>
<Link id="l03049" /><CodeLine lineNumber="3049"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> LikelyTaken(<a href="/docs/api/files/lib/lib/target/lib/target/mips/mips16isellowering-cpp/#a0acb682b8260ab1c60b918599864e2e5">T</a> - 1, <a href="/docs/api/files/lib/lib/target/lib/target/mips/mips16isellowering-cpp/#a0acb682b8260ab1c60b918599864e2e5">T</a>);</Highlight></CodeLine>
<Link id="l03050" /><CodeLine lineNumber="3050"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03051" /><CodeLine lineNumber="3051"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Weights.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() == 2 &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Unexpected profile data!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03052" /><CodeLine lineNumber="3052"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">size&#95;t</Highlight><Highlight kind="normal"> Idx = BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(0) == TakenSucc ? 0 : 1;</Highlight></CodeLine>
<Link id="l03053" /><CodeLine lineNumber="3053"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> Num = Weights&#91;Idx&#93;;</Highlight></CodeLine>
<Link id="l03054" /><CodeLine lineNumber="3054"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> Denom = Weights&#91;0&#93; + Weights&#91;1&#93;;</Highlight></CodeLine>
<Link id="l03055" /><CodeLine lineNumber="3055"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Degenerate or overflowed metadata.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03056" /><CodeLine lineNumber="3056"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Denom == 0 || Num &gt; Denom)</Highlight></CodeLine>
<Link id="l03057" /><CodeLine lineNumber="3057"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03058" /><CodeLine lineNumber="3058"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> ActualTaken(Num, Denom);</Highlight></CodeLine>
<Link id="l03059" /><CodeLine lineNumber="3059"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (LikelyTaken &gt; ActualTaken)</Highlight></CodeLine>
<Link id="l03060" /><CodeLine lineNumber="3060"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03061" /><CodeLine lineNumber="3061"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03062" /><CodeLine lineNumber="3062"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l03063" /><CodeLine lineNumber="3063"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l03064" /><CodeLine lineNumber="3064"><Highlight kind="comment">/// Materialize pending invariant condition of the given candidate into IR. The</Highlight></CodeLine>
<Link id="l03065" /><CodeLine lineNumber="3065"><Highlight kind="comment">/// injected loop-invariant condition implies the original loop-variant branch</Highlight></CodeLine>
<Link id="l03066" /><CodeLine lineNumber="3066"><Highlight kind="comment">/// condition, so the materialization turns</Highlight></CodeLine>
<Link id="l03067" /><CodeLine lineNumber="3067"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l03068" /><CodeLine lineNumber="3068"><Highlight kind="comment">/// loop&#95;block:</Highlight></CodeLine>
<Link id="l03069" /><CodeLine lineNumber="3069"><Highlight kind="comment">///   ...</Highlight></CodeLine>
<Link id="l03070" /><CodeLine lineNumber="3070"><Highlight kind="comment">///   br i1 %variant&#95;cond, label InLoopSucc, label OutOfLoopSucc</Highlight></CodeLine>
<Link id="l03071" /><CodeLine lineNumber="3071"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l03072" /><CodeLine lineNumber="3072"><Highlight kind="comment">/// into</Highlight></CodeLine>
<Link id="l03073" /><CodeLine lineNumber="3073"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l03074" /><CodeLine lineNumber="3074"><Highlight kind="comment">/// preheader:</Highlight></CodeLine>
<Link id="l03075" /><CodeLine lineNumber="3075"><Highlight kind="comment">///   %invariant&#95;cond = LHS pred RHS</Highlight></CodeLine>
<Link id="l03076" /><CodeLine lineNumber="3076"><Highlight kind="comment">/// ...</Highlight></CodeLine>
<Link id="l03077" /><CodeLine lineNumber="3077"><Highlight kind="comment">/// loop&#95;block:</Highlight></CodeLine>
<Link id="l03078" /><CodeLine lineNumber="3078"><Highlight kind="comment">///   br i1 %invariant&#95;cond, label InLoopSucc, label OriginalCheck</Highlight></CodeLine>
<Link id="l03079" /><CodeLine lineNumber="3079"><Highlight kind="comment">/// OriginalCheck:</Highlight></CodeLine>
<Link id="l03080" /><CodeLine lineNumber="3080"><Highlight kind="comment">///   br i1 %variant&#95;cond, label InLoopSucc, label OutOfLoopSucc</Highlight></CodeLine>
<Link id="l03081" /><CodeLine lineNumber="3081"><Highlight kind="comment">/// ...</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03082" /><CodeLine lineNumber="3082"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a428fcbe432c0149594a5fe987bafd318">NonTrivialUnswitchCandidate</a></Highlight></CodeLine>
<Link id="l03083" /><CodeLine lineNumber="3083" lineLink="#aa8f270ce4d001ee9e7839aa11c607931"><Highlight kind="normal"><a href="#aa8f270ce4d001ee9e7839aa11c607931">injectPendingInvariantConditions</a>(<a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a428fcbe432c0149594a5fe987bafd318">NonTrivialUnswitchCandidate</a> Candidate, <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L,</Highlight></CodeLine>
<Link id="l03084" /><CodeLine lineNumber="3084"><Highlight kind="normal">                                 <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI,</Highlight></CodeLine>
<Link id="l03085" /><CodeLine lineNumber="3085"><Highlight kind="normal">                                 <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &amp;AC, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42;MSSAU) &#123;</Highlight></CodeLine>
<Link id="l03086" /><CodeLine lineNumber="3086"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Candidate.hasPendingInjection() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Nothing to inject!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03087" /><CodeLine lineNumber="3087"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Preheader = L.getLoopPreheader();</Highlight></CodeLine>
<Link id="l03088" /><CodeLine lineNumber="3088"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Preheader &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Loop is not in simplified form?&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03089" /><CodeLine lineNumber="3089"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(LI.<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(Candidate.TI-&gt;getParent()) == &amp;L &amp;&amp;</Highlight></CodeLine>
<Link id="l03090" /><CodeLine lineNumber="3090"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;Unswitching branch of inner loop!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03091" /><CodeLine lineNumber="3091"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03092" /><CodeLine lineNumber="3092"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> Pred = Candidate.PendingInjection-&gt;Pred;</Highlight></CodeLine>
<Link id="l03093" /><CodeLine lineNumber="3093"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a> = Candidate.PendingInjection-&gt;LHS;</Highlight></CodeLine>
<Link id="l03094" /><CodeLine lineNumber="3094"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a> = Candidate.PendingInjection-&gt;RHS;</Highlight></CodeLine>
<Link id="l03095" /><CodeLine lineNumber="3095"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;InLoopSucc = Candidate.PendingInjection-&gt;InLoopSucc;</Highlight></CodeLine>
<Link id="l03096" /><CodeLine lineNumber="3096"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;TI = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BranchInst&gt;</a>(Candidate.TI);</Highlight></CodeLine>
<Link id="l03097" /><CodeLine lineNumber="3097"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB = Candidate.TI-&gt;getParent();</Highlight></CodeLine>
<Link id="l03098" /><CodeLine lineNumber="3098"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;OutOfLoopSucc = InLoopSucc == TI-&gt;getSuccessor(0) ? TI-&gt;getSuccessor(1)</Highlight></CodeLine>
<Link id="l03099" /><CodeLine lineNumber="3099"><Highlight kind="normal">                                                          : TI-&gt;getSuccessor(0);</Highlight></CodeLine>
<Link id="l03100" /><CodeLine lineNumber="3100"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// FIXME: Remove this once limitation on successors is lifted.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03101" /><CodeLine lineNumber="3101"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(L.contains(InLoopSucc) &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Not supported yet!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03102" /><CodeLine lineNumber="3102"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!L.contains(OutOfLoopSucc) &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Not supported yet!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03103" /><CodeLine lineNumber="3103"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;Ctx = BB-&gt;getContext();</Highlight></CodeLine>
<Link id="l03104" /><CodeLine lineNumber="3104"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03105" /><CodeLine lineNumber="3105"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> Builder(Preheader-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l03106" /><CodeLine lineNumber="3106"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/llvm/cmpinst/#af206a3d6f58d9e53b074460f0d1ecb86">ICmpInst::isUnsigned</a>(Pred) &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Not supported yet!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03107" /><CodeLine lineNumber="3107"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>-&gt;getType() != <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>-&gt;getType()) &#123;</Highlight></CodeLine>
<Link id="l03108" /><CodeLine lineNumber="3108"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>-&gt;getType()-&gt;getIntegerBitWidth() &lt;</Highlight></CodeLine>
<Link id="l03109" /><CodeLine lineNumber="3109"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>-&gt;getType()-&gt;getIntegerBitWidth())</Highlight></CodeLine>
<Link id="l03110" /><CodeLine lineNumber="3110"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a> = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a9e6950f7f17700d5c0d61ad0b846ec5c">CreateZExt</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>-&gt;getType(), <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>-&gt;getName() + </Highlight><Highlight kind="stringliteral">&quot;.wide&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03111" /><CodeLine lineNumber="3111"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03112" /><CodeLine lineNumber="3112"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a> = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a9e6950f7f17700d5c0d61ad0b846ec5c">CreateZExt</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>-&gt;getType(), <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>-&gt;getName() + </Highlight><Highlight kind="stringliteral">&quot;.wide&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03113" /><CodeLine lineNumber="3113"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l03114" /><CodeLine lineNumber="3114"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Do not use builder here: CreateICmp may simplify this into a constant and</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03115" /><CodeLine lineNumber="3115"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// unswitching will break. Better optimize it away later.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03116" /><CodeLine lineNumber="3116"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;InjectedCond =</Highlight></CodeLine>
<Link id="l03117" /><CodeLine lineNumber="3117"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/cmpinst/#a62e2cf3675b93f0e6c07a4a00852f7cd">ICmpInst::Create</a>(Instruction::ICmp, Pred, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>, </Highlight><Highlight kind="stringliteral">&quot;injected.cond&quot;</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l03118" /><CodeLine lineNumber="3118"><Highlight kind="normal">                       Preheader-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>()-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>());</Highlight></CodeLine>
<Link id="l03119" /><CodeLine lineNumber="3119"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03120" /><CodeLine lineNumber="3120"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;CheckBlock = <a href="/docs/api/classes/llvm/basicblock/#a4a5b798214be930cf8e133c032ba0129">BasicBlock::Create</a>(Ctx, BB-&gt;getName() + </Highlight><Highlight kind="stringliteral">&quot;.check&quot;</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l03121" /><CodeLine lineNumber="3121"><Highlight kind="normal">                                              BB-&gt;getParent(), InLoopSucc);</Highlight></CodeLine>
<Link id="l03122" /><CodeLine lineNumber="3122"><Highlight kind="normal">  Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#ace45cae6925c65e9d6916e09dd5b17cc">SetInsertPoint</a>(TI);</Highlight></CodeLine>
<Link id="l03123" /><CodeLine lineNumber="3123"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;InvariantBr =</Highlight></CodeLine>
<Link id="l03124" /><CodeLine lineNumber="3124"><Highlight kind="normal">      Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a972c30f044db799668bdcace5544edeb">CreateCondBr</a>(InjectedCond, InLoopSucc, CheckBlock);</Highlight></CodeLine>
<Link id="l03125" /><CodeLine lineNumber="3125"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03126" /><CodeLine lineNumber="3126"><Highlight kind="normal">  Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#ace45cae6925c65e9d6916e09dd5b17cc">SetInsertPoint</a>(CheckBlock);</Highlight></CodeLine>
<Link id="l03127" /><CodeLine lineNumber="3127"><Highlight kind="normal">  Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a972c30f044db799668bdcace5544edeb">CreateCondBr</a>(TI-&gt;getCondition(), TI-&gt;getSuccessor(0),</Highlight></CodeLine>
<Link id="l03128" /><CodeLine lineNumber="3128"><Highlight kind="normal">                       TI-&gt;getSuccessor(1));</Highlight></CodeLine>
<Link id="l03129" /><CodeLine lineNumber="3129"><Highlight kind="normal">  TI-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</Highlight></CodeLine>
<Link id="l03130" /><CodeLine lineNumber="3130"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03131" /><CodeLine lineNumber="3131"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Fixup phis.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03132" /><CodeLine lineNumber="3132"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : &#42;InLoopSucc) &#123;</Highlight></CodeLine>
<Link id="l03133" /><CodeLine lineNumber="3133"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;PN = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;PHINode&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</Highlight></CodeLine>
<Link id="l03134" /><CodeLine lineNumber="3134"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!PN)</Highlight></CodeLine>
<Link id="l03135" /><CodeLine lineNumber="3135"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">break</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03136" /><CodeLine lineNumber="3136"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;Inc = PN-&gt;getIncomingValueForBlock(BB);</Highlight></CodeLine>
<Link id="l03137" /><CodeLine lineNumber="3137"><Highlight kind="normal">    PN-&gt;addIncoming(Inc, CheckBlock);</Highlight></CodeLine>
<Link id="l03138" /><CodeLine lineNumber="3138"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l03139" /><CodeLine lineNumber="3139"><Highlight kind="normal">  OutOfLoopSucc-&gt;replacePhiUsesWith(BB, CheckBlock);</Highlight></CodeLine>
<Link id="l03140" /><CodeLine lineNumber="3140"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03141" /><CodeLine lineNumber="3141"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;DominatorTree::UpdateType, 4&gt;</a> DTUpdates = &#123;</Highlight></CodeLine>
<Link id="l03142" /><CodeLine lineNumber="3142"><Highlight kind="normal">    &#123; <a href="/docs/api/classes/llvm/dominatortreebase/#a9aeeca2833810f01b20545a46fe22503">DominatorTree::Insert</a>, BB, CheckBlock &#125;,</Highlight></CodeLine>
<Link id="l03143" /><CodeLine lineNumber="3143"><Highlight kind="normal">    &#123; <a href="/docs/api/classes/llvm/dominatortreebase/#a9aeeca2833810f01b20545a46fe22503">DominatorTree::Insert</a>, CheckBlock, InLoopSucc &#125;,</Highlight></CodeLine>
<Link id="l03144" /><CodeLine lineNumber="3144"><Highlight kind="normal">    &#123; <a href="/docs/api/classes/llvm/dominatortreebase/#a9aeeca2833810f01b20545a46fe22503">DominatorTree::Insert</a>, CheckBlock, OutOfLoopSucc &#125;,</Highlight></CodeLine>
<Link id="l03145" /><CodeLine lineNumber="3145"><Highlight kind="normal">    &#123; <a href="/docs/api/classes/llvm/dominatortreebase/#a71c91cbbfc1c0ecf9a69e10ccf739bd7">DominatorTree::Delete</a>, BB, OutOfLoopSucc &#125;</Highlight></CodeLine>
<Link id="l03146" /><CodeLine lineNumber="3146"><Highlight kind="normal">  &#125;;</Highlight></CodeLine>
<Link id="l03147" /><CodeLine lineNumber="3147"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03148" /><CodeLine lineNumber="3148"><Highlight kind="normal">  DT.<a href="/docs/api/classes/llvm/dominatortreebase/#a470b5b573c7915fe13bd529b22c9adbc">applyUpdates</a>(DTUpdates);</Highlight></CodeLine>
<Link id="l03149" /><CodeLine lineNumber="3149"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU)</Highlight></CodeLine>
<Link id="l03150" /><CodeLine lineNumber="3150"><Highlight kind="normal">    MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#ad89ca302de455d3971f751c8d1a5bd58">applyUpdates</a>(DTUpdates, DT);</Highlight></CodeLine>
<Link id="l03151" /><CodeLine lineNumber="3151"><Highlight kind="normal">  L.addBasicBlockToLoop(CheckBlock, LI);</Highlight></CodeLine>
<Link id="l03152" /><CodeLine lineNumber="3152"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03153" /><CodeLine lineNumber="3153"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#ifndef NDEBUG</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03154" /><CodeLine lineNumber="3154"><Highlight kind="normal">  DT.<a href="/docs/api/classes/llvm/dominatortreebase/#a1f08f2925fec05b265e540d29066b9c8">verify</a>();</Highlight></CodeLine>
<Link id="l03155" /><CodeLine lineNumber="3155"><Highlight kind="normal">  LI.<a href="/docs/api/classes/llvm/loopinfobase/#a17a8f7aba5cca5c7f9faa779a3c4bc37">verify</a>(DT);</Highlight></CodeLine>
<Link id="l03156" /><CodeLine lineNumber="3156"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU &amp;&amp; <a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l03157" /><CodeLine lineNumber="3157"><Highlight kind="normal">    MSSAU-&gt;<a href="/docs/api/classes/llvm/memoryssaupdater/#a01a350909e784d6fa43181a72de61529">getMemorySSA</a>()-&gt;<a href="/docs/api/classes/llvm/memoryssa/#a88b10d37f671e58cf138ac84a8257c17">verifyMemorySSA</a>();</Highlight></CodeLine>
<Link id="l03158" /><CodeLine lineNumber="3158"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#endif</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03159" /><CodeLine lineNumber="3159"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03160" /><CodeLine lineNumber="3160"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// TODO: In fact, cost of unswitching a new invariant candidate is &#42;slightly&#42;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03161" /><CodeLine lineNumber="3161"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// higher because we have just inserted a new block. Need to think how to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03162" /><CodeLine lineNumber="3162"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// adjust the cost of injected candidates when it was first computed.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03163" /><CodeLine lineNumber="3163"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Injected a new loop-invariant branch &quot;</Highlight><Highlight kind="normal"> &lt;&lt; &#42;InvariantBr</Highlight></CodeLine>
<Link id="l03164" /><CodeLine lineNumber="3164"><Highlight kind="normal">                    &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; and considering it for unswitching.&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03165" /><CodeLine lineNumber="3165"><Highlight kind="normal">  ++NumInvariantConditionsInjected;</Highlight></CodeLine>
<Link id="l03166" /><CodeLine lineNumber="3166"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a428fcbe432c0149594a5fe987bafd318">NonTrivialUnswitchCandidate</a>(InvariantBr, &#123; InjectedCond &#125;,</Highlight></CodeLine>
<Link id="l03167" /><CodeLine lineNumber="3167"><Highlight kind="normal">                                     Candidate.Cost);</Highlight></CodeLine>
<Link id="l03168" /><CodeLine lineNumber="3168"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l03169" /><CodeLine lineNumber="3169"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l03170" /><CodeLine lineNumber="3170"><Highlight kind="comment">/// Given chain of loop branch conditions looking like:</Highlight></CodeLine>
<Link id="l03171" /><CodeLine lineNumber="3171"><Highlight kind="comment">///   br (Variant &lt; Invariant1)</Highlight></CodeLine>
<Link id="l03172" /><CodeLine lineNumber="3172"><Highlight kind="comment">///   br (Variant &lt; Invariant2)</Highlight></CodeLine>
<Link id="l03173" /><CodeLine lineNumber="3173"><Highlight kind="comment">///   br (Variant &lt; Invariant3)</Highlight></CodeLine>
<Link id="l03174" /><CodeLine lineNumber="3174"><Highlight kind="comment">///   ...</Highlight></CodeLine>
<Link id="l03175" /><CodeLine lineNumber="3175"><Highlight kind="comment">/// collect set of invariant conditions on which we want to unswitch, which</Highlight></CodeLine>
<Link id="l03176" /><CodeLine lineNumber="3176"><Highlight kind="comment">/// look like:</Highlight></CodeLine>
<Link id="l03177" /><CodeLine lineNumber="3177"><Highlight kind="comment">///   Invariant1 &lt;= Invariant2</Highlight></CodeLine>
<Link id="l03178" /><CodeLine lineNumber="3178"><Highlight kind="comment">///   Invariant2 &lt;= Invariant3</Highlight></CodeLine>
<Link id="l03179" /><CodeLine lineNumber="3179"><Highlight kind="comment">///   ...</Highlight></CodeLine>
<Link id="l03180" /><CodeLine lineNumber="3180"><Highlight kind="comment">/// Though they might not immediately exist in the IR, we can still inject them.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03181" /><CodeLine lineNumber="3181" lineLink="#a9ba70601e2398b462375dd8f3e9bc1b2"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a9ba70601e2398b462375dd8f3e9bc1b2">insertCandidatesWithPendingInjections</a>(</Highlight></CodeLine>
<Link id="l03182" /><CodeLine lineNumber="3182"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;NonTrivialUnswitchCandidate&gt;</a> &amp;UnswitchCandidates, <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L,</Highlight></CodeLine>
<Link id="l03183" /><CodeLine lineNumber="3183"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78b">ICmpInst::Predicate</a> Pred, <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;CompareDesc&gt;</a> Compares,</Highlight></CodeLine>
<Link id="l03184" /><CodeLine lineNumber="3184"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT) &#123;</Highlight></CodeLine>
<Link id="l03185" /><CodeLine lineNumber="3185"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03186" /><CodeLine lineNumber="3186"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/llvm/icmpinst/#ae955171baab3d9254f3ffb089c082206">ICmpInst::isRelational</a>(Pred));</Highlight></CodeLine>
<Link id="l03187" /><CodeLine lineNumber="3187"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/llvm/cmpinst/#a7d82fa77fd3d80b33e0beabb65ad8b93">ICmpInst::isStrictPredicate</a>(Pred));</Highlight></CodeLine>
<Link id="l03188" /><CodeLine lineNumber="3188"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Compares.<a href="/docs/api/classes/llvm/arrayref/#a85ffb6531d4cda988ea81f18d4e56fb7">size</a>() &lt; 2)</Highlight></CodeLine>
<Link id="l03189" /><CodeLine lineNumber="3189"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03190" /><CodeLine lineNumber="3190"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78b">ICmpInst::Predicate</a> NonStrictPred = <a href="/docs/api/classes/llvm/cmpinst/#a6b13f2e75444202b854672a5fbf85e2e">ICmpInst::getNonStrictPredicate</a>(Pred);</Highlight></CodeLine>
<Link id="l03191" /><CodeLine lineNumber="3191"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> Prev = Compares.<a href="/docs/api/classes/llvm/arrayref/#aab36927882fbfdcbb860d87fd9c30da8">begin</a>(), <a href="/docs/api/namespaces/llvm/#ab13c360340346d082b959b8cd79f2c1a">Next</a> = Compares.<a href="/docs/api/classes/llvm/arrayref/#aab36927882fbfdcbb860d87fd9c30da8">begin</a>() + 1;</Highlight></CodeLine>
<Link id="l03192" /><CodeLine lineNumber="3192"><Highlight kind="normal">       <a href="/docs/api/namespaces/llvm/#ab13c360340346d082b959b8cd79f2c1a">Next</a> != Compares.<a href="/docs/api/classes/llvm/arrayref/#a7ca5197533a9c1fb8a2bd30587fcec6b">end</a>(); ++Prev, ++<a href="/docs/api/namespaces/llvm/#ab13c360340346d082b959b8cd79f2c1a">Next</a>) &#123;</Highlight></CodeLine>
<Link id="l03193" /><CodeLine lineNumber="3193"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a> = <a href="/docs/api/namespaces/llvm/#ab13c360340346d082b959b8cd79f2c1a">Next</a>-&gt;Invariant;</Highlight></CodeLine>
<Link id="l03194" /><CodeLine lineNumber="3194"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a> = Prev-&gt;Invariant;</Highlight></CodeLine>
<Link id="l03195" /><CodeLine lineNumber="3195"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;InLoopSucc = Prev-&gt;InLoopSucc;</Highlight></CodeLine>
<Link id="l03196" /><CodeLine lineNumber="3196"><Highlight kind="normal">    <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/injectedinvariant/#a9851d6d92871b3a0d2fc4b4f5c205b97">InjectedInvariant</a> ToInject(NonStrictPred, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>, InLoopSucc);</Highlight></CodeLine>
<Link id="l03197" /><CodeLine lineNumber="3197"><Highlight kind="normal">    <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a428fcbe432c0149594a5fe987bafd318">NonTrivialUnswitchCandidate</a> Candidate(Prev-&gt;Term, &#123; LHS, RHS &#125;,</Highlight></CodeLine>
<Link id="l03198" /><CodeLine lineNumber="3198"><Highlight kind="normal">                                          std::nullopt, std::move(ToInject));</Highlight></CodeLine>
<Link id="l03199" /><CodeLine lineNumber="3199"><Highlight kind="normal">    UnswitchCandidates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(std::move(Candidate));</Highlight></CodeLine>
<Link id="l03200" /><CodeLine lineNumber="3200"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l03201" /><CodeLine lineNumber="3201"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03202" /><CodeLine lineNumber="3202"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l03203" /><CodeLine lineNumber="3203"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l03204" /><CodeLine lineNumber="3204"><Highlight kind="comment">/// Collect unswitch candidates by invariant conditions that are not immediately</Highlight></CodeLine>
<Link id="l03205" /><CodeLine lineNumber="3205"><Highlight kind="comment">/// present in the loop. However, they can be injected into the code if we</Highlight></CodeLine>
<Link id="l03206" /><CodeLine lineNumber="3206"><Highlight kind="comment">/// decide it&#39;s profitable.</Highlight></CodeLine>
<Link id="l03207" /><CodeLine lineNumber="3207"><Highlight kind="comment">/// An example of such conditions is following:</Highlight></CodeLine>
<Link id="l03208" /><CodeLine lineNumber="3208"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l03209" /><CodeLine lineNumber="3209"><Highlight kind="comment">///   for (...) &#123;</Highlight></CodeLine>
<Link id="l03210" /><CodeLine lineNumber="3210"><Highlight kind="comment">///     x = load ...</Highlight></CodeLine>
<Link id="l03211" /><CodeLine lineNumber="3211"><Highlight kind="comment">///     if (! x &lt;u C1) break;</Highlight></CodeLine>
<Link id="l03212" /><CodeLine lineNumber="3212"><Highlight kind="comment">///     if (! x &lt;u C2) break;</Highlight></CodeLine>
<Link id="l03213" /><CodeLine lineNumber="3213"><Highlight kind="comment">///     &lt;do something&gt;</Highlight></CodeLine>
<Link id="l03214" /><CodeLine lineNumber="3214"><Highlight kind="comment">///   &#125;</Highlight></CodeLine>
<Link id="l03215" /><CodeLine lineNumber="3215"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l03216" /><CodeLine lineNumber="3216"><Highlight kind="comment">/// We can unswitch by condition &quot;C1 &lt;=u C2&quot;. If that is true, then &quot;x &lt;u C1 &lt;=</Highlight></CodeLine>
<Link id="l03217" /><CodeLine lineNumber="3217"><Highlight kind="comment">/// C2&quot; automatically implies &quot;x &lt;u C2&quot;, so we can get rid of one of</Highlight></CodeLine>
<Link id="l03218" /><CodeLine lineNumber="3218"><Highlight kind="comment">/// loop-variant checks in unswitched loop version.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03219" /><CodeLine lineNumber="3219" lineLink="#a607c1e689b230ff38733bfc0bfd3b6da"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a607c1e689b230ff38733bfc0bfd3b6da">collectUnswitchCandidatesWithInjections</a>(</Highlight></CodeLine>
<Link id="l03220" /><CodeLine lineNumber="3220"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;NonTrivialUnswitchCandidate&gt;</a> &amp;UnswitchCandidates,</Highlight></CodeLine>
<Link id="l03221" /><CodeLine lineNumber="3221"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/ivconditioninfo">IVConditionInfo</a> &amp;PartialIVInfo, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;&amp;PartialIVCondBranch, <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L,</Highlight></CodeLine>
<Link id="l03222" /><CodeLine lineNumber="3222"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI, <a href="/docs/api/classes/llvm/aaresults">AAResults</a> &amp;<a href="/docs/api/namespaces/llvm/aa">AA</a>,</Highlight></CodeLine>
<Link id="l03223" /><CodeLine lineNumber="3223"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42;MSSAU) &#123;</Highlight></CodeLine>
<Link id="l03224" /><CodeLine lineNumber="3224"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="#a777260b6a90536fc8e2d844a891eddb5">InjectInvariantConditions</a>)</Highlight></CodeLine>
<Link id="l03225" /><CodeLine lineNumber="3225"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03226" /><CodeLine lineNumber="3226"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03227" /><CodeLine lineNumber="3227"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!DT.<a href="/docs/api/classes/llvm/dominatortree/#a1a70f2c359aadd76a72aaaede16aca4a">isReachableFromEntry</a>(L.getHeader()))</Highlight></CodeLine>
<Link id="l03228" /><CodeLine lineNumber="3228"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03229" /><CodeLine lineNumber="3229"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;Latch = L.getLoopLatch();</Highlight></CodeLine>
<Link id="l03230" /><CodeLine lineNumber="3230"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Need to have a single latch and a preheader.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03231" /><CodeLine lineNumber="3231"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!Latch)</Highlight></CodeLine>
<Link id="l03232" /><CodeLine lineNumber="3232"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03233" /><CodeLine lineNumber="3233"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(L.getLoopPreheader() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Must have a preheader!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03234" /><CodeLine lineNumber="3234"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03235" /><CodeLine lineNumber="3235"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/densemap">DenseMap&lt;Value &#42;, SmallVector&lt;CompareDesc, 4&gt;</a> &gt; CandidatesULT;</Highlight></CodeLine>
<Link id="l03236" /><CodeLine lineNumber="3236"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Traverse the conditions that dominate latch (and therefore dominate each</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03237" /><CodeLine lineNumber="3237"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// other).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03238" /><CodeLine lineNumber="3238"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;DTN = DT.<a href="/docs/api/classes/llvm/dominatortreebase/#ad8295b9b507d1d847cd46856f8255eab">getNode</a>(Latch); L.contains(DTN-&gt;getBlock());</Highlight></CodeLine>
<Link id="l03239" /><CodeLine lineNumber="3239"><Highlight kind="normal">       DTN = DTN-&gt;getIDom()) &#123;</Highlight></CodeLine>
<Link id="l03240" /><CodeLine lineNumber="3240"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/cmppredicate">CmpPredicate</a> Pred;</Highlight></CodeLine>
<Link id="l03241" /><CodeLine lineNumber="3241"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a> = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">, &#42;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a> = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03242" /><CodeLine lineNumber="3242"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;IfTrue = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">, &#42;IfFalse = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03243" /><CodeLine lineNumber="3243"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB = DTN-&gt;getBlock();</Highlight></CodeLine>
<Link id="l03244" /><CodeLine lineNumber="3244"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Ignore inner loops.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03245" /><CodeLine lineNumber="3245"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (LI.<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(BB) != &amp;L)</Highlight></CodeLine>
<Link id="l03246" /><CodeLine lineNumber="3246"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03247" /><CodeLine lineNumber="3247"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;Term = BB-&gt;getTerminator();</Highlight></CodeLine>
<Link id="l03248" /><CodeLine lineNumber="3248"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Term, <a href="/docs/api/namespaces/llvm/patternmatch/#a811d001fa503a556ac2a48d64366500f">m&#95;Br</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#ab86c85b47e09489dcda68fd91d082d77">m&#95;ICmp</a>(Pred, <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>)),</Highlight></CodeLine>
<Link id="l03249" /><CodeLine lineNumber="3249"><Highlight kind="normal">                          <a href="/docs/api/namespaces/llvm/patternmatch/#ad856c036ca10c903c93082a4e784d4a6">m&#95;BasicBlock</a>(IfTrue), <a href="/docs/api/namespaces/llvm/patternmatch/#ad856c036ca10c903c93082a4e784d4a6">m&#95;BasicBlock</a>(IfFalse))))</Highlight></CodeLine>
<Link id="l03250" /><CodeLine lineNumber="3250"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03251" /><CodeLine lineNumber="3251"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>-&gt;getType()-&gt;isIntegerTy())</Highlight></CodeLine>
<Link id="l03252" /><CodeLine lineNumber="3252"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03253" /><CodeLine lineNumber="3253"><Highlight kind="normal">    <a href="#a94bc2ff14a27583461b207499f426ee2">canonicalizeForInvariantConditionInjection</a>(Pred, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>, IfTrue, IfFalse,</Highlight></CodeLine>
<Link id="l03254" /><CodeLine lineNumber="3254"><Highlight kind="normal">                                               L);</Highlight></CodeLine>
<Link id="l03255" /><CodeLine lineNumber="3255"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="#a4cbb86574a065a122292322ed4e27b0e">shouldTryInjectInvariantCondition</a>(Pred, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>, IfTrue, IfFalse, L))</Highlight></CodeLine>
<Link id="l03256" /><CodeLine lineNumber="3256"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03257" /><CodeLine lineNumber="3257"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="#af08d593d99b84298decf28611dd32f50">shouldTryInjectBasingOnMetadata</a>(<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BranchInst&gt;</a>(Term), IfTrue))</Highlight></CodeLine>
<Link id="l03258" /><CodeLine lineNumber="3258"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03259" /><CodeLine lineNumber="3259"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Strip ZEXT for unsigned predicate.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03260" /><CodeLine lineNumber="3260"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// TODO: once signed predicates are supported, also strip SEXT.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03261" /><CodeLine lineNumber="3261"><Highlight kind="normal">    <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/comparedesc/#ade23e38371e46b268eb92542813f53bc">CompareDesc</a> <a href="/docs/api/namespaces/llvm/#a4de98a9acffcef5bb4b31862cb8c72ac">Desc</a>(<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BranchInst&gt;</a>(Term), <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>, IfTrue);</Highlight></CodeLine>
<Link id="l03262" /><CodeLine lineNumber="3262"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;Zext = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ZExtInst&gt;</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>))</Highlight></CodeLine>
<Link id="l03263" /><CodeLine lineNumber="3263"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a> = Zext-&gt;getOperand(0);</Highlight></CodeLine>
<Link id="l03264" /><CodeLine lineNumber="3264"><Highlight kind="normal">    CandidatesULT&#91;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>&#93;.push&#95;back(<a href="/docs/api/namespaces/llvm/#a4de98a9acffcef5bb4b31862cb8c72ac">Desc</a>);</Highlight></CodeLine>
<Link id="l03265" /><CodeLine lineNumber="3265"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l03266" /><CodeLine lineNumber="3266"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03267" /><CodeLine lineNumber="3267"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> Found = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03268" /><CodeLine lineNumber="3268"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;It : CandidatesULT)</Highlight></CodeLine>
<Link id="l03269" /><CodeLine lineNumber="3269"><Highlight kind="normal">    Found |= <a href="#a9ba70601e2398b462375dd8f3e9bc1b2">insertCandidatesWithPendingInjections</a>(</Highlight></CodeLine>
<Link id="l03270" /><CodeLine lineNumber="3270"><Highlight kind="normal">        UnswitchCandidates, L, <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78ba91d86a4753c8bd7624e01bf565d87f8e">ICmpInst::ICMP&#95;ULT</a>, It.second, DT);</Highlight></CodeLine>
<Link id="l03271" /><CodeLine lineNumber="3271"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> Found;</Highlight></CodeLine>
<Link id="l03272" /><CodeLine lineNumber="3272"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l03273" /><CodeLine lineNumber="3273"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03274" /><CodeLine lineNumber="3274" lineLink="#a41cbe08b01edbedddb8d8706d13c5270"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a41cbe08b01edbedddb8d8706d13c5270">isSafeForNoNTrivialUnswitching</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI) &#123;</Highlight></CodeLine>
<Link id="l03275" /><CodeLine lineNumber="3275"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!L.isSafeToClone())</Highlight></CodeLine>
<Link id="l03276" /><CodeLine lineNumber="3276"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03277" /><CodeLine lineNumber="3277"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB : L.blocks())</Highlight></CodeLine>
<Link id="l03278" /><CodeLine lineNumber="3278"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : &#42;BB) &#123;</Highlight></CodeLine>
<Link id="l03279" /><CodeLine lineNumber="3279"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getType()-&gt;isTokenTy() &amp;&amp; <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.isUsedOutsideOfBlock(BB))</Highlight></CodeLine>
<Link id="l03280" /><CodeLine lineNumber="3280"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03281" /><CodeLine lineNumber="3281"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;CB = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CallBase&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) &#123;</Highlight></CodeLine>
<Link id="l03282" /><CodeLine lineNumber="3282"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!CB-&gt;cannotDuplicate() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Checked by L.isSafeToClone().&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03283" /><CodeLine lineNumber="3283"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (CB-&gt;isConvergent())</Highlight></CodeLine>
<Link id="l03284" /><CodeLine lineNumber="3284"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03285" /><CodeLine lineNumber="3285"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l03286" /><CodeLine lineNumber="3286"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l03287" /><CodeLine lineNumber="3287"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03288" /><CodeLine lineNumber="3288"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Check if there are irreducible CFG cycles in this loop. If so, we cannot</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03289" /><CodeLine lineNumber="3289"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// easily unswitch non-trivial edges out of the loop. Doing so might turn the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03290" /><CodeLine lineNumber="3290"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// irreducible control flow into reducible control flow and introduce new</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03291" /><CodeLine lineNumber="3291"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// loops &quot;out of thin air&quot;. If we ever discover important use cases for doing</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03292" /><CodeLine lineNumber="3292"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// this, we can add support to loop unswitch, but it is a lot of complexity</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03293" /><CodeLine lineNumber="3293"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// for what seems little or no real world benefit.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03294" /><CodeLine lineNumber="3294"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loopblocksrpo">LoopBlocksRPO</a> RPOT(&amp;L);</Highlight></CodeLine>
<Link id="l03295" /><CodeLine lineNumber="3295"><Highlight kind="normal">  RPOT.<a href="/docs/api/classes/llvm/loopblocksrpo/#aeab06fd248333b13725e55754883b570">perform</a>(&amp;LI);</Highlight></CodeLine>
<Link id="l03296" /><CodeLine lineNumber="3296"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a6dadcd5de1248b4d9893c409e7398c21">containsIrreducibleCFG&lt;const BasicBlock &#42;&gt;</a>(RPOT, LI))</Highlight></CodeLine>
<Link id="l03297" /><CodeLine lineNumber="3297"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03298" /><CodeLine lineNumber="3298"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03299" /><CodeLine lineNumber="3299"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 4&gt;</a> ExitBlocks;</Highlight></CodeLine>
<Link id="l03300" /><CodeLine lineNumber="3300"><Highlight kind="normal">  L.getUniqueExitBlocks(ExitBlocks);</Highlight></CodeLine>
<Link id="l03301" /><CodeLine lineNumber="3301"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We cannot unswitch if exit blocks contain a cleanuppad/catchswitch</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03302" /><CodeLine lineNumber="3302"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// instruction as we don&#39;t know how to split those exit blocks.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03303" /><CodeLine lineNumber="3303"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// FIXME: We should teach SplitBlock to handle this and remove this</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03304" /><CodeLine lineNumber="3304"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// restriction.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03305" /><CodeLine lineNumber="3305"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ExitBB : ExitBlocks) &#123;</Highlight></CodeLine>
<Link id="l03306" /><CodeLine lineNumber="3306"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> It = ExitBB-&gt;getFirstNonPHIIt();</Highlight></CodeLine>
<Link id="l03307" /><CodeLine lineNumber="3307"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;CleanupPadInst&gt;</a>(It) || <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;CatchSwitchInst&gt;</a>(It)) &#123;</Highlight></CodeLine>
<Link id="l03308" /><CodeLine lineNumber="3308"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Cannot unswitch because of cleanuppad/catchswitch &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03309" /><CodeLine lineNumber="3309"><Highlight kind="normal">                           </Highlight><Highlight kind="stringliteral">&quot;in exit block\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03310" /><CodeLine lineNumber="3310"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03311" /><CodeLine lineNumber="3311"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l03312" /><CodeLine lineNumber="3312"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l03313" /><CodeLine lineNumber="3313"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03314" /><CodeLine lineNumber="3314"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03315" /><CodeLine lineNumber="3315"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l03316" /><CodeLine lineNumber="3316"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03317" /><CodeLine lineNumber="3317" lineLink="#a52374e76082ee94158724e5695a88a02"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a428fcbe432c0149594a5fe987bafd318">NonTrivialUnswitchCandidate</a> <a href="#a52374e76082ee94158724e5695a88a02">findBestNonTrivialUnswitchCandidate</a>(</Highlight></CodeLine>
<Link id="l03318" /><CodeLine lineNumber="3318"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;NonTrivialUnswitchCandidate&gt;</a> UnswitchCandidates, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L,</Highlight></CodeLine>
<Link id="l03319" /><CodeLine lineNumber="3319"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI, <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &amp;AC,</Highlight></CodeLine>
<Link id="l03320" /><CodeLine lineNumber="3320"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/targettransforminfo">TargetTransformInfo</a> &amp;<a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/structs/llvm/ivconditioninfo">IVConditionInfo</a> &amp;PartialIVInfo) &#123;</Highlight></CodeLine>
<Link id="l03321" /><CodeLine lineNumber="3321"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Given that unswitching these terminators will require duplicating parts of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03322" /><CodeLine lineNumber="3322"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the loop, so we need to be able to model that cost. Compute the ephemeral</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03323" /><CodeLine lineNumber="3323"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// values and set up a data structure to hold per-BB costs. We cache each</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03324" /><CodeLine lineNumber="3324"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// block&#39;s cost so that we don&#39;t recompute this when considering different</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03325" /><CodeLine lineNumber="3325"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// subsets of the loop for duplication during unswitching.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03326" /><CodeLine lineNumber="3326"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;const Value &#42;, 4&gt;</a> EphValues;</Highlight></CodeLine>
<Link id="l03327" /><CodeLine lineNumber="3327"><Highlight kind="normal">  <a href="/docs/api/structs/llvm/codemetrics/#a7e174506b52ad46ea1f746a7f727d999">CodeMetrics::collectEphemeralValues</a>(&amp;L, &amp;AC, EphValues);</Highlight></CodeLine>
<Link id="l03328" /><CodeLine lineNumber="3328"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;BasicBlock &#42;, InstructionCost, 4&gt;</a> BBCostMap;</Highlight></CodeLine>
<Link id="l03329" /><CodeLine lineNumber="3329"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03330" /><CodeLine lineNumber="3330"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Compute the cost of each block, as well as the total loop cost. Also, bail</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03331" /><CodeLine lineNumber="3331"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// out if we see instructions which are incompatible with loop unswitching</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03332" /><CodeLine lineNumber="3332"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// (convergent, noduplicate, or cross-basic-block tokens).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03333" /><CodeLine lineNumber="3333"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// FIXME: We might be able to safely handle some of these in non-duplicated</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03334" /><CodeLine lineNumber="3334"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// regions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03335" /><CodeLine lineNumber="3335"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/targettransforminfo/#a706f223f760b55668fbae74202b816bb">TargetTransformInfo::TargetCostKind</a> <a href="/docs/api/files/lib/lib/analysis/costmodel-cpp/#a162d8b2b3865594d1e14d828d2b8336a">CostKind</a> =</Highlight></CodeLine>
<Link id="l03336" /><CodeLine lineNumber="3336"><Highlight kind="normal">      L.getHeader()-&gt;getParent()-&gt;hasMinSize()</Highlight></CodeLine>
<Link id="l03337" /><CodeLine lineNumber="3337"><Highlight kind="normal">      ? <a href="/docs/api/classes/llvm/targettransforminfo/#a706f223f760b55668fbae74202b816bba737cfc93e5a2ff961677d57186167e7c">TargetTransformInfo::TCK&#95;CodeSize</a></Highlight></CodeLine>
<Link id="l03338" /><CodeLine lineNumber="3338"><Highlight kind="normal">      : <a href="/docs/api/classes/llvm/targettransforminfo/#a706f223f760b55668fbae74202b816bba7f80055e1969cb850739546467460ad8">TargetTransformInfo::TCK&#95;SizeAndLatency</a>;</Highlight></CodeLine>
<Link id="l03339" /><CodeLine lineNumber="3339"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/instructioncost">InstructionCost</a> LoopCost = 0;</Highlight></CodeLine>
<Link id="l03340" /><CodeLine lineNumber="3340"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB : L.blocks()) &#123;</Highlight></CodeLine>
<Link id="l03341" /><CodeLine lineNumber="3341"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/instructioncost">InstructionCost</a> <a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a> = 0;</Highlight></CodeLine>
<Link id="l03342" /><CodeLine lineNumber="3342"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : &#42;BB) &#123;</Highlight></CodeLine>
<Link id="l03343" /><CodeLine lineNumber="3343"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (EphValues.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</Highlight></CodeLine>
<Link id="l03344" /><CodeLine lineNumber="3344"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03345" /><CodeLine lineNumber="3345"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a> += <a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>.getInstructionCost(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <a href="/docs/api/files/lib/lib/analysis/costmodel-cpp/#a162d8b2b3865594d1e14d828d2b8336a">CostKind</a>);</Highlight></CodeLine>
<Link id="l03346" /><CodeLine lineNumber="3346"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l03347" /><CodeLine lineNumber="3347"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a> &gt;= 0 &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Must not have negative costs!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03348" /><CodeLine lineNumber="3348"><Highlight kind="normal">    LoopCost += <a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a>;</Highlight></CodeLine>
<Link id="l03349" /><CodeLine lineNumber="3349"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(LoopCost &gt;= 0 &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Must not have negative loop costs!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03350" /><CodeLine lineNumber="3350"><Highlight kind="normal">    BBCostMap&#91;BB&#93; = <a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a>;</Highlight></CodeLine>
<Link id="l03351" /><CodeLine lineNumber="3351"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l03352" /><CodeLine lineNumber="3352"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Total loop cost: &quot;</Highlight><Highlight kind="normal"> &lt;&lt; LoopCost &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03353" /><CodeLine lineNumber="3353"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03354" /><CodeLine lineNumber="3354"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now we find the best candidate by searching for the one with the following</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03355" /><CodeLine lineNumber="3355"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// properties in order:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03356" /><CodeLine lineNumber="3356"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03357" /><CodeLine lineNumber="3357"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// 1) An unswitching cost below the threshold</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03358" /><CodeLine lineNumber="3358"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// 2) The smallest number of duplicated unswitch candidates (to avoid</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03359" /><CodeLine lineNumber="3359"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//    creating redundant subsequent unswitching)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03360" /><CodeLine lineNumber="3360"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// 3) The smallest cost after unswitching.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03361" /><CodeLine lineNumber="3361"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03362" /><CodeLine lineNumber="3362"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We prioritize reducing fanout of unswitch candidates provided the cost</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03363" /><CodeLine lineNumber="3363"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// remains below the threshold because this has a multiplicative effect.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03364" /><CodeLine lineNumber="3364"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03365" /><CodeLine lineNumber="3365"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// This requires memoizing each dominator subtree to avoid redundant work.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03366" /><CodeLine lineNumber="3366"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03367" /><CodeLine lineNumber="3367"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// FIXME: Need to actually do the number of candidates part above.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03368" /><CodeLine lineNumber="3368"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;DomTreeNode &#42;, InstructionCost, 4&gt;</a> DTCostMap;</Highlight></CodeLine>
<Link id="l03369" /><CodeLine lineNumber="3369"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Given a terminator which might be unswitched, computes the non-duplicated</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03370" /><CodeLine lineNumber="3370"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// cost for that terminator.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03371" /><CodeLine lineNumber="3371"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> ComputeUnswitchedCost = &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;TI,</Highlight></CodeLine>
<Link id="l03372" /><CodeLine lineNumber="3372"><Highlight kind="normal">                                   </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> FullUnswitch) -&gt; <a href="/docs/api/classes/llvm/instructioncost">InstructionCost</a> &#123;</Highlight></CodeLine>
<Link id="l03373" /><CodeLine lineNumber="3373"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Unswitching selects unswitches the entire loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03374" /><CodeLine lineNumber="3374"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;SelectInst&gt;</a>(TI))</Highlight></CodeLine>
<Link id="l03375" /><CodeLine lineNumber="3375"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> LoopCost;</Highlight></CodeLine>
<Link id="l03376" /><CodeLine lineNumber="3376"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03377" /><CodeLine lineNumber="3377"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;BB = &#42;TI.<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>();</Highlight></CodeLine>
<Link id="l03378" /><CodeLine lineNumber="3378"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;BasicBlock &#42;, 4&gt;</a> Visited;</Highlight></CodeLine>
<Link id="l03379" /><CodeLine lineNumber="3379"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03380" /><CodeLine lineNumber="3380"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/instructioncost">InstructionCost</a> <a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a> = 0;</Highlight></CodeLine>
<Link id="l03381" /><CodeLine lineNumber="3381"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;SuccBB : <a href="/docs/api/namespaces/llvm/#a26e2a938b431eaa6eca2beaa96410c9d">successors</a>(&amp;BB)) &#123;</Highlight></CodeLine>
<Link id="l03382" /><CodeLine lineNumber="3382"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Don&#39;t count successors more than once.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03383" /><CodeLine lineNumber="3383"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!Visited.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(SuccBB).second)</Highlight></CodeLine>
<Link id="l03384" /><CodeLine lineNumber="3384"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03385" /><CodeLine lineNumber="3385"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03386" /><CodeLine lineNumber="3386"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// If this is a partial unswitch candidate, then it must be a conditional</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03387" /><CodeLine lineNumber="3387"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// branch with a condition of either &#96;or&#96;, &#96;and&#96;, their corresponding</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03388" /><CodeLine lineNumber="3388"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// select forms or partially invariant instructions. In that case, one of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03389" /><CodeLine lineNumber="3389"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// the successors is necessarily duplicated, so don&#39;t even try to remove</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03390" /><CodeLine lineNumber="3390"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// its cost.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03391" /><CodeLine lineNumber="3391"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!FullUnswitch) &#123;</Highlight></CodeLine>
<Link id="l03392" /><CodeLine lineNumber="3392"><Highlight kind="normal">        </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;BI = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BranchInst&gt;</a>(TI);</Highlight></CodeLine>
<Link id="l03393" /><CodeLine lineNumber="3393"><Highlight kind="normal">        <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a> = <a href="#a5ca2e820d1b5a49dcaad5e6873917198">skipTrivialSelect</a>(BI.getCondition());</Highlight></CodeLine>
<Link id="l03394" /><CodeLine lineNumber="3394"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, <a href="/docs/api/namespaces/llvm/patternmatch/#acf8c16eed89e5ee1a10b6dfc08a33b3a">m&#95;LogicalAnd</a>())) &#123;</Highlight></CodeLine>
<Link id="l03395" /><CodeLine lineNumber="3395"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SuccBB == BI.getSuccessor(1))</Highlight></CodeLine>
<Link id="l03396" /><CodeLine lineNumber="3396"><Highlight kind="normal">            </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03397" /><CodeLine lineNumber="3397"><Highlight kind="normal">        &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, <a href="/docs/api/namespaces/llvm/patternmatch/#a5cce7a41c7581ff15a23ab90eb3b403a">m&#95;LogicalOr</a>())) &#123;</Highlight></CodeLine>
<Link id="l03398" /><CodeLine lineNumber="3398"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SuccBB == BI.getSuccessor(0))</Highlight></CodeLine>
<Link id="l03399" /><CodeLine lineNumber="3399"><Highlight kind="normal">            </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03400" /><CodeLine lineNumber="3400"><Highlight kind="normal">        &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> ((PartialIVInfo.<a href="/docs/api/structs/llvm/ivconditioninfo/#a8115811b4523cb1c13e1e32c5dc3bb3d">KnownValue</a>-&gt;<a href="/docs/api/classes/llvm/constant/#a586fb7954fcb7d759a997b3e1e979d30">isOneValue</a>() &amp;&amp;</Highlight></CodeLine>
<Link id="l03401" /><CodeLine lineNumber="3401"><Highlight kind="normal">                    SuccBB == BI.getSuccessor(0)) ||</Highlight></CodeLine>
<Link id="l03402" /><CodeLine lineNumber="3402"><Highlight kind="normal">                   (!PartialIVInfo.<a href="/docs/api/structs/llvm/ivconditioninfo/#a8115811b4523cb1c13e1e32c5dc3bb3d">KnownValue</a>-&gt;<a href="/docs/api/classes/llvm/constant/#a586fb7954fcb7d759a997b3e1e979d30">isOneValue</a>() &amp;&amp;</Highlight></CodeLine>
<Link id="l03403" /><CodeLine lineNumber="3403"><Highlight kind="normal">                    SuccBB == BI.getSuccessor(1)))</Highlight></CodeLine>
<Link id="l03404" /><CodeLine lineNumber="3404"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03405" /><CodeLine lineNumber="3405"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l03406" /><CodeLine lineNumber="3406"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03407" /><CodeLine lineNumber="3407"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// This successor&#39;s domtree will not need to be duplicated after</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03408" /><CodeLine lineNumber="3408"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// unswitching if the edge to the successor dominates it (and thus the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03409" /><CodeLine lineNumber="3409"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// entire tree). This essentially means there is no other path into this</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03410" /><CodeLine lineNumber="3410"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// subtree and so it will end up live in only one clone of the loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03411" /><CodeLine lineNumber="3411"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SuccBB-&gt;getUniquePredecessor() ||</Highlight></CodeLine>
<Link id="l03412" /><CodeLine lineNumber="3412"><Highlight kind="normal">          <a href="/docs/api/namespaces/llvm/#a0d10fe510ced2849a8074fe81e5d04ce">llvm::all&#95;of</a>(<a href="/docs/api/namespaces/llvm/#acb22fb04083152eee862457e42e8dc31">predecessors</a>(SuccBB), &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;PredBB) &#123;</Highlight></CodeLine>
<Link id="l03413" /><CodeLine lineNumber="3413"><Highlight kind="normal">            </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> PredBB == &amp;BB || DT.<a href="/docs/api/classes/llvm/dominatortree/#a5c69311e8d44898dac36a155c3d8691d">dominates</a>(SuccBB, PredBB);</Highlight></CodeLine>
<Link id="l03414" /><CodeLine lineNumber="3414"><Highlight kind="normal">          &#125;)) &#123;</Highlight></CodeLine>
<Link id="l03415" /><CodeLine lineNumber="3415"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a> += <a href="#a78a15f5bff768264b9e435e319db18f3">computeDomSubtreeCost</a>(&#42;DT&#91;SuccBB&#93;, BBCostMap, DTCostMap);</Highlight></CodeLine>
<Link id="l03416" /><CodeLine lineNumber="3416"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a> &lt;= LoopCost &amp;&amp;</Highlight></CodeLine>
<Link id="l03417" /><CodeLine lineNumber="3417"><Highlight kind="normal">               </Highlight><Highlight kind="stringliteral">&quot;Non-duplicated cost should never exceed total loop cost!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03418" /><CodeLine lineNumber="3418"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l03419" /><CodeLine lineNumber="3419"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l03420" /><CodeLine lineNumber="3420"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03421" /><CodeLine lineNumber="3421"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Now scale the cost by the number of unique successors minus one. We</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03422" /><CodeLine lineNumber="3422"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// subtract one because there is already at least one copy of the entire</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03423" /><CodeLine lineNumber="3423"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// loop. This is computing the new cost of unswitching a condition.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03424" /><CodeLine lineNumber="3424"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Note that guards always have 2 unique successors that are implicit and</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03425" /><CodeLine lineNumber="3425"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// will be materialized if we decide to unswitch it.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03426" /><CodeLine lineNumber="3426"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> SuccessorsCount = <a href="/docs/api/namespaces/llvm/#a656efdcee3deb029763304d3e741a2d1">isGuard</a>(&amp;TI) ? 2 : Visited.<a href="/docs/api/classes/llvm/smallptrsetimplbase/#a0e1c3175b0ac22fe3853651c28e1ecb8">size</a>();</Highlight></CodeLine>
<Link id="l03427" /><CodeLine lineNumber="3427"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(SuccessorsCount &gt; 1 &amp;&amp;</Highlight></CodeLine>
<Link id="l03428" /><CodeLine lineNumber="3428"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;Cannot unswitch a condition without multiple distinct successors!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03429" /><CodeLine lineNumber="3429"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> (LoopCost - <a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a>) &#42; (SuccessorsCount - 1);</Highlight></CodeLine>
<Link id="l03430" /><CodeLine lineNumber="3430"><Highlight kind="normal">  &#125;;</Highlight></CodeLine>
<Link id="l03431" /><CodeLine lineNumber="3431"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03432" /><CodeLine lineNumber="3432"><Highlight kind="normal">  std::optional&lt;NonTrivialUnswitchCandidate&gt; Best;</Highlight></CodeLine>
<Link id="l03433" /><CodeLine lineNumber="3433"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;Candidate : UnswitchCandidates) &#123;</Highlight></CodeLine>
<Link id="l03434" /><CodeLine lineNumber="3434"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;TI = &#42;Candidate.TI;</Highlight></CodeLine>
<Link id="l03435" /><CodeLine lineNumber="3435"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;Value &#42;&gt;</a> Invariants = Candidate.Invariants;</Highlight></CodeLine>
<Link id="l03436" /><CodeLine lineNumber="3436"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;BI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BranchInst&gt;</a>(&amp;TI);</Highlight></CodeLine>
<Link id="l03437" /><CodeLine lineNumber="3437"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> FullUnswitch =</Highlight></CodeLine>
<Link id="l03438" /><CodeLine lineNumber="3438"><Highlight kind="normal">        !BI || Candidate.hasPendingInjection() ||</Highlight></CodeLine>
<Link id="l03439" /><CodeLine lineNumber="3439"><Highlight kind="normal">        (Invariants.<a href="/docs/api/classes/llvm/arrayref/#a85ffb6531d4cda988ea81f18d4e56fb7">size</a>() == 1 &amp;&amp;</Highlight></CodeLine>
<Link id="l03440" /><CodeLine lineNumber="3440"><Highlight kind="normal">         Invariants&#91;0&#93; == <a href="#a5ca2e820d1b5a49dcaad5e6873917198">skipTrivialSelect</a>(BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aebd4af5642453ce3169094f08dd3d7b8">getCondition</a>()));</Highlight></CodeLine>
<Link id="l03441" /><CodeLine lineNumber="3441"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/instructioncost">InstructionCost</a> CandidateCost = ComputeUnswitchedCost(TI, FullUnswitch);</Highlight></CodeLine>
<Link id="l03442" /><CodeLine lineNumber="3442"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Calculate cost multiplier which is a tool to limit potentially</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03443" /><CodeLine lineNumber="3443"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// exponential behavior of loop-unswitch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03444" /><CodeLine lineNumber="3444"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#a58389dda20e5bd529f3fb18c6531c7ce">EnableUnswitchCostMultiplier</a>) &#123;</Highlight></CodeLine>
<Link id="l03445" /><CodeLine lineNumber="3445"><Highlight kind="normal">      </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> CostMultiplier =</Highlight></CodeLine>
<Link id="l03446" /><CodeLine lineNumber="3446"><Highlight kind="normal">          <a href="#a0e686f0d790f0fd925a036c4cb50199b">CalculateUnswitchCostMultiplier</a>(TI, L, LI, DT, UnswitchCandidates);</Highlight></CodeLine>
<Link id="l03447" /><CodeLine lineNumber="3447"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(</Highlight></CodeLine>
<Link id="l03448" /><CodeLine lineNumber="3448"><Highlight kind="normal">          (CostMultiplier &gt; 0 &amp;&amp; CostMultiplier &lt;= <a href="#a639210c26d1952e9108bcdbb0353443b">UnswitchThreshold</a>) &amp;&amp;</Highlight></CodeLine>
<Link id="l03449" /><CodeLine lineNumber="3449"><Highlight kind="normal">          </Highlight><Highlight kind="stringliteral">&quot;cost multiplier needs to be in the range of 1..UnswitchThreshold&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03450" /><CodeLine lineNumber="3450"><Highlight kind="normal">      CandidateCost &#42;= CostMultiplier;</Highlight></CodeLine>
<Link id="l03451" /><CodeLine lineNumber="3451"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Computed cost of &quot;</Highlight><Highlight kind="normal"> &lt;&lt; CandidateCost</Highlight></CodeLine>
<Link id="l03452" /><CodeLine lineNumber="3452"><Highlight kind="normal">                        &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; (multiplier: &quot;</Highlight><Highlight kind="normal"> &lt;&lt; CostMultiplier &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;)&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03453" /><CodeLine lineNumber="3453"><Highlight kind="normal">                        &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; for unswitch candidate: &quot;</Highlight><Highlight kind="normal"> &lt;&lt; TI &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03454" /><CodeLine lineNumber="3454"><Highlight kind="normal">    &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l03455" /><CodeLine lineNumber="3455"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Computed cost of &quot;</Highlight><Highlight kind="normal"> &lt;&lt; CandidateCost</Highlight></CodeLine>
<Link id="l03456" /><CodeLine lineNumber="3456"><Highlight kind="normal">                        &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; for unswitch candidate: &quot;</Highlight><Highlight kind="normal"> &lt;&lt; TI &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03457" /><CodeLine lineNumber="3457"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l03458" /><CodeLine lineNumber="3458"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03459" /><CodeLine lineNumber="3459"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!Best || CandidateCost &lt; Best-&gt;<a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a>) &#123;</Highlight></CodeLine>
<Link id="l03460" /><CodeLine lineNumber="3460"><Highlight kind="normal">      Best = Candidate;</Highlight></CodeLine>
<Link id="l03461" /><CodeLine lineNumber="3461"><Highlight kind="normal">      Best-&gt;Cost = CandidateCost;</Highlight></CodeLine>
<Link id="l03462" /><CodeLine lineNumber="3462"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l03463" /><CodeLine lineNumber="3463"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l03464" /><CodeLine lineNumber="3464"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Best &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Must be!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03465" /><CodeLine lineNumber="3465"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> &#42;Best;</Highlight></CodeLine>
<Link id="l03466" /><CodeLine lineNumber="3466"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l03467" /><CodeLine lineNumber="3467"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03468" /><CodeLine lineNumber="3468"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Insert a freeze on an unswitched branch if all is true:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03469" /><CodeLine lineNumber="3469"><Highlight kind="normal"></Highlight><Highlight kind="comment">// 1 freeze-loop-unswitch-cond option is true</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03470" /><CodeLine lineNumber="3470"><Highlight kind="normal"></Highlight><Highlight kind="comment">// 2 The branch may not execute in the loop pre-transformation. If a branch may</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03471" /><CodeLine lineNumber="3471"><Highlight kind="normal"></Highlight><Highlight kind="comment">// not execute and could cause UB, it would always cause UB if it is hoisted outside</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03472" /><CodeLine lineNumber="3472"><Highlight kind="normal"></Highlight><Highlight kind="comment">// of the loop. Insert a freeze to prevent this case.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03473" /><CodeLine lineNumber="3473"><Highlight kind="normal"></Highlight><Highlight kind="comment">// 3 The branch condition may be poison or undef</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03474" /><CodeLine lineNumber="3474" lineLink="#a81f9271273f74a220003075573119a05"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a81f9271273f74a220003075573119a05">shouldInsertFreeze</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;TI, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT,</Highlight></CodeLine>
<Link id="l03475" /><CodeLine lineNumber="3475"><Highlight kind="normal">                               <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &amp;AC) &#123;</Highlight></CodeLine>
<Link id="l03476" /><CodeLine lineNumber="3476"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;BranchInst&gt;</a>(TI) || <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;SwitchInst&gt;</a>(TI));</Highlight></CodeLine>
<Link id="l03477" /><CodeLine lineNumber="3477"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="#a777551c6c08e4e3588b36665a8572414">FreezeLoopUnswitchCond</a>)</Highlight></CodeLine>
<Link id="l03478" /><CodeLine lineNumber="3478"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03479" /><CodeLine lineNumber="3479"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03480" /><CodeLine lineNumber="3480"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/icfloopsafetyinfo">ICFLoopSafetyInfo</a> SafetyInfo;</Highlight></CodeLine>
<Link id="l03481" /><CodeLine lineNumber="3481"><Highlight kind="normal">  SafetyInfo.<a href="/docs/api/classes/llvm/icfloopsafetyinfo/#aca2badb4637a1c884bebc80828feac0a">computeLoopSafetyInfo</a>(&amp;L);</Highlight></CodeLine>
<Link id="l03482" /><CodeLine lineNumber="3482"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SafetyInfo.<a href="/docs/api/classes/llvm/icfloopsafetyinfo/#ab40701961745d6467fa8e23b1e451c12">isGuaranteedToExecute</a>(TI, &amp;DT, &amp;L))</Highlight></CodeLine>
<Link id="l03483" /><CodeLine lineNumber="3483"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03484" /><CodeLine lineNumber="3484"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03485" /><CodeLine lineNumber="3485"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>;</Highlight></CodeLine>
<Link id="l03486" /><CodeLine lineNumber="3486"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;BI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BranchInst&gt;</a>(&amp;TI))</Highlight></CodeLine>
<Link id="l03487" /><CodeLine lineNumber="3487"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a> = <a href="#a5ca2e820d1b5a49dcaad5e6873917198">skipTrivialSelect</a>(BI-&gt;getCondition());</Highlight></CodeLine>
<Link id="l03488" /><CodeLine lineNumber="3488"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03489" /><CodeLine lineNumber="3489"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a> = <a href="#a5ca2e820d1b5a49dcaad5e6873917198">skipTrivialSelect</a>(<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;SwitchInst&gt;</a>(&amp;TI)-&gt;getCondition());</Highlight></CodeLine>
<Link id="l03490" /><CodeLine lineNumber="3490"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> !<a href="/docs/api/namespaces/llvm/#ab8a7ef433279aabf7f30fa5504a4d4ef">isGuaranteedNotToBeUndefOrPoison</a>(</Highlight></CodeLine>
<Link id="l03491" /><CodeLine lineNumber="3491"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, &amp;AC, L.getLoopPreheader()-&gt;getTerminator(), &amp;DT);</Highlight></CodeLine>
<Link id="l03492" /><CodeLine lineNumber="3492"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l03493" /><CodeLine lineNumber="3493"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03494" /><CodeLine lineNumber="3494" lineLink="#acc20b8effcbe869069ff973354344872"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#acc20b8effcbe869069ff973354344872">unswitchBestCondition</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI,</Highlight></CodeLine>
<Link id="l03495" /><CodeLine lineNumber="3495"><Highlight kind="normal">                                  <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &amp;AC, <a href="/docs/api/classes/llvm/aaresults">AAResults</a> &amp;<a href="/docs/api/namespaces/llvm/aa">AA</a>,</Highlight></CodeLine>
<Link id="l03496" /><CodeLine lineNumber="3496"><Highlight kind="normal">                                  <a href="/docs/api/classes/llvm/targettransforminfo">TargetTransformInfo</a> &amp;<a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42;SE,</Highlight></CodeLine>
<Link id="l03497" /><CodeLine lineNumber="3497"><Highlight kind="normal">                                  <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42;MSSAU,</Highlight></CodeLine>
<Link id="l03498" /><CodeLine lineNumber="3498"><Highlight kind="normal">                                  <a href="/docs/api/classes/llvm/lpmupdater">LPMUpdater</a> &amp;LoopUpdater) &#123;</Highlight></CodeLine>
<Link id="l03499" /><CodeLine lineNumber="3499"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Collect all invariant conditions within this loop (as opposed to an inner</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03500" /><CodeLine lineNumber="3500"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// loop which would be handled when visiting that inner loop).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03501" /><CodeLine lineNumber="3501"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;NonTrivialUnswitchCandidate, 4&gt;</a> UnswitchCandidates;</Highlight></CodeLine>
<Link id="l03502" /><CodeLine lineNumber="3502"><Highlight kind="normal">  <a href="/docs/api/structs/llvm/ivconditioninfo">IVConditionInfo</a> PartialIVInfo;</Highlight></CodeLine>
<Link id="l03503" /><CodeLine lineNumber="3503"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;PartialIVCondBranch = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03504" /><CodeLine lineNumber="3504"><Highlight kind="normal">  <a href="#a7737deb6a166cd21dc8465bb48f110b2">collectUnswitchCandidates</a>(UnswitchCandidates, PartialIVInfo,</Highlight></CodeLine>
<Link id="l03505" /><CodeLine lineNumber="3505"><Highlight kind="normal">                            PartialIVCondBranch, L, LI, <a href="/docs/api/namespaces/llvm/aa">AA</a>, MSSAU);</Highlight></CodeLine>
<Link id="l03506" /><CodeLine lineNumber="3506"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/namespaces/llvm/#a3f91ce019424451ab50bf348826fa270">findOptionMDForLoop</a>(&amp;L, </Highlight><Highlight kind="stringliteral">&quot;llvm.loop.unswitch.injection.disable&quot;</Highlight><Highlight kind="normal">))</Highlight></CodeLine>
<Link id="l03507" /><CodeLine lineNumber="3507"><Highlight kind="normal">    <a href="#a607c1e689b230ff38733bfc0bfd3b6da">collectUnswitchCandidatesWithInjections</a>(UnswitchCandidates, PartialIVInfo,</Highlight></CodeLine>
<Link id="l03508" /><CodeLine lineNumber="3508"><Highlight kind="normal">                                            PartialIVCondBranch, L, DT, LI, <a href="/docs/api/namespaces/llvm/aa">AA</a>,</Highlight></CodeLine>
<Link id="l03509" /><CodeLine lineNumber="3509"><Highlight kind="normal">                                            MSSAU);</Highlight></CodeLine>
<Link id="l03510" /><CodeLine lineNumber="3510"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If we didn&#39;t find any candidates, we&#39;re done.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03511" /><CodeLine lineNumber="3511"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UnswitchCandidates.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>())</Highlight></CodeLine>
<Link id="l03512" /><CodeLine lineNumber="3512"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03513" /><CodeLine lineNumber="3513"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03514" /><CodeLine lineNumber="3514"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(</Highlight></CodeLine>
<Link id="l03515" /><CodeLine lineNumber="3515"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Considering &quot;</Highlight><Highlight kind="normal"> &lt;&lt; UnswitchCandidates.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>()</Highlight></CodeLine>
<Link id="l03516" /><CodeLine lineNumber="3516"><Highlight kind="normal">             &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; non-trivial loop invariant conditions for unswitching.\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03517" /><CodeLine lineNumber="3517"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03518" /><CodeLine lineNumber="3518"><Highlight kind="normal">  <a href="/docs/api/structs/anonymous-namespace-simpleloopunswitch-cpp-/nontrivialunswitchcandidate/#a428fcbe432c0149594a5fe987bafd318">NonTrivialUnswitchCandidate</a> Best = <a href="#a52374e76082ee94158724e5695a88a02">findBestNonTrivialUnswitchCandidate</a>(</Highlight></CodeLine>
<Link id="l03519" /><CodeLine lineNumber="3519"><Highlight kind="normal">      UnswitchCandidates, L, DT, LI, AC, <a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>, PartialIVInfo);</Highlight></CodeLine>
<Link id="l03520" /><CodeLine lineNumber="3520"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03521" /><CodeLine lineNumber="3521"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Best.TI &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Failed to find loop unswitch candidate&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03522" /><CodeLine lineNumber="3522"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Best.Cost &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Failed to compute cost&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03523" /><CodeLine lineNumber="3523"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03524" /><CodeLine lineNumber="3524"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (&#42;Best.Cost &gt;= <a href="#a639210c26d1952e9108bcdbb0353443b">UnswitchThreshold</a>) &#123;</Highlight></CodeLine>
<Link id="l03525" /><CodeLine lineNumber="3525"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Cannot unswitch, lowest cost found: &quot;</Highlight><Highlight kind="normal"> &lt;&lt; &#42;Best.Cost</Highlight></CodeLine>
<Link id="l03526" /><CodeLine lineNumber="3526"><Highlight kind="normal">                      &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03527" /><CodeLine lineNumber="3527"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03528" /><CodeLine lineNumber="3528"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l03529" /><CodeLine lineNumber="3529"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03530" /><CodeLine lineNumber="3530"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> InjectedCondition = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03531" /><CodeLine lineNumber="3531"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Best.hasPendingInjection()) &#123;</Highlight></CodeLine>
<Link id="l03532" /><CodeLine lineNumber="3532"><Highlight kind="normal">    Best = <a href="#aa8f270ce4d001ee9e7839aa11c607931">injectPendingInvariantConditions</a>(Best, L, DT, LI, AC, MSSAU);</Highlight></CodeLine>
<Link id="l03533" /><CodeLine lineNumber="3533"><Highlight kind="normal">    InjectedCondition = </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03534" /><CodeLine lineNumber="3534"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l03535" /><CodeLine lineNumber="3535"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!Best.hasPendingInjection() &amp;&amp;</Highlight></CodeLine>
<Link id="l03536" /><CodeLine lineNumber="3536"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;All injections should have been done by now!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03537" /><CodeLine lineNumber="3537"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03538" /><CodeLine lineNumber="3538"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Best.TI != PartialIVCondBranch)</Highlight></CodeLine>
<Link id="l03539" /><CodeLine lineNumber="3539"><Highlight kind="normal">    PartialIVInfo.<a href="/docs/api/structs/llvm/ivconditioninfo/#a753ed4570ed0ac6d4f264c22b69a8add">InstToDuplicate</a>.<a href="/docs/api/classes/llvm/smallvectorimpl/#aac0ea55010b7b1a301e65a0baea057aa">clear</a>();</Highlight></CodeLine>
<Link id="l03540" /><CodeLine lineNumber="3540"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03541" /><CodeLine lineNumber="3541"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> InsertFreeze;</Highlight></CodeLine>
<Link id="l03542" /><CodeLine lineNumber="3542"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;<a href="/docs/api/namespaces/llvm/si">SI</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;SelectInst&gt;</a>(Best.TI)) &#123;</Highlight></CodeLine>
<Link id="l03543" /><CodeLine lineNumber="3543"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If the best candidate is a select, turn it into a branch. Select</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03544" /><CodeLine lineNumber="3544"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// instructions with a poison conditional do not propagate poison, but</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03545" /><CodeLine lineNumber="3545"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// branching on poison causes UB. Insert a freeze on the select</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03546" /><CodeLine lineNumber="3546"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// conditional to prevent UB after turning the select into a branch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03547" /><CodeLine lineNumber="3547"><Highlight kind="normal">    InsertFreeze = !<a href="/docs/api/namespaces/llvm/#ab8a7ef433279aabf7f30fa5504a4d4ef">isGuaranteedNotToBeUndefOrPoison</a>(</Highlight></CodeLine>
<Link id="l03548" /><CodeLine lineNumber="3548"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getCondition(), &amp;AC, L.getLoopPreheader()-&gt;getTerminator(), &amp;DT);</Highlight></CodeLine>
<Link id="l03549" /><CodeLine lineNumber="3549"><Highlight kind="normal">    Best.TI = <a href="#a2e6301db15e4516c92e21f33761886c6">turnSelectIntoBranch</a>(<a href="/docs/api/namespaces/llvm/si">SI</a>, DT, LI, MSSAU, &amp;AC);</Highlight></CodeLine>
<Link id="l03550" /><CodeLine lineNumber="3550"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l03551" /><CodeLine lineNumber="3551"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If the best candidate is a guard, turn it into a branch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03552" /><CodeLine lineNumber="3552"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a656efdcee3deb029763304d3e741a2d1">isGuard</a>(Best.TI))</Highlight></CodeLine>
<Link id="l03553" /><CodeLine lineNumber="3553"><Highlight kind="normal">      Best.TI =</Highlight></CodeLine>
<Link id="l03554" /><CodeLine lineNumber="3554"><Highlight kind="normal">          <a href="#af3ac46dde637293a34d0ff7b619a656b">turnGuardIntoBranch</a>(<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;IntrinsicInst&gt;</a>(Best.TI), L, DT, LI, MSSAU);</Highlight></CodeLine>
<Link id="l03555" /><CodeLine lineNumber="3555"><Highlight kind="normal">    InsertFreeze = <a href="#a81f9271273f74a220003075573119a05">shouldInsertFreeze</a>(L, &#42;Best.TI, DT, AC);</Highlight></CodeLine>
<Link id="l03556" /><CodeLine lineNumber="3556"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l03557" /><CodeLine lineNumber="3557"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03558" /><CodeLine lineNumber="3558"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Unswitching non-trivial (cost = &quot;</Highlight><Highlight kind="normal"> &lt;&lt; Best.Cost</Highlight></CodeLine>
<Link id="l03559" /><CodeLine lineNumber="3559"><Highlight kind="normal">                    &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;) terminator: &quot;</Highlight><Highlight kind="normal"> &lt;&lt; &#42;Best.TI &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03560" /><CodeLine lineNumber="3560"><Highlight kind="normal">  <a href="#aae4261fb86bc9023c3383785afa66b9a">unswitchNontrivialInvariants</a>(L, &#42;Best.TI, Best.Invariants, PartialIVInfo, DT,</Highlight></CodeLine>
<Link id="l03561" /><CodeLine lineNumber="3561"><Highlight kind="normal">                               LI, AC, SE, MSSAU, LoopUpdater, InsertFreeze,</Highlight></CodeLine>
<Link id="l03562" /><CodeLine lineNumber="3562"><Highlight kind="normal">                               InjectedCondition);</Highlight></CodeLine>
<Link id="l03563" /><CodeLine lineNumber="3563"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03564" /><CodeLine lineNumber="3564"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l03565" /><CodeLine lineNumber="3565"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l03566" /><CodeLine lineNumber="3566"><Highlight kind="comment">/// Unswitch control flow predicated on loop invariant conditions.</Highlight></CodeLine>
<Link id="l03567" /><CodeLine lineNumber="3567"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l03568" /><CodeLine lineNumber="3568"><Highlight kind="comment">/// This first hoists all branches or switches which are trivial (IE, do not</Highlight></CodeLine>
<Link id="l03569" /><CodeLine lineNumber="3569"><Highlight kind="comment">/// require duplicating any part of the loop) out of the loop body. It then</Highlight></CodeLine>
<Link id="l03570" /><CodeLine lineNumber="3570"><Highlight kind="comment">/// looks at other loop invariant control flows and tries to unswitch those as</Highlight></CodeLine>
<Link id="l03571" /><CodeLine lineNumber="3571"><Highlight kind="comment">/// well by cloning the loop if the result is small enough.</Highlight></CodeLine>
<Link id="l03572" /><CodeLine lineNumber="3572"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l03573" /><CodeLine lineNumber="3573"><Highlight kind="comment">/// The &#96;DT&#96;, &#96;LI&#96;, &#96;AC&#96;, &#96;AA&#96;, &#96;TTI&#96; parameters are required analyses that are</Highlight></CodeLine>
<Link id="l03574" /><CodeLine lineNumber="3574"><Highlight kind="comment">/// also updated based on the unswitch. The &#96;MSSA&#96; analysis is also updated if</Highlight></CodeLine>
<Link id="l03575" /><CodeLine lineNumber="3575"><Highlight kind="comment">/// valid (i.e. its use is enabled).</Highlight></CodeLine>
<Link id="l03576" /><CodeLine lineNumber="3576"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l03577" /><CodeLine lineNumber="3577"><Highlight kind="comment">/// If either &#96;NonTrivial&#96; is true or the flag &#96;EnableNonTrivialUnswitch&#96; is</Highlight></CodeLine>
<Link id="l03578" /><CodeLine lineNumber="3578"><Highlight kind="comment">/// true, we will attempt to do non-trivial unswitching as well as trivial</Highlight></CodeLine>
<Link id="l03579" /><CodeLine lineNumber="3579"><Highlight kind="comment">/// unswitching.</Highlight></CodeLine>
<Link id="l03580" /><CodeLine lineNumber="3580"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l03581" /><CodeLine lineNumber="3581"><Highlight kind="comment">/// The &#96;postUnswitch&#96; function will be run after unswitching is complete</Highlight></CodeLine>
<Link id="l03582" /><CodeLine lineNumber="3582"><Highlight kind="comment">/// with information on whether or not the provided loop remains a loop and</Highlight></CodeLine>
<Link id="l03583" /><CodeLine lineNumber="3583"><Highlight kind="comment">/// a list of new sibling loops created.</Highlight></CodeLine>
<Link id="l03584" /><CodeLine lineNumber="3584"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l03585" /><CodeLine lineNumber="3585"><Highlight kind="comment">/// If &#96;SE&#96; is non-null, we will update that analysis based on the unswitching</Highlight></CodeLine>
<Link id="l03586" /><CodeLine lineNumber="3586"><Highlight kind="comment">/// done.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03587" /><CodeLine lineNumber="3587" lineLink="#a00b3b7cedd83de61be0312c6535f3f37"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a00b3b7cedd83de61be0312c6535f3f37">unswitchLoop</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &amp;LI,</Highlight></CodeLine>
<Link id="l03588" /><CodeLine lineNumber="3588"><Highlight kind="normal">                         <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &amp;AC, <a href="/docs/api/classes/llvm/aaresults">AAResults</a> &amp;<a href="/docs/api/namespaces/llvm/aa">AA</a>,</Highlight></CodeLine>
<Link id="l03589" /><CodeLine lineNumber="3589"><Highlight kind="normal">                         <a href="/docs/api/classes/llvm/targettransforminfo">TargetTransformInfo</a> &amp;<a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>, </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> Trivial,</Highlight></CodeLine>
<Link id="l03590" /><CodeLine lineNumber="3590"><Highlight kind="normal">                         </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> NonTrivial, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42;SE,</Highlight></CodeLine>
<Link id="l03591" /><CodeLine lineNumber="3591"><Highlight kind="normal">                         <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42;MSSAU, <a href="/docs/api/classes/llvm/profilesummaryinfo">ProfileSummaryInfo</a> &#42;PSI,</Highlight></CodeLine>
<Link id="l03592" /><CodeLine lineNumber="3592"><Highlight kind="normal">                         <a href="/docs/api/classes/llvm/blockfrequencyinfo">BlockFrequencyInfo</a> &#42;BFI, <a href="/docs/api/classes/llvm/lpmupdater">LPMUpdater</a> &amp;LoopUpdater) &#123;</Highlight></CodeLine>
<Link id="l03593" /><CodeLine lineNumber="3593"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(L.isRecursivelyLCSSAForm(DT, LI) &amp;&amp;</Highlight></CodeLine>
<Link id="l03594" /><CodeLine lineNumber="3594"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;Loops must be in LCSSA form before unswitching.&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03595" /><CodeLine lineNumber="3595"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03596" /><CodeLine lineNumber="3596"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Must be in loop simplified form: we need a preheader and dedicated exits.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03597" /><CodeLine lineNumber="3597"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!L.isLoopSimplifyForm())</Highlight></CodeLine>
<Link id="l03598" /><CodeLine lineNumber="3598"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03599" /><CodeLine lineNumber="3599"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03600" /><CodeLine lineNumber="3600"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Try trivial unswitch first before loop over other basic blocks in the loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03601" /><CodeLine lineNumber="3601"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Trivial &amp;&amp; <a href="#a050cc2b2d1467ffcad6a825f1141424c">unswitchAllTrivialConditions</a>(L, DT, LI, SE, MSSAU)) &#123;</Highlight></CodeLine>
<Link id="l03602" /><CodeLine lineNumber="3602"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If we unswitched successfully we will want to clean up the loop before</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03603" /><CodeLine lineNumber="3603"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// processing it further so just mark it as unswitched and return.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03604" /><CodeLine lineNumber="3604"><Highlight kind="normal">    <a href="#a45007554e260296266b8ae927dde223f">postUnswitch</a>(L, LoopUpdater, L.getName(),</Highlight></CodeLine>
<Link id="l03605" /><CodeLine lineNumber="3605"><Highlight kind="normal">                 </Highlight><Highlight kind="comment">/&#42;CurrentLoopValid&#42;/</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">, </Highlight><Highlight kind="comment">/&#42;PartiallyInvariant&#42;/</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l03606" /><CodeLine lineNumber="3606"><Highlight kind="normal">                 </Highlight><Highlight kind="comment">/&#42;InjectedCondition&#42;/</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">, &#123;&#125;);</Highlight></CodeLine>
<Link id="l03607" /><CodeLine lineNumber="3607"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03608" /><CodeLine lineNumber="3608"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l03609" /><CodeLine lineNumber="3609"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03610" /><CodeLine lineNumber="3610"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/function">Function</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = L.getHeader()-&gt;getParent();</Highlight></CodeLine>
<Link id="l03611" /><CodeLine lineNumber="3611"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03612" /><CodeLine lineNumber="3612"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Check whether we should continue with non-trivial conditions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03613" /><CodeLine lineNumber="3613"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// EnableNonTrivialUnswitch: Global variable that forces non-trivial</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03614" /><CodeLine lineNumber="3614"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//                           unswitching for testing and debugging.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03615" /><CodeLine lineNumber="3615"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// NonTrivial: Parameter that enables non-trivial unswitching for this</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03616" /><CodeLine lineNumber="3616"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//             invocation of the transform. But this should be allowed only</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03617" /><CodeLine lineNumber="3617"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//             for targets without branch divergence.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03618" /><CodeLine lineNumber="3618"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03619" /><CodeLine lineNumber="3619"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// FIXME: If divergence analysis becomes available to a loop</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03620" /><CodeLine lineNumber="3620"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// transform, we should allow unswitching for non-trivial uniform</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03621" /><CodeLine lineNumber="3621"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// branches even on targets that have divergence.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03622" /><CodeLine lineNumber="3622"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// https://bugs.llvm.org/show&#95;bug.cgi?id=48819</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03623" /><CodeLine lineNumber="3623"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> ContinueWithNonTrivial =</Highlight></CodeLine>
<Link id="l03624" /><CodeLine lineNumber="3624"><Highlight kind="normal">      <a href="#a08f48517d908cdf7a21eed936deb7f7c">EnableNonTrivialUnswitch</a> || (NonTrivial &amp;&amp; !<a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>.hasBranchDivergence(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>));</Highlight></CodeLine>
<Link id="l03625" /><CodeLine lineNumber="3625"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!ContinueWithNonTrivial)</Highlight></CodeLine>
<Link id="l03626" /><CodeLine lineNumber="3626"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03627" /><CodeLine lineNumber="3627"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03628" /><CodeLine lineNumber="3628"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Skip non-trivial unswitching for optsize functions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03629" /><CodeLine lineNumber="3629"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;hasOptSize())</Highlight></CodeLine>
<Link id="l03630" /><CodeLine lineNumber="3630"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03631" /><CodeLine lineNumber="3631"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03632" /><CodeLine lineNumber="3632"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Returns true if Loop L&#39;s loop nest is cold, i.e. if the headers of L,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03633" /><CodeLine lineNumber="3633"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// of the loops L is nested in, and of the loops nested in L are all cold.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03634" /><CodeLine lineNumber="3634"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> IsLoopNestCold = &#91;&amp;&#93;(</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L) &#123;</Highlight></CodeLine>
<Link id="l03635" /><CodeLine lineNumber="3635"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Check L and all of its parent loops.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03636" /><CodeLine lineNumber="3636"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;Parent = L;</Highlight></CodeLine>
<Link id="l03637" /><CodeLine lineNumber="3637"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (Parent) &#123;</Highlight></CodeLine>
<Link id="l03638" /><CodeLine lineNumber="3638"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!PSI-&gt;<a href="/docs/api/classes/llvm/profilesummaryinfo/#a597b25ab8d0a79f855c6c66dc48cb803">isColdBlock</a>(Parent-&gt;getHeader(), BFI))</Highlight></CodeLine>
<Link id="l03639" /><CodeLine lineNumber="3639"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03640" /><CodeLine lineNumber="3640"><Highlight kind="normal">      Parent = Parent-&gt;getParentLoop();</Highlight></CodeLine>
<Link id="l03641" /><CodeLine lineNumber="3641"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l03642" /><CodeLine lineNumber="3642"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Next check all loops nested within L.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03643" /><CodeLine lineNumber="3643"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;const Loop &#42;, 4&gt;</a> Worklist;</Highlight></CodeLine>
<Link id="l03644" /><CodeLine lineNumber="3644"><Highlight kind="normal">    Worklist.<a href="/docs/api/classes/llvm/smallvectorimpl/#a94d23373106467003722f7d6c17b1528">insert</a>(Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a075e34e98605d0e7c289763a104869ac">end</a>(), L-&gt;getSubLoops().begin(),</Highlight></CodeLine>
<Link id="l03645" /><CodeLine lineNumber="3645"><Highlight kind="normal">                    L-&gt;getSubLoops().end());</Highlight></CodeLine>
<Link id="l03646" /><CodeLine lineNumber="3646"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (!Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>()) &#123;</Highlight></CodeLine>
<Link id="l03647" /><CodeLine lineNumber="3647"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;CurLoop = Worklist.<a href="/docs/api/classes/llvm/smallvectorimpl/#a0c8ffe664a36e30d49c84d0aded2fe08">pop&#95;back&#95;val</a>();</Highlight></CodeLine>
<Link id="l03648" /><CodeLine lineNumber="3648"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!PSI-&gt;<a href="/docs/api/classes/llvm/profilesummaryinfo/#a597b25ab8d0a79f855c6c66dc48cb803">isColdBlock</a>(CurLoop-&gt;getHeader(), BFI))</Highlight></CodeLine>
<Link id="l03649" /><CodeLine lineNumber="3649"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03650" /><CodeLine lineNumber="3650"><Highlight kind="normal">      Worklist.<a href="/docs/api/classes/llvm/smallvectorimpl/#a94d23373106467003722f7d6c17b1528">insert</a>(Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a075e34e98605d0e7c289763a104869ac">end</a>(), CurLoop-&gt;getSubLoops().begin(),</Highlight></CodeLine>
<Link id="l03651" /><CodeLine lineNumber="3651"><Highlight kind="normal">                      CurLoop-&gt;getSubLoops().end());</Highlight></CodeLine>
<Link id="l03652" /><CodeLine lineNumber="3652"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l03653" /><CodeLine lineNumber="3653"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03654" /><CodeLine lineNumber="3654"><Highlight kind="normal">  &#125;;</Highlight></CodeLine>
<Link id="l03655" /><CodeLine lineNumber="3655"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03656" /><CodeLine lineNumber="3656"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Skip cold loops in cold loop nests, as unswitching them brings little</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03657" /><CodeLine lineNumber="3657"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// benefit but increases the code size</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03658" /><CodeLine lineNumber="3658"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (PSI &amp;&amp; PSI-&gt;<a href="/docs/api/classes/llvm/profilesummaryinfo/#a11d1c1af51bf81a6a9f8f5191b5e3cf2">hasProfileSummary</a>() &amp;&amp; BFI &amp;&amp; IsLoopNestCold(&amp;L)) &#123;</Highlight></CodeLine>
<Link id="l03659" /><CodeLine lineNumber="3659"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; Skip cold loop: &quot;</Highlight><Highlight kind="normal"> &lt;&lt; L &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03660" /><CodeLine lineNumber="3660"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03661" /><CodeLine lineNumber="3661"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l03662" /><CodeLine lineNumber="3662"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03663" /><CodeLine lineNumber="3663"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Perform legality checks.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03664" /><CodeLine lineNumber="3664"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="#a41cbe08b01edbedddb8d8706d13c5270">isSafeForNoNTrivialUnswitching</a>(L, LI))</Highlight></CodeLine>
<Link id="l03665" /><CodeLine lineNumber="3665"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03666" /><CodeLine lineNumber="3666"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03667" /><CodeLine lineNumber="3667"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// For non-trivial unswitching, because it often creates new loops, we rely on</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03668" /><CodeLine lineNumber="3668"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the pass manager to iterate on the loops rather than trying to immediately</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03669" /><CodeLine lineNumber="3669"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// reach a fixed point. There is no substantial advantage to iterating</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03670" /><CodeLine lineNumber="3670"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// internally, and if any of the new loops are simplified enough to contain</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03671" /><CodeLine lineNumber="3671"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// trivial unswitching we want to prefer those.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03672" /><CodeLine lineNumber="3672"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03673" /><CodeLine lineNumber="3673"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Try to unswitch the best invariant condition. We prefer this full unswitch to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03674" /><CodeLine lineNumber="3674"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// a partial unswitch when possible below the threshold.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03675" /><CodeLine lineNumber="3675"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#acc20b8effcbe869069ff973354344872">unswitchBestCondition</a>(L, DT, LI, AC, <a href="/docs/api/namespaces/llvm/aa">AA</a>, <a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>, SE, MSSAU, LoopUpdater))</Highlight></CodeLine>
<Link id="l03676" /><CodeLine lineNumber="3676"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03677" /><CodeLine lineNumber="3677"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03678" /><CodeLine lineNumber="3678"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// No other opportunities to unswitch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03679" /><CodeLine lineNumber="3679"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03680" /><CodeLine lineNumber="3680"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l03681" /><CodeLine lineNumber="3681"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03682" /><CodeLine lineNumber="3682" lineLink="/docs/api/classes/llvm/simpleloopunswitchpass/#ae7088b7b5c8bd069497f13e3e1990eff"><Highlight kind="normal"><a href="/docs/api/classes/llvm/preservedanalyses">PreservedAnalyses</a> <a href="/docs/api/classes/llvm/simpleloopunswitchpass/#ae7088b7b5c8bd069497f13e3e1990eff">SimpleLoopUnswitchPass::run</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, <a href="/docs/api/namespaces/llvm/#a58dde534a0ea2a23cb6c779c5c283f75">LoopAnalysisManager</a> &amp;AM,</Highlight></CodeLine>
<Link id="l03683" /><CodeLine lineNumber="3683"><Highlight kind="normal">                                              <a href="/docs/api/structs/llvm/loopstandardanalysisresults">LoopStandardAnalysisResults</a> &amp;AR,</Highlight></CodeLine>
<Link id="l03684" /><CodeLine lineNumber="3684"><Highlight kind="normal">                                              <a href="/docs/api/classes/llvm/lpmupdater">LPMUpdater</a> &amp;U) &#123;</Highlight></CodeLine>
<Link id="l03685" /><CodeLine lineNumber="3685"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = &#42;L.getHeader()-&gt;getParent();</Highlight></CodeLine>
<Link id="l03686" /><CodeLine lineNumber="3686"><Highlight kind="normal">  (void)<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>;</Highlight></CodeLine>
<Link id="l03687" /><CodeLine lineNumber="3687"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/profilesummaryinfo">ProfileSummaryInfo</a> &#42;PSI = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03688" /><CodeLine lineNumber="3688"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> OuterProxy =</Highlight></CodeLine>
<Link id="l03689" /><CodeLine lineNumber="3689"><Highlight kind="normal">          AM.<a href="/docs/api/classes/llvm/analysismanager/#aaab1fad63e4f3b8679469720a873fedd">getResult</a>&lt;<a href="/docs/api/namespaces/llvm/#a981d102917dd5641837cce49b0b702a1">FunctionAnalysisManagerLoopProxy</a>&gt;(L, AR)</Highlight></CodeLine>
<Link id="l03690" /><CodeLine lineNumber="3690"><Highlight kind="normal">              .getCachedResult&lt;<a href="/docs/api/namespaces/llvm/#a2b0ee73723ccffec457f8712220b0c25">ModuleAnalysisManagerFunctionProxy</a>&gt;(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>))</Highlight></CodeLine>
<Link id="l03691" /><CodeLine lineNumber="3691"><Highlight kind="normal">    PSI = OuterProxy-&gt;getCachedResult&lt;<a href="/docs/api/classes/llvm/profilesummaryanalysis">ProfileSummaryAnalysis</a>&gt;(&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getParent());</Highlight></CodeLine>
<Link id="l03692" /><CodeLine lineNumber="3692"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Unswitching loop in &quot;</Highlight><Highlight kind="normal"> &lt;&lt; <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getName() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;: &quot;</Highlight><Highlight kind="normal"> &lt;&lt; L</Highlight></CodeLine>
<Link id="l03693" /><CodeLine lineNumber="3693"><Highlight kind="normal">                    &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l03694" /><CodeLine lineNumber="3694"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03695" /><CodeLine lineNumber="3695"><Highlight kind="normal">  std::optional&lt;MemorySSAUpdater&gt; MSSAU;</Highlight></CodeLine>
<Link id="l03696" /><CodeLine lineNumber="3696"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (AR.<a href="/docs/api/structs/llvm/loopstandardanalysisresults/#a1cfb392c267da10531478c2f42baa603">MSSA</a>) &#123;</Highlight></CodeLine>
<Link id="l03697" /><CodeLine lineNumber="3697"><Highlight kind="normal">    MSSAU = <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a>(AR.<a href="/docs/api/structs/llvm/loopstandardanalysisresults/#a1cfb392c267da10531478c2f42baa603">MSSA</a>);</Highlight></CodeLine>
<Link id="l03698" /><CodeLine lineNumber="3698"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l03699" /><CodeLine lineNumber="3699"><Highlight kind="normal">      AR.<a href="/docs/api/structs/llvm/loopstandardanalysisresults/#a1cfb392c267da10531478c2f42baa603">MSSA</a>-&gt;<a href="/docs/api/classes/llvm/memoryssa/#a88b10d37f671e58cf138ac84a8257c17">verifyMemorySSA</a>();</Highlight></CodeLine>
<Link id="l03700" /><CodeLine lineNumber="3700"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l03701" /><CodeLine lineNumber="3701"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="#a00b3b7cedd83de61be0312c6535f3f37">unswitchLoop</a>(L, AR.<a href="/docs/api/structs/llvm/loopstandardanalysisresults/#aaa96df870a1b3d7ffc56bec3eb0b0cff">DT</a>, AR.<a href="/docs/api/structs/llvm/loopstandardanalysisresults/#aa09379aa4435be95eb717dd9b5d8b4c5">LI</a>, AR.<a href="/docs/api/structs/llvm/loopstandardanalysisresults/#a902b4712394a3b3450893634b3302893">AC</a>, AR.<a href="/docs/api/structs/llvm/loopstandardanalysisresults/#abd7da877be8576011299f4fcaaf299be">AA</a>, AR.<a href="/docs/api/structs/llvm/loopstandardanalysisresults/#a3444a9359f5f17f1694f82c41d5fd574">TTI</a>, Trivial, NonTrivial,</Highlight></CodeLine>
<Link id="l03702" /><CodeLine lineNumber="3702"><Highlight kind="normal">                    &amp;AR.<a href="/docs/api/structs/llvm/loopstandardanalysisresults/#a124376878e24aef4252795ba9fea420f">SE</a>, MSSAU ? &amp;&#42;MSSAU : </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">, PSI, AR.<a href="/docs/api/structs/llvm/loopstandardanalysisresults/#a0fbd3535a2ca32937aebf75738e854fb">BFI</a>, U))</Highlight></CodeLine>
<Link id="l03703" /><CodeLine lineNumber="3703"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/preservedanalyses/#a1258a1ff55557c27684010ebd7283712">PreservedAnalyses::all</a>();</Highlight></CodeLine>
<Link id="l03704" /><CodeLine lineNumber="3704"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03705" /><CodeLine lineNumber="3705"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (AR.<a href="/docs/api/structs/llvm/loopstandardanalysisresults/#a1cfb392c267da10531478c2f42baa603">MSSA</a> &amp;&amp; <a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l03706" /><CodeLine lineNumber="3706"><Highlight kind="normal">    AR.<a href="/docs/api/structs/llvm/loopstandardanalysisresults/#a1cfb392c267da10531478c2f42baa603">MSSA</a>-&gt;<a href="/docs/api/classes/llvm/memoryssa/#a88b10d37f671e58cf138ac84a8257c17">verifyMemorySSA</a>();</Highlight></CodeLine>
<Link id="l03707" /><CodeLine lineNumber="3707"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03708" /><CodeLine lineNumber="3708"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Historically this pass has had issues with the dominator tree so verify it</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03709" /><CodeLine lineNumber="3709"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// in asserts builds.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03710" /><CodeLine lineNumber="3710"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(AR.<a href="/docs/api/structs/llvm/loopstandardanalysisresults/#aaa96df870a1b3d7ffc56bec3eb0b0cff">DT</a>.<a href="/docs/api/classes/llvm/dominatortreebase/#a1f08f2925fec05b265e540d29066b9c8">verify</a>(DominatorTree::VerificationLevel::Fast));</Highlight></CodeLine>
<Link id="l03711" /><CodeLine lineNumber="3711"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03712" /><CodeLine lineNumber="3712"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> PA = <a href="/docs/api/namespaces/llvm/#ac7294ba4e105807674fe3a394437fcc1">getLoopPassPreservedAnalyses</a>();</Highlight></CodeLine>
<Link id="l03713" /><CodeLine lineNumber="3713"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (AR.<a href="/docs/api/structs/llvm/loopstandardanalysisresults/#a1cfb392c267da10531478c2f42baa603">MSSA</a>)</Highlight></CodeLine>
<Link id="l03714" /><CodeLine lineNumber="3714"><Highlight kind="normal">    PA.preserve&lt;<a href="/docs/api/classes/llvm/memoryssaanalysis">MemorySSAAnalysis</a>&gt;();</Highlight></CodeLine>
<Link id="l03715" /><CodeLine lineNumber="3715"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> PA;</Highlight></CodeLine>
<Link id="l03716" /><CodeLine lineNumber="3716"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l03717" /><CodeLine lineNumber="3717"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03718" /><CodeLine lineNumber="3718" lineLink="/docs/api/classes/llvm/simpleloopunswitchpass/#a200a7ffd107aee97365d96726a222fc0"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/simpleloopunswitchpass/#a200a7ffd107aee97365d96726a222fc0">SimpleLoopUnswitchPass::printPipeline</a>(</Highlight></CodeLine>
<Link id="l03719" /><CodeLine lineNumber="3719"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/raw-ostream">raw&#95;ostream</a> &amp;OS, <a href="/docs/api/classes/llvm/function-ref">function&#95;ref</a>&lt;<a href="/docs/api/classes/llvm/stringref">StringRef</a>(<a href="/docs/api/classes/llvm/stringref">StringRef</a>)&gt; MapClassName2PassName) &#123;</Highlight></CodeLine>
<Link id="l03720" /><CodeLine lineNumber="3720"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">static&#95;cast&lt;</Highlight><Highlight kind="normal"><a href="/docs/api/structs/llvm/passinfomixin">PassInfoMixin&lt;SimpleLoopUnswitchPass&gt;</a> &#42;</Highlight><Highlight kind="keyword">&gt;</Highlight><Highlight kind="normal">(</Highlight><Highlight kind="keyword">this</Highlight><Highlight kind="normal">)-&gt;<a href="/docs/api/classes/llvm/simpleloopunswitchpass/#a200a7ffd107aee97365d96726a222fc0">printPipeline</a>(</Highlight></CodeLine>
<Link id="l03721" /><CodeLine lineNumber="3721"><Highlight kind="normal">      OS, MapClassName2PassName);</Highlight></CodeLine>
<Link id="l03722" /><CodeLine lineNumber="3722"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l03723" /><CodeLine lineNumber="3723"><Highlight kind="normal">  OS &lt;&lt; </Highlight><Highlight kind="charliteral">&#39;&lt;&#39;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03724" /><CodeLine lineNumber="3724"><Highlight kind="normal">  OS &lt;&lt; (NonTrivial ? </Highlight><Highlight kind="stringliteral">&quot;&quot;</Highlight><Highlight kind="normal"> : </Highlight><Highlight kind="stringliteral">&quot;no-&quot;</Highlight><Highlight kind="normal">) &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;nontrivial;&quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03725" /><CodeLine lineNumber="3725"><Highlight kind="normal">  OS &lt;&lt; (Trivial ? </Highlight><Highlight kind="stringliteral">&quot;&quot;</Highlight><Highlight kind="normal"> : </Highlight><Highlight kind="stringliteral">&quot;no-&quot;</Highlight><Highlight kind="normal">) &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;trivial&quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03726" /><CodeLine lineNumber="3726"><Highlight kind="normal">  OS &lt;&lt; </Highlight><Highlight kind="charliteral">&#39;&gt;&#39;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l03727" /><CodeLine lineNumber="3727"><Highlight kind="normal">&#125;</Highlight></CodeLine>

</ProgramListing>


</DoxygenPage>
