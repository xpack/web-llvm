---

# DO NOT EDIT!
# Automatically generated via docusaurus-plugin-doxygen by Doxygen.

slug: /api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp
custom_edit_url: null
keywords:
  - doxygen
  - reference
  - file

---

import Link from '@docusaurus/Link'

import CodeLine from '@xpack/docusaurus-plugin-doxygen/components/CodeLine'
import DoxygenPage from '@xpack/docusaurus-plugin-doxygen/components/DoxygenPage'
import IncludesList from '@xpack/docusaurus-plugin-doxygen/components/IncludesList'
import IncludesListItem from '@xpack/docusaurus-plugin-doxygen/components/IncludesListItem'
import MemberDefinition from '@xpack/docusaurus-plugin-doxygen/components/MemberDefinition'
import MembersIndex from '@xpack/docusaurus-plugin-doxygen/components/MembersIndex'
import MembersIndexItem from '@xpack/docusaurus-plugin-doxygen/components/MembersIndexItem'
import ProgramListing from '@xpack/docusaurus-plugin-doxygen/components/ProgramListing'
import SectionDefinition from '@xpack/docusaurus-plugin-doxygen/components/SectionDefinition'
import SectionUser from '@xpack/docusaurus-plugin-doxygen/components/SectionUser'

import pluginConfig from '@site/docusaurus-plugin-doxygen-config.json'

# The `CoroSplit.cpp` File Reference

<DoxygenPage pluginConfig={pluginConfig}>



## Included Headers

<IncludesList>
<IncludesListItem
  filePath="llvm/Transforms/Coroutines/CoroSplit.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/coroutines/corosplit-h"
  isLocal="true" />
<IncludesListItem
  filePath="CoroCloner.h"
  permalink="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corocloner-h"
  isLocal="true" />
<IncludesListItem
  filePath="CoroInternal.h"
  permalink="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corointernal-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/DenseMap.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/densemap-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/PriorityWorklist.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/priorityworklist-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/STLExtras.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/stlextras-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SmallPtrSet.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/smallptrset-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SmallVector.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/smallvector-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/StringExtras.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/stringextras-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/StringRef.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/stringref-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/Twine.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/twine-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/CFG.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/cfg-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/CallGraph.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/callgraph-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/ConstantFolding.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/constantfolding-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/LazyCallGraph.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/lazycallgraph-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/OptimizationRemarkEmitter.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/optimizationremarkemitter-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/TargetTransformInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/targettransforminfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/BinaryFormat/Dwarf.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/binaryformat/dwarf-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Argument.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/argument-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Attributes.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/attributes-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/BasicBlock.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/basicblock-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/CFG.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/cfg-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/CallingConv.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/callingconv-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Constants.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/constants-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/DataLayout.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/datalayout-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/DebugInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/debuginfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/DerivedTypes.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/derivedtypes-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Dominators.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/dominators-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/GlobalValue.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/globalvalue-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/GlobalVariable.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/globalvariable-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/InstIterator.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/institerator-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/InstrTypes.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/instrtypes-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Instruction.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/instruction-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Instructions.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/instructions-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/IntrinsicInst.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/intrinsicinst-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/LLVMContext.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/llvmcontext-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Module.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/module-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Type.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/type-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Value.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/value-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Verifier.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/verifier-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/Casting.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/casting-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/Debug.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/debug-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/PrettyStackTrace.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/prettystacktrace-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/raw_ostream.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/raw-ostream-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Coroutines/MaterializationUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/coroutines/materializationutils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Scalar.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/scalar-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/BasicBlockUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/basicblockutils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/CallGraphUpdater.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/callgraphupdater-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/Cloning.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/cloning-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/Local.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/local-h"
  isLocal="true" />
<IncludesListItem
  filePath="cassert"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="cstddef"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="cstdint"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="initializer_list"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="iterator"
  permalink=""
  isLocal="false" />
</IncludesList>

## Namespaces Index

<MembersIndex>

<MembersIndexItem
  type="namespace"
  name={<><a href="/docs/api/namespaces/anonymous-corosplit-cpp-">anonymous&#123;CoroSplit.cpp&#125;</a></>}>
</MembersIndexItem>

</MembersIndex>

## Classes Index

<MembersIndex>

<MembersIndexItem
  type="struct"
  name={<><a href="/docs/api/structs/anonymous-namespace-corosplit-cpp-/switchcoroutinesplitter">SwitchCoroutineSplitter</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type="class"
  name={<><a href="/docs/api/classes/anonymous-namespace-corosplit-cpp-/prettystacktracefunction">PrettyStackTraceFunction</a></>}>
</MembersIndexItem>

</MembersIndex>

## Functions Index

<MembersIndex>

<MembersIndexItem
  type="void"
  name={<><a href="#a2c299a4357972cc32be0eda57abda580">addAsyncContextAttrs</a> (AttributeList &amp;Attrs, LLVMContext &amp;Context, unsigned ParamIndex)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a7c497627acf5128770bd9fa245b44fbd">addFramePointerAttrs</a> (AttributeList &amp;Attrs, LLVMContext &amp;Context, unsigned ParamIndex, uint64&#95;t Size, Align Alignment, bool NoAlias)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a68cd8d24134223f2dfaf5f482a56f1fd">addPrepareFunction</a> (const Module &amp;M, SmallVectorImpl&lt; Function &#42; &gt; &amp;Fns, StringRef Name)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a0e09834bc2b325fc2f777641292396e1">addSwiftSelfAttrs</a> (AttributeList &amp;Attrs, LLVMContext &amp;Context, unsigned ParamIndex)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#ab349dce775a8c8dcd72c24059e8357a2">coerceArguments</a> (IRBuilder&lt;&gt; &amp;Builder, FunctionType &#42;FnTy, ArrayRef&lt; Value &#42; &gt; FnArgs, SmallVectorImpl&lt; Value &#42; &gt; &amp;CallArgs)</>}>
Coerce the arguments in <code>FnArgs</code> according to <code>FnTy</code> in <code>CallArgs</code>. <a href="#ab349dce775a8c8dcd72c24059e8357a2">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<>std::pair&lt; <a href="/docs/api/classes/llvm/smallvector">SmallVector</a>&lt; <a href="/docs/api/classes/llvm/dbgvariableintrinsic">DbgVariableIntrinsic</a> &#42;, 8 &gt;, <a href="/docs/api/classes/llvm/smallvector">SmallVector</a>&lt; <a href="/docs/api/classes/llvm/dbgvariablerecord">DbgVariableRecord</a> &#42; &gt; &gt;</>}
  name={<><a href="#a13dafea5ca0652a4011dd613a8f02494">collectDbgVariableIntrinsics</a> (Function &amp;F)</>}>
Returns all <a href="/docs/api/classes/llvm/dbgvariableintrinsic">DbgVariableIntrinsic</a> in F. <a href="#a13dafea5ca0652a4011dd613a8f02494">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/function">Function</a> &#42;</>}
  name={<><a href="#a452dcc29fd5e19bda874218e10a8945c">createCloneDeclaration</a> (Function &amp;OrigF, coro::Shape &amp;Shape, const Twine &amp;Suffix, Module::iterator InsertBefore, AnyCoroSuspendInst &#42;ActiveSuspend)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<>std::unique&#95;ptr&lt; <a href="/docs/api/classes/llvm/coro/baseabi">coro::BaseABI</a> &gt;</>}
  name={<><a href="#a88fd8d22fd3856c5ed785a7d9f2a736e">CreateNewABI</a> (Function &amp;F, coro::Shape &amp;S, std::function&lt; bool(Instruction &amp;)&gt; IsMatCallback, const SmallVector&lt; CoroSplitPass::BaseABITy &gt; GenCustomABIs)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a8bf580168c7138b15f7bfdd080416bec">doSplitCoroutine</a> (Function &amp;F, SmallVectorImpl&lt; Function &#42; &gt; &amp;Clones, coro::BaseABI &amp;ABI, TargetTransformInfo &amp;TTI, bool OptimizeFrame)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/typesize">TypeSize</a></>}
  name={<><a href="#af1eb41cd2b90362db4ffc6eb47608943">getFrameSizeForShape</a> (coro::Shape &amp;Shape)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/functiontype">FunctionType</a> &#42;</>}
  name={<><a href="#a492e33f38ce495d0143f95092cfd0595">getFunctionTypeFromAsyncSuspend</a> (AnyCoroSuspendInst &#42;Suspend)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#ab7881567f602c3a94d11e2817f4464e0">handleNoSuspendCoroutine</a> (coro::Shape &amp;Shape)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a116742dc8bd808e796becf1166383f63">hasCallsBetween</a> (Instruction &#42;Save, Instruction &#42;ResumeOrDestroy)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a8d997c978c5ed505d64079540c9f5905">hasCallsInBlockBetween</a> (iterator&#95;range&lt; BasicBlock::iterator &gt; R)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a44c557dcf96034410cdb25dd01c12dde">hasCallsInBlocksBetween</a> (BasicBlock &#42;SaveBB, BasicBlock &#42;ResDesBB)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a80552a6c7d2a87204a411292848a5af0">hasSafeElideCaller</a> (Function &amp;F)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#ab5b261757331e18b934bba9c3d3e6b69">lowerAwaitSuspend</a> (IRBuilder&lt;&gt; &amp;Builder, CoroAwaitSuspendInst &#42;CB, coro::Shape &amp;Shape)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#ab68c3421a2e14ba10398bfcd82d6161e">lowerAwaitSuspends</a> (Function &amp;F, coro::Shape &amp;Shape)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#aa6734dd82cf736e89074802287b0abfe">markCoroutineAsDone</a> (IRBuilder&lt;&gt; &amp;Builder, const coro::Shape &amp;Shape, Value &#42;FramePtr)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a3907189466613e437b0ea2731bf9b159">maybeFreeRetconStorage</a> (IRBuilder&lt;&gt; &amp;Builder, const coro::Shape &amp;Shape, Value &#42;FramePtr, CallGraph &#42;CG)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#ac2458e50c1358135964844abe8d8979d">postSplitCleanup</a> (Function &amp;F)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#aa2ead3ae2cc059f459be46ce71ef20a5">removeCoroEndsFromRampFunction</a> (const coro::Shape &amp;Shape)</>}>
Remove calls to llvm.coro.end in the original function. <a href="#aa2ead3ae2cc059f459be46ce71ef20a5">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a83664bf5c186d5e2d65853f2cce4ec3a">replaceAllPrepares</a> (Function &#42;PrepareFn, LazyCallGraph &amp;CG, LazyCallGraph::SCC &amp;C)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#af678f41709f265e2589f247e883aa738">replaceAsyncResumeFunction</a> (CoroSuspendAsyncInst &#42;Suspend, Value &#42;Continuation)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#ab289568caaa6647ee577a06e6e12499a">replaceCoroEnd</a> (AnyCoroEndInst &#42;End, const coro::Shape &amp;Shape, Value &#42;FramePtr, bool InResume, CallGraph &#42;CG)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a8b22bf92719f6baa98dcfe7e99bd5389">replaceCoroEndAsync</a> (AnyCoroEndInst &#42;End)</>}>
Replace an llvm.coro.end.async. <a href="#a8b22bf92719f6baa98dcfe7e99bd5389">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a84fbc09723655416fad6677d7fdaf8a6">replaceFallthroughCoroEnd</a> (AnyCoroEndInst &#42;End, const coro::Shape &amp;Shape, Value &#42;FramePtr, bool InResume, CallGraph &#42;CG)</>}>
Replace a non-unwind call to llvm.coro.end. <a href="#a84fbc09723655416fad6677d7fdaf8a6">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a8543371395854bee27033b8e24836cb0">replaceFrameSizeAndAlignment</a> (coro::Shape &amp;Shape)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#acd162cfe23d841a49056ce6436dd2075">replacePrepare</a> (CallInst &#42;Prepare, LazyCallGraph &amp;CG, LazyCallGraph::SCC &amp;C)</>}>
Replace a call to llvm.coro.prepare.retcon. <a href="#acd162cfe23d841a49056ce6436dd2075">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a236935b2df66a03a0a54350a6b9b84bc">replaceSwiftErrorOps</a> (Function &amp;F, coro::Shape &amp;Shape, ValueToValueMapTy &#42;VMap)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a9cb75e325aabbbb2e1fdf034b2f11491">replaceUnwindCoroEnd</a> (AnyCoroEndInst &#42;End, const coro::Shape &amp;Shape, Value &#42;FramePtr, bool InResume, CallGraph &#42;CG)</>}>
Replace an unwind call to llvm.coro.end. <a href="#a9cb75e325aabbbb2e1fdf034b2f11491">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a9f3928b341e4412b8b66b794896014f0">simplifySuspendPoint</a> (CoroSuspendInst &#42;Suspend, CoroBeginInst &#42;CoroBegin)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a76d02f8354cb0d3c8b30eb7812ae01b2">simplifySuspendPoints</a> (coro::Shape &amp;Shape)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#ab02a4d4ecc962ea09ed6c79ebc699a54">updateAsyncFuncPointerContextSize</a> (coro::Shape &amp;Shape)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/lazycallgraph/scc">LazyCallGraph::SCC</a> &amp;</>}
  name={<><a href="#a1d6bceebc19a80123ae26670c7645d1a">updateCallGraphAfterCoroutineSplit</a> (LazyCallGraph::Node &amp;N, const coro::Shape &amp;Shape, const SmallVectorImpl&lt; Function &#42; &gt; &amp;Clones, LazyCallGraph::SCC &amp;C, LazyCallGraph &amp;CG, CGSCCAnalysisManager &amp;AM, CGSCCUpdateResult &amp;UR, FunctionAnalysisManager &amp;FAM)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a4d1d15c0a00a9b9391977c8f482e0428">updateScopeLine</a> (Instruction &#42;ActiveSuspend, DISubprogram &amp;SPToUpdate)</>}>
Adjust the scope line of the funclet to the first line number after the suspend point. <a href="#a4d1d15c0a00a9b9391977c8f482e0428">More...</a>
</MembersIndexItem>

</MembersIndex>

## Defines Index

<MembersIndex>

<MembersIndexItem
  type="#define"
  name={<><a href="#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>&nbsp;&nbsp;&nbsp;&quot;coro-split&quot;</>}>
</MembersIndexItem>

</MembersIndex>


<SectionDefinition>

## Functions

### addAsyncContextAttrs() {#a2c299a4357972cc32be0eda57abda580}

<MemberDefinition
  prototype={<>static void addAsyncContextAttrs (AttributeList &amp; Attrs, <a href="/docs/api/classes/llvm/llvmcontext">LLVMContext</a> &amp; Context, unsigned ParamIndex)</>}
  labels = {["static"]}>

Definition at line <a href="#l00881">881</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### addFramePointerAttrs() {#a7c497627acf5128770bd9fa245b44fbd}

<MemberDefinition
  prototype={<>static void addFramePointerAttrs (AttributeList &amp; Attrs, <a href="/docs/api/classes/llvm/llvmcontext">LLVMContext</a> &amp; Context, unsigned ParamIndex, uint64&#95;t Size, <a href="/docs/api/structs/llvm/align">Align</a> Alignment, bool NoAlias)</>}
  labels = {["static"]}>

Definition at line <a href="#l00866">866</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### addPrepareFunction() {#a68cd8d24134223f2dfaf5f482a56f1fd}

<MemberDefinition
  prototype={<>static void addPrepareFunction (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/module">Module</a> &amp; M, <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt; <a href="/docs/api/classes/llvm/function">Function</a> &#42; &gt; &amp; Fns, <a href="/docs/api/classes/llvm/stringref">StringRef</a> Name)</>}
  labels = {["static"]}>

Definition at line <a href="#l02143">2143</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### addSwiftSelfAttrs() {#a0e09834bc2b325fc2f777641292396e1}

<MemberDefinition
  prototype={<>static void addSwiftSelfAttrs (AttributeList &amp; Attrs, <a href="/docs/api/classes/llvm/llvmcontext">LLVMContext</a> &amp; Context, unsigned ParamIndex)</>}
  labels = {["static"]}>

Definition at line <a href="#l00888">888</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### coerceArguments() {#ab349dce775a8c8dcd72c24059e8357a2}

<MemberDefinition
  prototype={<>static void coerceArguments (<a href="/docs/api/classes/llvm/irbuilder">IRBuilder</a>&lt;&gt; &amp; Builder, <a href="/docs/api/classes/functiontype">FunctionType</a> &#42; FnTy, <a href="/docs/api/classes/llvm/arrayref">ArrayRef</a>&lt; <a href="/docs/api/classes/llvm/value">Value</a> &#42; &gt; FnArgs, <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt; <a href="/docs/api/classes/llvm/value">Value</a> &#42; &gt; &amp; CallArgs)</>}
  labels = {["static"]}>
Coerce the arguments in <code>FnArgs</code> according to <code>FnTy</code> in <code>CallArgs</code>.

Definition at line <a href="#l01690">1690</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### collectDbgVariableIntrinsics() {#a13dafea5ca0652a4011dd613a8f02494}

<MemberDefinition
  prototype={<>static std::pair&lt; SmallVector&lt; DbgVariableIntrinsic &#42;, 8 &gt;, SmallVector&lt; DbgVariableRecord &#42; &gt; &gt; collectDbgVariableIntrinsics (<a href="/docs/api/classes/llvm/function">Function</a> &amp; F)</>}
  labels = {["static"]}>
Returns all <a href="/docs/api/classes/llvm/dbgvariableintrinsic">DbgVariableIntrinsic</a> in F.

Definition at line <a href="#l00641">641</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### createCloneDeclaration() {#a452dcc29fd5e19bda874218e10a8945c}

<MemberDefinition
  prototype={<>static Function &#42; createCloneDeclaration (<a href="/docs/api/classes/llvm/function">Function</a> &amp; OrigF, <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp; Shape, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/twine">Twine</a> &amp; Suffix, Module::iterator InsertBefore, <a href="/docs/api/classes/llvm/anycorosuspendinst">AnyCoroSuspendInst</a> &#42; ActiveSuspend)</>}
  labels = {["static"]}>

Definition at line <a href="#l00466">466</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### CreateNewABI() {#a88fd8d22fd3856c5ed785a7d9f2a736e}

<MemberDefinition
  prototype={<>static std::unique&#95;ptr&lt; coro::BaseABI &gt; CreateNewABI (<a href="/docs/api/classes/llvm/function">Function</a> &amp; F, <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp; S, <a href="/docs/api/files/lib/lib/analysis/regionprinter-cpp/#aa37fbbce2360106772fd97ed06455d55">std::function</a>&lt; bool(<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;)&gt; IsMatCallback, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/smallvector">SmallVector</a>&lt; <a href="/docs/api/structs/llvm/corosplitpass/#abaf5427dbf33b7bab2de92c89385a547">CoroSplitPass::BaseABITy</a> &gt; GenCustomABIs)</>}
  labels = {["static"]}>

Definition at line <a href="#l02152">2152</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### doSplitCoroutine() {#a8bf580168c7138b15f7bfdd080416bec}

<MemberDefinition
  prototype={<>static void doSplitCoroutine (<a href="/docs/api/classes/llvm/function">Function</a> &amp; F, <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt; <a href="/docs/api/classes/llvm/function">Function</a> &#42; &gt; &amp; Clones, <a href="/docs/api/classes/llvm/coro/baseabi">coro::BaseABI</a> &amp; ABI, <a href="/docs/api/classes/llvm/targettransforminfo">TargetTransformInfo</a> &amp; TTI, bool OptimizeFrame)</>}
  labels = {["static"]}>

Definition at line <a href="#l02005">2005</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### getFrameSizeForShape() {#af1eb41cd2b90362db4ffc6eb47608943}

<MemberDefinition
  prototype={<>static TypeSize getFrameSizeForShape (<a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp; Shape)</>}
  labels = {["static"]}>

Definition at line <a href="#l01156">1156</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### getFunctionTypeFromAsyncSuspend() {#a492e33f38ce495d0143f95092cfd0595}

<MemberDefinition
  prototype={<>static FunctionType &#42; getFunctionTypeFromAsyncSuspend (<a href="/docs/api/classes/llvm/anycorosuspendinst">AnyCoroSuspendInst</a> &#42; Suspend)</>}
  labels = {["static"]}>

Definition at line <a href="#l00458">458</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### handleNoSuspendCoroutine() {#ab7881567f602c3a94d11e2817f4464e0}

<MemberDefinition
  prototype={<>static void handleNoSuspendCoroutine (<a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp; Shape)</>}
  labels = {["static"]}>

Definition at line <a href="#l01202">1202</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### hasCallsBetween() {#a116742dc8bd808e796becf1166383f63}

<MemberDefinition
  prototype={<>static bool hasCallsBetween (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42; Save, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42; ResumeOrDestroy)</>}
  labels = {["static"]}>

Definition at line <a href="#l01277">1277</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### hasCallsInBlockBetween() {#a8d997c978c5ed505d64079540c9f5905}

<MemberDefinition
  prototype={<>static bool hasCallsInBlockBetween (<a href="/docs/api/classes/llvm/iterator-range">iterator&#95;range</a>&lt; <a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> &gt; R)</>}
  labels = {["static"]}>

Definition at line <a href="#l01236">1236</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### hasCallsInBlocksBetween() {#a44c557dcf96034410cdb25dd01c12dde}

<MemberDefinition
  prototype={<>static bool hasCallsInBlocksBetween (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; SaveBB, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; ResDesBB)</>}
  labels = {["static"]}>

Definition at line <a href="#l01248">1248</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### hasSafeElideCaller() {#a80552a6c7d2a87204a411292848a5af0}

<MemberDefinition
  prototype={<>static bool hasSafeElideCaller (<a href="/docs/api/classes/llvm/function">Function</a> &amp; F)</>}
  labels = {["static"]}>

Definition at line <a href="#l01987">1987</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### lowerAwaitSuspend() {#ab5b261757331e18b934bba9c3d3e6b69}

<MemberDefinition
  prototype={<>static void lowerAwaitSuspend (<a href="/docs/api/classes/llvm/irbuilder">IRBuilder</a>&lt;&gt; &amp; Builder, <a href="/docs/api/classes/llvm/coroawaitsuspendinst">CoroAwaitSuspendInst</a> &#42; CB, <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp; Shape)</>}
  labels = {["static"]}>

Definition at line <a href="#l00103">103</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### lowerAwaitSuspends() {#ab68c3421a2e14ba10398bfcd82d6161e}

<MemberDefinition
  prototype={<>static void lowerAwaitSuspends (<a href="/docs/api/classes/llvm/function">Function</a> &amp; F, <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp; Shape)</>}
  labels = {["static"]}>

Definition at line <a href="#l00169">169</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### markCoroutineAsDone() {#aa6734dd82cf736e89074802287b0abfe}

<MemberDefinition
  prototype={<>static void markCoroutineAsDone (<a href="/docs/api/classes/llvm/irbuilder">IRBuilder</a>&lt;&gt; &amp; Builder, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp; Shape, <a href="/docs/api/classes/llvm/value">Value</a> &#42; FramePtr)</>}
  labels = {["static"]}>

Definition at line <a href="#l00330">330</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### maybeFreeRetconStorage() {#a3907189466613e437b0ea2731bf9b159}

<MemberDefinition
  prototype={<>static void maybeFreeRetconStorage (<a href="/docs/api/classes/llvm/irbuilder">IRBuilder</a>&lt;&gt; &amp; Builder, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp; Shape, <a href="/docs/api/classes/llvm/value">Value</a> &#42; FramePtr, <a href="/docs/api/classes/llvm/callgraph">CallGraph</a> &#42; CG)</>}
  labels = {["static"]}>

Definition at line <a href="#l00175">175</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### postSplitCleanup() {#ac2458e50c1358135964844abe8d8979d}

<MemberDefinition
  prototype={<>static void postSplitCleanup (<a href="/docs/api/classes/llvm/function">Function</a> &amp; F)</>}
  labels = {["static"]}>

Definition at line <a href="#l01188">1188</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### removeCoroEndsFromRampFunction() {#aa2ead3ae2cc059f459be46ce71ef20a5}

<MemberDefinition
  prototype={<>static void removeCoroEndsFromRampFunction (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp; Shape)</>}
  labels = {["static"]}>
Remove calls to llvm.coro.end in the original function.

Definition at line <a href="#l01973">1973</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### replaceAllPrepares() {#a83664bf5c186d5e2d65853f2cce4ec3a}

<MemberDefinition
  prototype={<>static bool replaceAllPrepares (<a href="/docs/api/classes/llvm/function">Function</a> &#42; PrepareFn, <a href="/docs/api/classes/llvm/lazycallgraph">LazyCallGraph</a> &amp; CG, <a href="/docs/api/classes/llvm/lazycallgraph/scc">LazyCallGraph::SCC</a> &amp; C)</>}
  labels = {["static"]}>

Definition at line <a href="#l02130">2130</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### replaceAsyncResumeFunction() {#af678f41709f265e2589f247e883aa738}

<MemberDefinition
  prototype={<>static void replaceAsyncResumeFunction (<a href="/docs/api/classes/llvm/corosuspendasyncinst">CoroSuspendAsyncInst</a> &#42; Suspend, <a href="/docs/api/classes/llvm/value">Value</a> &#42; Continuation)</>}
  labels = {["static"]}>

Definition at line <a href="#l01675">1675</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### replaceCoroEnd() {#ab289568caaa6647ee577a06e6e12499a}

<MemberDefinition
  prototype={<>static void replaceCoroEnd (<a href="/docs/api/classes/llvm/anycoroendinst">AnyCoroEndInst</a> &#42; End, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp; Shape, <a href="/docs/api/classes/llvm/value">Value</a> &#42; FramePtr, bool InResume, <a href="/docs/api/classes/llvm/callgraph">CallGraph</a> &#42; CG)</>}
  labels = {["static"]}>

Definition at line <a href="#l00402">402</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### replaceCoroEndAsync() {#a8b22bf92719f6baa98dcfe7e99bd5389}

<MemberDefinition
  prototype={<>static bool replaceCoroEndAsync (<a href="/docs/api/classes/llvm/anycoroendinst">AnyCoroEndInst</a> &#42; End)</>}
  labels = {["static"]}>
Replace an llvm.coro.end.async.

Will inline the must tail call function call if there is one. 
<SectionUser title="Returns">
true if cleanup of the coro.end block is needed, false otherwise.
</SectionUser>

Definition at line <a href="#l00188">188</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### replaceFallthroughCoroEnd() {#a84fbc09723655416fad6677d7fdaf8a6}

<MemberDefinition
  prototype={<>static void replaceFallthroughCoroEnd (<a href="/docs/api/classes/llvm/anycoroendinst">AnyCoroEndInst</a> &#42; End, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp; Shape, <a href="/docs/api/classes/llvm/value">Value</a> &#42; FramePtr, bool InResume, <a href="/docs/api/classes/llvm/callgraph">CallGraph</a> &#42; CG)</>}
  labels = {["static"]}>
Replace a non-unwind call to llvm.coro.end.

Definition at line <a href="#l00231">231</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### replaceFrameSizeAndAlignment() {#a8543371395854bee27033b8e24836cb0}

<MemberDefinition
  prototype={<>static void replaceFrameSizeAndAlignment (<a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp; Shape)</>}
  labels = {["static"]}>

Definition at line <a href="#l01164">1164</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### replacePrepare() {#acd162cfe23d841a49056ce6436dd2075}

<MemberDefinition
  prototype={<>static void replacePrepare (<a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42; Prepare, <a href="/docs/api/classes/llvm/lazycallgraph">LazyCallGraph</a> &amp; CG, <a href="/docs/api/classes/llvm/lazycallgraph/scc">LazyCallGraph::SCC</a> &amp; C)</>}
  labels = {["static"]}>
Replace a call to llvm.coro.prepare.retcon.

Definition at line <a href="#l02094">2094</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### replaceSwiftErrorOps() {#a236935b2df66a03a0a54350a6b9b84bc}

<MemberDefinition
  prototype={<>static void replaceSwiftErrorOps (<a href="/docs/api/classes/llvm/function">Function</a> &amp; F, <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp; Shape, <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &#42; VMap)</>}
  labels = {["static"]}>

Definition at line <a href="#l00582">582</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### replaceUnwindCoroEnd() {#a9cb75e325aabbbb2e1fdf034b2f11491}

<MemberDefinition
  prototype={<>static void replaceUnwindCoroEnd (<a href="/docs/api/classes/llvm/anycoroendinst">AnyCoroEndInst</a> &#42; End, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp; Shape, <a href="/docs/api/classes/llvm/value">Value</a> &#42; FramePtr, bool InResume, <a href="/docs/api/classes/llvm/callgraph">CallGraph</a> &#42; CG)</>}
  labels = {["static"]}>
Replace an unwind call to llvm.coro.end.

Definition at line <a href="#l00364">364</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### simplifySuspendPoint() {#a9f3928b341e4412b8b66b794896014f0}

<MemberDefinition
  prototype={<>static bool simplifySuspendPoint (<a href="/docs/api/classes/llvm/corosuspendinst">CoroSuspendInst</a> &#42; Suspend, <a href="/docs/api/classes/llvm/corobegininst">CoroBeginInst</a> &#42; CoroBegin)</>}
  labels = {["static"]}>

Definition at line <a href="#l01304">1304</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### simplifySuspendPoints() {#a76d02f8354cb0d3c8b30eb7812ae01b2}

<MemberDefinition
  prototype={<>static void simplifySuspendPoints (<a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp; Shape)</>}
  labels = {["static"]}>

Definition at line <a href="#l01364">1364</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### updateAsyncFuncPointerContextSize() {#ab02a4d4ecc962ea09ed6c79ebc699a54}

<MemberDefinition
  prototype={<>static void updateAsyncFuncPointerContextSize (<a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp; Shape)</>}
  labels = {["static"]}>

Definition at line <a href="#l01141">1141</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### updateCallGraphAfterCoroutineSplit() {#a1d6bceebc19a80123ae26670c7645d1a}

<MemberDefinition
  prototype={<>static LazyCallGraph::SCC &amp; updateCallGraphAfterCoroutineSplit (<a href="/docs/api/classes/llvm/lazycallgraph/node">LazyCallGraph::Node</a> &amp; N, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp; Shape, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt; <a href="/docs/api/classes/llvm/function">Function</a> &#42; &gt; &amp; Clones, <a href="/docs/api/classes/llvm/lazycallgraph/scc">LazyCallGraph::SCC</a> &amp; C, <a href="/docs/api/classes/llvm/lazycallgraph">LazyCallGraph</a> &amp; CG, <a href="/docs/api/namespaces/llvm/#a571b2bbf074b46c75300bd8f14c5ab72">CGSCCAnalysisManager</a> &amp; AM, <a href="/docs/api/structs/llvm/cgsccupdateresult">CGSCCUpdateResult</a> &amp; UR, <a href="/docs/api/namespaces/llvm/#adce09a5a0de0e3177eb00e932734af2f">FunctionAnalysisManager</a> &amp; FAM)</>}
  labels = {["static"]}>

Definition at line <a href="#l02055">2055</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

### updateScopeLine() {#a4d1d15c0a00a9b9391977c8f482e0428}

<MemberDefinition
  prototype={<>static void updateScopeLine (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42; ActiveSuspend, <a href="/docs/api/classes/llvm/disubprogram">DISubprogram</a> &amp; SPToUpdate)</>}
  labels = {["static"]}>
Adjust the scope line of the funclet to the first line number after the suspend point.

This avoids a jump in the line table from the function declaration (where prologue instructions are attributed to) to the suspend point. Only adjust the scope line when the files are the same. If no candidate line number is found, fallback to the line of ActiveSuspend.

Definition at line <a href="#l00822">822</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Defines

### DEBUG&#95;TYPE {#ad78e062f62e0d6e453941fb4ca843e4d}

<MemberDefinition
  prototype={<>#define DEBUG&#95;TYPE&nbsp;&nbsp;&nbsp;&quot;coro-split&quot;</>}>

Definition at line <a href="#l00079">79</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corosplit-cpp">CoroSplit.cpp</a>.
</MemberDefinition>

</SectionDefinition>

## File Listing

The file content with the documentation metadata removed is:

<ProgramListing>

<Link id="l00001" /><CodeLine lineNumber="1"><span class="doxyHighlightComment">//===- CoroSplit.cpp - Converts a coroutine into a state machine ----------===//</span></CodeLine>
<Link id="l00002" /><CodeLine lineNumber="2"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00003" /><CodeLine lineNumber="3"><span class="doxyHighlightComment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</span></CodeLine>
<Link id="l00004" /><CodeLine lineNumber="4"><span class="doxyHighlightComment">// See https://llvm.org/LICENSE.txt for license information.</span></CodeLine>
<Link id="l00005" /><CodeLine lineNumber="5"><span class="doxyHighlightComment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</span></CodeLine>
<Link id="l00006" /><CodeLine lineNumber="6"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00007" /><CodeLine lineNumber="7"><span class="doxyHighlightComment">//===----------------------------------------------------------------------===//</span></CodeLine>
<Link id="l00008" /><CodeLine lineNumber="8"><span class="doxyHighlightComment">// This pass builds the coroutine frame and outlines resume and destroy parts</span></CodeLine>
<Link id="l00009" /><CodeLine lineNumber="9"><span class="doxyHighlightComment">// of the coroutine into separate functions.</span></CodeLine>
<Link id="l00010" /><CodeLine lineNumber="10"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00011" /><CodeLine lineNumber="11"><span class="doxyHighlightComment">// We present a coroutine to an LLVM as an ordinary function with suspension</span></CodeLine>
<Link id="l00012" /><CodeLine lineNumber="12"><span class="doxyHighlightComment">// points marked up with intrinsics. We let the optimizer party on the coroutine</span></CodeLine>
<Link id="l00013" /><CodeLine lineNumber="13"><span class="doxyHighlightComment">// as a single function for as long as possible. Shortly before the coroutine is</span></CodeLine>
<Link id="l00014" /><CodeLine lineNumber="14"><span class="doxyHighlightComment">// eligible to be inlined into its callers, we split up the coroutine into parts</span></CodeLine>
<Link id="l00015" /><CodeLine lineNumber="15"><span class="doxyHighlightComment">// corresponding to an initial, resume and destroy invocations of the coroutine,</span></CodeLine>
<Link id="l00016" /><CodeLine lineNumber="16"><span class="doxyHighlightComment">// add them to the current SCC and restart the IPO pipeline to optimize the</span></CodeLine>
<Link id="l00017" /><CodeLine lineNumber="17"><span class="doxyHighlightComment">// coroutine subfunctions we extracted before proceeding to the caller of the</span></CodeLine>
<Link id="l00018" /><CodeLine lineNumber="18"><span class="doxyHighlightComment">// coroutine.</span></CodeLine>
<Link id="l00019" /><CodeLine lineNumber="19"><span class="doxyHighlightComment">//===----------------------------------------------------------------------===//</span></CodeLine>
<Link id="l00020" /><CodeLine lineNumber="20"></CodeLine>
<Link id="l00021" /><CodeLine lineNumber="21"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/coroutines/corosplit-h">llvm/Transforms/Coroutines/CoroSplit.h</a>&quot;</span></CodeLine>
<Link id="l00022" /><CodeLine lineNumber="22"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corocloner-h">CoroCloner.h</a>&quot;</span></CodeLine>
<Link id="l00023" /><CodeLine lineNumber="23"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/lib/lib/transforms/lib/transforms/coroutines/corointernal-h">CoroInternal.h</a>&quot;</span></CodeLine>
<Link id="l00024" /><CodeLine lineNumber="24"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/densemap-h">llvm/ADT/DenseMap.h</a>&quot;</span></CodeLine>
<Link id="l00025" /><CodeLine lineNumber="25"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/priorityworklist-h">llvm/ADT/PriorityWorklist.h</a>&quot;</span></CodeLine>
<Link id="l00026" /><CodeLine lineNumber="26"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/stlextras-h">llvm/ADT/STLExtras.h</a>&quot;</span></CodeLine>
<Link id="l00027" /><CodeLine lineNumber="27"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/smallptrset-h">llvm/ADT/SmallPtrSet.h</a>&quot;</span></CodeLine>
<Link id="l00028" /><CodeLine lineNumber="28"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/smallvector-h">llvm/ADT/SmallVector.h</a>&quot;</span></CodeLine>
<Link id="l00029" /><CodeLine lineNumber="29"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/stringextras-h">llvm/ADT/StringExtras.h</a>&quot;</span></CodeLine>
<Link id="l00030" /><CodeLine lineNumber="30"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/stringref-h">llvm/ADT/StringRef.h</a>&quot;</span></CodeLine>
<Link id="l00031" /><CodeLine lineNumber="31"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/twine-h">llvm/ADT/Twine.h</a>&quot;</span></CodeLine>
<Link id="l00032" /><CodeLine lineNumber="32"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/cfg-h">llvm/Analysis/CFG.h</a>&quot;</span></CodeLine>
<Link id="l00033" /><CodeLine lineNumber="33"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/callgraph-h">llvm/Analysis/CallGraph.h</a>&quot;</span></CodeLine>
<Link id="l00034" /><CodeLine lineNumber="34"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/constantfolding-h">llvm/Analysis/ConstantFolding.h</a>&quot;</span></CodeLine>
<Link id="l00035" /><CodeLine lineNumber="35"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/lazycallgraph-h">llvm/Analysis/LazyCallGraph.h</a>&quot;</span></CodeLine>
<Link id="l00036" /><CodeLine lineNumber="36"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/optimizationremarkemitter-h">llvm/Analysis/OptimizationRemarkEmitter.h</a>&quot;</span></CodeLine>
<Link id="l00037" /><CodeLine lineNumber="37"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/targettransforminfo-h">llvm/Analysis/TargetTransformInfo.h</a>&quot;</span></CodeLine>
<Link id="l00038" /><CodeLine lineNumber="38"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/binaryformat/dwarf-h">llvm/BinaryFormat/Dwarf.h</a>&quot;</span></CodeLine>
<Link id="l00039" /><CodeLine lineNumber="39"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/argument-h">llvm/IR/Argument.h</a>&quot;</span></CodeLine>
<Link id="l00040" /><CodeLine lineNumber="40"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/attributes-h">llvm/IR/Attributes.h</a>&quot;</span></CodeLine>
<Link id="l00041" /><CodeLine lineNumber="41"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/basicblock-h">llvm/IR/BasicBlock.h</a>&quot;</span></CodeLine>
<Link id="l00042" /><CodeLine lineNumber="42"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/cfg-h">llvm/IR/CFG.h</a>&quot;</span></CodeLine>
<Link id="l00043" /><CodeLine lineNumber="43"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/callingconv-h">llvm/IR/CallingConv.h</a>&quot;</span></CodeLine>
<Link id="l00044" /><CodeLine lineNumber="44"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/constants-h">llvm/IR/Constants.h</a>&quot;</span></CodeLine>
<Link id="l00045" /><CodeLine lineNumber="45"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/datalayout-h">llvm/IR/DataLayout.h</a>&quot;</span></CodeLine>
<Link id="l00046" /><CodeLine lineNumber="46"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/debuginfo-h">llvm/IR/DebugInfo.h</a>&quot;</span></CodeLine>
<Link id="l00047" /><CodeLine lineNumber="47"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/derivedtypes-h">llvm/IR/DerivedTypes.h</a>&quot;</span></CodeLine>
<Link id="l00048" /><CodeLine lineNumber="48"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/dominators-h">llvm/IR/Dominators.h</a>&quot;</span></CodeLine>
<Link id="l00049" /><CodeLine lineNumber="49"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/globalvalue-h">llvm/IR/GlobalValue.h</a>&quot;</span></CodeLine>
<Link id="l00050" /><CodeLine lineNumber="50"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/globalvariable-h">llvm/IR/GlobalVariable.h</a>&quot;</span></CodeLine>
<Link id="l00051" /><CodeLine lineNumber="51"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/institerator-h">llvm/IR/InstIterator.h</a>&quot;</span></CodeLine>
<Link id="l00052" /><CodeLine lineNumber="52"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/instrtypes-h">llvm/IR/InstrTypes.h</a>&quot;</span></CodeLine>
<Link id="l00053" /><CodeLine lineNumber="53"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/instruction-h">llvm/IR/Instruction.h</a>&quot;</span></CodeLine>
<Link id="l00054" /><CodeLine lineNumber="54"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/instructions-h">llvm/IR/Instructions.h</a>&quot;</span></CodeLine>
<Link id="l00055" /><CodeLine lineNumber="55"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/intrinsicinst-h">llvm/IR/IntrinsicInst.h</a>&quot;</span></CodeLine>
<Link id="l00056" /><CodeLine lineNumber="56"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/llvmcontext-h">llvm/IR/LLVMContext.h</a>&quot;</span></CodeLine>
<Link id="l00057" /><CodeLine lineNumber="57"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/module-h">llvm/IR/Module.h</a>&quot;</span></CodeLine>
<Link id="l00058" /><CodeLine lineNumber="58"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/type-h">llvm/IR/Type.h</a>&quot;</span></CodeLine>
<Link id="l00059" /><CodeLine lineNumber="59"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/value-h">llvm/IR/Value.h</a>&quot;</span></CodeLine>
<Link id="l00060" /><CodeLine lineNumber="60"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/verifier-h">llvm/IR/Verifier.h</a>&quot;</span></CodeLine>
<Link id="l00061" /><CodeLine lineNumber="61"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/casting-h">llvm/Support/Casting.h</a>&quot;</span></CodeLine>
<Link id="l00062" /><CodeLine lineNumber="62"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h">llvm/Support/Debug.h</a>&quot;</span></CodeLine>
<Link id="l00063" /><CodeLine lineNumber="63"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/prettystacktrace-h">llvm/Support/PrettyStackTrace.h</a>&quot;</span></CodeLine>
<Link id="l00064" /><CodeLine lineNumber="64"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/raw-ostream-h">llvm/Support/raw&#95;ostream.h</a>&quot;</span></CodeLine>
<Link id="l00065" /><CodeLine lineNumber="65"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/coroutines/materializationutils-h">llvm/Transforms/Coroutines/MaterializationUtils.h</a>&quot;</span></CodeLine>
<Link id="l00066" /><CodeLine lineNumber="66"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/scalar-h">llvm/Transforms/Scalar.h</a>&quot;</span></CodeLine>
<Link id="l00067" /><CodeLine lineNumber="67"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/basicblockutils-h">llvm/Transforms/Utils/BasicBlockUtils.h</a>&quot;</span></CodeLine>
<Link id="l00068" /><CodeLine lineNumber="68"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/callgraphupdater-h">llvm/Transforms/Utils/CallGraphUpdater.h</a>&quot;</span></CodeLine>
<Link id="l00069" /><CodeLine lineNumber="69"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/cloning-h">llvm/Transforms/Utils/Cloning.h</a>&quot;</span></CodeLine>
<Link id="l00070" /><CodeLine lineNumber="70"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/local-h">llvm/Transforms/Utils/Local.h</a>&quot;</span></CodeLine>
<Link id="l00071" /><CodeLine lineNumber="71"><span class="doxyHighlightPreprocessor">#include &lt;cassert&gt;</span></CodeLine>
<Link id="l00072" /><CodeLine lineNumber="72"><span class="doxyHighlightPreprocessor">#include &lt;cstddef&gt;</span></CodeLine>
<Link id="l00073" /><CodeLine lineNumber="73"><span class="doxyHighlightPreprocessor">#include &lt;cstdint&gt;</span></CodeLine>
<Link id="l00074" /><CodeLine lineNumber="74"><span class="doxyHighlightPreprocessor">#include &lt;initializer&#95;list&gt;</span></CodeLine>
<Link id="l00075" /><CodeLine lineNumber="75"><span class="doxyHighlightPreprocessor">#include &lt;iterator&gt;</span></CodeLine>
<Link id="l00076" /><CodeLine lineNumber="76"></CodeLine>
<Link id="l00077" /><CodeLine lineNumber="77"><span class="doxyHighlightKeyword">using namespace </span><span class="doxyHighlight"><a href="/docs/api/namespaces/llvm">llvm</a>;</span></CodeLine>
<Link id="l00078" /><CodeLine lineNumber="78"></CodeLine>
<Link id="l00079" /><CodeLine lineNumber="79" lineLink="#ad78e062f62e0d6e453941fb4ca843e4d"><span class="doxyHighlightPreprocessor">#define DEBUG&#95;TYPE &quot;coro-split&quot;</span></CodeLine>
<Link id="l00080" /><CodeLine lineNumber="80"></CodeLine>
<Link id="l00081" /><CodeLine lineNumber="81" lineLink="/docs/api/namespaces/anonymous-corosplit-cpp-"><span class="doxyHighlightKeyword">namespace </span><span class="doxyHighlight">&#123;</span></CodeLine>
<Link id="l00082" /><CodeLine lineNumber="82"><span class="doxyHighlightComment">/// Collect (a known) subset of global debug info metadata potentially used by</span></CodeLine>
<Link id="l00083" /><CodeLine lineNumber="83"><span class="doxyHighlightComment">/// the function \\p F.</span></CodeLine>
<Link id="l00084" /><CodeLine lineNumber="84"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00085" /><CodeLine lineNumber="85"><span class="doxyHighlightComment">/// This metadata set can be used to avoid cloning debug info not owned by \\p F</span></CodeLine>
<Link id="l00086" /><CodeLine lineNumber="86"><span class="doxyHighlightComment">/// and is shared among all potential clones \\p F.</span></CodeLine>
<Link id="l00087" /><CodeLine lineNumber="87" lineLink="/docs/api/namespaces/anonymous-corosplit-cpp-/#a9d81a7f738bbf6c1cd81fdca9ba2bc99"><span class="doxyHighlight"><a href="/docs/api/namespaces/llvm/#a91897d2d0da113b016f14ae110586ab1">MetadataSetTy</a> <a href="/docs/api/namespaces/anonymous-corosplit-cpp-/#a9d81a7f738bbf6c1cd81fdca9ba2bc99">collectCommonDebugInfo</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l00088" /><CodeLine lineNumber="88"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/timetracescope">TimeTraceScope</a> FunctionScope(</span><span class="doxyHighlightStringLiteral">&quot;CollectCommonDebugInfo&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00089" /><CodeLine lineNumber="89"></CodeLine>
<Link id="l00090" /><CodeLine lineNumber="90"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/debuginfofinder">DebugInfoFinder</a> DIFinder;</span></CodeLine>
<Link id="l00091" /><CodeLine lineNumber="91"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/disubprogram">DISubprogram</a> &#42;SPClonedWithinModule = <a href="/docs/api/namespaces/llvm/#ad9d4e85b3abfbf1a3dd8a7fd45057cce">CollectDebugInfoForCloning</a>(</span></CodeLine>
<Link id="l00092" /><CodeLine lineNumber="92"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, <a href="/docs/api/namespaces/llvm/#abe00617fc34ceb1aa0eb62995732b30aa68b46a44773674a07e6730fac74fc46b">CloneFunctionChangeType::LocalChangesOnly</a>, DIFinder);</span></CodeLine>
<Link id="l00093" /><CodeLine lineNumber="93"></CodeLine>
<Link id="l00094" /><CodeLine lineNumber="94"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/#a954c742913f42266852b86ca04547929">FindDebugInfoToIdentityMap</a>(<a href="/docs/api/namespaces/llvm/#abe00617fc34ceb1aa0eb62995732b30aa68b46a44773674a07e6730fac74fc46b">CloneFunctionChangeType::LocalChangesOnly</a>,</span></CodeLine>
<Link id="l00095" /><CodeLine lineNumber="95"><span class="doxyHighlight">                                    DIFinder, SPClonedWithinModule);</span></CodeLine>
<Link id="l00096" /><CodeLine lineNumber="96"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00097" /><CodeLine lineNumber="97"><span class="doxyHighlight">&#125; </span><span class="doxyHighlightComment">// end anonymous namespace</span></CodeLine>
<Link id="l00098" /><CodeLine lineNumber="98"></CodeLine>
<Link id="l00099" /><CodeLine lineNumber="99"><span class="doxyHighlightComment">// FIXME:</span></CodeLine>
<Link id="l00100" /><CodeLine lineNumber="100"><span class="doxyHighlightComment">// Lower the intrinisc in CoroEarly phase if coroutine frame doesn&#39;t escape</span></CodeLine>
<Link id="l00101" /><CodeLine lineNumber="101"><span class="doxyHighlightComment">// and it is known that other transformations, for example, sanitizers</span></CodeLine>
<Link id="l00102" /><CodeLine lineNumber="102"><span class="doxyHighlightComment">// won&#39;t lead to incorrect code.</span></CodeLine>
<Link id="l00103" /><CodeLine lineNumber="103" lineLink="#ab5b261757331e18b934bba9c3d3e6b69"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#ab5b261757331e18b934bba9c3d3e6b69">lowerAwaitSuspend</a>(<a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> &amp;Builder, <a href="/docs/api/classes/llvm/coroawaitsuspendinst">CoroAwaitSuspendInst</a> &#42;CB,</span></CodeLine>
<Link id="l00104" /><CodeLine lineNumber="104"><span class="doxyHighlight">                              <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;Shape) &#123;</span></CodeLine>
<Link id="l00105" /><CodeLine lineNumber="105"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpualiasanalysis-cpp/#a63f565f28385a6f2c7a4756ff6f3fa16">Wrapper</a> = CB-&gt;<a href="/docs/api/classes/llvm/coroawaitsuspendinst/#afd6b128b8f20ce45f7417590b5527b09">getWrapperFunction</a>();</span></CodeLine>
<Link id="l00106" /><CodeLine lineNumber="106"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Awaiter = CB-&gt;<a href="/docs/api/classes/llvm/coroawaitsuspendinst/#ad95956ea38c201709e4f6e230ccdebff">getAwaiter</a>();</span></CodeLine>
<Link id="l00107" /><CodeLine lineNumber="107"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a> = CB-&gt;<a href="/docs/api/classes/llvm/coroawaitsuspendinst/#a661148f67663ccb7062f61fa52acd614">getFrame</a>();</span></CodeLine>
<Link id="l00108" /><CodeLine lineNumber="108"></CodeLine>
<Link id="l00109" /><CodeLine lineNumber="109"><span class="doxyHighlight">  Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#ace45cae6925c65e9d6916e09dd5b17cc">SetInsertPoint</a>(CB);</span></CodeLine>
<Link id="l00110" /><CodeLine lineNumber="110"></CodeLine>
<Link id="l00111" /><CodeLine lineNumber="111"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/callbase">CallBase</a> &#42;NewCall = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00112" /><CodeLine lineNumber="112"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// await&#95;suspend has only 2 parameters, awaiter and handle.</span></CodeLine>
<Link id="l00113" /><CodeLine lineNumber="113"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Copy parameter attributes from the intrinsic call, but remove the last,</span></CodeLine>
<Link id="l00114" /><CodeLine lineNumber="114"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// because the last parameter now becomes the function that is being called.</span></CodeLine>
<Link id="l00115" /><CodeLine lineNumber="115"><span class="doxyHighlight">  AttributeList NewAttributes =</span></CodeLine>
<Link id="l00116" /><CodeLine lineNumber="116"><span class="doxyHighlight">      CB-&gt;<a href="/docs/api/classes/llvm/callbase/#ae0c55761fce39dd71617690b04385193">getAttributes</a>().removeParamAttributes(CB-&gt;<a href="/docs/api/classes/llvm/value/#ab3fc0225d8aaf8434026c3573f961f2c">getContext</a>(), 2);</span></CodeLine>
<Link id="l00117" /><CodeLine lineNumber="117"></CodeLine>
<Link id="l00118" /><CodeLine lineNumber="118"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Invoke = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;InvokeInst&gt;</a>(CB)) &#123;</span></CodeLine>
<Link id="l00119" /><CodeLine lineNumber="119"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> WrapperInvoke =</span></CodeLine>
<Link id="l00120" /><CodeLine lineNumber="120"><span class="doxyHighlight">        Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a49c408a438b1844778bc59b1e4bb00c9">CreateInvoke</a>(<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpualiasanalysis-cpp/#a63f565f28385a6f2c7a4756ff6f3fa16">Wrapper</a>, Invoke-&gt;getNormalDest(),</span></CodeLine>
<Link id="l00121" /><CodeLine lineNumber="121"><span class="doxyHighlight">                             Invoke-&gt;getUnwindDest(), &#123;Awaiter, FramePtr&#125;);</span></CodeLine>
<Link id="l00122" /><CodeLine lineNumber="122"></CodeLine>
<Link id="l00123" /><CodeLine lineNumber="123"><span class="doxyHighlight">    WrapperInvoke-&gt;<a href="/docs/api/classes/llvm/callbase/#a0851b4de29686e9c3918449b054cfada">setCallingConv</a>(Invoke-&gt;getCallingConv());</span></CodeLine>
<Link id="l00124" /><CodeLine lineNumber="124"><span class="doxyHighlight">    std::copy(Invoke-&gt;bundle&#95;op&#95;info&#95;begin(), Invoke-&gt;bundle&#95;op&#95;info&#95;end(),</span></CodeLine>
<Link id="l00125" /><CodeLine lineNumber="125"><span class="doxyHighlight">              WrapperInvoke-&gt;bundle&#95;op&#95;info&#95;begin());</span></CodeLine>
<Link id="l00126" /><CodeLine lineNumber="126"><span class="doxyHighlight">    WrapperInvoke-&gt;setAttributes(NewAttributes);</span></CodeLine>
<Link id="l00127" /><CodeLine lineNumber="127"><span class="doxyHighlight">    WrapperInvoke-&gt;setDebugLoc(Invoke-&gt;getDebugLoc());</span></CodeLine>
<Link id="l00128" /><CodeLine lineNumber="128"><span class="doxyHighlight">    NewCall = WrapperInvoke;</span></CodeLine>
<Link id="l00129" /><CodeLine lineNumber="129"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> <a href="/docs/api/groups/arcopt/#ga9c9cf6ad55eb23d77d083a184e416c09">Call</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CallInst&gt;</a>(CB)) &#123;</span></CodeLine>
<Link id="l00130" /><CodeLine lineNumber="130"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> WrapperCall = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#ab086c5b9f9563eda0cdd703f454e041e">CreateCall</a>(<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpualiasanalysis-cpp/#a63f565f28385a6f2c7a4756ff6f3fa16">Wrapper</a>, &#123;Awaiter, <a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>&#125;);</span></CodeLine>
<Link id="l00131" /><CodeLine lineNumber="131"></CodeLine>
<Link id="l00132" /><CodeLine lineNumber="132"><span class="doxyHighlight">    WrapperCall-&gt;<a href="/docs/api/classes/llvm/callbase/#a9da3b29e8e71b9be4645874e1721207a">setAttributes</a>(NewAttributes);</span></CodeLine>
<Link id="l00133" /><CodeLine lineNumber="133"><span class="doxyHighlight">    WrapperCall-&gt;setDebugLoc(<a href="/docs/api/groups/arcopt/#ga9c9cf6ad55eb23d77d083a184e416c09">Call</a>-&gt;getDebugLoc());</span></CodeLine>
<Link id="l00134" /><CodeLine lineNumber="134"><span class="doxyHighlight">    NewCall = WrapperCall;</span></CodeLine>
<Link id="l00135" /><CodeLine lineNumber="135"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00136" /><CodeLine lineNumber="136"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/errorhandling-h/#ace243f5c25697a1107cce46626b3dc94">llvm&#95;unreachable</a>(</span><span class="doxyHighlightStringLiteral">&quot;Unexpected coro&#95;await&#95;suspend invocation method&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00137" /><CodeLine lineNumber="137"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00138" /><CodeLine lineNumber="138"></CodeLine>
<Link id="l00139" /><CodeLine lineNumber="139"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CB-&gt;<a href="/docs/api/classes/llvm/callbase/#a2b1ae7cf1bafdd43d1fee4c6ad0a2913">getCalledFunction</a>()-&gt;<a href="/docs/api/classes/llvm/function/#a4d0a7baab8d078065b2de10e3460892a">getIntrinsicID</a>() ==</span></CodeLine>
<Link id="l00140" /><CodeLine lineNumber="140"><span class="doxyHighlight">      Intrinsic::coro&#95;await&#95;suspend&#95;handle) &#123;</span></CodeLine>
<Link id="l00141" /><CodeLine lineNumber="141"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Follow the lowered await&#95;suspend call above with a lowered resume call</span></CodeLine>
<Link id="l00142" /><CodeLine lineNumber="142"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// to the returned coroutine.</span></CodeLine>
<Link id="l00143" /><CodeLine lineNumber="143"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Invoke = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;InvokeInst&gt;</a>(CB)) &#123;</span></CodeLine>
<Link id="l00144" /><CodeLine lineNumber="144"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If the await&#95;suspend call is an invoke, we continue in the next block.</span></CodeLine>
<Link id="l00145" /><CodeLine lineNumber="145"><span class="doxyHighlight">      Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#ace45cae6925c65e9d6916e09dd5b17cc">SetInsertPoint</a>(Invoke-&gt;getNormalDest()-&gt;getFirstInsertionPt());</span></CodeLine>
<Link id="l00146" /><CodeLine lineNumber="146"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00147" /><CodeLine lineNumber="147"></CodeLine>
<Link id="l00148" /><CodeLine lineNumber="148"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/coro/lowererbase">coro::LowererBase</a> LB(&#42;<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpualiasanalysis-cpp/#a63f565f28385a6f2c7a4756ff6f3fa16">Wrapper</a>-&gt;getParent());</span></CodeLine>
<Link id="l00149" /><CodeLine lineNumber="149"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;ResumeAddr = LB.<a href="/docs/api/structs/llvm/coro/lowererbase/#a8e44a67be75da70df132c8683575d772">makeSubFnCall</a>(NewCall, <a href="/docs/api/classes/llvm/corosubfninst/#abb112419696544e53611285949f18783a87b893a1cb8e9c1f3247601121d13e01">CoroSubFnInst::ResumeIndex</a>,</span></CodeLine>
<Link id="l00150" /><CodeLine lineNumber="150"><span class="doxyHighlight">                                        &amp;&#42;Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a4e5c1b91bf5e2860398e3fa35c96b5af">GetInsertPoint</a>());</span></CodeLine>
<Link id="l00151" /><CodeLine lineNumber="151"></CodeLine>
<Link id="l00152" /><CodeLine lineNumber="152"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/llvmcontext">LLVMContext</a> &amp;Ctx = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aa2ed385be8984b4306762990278eb13d">getContext</a>();</span></CodeLine>
<Link id="l00153" /><CodeLine lineNumber="153"><span class="doxyHighlight">    <a href="/docs/api/classes/functiontype">FunctionType</a> &#42;ResumeTy = <a href="/docs/api/classes/llvm/functiontype/#af8be7844c269f201ebcee1e15048c378">FunctionType::get</a>(</span></CodeLine>
<Link id="l00154" /><CodeLine lineNumber="154"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/type/#a6e20e76960d952de088354cbcd14c3ab">Type::getVoidTy</a>(Ctx), <a href="/docs/api/classes/llvm/pointertype/#af8a1dbdbfd89aa4899b3c0d39495d0dd">PointerType::getUnqual</a>(Ctx), </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00155" /><CodeLine lineNumber="155"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;ResumeCall = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#ab086c5b9f9563eda0cdd703f454e041e">CreateCall</a>(ResumeTy, ResumeAddr, &#123;NewCall&#125;);</span></CodeLine>
<Link id="l00156" /><CodeLine lineNumber="156"><span class="doxyHighlight">    ResumeCall-&gt;<a href="/docs/api/classes/llvm/callbase/#a0851b4de29686e9c3918449b054cfada">setCallingConv</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cabc8e2ee40a84687a9e12fd08784b87ba">CallingConv::Fast</a>);</span></CodeLine>
<Link id="l00157" /><CodeLine lineNumber="157"></CodeLine>
<Link id="l00158" /><CodeLine lineNumber="158"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We can&#39;t insert the &#39;ret&#39; instruction and adjust the cc until the</span></CodeLine>
<Link id="l00159" /><CodeLine lineNumber="159"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// function has been split, so remember this for later.</span></CodeLine>
<Link id="l00160" /><CodeLine lineNumber="160"><span class="doxyHighlight">    Shape.<a href="/docs/api/structs/llvm/coro/shape/#a06f9098a6725a57dcb2b25cdc9fd3398">SymmetricTransfers</a>.push&#95;back(ResumeCall);</span></CodeLine>
<Link id="l00161" /><CodeLine lineNumber="161"></CodeLine>
<Link id="l00162" /><CodeLine lineNumber="162"><span class="doxyHighlight">    NewCall = ResumeCall;</span></CodeLine>
<Link id="l00163" /><CodeLine lineNumber="163"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00164" /><CodeLine lineNumber="164"></CodeLine>
<Link id="l00165" /><CodeLine lineNumber="165"><span class="doxyHighlight">  CB-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(NewCall);</span></CodeLine>
<Link id="l00166" /><CodeLine lineNumber="166"><span class="doxyHighlight">  CB-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</span></CodeLine>
<Link id="l00167" /><CodeLine lineNumber="167"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00168" /><CodeLine lineNumber="168"></CodeLine>
<Link id="l00169" /><CodeLine lineNumber="169" lineLink="#ab68c3421a2e14ba10398bfcd82d6161e"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#ab68c3421a2e14ba10398bfcd82d6161e">lowerAwaitSuspends</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;Shape) &#123;</span></CodeLine>
<Link id="l00170" /><CodeLine lineNumber="170"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> Builder(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getContext());</span></CodeLine>
<Link id="l00171" /><CodeLine lineNumber="171"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;AWS : Shape.<a href="/docs/api/structs/llvm/coro/shape/#a0b14d3f96facecc355aaac306b6279ae">CoroAwaitSuspends</a>)</span></CodeLine>
<Link id="l00172" /><CodeLine lineNumber="172"><span class="doxyHighlight">    <a href="#ab5b261757331e18b934bba9c3d3e6b69">lowerAwaitSuspend</a>(Builder, AWS, Shape);</span></CodeLine>
<Link id="l00173" /><CodeLine lineNumber="173"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00174" /><CodeLine lineNumber="174"></CodeLine>
<Link id="l00175" /><CodeLine lineNumber="175" lineLink="#a3907189466613e437b0ea2731bf9b159"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#a3907189466613e437b0ea2731bf9b159">maybeFreeRetconStorage</a>(<a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> &amp;Builder,</span></CodeLine>
<Link id="l00176" /><CodeLine lineNumber="176"><span class="doxyHighlight">                                   </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;Shape, <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>,</span></CodeLine>
<Link id="l00177" /><CodeLine lineNumber="177"><span class="doxyHighlight">                                   <a href="/docs/api/classes/llvm/callgraph">CallGraph</a> &#42;CG) &#123;</span></CodeLine>
<Link id="l00178" /><CodeLine lineNumber="178"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Shape.<a href="/docs/api/structs/llvm/coro/shape/#a4e554c60419835fc3c74b91b28ca31c8">ABI</a> == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380aad9d7f07127e321d1358b695c8720166">coro::ABI::Retcon</a> || Shape.<a href="/docs/api/structs/llvm/coro/shape/#a4e554c60419835fc3c74b91b28ca31c8">ABI</a> == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a6ec6c15fe79ec2274d2c3e79ae4bcc41">coro::ABI::RetconOnce</a>);</span></CodeLine>
<Link id="l00179" /><CodeLine lineNumber="179"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Shape.<a href="/docs/api/structs/llvm/coro/shape/#ace1508259ecd37ceaafb9162d3768fff">RetconLowering</a>.<a href="/docs/api/structs/llvm/coro/shape/retconloweringstorage/#a4df922b446b5bfca3248510df728539b">IsFrameInlineInStorage</a>)</span></CodeLine>
<Link id="l00180" /><CodeLine lineNumber="180"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00181" /><CodeLine lineNumber="181"></CodeLine>
<Link id="l00182" /><CodeLine lineNumber="182"><span class="doxyHighlight">  Shape.<a href="/docs/api/structs/llvm/coro/shape/#acad2aaa7f484c978bb790533eec90ac4">emitDealloc</a>(Builder, <a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>, CG);</span></CodeLine>
<Link id="l00183" /><CodeLine lineNumber="183"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00184" /><CodeLine lineNumber="184"></CodeLine>
<Link id="l00185" /><CodeLine lineNumber="185"><span class="doxyHighlightComment">/// Replace an llvm.coro.end.async.</span></CodeLine>
<Link id="l00186" /><CodeLine lineNumber="186"><span class="doxyHighlightComment">/// Will inline the must tail call function call if there is one.</span></CodeLine>
<Link id="l00187" /><CodeLine lineNumber="187"><span class="doxyHighlightComment">/// \\returns true if cleanup of the coro.end block is needed, false otherwise.</span></CodeLine>
<Link id="l00188" /><CodeLine lineNumber="188" lineLink="#a8b22bf92719f6baa98dcfe7e99bd5389"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#a8b22bf92719f6baa98dcfe7e99bd5389">replaceCoroEndAsync</a>(<a href="/docs/api/classes/llvm/anycoroendinst">AnyCoroEndInst</a> &#42;End) &#123;</span></CodeLine>
<Link id="l00189" /><CodeLine lineNumber="189"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> Builder(End);</span></CodeLine>
<Link id="l00190" /><CodeLine lineNumber="190"></CodeLine>
<Link id="l00191" /><CodeLine lineNumber="191"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;EndAsync = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CoroAsyncEndInst&gt;</a>(End);</span></CodeLine>
<Link id="l00192" /><CodeLine lineNumber="192"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!EndAsync) &#123;</span></CodeLine>
<Link id="l00193" /><CodeLine lineNumber="193"><span class="doxyHighlight">    Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aa6536556982b7e6e2e5884e471f3ce6b">CreateRetVoid</a>();</span></CodeLine>
<Link id="l00194" /><CodeLine lineNumber="194"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight"> </span><span class="doxyHighlightComment">/&#42;needs cleanup of coro.end block&#42;/</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00195" /><CodeLine lineNumber="195"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00196" /><CodeLine lineNumber="196"></CodeLine>
<Link id="l00197" /><CodeLine lineNumber="197"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;MustTailCallFunc = EndAsync-&gt;getMustTailCallFunction();</span></CodeLine>
<Link id="l00198" /><CodeLine lineNumber="198"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!MustTailCallFunc) &#123;</span></CodeLine>
<Link id="l00199" /><CodeLine lineNumber="199"><span class="doxyHighlight">    Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aa6536556982b7e6e2e5884e471f3ce6b">CreateRetVoid</a>();</span></CodeLine>
<Link id="l00200" /><CodeLine lineNumber="200"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight"> </span><span class="doxyHighlightComment">/&#42;needs cleanup of coro.end block&#42;/</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00201" /><CodeLine lineNumber="201"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00202" /><CodeLine lineNumber="202"></CodeLine>
<Link id="l00203" /><CodeLine lineNumber="203"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Move the must tail call from the predecessor block into the end block.</span></CodeLine>
<Link id="l00204" /><CodeLine lineNumber="204"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CoroEndBlock = End-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>();</span></CodeLine>
<Link id="l00205" /><CodeLine lineNumber="205"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;MustTailCallFuncBlock = CoroEndBlock-&gt;getSinglePredecessor();</span></CodeLine>
<Link id="l00206" /><CodeLine lineNumber="206"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(MustTailCallFuncBlock &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Must have a single predecessor block&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00207" /><CodeLine lineNumber="207"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> It = MustTailCallFuncBlock-&gt;getTerminator()-&gt;getIterator();</span></CodeLine>
<Link id="l00208" /><CodeLine lineNumber="208"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;MustTailCall = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CallInst&gt;</a>(&amp;&#42;std::prev(It));</span></CodeLine>
<Link id="l00209" /><CodeLine lineNumber="209"><span class="doxyHighlight">  CoroEndBlock-&gt;splice(End-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>(), MustTailCallFuncBlock,</span></CodeLine>
<Link id="l00210" /><CodeLine lineNumber="210"><span class="doxyHighlight">                       MustTailCall-&gt;getIterator());</span></CodeLine>
<Link id="l00211" /><CodeLine lineNumber="211"></CodeLine>
<Link id="l00212" /><CodeLine lineNumber="212"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Insert the return instruction.</span></CodeLine>
<Link id="l00213" /><CodeLine lineNumber="213"><span class="doxyHighlight">  Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#ace45cae6925c65e9d6916e09dd5b17cc">SetInsertPoint</a>(End);</span></CodeLine>
<Link id="l00214" /><CodeLine lineNumber="214"><span class="doxyHighlight">  Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aa6536556982b7e6e2e5884e471f3ce6b">CreateRetVoid</a>();</span></CodeLine>
<Link id="l00215" /><CodeLine lineNumber="215"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/inlinefunctioninfo">InlineFunctionInfo</a> FnInfo;</span></CodeLine>
<Link id="l00216" /><CodeLine lineNumber="216"></CodeLine>
<Link id="l00217" /><CodeLine lineNumber="217"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Remove the rest of the block, by splitting it into an unreachable block.</span></CodeLine>
<Link id="l00218" /><CodeLine lineNumber="218"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;BB = End-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>();</span></CodeLine>
<Link id="l00219" /><CodeLine lineNumber="219"><span class="doxyHighlight">  BB-&gt;splitBasicBlock(End);</span></CodeLine>
<Link id="l00220" /><CodeLine lineNumber="220"><span class="doxyHighlight">  BB-&gt;getTerminator()-&gt;eraseFromParent();</span></CodeLine>
<Link id="l00221" /><CodeLine lineNumber="221"></CodeLine>
<Link id="l00222" /><CodeLine lineNumber="222"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> InlineRes = <a href="/docs/api/namespaces/llvm/#ab5a3ac0a249da0743dac1bd816d8e5d5">InlineFunction</a>(&#42;MustTailCall, FnInfo);</span></CodeLine>
<Link id="l00223" /><CodeLine lineNumber="223"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(InlineRes.isSuccess() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Expected inlining to succeed&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00224" /><CodeLine lineNumber="224"><span class="doxyHighlight">  (void)InlineRes;</span></CodeLine>
<Link id="l00225" /><CodeLine lineNumber="225"></CodeLine>
<Link id="l00226" /><CodeLine lineNumber="226"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We have cleaned up the coro.end block above.</span></CodeLine>
<Link id="l00227" /><CodeLine lineNumber="227"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00228" /><CodeLine lineNumber="228"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00229" /><CodeLine lineNumber="229"></CodeLine>
<Link id="l00230" /><CodeLine lineNumber="230"><span class="doxyHighlightComment">/// Replace a non-unwind call to llvm.coro.end.</span></CodeLine>
<Link id="l00231" /><CodeLine lineNumber="231" lineLink="#a84fbc09723655416fad6677d7fdaf8a6"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#a84fbc09723655416fad6677d7fdaf8a6">replaceFallthroughCoroEnd</a>(<a href="/docs/api/classes/llvm/anycoroendinst">AnyCoroEndInst</a> &#42;End,</span></CodeLine>
<Link id="l00232" /><CodeLine lineNumber="232"><span class="doxyHighlight">                                      </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;Shape, <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>,</span></CodeLine>
<Link id="l00233" /><CodeLine lineNumber="233"><span class="doxyHighlight">                                      </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> InResume, <a href="/docs/api/classes/llvm/callgraph">CallGraph</a> &#42;CG) &#123;</span></CodeLine>
<Link id="l00234" /><CodeLine lineNumber="234"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Start inserting right before the coro.end.</span></CodeLine>
<Link id="l00235" /><CodeLine lineNumber="235"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> Builder(End);</span></CodeLine>
<Link id="l00236" /><CodeLine lineNumber="236"></CodeLine>
<Link id="l00237" /><CodeLine lineNumber="237"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create the return instruction.</span></CodeLine>
<Link id="l00238" /><CodeLine lineNumber="238"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (Shape.<a href="/docs/api/structs/llvm/coro/shape/#a4e554c60419835fc3c74b91b28ca31c8">ABI</a>) &#123;</span></CodeLine>
<Link id="l00239" /><CodeLine lineNumber="239"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The cloned functions in switch-lowering always return void.</span></CodeLine>
<Link id="l00240" /><CodeLine lineNumber="240"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">coro::ABI::Switch</a>:</span></CodeLine>
<Link id="l00241" /><CodeLine lineNumber="241"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CoroEndInst&gt;</a>(End)-&gt;hasResults() &amp;&amp;</span></CodeLine>
<Link id="l00242" /><CodeLine lineNumber="242"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;switch coroutine should not return any values&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00243" /><CodeLine lineNumber="243"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// coro.end doesn&#39;t immediately end the coroutine in the main function</span></CodeLine>
<Link id="l00244" /><CodeLine lineNumber="244"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// in this lowering, because we need to deallocate the coroutine.</span></CodeLine>
<Link id="l00245" /><CodeLine lineNumber="245"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!InResume)</span></CodeLine>
<Link id="l00246" /><CodeLine lineNumber="246"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00247" /><CodeLine lineNumber="247"><span class="doxyHighlight">    Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aa6536556982b7e6e2e5884e471f3ce6b">CreateRetVoid</a>();</span></CodeLine>
<Link id="l00248" /><CodeLine lineNumber="248"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00249" /><CodeLine lineNumber="249"></CodeLine>
<Link id="l00250" /><CodeLine lineNumber="250"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In async lowering this returns.</span></CodeLine>
<Link id="l00251" /><CodeLine lineNumber="251"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a24aa4117da86c41684ad25742832dfa6">coro::ABI::Async</a>: &#123;</span></CodeLine>
<Link id="l00252" /><CodeLine lineNumber="252"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> CoroEndBlockNeedsCleanup = <a href="#a8b22bf92719f6baa98dcfe7e99bd5389">replaceCoroEndAsync</a>(End);</span></CodeLine>
<Link id="l00253" /><CodeLine lineNumber="253"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CoroEndBlockNeedsCleanup)</span></CodeLine>
<Link id="l00254" /><CodeLine lineNumber="254"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00255" /><CodeLine lineNumber="255"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00256" /><CodeLine lineNumber="256"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00257" /><CodeLine lineNumber="257"></CodeLine>
<Link id="l00258" /><CodeLine lineNumber="258"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In unique continuation lowering, the continuations always return void.</span></CodeLine>
<Link id="l00259" /><CodeLine lineNumber="259"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// But we may have implicitly allocated storage.</span></CodeLine>
<Link id="l00260" /><CodeLine lineNumber="260"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a6ec6c15fe79ec2274d2c3e79ae4bcc41">coro::ABI::RetconOnce</a>: &#123;</span></CodeLine>
<Link id="l00261" /><CodeLine lineNumber="261"><span class="doxyHighlight">    <a href="#a3907189466613e437b0ea2731bf9b159">maybeFreeRetconStorage</a>(Builder, Shape, <a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>, CG);</span></CodeLine>
<Link id="l00262" /><CodeLine lineNumber="262"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CoroEnd = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CoroEndInst&gt;</a>(End);</span></CodeLine>
<Link id="l00263" /><CodeLine lineNumber="263"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;RetTy = Shape.<a href="/docs/api/structs/llvm/coro/shape/#a1a578073d9d2487a3806e8a51abb1b6e">getResumeFunctionType</a>()-&gt;<a href="/docs/api/classes/llvm/functiontype/#ad65790aa94dd4678a1d339d8304e1965">getReturnType</a>();</span></CodeLine>
<Link id="l00264" /><CodeLine lineNumber="264"></CodeLine>
<Link id="l00265" /><CodeLine lineNumber="265"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CoroEnd-&gt;hasResults()) &#123;</span></CodeLine>
<Link id="l00266" /><CodeLine lineNumber="266"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(RetTy-&gt;isVoidTy());</span></CodeLine>
<Link id="l00267" /><CodeLine lineNumber="267"><span class="doxyHighlight">      Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aa6536556982b7e6e2e5884e471f3ce6b">CreateRetVoid</a>();</span></CodeLine>
<Link id="l00268" /><CodeLine lineNumber="268"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00269" /><CodeLine lineNumber="269"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00270" /><CodeLine lineNumber="270"></CodeLine>
<Link id="l00271" /><CodeLine lineNumber="271"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CoroResults = CoroEnd-&gt;getResults();</span></CodeLine>
<Link id="l00272" /><CodeLine lineNumber="272"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumReturns = CoroResults-&gt;numReturns();</span></CodeLine>
<Link id="l00273" /><CodeLine lineNumber="273"></CodeLine>
<Link id="l00274" /><CodeLine lineNumber="274"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;RetStructTy = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;StructType&gt;</a>(RetTy)) &#123;</span></CodeLine>
<Link id="l00275" /><CodeLine lineNumber="275"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(RetStructTy-&gt;getNumElements() == NumReturns &amp;&amp;</span></CodeLine>
<Link id="l00276" /><CodeLine lineNumber="276"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;numbers of returns should match resume function singature&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00277" /><CodeLine lineNumber="277"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;ReturnValue = <a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(RetStructTy);</span></CodeLine>
<Link id="l00278" /><CodeLine lineNumber="278"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> Idx = 0;</span></CodeLine>
<Link id="l00279" /><CodeLine lineNumber="279"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/value">Value</a> &#42;RetValEl : CoroResults-&gt;return&#95;values())</span></CodeLine>
<Link id="l00280" /><CodeLine lineNumber="280"><span class="doxyHighlight">        ReturnValue = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a20833e358e38f9a86074bb4cc72b0d14">CreateInsertValue</a>(ReturnValue, RetValEl, Idx++);</span></CodeLine>
<Link id="l00281" /><CodeLine lineNumber="281"><span class="doxyHighlight">      Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a5d0c52ee1cde6421f98c193e0e42b97d">CreateRet</a>(ReturnValue);</span></CodeLine>
<Link id="l00282" /><CodeLine lineNumber="282"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NumReturns == 0) &#123;</span></CodeLine>
<Link id="l00283" /><CodeLine lineNumber="283"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(RetTy-&gt;isVoidTy());</span></CodeLine>
<Link id="l00284" /><CodeLine lineNumber="284"><span class="doxyHighlight">      Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aa6536556982b7e6e2e5884e471f3ce6b">CreateRetVoid</a>();</span></CodeLine>
<Link id="l00285" /><CodeLine lineNumber="285"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00286" /><CodeLine lineNumber="286"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(NumReturns == 1);</span></CodeLine>
<Link id="l00287" /><CodeLine lineNumber="287"><span class="doxyHighlight">      Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a5d0c52ee1cde6421f98c193e0e42b97d">CreateRet</a>(&#42;CoroResults-&gt;retval&#95;begin());</span></CodeLine>
<Link id="l00288" /><CodeLine lineNumber="288"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00289" /><CodeLine lineNumber="289"><span class="doxyHighlight">    CoroResults-&gt;replaceAllUsesWith(</span></CodeLine>
<Link id="l00290" /><CodeLine lineNumber="290"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/constanttokennone/#a8e29fb8e39fb67b3bb746dbba47fcb29">ConstantTokenNone::get</a>(CoroResults-&gt;getContext()));</span></CodeLine>
<Link id="l00291" /><CodeLine lineNumber="291"><span class="doxyHighlight">    CoroResults-&gt;eraseFromParent();</span></CodeLine>
<Link id="l00292" /><CodeLine lineNumber="292"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00293" /><CodeLine lineNumber="293"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00294" /><CodeLine lineNumber="294"></CodeLine>
<Link id="l00295" /><CodeLine lineNumber="295"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In non-unique continuation lowering, we signal completion by returning</span></CodeLine>
<Link id="l00296" /><CodeLine lineNumber="296"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// a null continuation.</span></CodeLine>
<Link id="l00297" /><CodeLine lineNumber="297"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380aad9d7f07127e321d1358b695c8720166">coro::ABI::Retcon</a>: &#123;</span></CodeLine>
<Link id="l00298" /><CodeLine lineNumber="298"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CoroEndInst&gt;</a>(End)-&gt;hasResults() &amp;&amp;</span></CodeLine>
<Link id="l00299" /><CodeLine lineNumber="299"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;retcon coroutine should not return any values&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00300" /><CodeLine lineNumber="300"><span class="doxyHighlight">    <a href="#a3907189466613e437b0ea2731bf9b159">maybeFreeRetconStorage</a>(Builder, Shape, <a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>, CG);</span></CodeLine>
<Link id="l00301" /><CodeLine lineNumber="301"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> RetTy = Shape.<a href="/docs/api/structs/llvm/coro/shape/#a1a578073d9d2487a3806e8a51abb1b6e">getResumeFunctionType</a>()-&gt;<a href="/docs/api/classes/llvm/functiontype/#ad65790aa94dd4678a1d339d8304e1965">getReturnType</a>();</span></CodeLine>
<Link id="l00302" /><CodeLine lineNumber="302"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> RetStructTy = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;StructType&gt;</a>(RetTy);</span></CodeLine>
<Link id="l00303" /><CodeLine lineNumber="303"><span class="doxyHighlight">    <a href="/docs/api/classes/pointertype">PointerType</a> &#42;ContinuationTy =</span></CodeLine>
<Link id="l00304" /><CodeLine lineNumber="304"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;PointerType&gt;</a>(RetStructTy ? RetStructTy-&gt;getElementType(0) : RetTy);</span></CodeLine>
<Link id="l00305" /><CodeLine lineNumber="305"></CodeLine>
<Link id="l00306" /><CodeLine lineNumber="306"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;ReturnValue = <a href="/docs/api/classes/llvm/constantpointernull/#a96f5c85e4022e369266541b2db3fda69">ConstantPointerNull::get</a>(ContinuationTy);</span></CodeLine>
<Link id="l00307" /><CodeLine lineNumber="307"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (RetStructTy) &#123;</span></CodeLine>
<Link id="l00308" /><CodeLine lineNumber="308"><span class="doxyHighlight">      ReturnValue = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a20833e358e38f9a86074bb4cc72b0d14">CreateInsertValue</a>(<a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(RetStructTy),</span></CodeLine>
<Link id="l00309" /><CodeLine lineNumber="309"><span class="doxyHighlight">                                              ReturnValue, 0);</span></CodeLine>
<Link id="l00310" /><CodeLine lineNumber="310"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00311" /><CodeLine lineNumber="311"><span class="doxyHighlight">    Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a5d0c52ee1cde6421f98c193e0e42b97d">CreateRet</a>(ReturnValue);</span></CodeLine>
<Link id="l00312" /><CodeLine lineNumber="312"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00313" /><CodeLine lineNumber="313"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00314" /><CodeLine lineNumber="314"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00315" /><CodeLine lineNumber="315"></CodeLine>
<Link id="l00316" /><CodeLine lineNumber="316"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Remove the rest of the block, by splitting it into an unreachable block.</span></CodeLine>
<Link id="l00317" /><CodeLine lineNumber="317"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;BB = End-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>();</span></CodeLine>
<Link id="l00318" /><CodeLine lineNumber="318"><span class="doxyHighlight">  BB-&gt;splitBasicBlock(End);</span></CodeLine>
<Link id="l00319" /><CodeLine lineNumber="319"><span class="doxyHighlight">  BB-&gt;getTerminator()-&gt;eraseFromParent();</span></CodeLine>
<Link id="l00320" /><CodeLine lineNumber="320"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00321" /><CodeLine lineNumber="321"></CodeLine>
<Link id="l00322" /><CodeLine lineNumber="322"><span class="doxyHighlightComment">// Mark a coroutine as done, which implies that the coroutine is finished and</span></CodeLine>
<Link id="l00323" /><CodeLine lineNumber="323"><span class="doxyHighlightComment">// never get resumed.</span></CodeLine>
<Link id="l00324" /><CodeLine lineNumber="324"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00325" /><CodeLine lineNumber="325"><span class="doxyHighlightComment">// In resume-switched ABI, the done state is represented by storing zero in</span></CodeLine>
<Link id="l00326" /><CodeLine lineNumber="326"><span class="doxyHighlightComment">// ResumeFnAddr.</span></CodeLine>
<Link id="l00327" /><CodeLine lineNumber="327"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00328" /><CodeLine lineNumber="328"><span class="doxyHighlightComment">// NOTE: We couldn&#39;t omit the argument &#96;FramePtr&#96;. It is necessary because the</span></CodeLine>
<Link id="l00329" /><CodeLine lineNumber="329"><span class="doxyHighlightComment">// pointer to the frame in splitted function is not stored in &#96;Shape&#96;.</span></CodeLine>
<Link id="l00330" /><CodeLine lineNumber="330" lineLink="#aa6734dd82cf736e89074802287b0abfe"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#aa6734dd82cf736e89074802287b0abfe">markCoroutineAsDone</a>(<a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> &amp;Builder, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;Shape,</span></CodeLine>
<Link id="l00331" /><CodeLine lineNumber="331"><span class="doxyHighlight">                                <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>) &#123;</span></CodeLine>
<Link id="l00332" /><CodeLine lineNumber="332"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(</span></CodeLine>
<Link id="l00333" /><CodeLine lineNumber="333"><span class="doxyHighlight">      Shape.<a href="/docs/api/structs/llvm/coro/shape/#a4e554c60419835fc3c74b91b28ca31c8">ABI</a> == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">coro::ABI::Switch</a> &amp;&amp;</span></CodeLine>
<Link id="l00334" /><CodeLine lineNumber="334"><span class="doxyHighlight">      </span><span class="doxyHighlightStringLiteral">&quot;markCoroutineAsDone is only supported for Switch-Resumed ABI for now.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00335" /><CodeLine lineNumber="335"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;GepIndex = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a4e95ff363c20e1f51b673230538e10fd">CreateStructGEP</a>(</span></CodeLine>
<Link id="l00336" /><CodeLine lineNumber="336"><span class="doxyHighlight">      Shape.<a href="/docs/api/structs/llvm/coro/shape/#a24c5fed9b14aed8a3b4f3828472fbab5">FrameTy</a>, <a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>, <a href="/docs/api/structs/llvm/coro/shape/switchfieldindex/#aef925686aca6c6970964fea2c25bf242a012dd1dc85c718e8159980fa4273d9e6">coro::Shape::SwitchFieldIndex::Resume</a>,</span></CodeLine>
<Link id="l00337" /><CodeLine lineNumber="337"><span class="doxyHighlight">      </span><span class="doxyHighlightStringLiteral">&quot;ResumeFn.addr&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00338" /><CodeLine lineNumber="338"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NullPtr = <a href="/docs/api/classes/llvm/constantpointernull/#a96f5c85e4022e369266541b2db3fda69">ConstantPointerNull::get</a>(<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;PointerType&gt;</a>(</span></CodeLine>
<Link id="l00339" /><CodeLine lineNumber="339"><span class="doxyHighlight">      Shape.<a href="/docs/api/structs/llvm/coro/shape/#a24c5fed9b14aed8a3b4f3828472fbab5">FrameTy</a>-&gt;<a href="/docs/api/classes/llvm/structtype/#abe11230ab448dd37adc9feb99ac7d3da">getTypeAtIndex</a>(<a href="/docs/api/structs/llvm/coro/shape/switchfieldindex/#aef925686aca6c6970964fea2c25bf242a012dd1dc85c718e8159980fa4273d9e6">coro::Shape::SwitchFieldIndex::Resume</a>)));</span></CodeLine>
<Link id="l00340" /><CodeLine lineNumber="340"><span class="doxyHighlight">  Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aabfc20af4dcf7d94262824dcac2e7bed">CreateStore</a>(NullPtr, GepIndex);</span></CodeLine>
<Link id="l00341" /><CodeLine lineNumber="341"></CodeLine>
<Link id="l00342" /><CodeLine lineNumber="342"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the coroutine don&#39;t have unwind coro end, we could omit the store to</span></CodeLine>
<Link id="l00343" /><CodeLine lineNumber="343"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the final suspend point since we could infer the coroutine is suspended</span></CodeLine>
<Link id="l00344" /><CodeLine lineNumber="344"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// at the final suspend point by the nullness of ResumeFnAddr.</span></CodeLine>
<Link id="l00345" /><CodeLine lineNumber="345"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// However, we can&#39;t skip it if the coroutine have unwind coro end. Since</span></CodeLine>
<Link id="l00346" /><CodeLine lineNumber="346"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the coroutine reaches unwind coro end is considered suspended at the</span></CodeLine>
<Link id="l00347" /><CodeLine lineNumber="347"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// final suspend point (the ResumeFnAddr is null) but in fact the coroutine</span></CodeLine>
<Link id="l00348" /><CodeLine lineNumber="348"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// didn&#39;t complete yet. We need the IndexVal for the final suspend point</span></CodeLine>
<Link id="l00349" /><CodeLine lineNumber="349"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// to make the states clear.</span></CodeLine>
<Link id="l00350" /><CodeLine lineNumber="350"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Shape.<a href="/docs/api/structs/llvm/coro/shape/#abe8f7906a8618f90e2a75109a778054a">SwitchLowering</a>.<a href="/docs/api/structs/llvm/coro/shape/switchloweringstorage/#a4eae23cbbb20b1a985a27727e3901ee6">HasUnwindCoroEnd</a> &amp;&amp;</span></CodeLine>
<Link id="l00351" /><CodeLine lineNumber="351"><span class="doxyHighlight">      Shape.<a href="/docs/api/structs/llvm/coro/shape/#abe8f7906a8618f90e2a75109a778054a">SwitchLowering</a>.<a href="/docs/api/structs/llvm/coro/shape/switchloweringstorage/#a443e8b3df70f81937afd7c6bf52f9f84">HasFinalSuspend</a>) &#123;</span></CodeLine>
<Link id="l00352" /><CodeLine lineNumber="352"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CoroSuspendInst&gt;</a>(Shape.<a href="/docs/api/structs/llvm/coro/shape/#a5fd0aa934908c837c6d78097a2fd667b">CoroSuspends</a>.back())-&gt;isFinal() &amp;&amp;</span></CodeLine>
<Link id="l00353" /><CodeLine lineNumber="353"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;The final suspend should only live in the last position of &quot;</span></CodeLine>
<Link id="l00354" /><CodeLine lineNumber="354"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;CoroSuspends.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00355" /><CodeLine lineNumber="355"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;IndexVal = Shape.<a href="/docs/api/structs/llvm/coro/shape/#a9e8a88398e176735a277b77269570c50">getIndex</a>(Shape.<a href="/docs/api/structs/llvm/coro/shape/#a5fd0aa934908c837c6d78097a2fd667b">CoroSuspends</a>.size() - 1);</span></CodeLine>
<Link id="l00356" /><CodeLine lineNumber="356"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;FinalIndex = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a4e95ff363c20e1f51b673230538e10fd">CreateStructGEP</a>(</span></CodeLine>
<Link id="l00357" /><CodeLine lineNumber="357"><span class="doxyHighlight">        Shape.<a href="/docs/api/structs/llvm/coro/shape/#a24c5fed9b14aed8a3b4f3828472fbab5">FrameTy</a>, <a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>, Shape.<a href="/docs/api/structs/llvm/coro/shape/#aedc5db661c24859142b1b7a67dc05ba7">getSwitchIndexField</a>(), </span><span class="doxyHighlightStringLiteral">&quot;index.addr&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00358" /><CodeLine lineNumber="358"></CodeLine>
<Link id="l00359" /><CodeLine lineNumber="359"><span class="doxyHighlight">    Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aabfc20af4dcf7d94262824dcac2e7bed">CreateStore</a>(IndexVal, FinalIndex);</span></CodeLine>
<Link id="l00360" /><CodeLine lineNumber="360"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00361" /><CodeLine lineNumber="361"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00362" /><CodeLine lineNumber="362"></CodeLine>
<Link id="l00363" /><CodeLine lineNumber="363"><span class="doxyHighlightComment">/// Replace an unwind call to llvm.coro.end.</span></CodeLine>
<Link id="l00364" /><CodeLine lineNumber="364" lineLink="#a9cb75e325aabbbb2e1fdf034b2f11491"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#a9cb75e325aabbbb2e1fdf034b2f11491">replaceUnwindCoroEnd</a>(<a href="/docs/api/classes/llvm/anycoroendinst">AnyCoroEndInst</a> &#42;End, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;Shape,</span></CodeLine>
<Link id="l00365" /><CodeLine lineNumber="365"><span class="doxyHighlight">                                 <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>, </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> InResume,</span></CodeLine>
<Link id="l00366" /><CodeLine lineNumber="366"><span class="doxyHighlight">                                 <a href="/docs/api/classes/llvm/callgraph">CallGraph</a> &#42;CG) &#123;</span></CodeLine>
<Link id="l00367" /><CodeLine lineNumber="367"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> Builder(End);</span></CodeLine>
<Link id="l00368" /><CodeLine lineNumber="368"></CodeLine>
<Link id="l00369" /><CodeLine lineNumber="369"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (Shape.<a href="/docs/api/structs/llvm/coro/shape/#a4e554c60419835fc3c74b91b28ca31c8">ABI</a>) &#123;</span></CodeLine>
<Link id="l00370" /><CodeLine lineNumber="370"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In switch-lowering, this does nothing in the main function.</span></CodeLine>
<Link id="l00371" /><CodeLine lineNumber="371"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">coro::ABI::Switch</a>: &#123;</span></CodeLine>
<Link id="l00372" /><CodeLine lineNumber="372"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// In C++&#39;s specification, the coroutine should be marked as done</span></CodeLine>
<Link id="l00373" /><CodeLine lineNumber="373"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// if promise.unhandled&#95;exception() throws.  The frontend will</span></CodeLine>
<Link id="l00374" /><CodeLine lineNumber="374"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// call coro.end(true) along this path.</span></CodeLine>
<Link id="l00375" /><CodeLine lineNumber="375"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00376" /><CodeLine lineNumber="376"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// FIXME: We should refactor this once there is other language</span></CodeLine>
<Link id="l00377" /><CodeLine lineNumber="377"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// which uses Switch-Resumed style other than C++.</span></CodeLine>
<Link id="l00378" /><CodeLine lineNumber="378"><span class="doxyHighlight">    <a href="#aa6734dd82cf736e89074802287b0abfe">markCoroutineAsDone</a>(Builder, Shape, <a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>);</span></CodeLine>
<Link id="l00379" /><CodeLine lineNumber="379"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!InResume)</span></CodeLine>
<Link id="l00380" /><CodeLine lineNumber="380"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00381" /><CodeLine lineNumber="381"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00382" /><CodeLine lineNumber="382"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00383" /><CodeLine lineNumber="383"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In async lowering this does nothing.</span></CodeLine>
<Link id="l00384" /><CodeLine lineNumber="384"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a24aa4117da86c41684ad25742832dfa6">coro::ABI::Async</a>:</span></CodeLine>
<Link id="l00385" /><CodeLine lineNumber="385"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00386" /><CodeLine lineNumber="386"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In continuation-lowering, this frees the continuation storage.</span></CodeLine>
<Link id="l00387" /><CodeLine lineNumber="387"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380aad9d7f07127e321d1358b695c8720166">coro::ABI::Retcon</a>:</span></CodeLine>
<Link id="l00388" /><CodeLine lineNumber="388"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a6ec6c15fe79ec2274d2c3e79ae4bcc41">coro::ABI::RetconOnce</a>:</span></CodeLine>
<Link id="l00389" /><CodeLine lineNumber="389"><span class="doxyHighlight">    <a href="#a3907189466613e437b0ea2731bf9b159">maybeFreeRetconStorage</a>(Builder, Shape, <a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>, CG);</span></CodeLine>
<Link id="l00390" /><CodeLine lineNumber="390"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00391" /><CodeLine lineNumber="391"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00392" /><CodeLine lineNumber="392"></CodeLine>
<Link id="l00393" /><CodeLine lineNumber="393"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If coro.end has an associated bundle, add cleanupret instruction.</span></CodeLine>
<Link id="l00394" /><CodeLine lineNumber="394"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Bundle = End-&gt;<a href="/docs/api/classes/llvm/callbase/#a23ab5f34fb7b9476d45da0102ecbfae6">getOperandBundle</a>(<a href="/docs/api/classes/llvm/llvmcontext/#a44d727ac5fccf852bfb2bae3e06adc9ca8997c6b0930e2c05209e95e7172c6cf3">LLVMContext::OB&#95;funclet</a>)) &#123;</span></CodeLine>
<Link id="l00395" /><CodeLine lineNumber="395"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;FromPad = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CleanupPadInst&gt;</a>(Bundle-&gt;Inputs&#91;0&#93;);</span></CodeLine>
<Link id="l00396" /><CodeLine lineNumber="396"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CleanupRet = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a5cff1b957d4c020c106da5126e6304d3">CreateCleanupRet</a>(FromPad, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00397" /><CodeLine lineNumber="397"><span class="doxyHighlight">    End-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>()-&gt;splitBasicBlock(End);</span></CodeLine>
<Link id="l00398" /><CodeLine lineNumber="398"><span class="doxyHighlight">    CleanupRet-&gt;getParent()-&gt;getTerminator()-&gt;eraseFromParent();</span></CodeLine>
<Link id="l00399" /><CodeLine lineNumber="399"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00400" /><CodeLine lineNumber="400"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00401" /><CodeLine lineNumber="401"></CodeLine>
<Link id="l00402" /><CodeLine lineNumber="402" lineLink="#ab289568caaa6647ee577a06e6e12499a"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#ab289568caaa6647ee577a06e6e12499a">replaceCoroEnd</a>(<a href="/docs/api/classes/llvm/anycoroendinst">AnyCoroEndInst</a> &#42;End, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;Shape,</span></CodeLine>
<Link id="l00403" /><CodeLine lineNumber="403"><span class="doxyHighlight">                           <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>, </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> InResume, <a href="/docs/api/classes/llvm/callgraph">CallGraph</a> &#42;CG) &#123;</span></CodeLine>
<Link id="l00404" /><CodeLine lineNumber="404"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (End-&gt;<a href="/docs/api/classes/llvm/anycoroendinst/#ad120b0fb98dfee5e50709ce853aa9327">isUnwind</a>())</span></CodeLine>
<Link id="l00405" /><CodeLine lineNumber="405"><span class="doxyHighlight">    <a href="#a9cb75e325aabbbb2e1fdf034b2f11491">replaceUnwindCoroEnd</a>(End, Shape, <a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>, InResume, CG);</span></CodeLine>
<Link id="l00406" /><CodeLine lineNumber="406"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00407" /><CodeLine lineNumber="407"><span class="doxyHighlight">    <a href="#a84fbc09723655416fad6677d7fdaf8a6">replaceFallthroughCoroEnd</a>(End, Shape, <a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>, InResume, CG);</span></CodeLine>
<Link id="l00408" /><CodeLine lineNumber="408"></CodeLine>
<Link id="l00409" /><CodeLine lineNumber="409"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;Context = End-&gt;<a href="/docs/api/classes/llvm/value/#ab3fc0225d8aaf8434026c3573f961f2c">getContext</a>();</span></CodeLine>
<Link id="l00410" /><CodeLine lineNumber="410"><span class="doxyHighlight">  End-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(InResume ? <a href="/docs/api/classes/llvm/constantint/#a82dbbd8e3688b0bc1eedb338864d0d0c">ConstantInt::getTrue</a>(Context)</span></CodeLine>
<Link id="l00411" /><CodeLine lineNumber="411"><span class="doxyHighlight">                                   : <a href="/docs/api/classes/llvm/constantint/#aa7cce62ac5cc6df09cce0535874336b7">ConstantInt::getFalse</a>(Context));</span></CodeLine>
<Link id="l00412" /><CodeLine lineNumber="412"><span class="doxyHighlight">  End-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</span></CodeLine>
<Link id="l00413" /><CodeLine lineNumber="413"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00414" /><CodeLine lineNumber="414"></CodeLine>
<Link id="l00415" /><CodeLine lineNumber="415"><span class="doxyHighlightComment">// In the resume function, we remove the last case  (when coro::Shape is built,</span></CodeLine>
<Link id="l00416" /><CodeLine lineNumber="416"><span class="doxyHighlightComment">// the final suspend point (if present) is always the last element of</span></CodeLine>
<Link id="l00417" /><CodeLine lineNumber="417"><span class="doxyHighlightComment">// CoroSuspends array) since it is an undefined behavior to resume a coroutine</span></CodeLine>
<Link id="l00418" /><CodeLine lineNumber="418"><span class="doxyHighlightComment">// suspended at the final suspend point.</span></CodeLine>
<Link id="l00419" /><CodeLine lineNumber="419"><span class="doxyHighlightComment">// In the destroy function, if it isn&#39;t possible that the ResumeFnAddr is NULL</span></CodeLine>
<Link id="l00420" /><CodeLine lineNumber="420"><span class="doxyHighlightComment">// and the coroutine doesn&#39;t suspend at the final suspend point actually (this</span></CodeLine>
<Link id="l00421" /><CodeLine lineNumber="421"><span class="doxyHighlightComment">// is possible since the coroutine is considered suspended at the final suspend</span></CodeLine>
<Link id="l00422" /><CodeLine lineNumber="422"><span class="doxyHighlightComment">// point if promise.unhandled&#95;exception() exits via an exception), we can</span></CodeLine>
<Link id="l00423" /><CodeLine lineNumber="423"><span class="doxyHighlightComment">// remove the last case.</span></CodeLine>
<Link id="l00424" /><CodeLine lineNumber="424" lineLink="/docs/api/classes/llvm/coro/basecloner/#a614a737e40ceece782633b5cabbeab49"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/coro/basecloner/#a614a737e40ceece782633b5cabbeab49">coro::BaseCloner::handleFinalSuspend</a>() &#123;</span></CodeLine>
<Link id="l00425" /><CodeLine lineNumber="425"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.ABI == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">coro::ABI::Switch</a> &amp;&amp;</span></CodeLine>
<Link id="l00426" /><CodeLine lineNumber="426"><span class="doxyHighlight">         <a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.SwitchLowering.HasFinalSuspend);</span></CodeLine>
<Link id="l00427" /><CodeLine lineNumber="427"></CodeLine>
<Link id="l00428" /><CodeLine lineNumber="428"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/coro/basecloner/#a9f899602a4006892760f56f26f0da449">isSwitchDestroyFunction</a>() &amp;&amp; <a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.SwitchLowering.HasUnwindCoroEnd)</span></CodeLine>
<Link id="l00429" /><CodeLine lineNumber="429"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00430" /><CodeLine lineNumber="430"></CodeLine>
<Link id="l00431" /><CodeLine lineNumber="431"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">Switch</a> = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;SwitchInst&gt;</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a817ca8bc950897f8f548f58d746d03d2">VMap</a>&#91;<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.SwitchLowering.ResumeSwitch&#93;);</span></CodeLine>
<Link id="l00432" /><CodeLine lineNumber="432"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> FinalCaseIt = std::prev(<a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">Switch</a>-&gt;case&#95;end());</span></CodeLine>
<Link id="l00433" /><CodeLine lineNumber="433"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ResumeBB = FinalCaseIt-&gt;getCaseSuccessor();</span></CodeLine>
<Link id="l00434" /><CodeLine lineNumber="434"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">Switch</a>-&gt;removeCase(FinalCaseIt);</span></CodeLine>
<Link id="l00435" /><CodeLine lineNumber="435"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/coro/basecloner/#a9f899602a4006892760f56f26f0da449">isSwitchDestroyFunction</a>()) &#123;</span></CodeLine>
<Link id="l00436" /><CodeLine lineNumber="436"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;OldSwitchBB = <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">Switch</a>-&gt;getParent();</span></CodeLine>
<Link id="l00437" /><CodeLine lineNumber="437"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewSwitchBB = OldSwitchBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a52c990590792c91dd20b6d45acebe359">splitBasicBlock</a>(<a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">Switch</a>, </span><span class="doxyHighlightStringLiteral">&quot;Switch&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00438" /><CodeLine lineNumber="438"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.SetInsertPoint(OldSwitchBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</span></CodeLine>
<Link id="l00439" /><CodeLine lineNumber="439"></CodeLine>
<Link id="l00440" /><CodeLine lineNumber="440"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;isCoroOnlyDestroyWhenComplete()) &#123;</span></CodeLine>
<Link id="l00441" /><CodeLine lineNumber="441"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// When the coroutine can only be destroyed when complete, we don&#39;t need</span></CodeLine>
<Link id="l00442" /><CodeLine lineNumber="442"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// to generate code for other cases.</span></CodeLine>
<Link id="l00443" /><CodeLine lineNumber="443"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.CreateBr(ResumeBB);</span></CodeLine>
<Link id="l00444" /><CodeLine lineNumber="444"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00445" /><CodeLine lineNumber="445"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;GepIndex = <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.CreateStructGEP(</span></CodeLine>
<Link id="l00446" /><CodeLine lineNumber="446"><span class="doxyHighlight">          <a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.FrameTy, <a href="/docs/api/classes/llvm/coro/basecloner/#a3c3567cc47523e331dfcadc14d09550b">NewFramePtr</a>, <a href="/docs/api/structs/llvm/coro/shape/switchfieldindex/#aef925686aca6c6970964fea2c25bf242a012dd1dc85c718e8159980fa4273d9e6">coro::Shape::SwitchFieldIndex::Resume</a>,</span></CodeLine>
<Link id="l00447" /><CodeLine lineNumber="447"><span class="doxyHighlight">          </span><span class="doxyHighlightStringLiteral">&quot;ResumeFn.addr&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00448" /><CodeLine lineNumber="448"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Load =</span></CodeLine>
<Link id="l00449" /><CodeLine lineNumber="449"><span class="doxyHighlight">          <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.CreateLoad(<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.getSwitchResumePointerType(), GepIndex);</span></CodeLine>
<Link id="l00450" /><CodeLine lineNumber="450"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a> = <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.CreateIsNull(Load);</span></CodeLine>
<Link id="l00451" /><CodeLine lineNumber="451"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.CreateCondBr(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, ResumeBB, NewSwitchBB);</span></CodeLine>
<Link id="l00452" /><CodeLine lineNumber="452"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00453" /><CodeLine lineNumber="453"><span class="doxyHighlight">    OldSwitchBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>()-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</span></CodeLine>
<Link id="l00454" /><CodeLine lineNumber="454"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00455" /><CodeLine lineNumber="455"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00456" /><CodeLine lineNumber="456"></CodeLine>
<Link id="l00457" /><CodeLine lineNumber="457"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/functiontype">FunctionType</a> &#42;</span></CodeLine>
<Link id="l00458" /><CodeLine lineNumber="458" lineLink="#a492e33f38ce495d0143f95092cfd0595"><span class="doxyHighlight"><a href="#a492e33f38ce495d0143f95092cfd0595">getFunctionTypeFromAsyncSuspend</a>(<a href="/docs/api/classes/llvm/anycorosuspendinst">AnyCoroSuspendInst</a> &#42;Suspend) &#123;</span></CodeLine>
<Link id="l00459" /><CodeLine lineNumber="459"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;AsyncSuspend = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CoroSuspendAsyncInst&gt;</a>(Suspend);</span></CodeLine>
<Link id="l00460" /><CodeLine lineNumber="460"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;StructTy = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;StructType&gt;</a>(AsyncSuspend-&gt;getType());</span></CodeLine>
<Link id="l00461" /><CodeLine lineNumber="461"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;Context = Suspend-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>()-&gt;getParent()-&gt;getContext();</span></CodeLine>
<Link id="l00462" /><CodeLine lineNumber="462"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;VoidTy = <a href="/docs/api/classes/llvm/type/#a6e20e76960d952de088354cbcd14c3ab">Type::getVoidTy</a>(Context);</span></CodeLine>
<Link id="l00463" /><CodeLine lineNumber="463"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/functiontype/#af8be7844c269f201ebcee1e15048c378">FunctionType::get</a>(VoidTy, StructTy-&gt;elements(), </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00464" /><CodeLine lineNumber="464"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00465" /><CodeLine lineNumber="465"></CodeLine>
<Link id="l00466" /><CodeLine lineNumber="466" lineLink="#a452dcc29fd5e19bda874218e10a8945c"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/function">Function</a> &#42;<a href="#a452dcc29fd5e19bda874218e10a8945c">createCloneDeclaration</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;OrigF, <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;Shape,</span></CodeLine>
<Link id="l00467" /><CodeLine lineNumber="467"><span class="doxyHighlight">                                        </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/twine">Twine</a> &amp;Suffix,</span></CodeLine>
<Link id="l00468" /><CodeLine lineNumber="468"><span class="doxyHighlight">                                        <a href="/docs/api/classes/llvm/module/#a7893161303eb07ae7864db6b3d004d9e">Module::iterator</a> InsertBefore,</span></CodeLine>
<Link id="l00469" /><CodeLine lineNumber="469"><span class="doxyHighlight">                                        <a href="/docs/api/classes/llvm/anycorosuspendinst">AnyCoroSuspendInst</a> &#42;ActiveSuspend) &#123;</span></CodeLine>
<Link id="l00470" /><CodeLine lineNumber="470"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/module">Module</a> &#42;M = OrigF.<a href="/docs/api/classes/llvm/globalvalue/#a739b30c811f1eece61b05320ddf44e5b">getParent</a>();</span></CodeLine>
<Link id="l00471" /><CodeLine lineNumber="471"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;FnTy = (Shape.<a href="/docs/api/structs/llvm/coro/shape/#a4e554c60419835fc3c74b91b28ca31c8">ABI</a> != <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a24aa4117da86c41684ad25742832dfa6">coro::ABI::Async</a>)</span></CodeLine>
<Link id="l00472" /><CodeLine lineNumber="472"><span class="doxyHighlight">                   ? Shape.<a href="/docs/api/structs/llvm/coro/shape/#a1a578073d9d2487a3806e8a51abb1b6e">getResumeFunctionType</a>()</span></CodeLine>
<Link id="l00473" /><CodeLine lineNumber="473"><span class="doxyHighlight">                   : <a href="#a492e33f38ce495d0143f95092cfd0595">getFunctionTypeFromAsyncSuspend</a>(ActiveSuspend);</span></CodeLine>
<Link id="l00474" /><CodeLine lineNumber="474"></CodeLine>
<Link id="l00475" /><CodeLine lineNumber="475"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;NewF =</span></CodeLine>
<Link id="l00476" /><CodeLine lineNumber="476"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/function/#a05d7aedbbdc0fd24e8bc27edfe9c603f">Function::Create</a>(FnTy, <a href="/docs/api/classes/llvm/globalvalue/#aedfa75f0c85c4aa85b257f066fbea57ca1511edd03e02d1f3dd277a3c6abf6ad5">GlobalValue::LinkageTypes::InternalLinkage</a>,</span></CodeLine>
<Link id="l00477" /><CodeLine lineNumber="477"><span class="doxyHighlight">                       OrigF.<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>() + Suffix);</span></CodeLine>
<Link id="l00478" /><CodeLine lineNumber="478"></CodeLine>
<Link id="l00479" /><CodeLine lineNumber="479"><span class="doxyHighlight">  M-&gt;getFunctionList().insert(InsertBefore, NewF);</span></CodeLine>
<Link id="l00480" /><CodeLine lineNumber="480"></CodeLine>
<Link id="l00481" /><CodeLine lineNumber="481"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> NewF;</span></CodeLine>
<Link id="l00482" /><CodeLine lineNumber="482"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00483" /><CodeLine lineNumber="483"></CodeLine>
<Link id="l00484" /><CodeLine lineNumber="484"><span class="doxyHighlightComment">/// Replace uses of the active llvm.coro.suspend.retcon/async call with the</span></CodeLine>
<Link id="l00485" /><CodeLine lineNumber="485"><span class="doxyHighlightComment">/// arguments to the continuation function.</span></CodeLine>
<Link id="l00486" /><CodeLine lineNumber="486"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00487" /><CodeLine lineNumber="487"><span class="doxyHighlightComment">/// This assumes that the builder has a meaningful insertion point.</span></CodeLine>
<Link id="l00488" /><CodeLine lineNumber="488" lineLink="/docs/api/classes/llvm/coro/basecloner/#accee5b18a5d340c2e2aa6ec426df1778"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/coro/basecloner/#accee5b18a5d340c2e2aa6ec426df1778">coro::BaseCloner::replaceRetconOrAsyncSuspendUses</a>() &#123;</span></CodeLine>
<Link id="l00489" /><CodeLine lineNumber="489"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.ABI == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380aad9d7f07127e321d1358b695c8720166">coro::ABI::Retcon</a> || <a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.ABI == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a6ec6c15fe79ec2274d2c3e79ae4bcc41">coro::ABI::RetconOnce</a> ||</span></CodeLine>
<Link id="l00490" /><CodeLine lineNumber="490"><span class="doxyHighlight">         <a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.ABI == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a24aa4117da86c41684ad25742832dfa6">coro::ABI::Async</a>);</span></CodeLine>
<Link id="l00491" /><CodeLine lineNumber="491"></CodeLine>
<Link id="l00492" /><CodeLine lineNumber="492"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> NewS = <a href="/docs/api/classes/llvm/coro/basecloner/#a817ca8bc950897f8f548f58d746d03d2">VMap</a>&#91;<a href="/docs/api/classes/llvm/coro/basecloner/#a1e5d0f79e5f4e6b854642ab34a378517">ActiveSuspend</a>&#93;;</span></CodeLine>
<Link id="l00493" /><CodeLine lineNumber="493"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NewS-&gt;use&#95;empty())</span></CodeLine>
<Link id="l00494" /><CodeLine lineNumber="494"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00495" /><CodeLine lineNumber="495"></CodeLine>
<Link id="l00496" /><CodeLine lineNumber="496"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Copy out all the continuation arguments after the buffer pointer into</span></CodeLine>
<Link id="l00497" /><CodeLine lineNumber="497"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// an easily-indexed data structure for convenience.</span></CodeLine>
<Link id="l00498" /><CodeLine lineNumber="498"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Value &#42;, 8&gt;</a> Args;</span></CodeLine>
<Link id="l00499" /><CodeLine lineNumber="499"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The async ABI includes all arguments -- including the first argument.</span></CodeLine>
<Link id="l00500" /><CodeLine lineNumber="500"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> IsAsyncABI = <a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.ABI == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a24aa4117da86c41684ad25742832dfa6">coro::ABI::Async</a>;</span></CodeLine>
<Link id="l00501" /><CodeLine lineNumber="501"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = IsAsyncABI ? <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;arg&#95;begin() : std::next(<a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;arg&#95;begin()),</span></CodeLine>
<Link id="l00502" /><CodeLine lineNumber="502"><span class="doxyHighlight">            E = <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;arg&#95;end();</span></CodeLine>
<Link id="l00503" /><CodeLine lineNumber="503"><span class="doxyHighlight">       <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> != E; ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)</span></CodeLine>
<Link id="l00504" /><CodeLine lineNumber="504"><span class="doxyHighlight">    Args.push&#95;back(&amp;&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</span></CodeLine>
<Link id="l00505" /><CodeLine lineNumber="505"></CodeLine>
<Link id="l00506" /><CodeLine lineNumber="506"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the suspend returns a single scalar value, we can just do a simple</span></CodeLine>
<Link id="l00507" /><CodeLine lineNumber="507"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// replacement.</span></CodeLine>
<Link id="l00508" /><CodeLine lineNumber="508"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;StructType&gt;</a>(NewS-&gt;getType())) &#123;</span></CodeLine>
<Link id="l00509" /><CodeLine lineNumber="509"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Args.size() == 1);</span></CodeLine>
<Link id="l00510" /><CodeLine lineNumber="510"><span class="doxyHighlight">    NewS-&gt;replaceAllUsesWith(Args.front());</span></CodeLine>
<Link id="l00511" /><CodeLine lineNumber="511"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00512" /><CodeLine lineNumber="512"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00513" /><CodeLine lineNumber="513"></CodeLine>
<Link id="l00514" /><CodeLine lineNumber="514"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Try to peephole extracts of an aggregate return.</span></CodeLine>
<Link id="l00515" /><CodeLine lineNumber="515"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/use">Use</a> &amp;U : <a href="/docs/api/namespaces/llvm/#a3d2cdc4a0db233678e7141c9d6ea3419">llvm::make&#95;early&#95;inc&#95;range</a>(NewS-&gt;uses())) &#123;</span></CodeLine>
<Link id="l00516" /><CodeLine lineNumber="516"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;EVI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ExtractValueInst&gt;</a>(U.getUser());</span></CodeLine>
<Link id="l00517" /><CodeLine lineNumber="517"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!EVI || EVI-&gt;getNumIndices() != 1)</span></CodeLine>
<Link id="l00518" /><CodeLine lineNumber="518"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00519" /><CodeLine lineNumber="519"></CodeLine>
<Link id="l00520" /><CodeLine lineNumber="520"><span class="doxyHighlight">    EVI-&gt;replaceAllUsesWith(Args&#91;EVI-&gt;getIndices().front()&#93;);</span></CodeLine>
<Link id="l00521" /><CodeLine lineNumber="521"><span class="doxyHighlight">    EVI-&gt;eraseFromParent();</span></CodeLine>
<Link id="l00522" /><CodeLine lineNumber="522"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00523" /><CodeLine lineNumber="523"></CodeLine>
<Link id="l00524" /><CodeLine lineNumber="524"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we have no remaining uses, we&#39;re done.</span></CodeLine>
<Link id="l00525" /><CodeLine lineNumber="525"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NewS-&gt;use&#95;empty())</span></CodeLine>
<Link id="l00526" /><CodeLine lineNumber="526"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00527" /><CodeLine lineNumber="527"></CodeLine>
<Link id="l00528" /><CodeLine lineNumber="528"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Otherwise, we need to create an aggregate.</span></CodeLine>
<Link id="l00529" /><CodeLine lineNumber="529"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;Aggr = <a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(NewS-&gt;getType());</span></CodeLine>
<Link id="l00530" /><CodeLine lineNumber="530"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#91;Idx, Arg&#93; : <a href="/docs/api/namespaces/llvm/#a206e2134ddd2312c3488d0632d98f554">llvm::enumerate</a>(Args))</span></CodeLine>
<Link id="l00531" /><CodeLine lineNumber="531"><span class="doxyHighlight">    Aggr = <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.CreateInsertValue(Aggr, Arg, Idx);</span></CodeLine>
<Link id="l00532" /><CodeLine lineNumber="532"></CodeLine>
<Link id="l00533" /><CodeLine lineNumber="533"><span class="doxyHighlight">  NewS-&gt;replaceAllUsesWith(Aggr);</span></CodeLine>
<Link id="l00534" /><CodeLine lineNumber="534"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00535" /><CodeLine lineNumber="535"></CodeLine>
<Link id="l00536" /><CodeLine lineNumber="536" lineLink="/docs/api/classes/llvm/coro/basecloner/#a297393e7eadf926c84fff5c68e7d6818"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/coro/basecloner/#a297393e7eadf926c84fff5c68e7d6818">coro::BaseCloner::replaceCoroSuspends</a>() &#123;</span></CodeLine>
<Link id="l00537" /><CodeLine lineNumber="537"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;SuspendResult;</span></CodeLine>
<Link id="l00538" /><CodeLine lineNumber="538"></CodeLine>
<Link id="l00539" /><CodeLine lineNumber="539"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.ABI) &#123;</span></CodeLine>
<Link id="l00540" /><CodeLine lineNumber="540"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In switch lowering, replace coro.suspend with the appropriate value</span></CodeLine>
<Link id="l00541" /><CodeLine lineNumber="541"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// for the type of function we&#39;re extracting.</span></CodeLine>
<Link id="l00542" /><CodeLine lineNumber="542"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Replacing coro.suspend with (0) will result in control flow proceeding to</span></CodeLine>
<Link id="l00543" /><CodeLine lineNumber="543"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// a resume label associated with a suspend point, replacing it with (1) will</span></CodeLine>
<Link id="l00544" /><CodeLine lineNumber="544"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// result in control flow proceeding to a cleanup label associated with this</span></CodeLine>
<Link id="l00545" /><CodeLine lineNumber="545"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// suspend point.</span></CodeLine>
<Link id="l00546" /><CodeLine lineNumber="546"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">coro::ABI::Switch</a>:</span></CodeLine>
<Link id="l00547" /><CodeLine lineNumber="547"><span class="doxyHighlight">    SuspendResult = <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.getInt8(<a href="/docs/api/classes/llvm/coro/basecloner/#a9f899602a4006892760f56f26f0da449">isSwitchDestroyFunction</a>() ? 1 : 0);</span></CodeLine>
<Link id="l00548" /><CodeLine lineNumber="548"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00549" /><CodeLine lineNumber="549"></CodeLine>
<Link id="l00550" /><CodeLine lineNumber="550"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In async lowering there are no uses of the result.</span></CodeLine>
<Link id="l00551" /><CodeLine lineNumber="551"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a24aa4117da86c41684ad25742832dfa6">coro::ABI::Async</a>:</span></CodeLine>
<Link id="l00552" /><CodeLine lineNumber="552"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00553" /><CodeLine lineNumber="553"></CodeLine>
<Link id="l00554" /><CodeLine lineNumber="554"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In returned-continuation lowering, the arguments from earlier</span></CodeLine>
<Link id="l00555" /><CodeLine lineNumber="555"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// continuations are theoretically arbitrary, and they should have been</span></CodeLine>
<Link id="l00556" /><CodeLine lineNumber="556"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// spilled.</span></CodeLine>
<Link id="l00557" /><CodeLine lineNumber="557"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a6ec6c15fe79ec2274d2c3e79ae4bcc41">coro::ABI::RetconOnce</a>:</span></CodeLine>
<Link id="l00558" /><CodeLine lineNumber="558"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380aad9d7f07127e321d1358b695c8720166">coro::ABI::Retcon</a>:</span></CodeLine>
<Link id="l00559" /><CodeLine lineNumber="559"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00560" /><CodeLine lineNumber="560"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00561" /><CodeLine lineNumber="561"></CodeLine>
<Link id="l00562" /><CodeLine lineNumber="562"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/anycorosuspendinst">AnyCoroSuspendInst</a> &#42;CS : <a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.CoroSuspends) &#123;</span></CodeLine>
<Link id="l00563" /><CodeLine lineNumber="563"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// The active suspend was handled earlier.</span></CodeLine>
<Link id="l00564" /><CodeLine lineNumber="564"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CS == <a href="/docs/api/classes/llvm/coro/basecloner/#a1e5d0f79e5f4e6b854642ab34a378517">ActiveSuspend</a>)</span></CodeLine>
<Link id="l00565" /><CodeLine lineNumber="565"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00566" /><CodeLine lineNumber="566"></CodeLine>
<Link id="l00567" /><CodeLine lineNumber="567"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;MappedCS = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;AnyCoroSuspendInst&gt;</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a817ca8bc950897f8f548f58d746d03d2">VMap</a>&#91;CS&#93;);</span></CodeLine>
<Link id="l00568" /><CodeLine lineNumber="568"><span class="doxyHighlight">    MappedCS-&gt;replaceAllUsesWith(SuspendResult);</span></CodeLine>
<Link id="l00569" /><CodeLine lineNumber="569"><span class="doxyHighlight">    MappedCS-&gt;eraseFromParent();</span></CodeLine>
<Link id="l00570" /><CodeLine lineNumber="570"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00571" /><CodeLine lineNumber="571"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00572" /><CodeLine lineNumber="572"></CodeLine>
<Link id="l00573" /><CodeLine lineNumber="573" lineLink="/docs/api/classes/llvm/coro/basecloner/#a7c1ae62749eee27ce4004984448899e0"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/coro/basecloner/#a7c1ae62749eee27ce4004984448899e0">coro::BaseCloner::replaceCoroEnds</a>() &#123;</span></CodeLine>
<Link id="l00574" /><CodeLine lineNumber="574"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/anycoroendinst">AnyCoroEndInst</a> &#42;CE : <a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.CoroEnds) &#123;</span></CodeLine>
<Link id="l00575" /><CodeLine lineNumber="575"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We use a null call graph because there&#39;s no call graph node for</span></CodeLine>
<Link id="l00576" /><CodeLine lineNumber="576"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// the cloned function yet.  We&#39;ll just be rebuilding that later.</span></CodeLine>
<Link id="l00577" /><CodeLine lineNumber="577"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewCE = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;AnyCoroEndInst&gt;</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a817ca8bc950897f8f548f58d746d03d2">VMap</a>&#91;CE&#93;);</span></CodeLine>
<Link id="l00578" /><CodeLine lineNumber="578"><span class="doxyHighlight">    <a href="#ab289568caaa6647ee577a06e6e12499a">replaceCoroEnd</a>(NewCE, <a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>, <a href="/docs/api/classes/llvm/coro/basecloner/#a3c3567cc47523e331dfcadc14d09550b">NewFramePtr</a>, </span><span class="doxyHighlightComment">/&#42;in resume&#42;/</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00579" /><CodeLine lineNumber="579"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00580" /><CodeLine lineNumber="580"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00581" /><CodeLine lineNumber="581"></CodeLine>
<Link id="l00582" /><CodeLine lineNumber="582" lineLink="#a236935b2df66a03a0a54350a6b9b84bc"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#a236935b2df66a03a0a54350a6b9b84bc">replaceSwiftErrorOps</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;Shape,</span></CodeLine>
<Link id="l00583" /><CodeLine lineNumber="583"><span class="doxyHighlight">                                 <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &#42;VMap) &#123;</span></CodeLine>
<Link id="l00584" /><CodeLine lineNumber="584"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Shape.<a href="/docs/api/structs/llvm/coro/shape/#a4e554c60419835fc3c74b91b28ca31c8">ABI</a> == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a24aa4117da86c41684ad25742832dfa6">coro::ABI::Async</a> &amp;&amp; Shape.<a href="/docs/api/structs/llvm/coro/shape/#a5fd0aa934908c837c6d78097a2fd667b">CoroSuspends</a>.empty())</span></CodeLine>
<Link id="l00585" /><CodeLine lineNumber="585"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00586" /><CodeLine lineNumber="586"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;CachedSlot = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00587" /><CodeLine lineNumber="587"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> getSwiftErrorSlot = &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/type">Type</a> &#42;ValueTy) -&gt; <a href="/docs/api/classes/llvm/value">Value</a> &#42; &#123;</span></CodeLine>
<Link id="l00588" /><CodeLine lineNumber="588"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CachedSlot)</span></CodeLine>
<Link id="l00589" /><CodeLine lineNumber="589"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> CachedSlot;</span></CodeLine>
<Link id="l00590" /><CodeLine lineNumber="590"></CodeLine>
<Link id="l00591" /><CodeLine lineNumber="591"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Check if the function has a swifterror argument.</span></CodeLine>
<Link id="l00592" /><CodeLine lineNumber="592"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;Arg : <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.args()) &#123;</span></CodeLine>
<Link id="l00593" /><CodeLine lineNumber="593"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Arg.isSwiftError()) &#123;</span></CodeLine>
<Link id="l00594" /><CodeLine lineNumber="594"><span class="doxyHighlight">        CachedSlot = &amp;Arg;</span></CodeLine>
<Link id="l00595" /><CodeLine lineNumber="595"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &amp;Arg;</span></CodeLine>
<Link id="l00596" /><CodeLine lineNumber="596"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00597" /><CodeLine lineNumber="597"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00598" /><CodeLine lineNumber="598"></CodeLine>
<Link id="l00599" /><CodeLine lineNumber="599"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Create a swifterror alloca.</span></CodeLine>
<Link id="l00600" /><CodeLine lineNumber="600"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> Builder(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getEntryBlock(),</span></CodeLine>
<Link id="l00601" /><CodeLine lineNumber="601"><span class="doxyHighlight">                        <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getEntryBlock().getFirstNonPHIOrDbg());</span></CodeLine>
<Link id="l00602" /><CodeLine lineNumber="602"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Alloca = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a1b30cd686a320a8e5cb4532fd3a552a8">CreateAlloca</a>(ValueTy);</span></CodeLine>
<Link id="l00603" /><CodeLine lineNumber="603"><span class="doxyHighlight">    Alloca-&gt;<a href="/docs/api/classes/llvm/allocainst/#a31eeebeefd320f6a2db4a867f568bee3">setSwiftError</a>(</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00604" /><CodeLine lineNumber="604"></CodeLine>
<Link id="l00605" /><CodeLine lineNumber="605"><span class="doxyHighlight">    CachedSlot = Alloca;</span></CodeLine>
<Link id="l00606" /><CodeLine lineNumber="606"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Alloca;</span></CodeLine>
<Link id="l00607" /><CodeLine lineNumber="607"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l00608" /><CodeLine lineNumber="608"></CodeLine>
<Link id="l00609" /><CodeLine lineNumber="609"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42;<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a> : Shape.<a href="/docs/api/structs/llvm/coro/shape/#ae290085a52a8df4810b4e7f48dbe1ac5">SwiftErrorOps</a>) &#123;</span></CodeLine>
<Link id="l00610" /><CodeLine lineNumber="610"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> MappedOp = VMap ? <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CallInst&gt;</a>((&#42;VMap)&#91;<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>&#93;) : <a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>;</span></CodeLine>
<Link id="l00611" /><CodeLine lineNumber="611"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> Builder(MappedOp);</span></CodeLine>
<Link id="l00612" /><CodeLine lineNumber="612"></CodeLine>
<Link id="l00613" /><CodeLine lineNumber="613"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If there are no arguments, this is a &#39;get&#39; operation.</span></CodeLine>
<Link id="l00614" /><CodeLine lineNumber="614"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;MappedResult;</span></CodeLine>
<Link id="l00615" /><CodeLine lineNumber="615"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>-&gt;arg&#95;empty()) &#123;</span></CodeLine>
<Link id="l00616" /><CodeLine lineNumber="616"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> ValueTy = <a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>-&gt;getType();</span></CodeLine>
<Link id="l00617" /><CodeLine lineNumber="617"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Slot = getSwiftErrorSlot(ValueTy);</span></CodeLine>
<Link id="l00618" /><CodeLine lineNumber="618"><span class="doxyHighlight">      MappedResult = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a9b01712e5f196d6d3d021ef23aad50e4">CreateLoad</a>(ValueTy, Slot);</span></CodeLine>
<Link id="l00619" /><CodeLine lineNumber="619"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00620" /><CodeLine lineNumber="620"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>-&gt;arg&#95;size() == 1);</span></CodeLine>
<Link id="l00621" /><CodeLine lineNumber="621"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/value">Value</a> = MappedOp-&gt;getArgOperand(0);</span></CodeLine>
<Link id="l00622" /><CodeLine lineNumber="622"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> ValueTy = <a href="/docs/api/classes/llvm/value">Value</a>-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>();</span></CodeLine>
<Link id="l00623" /><CodeLine lineNumber="623"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Slot = getSwiftErrorSlot(ValueTy);</span></CodeLine>
<Link id="l00624" /><CodeLine lineNumber="624"><span class="doxyHighlight">      Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aabfc20af4dcf7d94262824dcac2e7bed">CreateStore</a>(<a href="/docs/api/classes/llvm/value">Value</a>, Slot);</span></CodeLine>
<Link id="l00625" /><CodeLine lineNumber="625"><span class="doxyHighlight">      MappedResult = Slot;</span></CodeLine>
<Link id="l00626" /><CodeLine lineNumber="626"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00627" /><CodeLine lineNumber="627"></CodeLine>
<Link id="l00628" /><CodeLine lineNumber="628"><span class="doxyHighlight">    MappedOp-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(MappedResult);</span></CodeLine>
<Link id="l00629" /><CodeLine lineNumber="629"><span class="doxyHighlight">    MappedOp-&gt;eraseFromParent();</span></CodeLine>
<Link id="l00630" /><CodeLine lineNumber="630"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00631" /><CodeLine lineNumber="631"></CodeLine>
<Link id="l00632" /><CodeLine lineNumber="632"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we&#39;re updating the original function, we&#39;ve invalidated SwiftErrorOps.</span></CodeLine>
<Link id="l00633" /><CodeLine lineNumber="633"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (VMap == </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">) &#123;</span></CodeLine>
<Link id="l00634" /><CodeLine lineNumber="634"><span class="doxyHighlight">    Shape.<a href="/docs/api/structs/llvm/coro/shape/#ae290085a52a8df4810b4e7f48dbe1ac5">SwiftErrorOps</a>.clear();</span></CodeLine>
<Link id="l00635" /><CodeLine lineNumber="635"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00636" /><CodeLine lineNumber="636"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00637" /><CodeLine lineNumber="637"></CodeLine>
<Link id="l00638" /><CodeLine lineNumber="638"><span class="doxyHighlightComment">/// Returns all DbgVariableIntrinsic in F.</span></CodeLine>
<Link id="l00639" /><CodeLine lineNumber="639"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> std::pair&lt;SmallVector&lt;DbgVariableIntrinsic &#42;, 8&gt;,</span></CodeLine>
<Link id="l00640" /><CodeLine lineNumber="640"><span class="doxyHighlight">                 SmallVector&lt;DbgVariableRecord &#42;&gt;&gt;</span></CodeLine>
<Link id="l00641" /><CodeLine lineNumber="641" lineLink="#a13dafea5ca0652a4011dd613a8f02494"><span class="doxyHighlight"><a href="#a13dafea5ca0652a4011dd613a8f02494">collectDbgVariableIntrinsics</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l00642" /><CodeLine lineNumber="642"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;DbgVariableIntrinsic &#42;, 8&gt;</a> Intrinsics;</span></CodeLine>
<Link id="l00643" /><CodeLine lineNumber="643"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;DbgVariableRecord &#42;&gt;</a> DbgVariableRecords;</span></CodeLine>
<Link id="l00644" /><CodeLine lineNumber="644"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : <a href="/docs/api/files/lib/lib/codegen/atomicexpandpass-cpp/#a1bcc06b1cb86bd0ea08f33323190bdaa">instructions</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>)) &#123;</span></CodeLine>
<Link id="l00645" /><CodeLine lineNumber="645"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/dbgvariablerecord">DbgVariableRecord</a> &amp;DVR : <a href="/docs/api/namespaces/llvm/#ae876eb96b89c1afcc3e9cd285cc3f08c">filterDbgVars</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getDbgRecordRange()))</span></CodeLine>
<Link id="l00646" /><CodeLine lineNumber="646"><span class="doxyHighlight">      DbgVariableRecords.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&amp;DVR);</span></CodeLine>
<Link id="l00647" /><CodeLine lineNumber="647"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;DVI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;DbgVariableIntrinsic&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</span></CodeLine>
<Link id="l00648" /><CodeLine lineNumber="648"><span class="doxyHighlight">      Intrinsics.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(DVI);</span></CodeLine>
<Link id="l00649" /><CodeLine lineNumber="649"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00650" /><CodeLine lineNumber="650"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &#123;Intrinsics, DbgVariableRecords&#125;;</span></CodeLine>
<Link id="l00651" /><CodeLine lineNumber="651"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00652" /><CodeLine lineNumber="652"></CodeLine>
<Link id="l00653" /><CodeLine lineNumber="653" lineLink="/docs/api/classes/llvm/coro/basecloner/#a0ec280addacac6912b1860f98ac682d9"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/coro/basecloner/#a0ec280addacac6912b1860f98ac682d9">coro::BaseCloner::replaceSwiftErrorOps</a>() &#123;</span></CodeLine>
<Link id="l00654" /><CodeLine lineNumber="654"><span class="doxyHighlight">  <a href="#a236935b2df66a03a0a54350a6b9b84bc">::replaceSwiftErrorOps</a>(&#42;<a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>, <a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>, &amp;<a href="/docs/api/classes/llvm/coro/basecloner/#a817ca8bc950897f8f548f58d746d03d2">VMap</a>);</span></CodeLine>
<Link id="l00655" /><CodeLine lineNumber="655"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00656" /><CodeLine lineNumber="656"></CodeLine>
<Link id="l00657" /><CodeLine lineNumber="657" lineLink="/docs/api/classes/llvm/coro/basecloner/#a1d6e16608b64f29f9a4d1483507317b5"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/coro/basecloner/#a1d6e16608b64f29f9a4d1483507317b5">coro::BaseCloner::salvageDebugInfo</a>() &#123;</span></CodeLine>
<Link id="l00658" /><CodeLine lineNumber="658"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#91;Worklist, DbgVariableRecords&#93; = <a href="#a13dafea5ca0652a4011dd613a8f02494">collectDbgVariableIntrinsics</a>(&#42;<a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>);</span></CodeLine>
<Link id="l00659" /><CodeLine lineNumber="659"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;Argument &#42;, AllocaInst &#42;, 4&gt;</a> ArgToAllocaMap;</span></CodeLine>
<Link id="l00660" /><CodeLine lineNumber="660"></CodeLine>
<Link id="l00661" /><CodeLine lineNumber="661"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Only 64-bit ABIs have a register we can refer to with the entry value.</span></CodeLine>
<Link id="l00662" /><CodeLine lineNumber="662"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> UseEntryValue =</span></CodeLine>
<Link id="l00663" /><CodeLine lineNumber="663"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/triple">llvm::Triple</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a567c0d086b740b39c9bfd703e0cf2908">OrigF</a>.getParent()-&gt;getTargetTriple()).<a href="/docs/api/classes/llvm/triple/#a9e0d7431e635bbbf753602d214d89f0e">isArch64Bit</a>();</span></CodeLine>
<Link id="l00664" /><CodeLine lineNumber="664"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/dbgvariableintrinsic">DbgVariableIntrinsic</a> &#42;DVI : Worklist)</span></CodeLine>
<Link id="l00665" /><CodeLine lineNumber="665"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/coro/#a14553297713bc2c6012758ee13a2b917">coro::salvageDebugInfo</a>(ArgToAllocaMap, &#42;DVI, UseEntryValue);</span></CodeLine>
<Link id="l00666" /><CodeLine lineNumber="666"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/dbgvariablerecord">DbgVariableRecord</a> &#42;DVR : DbgVariableRecords)</span></CodeLine>
<Link id="l00667" /><CodeLine lineNumber="667"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/coro/#a14553297713bc2c6012758ee13a2b917">coro::salvageDebugInfo</a>(ArgToAllocaMap, &#42;DVR, UseEntryValue);</span></CodeLine>
<Link id="l00668" /><CodeLine lineNumber="668"></CodeLine>
<Link id="l00669" /><CodeLine lineNumber="669"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Remove all salvaged dbg.declare intrinsics that became</span></CodeLine>
<Link id="l00670" /><CodeLine lineNumber="670"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// either unreachable or stale due to the CoroSplit transformation.</span></CodeLine>
<Link id="l00671" /><CodeLine lineNumber="671"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> DomTree(&#42;<a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>);</span></CodeLine>
<Link id="l00672" /><CodeLine lineNumber="672"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> IsUnreachableBlock = &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB) &#123;</span></CodeLine>
<Link id="l00673" /><CodeLine lineNumber="673"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> !<a href="/docs/api/namespaces/llvm/#affedc93ead6b25c57a7196d32ff11e89">isPotentiallyReachable</a>(&amp;<a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;getEntryBlock(), BB, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00674" /><CodeLine lineNumber="674"><span class="doxyHighlight">                                   &amp;DomTree);</span></CodeLine>
<Link id="l00675" /><CodeLine lineNumber="675"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l00676" /><CodeLine lineNumber="676"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> RemoveOne = &#91;&amp;&#93;(</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;DVI) &#123;</span></CodeLine>
<Link id="l00677" /><CodeLine lineNumber="677"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IsUnreachableBlock(DVI-&gt;getParent()))</span></CodeLine>
<Link id="l00678" /><CodeLine lineNumber="678"><span class="doxyHighlight">      DVI-&gt;eraseFromParent();</span></CodeLine>
<Link id="l00679" /><CodeLine lineNumber="679"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a4956305191cdba7f9995569d011a5ab7">isa&#95;and&#95;nonnull&lt;AllocaInst&gt;</a>(DVI-&gt;getVariableLocationOp(0))) &#123;</span></CodeLine>
<Link id="l00680" /><CodeLine lineNumber="680"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Count all non-debuginfo uses in reachable blocks.</span></CodeLine>
<Link id="l00681" /><CodeLine lineNumber="681"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/codegen/removeloadsintofakeuses-cpp/#a0b427ca665b192edbeb8d6ca3c8f19fd">Uses</a> = 0;</span></CodeLine>
<Link id="l00682" /><CodeLine lineNumber="682"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/classes/llvm/user">User</a> : DVI-&gt;getVariableLocationOp(0)-&gt;<a href="/docs/api/classes/llvm/value/#a411cf3e3932f209ce3374cb31adc1da6">users</a>())</span></CodeLine>
<Link id="l00683" /><CodeLine lineNumber="683"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(<a href="/docs/api/classes/llvm/user">User</a>))</span></CodeLine>
<Link id="l00684" /><CodeLine lineNumber="684"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;AllocaInst&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &amp;&amp; !IsUnreachableBlock(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getParent()))</span></CodeLine>
<Link id="l00685" /><CodeLine lineNumber="685"><span class="doxyHighlight">            ++<a href="/docs/api/files/lib/lib/codegen/removeloadsintofakeuses-cpp/#a0b427ca665b192edbeb8d6ca3c8f19fd">Uses</a>;</span></CodeLine>
<Link id="l00686" /><CodeLine lineNumber="686"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/codegen/removeloadsintofakeuses-cpp/#a0b427ca665b192edbeb8d6ca3c8f19fd">Uses</a>)</span></CodeLine>
<Link id="l00687" /><CodeLine lineNumber="687"><span class="doxyHighlight">        DVI-&gt;eraseFromParent();</span></CodeLine>
<Link id="l00688" /><CodeLine lineNumber="688"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00689" /><CodeLine lineNumber="689"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l00690" /><CodeLine lineNumber="690"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a0b2a153b655ed78a07468297eb4c6256">for&#95;each</a>(Worklist, RemoveOne);</span></CodeLine>
<Link id="l00691" /><CodeLine lineNumber="691"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a0b2a153b655ed78a07468297eb4c6256">for&#95;each</a>(DbgVariableRecords, RemoveOne);</span></CodeLine>
<Link id="l00692" /><CodeLine lineNumber="692"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00693" /><CodeLine lineNumber="693"></CodeLine>
<Link id="l00694" /><CodeLine lineNumber="694" lineLink="/docs/api/classes/llvm/coro/basecloner/#a275ed8c2ebcd61ba635dbf7c119e7ed2"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/coro/basecloner/#a275ed8c2ebcd61ba635dbf7c119e7ed2">coro::BaseCloner::replaceEntryBlock</a>() &#123;</span></CodeLine>
<Link id="l00695" /><CodeLine lineNumber="695"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In the original function, the AllocaSpillBlock is a block immediately</span></CodeLine>
<Link id="l00696" /><CodeLine lineNumber="696"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// following the allocation of the frame object which defines GEPs for</span></CodeLine>
<Link id="l00697" /><CodeLine lineNumber="697"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// all the allocas that have been moved into the frame, and it ends by</span></CodeLine>
<Link id="l00698" /><CodeLine lineNumber="698"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// branching to the original beginning of the coroutine.  Make this</span></CodeLine>
<Link id="l00699" /><CodeLine lineNumber="699"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the entry block of the cloned function.</span></CodeLine>
<Link id="l00700" /><CodeLine lineNumber="700"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Entry = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a817ca8bc950897f8f548f58d746d03d2">VMap</a>&#91;<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.AllocaSpillBlock&#93;);</span></CodeLine>
<Link id="l00701" /><CodeLine lineNumber="701"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;OldEntry = &amp;<a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;getEntryBlock();</span></CodeLine>
<Link id="l00702" /><CodeLine lineNumber="702"><span class="doxyHighlight">  Entry-&gt;setName(</span><span class="doxyHighlightStringLiteral">&quot;entry&quot;</span><span class="doxyHighlight"> + <a href="/docs/api/classes/llvm/coro/basecloner/#aa8abf978b13ebdb39f3fa271d7c49bf5">Suffix</a>);</span></CodeLine>
<Link id="l00703" /><CodeLine lineNumber="703"><span class="doxyHighlight">  Entry-&gt;moveBefore(OldEntry);</span></CodeLine>
<Link id="l00704" /><CodeLine lineNumber="704"><span class="doxyHighlight">  Entry-&gt;getTerminator()-&gt;eraseFromParent();</span></CodeLine>
<Link id="l00705" /><CodeLine lineNumber="705"></CodeLine>
<Link id="l00706" /><CodeLine lineNumber="706"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Clear all predecessors of the new entry block.  There should be</span></CodeLine>
<Link id="l00707" /><CodeLine lineNumber="707"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// exactly one predecessor, which we created when splitting out</span></CodeLine>
<Link id="l00708" /><CodeLine lineNumber="708"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// AllocaSpillBlock to begin with.</span></CodeLine>
<Link id="l00709" /><CodeLine lineNumber="709"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Entry-&gt;hasOneUse());</span></CodeLine>
<Link id="l00710" /><CodeLine lineNumber="710"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> BranchToEntry = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BranchInst&gt;</a>(Entry-&gt;user&#95;back());</span></CodeLine>
<Link id="l00711" /><CodeLine lineNumber="711"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BranchToEntry-&gt;isUnconditional());</span></CodeLine>
<Link id="l00712" /><CodeLine lineNumber="712"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.SetInsertPoint(BranchToEntry);</span></CodeLine>
<Link id="l00713" /><CodeLine lineNumber="713"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.CreateUnreachable();</span></CodeLine>
<Link id="l00714" /><CodeLine lineNumber="714"><span class="doxyHighlight">  BranchToEntry-&gt;eraseFromParent();</span></CodeLine>
<Link id="l00715" /><CodeLine lineNumber="715"></CodeLine>
<Link id="l00716" /><CodeLine lineNumber="716"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Branch from the entry to the appropriate place.</span></CodeLine>
<Link id="l00717" /><CodeLine lineNumber="717"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.SetInsertPoint(Entry);</span></CodeLine>
<Link id="l00718" /><CodeLine lineNumber="718"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.ABI) &#123;</span></CodeLine>
<Link id="l00719" /><CodeLine lineNumber="719"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">coro::ABI::Switch</a>: &#123;</span></CodeLine>
<Link id="l00720" /><CodeLine lineNumber="720"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// In switch-lowering, we built a resume-entry block in the original</span></CodeLine>
<Link id="l00721" /><CodeLine lineNumber="721"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// function.  Make the entry block branch to this.</span></CodeLine>
<Link id="l00722" /><CodeLine lineNumber="722"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;SwitchBB =</span></CodeLine>
<Link id="l00723" /><CodeLine lineNumber="723"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a817ca8bc950897f8f548f58d746d03d2">VMap</a>&#91;<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.SwitchLowering.ResumeEntryBlock&#93;);</span></CodeLine>
<Link id="l00724" /><CodeLine lineNumber="724"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.CreateBr(SwitchBB);</span></CodeLine>
<Link id="l00725" /><CodeLine lineNumber="725"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00726" /><CodeLine lineNumber="726"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00727" /><CodeLine lineNumber="727"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a24aa4117da86c41684ad25742832dfa6">coro::ABI::Async</a>:</span></CodeLine>
<Link id="l00728" /><CodeLine lineNumber="728"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380aad9d7f07127e321d1358b695c8720166">coro::ABI::Retcon</a>:</span></CodeLine>
<Link id="l00729" /><CodeLine lineNumber="729"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a6ec6c15fe79ec2274d2c3e79ae4bcc41">coro::ABI::RetconOnce</a>: &#123;</span></CodeLine>
<Link id="l00730" /><CodeLine lineNumber="730"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// In continuation ABIs, we want to branch to immediately after the</span></CodeLine>
<Link id="l00731" /><CodeLine lineNumber="731"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// active suspend point.  Earlier phases will have put the suspend in its</span></CodeLine>
<Link id="l00732" /><CodeLine lineNumber="732"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// own basic block, so just thread our jump directly to its successor.</span></CodeLine>
<Link id="l00733" /><CodeLine lineNumber="733"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.ABI == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a24aa4117da86c41684ad25742832dfa6">coro::ABI::Async</a> &amp;&amp;</span></CodeLine>
<Link id="l00734" /><CodeLine lineNumber="734"><span class="doxyHighlight">            <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;CoroSuspendAsyncInst&gt;</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a1e5d0f79e5f4e6b854642ab34a378517">ActiveSuspend</a>)) ||</span></CodeLine>
<Link id="l00735" /><CodeLine lineNumber="735"><span class="doxyHighlight">           ((<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.ABI == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380aad9d7f07127e321d1358b695c8720166">coro::ABI::Retcon</a> ||</span></CodeLine>
<Link id="l00736" /><CodeLine lineNumber="736"><span class="doxyHighlight">             <a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.ABI == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a6ec6c15fe79ec2274d2c3e79ae4bcc41">coro::ABI::RetconOnce</a>) &amp;&amp;</span></CodeLine>
<Link id="l00737" /><CodeLine lineNumber="737"><span class="doxyHighlight">            <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;CoroSuspendRetconInst&gt;</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a1e5d0f79e5f4e6b854642ab34a378517">ActiveSuspend</a>)));</span></CodeLine>
<Link id="l00738" /><CodeLine lineNumber="738"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;MappedCS = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;AnyCoroSuspendInst&gt;</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a817ca8bc950897f8f548f58d746d03d2">VMap</a>&#91;<a href="/docs/api/classes/llvm/coro/basecloner/#a1e5d0f79e5f4e6b854642ab34a378517">ActiveSuspend</a>&#93;);</span></CodeLine>
<Link id="l00739" /><CodeLine lineNumber="739"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Branch = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BranchInst&gt;</a>(MappedCS-&gt;getNextNode());</span></CodeLine>
<Link id="l00740" /><CodeLine lineNumber="740"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Branch-&gt;isUnconditional());</span></CodeLine>
<Link id="l00741" /><CodeLine lineNumber="741"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.CreateBr(Branch-&gt;getSuccessor(0));</span></CodeLine>
<Link id="l00742" /><CodeLine lineNumber="742"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00743" /><CodeLine lineNumber="743"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00744" /><CodeLine lineNumber="744"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00745" /><CodeLine lineNumber="745"></CodeLine>
<Link id="l00746" /><CodeLine lineNumber="746"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Any static alloca that&#39;s still being used but not reachable from the new</span></CodeLine>
<Link id="l00747" /><CodeLine lineNumber="747"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// entry needs to be moved to the new entry.</span></CodeLine>
<Link id="l00748" /><CodeLine lineNumber="748"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = OldEntry-&gt;getParent();</span></CodeLine>
<Link id="l00749" /><CodeLine lineNumber="749"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> DT&#123;&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>&#125;;</span></CodeLine>
<Link id="l00750" /><CodeLine lineNumber="750"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : <a href="/docs/api/namespaces/llvm/#a3d2cdc4a0db233678e7141c9d6ea3419">llvm::make&#95;early&#95;inc&#95;range</a>(<a href="/docs/api/files/lib/lib/codegen/atomicexpandpass-cpp/#a1bcc06b1cb86bd0ea08f33323190bdaa">instructions</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>))) &#123;</span></CodeLine>
<Link id="l00751" /><CodeLine lineNumber="751"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Alloca = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;AllocaInst&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</span></CodeLine>
<Link id="l00752" /><CodeLine lineNumber="752"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Alloca || <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.use&#95;empty())</span></CodeLine>
<Link id="l00753" /><CodeLine lineNumber="753"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00754" /><CodeLine lineNumber="754"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (DT.<a href="/docs/api/classes/llvm/dominatortree/#a1a70f2c359aadd76a72aaaede16aca4a">isReachableFromEntry</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getParent()) ||</span></CodeLine>
<Link id="l00755" /><CodeLine lineNumber="755"><span class="doxyHighlight">        !<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;ConstantInt&gt;</a>(Alloca-&gt;getArraySize()))</span></CodeLine>
<Link id="l00756" /><CodeLine lineNumber="756"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00757" /><CodeLine lineNumber="757"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.moveBefore(&#42;Entry, Entry-&gt;getFirstInsertionPt());</span></CodeLine>
<Link id="l00758" /><CodeLine lineNumber="758"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00759" /><CodeLine lineNumber="759"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00760" /><CodeLine lineNumber="760"></CodeLine>
<Link id="l00761" /><CodeLine lineNumber="761"><span class="doxyHighlightComment">/// Derive the value of the new frame pointer.</span></CodeLine>
<Link id="l00762" /><CodeLine lineNumber="762" lineLink="/docs/api/classes/llvm/coro/basecloner/#a2039a88cc5cd331c4012e856dde33eed"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/classes/llvm/coro/basecloner/#a2039a88cc5cd331c4012e856dde33eed">coro::BaseCloner::deriveNewFramePointer</a>() &#123;</span></CodeLine>
<Link id="l00763" /><CodeLine lineNumber="763"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Builder should be inserting to the front of the new entry block.</span></CodeLine>
<Link id="l00764" /><CodeLine lineNumber="764"></CodeLine>
<Link id="l00765" /><CodeLine lineNumber="765"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.ABI) &#123;</span></CodeLine>
<Link id="l00766" /><CodeLine lineNumber="766"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In switch-lowering, the argument is the frame pointer.</span></CodeLine>
<Link id="l00767" /><CodeLine lineNumber="767"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">coro::ABI::Switch</a>:</span></CodeLine>
<Link id="l00768" /><CodeLine lineNumber="768"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &amp;&#42;<a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;arg&#95;begin();</span></CodeLine>
<Link id="l00769" /><CodeLine lineNumber="769"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In async-lowering, one of the arguments is an async context as determined</span></CodeLine>
<Link id="l00770" /><CodeLine lineNumber="770"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// by the &#96;llvm.coro.id.async&#96; intrinsic. We can retrieve the async context of</span></CodeLine>
<Link id="l00771" /><CodeLine lineNumber="771"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the resume function from the async context projection function associated</span></CodeLine>
<Link id="l00772" /><CodeLine lineNumber="772"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// with the active suspend. The frame is located as a tail to the async</span></CodeLine>
<Link id="l00773" /><CodeLine lineNumber="773"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// context header.</span></CodeLine>
<Link id="l00774" /><CodeLine lineNumber="774"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a24aa4117da86c41684ad25742832dfa6">coro::ABI::Async</a>: &#123;</span></CodeLine>
<Link id="l00775" /><CodeLine lineNumber="775"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;ActiveAsyncSuspend = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CoroSuspendAsyncInst&gt;</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a1e5d0f79e5f4e6b854642ab34a378517">ActiveSuspend</a>);</span></CodeLine>
<Link id="l00776" /><CodeLine lineNumber="776"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> ContextIdx = ActiveAsyncSuspend-&gt;getStorageArgumentIndex() &amp; 0xff;</span></CodeLine>
<Link id="l00777" /><CodeLine lineNumber="777"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CalleeContext = <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;getArg(ContextIdx);</span></CodeLine>
<Link id="l00778" /><CodeLine lineNumber="778"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;ProjectionFunc =</span></CodeLine>
<Link id="l00779" /><CodeLine lineNumber="779"><span class="doxyHighlight">        ActiveAsyncSuspend-&gt;getAsyncContextProjectionFunction();</span></CodeLine>
<Link id="l00780" /><CodeLine lineNumber="780"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> DbgLoc =</span></CodeLine>
<Link id="l00781" /><CodeLine lineNumber="781"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CoroSuspendAsyncInst&gt;</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a817ca8bc950897f8f548f58d746d03d2">VMap</a>&#91;<a href="/docs/api/classes/llvm/coro/basecloner/#a1e5d0f79e5f4e6b854642ab34a378517">ActiveSuspend</a>&#93;)-&gt;getDebugLoc();</span></CodeLine>
<Link id="l00782" /><CodeLine lineNumber="782"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Calling i8&#42; (i8&#42;)</span></CodeLine>
<Link id="l00783" /><CodeLine lineNumber="783"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CallerContext = <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.CreateCall(ProjectionFunc-&gt;getFunctionType(),</span></CodeLine>
<Link id="l00784" /><CodeLine lineNumber="784"><span class="doxyHighlight">                                             ProjectionFunc, CalleeContext);</span></CodeLine>
<Link id="l00785" /><CodeLine lineNumber="785"><span class="doxyHighlight">    CallerContext-&gt;setCallingConv(ProjectionFunc-&gt;getCallingConv());</span></CodeLine>
<Link id="l00786" /><CodeLine lineNumber="786"><span class="doxyHighlight">    CallerContext-&gt;setDebugLoc(DbgLoc);</span></CodeLine>
<Link id="l00787" /><CodeLine lineNumber="787"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// The frame is located after the async&#95;context header.</span></CodeLine>
<Link id="l00788" /><CodeLine lineNumber="788"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;Context = <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.getContext();</span></CodeLine>
<Link id="l00789" /><CodeLine lineNumber="789"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;FramePtrAddr = <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.CreateConstInBoundsGEP1&#95;32(</span></CodeLine>
<Link id="l00790" /><CodeLine lineNumber="790"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/type/#a7ba5de75f50bb4a4ba920698edf39b28">Type::getInt8Ty</a>(Context), CallerContext,</span></CodeLine>
<Link id="l00791" /><CodeLine lineNumber="791"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.AsyncLowering.FrameOffset, </span><span class="doxyHighlightStringLiteral">&quot;async.ctx.frameptr&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00792" /><CodeLine lineNumber="792"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Inline the projection function.</span></CodeLine>
<Link id="l00793" /><CodeLine lineNumber="793"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/inlinefunctioninfo">InlineFunctionInfo</a> <a href="/docs/api/files/lib/lib/debuginfo/lib/debuginfo/gsym/functioninfo-cpp/#a3e1eb307ada3e1ef3a115f4c734aa5eeac1775aaace95748849e1216a09f028fc">InlineInfo</a>;</span></CodeLine>
<Link id="l00794" /><CodeLine lineNumber="794"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> InlineRes = <a href="/docs/api/namespaces/llvm/#ab5a3ac0a249da0743dac1bd816d8e5d5">InlineFunction</a>(&#42;CallerContext, <a href="/docs/api/files/lib/lib/debuginfo/lib/debuginfo/gsym/functioninfo-cpp/#a3e1eb307ada3e1ef3a115f4c734aa5eeac1775aaace95748849e1216a09f028fc">InlineInfo</a>);</span></CodeLine>
<Link id="l00795" /><CodeLine lineNumber="795"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(InlineRes.isSuccess());</span></CodeLine>
<Link id="l00796" /><CodeLine lineNumber="796"><span class="doxyHighlight">    (void)InlineRes;</span></CodeLine>
<Link id="l00797" /><CodeLine lineNumber="797"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> FramePtrAddr;</span></CodeLine>
<Link id="l00798" /><CodeLine lineNumber="798"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00799" /><CodeLine lineNumber="799"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In continuation-lowering, the argument is the opaque storage.</span></CodeLine>
<Link id="l00800" /><CodeLine lineNumber="800"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380aad9d7f07127e321d1358b695c8720166">coro::ABI::Retcon</a>:</span></CodeLine>
<Link id="l00801" /><CodeLine lineNumber="801"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a6ec6c15fe79ec2274d2c3e79ae4bcc41">coro::ABI::RetconOnce</a>: &#123;</span></CodeLine>
<Link id="l00802" /><CodeLine lineNumber="802"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/argument">Argument</a> &#42;NewStorage = &amp;&#42;<a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;arg&#95;begin();</span></CodeLine>
<Link id="l00803" /><CodeLine lineNumber="803"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> FramePtrTy = <a href="/docs/api/classes/llvm/pointertype/#af8a1dbdbfd89aa4899b3c0d39495d0dd">PointerType::getUnqual</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.FrameTy-&gt;getContext());</span></CodeLine>
<Link id="l00804" /><CodeLine lineNumber="804"></CodeLine>
<Link id="l00805" /><CodeLine lineNumber="805"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If the storage is inline, just bitcast to the storage to the frame type.</span></CodeLine>
<Link id="l00806" /><CodeLine lineNumber="806"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.RetconLowering.IsFrameInlineInStorage)</span></CodeLine>
<Link id="l00807" /><CodeLine lineNumber="807"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> NewStorage;</span></CodeLine>
<Link id="l00808" /><CodeLine lineNumber="808"></CodeLine>
<Link id="l00809" /><CodeLine lineNumber="809"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Otherwise, load the real frame from the opaque storage.</span></CodeLine>
<Link id="l00810" /><CodeLine lineNumber="810"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.CreateLoad(FramePtrTy, NewStorage);</span></CodeLine>
<Link id="l00811" /><CodeLine lineNumber="811"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00812" /><CodeLine lineNumber="812"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00813" /><CodeLine lineNumber="813"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/errorhandling-h/#ace243f5c25697a1107cce46626b3dc94">llvm&#95;unreachable</a>(</span><span class="doxyHighlightStringLiteral">&quot;bad ABI&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00814" /><CodeLine lineNumber="814"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00815" /><CodeLine lineNumber="815"></CodeLine>
<Link id="l00816" /><CodeLine lineNumber="816"><span class="doxyHighlightComment">/// Adjust the scope line of the funclet to the first line number after the</span></CodeLine>
<Link id="l00817" /><CodeLine lineNumber="817"><span class="doxyHighlightComment">/// suspend point. This avoids a jump in the line table from the function</span></CodeLine>
<Link id="l00818" /><CodeLine lineNumber="818"><span class="doxyHighlightComment">/// declaration (where prologue instructions are attributed to) to the suspend</span></CodeLine>
<Link id="l00819" /><CodeLine lineNumber="819"><span class="doxyHighlightComment">/// point.</span></CodeLine>
<Link id="l00820" /><CodeLine lineNumber="820"><span class="doxyHighlightComment">/// Only adjust the scope line when the files are the same.</span></CodeLine>
<Link id="l00821" /><CodeLine lineNumber="821"><span class="doxyHighlightComment">/// If no candidate line number is found, fallback to the line of ActiveSuspend.</span></CodeLine>
<Link id="l00822" /><CodeLine lineNumber="822" lineLink="#a4d1d15c0a00a9b9391977c8f482e0428"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#a4d1d15c0a00a9b9391977c8f482e0428">updateScopeLine</a>(<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;ActiveSuspend,</span></CodeLine>
<Link id="l00823" /><CodeLine lineNumber="823"><span class="doxyHighlight">                            <a href="/docs/api/classes/llvm/disubprogram">DISubprogram</a> &amp;SPToUpdate) &#123;</span></CodeLine>
<Link id="l00824" /><CodeLine lineNumber="824"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!ActiveSuspend)</span></CodeLine>
<Link id="l00825" /><CodeLine lineNumber="825"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00826" /><CodeLine lineNumber="826"></CodeLine>
<Link id="l00827" /><CodeLine lineNumber="827"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// No subsequent instruction -&gt; fallback to the location of ActiveSuspend.</span></CodeLine>
<Link id="l00828" /><CodeLine lineNumber="828"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!ActiveSuspend-&gt;<a href="/docs/api/classes/llvm/instruction/#a91bd28adea418a08cec78b72413d9d45">getNextNonDebugInstruction</a>()) &#123;</span></CodeLine>
<Link id="l00829" /><CodeLine lineNumber="829"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a> = ActiveSuspend-&gt;<a href="/docs/api/classes/llvm/instruction/#a4b8faae4ff9e7434a1d226d03d15dcd2">getDebugLoc</a>())</span></CodeLine>
<Link id="l00830" /><CodeLine lineNumber="830"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SPToUpdate.<a href="/docs/api/classes/llvm/discope/#a693505a142c46203bb19ff1f09b5ea22">getFile</a>() == <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>-&gt;getFile())</span></CodeLine>
<Link id="l00831" /><CodeLine lineNumber="831"><span class="doxyHighlight">        SPToUpdate.setScopeLine(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>-&gt;getLine());</span></CodeLine>
<Link id="l00832" /><CodeLine lineNumber="832"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00833" /><CodeLine lineNumber="833"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00834" /><CodeLine lineNumber="834"></CodeLine>
<Link id="l00835" /><CodeLine lineNumber="835"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06add2496ae8d635f9f169602771c88d376">Successor</a> =</span></CodeLine>
<Link id="l00836" /><CodeLine lineNumber="836"><span class="doxyHighlight">      ActiveSuspend-&gt;<a href="/docs/api/classes/llvm/instruction/#a91bd28adea418a08cec78b72413d9d45">getNextNonDebugInstruction</a>()-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>();</span></CodeLine>
<Link id="l00837" /><CodeLine lineNumber="837"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Corosplit splits the BB around ActiveSuspend, so the meaningful</span></CodeLine>
<Link id="l00838" /><CodeLine lineNumber="838"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// instructions are not in the same BB.</span></CodeLine>
<Link id="l00839" /><CodeLine lineNumber="839"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Branch = <a href="/docs/api/namespaces/llvm/#a5f6182886dc2f96c204299e92c1565d5">dyn&#95;cast&#95;or&#95;null&lt;BranchInst&gt;</a>(<a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06add2496ae8d635f9f169602771c88d376">Successor</a>);</span></CodeLine>
<Link id="l00840" /><CodeLine lineNumber="840"><span class="doxyHighlight">      Branch &amp;&amp; Branch-&gt;isUnconditional())</span></CodeLine>
<Link id="l00841" /><CodeLine lineNumber="841"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06add2496ae8d635f9f169602771c88d376">Successor</a> = Branch-&gt;getSuccessor(0)-&gt;getFirstNonPHIOrDbg();</span></CodeLine>
<Link id="l00842" /><CodeLine lineNumber="842"></CodeLine>
<Link id="l00843" /><CodeLine lineNumber="843"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Find the first successor of ActiveSuspend with a non-zero line location.</span></CodeLine>
<Link id="l00844" /><CodeLine lineNumber="844"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If that matches the file of ActiveSuspend, use it.</span></CodeLine>
<Link id="l00845" /><CodeLine lineNumber="845"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;PBB = <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06add2496ae8d635f9f169602771c88d376">Successor</a>-&gt;getParent();</span></CodeLine>
<Link id="l00846" /><CodeLine lineNumber="846"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (; <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06add2496ae8d635f9f169602771c88d376">Successor</a> != PBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a0b4e7bee9b8575cc7db73329f1a561bd">end</a>(); <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06add2496ae8d635f9f169602771c88d376">Successor</a> = std::next(<a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06add2496ae8d635f9f169602771c88d376">Successor</a>)) &#123;</span></CodeLine>
<Link id="l00847" /><CodeLine lineNumber="847"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06add2496ae8d635f9f169602771c88d376">Successor</a> = <a href="/docs/api/namespaces/llvm/#a6577ad74b2f1a18729c71543850d8616">skipDebugIntrinsics</a>(<a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06add2496ae8d635f9f169602771c88d376">Successor</a>);</span></CodeLine>
<Link id="l00848" /><CodeLine lineNumber="848"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a> = <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06add2496ae8d635f9f169602771c88d376">Successor</a>-&gt;getDebugLoc();</span></CodeLine>
<Link id="l00849" /><CodeLine lineNumber="849"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a> || <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>.getLine() == 0)</span></CodeLine>
<Link id="l00850" /><CodeLine lineNumber="850"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00851" /><CodeLine lineNumber="851"></CodeLine>
<Link id="l00852" /><CodeLine lineNumber="852"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SPToUpdate.<a href="/docs/api/classes/llvm/discope/#a693505a142c46203bb19ff1f09b5ea22">getFile</a>() == <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>-&gt;getFile()) &#123;</span></CodeLine>
<Link id="l00853" /><CodeLine lineNumber="853"><span class="doxyHighlight">      SPToUpdate.setScopeLine(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>.getLine());</span></CodeLine>
<Link id="l00854" /><CodeLine lineNumber="854"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00855" /><CodeLine lineNumber="855"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00856" /><CodeLine lineNumber="856"></CodeLine>
<Link id="l00857" /><CodeLine lineNumber="857"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00858" /><CodeLine lineNumber="858"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00859" /><CodeLine lineNumber="859"></CodeLine>
<Link id="l00860" /><CodeLine lineNumber="860"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the search above failed, fallback to the location of ActiveSuspend.</span></CodeLine>
<Link id="l00861" /><CodeLine lineNumber="861"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a> = ActiveSuspend-&gt;<a href="/docs/api/classes/llvm/instruction/#a4b8faae4ff9e7434a1d226d03d15dcd2">getDebugLoc</a>())</span></CodeLine>
<Link id="l00862" /><CodeLine lineNumber="862"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SPToUpdate.<a href="/docs/api/classes/llvm/discope/#a693505a142c46203bb19ff1f09b5ea22">getFile</a>() == <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>-&gt;getFile())</span></CodeLine>
<Link id="l00863" /><CodeLine lineNumber="863"><span class="doxyHighlight">      SPToUpdate.setScopeLine(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>-&gt;getLine());</span></CodeLine>
<Link id="l00864" /><CodeLine lineNumber="864"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00865" /><CodeLine lineNumber="865"></CodeLine>
<Link id="l00866" /><CodeLine lineNumber="866" lineLink="#a7c497627acf5128770bd9fa245b44fbd"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#a7c497627acf5128770bd9fa245b44fbd">addFramePointerAttrs</a>(AttributeList &amp;Attrs, <a href="/docs/api/classes/llvm/llvmcontext">LLVMContext</a> &amp;Context,</span></CodeLine>
<Link id="l00867" /><CodeLine lineNumber="867"><span class="doxyHighlight">                                 </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> ParamIndex, uint64&#95;t <a href="/docs/api/files/lib/lib/analysis/inlineorder-cpp/#a7ee6f0cb51c3b9056199e9a0001fe8c3a6f6cb72d544962fa333e2e34ce64f719">Size</a>,</span></CodeLine>
<Link id="l00868" /><CodeLine lineNumber="868"><span class="doxyHighlight">                                 <a href="/docs/api/structs/llvm/align">Align</a> Alignment, </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> NoAlias) &#123;</span></CodeLine>
<Link id="l00869" /><CodeLine lineNumber="869"><span class="doxyHighlight">  AttrBuilder ParamAttrs(Context);</span></CodeLine>
<Link id="l00870" /><CodeLine lineNumber="870"><span class="doxyHighlight">  ParamAttrs.addAttribute(Attribute::NonNull);</span></CodeLine>
<Link id="l00871" /><CodeLine lineNumber="871"><span class="doxyHighlight">  ParamAttrs.addAttribute(Attribute::NoUndef);</span></CodeLine>
<Link id="l00872" /><CodeLine lineNumber="872"></CodeLine>
<Link id="l00873" /><CodeLine lineNumber="873"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NoAlias)</span></CodeLine>
<Link id="l00874" /><CodeLine lineNumber="874"><span class="doxyHighlight">    ParamAttrs.addAttribute(Attribute::NoAlias);</span></CodeLine>
<Link id="l00875" /><CodeLine lineNumber="875"></CodeLine>
<Link id="l00876" /><CodeLine lineNumber="876"><span class="doxyHighlight">  ParamAttrs.addAlignmentAttr(Alignment);</span></CodeLine>
<Link id="l00877" /><CodeLine lineNumber="877"><span class="doxyHighlight">  ParamAttrs.addDereferenceableAttr(<a href="/docs/api/files/lib/lib/analysis/inlineorder-cpp/#a7ee6f0cb51c3b9056199e9a0001fe8c3a6f6cb72d544962fa333e2e34ce64f719">Size</a>);</span></CodeLine>
<Link id="l00878" /><CodeLine lineNumber="878"><span class="doxyHighlight">  Attrs = Attrs.addParamAttributes(Context, ParamIndex, ParamAttrs);</span></CodeLine>
<Link id="l00879" /><CodeLine lineNumber="879"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00880" /><CodeLine lineNumber="880"></CodeLine>
<Link id="l00881" /><CodeLine lineNumber="881" lineLink="#a2c299a4357972cc32be0eda57abda580"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#a2c299a4357972cc32be0eda57abda580">addAsyncContextAttrs</a>(AttributeList &amp;Attrs, <a href="/docs/api/classes/llvm/llvmcontext">LLVMContext</a> &amp;Context,</span></CodeLine>
<Link id="l00882" /><CodeLine lineNumber="882"><span class="doxyHighlight">                                 </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> ParamIndex) &#123;</span></CodeLine>
<Link id="l00883" /><CodeLine lineNumber="883"><span class="doxyHighlight">  AttrBuilder ParamAttrs(Context);</span></CodeLine>
<Link id="l00884" /><CodeLine lineNumber="884"><span class="doxyHighlight">  ParamAttrs.addAttribute(Attribute::SwiftAsync);</span></CodeLine>
<Link id="l00885" /><CodeLine lineNumber="885"><span class="doxyHighlight">  Attrs = Attrs.addParamAttributes(Context, ParamIndex, ParamAttrs);</span></CodeLine>
<Link id="l00886" /><CodeLine lineNumber="886"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00887" /><CodeLine lineNumber="887"></CodeLine>
<Link id="l00888" /><CodeLine lineNumber="888" lineLink="#a0e09834bc2b325fc2f777641292396e1"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#a0e09834bc2b325fc2f777641292396e1">addSwiftSelfAttrs</a>(AttributeList &amp;Attrs, <a href="/docs/api/classes/llvm/llvmcontext">LLVMContext</a> &amp;Context,</span></CodeLine>
<Link id="l00889" /><CodeLine lineNumber="889"><span class="doxyHighlight">                              </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> ParamIndex) &#123;</span></CodeLine>
<Link id="l00890" /><CodeLine lineNumber="890"><span class="doxyHighlight">  AttrBuilder ParamAttrs(Context);</span></CodeLine>
<Link id="l00891" /><CodeLine lineNumber="891"><span class="doxyHighlight">  ParamAttrs.addAttribute(Attribute::SwiftSelf);</span></CodeLine>
<Link id="l00892" /><CodeLine lineNumber="892"><span class="doxyHighlight">  Attrs = Attrs.addParamAttributes(Context, ParamIndex, ParamAttrs);</span></CodeLine>
<Link id="l00893" /><CodeLine lineNumber="893"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00894" /><CodeLine lineNumber="894"></CodeLine>
<Link id="l00895" /><CodeLine lineNumber="895"><span class="doxyHighlightComment">/// Clone the body of the original function into a resume function of</span></CodeLine>
<Link id="l00896" /><CodeLine lineNumber="896"><span class="doxyHighlightComment">/// some sort.</span></CodeLine>
<Link id="l00897" /><CodeLine lineNumber="897" lineLink="/docs/api/classes/llvm/coro/basecloner/#acfb266590cdac3ed6480244efcd5899c"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/coro/basecloner/#acfb266590cdac3ed6480244efcd5899c">coro::BaseCloner::create</a>() &#123;</span></CodeLine>
<Link id="l00898" /><CodeLine lineNumber="898"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>);</span></CodeLine>
<Link id="l00899" /><CodeLine lineNumber="899"></CodeLine>
<Link id="l00900" /><CodeLine lineNumber="900"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Replace all args with dummy instructions. If an argument is the old frame</span></CodeLine>
<Link id="l00901" /><CodeLine lineNumber="901"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// pointer, the dummy will be replaced by the new frame pointer once it is</span></CodeLine>
<Link id="l00902" /><CodeLine lineNumber="902"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// computed below. Uses of all other arguments should have already been</span></CodeLine>
<Link id="l00903" /><CodeLine lineNumber="903"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// rewritten by buildCoroutineFrame() to use loads/stores on the coroutine</span></CodeLine>
<Link id="l00904" /><CodeLine lineNumber="904"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// frame.</span></CodeLine>
<Link id="l00905" /><CodeLine lineNumber="905"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Instruction &#42;&gt;</a> DummyArgs;</span></CodeLine>
<Link id="l00906" /><CodeLine lineNumber="906"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/argument">Argument</a> &amp;<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#a2e38c85003a042421cde1647632d0b72">A</a> : <a href="/docs/api/classes/llvm/coro/basecloner/#a567c0d086b740b39c9bfd703e0cf2908">OrigF</a>.args()) &#123;</span></CodeLine>
<Link id="l00907" /><CodeLine lineNumber="907"><span class="doxyHighlight">    DummyArgs.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(</span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/freezeinst">FreezeInst</a>(<a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#a2e38c85003a042421cde1647632d0b72">A</a>.getType())));</span></CodeLine>
<Link id="l00908" /><CodeLine lineNumber="908"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/coro/basecloner/#a817ca8bc950897f8f548f58d746d03d2">VMap</a>&#91;&amp;<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#a2e38c85003a042421cde1647632d0b72">A</a>&#93; = DummyArgs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#acd9e771a3296c6b24146955754620557">back</a>();</span></CodeLine>
<Link id="l00909" /><CodeLine lineNumber="909"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00910" /><CodeLine lineNumber="910"></CodeLine>
<Link id="l00911" /><CodeLine lineNumber="911"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;ReturnInst &#42;, 4&gt;</a> Returns;</span></CodeLine>
<Link id="l00912" /><CodeLine lineNumber="912"></CodeLine>
<Link id="l00913" /><CodeLine lineNumber="913"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Ignore attempts to change certain attributes of the function.</span></CodeLine>
<Link id="l00914" /><CodeLine lineNumber="914"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: maybe there should be a way to suppress this during cloning?</span></CodeLine>
<Link id="l00915" /><CodeLine lineNumber="915"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> savedVisibility = <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;getVisibility();</span></CodeLine>
<Link id="l00916" /><CodeLine lineNumber="916"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> savedUnnamedAddr = <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;getUnnamedAddr();</span></CodeLine>
<Link id="l00917" /><CodeLine lineNumber="917"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> savedDLLStorageClass = <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;getDLLStorageClass();</span></CodeLine>
<Link id="l00918" /><CodeLine lineNumber="918"></CodeLine>
<Link id="l00919" /><CodeLine lineNumber="919"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// NewF&#39;s linkage (which CloneFunctionInto does &#42;not&#42; change) might not</span></CodeLine>
<Link id="l00920" /><CodeLine lineNumber="920"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// be compatible with the visibility of OrigF (which it &#42;does&#42; change),</span></CodeLine>
<Link id="l00921" /><CodeLine lineNumber="921"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// so protect against that.</span></CodeLine>
<Link id="l00922" /><CodeLine lineNumber="922"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> savedLinkage = <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;getLinkage();</span></CodeLine>
<Link id="l00923" /><CodeLine lineNumber="923"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;setLinkage(<a href="/docs/api/classes/llvm/globalvalue/#aedfa75f0c85c4aa85b257f066fbea57ca6c93794d7b99cd433e96c53eadb15a6e">llvm::GlobalValue::ExternalLinkage</a>);</span></CodeLine>
<Link id="l00924" /><CodeLine lineNumber="924"></CodeLine>
<Link id="l00925" /><CodeLine lineNumber="925"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a0a9ae7045e9bc2bab2a756c683a24f45">CloneFunctionAttributesInto</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>, &amp;<a href="/docs/api/classes/llvm/coro/basecloner/#a567c0d086b740b39c9bfd703e0cf2908">OrigF</a>, <a href="/docs/api/classes/llvm/coro/basecloner/#a817ca8bc950897f8f548f58d746d03d2">VMap</a>, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00926" /><CodeLine lineNumber="926"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a9d39db97de33dc64cd40be3d37fc8ed9">CloneFunctionMetadataInto</a>(&#42;<a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>, <a href="/docs/api/classes/llvm/coro/basecloner/#a567c0d086b740b39c9bfd703e0cf2908">OrigF</a>, <a href="/docs/api/classes/llvm/coro/basecloner/#a817ca8bc950897f8f548f58d746d03d2">VMap</a>, <a href="/docs/api/namespaces/llvm/#a77724415203930efd07d7098cb1e437da89b60f3b4ad8c1e0ddb9a31b57cb13f9">RF&#95;None</a>, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00927" /><CodeLine lineNumber="927"><span class="doxyHighlight">                            &amp;<a href="/docs/api/classes/llvm/coro/basecloner/#a38506d5e7b2f1915b1578ba729c1ca89">CommonDebugInfo</a>);</span></CodeLine>
<Link id="l00928" /><CodeLine lineNumber="928"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#af97d9ff977792ae671987a9a95f942f2">CloneFunctionBodyInto</a>(&#42;<a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>, <a href="/docs/api/classes/llvm/coro/basecloner/#a567c0d086b740b39c9bfd703e0cf2908">OrigF</a>, <a href="/docs/api/classes/llvm/coro/basecloner/#a817ca8bc950897f8f548f58d746d03d2">VMap</a>, <a href="/docs/api/namespaces/llvm/#a77724415203930efd07d7098cb1e437da89b60f3b4ad8c1e0ddb9a31b57cb13f9">RF&#95;None</a>, Returns, </span><span class="doxyHighlightStringLiteral">&quot;&quot;</span><span class="doxyHighlight">, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00929" /><CodeLine lineNumber="929"><span class="doxyHighlight">                        </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">, &amp;<a href="/docs/api/classes/llvm/coro/basecloner/#a38506d5e7b2f1915b1578ba729c1ca89">CommonDebugInfo</a>);</span></CodeLine>
<Link id="l00930" /><CodeLine lineNumber="930"></CodeLine>
<Link id="l00931" /><CodeLine lineNumber="931"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;Context = <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;getContext();</span></CodeLine>
<Link id="l00932" /><CodeLine lineNumber="932"></CodeLine>
<Link id="l00933" /><CodeLine lineNumber="933"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/disubprogram">DISubprogram</a> &#42;SP = <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;getSubprogram()) &#123;</span></CodeLine>
<Link id="l00934" /><CodeLine lineNumber="934"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(SP != <a href="/docs/api/classes/llvm/coro/basecloner/#a567c0d086b740b39c9bfd703e0cf2908">OrigF</a>.getSubprogram() &amp;&amp; SP-&gt;isDistinct());</span></CodeLine>
<Link id="l00935" /><CodeLine lineNumber="935"><span class="doxyHighlight">    <a href="#a4d1d15c0a00a9b9391977c8f482e0428">updateScopeLine</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a1e5d0f79e5f4e6b854642ab34a378517">ActiveSuspend</a>, &#42;SP);</span></CodeLine>
<Link id="l00936" /><CodeLine lineNumber="936"></CodeLine>
<Link id="l00937" /><CodeLine lineNumber="937"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Update the linkage name to reflect the modified symbol name. It</span></CodeLine>
<Link id="l00938" /><CodeLine lineNumber="938"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// is necessary to update the linkage name in Swift, since the</span></CodeLine>
<Link id="l00939" /><CodeLine lineNumber="939"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// mangling changes for resume functions. It might also be the</span></CodeLine>
<Link id="l00940" /><CodeLine lineNumber="940"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// right thing to do in C++, but due to a limitation in LLVM&#39;s</span></CodeLine>
<Link id="l00941" /><CodeLine lineNumber="941"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// AsmPrinter we can only do this if the function doesn&#39;t have an</span></CodeLine>
<Link id="l00942" /><CodeLine lineNumber="942"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// abstract specification, since the DWARF backend expects the</span></CodeLine>
<Link id="l00943" /><CodeLine lineNumber="943"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// abstract specification to contain the linkage name and asserts</span></CodeLine>
<Link id="l00944" /><CodeLine lineNumber="944"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// that they are identical.</span></CodeLine>
<Link id="l00945" /><CodeLine lineNumber="945"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SP-&gt;getUnit() &amp;&amp;</span></CodeLine>
<Link id="l00946" /><CodeLine lineNumber="946"><span class="doxyHighlight">        SP-&gt;getUnit()-&gt;getSourceLanguage() == dwarf::DW&#95;LANG&#95;Swift) &#123;</span></CodeLine>
<Link id="l00947" /><CodeLine lineNumber="947"><span class="doxyHighlight">      SP-&gt;replaceLinkageName(<a href="/docs/api/classes/llvm/mdstring/#affbb7e2e9ad8d18114816f2443d672b9">MDString::get</a>(Context, <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;getName()));</span></CodeLine>
<Link id="l00948" /><CodeLine lineNumber="948"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Decl = SP-&gt;getDeclaration()) &#123;</span></CodeLine>
<Link id="l00949" /><CodeLine lineNumber="949"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewDecl = <a href="/docs/api/classes/llvm/mdnode/#a7d10a7b9b7f40b04d27ed97c38ea1950">DISubprogram::get</a>(</span></CodeLine>
<Link id="l00950" /><CodeLine lineNumber="950"><span class="doxyHighlight">            Decl-&gt;getContext(), Decl-&gt;getScope(), Decl-&gt;getName(),</span></CodeLine>
<Link id="l00951" /><CodeLine lineNumber="951"><span class="doxyHighlight">            <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;getName(), Decl-&gt;getFile(), Decl-&gt;getLine(), Decl-&gt;getType(),</span></CodeLine>
<Link id="l00952" /><CodeLine lineNumber="952"><span class="doxyHighlight">            Decl-&gt;getScopeLine(), Decl-&gt;getContainingType(),</span></CodeLine>
<Link id="l00953" /><CodeLine lineNumber="953"><span class="doxyHighlight">            Decl-&gt;getVirtualIndex(), Decl-&gt;getThisAdjustment(),</span></CodeLine>
<Link id="l00954" /><CodeLine lineNumber="954"><span class="doxyHighlight">            Decl-&gt;getFlags(), Decl-&gt;getSPFlags(), Decl-&gt;getUnit(),</span></CodeLine>
<Link id="l00955" /><CodeLine lineNumber="955"><span class="doxyHighlight">            Decl-&gt;getTemplateParams(), </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">, Decl-&gt;getRetainedNodes(),</span></CodeLine>
<Link id="l00956" /><CodeLine lineNumber="956"><span class="doxyHighlight">            Decl-&gt;getThrownTypes(), Decl-&gt;getAnnotations(),</span></CodeLine>
<Link id="l00957" /><CodeLine lineNumber="957"><span class="doxyHighlight">            Decl-&gt;getTargetFuncName());</span></CodeLine>
<Link id="l00958" /><CodeLine lineNumber="958"><span class="doxyHighlight">        SP-&gt;replaceDeclaration(NewDecl);</span></CodeLine>
<Link id="l00959" /><CodeLine lineNumber="959"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00960" /><CodeLine lineNumber="960"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00961" /><CodeLine lineNumber="961"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00962" /><CodeLine lineNumber="962"></CodeLine>
<Link id="l00963" /><CodeLine lineNumber="963"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;setLinkage(savedLinkage);</span></CodeLine>
<Link id="l00964" /><CodeLine lineNumber="964"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;setVisibility(savedVisibility);</span></CodeLine>
<Link id="l00965" /><CodeLine lineNumber="965"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;setUnnamedAddr(savedUnnamedAddr);</span></CodeLine>
<Link id="l00966" /><CodeLine lineNumber="966"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;setDLLStorageClass(savedDLLStorageClass);</span></CodeLine>
<Link id="l00967" /><CodeLine lineNumber="967"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The function sanitizer metadata needs to match the signature of the</span></CodeLine>
<Link id="l00968" /><CodeLine lineNumber="968"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// function it is being attached to. However this does not hold for split</span></CodeLine>
<Link id="l00969" /><CodeLine lineNumber="969"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// functions here. Thus remove the metadata for split functions.</span></CodeLine>
<Link id="l00970" /><CodeLine lineNumber="970"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.ABI == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">coro::ABI::Switch</a> &amp;&amp;</span></CodeLine>
<Link id="l00971" /><CodeLine lineNumber="971"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;hasMetadata(LLVMContext::MD&#95;func&#95;sanitize))</span></CodeLine>
<Link id="l00972" /><CodeLine lineNumber="972"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;eraseMetadata(LLVMContext::MD&#95;func&#95;sanitize);</span></CodeLine>
<Link id="l00973" /><CodeLine lineNumber="973"></CodeLine>
<Link id="l00974" /><CodeLine lineNumber="974"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Replace the attributes of the new function:</span></CodeLine>
<Link id="l00975" /><CodeLine lineNumber="975"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> OrigAttrs = <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;getAttributes();</span></CodeLine>
<Link id="l00976" /><CodeLine lineNumber="976"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> NewAttrs = AttributeList();</span></CodeLine>
<Link id="l00977" /><CodeLine lineNumber="977"></CodeLine>
<Link id="l00978" /><CodeLine lineNumber="978"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.ABI) &#123;</span></CodeLine>
<Link id="l00979" /><CodeLine lineNumber="979"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">coro::ABI::Switch</a>:</span></CodeLine>
<Link id="l00980" /><CodeLine lineNumber="980"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Bootstrap attributes by copying function attributes from the</span></CodeLine>
<Link id="l00981" /><CodeLine lineNumber="981"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// original function.  This should include optimization settings and so on.</span></CodeLine>
<Link id="l00982" /><CodeLine lineNumber="982"><span class="doxyHighlight">    NewAttrs = NewAttrs.addFnAttributes(</span></CodeLine>
<Link id="l00983" /><CodeLine lineNumber="983"><span class="doxyHighlight">        Context, AttrBuilder(Context, OrigAttrs.getFnAttrs()));</span></CodeLine>
<Link id="l00984" /><CodeLine lineNumber="984"></CodeLine>
<Link id="l00985" /><CodeLine lineNumber="985"><span class="doxyHighlight">    <a href="#a7c497627acf5128770bd9fa245b44fbd">addFramePointerAttrs</a>(NewAttrs, Context, 0, <a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.FrameSize,</span></CodeLine>
<Link id="l00986" /><CodeLine lineNumber="986"><span class="doxyHighlight">                         <a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.FrameAlign, </span><span class="doxyHighlightComment">/&#42;NoAlias=&#42;/</span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00987" /><CodeLine lineNumber="987"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00988" /><CodeLine lineNumber="988"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a24aa4117da86c41684ad25742832dfa6">coro::ABI::Async</a>: &#123;</span></CodeLine>
<Link id="l00989" /><CodeLine lineNumber="989"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;ActiveAsyncSuspend = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CoroSuspendAsyncInst&gt;</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a1e5d0f79e5f4e6b854642ab34a378517">ActiveSuspend</a>);</span></CodeLine>
<Link id="l00990" /><CodeLine lineNumber="990"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/coro/basecloner/#a567c0d086b740b39c9bfd703e0cf2908">OrigF</a>.hasParamAttribute(<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.AsyncLowering.ContextArgNo,</span></CodeLine>
<Link id="l00991" /><CodeLine lineNumber="991"><span class="doxyHighlight">                                Attribute::SwiftAsync)) &#123;</span></CodeLine>
<Link id="l00992" /><CodeLine lineNumber="992"><span class="doxyHighlight">      uint32&#95;t ArgAttributeIndices =</span></CodeLine>
<Link id="l00993" /><CodeLine lineNumber="993"><span class="doxyHighlight">          ActiveAsyncSuspend-&gt;getStorageArgumentIndex();</span></CodeLine>
<Link id="l00994" /><CodeLine lineNumber="994"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> ContextArgIndex = ArgAttributeIndices &amp; 0xff;</span></CodeLine>
<Link id="l00995" /><CodeLine lineNumber="995"><span class="doxyHighlight">      <a href="#a2c299a4357972cc32be0eda57abda580">addAsyncContextAttrs</a>(NewAttrs, Context, ContextArgIndex);</span></CodeLine>
<Link id="l00996" /><CodeLine lineNumber="996"></CodeLine>
<Link id="l00997" /><CodeLine lineNumber="997"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// &#96;swiftasync&#96; must preceed &#96;swiftself&#96; so 0 is not a valid index for</span></CodeLine>
<Link id="l00998" /><CodeLine lineNumber="998"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// &#96;swiftself&#96;.</span></CodeLine>
<Link id="l00999" /><CodeLine lineNumber="999"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> SwiftSelfIndex = ArgAttributeIndices &gt;&gt; 8;</span></CodeLine>
<Link id="l01000" /><CodeLine lineNumber="1000"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SwiftSelfIndex)</span></CodeLine>
<Link id="l01001" /><CodeLine lineNumber="1001"><span class="doxyHighlight">        <a href="#a0e09834bc2b325fc2f777641292396e1">addSwiftSelfAttrs</a>(NewAttrs, Context, SwiftSelfIndex);</span></CodeLine>
<Link id="l01002" /><CodeLine lineNumber="1002"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01003" /><CodeLine lineNumber="1003"></CodeLine>
<Link id="l01004" /><CodeLine lineNumber="1004"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Transfer the original function&#39;s attributes.</span></CodeLine>
<Link id="l01005" /><CodeLine lineNumber="1005"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> FnAttrs = <a href="/docs/api/classes/llvm/coro/basecloner/#a567c0d086b740b39c9bfd703e0cf2908">OrigF</a>.getAttributes().getFnAttrs();</span></CodeLine>
<Link id="l01006" /><CodeLine lineNumber="1006"><span class="doxyHighlight">    NewAttrs = NewAttrs.addFnAttributes(Context, AttrBuilder(Context, FnAttrs));</span></CodeLine>
<Link id="l01007" /><CodeLine lineNumber="1007"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01008" /><CodeLine lineNumber="1008"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01009" /><CodeLine lineNumber="1009"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380aad9d7f07127e321d1358b695c8720166">coro::ABI::Retcon</a>:</span></CodeLine>
<Link id="l01010" /><CodeLine lineNumber="1010"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a6ec6c15fe79ec2274d2c3e79ae4bcc41">coro::ABI::RetconOnce</a>:</span></CodeLine>
<Link id="l01011" /><CodeLine lineNumber="1011"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If we have a continuation prototype, just use its attributes,</span></CodeLine>
<Link id="l01012" /><CodeLine lineNumber="1012"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// full-stop.</span></CodeLine>
<Link id="l01013" /><CodeLine lineNumber="1013"><span class="doxyHighlight">    NewAttrs = <a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.RetconLowering.ResumePrototype-&gt;getAttributes();</span></CodeLine>
<Link id="l01014" /><CodeLine lineNumber="1014"></CodeLine>
<Link id="l01015" /><CodeLine lineNumber="1015"><span class="doxyHighlightComment">    /// FIXME: Is it really good to add the NoAlias attribute?</span></CodeLine>
<Link id="l01016" /><CodeLine lineNumber="1016"><span class="doxyHighlight">    <a href="#a7c497627acf5128770bd9fa245b44fbd">addFramePointerAttrs</a>(NewAttrs, Context, 0,</span></CodeLine>
<Link id="l01017" /><CodeLine lineNumber="1017"><span class="doxyHighlight">                         <a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.getRetconCoroId()-&gt;getStorageSize(),</span></CodeLine>
<Link id="l01018" /><CodeLine lineNumber="1018"><span class="doxyHighlight">                         <a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.getRetconCoroId()-&gt;getStorageAlignment(),</span></CodeLine>
<Link id="l01019" /><CodeLine lineNumber="1019"><span class="doxyHighlight">                         </span><span class="doxyHighlightComment">/&#42;NoAlias=&#42;/</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01020" /><CodeLine lineNumber="1020"></CodeLine>
<Link id="l01021" /><CodeLine lineNumber="1021"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01022" /><CodeLine lineNumber="1022"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01023" /><CodeLine lineNumber="1023"></CodeLine>
<Link id="l01024" /><CodeLine lineNumber="1024"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.ABI) &#123;</span></CodeLine>
<Link id="l01025" /><CodeLine lineNumber="1025"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In these ABIs, the cloned functions always return &#39;void&#39;, and the</span></CodeLine>
<Link id="l01026" /><CodeLine lineNumber="1026"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// existing return sites are meaningless.  Note that for unique</span></CodeLine>
<Link id="l01027" /><CodeLine lineNumber="1027"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// continuations, this includes the returns associated with suspends;</span></CodeLine>
<Link id="l01028" /><CodeLine lineNumber="1028"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// this is fine because we can&#39;t suspend twice.</span></CodeLine>
<Link id="l01029" /><CodeLine lineNumber="1029"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">coro::ABI::Switch</a>:</span></CodeLine>
<Link id="l01030" /><CodeLine lineNumber="1030"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a6ec6c15fe79ec2274d2c3e79ae4bcc41">coro::ABI::RetconOnce</a>:</span></CodeLine>
<Link id="l01031" /><CodeLine lineNumber="1031"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Remove old returns.</span></CodeLine>
<Link id="l01032" /><CodeLine lineNumber="1032"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/returninst">ReturnInst</a> &#42;Return : Returns)</span></CodeLine>
<Link id="l01033" /><CodeLine lineNumber="1033"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#a97370114df349e0996f133e3402c1595">changeToUnreachable</a>(Return);</span></CodeLine>
<Link id="l01034" /><CodeLine lineNumber="1034"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01035" /><CodeLine lineNumber="1035"></CodeLine>
<Link id="l01036" /><CodeLine lineNumber="1036"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// With multi-suspend continuations, we&#39;ll already have eliminated the</span></CodeLine>
<Link id="l01037" /><CodeLine lineNumber="1037"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// original returns and inserted returns before all the suspend points,</span></CodeLine>
<Link id="l01038" /><CodeLine lineNumber="1038"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// so we want to leave any returns in place.</span></CodeLine>
<Link id="l01039" /><CodeLine lineNumber="1039"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380aad9d7f07127e321d1358b695c8720166">coro::ABI::Retcon</a>:</span></CodeLine>
<Link id="l01040" /><CodeLine lineNumber="1040"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01041" /><CodeLine lineNumber="1041"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Async lowering will insert musttail call functions at all suspend points</span></CodeLine>
<Link id="l01042" /><CodeLine lineNumber="1042"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// followed by a return.</span></CodeLine>
<Link id="l01043" /><CodeLine lineNumber="1043"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Don&#39;t change returns to unreachable because that will trip up the verifier.</span></CodeLine>
<Link id="l01044" /><CodeLine lineNumber="1044"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// These returns should be unreachable from the clone.</span></CodeLine>
<Link id="l01045" /><CodeLine lineNumber="1045"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a24aa4117da86c41684ad25742832dfa6">coro::ABI::Async</a>:</span></CodeLine>
<Link id="l01046" /><CodeLine lineNumber="1046"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01047" /><CodeLine lineNumber="1047"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01048" /><CodeLine lineNumber="1048"></CodeLine>
<Link id="l01049" /><CodeLine lineNumber="1049"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;setAttributes(NewAttrs);</span></CodeLine>
<Link id="l01050" /><CodeLine lineNumber="1050"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;setCallingConv(<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.getResumeFunctionCC());</span></CodeLine>
<Link id="l01051" /><CodeLine lineNumber="1051"></CodeLine>
<Link id="l01052" /><CodeLine lineNumber="1052"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Set up the new entry block.</span></CodeLine>
<Link id="l01053" /><CodeLine lineNumber="1053"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/basecloner/#a275ed8c2ebcd61ba635dbf7c119e7ed2">replaceEntryBlock</a>();</span></CodeLine>
<Link id="l01054" /><CodeLine lineNumber="1054"></CodeLine>
<Link id="l01055" /><CodeLine lineNumber="1055"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Turn symmetric transfers into musttail calls.</span></CodeLine>
<Link id="l01056" /><CodeLine lineNumber="1056"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42;ResumeCall : <a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.SymmetricTransfers) &#123;</span></CodeLine>
<Link id="l01057" /><CodeLine lineNumber="1057"><span class="doxyHighlight">    ResumeCall = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CallInst&gt;</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a817ca8bc950897f8f548f58d746d03d2">VMap</a>&#91;ResumeCall&#93;);</span></CodeLine>
<Link id="l01058" /><CodeLine lineNumber="1058"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/coro/basecloner/#a6472b6d2ecf3c53f5e7ddc8cf0a803bb">TTI</a>.supportsTailCallFor(ResumeCall)) &#123;</span></CodeLine>
<Link id="l01059" /><CodeLine lineNumber="1059"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// FIXME: Could we support symmetric transfer effectively without</span></CodeLine>
<Link id="l01060" /><CodeLine lineNumber="1060"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// musttail?</span></CodeLine>
<Link id="l01061" /><CodeLine lineNumber="1061"><span class="doxyHighlight">      ResumeCall-&gt;setTailCallKind(<a href="/docs/api/classes/llvm/callinst/#ad682514c13f12f1a8d759d422fce6aefa2c3fc2c37f5db1dd777fad4e0d33ec7e">CallInst::TCK&#95;MustTail</a>);</span></CodeLine>
<Link id="l01062" /><CodeLine lineNumber="1062"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01063" /><CodeLine lineNumber="1063"></CodeLine>
<Link id="l01064" /><CodeLine lineNumber="1064"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Put a &#39;ret void&#39; after the call, and split any remaining instructions to</span></CodeLine>
<Link id="l01065" /><CodeLine lineNumber="1065"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// an unreachable block.</span></CodeLine>
<Link id="l01066" /><CodeLine lineNumber="1066"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB = ResumeCall-&gt;<a href="/docs/api/classes/llvm/basicblock/#a1b4bf7c97cdc8159fd73d48063f0b250">getParent</a>();</span></CodeLine>
<Link id="l01067" /><CodeLine lineNumber="1067"><span class="doxyHighlight">    BB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a52c990590792c91dd20b6d45acebe359">splitBasicBlock</a>(ResumeCall-&gt;getNextNode());</span></CodeLine>
<Link id="l01068" /><CodeLine lineNumber="1068"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.SetInsertPoint(BB-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</span></CodeLine>
<Link id="l01069" /><CodeLine lineNumber="1069"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.CreateRetVoid();</span></CodeLine>
<Link id="l01070" /><CodeLine lineNumber="1070"><span class="doxyHighlight">    BB-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>()-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</span></CodeLine>
<Link id="l01071" /><CodeLine lineNumber="1071"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01072" /><CodeLine lineNumber="1072"></CodeLine>
<Link id="l01073" /><CodeLine lineNumber="1073"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.SetInsertPoint(&amp;<a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a>-&gt;getEntryBlock().front());</span></CodeLine>
<Link id="l01074" /><CodeLine lineNumber="1074"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/basecloner/#a3c3567cc47523e331dfcadc14d09550b">NewFramePtr</a> = <a href="/docs/api/classes/llvm/coro/basecloner/#a2039a88cc5cd331c4012e856dde33eed">deriveNewFramePointer</a>();</span></CodeLine>
<Link id="l01075" /><CodeLine lineNumber="1075"></CodeLine>
<Link id="l01076" /><CodeLine lineNumber="1076"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Remap frame pointer.</span></CodeLine>
<Link id="l01077" /><CodeLine lineNumber="1077"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;OldFramePtr = <a href="/docs/api/classes/llvm/coro/basecloner/#a817ca8bc950897f8f548f58d746d03d2">VMap</a>&#91;<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.FramePtr&#93;;</span></CodeLine>
<Link id="l01078" /><CodeLine lineNumber="1078"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/basecloner/#a3c3567cc47523e331dfcadc14d09550b">NewFramePtr</a>-&gt;takeName(OldFramePtr);</span></CodeLine>
<Link id="l01079" /><CodeLine lineNumber="1079"><span class="doxyHighlight">  OldFramePtr-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a3c3567cc47523e331dfcadc14d09550b">NewFramePtr</a>);</span></CodeLine>
<Link id="l01080" /><CodeLine lineNumber="1080"></CodeLine>
<Link id="l01081" /><CodeLine lineNumber="1081"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Remap vFrame pointer.</span></CodeLine>
<Link id="l01082" /><CodeLine lineNumber="1082"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewVFrame = <a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.CreateBitCast(</span></CodeLine>
<Link id="l01083" /><CodeLine lineNumber="1083"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/coro/basecloner/#a3c3567cc47523e331dfcadc14d09550b">NewFramePtr</a>, <a href="/docs/api/classes/llvm/pointertype/#af8a1dbdbfd89aa4899b3c0d39495d0dd">PointerType::getUnqual</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#abb1ffcc2d4d7f478062b9bf40cee18db">Builder</a>.getContext()), </span><span class="doxyHighlightStringLiteral">&quot;vFrame&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01084" /><CodeLine lineNumber="1084"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;OldVFrame = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Value&gt;</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a817ca8bc950897f8f548f58d746d03d2">VMap</a>&#91;<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.CoroBegin&#93;);</span></CodeLine>
<Link id="l01085" /><CodeLine lineNumber="1085"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (OldVFrame != NewVFrame)</span></CodeLine>
<Link id="l01086" /><CodeLine lineNumber="1086"><span class="doxyHighlight">    OldVFrame-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(NewVFrame);</span></CodeLine>
<Link id="l01087" /><CodeLine lineNumber="1087"></CodeLine>
<Link id="l01088" /><CodeLine lineNumber="1088"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// All uses of the arguments should have been resolved by this point,</span></CodeLine>
<Link id="l01089" /><CodeLine lineNumber="1089"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// so we can safely remove the dummy values.</span></CodeLine>
<Link id="l01090" /><CodeLine lineNumber="1090"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;DummyArg : DummyArgs) &#123;</span></CodeLine>
<Link id="l01091" /><CodeLine lineNumber="1091"><span class="doxyHighlight">    DummyArg-&gt;replaceAllUsesWith(<a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(DummyArg-&gt;getType()));</span></CodeLine>
<Link id="l01092" /><CodeLine lineNumber="1092"><span class="doxyHighlight">    DummyArg-&gt;deleteValue();</span></CodeLine>
<Link id="l01093" /><CodeLine lineNumber="1093"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01094" /><CodeLine lineNumber="1094"></CodeLine>
<Link id="l01095" /><CodeLine lineNumber="1095"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.ABI) &#123;</span></CodeLine>
<Link id="l01096" /><CodeLine lineNumber="1096"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">coro::ABI::Switch</a>:</span></CodeLine>
<Link id="l01097" /><CodeLine lineNumber="1097"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Rewrite final suspend handling as it is not done via switch (allows to</span></CodeLine>
<Link id="l01098" /><CodeLine lineNumber="1098"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// remove final case from the switch, since it is undefined behavior to</span></CodeLine>
<Link id="l01099" /><CodeLine lineNumber="1099"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// resume the coroutine suspended at the final suspend point.</span></CodeLine>
<Link id="l01100" /><CodeLine lineNumber="1100"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.SwitchLowering.HasFinalSuspend)</span></CodeLine>
<Link id="l01101" /><CodeLine lineNumber="1101"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/coro/basecloner/#a614a737e40ceece782633b5cabbeab49">handleFinalSuspend</a>();</span></CodeLine>
<Link id="l01102" /><CodeLine lineNumber="1102"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01103" /><CodeLine lineNumber="1103"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a24aa4117da86c41684ad25742832dfa6">coro::ABI::Async</a>:</span></CodeLine>
<Link id="l01104" /><CodeLine lineNumber="1104"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380aad9d7f07127e321d1358b695c8720166">coro::ABI::Retcon</a>:</span></CodeLine>
<Link id="l01105" /><CodeLine lineNumber="1105"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a6ec6c15fe79ec2274d2c3e79ae4bcc41">coro::ABI::RetconOnce</a>:</span></CodeLine>
<Link id="l01106" /><CodeLine lineNumber="1106"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Replace uses of the active suspend with the corresponding</span></CodeLine>
<Link id="l01107" /><CodeLine lineNumber="1107"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// continuation-function arguments.</span></CodeLine>
<Link id="l01108" /><CodeLine lineNumber="1108"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a1e5d0f79e5f4e6b854642ab34a378517">ActiveSuspend</a> != </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight"> &amp;&amp;</span></CodeLine>
<Link id="l01109" /><CodeLine lineNumber="1109"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;no active suspend when lowering a continuation-style coroutine&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01110" /><CodeLine lineNumber="1110"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/coro/basecloner/#accee5b18a5d340c2e2aa6ec426df1778">replaceRetconOrAsyncSuspendUses</a>();</span></CodeLine>
<Link id="l01111" /><CodeLine lineNumber="1111"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01112" /><CodeLine lineNumber="1112"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01113" /><CodeLine lineNumber="1113"></CodeLine>
<Link id="l01114" /><CodeLine lineNumber="1114"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Handle suspends.</span></CodeLine>
<Link id="l01115" /><CodeLine lineNumber="1115"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/basecloner/#a297393e7eadf926c84fff5c68e7d6818">replaceCoroSuspends</a>();</span></CodeLine>
<Link id="l01116" /><CodeLine lineNumber="1116"></CodeLine>
<Link id="l01117" /><CodeLine lineNumber="1117"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Handle swifterror.</span></CodeLine>
<Link id="l01118" /><CodeLine lineNumber="1118"><span class="doxyHighlight">  <a href="#a236935b2df66a03a0a54350a6b9b84bc">replaceSwiftErrorOps</a>();</span></CodeLine>
<Link id="l01119" /><CodeLine lineNumber="1119"></CodeLine>
<Link id="l01120" /><CodeLine lineNumber="1120"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Remove coro.end intrinsics.</span></CodeLine>
<Link id="l01121" /><CodeLine lineNumber="1121"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/basecloner/#a7c1ae62749eee27ce4004984448899e0">replaceCoroEnds</a>();</span></CodeLine>
<Link id="l01122" /><CodeLine lineNumber="1122"></CodeLine>
<Link id="l01123" /><CodeLine lineNumber="1123"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Salvage debug info that points into the coroutine frame.</span></CodeLine>
<Link id="l01124" /><CodeLine lineNumber="1124"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/coro/#a14553297713bc2c6012758ee13a2b917">salvageDebugInfo</a>();</span></CodeLine>
<Link id="l01125" /><CodeLine lineNumber="1125"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01126" /><CodeLine lineNumber="1126"></CodeLine>
<Link id="l01127" /><CodeLine lineNumber="1127" lineLink="/docs/api/classes/llvm/coro/switchcloner/#a402d5de6c6250d90988f455ada737600"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/coro/switchcloner/#a402d5de6c6250d90988f455ada737600">coro::SwitchCloner::create</a>() &#123;</span></CodeLine>
<Link id="l01128" /><CodeLine lineNumber="1128"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create a new function matching the original type</span></CodeLine>
<Link id="l01129" /><CodeLine lineNumber="1129"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/basecloner/#a89388e76a59ed9ad1d493b03f212bb3d">NewF</a> = <a href="#a452dcc29fd5e19bda874218e10a8945c">createCloneDeclaration</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a567c0d086b740b39c9bfd703e0cf2908">OrigF</a>, <a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>, <a href="/docs/api/classes/llvm/coro/basecloner/#aa8abf978b13ebdb39f3fa271d7c49bf5">Suffix</a>, <a href="/docs/api/classes/llvm/coro/basecloner/#a567c0d086b740b39c9bfd703e0cf2908">OrigF</a>.getParent()-&gt;end(),</span></CodeLine>
<Link id="l01130" /><CodeLine lineNumber="1130"><span class="doxyHighlight">                                <a href="/docs/api/classes/llvm/coro/basecloner/#a1e5d0f79e5f4e6b854642ab34a378517">ActiveSuspend</a>);</span></CodeLine>
<Link id="l01131" /><CodeLine lineNumber="1131"></CodeLine>
<Link id="l01132" /><CodeLine lineNumber="1132"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Clone the function</span></CodeLine>
<Link id="l01133" /><CodeLine lineNumber="1133"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/basecloner/#acfb266590cdac3ed6480244efcd5899c">coro::BaseCloner::create</a>();</span></CodeLine>
<Link id="l01134" /><CodeLine lineNumber="1134"></CodeLine>
<Link id="l01135" /><CodeLine lineNumber="1135"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Eliminate coro.free from the clones, replacing it with &#39;null&#39; in cleanup,</span></CodeLine>
<Link id="l01136" /><CodeLine lineNumber="1136"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// to suppress deallocation code.</span></CodeLine>
<Link id="l01137" /><CodeLine lineNumber="1137"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/coro/#abf799de7147065c0e7f525e1b6009dde">coro::replaceCoroFree</a>(<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CoroIdInst&gt;</a>(<a href="/docs/api/classes/llvm/coro/basecloner/#a817ca8bc950897f8f548f58d746d03d2">VMap</a>&#91;<a href="/docs/api/classes/llvm/coro/basecloner/#a7288c19a015ef21ca88686272daa99bd">Shape</a>.CoroBegin-&gt;getId()&#93;),</span></CodeLine>
<Link id="l01138" /><CodeLine lineNumber="1138"><span class="doxyHighlight">                        </span><span class="doxyHighlightComment">/&#42;Elide=&#42;/</span><span class="doxyHighlight"><a href="/docs/api/classes/llvm/coro/basecloner/#aa92eee9e4cc8d96f072ac2887d82eb6e">FKind</a> == <a href="/docs/api/namespaces/llvm/coro/#ad5c7ebab0ec481424c33db8902c652f4a2c249a520c88badf6f400e74f26ce424">coro::CloneKind::SwitchCleanup</a>);</span></CodeLine>
<Link id="l01139" /><CodeLine lineNumber="1139"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01140" /><CodeLine lineNumber="1140"></CodeLine>
<Link id="l01141" /><CodeLine lineNumber="1141" lineLink="#ab02a4d4ecc962ea09ed6c79ebc699a54"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#ab02a4d4ecc962ea09ed6c79ebc699a54">updateAsyncFuncPointerContextSize</a>(<a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;Shape) &#123;</span></CodeLine>
<Link id="l01142" /><CodeLine lineNumber="1142"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Shape.<a href="/docs/api/structs/llvm/coro/shape/#a4e554c60419835fc3c74b91b28ca31c8">ABI</a> == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a24aa4117da86c41684ad25742832dfa6">coro::ABI::Async</a>);</span></CodeLine>
<Link id="l01143" /><CodeLine lineNumber="1143"></CodeLine>
<Link id="l01144" /><CodeLine lineNumber="1144"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;FuncPtrStruct = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;ConstantStruct&gt;</a>(</span></CodeLine>
<Link id="l01145" /><CodeLine lineNumber="1145"><span class="doxyHighlight">      Shape.<a href="/docs/api/structs/llvm/coro/shape/#a0cca043bc17f6f673acb6324db527dae">AsyncLowering</a>.<a href="/docs/api/structs/llvm/coro/shape/asyncloweringstorage/#a025046ebc1affc226aa470223f73794c">AsyncFuncPointer</a>-&gt;<a href="/docs/api/classes/llvm/globalvariable/#a0698d5bcabbfbca4f56a9d7a81cecb25">getInitializer</a>());</span></CodeLine>
<Link id="l01146" /><CodeLine lineNumber="1146"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;OrigRelativeFunOffset = FuncPtrStruct-&gt;getOperand(0);</span></CodeLine>
<Link id="l01147" /><CodeLine lineNumber="1147"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;OrigContextSize = FuncPtrStruct-&gt;getOperand(1);</span></CodeLine>
<Link id="l01148" /><CodeLine lineNumber="1148"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewContextSize = ConstantInt::get(OrigContextSize-&gt;getType(),</span></CodeLine>
<Link id="l01149" /><CodeLine lineNumber="1149"><span class="doxyHighlight">                                          Shape.<a href="/docs/api/structs/llvm/coro/shape/#a0cca043bc17f6f673acb6324db527dae">AsyncLowering</a>.<a href="/docs/api/structs/llvm/coro/shape/asyncloweringstorage/#a6b353e50aa2fb0fadf3c46ad81a28e00">ContextSize</a>);</span></CodeLine>
<Link id="l01150" /><CodeLine lineNumber="1150"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewFuncPtrStruct = <a href="/docs/api/classes/llvm/constantstruct/#a54fcfa620deb80373f489ba2fdad7643">ConstantStruct::get</a>(</span></CodeLine>
<Link id="l01151" /><CodeLine lineNumber="1151"><span class="doxyHighlight">      FuncPtrStruct-&gt;getType(), OrigRelativeFunOffset, NewContextSize);</span></CodeLine>
<Link id="l01152" /><CodeLine lineNumber="1152"></CodeLine>
<Link id="l01153" /><CodeLine lineNumber="1153"><span class="doxyHighlight">  Shape.<a href="/docs/api/structs/llvm/coro/shape/#a0cca043bc17f6f673acb6324db527dae">AsyncLowering</a>.<a href="/docs/api/structs/llvm/coro/shape/asyncloweringstorage/#a025046ebc1affc226aa470223f73794c">AsyncFuncPointer</a>-&gt;<a href="/docs/api/classes/llvm/globalvariable/#a095f8f031d99ce3c0b25478713293dea">setInitializer</a>(NewFuncPtrStruct);</span></CodeLine>
<Link id="l01154" /><CodeLine lineNumber="1154"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01155" /><CodeLine lineNumber="1155"></CodeLine>
<Link id="l01156" /><CodeLine lineNumber="1156" lineLink="#af1eb41cd2b90362db4ffc6eb47608943"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/typesize">TypeSize</a> <a href="#af1eb41cd2b90362db4ffc6eb47608943">getFrameSizeForShape</a>(<a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;Shape) &#123;</span></CodeLine>
<Link id="l01157" /><CodeLine lineNumber="1157"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In the same function all coro.sizes should have the same result type.</span></CodeLine>
<Link id="l01158" /><CodeLine lineNumber="1158"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;SizeIntrin = Shape.<a href="/docs/api/structs/llvm/coro/shape/#a48b7ab2f26b9e2bc67de02229a1cdd1f">CoroSizes</a>.back();</span></CodeLine>
<Link id="l01159" /><CodeLine lineNumber="1159"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/module">Module</a> &#42;M = SizeIntrin-&gt;getModule();</span></CodeLine>
<Link id="l01160" /><CodeLine lineNumber="1160"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/datalayout">DataLayout</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a> = M-&gt;getDataLayout();</span></CodeLine>
<Link id="l01161" /><CodeLine lineNumber="1161"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>.getTypeAllocSize(Shape.<a href="/docs/api/structs/llvm/coro/shape/#a24c5fed9b14aed8a3b4f3828472fbab5">FrameTy</a>);</span></CodeLine>
<Link id="l01162" /><CodeLine lineNumber="1162"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01163" /><CodeLine lineNumber="1163"></CodeLine>
<Link id="l01164" /><CodeLine lineNumber="1164" lineLink="#a8543371395854bee27033b8e24836cb0"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#a8543371395854bee27033b8e24836cb0">replaceFrameSizeAndAlignment</a>(<a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;Shape) &#123;</span></CodeLine>
<Link id="l01165" /><CodeLine lineNumber="1165"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Shape.<a href="/docs/api/structs/llvm/coro/shape/#a4e554c60419835fc3c74b91b28ca31c8">ABI</a> == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a24aa4117da86c41684ad25742832dfa6">coro::ABI::Async</a>)</span></CodeLine>
<Link id="l01166" /><CodeLine lineNumber="1166"><span class="doxyHighlight">    <a href="#ab02a4d4ecc962ea09ed6c79ebc699a54">updateAsyncFuncPointerContextSize</a>(Shape);</span></CodeLine>
<Link id="l01167" /><CodeLine lineNumber="1167"></CodeLine>
<Link id="l01168" /><CodeLine lineNumber="1168"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/coroaligninst">CoroAlignInst</a> &#42;CA : Shape.<a href="/docs/api/structs/llvm/coro/shape/#ad49b292032d2eebe5e027ab2d4445e6d">CoroAligns</a>) &#123;</span></CodeLine>
<Link id="l01169" /><CodeLine lineNumber="1169"><span class="doxyHighlight">    CA-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(</span></CodeLine>
<Link id="l01170" /><CodeLine lineNumber="1170"><span class="doxyHighlight">        ConstantInt::get(CA-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>(), Shape.<a href="/docs/api/structs/llvm/coro/shape/#a0a1a8e48ba1e5d845e979d5da8de597d">FrameAlign</a>.<a href="/docs/api/structs/llvm/align/#a80735739b49cf97a491922c8f9af2cc1">value</a>()));</span></CodeLine>
<Link id="l01171" /><CodeLine lineNumber="1171"><span class="doxyHighlight">    CA-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</span></CodeLine>
<Link id="l01172" /><CodeLine lineNumber="1172"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01173" /><CodeLine lineNumber="1173"></CodeLine>
<Link id="l01174" /><CodeLine lineNumber="1174"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Shape.<a href="/docs/api/structs/llvm/coro/shape/#a48b7ab2f26b9e2bc67de02229a1cdd1f">CoroSizes</a>.empty())</span></CodeLine>
<Link id="l01175" /><CodeLine lineNumber="1175"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01176" /><CodeLine lineNumber="1176"></CodeLine>
<Link id="l01177" /><CodeLine lineNumber="1177"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In the same function all coro.sizes should have the same result type.</span></CodeLine>
<Link id="l01178" /><CodeLine lineNumber="1178"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;SizeIntrin = Shape.<a href="/docs/api/structs/llvm/coro/shape/#a48b7ab2f26b9e2bc67de02229a1cdd1f">CoroSizes</a>.back();</span></CodeLine>
<Link id="l01179" /><CodeLine lineNumber="1179"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;SizeConstant =</span></CodeLine>
<Link id="l01180" /><CodeLine lineNumber="1180"><span class="doxyHighlight">      ConstantInt::get(SizeIntrin-&gt;getType(), <a href="#af1eb41cd2b90362db4ffc6eb47608943">getFrameSizeForShape</a>(Shape));</span></CodeLine>
<Link id="l01181" /><CodeLine lineNumber="1181"></CodeLine>
<Link id="l01182" /><CodeLine lineNumber="1182"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/corosizeinst">CoroSizeInst</a> &#42;CS : Shape.<a href="/docs/api/structs/llvm/coro/shape/#a48b7ab2f26b9e2bc67de02229a1cdd1f">CoroSizes</a>) &#123;</span></CodeLine>
<Link id="l01183" /><CodeLine lineNumber="1183"><span class="doxyHighlight">    CS-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(SizeConstant);</span></CodeLine>
<Link id="l01184" /><CodeLine lineNumber="1184"><span class="doxyHighlight">    CS-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</span></CodeLine>
<Link id="l01185" /><CodeLine lineNumber="1185"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01186" /><CodeLine lineNumber="1186"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01187" /><CodeLine lineNumber="1187"></CodeLine>
<Link id="l01188" /><CodeLine lineNumber="1188" lineLink="#ac2458e50c1358135964844abe8d8979d"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#ac2458e50c1358135964844abe8d8979d">postSplitCleanup</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l01189" /><CodeLine lineNumber="1189"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#aec88b7682025edff7984c3b6c8da8ac9">removeUnreachableBlocks</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l01190" /><CodeLine lineNumber="1190"></CodeLine>
<Link id="l01191" /><CodeLine lineNumber="1191"><span class="doxyHighlightPreprocessor">#ifndef NDEBUG</span></CodeLine>
<Link id="l01192" /><CodeLine lineNumber="1192"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For now, we do a mandatory verification step because we don&#39;t</span></CodeLine>
<Link id="l01193" /><CodeLine lineNumber="1193"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// entirely trust this pass.  Note that we don&#39;t want to add a verifier</span></CodeLine>
<Link id="l01194" /><CodeLine lineNumber="1194"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// pass to FPM below because it will also verify all the global data.</span></CodeLine>
<Link id="l01195" /><CodeLine lineNumber="1195"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a26389c546573f058ad8ecbdc5c1933cf">verifyFunction</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, &amp;<a href="/docs/api/namespaces/llvm/#a9a7b5c68c90f85baaedaa854cc5002cc">errs</a>()))</span></CodeLine>
<Link id="l01196" /><CodeLine lineNumber="1196"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(</span><span class="doxyHighlightStringLiteral">&quot;Broken function&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01197" /><CodeLine lineNumber="1197"><span class="doxyHighlightPreprocessor">#endif</span></CodeLine>
<Link id="l01198" /><CodeLine lineNumber="1198"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01199" /><CodeLine lineNumber="1199"></CodeLine>
<Link id="l01200" /><CodeLine lineNumber="1200"><span class="doxyHighlightComment">// Coroutine has no suspend points. Remove heap allocation for the coroutine</span></CodeLine>
<Link id="l01201" /><CodeLine lineNumber="1201"><span class="doxyHighlightComment">// frame if possible.</span></CodeLine>
<Link id="l01202" /><CodeLine lineNumber="1202" lineLink="#ab7881567f602c3a94d11e2817f4464e0"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#ab7881567f602c3a94d11e2817f4464e0">handleNoSuspendCoroutine</a>(<a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;Shape) &#123;</span></CodeLine>
<Link id="l01203" /><CodeLine lineNumber="1203"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CoroBegin = Shape.<a href="/docs/api/structs/llvm/coro/shape/#abfb56acef5d60fefb2edc417f0bfbda0">CoroBegin</a>;</span></CodeLine>
<Link id="l01204" /><CodeLine lineNumber="1204"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (Shape.<a href="/docs/api/structs/llvm/coro/shape/#a4e554c60419835fc3c74b91b28ca31c8">ABI</a>) &#123;</span></CodeLine>
<Link id="l01205" /><CodeLine lineNumber="1205"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">coro::ABI::Switch</a>: &#123;</span></CodeLine>
<Link id="l01206" /><CodeLine lineNumber="1206"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> SwitchId = Shape.<a href="/docs/api/structs/llvm/coro/shape/#a3660324b8035c8b52afd23e54623ddf8">getSwitchCoroId</a>();</span></CodeLine>
<Link id="l01207" /><CodeLine lineNumber="1207"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;AllocInst = SwitchId-&gt;<a href="/docs/api/classes/llvm/anycoroidinst/#adc3f7ab9023c4725ef498b410afd742d">getCoroAlloc</a>();</span></CodeLine>
<Link id="l01208" /><CodeLine lineNumber="1208"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/coro/#abf799de7147065c0e7f525e1b6009dde">coro::replaceCoroFree</a>(SwitchId, </span><span class="doxyHighlightComment">/&#42;Elide=&#42;/</span><span class="doxyHighlight">AllocInst != </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01209" /><CodeLine lineNumber="1209"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (AllocInst) &#123;</span></CodeLine>
<Link id="l01210" /><CodeLine lineNumber="1210"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> Builder(AllocInst);</span></CodeLine>
<Link id="l01211" /><CodeLine lineNumber="1211"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Frame = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a1b30cd686a320a8e5cb4532fd3a552a8">CreateAlloca</a>(Shape.<a href="/docs/api/structs/llvm/coro/shape/#a24c5fed9b14aed8a3b4f3828472fbab5">FrameTy</a>);</span></CodeLine>
<Link id="l01212" /><CodeLine lineNumber="1212"><span class="doxyHighlight">      Frame-&gt;<a href="/docs/api/classes/llvm/allocainst/#af3bb24b322533dbe8a63c84b18568fe1">setAlignment</a>(Shape.<a href="/docs/api/structs/llvm/coro/shape/#a0a1a8e48ba1e5d845e979d5da8de597d">FrameAlign</a>);</span></CodeLine>
<Link id="l01213" /><CodeLine lineNumber="1213"><span class="doxyHighlight">      AllocInst-&gt;replaceAllUsesWith(Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aaf3d3500cf7eb631e9095e87565410ed">getFalse</a>());</span></CodeLine>
<Link id="l01214" /><CodeLine lineNumber="1214"><span class="doxyHighlight">      AllocInst-&gt;eraseFromParent();</span></CodeLine>
<Link id="l01215" /><CodeLine lineNumber="1215"><span class="doxyHighlight">      CoroBegin-&gt;replaceAllUsesWith(Frame);</span></CodeLine>
<Link id="l01216" /><CodeLine lineNumber="1216"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l01217" /><CodeLine lineNumber="1217"><span class="doxyHighlight">      CoroBegin-&gt;replaceAllUsesWith(CoroBegin-&gt;getMem());</span></CodeLine>
<Link id="l01218" /><CodeLine lineNumber="1218"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01219" /><CodeLine lineNumber="1219"></CodeLine>
<Link id="l01220" /><CodeLine lineNumber="1220"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01221" /><CodeLine lineNumber="1221"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01222" /><CodeLine lineNumber="1222"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a24aa4117da86c41684ad25742832dfa6">coro::ABI::Async</a>:</span></CodeLine>
<Link id="l01223" /><CodeLine lineNumber="1223"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380aad9d7f07127e321d1358b695c8720166">coro::ABI::Retcon</a>:</span></CodeLine>
<Link id="l01224" /><CodeLine lineNumber="1224"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a6ec6c15fe79ec2274d2c3e79ae4bcc41">coro::ABI::RetconOnce</a>:</span></CodeLine>
<Link id="l01225" /><CodeLine lineNumber="1225"><span class="doxyHighlight">    CoroBegin-&gt;replaceAllUsesWith(<a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(CoroBegin-&gt;getType()));</span></CodeLine>
<Link id="l01226" /><CodeLine lineNumber="1226"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01227" /><CodeLine lineNumber="1227"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01228" /><CodeLine lineNumber="1228"></CodeLine>
<Link id="l01229" /><CodeLine lineNumber="1229"><span class="doxyHighlight">  CoroBegin-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</span></CodeLine>
<Link id="l01230" /><CodeLine lineNumber="1230"><span class="doxyHighlight">  Shape.<a href="/docs/api/structs/llvm/coro/shape/#abfb56acef5d60fefb2edc417f0bfbda0">CoroBegin</a> = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01231" /><CodeLine lineNumber="1231"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01232" /><CodeLine lineNumber="1232"></CodeLine>
<Link id="l01233" /><CodeLine lineNumber="1233"><span class="doxyHighlightComment">// SimplifySuspendPoint needs to check that there is no calls between</span></CodeLine>
<Link id="l01234" /><CodeLine lineNumber="1234"><span class="doxyHighlightComment">// coro&#95;save and coro&#95;suspend, since any of the calls may potentially resume</span></CodeLine>
<Link id="l01235" /><CodeLine lineNumber="1235"><span class="doxyHighlightComment">// the coroutine and if that is the case we cannot eliminate the suspend point.</span></CodeLine>
<Link id="l01236" /><CodeLine lineNumber="1236" lineLink="#a8d997c978c5ed505d64079540c9f5905"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#a8d997c978c5ed505d64079540c9f5905">hasCallsInBlockBetween</a>(<a href="/docs/api/classes/llvm/iterator-range">iterator&#95;range&lt;BasicBlock::iterator&gt;</a> R) &#123;</span></CodeLine>
<Link id="l01237" /><CodeLine lineNumber="1237"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : R) &#123;</span></CodeLine>
<Link id="l01238" /><CodeLine lineNumber="1238"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Assume that no intrinsic can resume the coroutine.</span></CodeLine>
<Link id="l01239" /><CodeLine lineNumber="1239"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;IntrinsicInst&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</span></CodeLine>
<Link id="l01240" /><CodeLine lineNumber="1240"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01241" /><CodeLine lineNumber="1241"></CodeLine>
<Link id="l01242" /><CodeLine lineNumber="1242"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;CallBase&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</span></CodeLine>
<Link id="l01243" /><CodeLine lineNumber="1243"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01244" /><CodeLine lineNumber="1244"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01245" /><CodeLine lineNumber="1245"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01246" /><CodeLine lineNumber="1246"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01247" /><CodeLine lineNumber="1247"></CodeLine>
<Link id="l01248" /><CodeLine lineNumber="1248" lineLink="#a44c557dcf96034410cdb25dd01c12dde"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#a44c557dcf96034410cdb25dd01c12dde">hasCallsInBlocksBetween</a>(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;SaveBB, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ResDesBB) &#123;</span></CodeLine>
<Link id="l01249" /><CodeLine lineNumber="1249"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;BasicBlock &#42;, 8&gt;</a> Set;</span></CodeLine>
<Link id="l01250" /><CodeLine lineNumber="1250"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 8&gt;</a> Worklist;</span></CodeLine>
<Link id="l01251" /><CodeLine lineNumber="1251"></CodeLine>
<Link id="l01252" /><CodeLine lineNumber="1252"><span class="doxyHighlight">  Set.insert(SaveBB);</span></CodeLine>
<Link id="l01253" /><CodeLine lineNumber="1253"><span class="doxyHighlight">  Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(ResDesBB);</span></CodeLine>
<Link id="l01254" /><CodeLine lineNumber="1254"></CodeLine>
<Link id="l01255" /><CodeLine lineNumber="1255"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Accumulate all blocks between SaveBB and ResDesBB. Because CoroSaveIntr</span></CodeLine>
<Link id="l01256" /><CodeLine lineNumber="1256"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// returns a token consumed by suspend instruction, all blocks in between</span></CodeLine>
<Link id="l01257" /><CodeLine lineNumber="1257"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// will have to eventually hit SaveBB when going backwards from ResDesBB.</span></CodeLine>
<Link id="l01258" /><CodeLine lineNumber="1258"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">while</span><span class="doxyHighlight"> (!Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>()) &#123;</span></CodeLine>
<Link id="l01259" /><CodeLine lineNumber="1259"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;BB = Worklist.<a href="/docs/api/classes/llvm/smallvectorimpl/#a0c8ffe664a36e30d49c84d0aded2fe08">pop&#95;back&#95;val</a>();</span></CodeLine>
<Link id="l01260" /><CodeLine lineNumber="1260"><span class="doxyHighlight">    Set.insert(BB);</span></CodeLine>
<Link id="l01261" /><CodeLine lineNumber="1261"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Pred : <a href="/docs/api/namespaces/llvm/#acb22fb04083152eee862457e42e8dc31">predecessors</a>(BB))</span></CodeLine>
<Link id="l01262" /><CodeLine lineNumber="1262"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Set.contains(Pred))</span></CodeLine>
<Link id="l01263" /><CodeLine lineNumber="1263"><span class="doxyHighlight">        Worklist.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(Pred);</span></CodeLine>
<Link id="l01264" /><CodeLine lineNumber="1264"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01265" /><CodeLine lineNumber="1265"></CodeLine>
<Link id="l01266" /><CodeLine lineNumber="1266"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// SaveBB and ResDesBB are checked separately in hasCallsBetween.</span></CodeLine>
<Link id="l01267" /><CodeLine lineNumber="1267"><span class="doxyHighlight">  Set.erase(SaveBB);</span></CodeLine>
<Link id="l01268" /><CodeLine lineNumber="1268"><span class="doxyHighlight">  Set.erase(ResDesBB);</span></CodeLine>
<Link id="l01269" /><CodeLine lineNumber="1269"></CodeLine>
<Link id="l01270" /><CodeLine lineNumber="1270"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;BB : Set)</span></CodeLine>
<Link id="l01271" /><CodeLine lineNumber="1271"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a8d997c978c5ed505d64079540c9f5905">hasCallsInBlockBetween</a>(&#123;BB-&gt;getFirstNonPHIIt(), BB-&gt;end()&#125;))</span></CodeLine>
<Link id="l01272" /><CodeLine lineNumber="1272"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01273" /><CodeLine lineNumber="1273"></CodeLine>
<Link id="l01274" /><CodeLine lineNumber="1274"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01275" /><CodeLine lineNumber="1275"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01276" /><CodeLine lineNumber="1276"></CodeLine>
<Link id="l01277" /><CodeLine lineNumber="1277" lineLink="#a116742dc8bd808e796becf1166383f63"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#a116742dc8bd808e796becf1166383f63">hasCallsBetween</a>(<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Save, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;ResumeOrDestroy) &#123;</span></CodeLine>
<Link id="l01278" /><CodeLine lineNumber="1278"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;SaveBB = Save-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>();</span></CodeLine>
<Link id="l01279" /><CodeLine lineNumber="1279"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;ResumeOrDestroyBB = ResumeOrDestroy-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>();</span></CodeLine>
<Link id="l01280" /><CodeLine lineNumber="1280"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> SaveIt = Save-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>();</span></CodeLine>
<Link id="l01281" /><CodeLine lineNumber="1281"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> ResumeOrDestroyIt = ResumeOrDestroy-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>();</span></CodeLine>
<Link id="l01282" /><CodeLine lineNumber="1282"></CodeLine>
<Link id="l01283" /><CodeLine lineNumber="1283"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SaveBB == ResumeOrDestroyBB)</span></CodeLine>
<Link id="l01284" /><CodeLine lineNumber="1284"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="#a8d997c978c5ed505d64079540c9f5905">hasCallsInBlockBetween</a>(&#123;std::next(SaveIt), ResumeOrDestroyIt&#125;);</span></CodeLine>
<Link id="l01285" /><CodeLine lineNumber="1285"></CodeLine>
<Link id="l01286" /><CodeLine lineNumber="1286"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Any calls from Save to the end of the block?</span></CodeLine>
<Link id="l01287" /><CodeLine lineNumber="1287"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a8d997c978c5ed505d64079540c9f5905">hasCallsInBlockBetween</a>(&#123;std::next(SaveIt), SaveBB-&gt;end()&#125;))</span></CodeLine>
<Link id="l01288" /><CodeLine lineNumber="1288"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01289" /><CodeLine lineNumber="1289"></CodeLine>
<Link id="l01290" /><CodeLine lineNumber="1290"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Any calls from begging of the block up to ResumeOrDestroy?</span></CodeLine>
<Link id="l01291" /><CodeLine lineNumber="1291"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a8d997c978c5ed505d64079540c9f5905">hasCallsInBlockBetween</a>(</span></CodeLine>
<Link id="l01292" /><CodeLine lineNumber="1292"><span class="doxyHighlight">          &#123;ResumeOrDestroyBB-&gt;getFirstNonPHIIt(), ResumeOrDestroyIt&#125;))</span></CodeLine>
<Link id="l01293" /><CodeLine lineNumber="1293"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01294" /><CodeLine lineNumber="1294"></CodeLine>
<Link id="l01295" /><CodeLine lineNumber="1295"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Any calls in all of the blocks between SaveBB and ResumeOrDestroyBB?</span></CodeLine>
<Link id="l01296" /><CodeLine lineNumber="1296"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a44c557dcf96034410cdb25dd01c12dde">hasCallsInBlocksBetween</a>(SaveBB, ResumeOrDestroyBB))</span></CodeLine>
<Link id="l01297" /><CodeLine lineNumber="1297"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01298" /><CodeLine lineNumber="1298"></CodeLine>
<Link id="l01299" /><CodeLine lineNumber="1299"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01300" /><CodeLine lineNumber="1300"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01301" /><CodeLine lineNumber="1301"></CodeLine>
<Link id="l01302" /><CodeLine lineNumber="1302"><span class="doxyHighlightComment">// If a SuspendIntrin is preceded by Resume or Destroy, we can eliminate the</span></CodeLine>
<Link id="l01303" /><CodeLine lineNumber="1303"><span class="doxyHighlightComment">// suspend point and replace it with nornal control flow.</span></CodeLine>
<Link id="l01304" /><CodeLine lineNumber="1304" lineLink="#a9f3928b341e4412b8b66b794896014f0"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#a9f3928b341e4412b8b66b794896014f0">simplifySuspendPoint</a>(<a href="/docs/api/classes/llvm/corosuspendinst">CoroSuspendInst</a> &#42;Suspend,</span></CodeLine>
<Link id="l01305" /><CodeLine lineNumber="1305"><span class="doxyHighlight">                                 <a href="/docs/api/classes/llvm/corobegininst">CoroBeginInst</a> &#42;CoroBegin) &#123;</span></CodeLine>
<Link id="l01306" /><CodeLine lineNumber="1306"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Prev = Suspend-&gt;<a href="/docs/api/classes/llvm/ilist-node-with-parent/#a1dfdcf6998ec28bfd2f8d2cdebc984a9">getPrevNode</a>();</span></CodeLine>
<Link id="l01307" /><CodeLine lineNumber="1307"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Prev) &#123;</span></CodeLine>
<Link id="l01308" /><CodeLine lineNumber="1308"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Pred = Suspend-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>()-&gt;getSinglePredecessor();</span></CodeLine>
<Link id="l01309" /><CodeLine lineNumber="1309"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Pred)</span></CodeLine>
<Link id="l01310" /><CodeLine lineNumber="1310"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01311" /><CodeLine lineNumber="1311"><span class="doxyHighlight">    Prev = Pred-&gt;getTerminator();</span></CodeLine>
<Link id="l01312" /><CodeLine lineNumber="1312"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01313" /><CodeLine lineNumber="1313"></CodeLine>
<Link id="l01314" /><CodeLine lineNumber="1314"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/callbase">CallBase</a> &#42;CB = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CallBase&gt;</a>(Prev);</span></CodeLine>
<Link id="l01315" /><CodeLine lineNumber="1315"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CB)</span></CodeLine>
<Link id="l01316" /><CodeLine lineNumber="1316"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01317" /><CodeLine lineNumber="1317"></CodeLine>
<Link id="l01318" /><CodeLine lineNumber="1318"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Callee = CB-&gt;<a href="/docs/api/classes/llvm/callbase/#a8d13199cbf4d080d3b5dcf330dad5d2c">getCalledOperand</a>()-&gt;<a href="/docs/api/classes/llvm/value/#a966eb231e7d4e572874d2cb49b18faea">stripPointerCasts</a>();</span></CodeLine>
<Link id="l01319" /><CodeLine lineNumber="1319"></CodeLine>
<Link id="l01320" /><CodeLine lineNumber="1320"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// See if the callsite is for resumption or destruction of the coroutine.</span></CodeLine>
<Link id="l01321" /><CodeLine lineNumber="1321"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;SubFn = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CoroSubFnInst&gt;</a>(Callee);</span></CodeLine>
<Link id="l01322" /><CodeLine lineNumber="1322"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!SubFn)</span></CodeLine>
<Link id="l01323" /><CodeLine lineNumber="1323"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01324" /><CodeLine lineNumber="1324"></CodeLine>
<Link id="l01325" /><CodeLine lineNumber="1325"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Does not refer to the current coroutine, we cannot do anything with it.</span></CodeLine>
<Link id="l01326" /><CodeLine lineNumber="1326"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SubFn-&gt;getFrame() != CoroBegin)</span></CodeLine>
<Link id="l01327" /><CodeLine lineNumber="1327"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01328" /><CodeLine lineNumber="1328"></CodeLine>
<Link id="l01329" /><CodeLine lineNumber="1329"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// See if the transformation is safe. Specifically, see if there are any</span></CodeLine>
<Link id="l01330" /><CodeLine lineNumber="1330"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// calls in between Save and CallInstr. They can potenitally resume the</span></CodeLine>
<Link id="l01331" /><CodeLine lineNumber="1331"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// coroutine rendering this optimization unsafe.</span></CodeLine>
<Link id="l01332" /><CodeLine lineNumber="1332"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Save = Suspend-&gt;<a href="/docs/api/classes/llvm/corosuspendinst/#aa359a0b614626b5bfafbc095eef26e04">getCoroSave</a>();</span></CodeLine>
<Link id="l01333" /><CodeLine lineNumber="1333"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a116742dc8bd808e796becf1166383f63">hasCallsBetween</a>(Save, CB))</span></CodeLine>
<Link id="l01334" /><CodeLine lineNumber="1334"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01335" /><CodeLine lineNumber="1335"></CodeLine>
<Link id="l01336" /><CodeLine lineNumber="1336"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Replace llvm.coro.suspend with the value that results in resumption over</span></CodeLine>
<Link id="l01337" /><CodeLine lineNumber="1337"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the resume or cleanup path.</span></CodeLine>
<Link id="l01338" /><CodeLine lineNumber="1338"><span class="doxyHighlight">  Suspend-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(SubFn-&gt;getRawIndex());</span></CodeLine>
<Link id="l01339" /><CodeLine lineNumber="1339"><span class="doxyHighlight">  Suspend-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</span></CodeLine>
<Link id="l01340" /><CodeLine lineNumber="1340"><span class="doxyHighlight">  Save-&gt;eraseFromParent();</span></CodeLine>
<Link id="l01341" /><CodeLine lineNumber="1341"></CodeLine>
<Link id="l01342" /><CodeLine lineNumber="1342"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// No longer need a call to coro.resume or coro.destroy.</span></CodeLine>
<Link id="l01343" /><CodeLine lineNumber="1343"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Invoke = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;InvokeInst&gt;</a>(CB)) &#123;</span></CodeLine>
<Link id="l01344" /><CodeLine lineNumber="1344"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/branchinst/#a9f40e42226cee617c16cb1c447b115c5">BranchInst::Create</a>(Invoke-&gt;getNormalDest(), Invoke-&gt;getIterator());</span></CodeLine>
<Link id="l01345" /><CodeLine lineNumber="1345"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01346" /><CodeLine lineNumber="1346"></CodeLine>
<Link id="l01347" /><CodeLine lineNumber="1347"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Grab the CalledValue from CB before erasing the CallInstr.</span></CodeLine>
<Link id="l01348" /><CodeLine lineNumber="1348"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CalledValue = CB-&gt;<a href="/docs/api/classes/llvm/callbase/#a8d13199cbf4d080d3b5dcf330dad5d2c">getCalledOperand</a>();</span></CodeLine>
<Link id="l01349" /><CodeLine lineNumber="1349"><span class="doxyHighlight">  CB-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</span></CodeLine>
<Link id="l01350" /><CodeLine lineNumber="1350"></CodeLine>
<Link id="l01351" /><CodeLine lineNumber="1351"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If no more users remove it. Usually it is a bitcast of SubFn.</span></CodeLine>
<Link id="l01352" /><CodeLine lineNumber="1352"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CalledValue != SubFn &amp;&amp; CalledValue-&gt;user&#95;empty())</span></CodeLine>
<Link id="l01353" /><CodeLine lineNumber="1353"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(CalledValue))</span></CodeLine>
<Link id="l01354" /><CodeLine lineNumber="1354"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;eraseFromParent();</span></CodeLine>
<Link id="l01355" /><CodeLine lineNumber="1355"></CodeLine>
<Link id="l01356" /><CodeLine lineNumber="1356"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Now we are good to remove SubFn.</span></CodeLine>
<Link id="l01357" /><CodeLine lineNumber="1357"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SubFn-&gt;user&#95;empty())</span></CodeLine>
<Link id="l01358" /><CodeLine lineNumber="1358"><span class="doxyHighlight">    SubFn-&gt;eraseFromParent();</span></CodeLine>
<Link id="l01359" /><CodeLine lineNumber="1359"></CodeLine>
<Link id="l01360" /><CodeLine lineNumber="1360"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01361" /><CodeLine lineNumber="1361"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01362" /><CodeLine lineNumber="1362"></CodeLine>
<Link id="l01363" /><CodeLine lineNumber="1363"><span class="doxyHighlightComment">// Remove suspend points that are simplified.</span></CodeLine>
<Link id="l01364" /><CodeLine lineNumber="1364" lineLink="#a76d02f8354cb0d3c8b30eb7812ae01b2"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#a76d02f8354cb0d3c8b30eb7812ae01b2">simplifySuspendPoints</a>(<a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;Shape) &#123;</span></CodeLine>
<Link id="l01365" /><CodeLine lineNumber="1365"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Currently, the only simplification we do is switch-lowering-specific.</span></CodeLine>
<Link id="l01366" /><CodeLine lineNumber="1366"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Shape.<a href="/docs/api/structs/llvm/coro/shape/#a4e554c60419835fc3c74b91b28ca31c8">ABI</a> != <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">coro::ABI::Switch</a>)</span></CodeLine>
<Link id="l01367" /><CodeLine lineNumber="1367"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01368" /><CodeLine lineNumber="1368"></CodeLine>
<Link id="l01369" /><CodeLine lineNumber="1369"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;S = Shape.<a href="/docs/api/structs/llvm/coro/shape/#a5fd0aa934908c837c6d78097a2fd667b">CoroSuspends</a>;</span></CodeLine>
<Link id="l01370" /><CodeLine lineNumber="1370"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">size&#95;t</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = 0, <a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a> = S.size();</span></CodeLine>
<Link id="l01371" /><CodeLine lineNumber="1371"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a> == 0)</span></CodeLine>
<Link id="l01372" /><CodeLine lineNumber="1372"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01373" /><CodeLine lineNumber="1373"></CodeLine>
<Link id="l01374" /><CodeLine lineNumber="1374"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">size&#95;t</span><span class="doxyHighlight"> ChangedFinalIndex = std::numeric&#95;limits&lt;size&#95;t&gt;::max();</span></CodeLine>
<Link id="l01375" /><CodeLine lineNumber="1375"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">while</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">) &#123;</span></CodeLine>
<Link id="l01376" /><CodeLine lineNumber="1376"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/si">SI</a> = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CoroSuspendInst&gt;</a>(S&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93;);</span></CodeLine>
<Link id="l01377" /><CodeLine lineNumber="1377"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Leave final.suspend to handleFinalSuspend since it is undefined behavior</span></CodeLine>
<Link id="l01378" /><CodeLine lineNumber="1378"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// to resume a coroutine suspended at the final suspend point.</span></CodeLine>
<Link id="l01379" /><CodeLine lineNumber="1379"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;isFinal() &amp;&amp; <a href="#a9f3928b341e4412b8b66b794896014f0">simplifySuspendPoint</a>(<a href="/docs/api/namespaces/llvm/si">SI</a>, Shape.<a href="/docs/api/structs/llvm/coro/shape/#abfb56acef5d60fefb2edc417f0bfbda0">CoroBegin</a>)) &#123;</span></CodeLine>
<Link id="l01380" /><CodeLine lineNumber="1380"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (--<a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a> == <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)</span></CodeLine>
<Link id="l01381" /><CodeLine lineNumber="1381"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01382" /><CodeLine lineNumber="1382"></CodeLine>
<Link id="l01383" /><CodeLine lineNumber="1383"><span class="doxyHighlight">      <a href="/docs/api/namespaces/std/#ab8424022895aee3e366fb9a32f2883cb">std::swap</a>(S&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93;, S&#91;<a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>&#93;);</span></CodeLine>
<Link id="l01384" /><CodeLine lineNumber="1384"></CodeLine>
<Link id="l01385" /><CodeLine lineNumber="1385"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CoroSuspendInst&gt;</a>(S&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93;)-&gt;isFinal()) &#123;</span></CodeLine>
<Link id="l01386" /><CodeLine lineNumber="1386"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Shape.<a href="/docs/api/structs/llvm/coro/shape/#abe8f7906a8618f90e2a75109a778054a">SwitchLowering</a>.<a href="/docs/api/structs/llvm/coro/shape/switchloweringstorage/#a443e8b3df70f81937afd7c6bf52f9f84">HasFinalSuspend</a>);</span></CodeLine>
<Link id="l01387" /><CodeLine lineNumber="1387"><span class="doxyHighlight">        ChangedFinalIndex = <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l01388" /><CodeLine lineNumber="1388"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01389" /><CodeLine lineNumber="1389"></CodeLine>
<Link id="l01390" /><CodeLine lineNumber="1390"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01391" /><CodeLine lineNumber="1391"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01392" /><CodeLine lineNumber="1392"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> == <a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>)</span></CodeLine>
<Link id="l01393" /><CodeLine lineNumber="1393"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01394" /><CodeLine lineNumber="1394"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01395" /><CodeLine lineNumber="1395"><span class="doxyHighlight">  S.resize(<a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>);</span></CodeLine>
<Link id="l01396" /><CodeLine lineNumber="1396"></CodeLine>
<Link id="l01397" /><CodeLine lineNumber="1397"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Maintain final.suspend in case final suspend was swapped.</span></CodeLine>
<Link id="l01398" /><CodeLine lineNumber="1398"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Due to we requrie the final suspend to be the last element of CoroSuspends.</span></CodeLine>
<Link id="l01399" /><CodeLine lineNumber="1399"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ChangedFinalIndex &lt; <a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>) &#123;</span></CodeLine>
<Link id="l01400" /><CodeLine lineNumber="1400"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CoroSuspendInst&gt;</a>(S&#91;ChangedFinalIndex&#93;)-&gt;isFinal());</span></CodeLine>
<Link id="l01401" /><CodeLine lineNumber="1401"><span class="doxyHighlight">    <a href="/docs/api/namespaces/std/#ab8424022895aee3e366fb9a32f2883cb">std::swap</a>(S&#91;ChangedFinalIndex&#93;, S.back());</span></CodeLine>
<Link id="l01402" /><CodeLine lineNumber="1402"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01403" /><CodeLine lineNumber="1403"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01404" /><CodeLine lineNumber="1404"></CodeLine>
<Link id="l01405" /><CodeLine lineNumber="1405"><span class="doxyHighlightKeyword">namespace </span><span class="doxyHighlight">&#123;</span></CodeLine>
<Link id="l01406" /><CodeLine lineNumber="1406"></CodeLine>
<Link id="l01407" /><CodeLine lineNumber="1407" lineLink="/docs/api/structs/anonymous-namespace-corosplit-cpp-/switchcoroutinesplitter"><span class="doxyHighlightKeyword">struct </span><span class="doxyHighlight"><a href="/docs/api/structs/anonymous-namespace-corosplit-cpp-/switchcoroutinesplitter">SwitchCoroutineSplitter</a> &#123;</span></CodeLine>
<Link id="l01408" /><CodeLine lineNumber="1408" lineLink="/docs/api/structs/anonymous-namespace-corosplit-cpp-/switchcoroutinesplitter/#af34178528cc721dfa273965733da1f37"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/structs/anonymous-namespace-corosplit-cpp-/switchcoroutinesplitter/#af34178528cc721dfa273965733da1f37">split</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;Shape,</span></CodeLine>
<Link id="l01409" /><CodeLine lineNumber="1409"><span class="doxyHighlight">                    <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;Function &#42;&gt;</a> &amp;Clones,</span></CodeLine>
<Link id="l01410" /><CodeLine lineNumber="1410"><span class="doxyHighlight">                    <a href="/docs/api/classes/llvm/targettransforminfo">TargetTransformInfo</a> &amp;<a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>) &#123;</span></CodeLine>
<Link id="l01411" /><CodeLine lineNumber="1411"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Shape.<a href="/docs/api/structs/llvm/coro/shape/#a4e554c60419835fc3c74b91b28ca31c8">ABI</a> == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">coro::ABI::Switch</a>);</span></CodeLine>
<Link id="l01412" /><CodeLine lineNumber="1412"></CodeLine>
<Link id="l01413" /><CodeLine lineNumber="1413"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a91897d2d0da113b016f14ae110586ab1">MetadataSetTy</a> CommonDebugInfo&#123;<a href="/docs/api/namespaces/anonymous-corosplit-cpp-/#a9d81a7f738bbf6c1cd81fdca9ba2bc99">collectCommonDebugInfo</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>)&#125;;</span></CodeLine>
<Link id="l01414" /><CodeLine lineNumber="1414"></CodeLine>
<Link id="l01415" /><CodeLine lineNumber="1415"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Create a resume clone by cloning the body of the original function,</span></CodeLine>
<Link id="l01416" /><CodeLine lineNumber="1416"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// setting new entry block and replacing coro.suspend an appropriate value</span></CodeLine>
<Link id="l01417" /><CodeLine lineNumber="1417"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// to force resume or cleanup pass for every suspend point.</span></CodeLine>
<Link id="l01418" /><CodeLine lineNumber="1418"><span class="doxyHighlight">    createResumeEntryBlock(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, Shape);</span></CodeLine>
<Link id="l01419" /><CodeLine lineNumber="1419"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;ResumeClone = <a href="/docs/api/classes/llvm/coro/switchcloner/#a4e4793514f814a12dc765fc5cdefb996">coro::SwitchCloner::createClone</a>(</span></CodeLine>
<Link id="l01420" /><CodeLine lineNumber="1420"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, </span><span class="doxyHighlightStringLiteral">&quot;.resume&quot;</span><span class="doxyHighlight">, Shape, <a href="/docs/api/namespaces/llvm/coro/#ad5c7ebab0ec481424c33db8902c652f4ae58f565eb9e7a17b331c3eda53da8fc2">coro::CloneKind::SwitchResume</a>, <a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>,</span></CodeLine>
<Link id="l01421" /><CodeLine lineNumber="1421"><span class="doxyHighlight">        CommonDebugInfo);</span></CodeLine>
<Link id="l01422" /><CodeLine lineNumber="1422"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;DestroyClone = <a href="/docs/api/classes/llvm/coro/switchcloner/#a4e4793514f814a12dc765fc5cdefb996">coro::SwitchCloner::createClone</a>(</span></CodeLine>
<Link id="l01423" /><CodeLine lineNumber="1423"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, </span><span class="doxyHighlightStringLiteral">&quot;.destroy&quot;</span><span class="doxyHighlight">, Shape, <a href="/docs/api/namespaces/llvm/coro/#ad5c7ebab0ec481424c33db8902c652f4af04bd27f8437836c71e2e1504acc18c8">coro::CloneKind::SwitchUnwind</a>, <a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>,</span></CodeLine>
<Link id="l01424" /><CodeLine lineNumber="1424"><span class="doxyHighlight">        CommonDebugInfo);</span></CodeLine>
<Link id="l01425" /><CodeLine lineNumber="1425"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CleanupClone = <a href="/docs/api/classes/llvm/coro/switchcloner/#a4e4793514f814a12dc765fc5cdefb996">coro::SwitchCloner::createClone</a>(</span></CodeLine>
<Link id="l01426" /><CodeLine lineNumber="1426"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, </span><span class="doxyHighlightStringLiteral">&quot;.cleanup&quot;</span><span class="doxyHighlight">, Shape, <a href="/docs/api/namespaces/llvm/coro/#ad5c7ebab0ec481424c33db8902c652f4a2c249a520c88badf6f400e74f26ce424">coro::CloneKind::SwitchCleanup</a>, <a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>,</span></CodeLine>
<Link id="l01427" /><CodeLine lineNumber="1427"><span class="doxyHighlight">        CommonDebugInfo);</span></CodeLine>
<Link id="l01428" /><CodeLine lineNumber="1428"></CodeLine>
<Link id="l01429" /><CodeLine lineNumber="1429"><span class="doxyHighlight">    <a href="#ac2458e50c1358135964844abe8d8979d">postSplitCleanup</a>(&#42;ResumeClone);</span></CodeLine>
<Link id="l01430" /><CodeLine lineNumber="1430"><span class="doxyHighlight">    <a href="#ac2458e50c1358135964844abe8d8979d">postSplitCleanup</a>(&#42;DestroyClone);</span></CodeLine>
<Link id="l01431" /><CodeLine lineNumber="1431"><span class="doxyHighlight">    <a href="#ac2458e50c1358135964844abe8d8979d">postSplitCleanup</a>(&#42;CleanupClone);</span></CodeLine>
<Link id="l01432" /><CodeLine lineNumber="1432"></CodeLine>
<Link id="l01433" /><CodeLine lineNumber="1433"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Store addresses resume/destroy/cleanup functions in the coroutine frame.</span></CodeLine>
<Link id="l01434" /><CodeLine lineNumber="1434"><span class="doxyHighlight">    updateCoroFrame(Shape, ResumeClone, DestroyClone, CleanupClone);</span></CodeLine>
<Link id="l01435" /><CodeLine lineNumber="1435"></CodeLine>
<Link id="l01436" /><CodeLine lineNumber="1436"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Clones.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>());</span></CodeLine>
<Link id="l01437" /><CodeLine lineNumber="1437"><span class="doxyHighlight">    Clones.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(ResumeClone);</span></CodeLine>
<Link id="l01438" /><CodeLine lineNumber="1438"><span class="doxyHighlight">    Clones.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(DestroyClone);</span></CodeLine>
<Link id="l01439" /><CodeLine lineNumber="1439"><span class="doxyHighlight">    Clones.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(CleanupClone);</span></CodeLine>
<Link id="l01440" /><CodeLine lineNumber="1440"></CodeLine>
<Link id="l01441" /><CodeLine lineNumber="1441"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Create a constant array referring to resume/destroy/clone functions</span></CodeLine>
<Link id="l01442" /><CodeLine lineNumber="1442"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// pointed by the last argument of @llvm.coro.info, so that CoroElide pass</span></CodeLine>
<Link id="l01443" /><CodeLine lineNumber="1443"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// can determined correct function to call.</span></CodeLine>
<Link id="l01444" /><CodeLine lineNumber="1444"><span class="doxyHighlight">    setCoroInfo(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, Shape, Clones);</span></CodeLine>
<Link id="l01445" /><CodeLine lineNumber="1445"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01446" /><CodeLine lineNumber="1446"></CodeLine>
<Link id="l01447" /><CodeLine lineNumber="1447"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create a variant of ramp function that does not perform heap allocation</span></CodeLine>
<Link id="l01448" /><CodeLine lineNumber="1448"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// for a switch ABI coroutine.</span></CodeLine>
<Link id="l01449" /><CodeLine lineNumber="1449"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01450" /><CodeLine lineNumber="1450"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The newly split &#96;.noalloc&#96; ramp function has the following differences:</span></CodeLine>
<Link id="l01451" /><CodeLine lineNumber="1451"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  - Has one additional frame pointer parameter in lieu of dynamic</span></CodeLine>
<Link id="l01452" /><CodeLine lineNumber="1452"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  allocation.</span></CodeLine>
<Link id="l01453" /><CodeLine lineNumber="1453"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  - Suppressed allocations by replacing coro.alloc and coro.free.</span></CodeLine>
<Link id="l01454" /><CodeLine lineNumber="1454" lineLink="/docs/api/structs/anonymous-namespace-corosplit-cpp-/switchcoroutinesplitter/#af0793991541abccfec5c0d8831612b7b"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/function">Function</a> &#42;<a href="/docs/api/structs/anonymous-namespace-corosplit-cpp-/switchcoroutinesplitter/#af0793991541abccfec5c0d8831612b7b">createNoAllocVariant</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;Shape,</span></CodeLine>
<Link id="l01455" /><CodeLine lineNumber="1455"><span class="doxyHighlight">                                        <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;Function &#42;&gt;</a> &amp;Clones) &#123;</span></CodeLine>
<Link id="l01456" /><CodeLine lineNumber="1456"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Shape.<a href="/docs/api/structs/llvm/coro/shape/#a4e554c60419835fc3c74b91b28ca31c8">ABI</a> == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">coro::ABI::Switch</a>);</span></CodeLine>
<Link id="l01457" /><CodeLine lineNumber="1457"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;OrigFnTy = <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getFunctionType();</span></CodeLine>
<Link id="l01458" /><CodeLine lineNumber="1458"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> OldParams = OrigFnTy-&gt;params();</span></CodeLine>
<Link id="l01459" /><CodeLine lineNumber="1459"></CodeLine>
<Link id="l01460" /><CodeLine lineNumber="1460"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Type &#42;&gt;</a> NewParams;</span></CodeLine>
<Link id="l01461" /><CodeLine lineNumber="1461"><span class="doxyHighlight">    NewParams.<a href="/docs/api/classes/llvm/smallvectorimpl/#a499ea32ca1b8d16cedfe01d1e5b08f29">reserve</a>(OldParams.size() + 1);</span></CodeLine>
<Link id="l01462" /><CodeLine lineNumber="1462"><span class="doxyHighlight">    NewParams.<a href="/docs/api/classes/llvm/smallvectorimpl/#a7efd1f0c1206d95e4fe01a9b49a57b82">append</a>(OldParams.begin(), OldParams.end());</span></CodeLine>
<Link id="l01463" /><CodeLine lineNumber="1463"><span class="doxyHighlight">    NewParams.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(<a href="/docs/api/classes/llvm/pointertype/#af8a1dbdbfd89aa4899b3c0d39495d0dd">PointerType::getUnqual</a>(Shape.<a href="/docs/api/structs/llvm/coro/shape/#a24c5fed9b14aed8a3b4f3828472fbab5">FrameTy</a>-&gt;<a href="/docs/api/classes/llvm/type/#a909eca4ba9e5eefc203c8e3770bdab25">getContext</a>()));</span></CodeLine>
<Link id="l01464" /><CodeLine lineNumber="1464"></CodeLine>
<Link id="l01465" /><CodeLine lineNumber="1465"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewFnTy = <a href="/docs/api/classes/llvm/functiontype/#af8be7844c269f201ebcee1e15048c378">FunctionType::get</a>(OrigFnTy-&gt;getReturnType(), NewParams,</span></CodeLine>
<Link id="l01466" /><CodeLine lineNumber="1466"><span class="doxyHighlight">                                      OrigFnTy-&gt;isVarArg());</span></CodeLine>
<Link id="l01467" /><CodeLine lineNumber="1467"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/function">Function</a> &#42;NoAllocF =</span></CodeLine>
<Link id="l01468" /><CodeLine lineNumber="1468"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/function/#a05d7aedbbdc0fd24e8bc27edfe9c603f">Function::Create</a>(NewFnTy, <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getLinkage(), <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getName() + </span><span class="doxyHighlightStringLiteral">&quot;.noalloc&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01469" /><CodeLine lineNumber="1469"></CodeLine>
<Link id="l01470" /><CodeLine lineNumber="1470"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> VMap;</span></CodeLine>
<Link id="l01471" /><CodeLine lineNumber="1471"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> Idx = 0;</span></CodeLine>
<Link id="l01472" /><CodeLine lineNumber="1472"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.args()) &#123;</span></CodeLine>
<Link id="l01473" /><CodeLine lineNumber="1473"><span class="doxyHighlight">      VMap&#91;&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; = NoAllocF-&gt;<a href="/docs/api/classes/llvm/function/#aecf2b6d6f052a378dd8f69fd1bb700b1">getArg</a>(Idx++);</span></CodeLine>
<Link id="l01474" /><CodeLine lineNumber="1474"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01475" /><CodeLine lineNumber="1475"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We just appended the frame pointer as the last argument of the new</span></CodeLine>
<Link id="l01476" /><CodeLine lineNumber="1476"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// function.</span></CodeLine>
<Link id="l01477" /><CodeLine lineNumber="1477"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> FrameIdx = NoAllocF-&gt;<a href="/docs/api/classes/llvm/function/#ac6baa801e4aea800984e760d5460662f">arg&#95;size</a>() - 1;</span></CodeLine>
<Link id="l01478" /><CodeLine lineNumber="1478"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;ReturnInst &#42;, 4&gt;</a> Returns;</span></CodeLine>
<Link id="l01479" /><CodeLine lineNumber="1479"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#ac1b2be839460bb277d4f07f4aa5225ac">CloneFunctionInto</a>(NoAllocF, &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, VMap,</span></CodeLine>
<Link id="l01480" /><CodeLine lineNumber="1480"><span class="doxyHighlight">                      <a href="/docs/api/namespaces/llvm/#abe00617fc34ceb1aa0eb62995732b30aa68b46a44773674a07e6730fac74fc46b">CloneFunctionChangeType::LocalChangesOnly</a>, Returns);</span></CodeLine>
<Link id="l01481" /><CodeLine lineNumber="1481"></CodeLine>
<Link id="l01482" /><CodeLine lineNumber="1482"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Shape.<a href="/docs/api/structs/llvm/coro/shape/#abfb56acef5d60fefb2edc417f0bfbda0">CoroBegin</a>) &#123;</span></CodeLine>
<Link id="l01483" /><CodeLine lineNumber="1483"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewCoroBegin =</span></CodeLine>
<Link id="l01484" /><CodeLine lineNumber="1484"><span class="doxyHighlight">          <a href="/docs/api/namespaces/llvm/#a07be078de4a2c223bd6a76e24e1c02db">cast&#95;if&#95;present&lt;CoroBeginInst&gt;</a>(VMap&#91;Shape.<a href="/docs/api/structs/llvm/coro/shape/#abfb56acef5d60fefb2edc417f0bfbda0">CoroBegin</a>&#93;);</span></CodeLine>
<Link id="l01485" /><CodeLine lineNumber="1485"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewCoroId = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CoroIdInst&gt;</a>(NewCoroBegin-&gt;getId());</span></CodeLine>
<Link id="l01486" /><CodeLine lineNumber="1486"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/coro/#abf799de7147065c0e7f525e1b6009dde">coro::replaceCoroFree</a>(NewCoroId, </span><span class="doxyHighlightComment">/&#42;Elide=&#42;/</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01487" /><CodeLine lineNumber="1487"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/coro/#a7223c62dc4b1db59861cb3a7e225a387">coro::suppressCoroAllocs</a>(NewCoroId);</span></CodeLine>
<Link id="l01488" /><CodeLine lineNumber="1488"><span class="doxyHighlight">      NewCoroBegin-&gt;replaceAllUsesWith(NoAllocF-&gt;<a href="/docs/api/classes/llvm/function/#aecf2b6d6f052a378dd8f69fd1bb700b1">getArg</a>(FrameIdx));</span></CodeLine>
<Link id="l01489" /><CodeLine lineNumber="1489"><span class="doxyHighlight">      NewCoroBegin-&gt;eraseFromParent();</span></CodeLine>
<Link id="l01490" /><CodeLine lineNumber="1490"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01491" /><CodeLine lineNumber="1491"></CodeLine>
<Link id="l01492" /><CodeLine lineNumber="1492"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/module">Module</a> &#42;M = <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getParent();</span></CodeLine>
<Link id="l01493" /><CodeLine lineNumber="1493"><span class="doxyHighlight">    M-&gt;getFunctionList().insert(M-&gt;end(), NoAllocF);</span></CodeLine>
<Link id="l01494" /><CodeLine lineNumber="1494"></CodeLine>
<Link id="l01495" /><CodeLine lineNumber="1495"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#aec88b7682025edff7984c3b6c8da8ac9">removeUnreachableBlocks</a>(&#42;NoAllocF);</span></CodeLine>
<Link id="l01496" /><CodeLine lineNumber="1496"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> NewAttrs = NoAllocF-&gt;<a href="/docs/api/classes/llvm/function/#a7477aafbbe989ad35b96fac186d8e9fd">getAttributes</a>();</span></CodeLine>
<Link id="l01497" /><CodeLine lineNumber="1497"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// When we elide allocation, we read these attributes to determine the</span></CodeLine>
<Link id="l01498" /><CodeLine lineNumber="1498"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// frame size and alignment.</span></CodeLine>
<Link id="l01499" /><CodeLine lineNumber="1499"><span class="doxyHighlight">    <a href="#a7c497627acf5128770bd9fa245b44fbd">addFramePointerAttrs</a>(NewAttrs, NoAllocF-&gt;<a href="/docs/api/classes/llvm/function/#a9fffac2512fe651f0d5e37e27f5bd51c">getContext</a>(), FrameIdx,</span></CodeLine>
<Link id="l01500" /><CodeLine lineNumber="1500"><span class="doxyHighlight">                         Shape.<a href="/docs/api/structs/llvm/coro/shape/#a742806b2e667a87817ae171e1ec59826">FrameSize</a>, Shape.<a href="/docs/api/structs/llvm/coro/shape/#a0a1a8e48ba1e5d845e979d5da8de597d">FrameAlign</a>,</span></CodeLine>
<Link id="l01501" /><CodeLine lineNumber="1501"><span class="doxyHighlight">                         </span><span class="doxyHighlightComment">/&#42;NoAlias=&#42;/</span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01502" /><CodeLine lineNumber="1502"></CodeLine>
<Link id="l01503" /><CodeLine lineNumber="1503"><span class="doxyHighlight">    NoAllocF-&gt;<a href="/docs/api/classes/llvm/function/#a9e4c6c67f4b2528b5648299db4a86926">setAttributes</a>(NewAttrs);</span></CodeLine>
<Link id="l01504" /><CodeLine lineNumber="1504"></CodeLine>
<Link id="l01505" /><CodeLine lineNumber="1505"><span class="doxyHighlight">    Clones.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(NoAllocF);</span></CodeLine>
<Link id="l01506" /><CodeLine lineNumber="1506"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Reset the original function&#39;s coro info, make the new noalloc variant</span></CodeLine>
<Link id="l01507" /><CodeLine lineNumber="1507"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// connected to the original ramp function.</span></CodeLine>
<Link id="l01508" /><CodeLine lineNumber="1508"><span class="doxyHighlight">    setCoroInfo(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, Shape, Clones);</span></CodeLine>
<Link id="l01509" /><CodeLine lineNumber="1509"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// After copying, set the linkage to internal linkage. Original function</span></CodeLine>
<Link id="l01510" /><CodeLine lineNumber="1510"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// may have different linkage, but optimization dependent on this function</span></CodeLine>
<Link id="l01511" /><CodeLine lineNumber="1511"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// generally relies on LTO.</span></CodeLine>
<Link id="l01512" /><CodeLine lineNumber="1512"><span class="doxyHighlight">    NoAllocF-&gt;<a href="/docs/api/classes/llvm/globalvalue/#a687973de03d041e04b50a76d19d4fd36">setLinkage</a>(<a href="/docs/api/classes/llvm/globalvalue/#aedfa75f0c85c4aa85b257f066fbea57ca1511edd03e02d1f3dd277a3c6abf6ad5">llvm::GlobalValue::InternalLinkage</a>);</span></CodeLine>
<Link id="l01513" /><CodeLine lineNumber="1513"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> NoAllocF;</span></CodeLine>
<Link id="l01514" /><CodeLine lineNumber="1514"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01515" /><CodeLine lineNumber="1515"></CodeLine>
<Link id="l01516" /><CodeLine lineNumber="1516"><span class="doxyHighlightKeyword">private</span><span class="doxyHighlight">:</span></CodeLine>
<Link id="l01517" /><CodeLine lineNumber="1517"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create an entry block for a resume function with a switch that will jump to</span></CodeLine>
<Link id="l01518" /><CodeLine lineNumber="1518"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// suspend points.</span></CodeLine>
<Link id="l01519" /><CodeLine lineNumber="1519"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> createResumeEntryBlock(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;Shape) &#123;</span></CodeLine>
<Link id="l01520" /><CodeLine lineNumber="1520"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/llvmcontext">LLVMContext</a> &amp;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a> = <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getContext();</span></CodeLine>
<Link id="l01521" /><CodeLine lineNumber="1521"></CodeLine>
<Link id="l01522" /><CodeLine lineNumber="1522"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// resume.entry:</span></CodeLine>
<Link id="l01523" /><CodeLine lineNumber="1523"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//  %index.addr = getelementptr inbounds %f.Frame, %f.Frame&#42; %FramePtr, i32</span></CodeLine>
<Link id="l01524" /><CodeLine lineNumber="1524"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//  0, i32 2 % index = load i32, i32&#42; %index.addr switch i32 %index, label</span></CodeLine>
<Link id="l01525" /><CodeLine lineNumber="1525"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//  %unreachable &#91;</span></CodeLine>
<Link id="l01526" /><CodeLine lineNumber="1526"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//    i32 0, label %resume.0</span></CodeLine>
<Link id="l01527" /><CodeLine lineNumber="1527"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//    i32 1, label %resume.1</span></CodeLine>
<Link id="l01528" /><CodeLine lineNumber="1528"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//    ...</span></CodeLine>
<Link id="l01529" /><CodeLine lineNumber="1529"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//  &#93;</span></CodeLine>
<Link id="l01530" /><CodeLine lineNumber="1530"></CodeLine>
<Link id="l01531" /><CodeLine lineNumber="1531"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewEntry = <a href="/docs/api/classes/llvm/basicblock/#a4a5b798214be930cf8e133c032ba0129">BasicBlock::Create</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, </span><span class="doxyHighlightStringLiteral">&quot;resume.entry&quot;</span><span class="doxyHighlight">, &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l01532" /><CodeLine lineNumber="1532"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;UnreachBB = <a href="/docs/api/classes/llvm/basicblock/#a4a5b798214be930cf8e133c032ba0129">BasicBlock::Create</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, </span><span class="doxyHighlightStringLiteral">&quot;unreachable&quot;</span><span class="doxyHighlight">, &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l01533" /><CodeLine lineNumber="1533"></CodeLine>
<Link id="l01534" /><CodeLine lineNumber="1534"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> Builder(NewEntry);</span></CodeLine>
<Link id="l01535" /><CodeLine lineNumber="1535"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a> = Shape.<a href="/docs/api/structs/llvm/coro/shape/#a5eac2988672b484645dcbcd706430967">FramePtr</a>;</span></CodeLine>
<Link id="l01536" /><CodeLine lineNumber="1536"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;FrameTy = Shape.<a href="/docs/api/structs/llvm/coro/shape/#a24c5fed9b14aed8a3b4f3828472fbab5">FrameTy</a>;</span></CodeLine>
<Link id="l01537" /><CodeLine lineNumber="1537"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;GepIndex = Builder.CreateStructGEP(</span></CodeLine>
<Link id="l01538" /><CodeLine lineNumber="1538"><span class="doxyHighlight">        FrameTy, <a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>, Shape.<a href="/docs/api/structs/llvm/coro/shape/#aedc5db661c24859142b1b7a67dc05ba7">getSwitchIndexField</a>(), </span><span class="doxyHighlightStringLiteral">&quot;index.addr&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01539" /><CodeLine lineNumber="1539"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Index = Builder.CreateLoad(Shape.<a href="/docs/api/structs/llvm/coro/shape/#a22c53726eaeafbc188994ecbc7e27674">getIndexType</a>(), GepIndex, </span><span class="doxyHighlightStringLiteral">&quot;index&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01540" /><CodeLine lineNumber="1540"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Switch =</span></CodeLine>
<Link id="l01541" /><CodeLine lineNumber="1541"><span class="doxyHighlight">        Builder.CreateSwitch(Index, UnreachBB, Shape.<a href="/docs/api/structs/llvm/coro/shape/#a5fd0aa934908c837c6d78097a2fd667b">CoroSuspends</a>.size());</span></CodeLine>
<Link id="l01542" /><CodeLine lineNumber="1542"><span class="doxyHighlight">    Shape.<a href="/docs/api/structs/llvm/coro/shape/#abe8f7906a8618f90e2a75109a778054a">SwitchLowering</a>.<a href="/docs/api/structs/llvm/coro/shape/switchloweringstorage/#ab9ff52a8227ec3fe5547af29ed59622f">ResumeSwitch</a> = Switch;</span></CodeLine>
<Link id="l01543" /><CodeLine lineNumber="1543"></CodeLine>
<Link id="l01544" /><CodeLine lineNumber="1544"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">size&#95;t</span><span class="doxyHighlight"> SuspendIndex = 0;</span></CodeLine>
<Link id="l01545" /><CodeLine lineNumber="1545"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;AnyS : Shape.<a href="/docs/api/structs/llvm/coro/shape/#a5fd0aa934908c837c6d78097a2fd667b">CoroSuspends</a>) &#123;</span></CodeLine>
<Link id="l01546" /><CodeLine lineNumber="1546"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;S = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CoroSuspendInst&gt;</a>(AnyS);</span></CodeLine>
<Link id="l01547" /><CodeLine lineNumber="1547"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;IndexVal = Shape.<a href="/docs/api/structs/llvm/coro/shape/#a9e8a88398e176735a277b77269570c50">getIndex</a>(SuspendIndex);</span></CodeLine>
<Link id="l01548" /><CodeLine lineNumber="1548"></CodeLine>
<Link id="l01549" /><CodeLine lineNumber="1549"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Replace CoroSave with a store to Index:</span></CodeLine>
<Link id="l01550" /><CodeLine lineNumber="1550"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//    %index.addr = getelementptr %f.frame... (index field number)</span></CodeLine>
<Link id="l01551" /><CodeLine lineNumber="1551"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//    store i32 %IndexVal, i32&#42; %index.addr1</span></CodeLine>
<Link id="l01552" /><CodeLine lineNumber="1552"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Save = S-&gt;getCoroSave();</span></CodeLine>
<Link id="l01553" /><CodeLine lineNumber="1553"><span class="doxyHighlight">      Builder.SetInsertPoint(Save);</span></CodeLine>
<Link id="l01554" /><CodeLine lineNumber="1554"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (S-&gt;isFinal()) &#123;</span></CodeLine>
<Link id="l01555" /><CodeLine lineNumber="1555"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// The coroutine should be marked done if it reaches the final suspend</span></CodeLine>
<Link id="l01556" /><CodeLine lineNumber="1556"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// point.</span></CodeLine>
<Link id="l01557" /><CodeLine lineNumber="1557"><span class="doxyHighlight">        <a href="#aa6734dd82cf736e89074802287b0abfe">markCoroutineAsDone</a>(Builder, Shape, <a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>);</span></CodeLine>
<Link id="l01558" /><CodeLine lineNumber="1558"><span class="doxyHighlight">      &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l01559" /><CodeLine lineNumber="1559"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;GepIndex = Builder.CreateStructGEP(</span></CodeLine>
<Link id="l01560" /><CodeLine lineNumber="1560"><span class="doxyHighlight">            FrameTy, <a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>, Shape.<a href="/docs/api/structs/llvm/coro/shape/#aedc5db661c24859142b1b7a67dc05ba7">getSwitchIndexField</a>(), </span><span class="doxyHighlightStringLiteral">&quot;index.addr&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01561" /><CodeLine lineNumber="1561"><span class="doxyHighlight">        Builder.CreateStore(IndexVal, GepIndex);</span></CodeLine>
<Link id="l01562" /><CodeLine lineNumber="1562"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01563" /><CodeLine lineNumber="1563"></CodeLine>
<Link id="l01564" /><CodeLine lineNumber="1564"><span class="doxyHighlight">      Save-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(<a href="/docs/api/classes/llvm/constanttokennone/#a8e29fb8e39fb67b3bb746dbba47fcb29">ConstantTokenNone::get</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>));</span></CodeLine>
<Link id="l01565" /><CodeLine lineNumber="1565"><span class="doxyHighlight">      Save-&gt;eraseFromParent();</span></CodeLine>
<Link id="l01566" /><CodeLine lineNumber="1566"></CodeLine>
<Link id="l01567" /><CodeLine lineNumber="1567"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Split block before and after coro.suspend and add a jump from an entry</span></CodeLine>
<Link id="l01568" /><CodeLine lineNumber="1568"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// switch:</span></CodeLine>
<Link id="l01569" /><CodeLine lineNumber="1569"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01570" /><CodeLine lineNumber="1570"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//  whateverBB:</span></CodeLine>
<Link id="l01571" /><CodeLine lineNumber="1571"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//    whatever</span></CodeLine>
<Link id="l01572" /><CodeLine lineNumber="1572"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//    %0 = call i8 @llvm.coro.suspend(token none, i1 false)</span></CodeLine>
<Link id="l01573" /><CodeLine lineNumber="1573"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//    switch i8 %0, label %suspend&#91;i8 0, label %resume</span></CodeLine>
<Link id="l01574" /><CodeLine lineNumber="1574"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//                                 i8 1, label %cleanup&#93;</span></CodeLine>
<Link id="l01575" /><CodeLine lineNumber="1575"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// becomes:</span></CodeLine>
<Link id="l01576" /><CodeLine lineNumber="1576"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01577" /><CodeLine lineNumber="1577"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//  whateverBB:</span></CodeLine>
<Link id="l01578" /><CodeLine lineNumber="1578"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//     whatever</span></CodeLine>
<Link id="l01579" /><CodeLine lineNumber="1579"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//     br label %resume.0.landing</span></CodeLine>
<Link id="l01580" /><CodeLine lineNumber="1580"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01581" /><CodeLine lineNumber="1581"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//  resume.0: ; &lt;--- jump from the switch in the resume.entry</span></CodeLine>
<Link id="l01582" /><CodeLine lineNumber="1582"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//     %0 = tail call i8 @llvm.coro.suspend(token none, i1 false)</span></CodeLine>
<Link id="l01583" /><CodeLine lineNumber="1583"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//     br label %resume.0.landing</span></CodeLine>
<Link id="l01584" /><CodeLine lineNumber="1584"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01585" /><CodeLine lineNumber="1585"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//  resume.0.landing:</span></CodeLine>
<Link id="l01586" /><CodeLine lineNumber="1586"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//     %1 = phi i8&#91;-1, %whateverBB&#93;, &#91;%0, %resume.0&#93;</span></CodeLine>
<Link id="l01587" /><CodeLine lineNumber="1587"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//     switch i8 % 1, label %suspend &#91;i8 0, label %resume</span></CodeLine>
<Link id="l01588" /><CodeLine lineNumber="1588"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//                                    i8 1, label %cleanup&#93;</span></CodeLine>
<Link id="l01589" /><CodeLine lineNumber="1589"></CodeLine>
<Link id="l01590" /><CodeLine lineNumber="1590"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;SuspendBB = S-&gt;getParent();</span></CodeLine>
<Link id="l01591" /><CodeLine lineNumber="1591"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;ResumeBB =</span></CodeLine>
<Link id="l01592" /><CodeLine lineNumber="1592"><span class="doxyHighlight">          SuspendBB-&gt;splitBasicBlock(S, </span><span class="doxyHighlightStringLiteral">&quot;resume.&quot;</span><span class="doxyHighlight"> + Twine(SuspendIndex));</span></CodeLine>
<Link id="l01593" /><CodeLine lineNumber="1593"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;LandingBB = ResumeBB-&gt;splitBasicBlock(</span></CodeLine>
<Link id="l01594" /><CodeLine lineNumber="1594"><span class="doxyHighlight">          S-&gt;getNextNode(), ResumeBB-&gt;getName() + Twine(</span><span class="doxyHighlightStringLiteral">&quot;.landing&quot;</span><span class="doxyHighlight">));</span></CodeLine>
<Link id="l01595" /><CodeLine lineNumber="1595"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">Switch</a>-&gt;addCase(IndexVal, ResumeBB);</span></CodeLine>
<Link id="l01596" /><CodeLine lineNumber="1596"></CodeLine>
<Link id="l01597" /><CodeLine lineNumber="1597"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BranchInst&gt;</a>(SuspendBB-&gt;getTerminator())-&gt;setSuccessor(0, LandingBB);</span></CodeLine>
<Link id="l01598" /><CodeLine lineNumber="1598"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;PN = <a href="/docs/api/classes/llvm/phinode/#af4aba918a76ca15bde1be3e14572e475">PHINode::Create</a>(Builder.getInt8Ty(), 2, </span><span class="doxyHighlightStringLiteral">&quot;&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01599" /><CodeLine lineNumber="1599"><span class="doxyHighlight">      PN-&gt;insertBefore(LandingBB-&gt;begin());</span></CodeLine>
<Link id="l01600" /><CodeLine lineNumber="1600"><span class="doxyHighlight">      S-&gt;replaceAllUsesWith(PN);</span></CodeLine>
<Link id="l01601" /><CodeLine lineNumber="1601"><span class="doxyHighlight">      PN-&gt;addIncoming(Builder.getInt8(-1), SuspendBB);</span></CodeLine>
<Link id="l01602" /><CodeLine lineNumber="1602"><span class="doxyHighlight">      PN-&gt;addIncoming(S, ResumeBB);</span></CodeLine>
<Link id="l01603" /><CodeLine lineNumber="1603"></CodeLine>
<Link id="l01604" /><CodeLine lineNumber="1604"><span class="doxyHighlight">      ++SuspendIndex;</span></CodeLine>
<Link id="l01605" /><CodeLine lineNumber="1605"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01606" /><CodeLine lineNumber="1606"></CodeLine>
<Link id="l01607" /><CodeLine lineNumber="1607"><span class="doxyHighlight">    Builder.SetInsertPoint(UnreachBB);</span></CodeLine>
<Link id="l01608" /><CodeLine lineNumber="1608"><span class="doxyHighlight">    Builder.CreateUnreachable();</span></CodeLine>
<Link id="l01609" /><CodeLine lineNumber="1609"></CodeLine>
<Link id="l01610" /><CodeLine lineNumber="1610"><span class="doxyHighlight">    Shape.<a href="/docs/api/structs/llvm/coro/shape/#abe8f7906a8618f90e2a75109a778054a">SwitchLowering</a>.<a href="/docs/api/structs/llvm/coro/shape/switchloweringstorage/#ae5f82081e3f2b39a7e795491bb5d7a6e">ResumeEntryBlock</a> = NewEntry;</span></CodeLine>
<Link id="l01611" /><CodeLine lineNumber="1611"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01612" /><CodeLine lineNumber="1612"></CodeLine>
<Link id="l01613" /><CodeLine lineNumber="1613"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Store addresses of Resume/Destroy/Cleanup functions in the coroutine frame.</span></CodeLine>
<Link id="l01614" /><CodeLine lineNumber="1614"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> updateCoroFrame(coro::Shape &amp;Shape, Function &#42;ResumeFn,</span></CodeLine>
<Link id="l01615" /><CodeLine lineNumber="1615"><span class="doxyHighlight">                              Function &#42;DestroyFn, Function &#42;CleanupFn) &#123;</span></CodeLine>
<Link id="l01616" /><CodeLine lineNumber="1616"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#aa241826e10b4a9bf77c3115e7160d3c7">IRBuilder&lt;&gt;</a> Builder(&amp;&#42;Shape.<a href="/docs/api/structs/llvm/coro/shape/#ac406c2b5a7e2d11174becab5cb27765d">getInsertPtAfterFramePtr</a>());</span></CodeLine>
<Link id="l01617" /><CodeLine lineNumber="1617"></CodeLine>
<Link id="l01618" /><CodeLine lineNumber="1618"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;ResumeAddr = Builder.CreateStructGEP(</span></CodeLine>
<Link id="l01619" /><CodeLine lineNumber="1619"><span class="doxyHighlight">        Shape.<a href="/docs/api/structs/llvm/coro/shape/#a24c5fed9b14aed8a3b4f3828472fbab5">FrameTy</a>, Shape.<a href="/docs/api/structs/llvm/coro/shape/#a5eac2988672b484645dcbcd706430967">FramePtr</a>, <a href="/docs/api/structs/llvm/coro/shape/switchfieldindex/#aef925686aca6c6970964fea2c25bf242a012dd1dc85c718e8159980fa4273d9e6">coro::Shape::SwitchFieldIndex::Resume</a>,</span></CodeLine>
<Link id="l01620" /><CodeLine lineNumber="1620"><span class="doxyHighlight">        </span><span class="doxyHighlightStringLiteral">&quot;resume.addr&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01621" /><CodeLine lineNumber="1621"><span class="doxyHighlight">    Builder.CreateStore(ResumeFn, ResumeAddr);</span></CodeLine>
<Link id="l01622" /><CodeLine lineNumber="1622"></CodeLine>
<Link id="l01623" /><CodeLine lineNumber="1623"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a066e2a31a13d6520e52ae1944f194662">Value</a> &#42;DestroyOrCleanupFn = DestroyFn;</span></CodeLine>
<Link id="l01624" /><CodeLine lineNumber="1624"></CodeLine>
<Link id="l01625" /><CodeLine lineNumber="1625"><span class="doxyHighlight">    CoroIdInst &#42;CoroId = Shape.<a href="/docs/api/structs/llvm/coro/shape/#a3660324b8035c8b52afd23e54623ddf8">getSwitchCoroId</a>();</span></CodeLine>
<Link id="l01626" /><CodeLine lineNumber="1626"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CoroAllocInst &#42;CA = CoroId-&gt;<a href="/docs/api/classes/llvm/anycoroidinst/#adc3f7ab9023c4725ef498b410afd742d">getCoroAlloc</a>()) &#123;</span></CodeLine>
<Link id="l01627" /><CodeLine lineNumber="1627"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If there is a CoroAlloc and it returns false (meaning we elide the</span></CodeLine>
<Link id="l01628" /><CodeLine lineNumber="1628"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// allocation, use CleanupFn instead of DestroyFn).</span></CodeLine>
<Link id="l01629" /><CodeLine lineNumber="1629"><span class="doxyHighlight">      DestroyOrCleanupFn = Builder.CreateSelect(CA, DestroyFn, CleanupFn);</span></CodeLine>
<Link id="l01630" /><CodeLine lineNumber="1630"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01631" /><CodeLine lineNumber="1631"></CodeLine>
<Link id="l01632" /><CodeLine lineNumber="1632"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;DestroyAddr = Builder.CreateStructGEP(</span></CodeLine>
<Link id="l01633" /><CodeLine lineNumber="1633"><span class="doxyHighlight">        Shape.<a href="/docs/api/structs/llvm/coro/shape/#a24c5fed9b14aed8a3b4f3828472fbab5">FrameTy</a>, Shape.<a href="/docs/api/structs/llvm/coro/shape/#a5eac2988672b484645dcbcd706430967">FramePtr</a>, <a href="/docs/api/structs/llvm/coro/shape/switchfieldindex/#aef925686aca6c6970964fea2c25bf242a0416e9f2fbff942bd66bfa6d7e759d47">coro::Shape::SwitchFieldIndex::Destroy</a>,</span></CodeLine>
<Link id="l01634" /><CodeLine lineNumber="1634"><span class="doxyHighlight">        </span><span class="doxyHighlightStringLiteral">&quot;destroy.addr&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01635" /><CodeLine lineNumber="1635"><span class="doxyHighlight">    Builder.CreateStore(DestroyOrCleanupFn, DestroyAddr);</span></CodeLine>
<Link id="l01636" /><CodeLine lineNumber="1636"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01637" /><CodeLine lineNumber="1637"></CodeLine>
<Link id="l01638" /><CodeLine lineNumber="1638"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create a global constant array containing pointers to functions provided</span></CodeLine>
<Link id="l01639" /><CodeLine lineNumber="1639"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// and set Info parameter of CoroBegin to point at this constant. Example:</span></CodeLine>
<Link id="l01640" /><CodeLine lineNumber="1640"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01641" /><CodeLine lineNumber="1641"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   @f.resumers = internal constant &#91;2 x void(%f.frame&#42;)&#42;&#93;</span></CodeLine>
<Link id="l01642" /><CodeLine lineNumber="1642"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//                    &#91;void(%f.frame&#42;)&#42; @f.resume, void(%f.frame&#42;)&#42;</span></CodeLine>
<Link id="l01643" /><CodeLine lineNumber="1643"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//                    @f.destroy&#93;</span></CodeLine>
<Link id="l01644" /><CodeLine lineNumber="1644"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   define void @f() &#123;</span></CodeLine>
<Link id="l01645" /><CodeLine lineNumber="1645"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     ...</span></CodeLine>
<Link id="l01646" /><CodeLine lineNumber="1646"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     call i8&#42; @llvm.coro.begin(i8&#42; null, i32 0, i8&#42; null,</span></CodeLine>
<Link id="l01647" /><CodeLine lineNumber="1647"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//                    i8&#42; bitcast(&#91;2 x void(%f.frame&#42;)&#42;&#93; &#42; @f.resumers to</span></CodeLine>
<Link id="l01648" /><CodeLine lineNumber="1648"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//                    i8&#42;))</span></CodeLine>
<Link id="l01649" /><CodeLine lineNumber="1649"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01650" /><CodeLine lineNumber="1650"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Assumes that all the functions have the same signature.</span></CodeLine>
<Link id="l01651" /><CodeLine lineNumber="1651"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> setCoroInfo(Function &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, coro::Shape &amp;Shape,</span></CodeLine>
<Link id="l01652" /><CodeLine lineNumber="1652"><span class="doxyHighlight">                          <a href="/docs/api/namespaces/llvm/#ab9c6b351507d3c0730f4290919d43a12">ArrayRef&lt;Function &#42;&gt;</a> Fns) &#123;</span></CodeLine>
<Link id="l01653" /><CodeLine lineNumber="1653"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// This only works under the switch-lowering ABI because coro elision</span></CodeLine>
<Link id="l01654" /><CodeLine lineNumber="1654"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// only works on the switch-lowering ABI.</span></CodeLine>
<Link id="l01655" /><CodeLine lineNumber="1655"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a8fc529c79977cdd01e187986f960a07f">SmallVector&lt;Constant &#42;, 4&gt;</a> <a href="/docs/api/namespaces/llvm/amdgpu/hsamd/kernel/key/#a1958a762261549463a280bac3274d6d5">Args</a>(Fns);</span></CodeLine>
<Link id="l01656" /><CodeLine lineNumber="1656"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/namespaces/llvm/amdgpu/hsamd/kernel/key/#a1958a762261549463a280bac3274d6d5">Args</a>.empty());</span></CodeLine>
<Link id="l01657" /><CodeLine lineNumber="1657"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/codeview/#adfebd8c4ae29ccd84c600c1e65d6b807a86408593c34af77fdd90df932f8b5261">Function</a> &#42;Part = &#42;Fns.<a href="/docs/api/classes/llvm/arrayref/#aab36927882fbfdcbb860d87fd9c30da8">begin</a>();</span></CodeLine>
<Link id="l01658" /><CodeLine lineNumber="1658"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/codegen/machinecheckdebugify-cpp/#a85892acfa8970627e9bd9c9815f15c25">Module</a> &#42;<a href="/docs/api/namespaces/llvm/arm/#ac2456158e5acb44477d8ecfa2d04dbdea69691c7bdcc3ce6d5d8a1361f22d04ac">M</a> = Part-&gt;<a href="/docs/api/classes/llvm/globalvalue/#a739b30c811f1eece61b05320ddf44e5b">getParent</a>();</span></CodeLine>
<Link id="l01659" /><CodeLine lineNumber="1659"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;ArrTy = ArrayType::get(Part-&gt;<a href="/docs/api/classes/llvm/globalvalue/#a913a5d4b2cddde762446bd494e81a3f2">getType</a>(), <a href="/docs/api/namespaces/llvm/amdgpu/hsamd/kernel/key/#a1958a762261549463a280bac3274d6d5">Args</a>.size());</span></CodeLine>
<Link id="l01660" /><CodeLine lineNumber="1660"></CodeLine>
<Link id="l01661" /><CodeLine lineNumber="1661"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;ConstVal = <a href="/docs/api/classes/llvm/constantarray/#a0900dacdc7ad8e3ea0cc92993c7fd422">ConstantArray::get</a>(ArrTy, Args);</span></CodeLine>
<Link id="l01662" /><CodeLine lineNumber="1662"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;GV = </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> GlobalVariable(&#42;M, ConstVal-&gt;getType(), </span><span class="doxyHighlightComment">/&#42;isConstant=&#42;/</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l01663" /><CodeLine lineNumber="1663"><span class="doxyHighlight">                                  GlobalVariable::PrivateLinkage, ConstVal,</span></CodeLine>
<Link id="l01664" /><CodeLine lineNumber="1664"><span class="doxyHighlight">                                  <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getName() + Twine(</span><span class="doxyHighlightStringLiteral">&quot;.resumers&quot;</span><span class="doxyHighlight">));</span></CodeLine>
<Link id="l01665" /><CodeLine lineNumber="1665"></CodeLine>
<Link id="l01666" /><CodeLine lineNumber="1666"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Update coro.begin instruction to refer to this constant.</span></CodeLine>
<Link id="l01667" /><CodeLine lineNumber="1667"><span class="doxyHighlight">    LLVMContext &amp;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a> = <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getContext();</span></CodeLine>
<Link id="l01668" /><CodeLine lineNumber="1668"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;BC = <a href="/docs/api/classes/llvm/constantexpr/#a1f469b1f703519ae25ce564c8704310f">ConstantExpr::getPointerCast</a>(GV, PointerType::getUnqual(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>));</span></CodeLine>
<Link id="l01669" /><CodeLine lineNumber="1669"><span class="doxyHighlight">    Shape.<a href="/docs/api/structs/llvm/coro/shape/#a3660324b8035c8b52afd23e54623ddf8">getSwitchCoroId</a>()-&gt;<a href="/docs/api/classes/llvm/coroidinst/#a11b71b3b2f2b4d214a7eac47e628b3d2">setInfo</a>(BC);</span></CodeLine>
<Link id="l01670" /><CodeLine lineNumber="1670"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01671" /><CodeLine lineNumber="1671"><span class="doxyHighlight">&#125;;</span></CodeLine>
<Link id="l01672" /><CodeLine lineNumber="1672"></CodeLine>
<Link id="l01673" /><CodeLine lineNumber="1673"><span class="doxyHighlight">&#125; </span><span class="doxyHighlightComment">// namespace</span></CodeLine>
<Link id="l01674" /><CodeLine lineNumber="1674"></CodeLine>
<Link id="l01675" /><CodeLine lineNumber="1675" lineLink="#af678f41709f265e2589f247e883aa738"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#af678f41709f265e2589f247e883aa738">replaceAsyncResumeFunction</a>(<a href="/docs/api/classes/llvm/corosuspendasyncinst">CoroSuspendAsyncInst</a> &#42;Suspend,</span></CodeLine>
<Link id="l01676" /><CodeLine lineNumber="1676"><span class="doxyHighlight">                                       <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/namespaces/llvm/coro/#ad5c7ebab0ec481424c33db8902c652f4af11580a0250ef12842e64f487810cc70">Continuation</a>) &#123;</span></CodeLine>
<Link id="l01677" /><CodeLine lineNumber="1677"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;ResumeIntrinsic = Suspend-&gt;<a href="/docs/api/classes/llvm/corosuspendasyncinst/#aeb9fbb3057734e2753c7cf8966bd0e84">getResumeFunction</a>();</span></CodeLine>
<Link id="l01678" /><CodeLine lineNumber="1678"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;Context = Suspend-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>()-&gt;getParent()-&gt;getContext();</span></CodeLine>
<Link id="l01679" /><CodeLine lineNumber="1679"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Int8PtrTy = <a href="/docs/api/classes/llvm/pointertype/#af8a1dbdbfd89aa4899b3c0d39495d0dd">PointerType::getUnqual</a>(Context);</span></CodeLine>
<Link id="l01680" /><CodeLine lineNumber="1680"></CodeLine>
<Link id="l01681" /><CodeLine lineNumber="1681"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> Builder(ResumeIntrinsic);</span></CodeLine>
<Link id="l01682" /><CodeLine lineNumber="1682"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Val = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a83cf0b7088dc0d66ca9f5ecac7350e4c">CreateBitOrPointerCast</a>(<a href="/docs/api/namespaces/llvm/coro/#ad5c7ebab0ec481424c33db8902c652f4af11580a0250ef12842e64f487810cc70">Continuation</a>, Int8PtrTy);</span></CodeLine>
<Link id="l01683" /><CodeLine lineNumber="1683"><span class="doxyHighlight">  ResumeIntrinsic-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(Val);</span></CodeLine>
<Link id="l01684" /><CodeLine lineNumber="1684"><span class="doxyHighlight">  ResumeIntrinsic-&gt;eraseFromParent();</span></CodeLine>
<Link id="l01685" /><CodeLine lineNumber="1685"><span class="doxyHighlight">  Suspend-&gt;<a href="/docs/api/classes/llvm/user/#a5fa9b8e1842b354f64c1ba6be0a4a17f">setOperand</a>(<a href="/docs/api/classes/llvm/corosuspendasyncinst/#a605ed14ca54fecd8f58d5eed17028600a849e006178975accfd029d2d39b1deb1">CoroSuspendAsyncInst::ResumeFunctionArg</a>,</span></CodeLine>
<Link id="l01686" /><CodeLine lineNumber="1686"><span class="doxyHighlight">                      <a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(Int8PtrTy));</span></CodeLine>
<Link id="l01687" /><CodeLine lineNumber="1687"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01688" /><CodeLine lineNumber="1688"></CodeLine>
<Link id="l01689" /><CodeLine lineNumber="1689"><span class="doxyHighlightComment">/// Coerce the arguments in \\p FnArgs according to \\p FnTy in \\p CallArgs.</span></CodeLine>
<Link id="l01690" /><CodeLine lineNumber="1690" lineLink="#ab349dce775a8c8dcd72c24059e8357a2"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#ab349dce775a8c8dcd72c24059e8357a2">coerceArguments</a>(<a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> &amp;Builder, <a href="/docs/api/classes/functiontype">FunctionType</a> &#42;FnTy,</span></CodeLine>
<Link id="l01691" /><CodeLine lineNumber="1691"><span class="doxyHighlight">                            <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;Value &#42;&gt;</a> FnArgs,</span></CodeLine>
<Link id="l01692" /><CodeLine lineNumber="1692"><span class="doxyHighlight">                            <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;Value &#42;&gt;</a> &amp;CallArgs) &#123;</span></CodeLine>
<Link id="l01693" /><CodeLine lineNumber="1693"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">size&#95;t</span><span class="doxyHighlight"> ArgIdx = 0;</span></CodeLine>
<Link id="l01694" /><CodeLine lineNumber="1694"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;paramTy : FnTy-&gt;params()) &#123;</span></CodeLine>
<Link id="l01695" /><CodeLine lineNumber="1695"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(ArgIdx &lt; FnArgs.<a href="/docs/api/classes/llvm/arrayref/#a85ffb6531d4cda988ea81f18d4e56fb7">size</a>());</span></CodeLine>
<Link id="l01696" /><CodeLine lineNumber="1696"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (paramTy != FnArgs&#91;ArgIdx&#93;-&gt;<a href="/docs/api/files/lib/lib/object/tapifile-cpp/#a913a691648e20063bbd278e8f02d8430">getType</a>())</span></CodeLine>
<Link id="l01697" /><CodeLine lineNumber="1697"><span class="doxyHighlight">      CallArgs.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(</span></CodeLine>
<Link id="l01698" /><CodeLine lineNumber="1698"><span class="doxyHighlight">          Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a83cf0b7088dc0d66ca9f5ecac7350e4c">CreateBitOrPointerCast</a>(FnArgs&#91;ArgIdx&#93;, paramTy));</span></CodeLine>
<Link id="l01699" /><CodeLine lineNumber="1699"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l01700" /><CodeLine lineNumber="1700"><span class="doxyHighlight">      CallArgs.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(FnArgs&#91;ArgIdx&#93;);</span></CodeLine>
<Link id="l01701" /><CodeLine lineNumber="1701"><span class="doxyHighlight">    ++ArgIdx;</span></CodeLine>
<Link id="l01702" /><CodeLine lineNumber="1702"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01703" /><CodeLine lineNumber="1703"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01704" /><CodeLine lineNumber="1704"></CodeLine>
<Link id="l01705" /><CodeLine lineNumber="1705" lineLink="/docs/api/namespaces/llvm/coro/#aa0d499612ac66539c8daf29c8eb142a5"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42;<a href="/docs/api/namespaces/llvm/coro/#aa0d499612ac66539c8daf29c8eb142a5">coro::createMustTailCall</a>(<a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/classes/llvm/function">Function</a> &#42;MustTailCallFn,</span></CodeLine>
<Link id="l01706" /><CodeLine lineNumber="1706"><span class="doxyHighlight">                                   <a href="/docs/api/classes/llvm/targettransforminfo">TargetTransformInfo</a> &amp;<a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>,</span></CodeLine>
<Link id="l01707" /><CodeLine lineNumber="1707"><span class="doxyHighlight">                                   <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;Value &#42;&gt;</a> <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpulowerkernelarguments-cpp/#a1161e5a4e753384aaba3a8e4533c4261">Arguments</a>,</span></CodeLine>
<Link id="l01708" /><CodeLine lineNumber="1708"><span class="doxyHighlight">                                   <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> &amp;Builder) &#123;</span></CodeLine>
<Link id="l01709" /><CodeLine lineNumber="1709"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;FnTy = MustTailCallFn-&gt;<a href="/docs/api/classes/llvm/function/#a21075305f0e463b24aafc2fb99514ace">getFunctionType</a>();</span></CodeLine>
<Link id="l01710" /><CodeLine lineNumber="1710"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Coerce the arguments, llvm optimizations seem to ignore the types in</span></CodeLine>
<Link id="l01711" /><CodeLine lineNumber="1711"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// vaarg functions and throws away casts in optimized mode.</span></CodeLine>
<Link id="l01712" /><CodeLine lineNumber="1712"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Value &#42;, 8&gt;</a> CallArgs;</span></CodeLine>
<Link id="l01713" /><CodeLine lineNumber="1713"><span class="doxyHighlight">  <a href="#ab349dce775a8c8dcd72c24059e8357a2">coerceArguments</a>(Builder, FnTy, <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpulowerkernelarguments-cpp/#a1161e5a4e753384aaba3a8e4533c4261">Arguments</a>, CallArgs);</span></CodeLine>
<Link id="l01714" /><CodeLine lineNumber="1714"></CodeLine>
<Link id="l01715" /><CodeLine lineNumber="1715"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;TailCall = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#ab086c5b9f9563eda0cdd703f454e041e">CreateCall</a>(FnTy, MustTailCallFn, CallArgs);</span></CodeLine>
<Link id="l01716" /><CodeLine lineNumber="1716"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Skip targets which don&#39;t support tail call.</span></CodeLine>
<Link id="l01717" /><CodeLine lineNumber="1717"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>.supportsTailCallFor(TailCall)) &#123;</span></CodeLine>
<Link id="l01718" /><CodeLine lineNumber="1718"><span class="doxyHighlight">    TailCall-&gt;setTailCallKind(<a href="/docs/api/classes/llvm/callinst/#ad682514c13f12f1a8d759d422fce6aefa2c3fc2c37f5db1dd777fad4e0d33ec7e">CallInst::TCK&#95;MustTail</a>);</span></CodeLine>
<Link id="l01719" /><CodeLine lineNumber="1719"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01720" /><CodeLine lineNumber="1720"><span class="doxyHighlight">  TailCall-&gt;setDebugLoc(<a href="/docs/api/namespaces/llvm/loc">Loc</a>);</span></CodeLine>
<Link id="l01721" /><CodeLine lineNumber="1721"><span class="doxyHighlight">  TailCall-&gt;setCallingConv(MustTailCallFn-&gt;<a href="/docs/api/classes/llvm/function/#a5f494edc0a569c7fc9ff4181243be1ed">getCallingConv</a>());</span></CodeLine>
<Link id="l01722" /><CodeLine lineNumber="1722"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> TailCall;</span></CodeLine>
<Link id="l01723" /><CodeLine lineNumber="1723"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01724" /><CodeLine lineNumber="1724"></CodeLine>
<Link id="l01725" /><CodeLine lineNumber="1725" lineLink="/docs/api/classes/llvm/coro/asyncabi/#ae51f7f2d35223ec01d09e205c757a4df"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/coro/asyncabi/#ae51f7f2d35223ec01d09e205c757a4df">coro::AsyncABI::splitCoroutine</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>, <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;<a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>,</span></CodeLine>
<Link id="l01726" /><CodeLine lineNumber="1726"><span class="doxyHighlight">                                    <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;Function &#42;&gt;</a> &amp;Clones,</span></CodeLine>
<Link id="l01727" /><CodeLine lineNumber="1727"><span class="doxyHighlight">                                    <a href="/docs/api/classes/llvm/targettransforminfo">TargetTransformInfo</a> &amp;<a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>) &#123;</span></CodeLine>
<Link id="l01728" /><CodeLine lineNumber="1728"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.ABI == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a24aa4117da86c41684ad25742832dfa6">coro::ABI::Async</a>);</span></CodeLine>
<Link id="l01729" /><CodeLine lineNumber="1729"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Clones.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>());</span></CodeLine>
<Link id="l01730" /><CodeLine lineNumber="1730"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Reset various things that the optimizer might have decided it</span></CodeLine>
<Link id="l01731" /><CodeLine lineNumber="1731"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// &quot;knows&quot; about the coroutine function due to not seeing a return.</span></CodeLine>
<Link id="l01732" /><CodeLine lineNumber="1732"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>.removeFnAttr(Attribute::NoReturn);</span></CodeLine>
<Link id="l01733" /><CodeLine lineNumber="1733"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>.removeRetAttr(Attribute::NoAlias);</span></CodeLine>
<Link id="l01734" /><CodeLine lineNumber="1734"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>.removeRetAttr(Attribute::NonNull);</span></CodeLine>
<Link id="l01735" /><CodeLine lineNumber="1735"></CodeLine>
<Link id="l01736" /><CodeLine lineNumber="1736"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;Context = <a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>.getContext();</span></CodeLine>
<Link id="l01737" /><CodeLine lineNumber="1737"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Int8PtrTy = <a href="/docs/api/classes/llvm/pointertype/#af8a1dbdbfd89aa4899b3c0d39495d0dd">PointerType::getUnqual</a>(Context);</span></CodeLine>
<Link id="l01738" /><CodeLine lineNumber="1738"></CodeLine>
<Link id="l01739" /><CodeLine lineNumber="1739"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Id = <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.getAsyncCoroId();</span></CodeLine>
<Link id="l01740" /><CodeLine lineNumber="1740"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> Builder(Id);</span></CodeLine>
<Link id="l01741" /><CodeLine lineNumber="1741"></CodeLine>
<Link id="l01742" /><CodeLine lineNumber="1742"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a> = Id-&gt;getStorage();</span></CodeLine>
<Link id="l01743" /><CodeLine lineNumber="1743"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a> = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a83cf0b7088dc0d66ca9f5ecac7350e4c">CreateBitOrPointerCast</a>(<a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>, Int8PtrTy);</span></CodeLine>
<Link id="l01744" /><CodeLine lineNumber="1744"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a> = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a5945995573939aabe8aa3ccea099b219">CreateConstInBoundsGEP1&#95;32</a>(</span></CodeLine>
<Link id="l01745" /><CodeLine lineNumber="1745"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/type/#a7ba5de75f50bb4a4ba920698edf39b28">Type::getInt8Ty</a>(Context), <a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>, <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.AsyncLowering.FrameOffset,</span></CodeLine>
<Link id="l01746" /><CodeLine lineNumber="1746"><span class="doxyHighlight">      </span><span class="doxyHighlightStringLiteral">&quot;async.ctx.frameptr&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01747" /><CodeLine lineNumber="1747"></CodeLine>
<Link id="l01748" /><CodeLine lineNumber="1748"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Map all uses of llvm.coro.begin to the allocated frame pointer.</span></CodeLine>
<Link id="l01749" /><CodeLine lineNumber="1749"><span class="doxyHighlight">  &#123;</span></CodeLine>
<Link id="l01750" /><CodeLine lineNumber="1750"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Make sure we don&#39;t invalidate Shape.FramePtr.</span></CodeLine>
<Link id="l01751" /><CodeLine lineNumber="1751"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/trackingvh">TrackingVH&lt;Value&gt;</a> Handle(<a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.FramePtr);</span></CodeLine>
<Link id="l01752" /><CodeLine lineNumber="1752"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.CoroBegin-&gt;replaceAllUsesWith(<a href="/docs/api/files/lib/lib/target/lib/target/xcore/xcoreframelowering-cpp/#a64f8c7400de58c117c5af250f000675f">FramePtr</a>);</span></CodeLine>
<Link id="l01753" /><CodeLine lineNumber="1753"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.FramePtr = Handle.<a href="/docs/api/classes/llvm/trackingvh/#a3249c6d006cdfe254ce0e6c808260bfb">getValPtr</a>();</span></CodeLine>
<Link id="l01754" /><CodeLine lineNumber="1754"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01755" /><CodeLine lineNumber="1755"></CodeLine>
<Link id="l01756" /><CodeLine lineNumber="1756"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create all the functions in order after the main function.</span></CodeLine>
<Link id="l01757" /><CodeLine lineNumber="1757"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> NextF = std::next(<a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>.getIterator());</span></CodeLine>
<Link id="l01758" /><CodeLine lineNumber="1758"></CodeLine>
<Link id="l01759" /><CodeLine lineNumber="1759"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create a continuation function for each of the suspend points.</span></CodeLine>
<Link id="l01760" /><CodeLine lineNumber="1760"><span class="doxyHighlight">  Clones.<a href="/docs/api/classes/llvm/smallvectorimpl/#a499ea32ca1b8d16cedfe01d1e5b08f29">reserve</a>(<a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.CoroSuspends.size());</span></CodeLine>
<Link id="l01761" /><CodeLine lineNumber="1761"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#91;Idx, CS&#93; : <a href="/docs/api/namespaces/llvm/#a206e2134ddd2312c3488d0632d98f554">llvm::enumerate</a>(<a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.CoroSuspends)) &#123;</span></CodeLine>
<Link id="l01762" /><CodeLine lineNumber="1762"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Suspend = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CoroSuspendAsyncInst&gt;</a>(CS);</span></CodeLine>
<Link id="l01763" /><CodeLine lineNumber="1763"></CodeLine>
<Link id="l01764" /><CodeLine lineNumber="1764"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Create the clone declaration.</span></CodeLine>
<Link id="l01765" /><CodeLine lineNumber="1765"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> ResumeNameSuffix = </span><span class="doxyHighlightStringLiteral">&quot;.resume.&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01766" /><CodeLine lineNumber="1766"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> ProjectionFunctionName =</span></CodeLine>
<Link id="l01767" /><CodeLine lineNumber="1767"><span class="doxyHighlight">        Suspend-&gt;getAsyncContextProjectionFunction()-&gt;getName();</span></CodeLine>
<Link id="l01768" /><CodeLine lineNumber="1768"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> UseSwiftMangling = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01769" /><CodeLine lineNumber="1769"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ProjectionFunctionName == </span><span class="doxyHighlightStringLiteral">&quot;&#95;&#95;swift&#95;async&#95;resume&#95;project&#95;context&quot;</span><span class="doxyHighlight">) &#123;</span></CodeLine>
<Link id="l01770" /><CodeLine lineNumber="1770"><span class="doxyHighlight">      ResumeNameSuffix = </span><span class="doxyHighlightStringLiteral">&quot;TQ&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01771" /><CodeLine lineNumber="1771"><span class="doxyHighlight">      UseSwiftMangling = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01772" /><CodeLine lineNumber="1772"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ProjectionFunctionName == </span><span class="doxyHighlightStringLiteral">&quot;&#95;&#95;swift&#95;async&#95;resume&#95;get&#95;context&quot;</span><span class="doxyHighlight">) &#123;</span></CodeLine>
<Link id="l01773" /><CodeLine lineNumber="1773"><span class="doxyHighlight">      ResumeNameSuffix = </span><span class="doxyHighlightStringLiteral">&quot;TY&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01774" /><CodeLine lineNumber="1774"><span class="doxyHighlight">      UseSwiftMangling = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01775" /><CodeLine lineNumber="1775"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01776" /><CodeLine lineNumber="1776"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/namespaces/llvm/coro/#ad5c7ebab0ec481424c33db8902c652f4af11580a0250ef12842e64f487810cc70">Continuation</a> = <a href="#a452dcc29fd5e19bda874218e10a8945c">createCloneDeclaration</a>(</span></CodeLine>
<Link id="l01777" /><CodeLine lineNumber="1777"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>, <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>,</span></CodeLine>
<Link id="l01778" /><CodeLine lineNumber="1778"><span class="doxyHighlight">        UseSwiftMangling ? ResumeNameSuffix + <a href="/docs/api/classes/llvm/twine">Twine</a>(Idx) + </span><span class="doxyHighlightStringLiteral">&quot;&#95;&quot;</span></CodeLine>
<Link id="l01779" /><CodeLine lineNumber="1779"><span class="doxyHighlight">                         : ResumeNameSuffix + <a href="/docs/api/classes/llvm/twine">Twine</a>(Idx),</span></CodeLine>
<Link id="l01780" /><CodeLine lineNumber="1780"><span class="doxyHighlight">        NextF, Suspend);</span></CodeLine>
<Link id="l01781" /><CodeLine lineNumber="1781"><span class="doxyHighlight">    Clones.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(<a href="/docs/api/namespaces/llvm/coro/#ad5c7ebab0ec481424c33db8902c652f4af11580a0250ef12842e64f487810cc70">Continuation</a>);</span></CodeLine>
<Link id="l01782" /><CodeLine lineNumber="1782"></CodeLine>
<Link id="l01783" /><CodeLine lineNumber="1783"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Insert a branch to a new return block immediately before the suspend</span></CodeLine>
<Link id="l01784" /><CodeLine lineNumber="1784"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// point.</span></CodeLine>
<Link id="l01785" /><CodeLine lineNumber="1785"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;SuspendBB = Suspend-&gt;getParent();</span></CodeLine>
<Link id="l01786" /><CodeLine lineNumber="1786"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewSuspendBB = SuspendBB-&gt;splitBasicBlock(Suspend);</span></CodeLine>
<Link id="l01787" /><CodeLine lineNumber="1787"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Branch = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BranchInst&gt;</a>(SuspendBB-&gt;getTerminator());</span></CodeLine>
<Link id="l01788" /><CodeLine lineNumber="1788"></CodeLine>
<Link id="l01789" /><CodeLine lineNumber="1789"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Place it before the first suspend.</span></CodeLine>
<Link id="l01790" /><CodeLine lineNumber="1790"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;ReturnBB =</span></CodeLine>
<Link id="l01791" /><CodeLine lineNumber="1791"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/basicblock/#a4a5b798214be930cf8e133c032ba0129">BasicBlock::Create</a>(<a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>.getContext(), </span><span class="doxyHighlightStringLiteral">&quot;coro.return&quot;</span><span class="doxyHighlight">, &amp;<a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>, NewSuspendBB);</span></CodeLine>
<Link id="l01792" /><CodeLine lineNumber="1792"><span class="doxyHighlight">    Branch-&gt;setSuccessor(0, ReturnBB);</span></CodeLine>
<Link id="l01793" /><CodeLine lineNumber="1793"></CodeLine>
<Link id="l01794" /><CodeLine lineNumber="1794"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> Builder(ReturnBB);</span></CodeLine>
<Link id="l01795" /><CodeLine lineNumber="1795"></CodeLine>
<Link id="l01796" /><CodeLine lineNumber="1796"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Insert the call to the tail call function and inline it.</span></CodeLine>
<Link id="l01797" /><CodeLine lineNumber="1797"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Fn = Suspend-&gt;getMustTailCallFunction();</span></CodeLine>
<Link id="l01798" /><CodeLine lineNumber="1798"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Value &#42;, 8&gt;</a> Args(Suspend-&gt;args());</span></CodeLine>
<Link id="l01799" /><CodeLine lineNumber="1799"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> FnArgs = <a href="/docs/api/namespaces/llvm/#ab9c6b351507d3c0730f4290919d43a12">ArrayRef&lt;Value &#42;&gt;</a>(Args).drop&#95;front(</span></CodeLine>
<Link id="l01800" /><CodeLine lineNumber="1800"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/corosuspendasyncinst/#a605ed14ca54fecd8f58d5eed17028600adea642c56a7c4aa607d2901d060b240c">CoroSuspendAsyncInst::MustTailCallFuncArg</a> + 1);</span></CodeLine>
<Link id="l01801" /><CodeLine lineNumber="1801"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;TailCall = <a href="/docs/api/namespaces/llvm/coro/#aa0d499612ac66539c8daf29c8eb142a5">coro::createMustTailCall</a>(Suspend-&gt;getDebugLoc(), Fn, <a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>,</span></CodeLine>
<Link id="l01802" /><CodeLine lineNumber="1802"><span class="doxyHighlight">                                              FnArgs, Builder);</span></CodeLine>
<Link id="l01803" /><CodeLine lineNumber="1803"><span class="doxyHighlight">    Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aa6536556982b7e6e2e5884e471f3ce6b">CreateRetVoid</a>();</span></CodeLine>
<Link id="l01804" /><CodeLine lineNumber="1804"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/inlinefunctioninfo">InlineFunctionInfo</a> FnInfo;</span></CodeLine>
<Link id="l01805" /><CodeLine lineNumber="1805"><span class="doxyHighlight">    (void)<a href="/docs/api/namespaces/llvm/#ab5a3ac0a249da0743dac1bd816d8e5d5">InlineFunction</a>(&#42;TailCall, FnInfo);</span></CodeLine>
<Link id="l01806" /><CodeLine lineNumber="1806"></CodeLine>
<Link id="l01807" /><CodeLine lineNumber="1807"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Replace the lvm.coro.async.resume intrisic call.</span></CodeLine>
<Link id="l01808" /><CodeLine lineNumber="1808"><span class="doxyHighlight">    <a href="#af678f41709f265e2589f247e883aa738">replaceAsyncResumeFunction</a>(Suspend, <a href="/docs/api/namespaces/llvm/coro/#ad5c7ebab0ec481424c33db8902c652f4af11580a0250ef12842e64f487810cc70">Continuation</a>);</span></CodeLine>
<Link id="l01809" /><CodeLine lineNumber="1809"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01810" /><CodeLine lineNumber="1810"></CodeLine>
<Link id="l01811" /><CodeLine lineNumber="1811"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Clones.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() == <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.CoroSuspends.size());</span></CodeLine>
<Link id="l01812" /><CodeLine lineNumber="1812"></CodeLine>
<Link id="l01813" /><CodeLine lineNumber="1813"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a91897d2d0da113b016f14ae110586ab1">MetadataSetTy</a> CommonDebugInfo&#123;collectCommonDebugInfo(<a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>)&#125;;</span></CodeLine>
<Link id="l01814" /><CodeLine lineNumber="1814"></CodeLine>
<Link id="l01815" /><CodeLine lineNumber="1815"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#91;Idx, CS&#93; : <a href="/docs/api/namespaces/llvm/#a206e2134ddd2312c3488d0632d98f554">llvm::enumerate</a>(<a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.CoroSuspends)) &#123;</span></CodeLine>
<Link id="l01816" /><CodeLine lineNumber="1816"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Suspend = CS;</span></CodeLine>
<Link id="l01817" /><CodeLine lineNumber="1817"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Clone = Clones&#91;Idx&#93;;</span></CodeLine>
<Link id="l01818" /><CodeLine lineNumber="1818"></CodeLine>
<Link id="l01819" /><CodeLine lineNumber="1819"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/coro/basecloner/#a0db1d0e9931350a1fe08aa96d5b5eafc">coro::BaseCloner::createClone</a>(<a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>, </span><span class="doxyHighlightStringLiteral">&quot;resume.&quot;</span><span class="doxyHighlight"> + <a href="/docs/api/classes/llvm/twine">Twine</a>(Idx), <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>, Clone,</span></CodeLine>
<Link id="l01820" /><CodeLine lineNumber="1820"><span class="doxyHighlight">                                  Suspend, <a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>, CommonDebugInfo);</span></CodeLine>
<Link id="l01821" /><CodeLine lineNumber="1821"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01822" /><CodeLine lineNumber="1822"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01823" /><CodeLine lineNumber="1823"></CodeLine>
<Link id="l01824" /><CodeLine lineNumber="1824" lineLink="/docs/api/classes/llvm/coro/anyretconabi/#adc7bbccb30409488c60813454af8c81d"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/coro/anyretconabi/#adc7bbccb30409488c60813454af8c81d">coro::AnyRetconABI::splitCoroutine</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>, <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;<a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>,</span></CodeLine>
<Link id="l01825" /><CodeLine lineNumber="1825"><span class="doxyHighlight">                                        <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;Function &#42;&gt;</a> &amp;Clones,</span></CodeLine>
<Link id="l01826" /><CodeLine lineNumber="1826"><span class="doxyHighlight">                                        <a href="/docs/api/classes/llvm/targettransforminfo">TargetTransformInfo</a> &amp;<a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>) &#123;</span></CodeLine>
<Link id="l01827" /><CodeLine lineNumber="1827"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.ABI == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380aad9d7f07127e321d1358b695c8720166">coro::ABI::Retcon</a> || <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.ABI == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a6ec6c15fe79ec2274d2c3e79ae4bcc41">coro::ABI::RetconOnce</a>);</span></CodeLine>
<Link id="l01828" /><CodeLine lineNumber="1828"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Clones.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>());</span></CodeLine>
<Link id="l01829" /><CodeLine lineNumber="1829"></CodeLine>
<Link id="l01830" /><CodeLine lineNumber="1830"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Reset various things that the optimizer might have decided it</span></CodeLine>
<Link id="l01831" /><CodeLine lineNumber="1831"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// &quot;knows&quot; about the coroutine function due to not seeing a return.</span></CodeLine>
<Link id="l01832" /><CodeLine lineNumber="1832"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>.removeFnAttr(Attribute::NoReturn);</span></CodeLine>
<Link id="l01833" /><CodeLine lineNumber="1833"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>.removeRetAttr(Attribute::NoAlias);</span></CodeLine>
<Link id="l01834" /><CodeLine lineNumber="1834"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>.removeRetAttr(Attribute::NonNull);</span></CodeLine>
<Link id="l01835" /><CodeLine lineNumber="1835"></CodeLine>
<Link id="l01836" /><CodeLine lineNumber="1836"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Allocate the frame.</span></CodeLine>
<Link id="l01837" /><CodeLine lineNumber="1837"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Id = <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.getRetconCoroId();</span></CodeLine>
<Link id="l01838" /><CodeLine lineNumber="1838"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;RawFramePtr;</span></CodeLine>
<Link id="l01839" /><CodeLine lineNumber="1839"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.RetconLowering.IsFrameInlineInStorage) &#123;</span></CodeLine>
<Link id="l01840" /><CodeLine lineNumber="1840"><span class="doxyHighlight">    RawFramePtr = Id-&gt;getStorage();</span></CodeLine>
<Link id="l01841" /><CodeLine lineNumber="1841"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l01842" /><CodeLine lineNumber="1842"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> Builder(Id);</span></CodeLine>
<Link id="l01843" /><CodeLine lineNumber="1843"></CodeLine>
<Link id="l01844" /><CodeLine lineNumber="1844"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Determine the size of the frame.</span></CodeLine>
<Link id="l01845" /><CodeLine lineNumber="1845"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/datalayout">DataLayout</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a> = <a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>.getDataLayout();</span></CodeLine>
<Link id="l01846" /><CodeLine lineNumber="1846"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/analysis/inlineorder-cpp/#a7ee6f0cb51c3b9056199e9a0001fe8c3a6f6cb72d544962fa333e2e34ce64f719">Size</a> = <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>.getTypeAllocSize(<a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.FrameTy);</span></CodeLine>
<Link id="l01847" /><CodeLine lineNumber="1847"></CodeLine>
<Link id="l01848" /><CodeLine lineNumber="1848"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Allocate.  We don&#39;t need to update the call graph node because we&#39;re</span></CodeLine>
<Link id="l01849" /><CodeLine lineNumber="1849"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// going to recompute it from scratch after splitting.</span></CodeLine>
<Link id="l01850" /><CodeLine lineNumber="1850"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// FIXME: pass the required alignment</span></CodeLine>
<Link id="l01851" /><CodeLine lineNumber="1851"><span class="doxyHighlight">    RawFramePtr = <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.emitAlloc(Builder, Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a73f286a780fbb8c82c0a8574540719ea">getInt64</a>(<a href="/docs/api/files/lib/lib/analysis/inlineorder-cpp/#a7ee6f0cb51c3b9056199e9a0001fe8c3a6f6cb72d544962fa333e2e34ce64f719">Size</a>), </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01852" /><CodeLine lineNumber="1852"><span class="doxyHighlight">    RawFramePtr =</span></CodeLine>
<Link id="l01853" /><CodeLine lineNumber="1853"><span class="doxyHighlight">        Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a932f08e32ea37a7019902ee467beb268">CreateBitCast</a>(RawFramePtr, <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.CoroBegin-&gt;getType());</span></CodeLine>
<Link id="l01854" /><CodeLine lineNumber="1854"></CodeLine>
<Link id="l01855" /><CodeLine lineNumber="1855"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Stash the allocated frame pointer in the continuation storage.</span></CodeLine>
<Link id="l01856" /><CodeLine lineNumber="1856"><span class="doxyHighlight">    Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aabfc20af4dcf7d94262824dcac2e7bed">CreateStore</a>(RawFramePtr, Id-&gt;getStorage());</span></CodeLine>
<Link id="l01857" /><CodeLine lineNumber="1857"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01858" /><CodeLine lineNumber="1858"></CodeLine>
<Link id="l01859" /><CodeLine lineNumber="1859"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Map all uses of llvm.coro.begin to the allocated frame pointer.</span></CodeLine>
<Link id="l01860" /><CodeLine lineNumber="1860"><span class="doxyHighlight">  &#123;</span></CodeLine>
<Link id="l01861" /><CodeLine lineNumber="1861"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Make sure we don&#39;t invalidate Shape.FramePtr.</span></CodeLine>
<Link id="l01862" /><CodeLine lineNumber="1862"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/trackingvh">TrackingVH&lt;Value&gt;</a> Handle(<a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.FramePtr);</span></CodeLine>
<Link id="l01863" /><CodeLine lineNumber="1863"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.CoroBegin-&gt;replaceAllUsesWith(RawFramePtr);</span></CodeLine>
<Link id="l01864" /><CodeLine lineNumber="1864"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.FramePtr = Handle.<a href="/docs/api/classes/llvm/trackingvh/#a3249c6d006cdfe254ce0e6c808260bfb">getValPtr</a>();</span></CodeLine>
<Link id="l01865" /><CodeLine lineNumber="1865"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01866" /><CodeLine lineNumber="1866"></CodeLine>
<Link id="l01867" /><CodeLine lineNumber="1867"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create a unique return block.</span></CodeLine>
<Link id="l01868" /><CodeLine lineNumber="1868"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ReturnBB = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01869" /><CodeLine lineNumber="1869"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;ContinuationPhi = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01870" /><CodeLine lineNumber="1870"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;PHINode &#42;, 4&gt;</a> ReturnPHIs;</span></CodeLine>
<Link id="l01871" /><CodeLine lineNumber="1871"></CodeLine>
<Link id="l01872" /><CodeLine lineNumber="1872"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create all the functions in order after the main function.</span></CodeLine>
<Link id="l01873" /><CodeLine lineNumber="1873"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> NextF = std::next(<a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>.getIterator());</span></CodeLine>
<Link id="l01874" /><CodeLine lineNumber="1874"></CodeLine>
<Link id="l01875" /><CodeLine lineNumber="1875"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create a continuation function for each of the suspend points.</span></CodeLine>
<Link id="l01876" /><CodeLine lineNumber="1876"><span class="doxyHighlight">  Clones.<a href="/docs/api/classes/llvm/smallvectorimpl/#a499ea32ca1b8d16cedfe01d1e5b08f29">reserve</a>(<a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.CoroSuspends.size());</span></CodeLine>
<Link id="l01877" /><CodeLine lineNumber="1877"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#91;Idx, CS&#93; : <a href="/docs/api/namespaces/llvm/#a206e2134ddd2312c3488d0632d98f554">llvm::enumerate</a>(<a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.CoroSuspends)) &#123;</span></CodeLine>
<Link id="l01878" /><CodeLine lineNumber="1878"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Suspend = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CoroSuspendRetconInst&gt;</a>(CS);</span></CodeLine>
<Link id="l01879" /><CodeLine lineNumber="1879"></CodeLine>
<Link id="l01880" /><CodeLine lineNumber="1880"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Create the clone declaration.</span></CodeLine>
<Link id="l01881" /><CodeLine lineNumber="1881"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#ad5c7ebab0ec481424c33db8902c652f4af11580a0250ef12842e64f487810cc70">Continuation</a> = <a href="#a452dcc29fd5e19bda874218e10a8945c">createCloneDeclaration</a>(</span></CodeLine>
<Link id="l01882" /><CodeLine lineNumber="1882"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>, <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>, </span><span class="doxyHighlightStringLiteral">&quot;.resume.&quot;</span><span class="doxyHighlight"> + <a href="/docs/api/classes/llvm/twine">Twine</a>(Idx), NextF, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01883" /><CodeLine lineNumber="1883"><span class="doxyHighlight">    Clones.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(<a href="/docs/api/namespaces/llvm/coro/#ad5c7ebab0ec481424c33db8902c652f4af11580a0250ef12842e64f487810cc70">Continuation</a>);</span></CodeLine>
<Link id="l01884" /><CodeLine lineNumber="1884"></CodeLine>
<Link id="l01885" /><CodeLine lineNumber="1885"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Insert a branch to the unified return block immediately before</span></CodeLine>
<Link id="l01886" /><CodeLine lineNumber="1886"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// the suspend point.</span></CodeLine>
<Link id="l01887" /><CodeLine lineNumber="1887"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> SuspendBB = Suspend-&gt;getParent();</span></CodeLine>
<Link id="l01888" /><CodeLine lineNumber="1888"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> NewSuspendBB = SuspendBB-&gt;splitBasicBlock(Suspend);</span></CodeLine>
<Link id="l01889" /><CodeLine lineNumber="1889"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Branch = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BranchInst&gt;</a>(SuspendBB-&gt;getTerminator());</span></CodeLine>
<Link id="l01890" /><CodeLine lineNumber="1890"></CodeLine>
<Link id="l01891" /><CodeLine lineNumber="1891"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Create the unified return block.</span></CodeLine>
<Link id="l01892" /><CodeLine lineNumber="1892"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!ReturnBB) &#123;</span></CodeLine>
<Link id="l01893" /><CodeLine lineNumber="1893"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Place it before the first suspend.</span></CodeLine>
<Link id="l01894" /><CodeLine lineNumber="1894"><span class="doxyHighlight">      ReturnBB =</span></CodeLine>
<Link id="l01895" /><CodeLine lineNumber="1895"><span class="doxyHighlight">          <a href="/docs/api/classes/llvm/basicblock/#a4a5b798214be930cf8e133c032ba0129">BasicBlock::Create</a>(<a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>.getContext(), </span><span class="doxyHighlightStringLiteral">&quot;coro.return&quot;</span><span class="doxyHighlight">, &amp;<a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>, NewSuspendBB);</span></CodeLine>
<Link id="l01896" /><CodeLine lineNumber="1896"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.RetconLowering.ReturnBlock = ReturnBB;</span></CodeLine>
<Link id="l01897" /><CodeLine lineNumber="1897"></CodeLine>
<Link id="l01898" /><CodeLine lineNumber="1898"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> Builder(ReturnBB);</span></CodeLine>
<Link id="l01899" /><CodeLine lineNumber="1899"></CodeLine>
<Link id="l01900" /><CodeLine lineNumber="1900"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// First, the continuation.</span></CodeLine>
<Link id="l01901" /><CodeLine lineNumber="1901"><span class="doxyHighlight">      ContinuationPhi =</span></CodeLine>
<Link id="l01902" /><CodeLine lineNumber="1902"><span class="doxyHighlight">          Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a876fb556ecea804faa2cd8ad1e498ec3">CreatePHI</a>(<a href="/docs/api/namespaces/llvm/coro/#ad5c7ebab0ec481424c33db8902c652f4af11580a0250ef12842e64f487810cc70">Continuation</a>-&gt;getType(), <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.CoroSuspends.size());</span></CodeLine>
<Link id="l01903" /><CodeLine lineNumber="1903"></CodeLine>
<Link id="l01904" /><CodeLine lineNumber="1904"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Create PHIs for all other return values.</span></CodeLine>
<Link id="l01905" /><CodeLine lineNumber="1905"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(ReturnPHIs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>());</span></CodeLine>
<Link id="l01906" /><CodeLine lineNumber="1906"></CodeLine>
<Link id="l01907" /><CodeLine lineNumber="1907"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Next, all the directly-yielded values.</span></CodeLine>
<Link id="l01908" /><CodeLine lineNumber="1908"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;ResultTy : <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.getRetconResultTypes())</span></CodeLine>
<Link id="l01909" /><CodeLine lineNumber="1909"><span class="doxyHighlight">        ReturnPHIs.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(</span></CodeLine>
<Link id="l01910" /><CodeLine lineNumber="1910"><span class="doxyHighlight">            Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a876fb556ecea804faa2cd8ad1e498ec3">CreatePHI</a>(ResultTy, <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.CoroSuspends.size()));</span></CodeLine>
<Link id="l01911" /><CodeLine lineNumber="1911"></CodeLine>
<Link id="l01912" /><CodeLine lineNumber="1912"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Build the return value.</span></CodeLine>
<Link id="l01913" /><CodeLine lineNumber="1913"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> RetTy = <a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>.getReturnType();</span></CodeLine>
<Link id="l01914" /><CodeLine lineNumber="1914"></CodeLine>
<Link id="l01915" /><CodeLine lineNumber="1915"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Cast the continuation value if necessary.</span></CodeLine>
<Link id="l01916" /><CodeLine lineNumber="1916"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// We can&#39;t rely on the types matching up because that type would</span></CodeLine>
<Link id="l01917" /><CodeLine lineNumber="1917"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// have to be infinite.</span></CodeLine>
<Link id="l01918" /><CodeLine lineNumber="1918"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> CastedContinuationTy =</span></CodeLine>
<Link id="l01919" /><CodeLine lineNumber="1919"><span class="doxyHighlight">          (ReturnPHIs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>() ? RetTy : RetTy-&gt;getStructElementType(0));</span></CodeLine>
<Link id="l01920" /><CodeLine lineNumber="1920"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CastedContinuation =</span></CodeLine>
<Link id="l01921" /><CodeLine lineNumber="1921"><span class="doxyHighlight">          Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a932f08e32ea37a7019902ee467beb268">CreateBitCast</a>(ContinuationPhi, CastedContinuationTy);</span></CodeLine>
<Link id="l01922" /><CodeLine lineNumber="1922"></CodeLine>
<Link id="l01923" /><CodeLine lineNumber="1923"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;RetV = CastedContinuation;</span></CodeLine>
<Link id="l01924" /><CodeLine lineNumber="1924"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!ReturnPHIs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>()) &#123;</span></CodeLine>
<Link id="l01925" /><CodeLine lineNumber="1925"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> ValueIdx = 0;</span></CodeLine>
<Link id="l01926" /><CodeLine lineNumber="1926"><span class="doxyHighlight">        RetV = <a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(RetTy);</span></CodeLine>
<Link id="l01927" /><CodeLine lineNumber="1927"><span class="doxyHighlight">        RetV = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a20833e358e38f9a86074bb4cc72b0d14">CreateInsertValue</a>(RetV, CastedContinuation, ValueIdx++);</span></CodeLine>
<Link id="l01928" /><CodeLine lineNumber="1928"></CodeLine>
<Link id="l01929" /><CodeLine lineNumber="1929"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Phi : ReturnPHIs)</span></CodeLine>
<Link id="l01930" /><CodeLine lineNumber="1930"><span class="doxyHighlight">          RetV = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a20833e358e38f9a86074bb4cc72b0d14">CreateInsertValue</a>(RetV, Phi, ValueIdx++);</span></CodeLine>
<Link id="l01931" /><CodeLine lineNumber="1931"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01932" /><CodeLine lineNumber="1932"></CodeLine>
<Link id="l01933" /><CodeLine lineNumber="1933"><span class="doxyHighlight">      Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a5d0c52ee1cde6421f98c193e0e42b97d">CreateRet</a>(RetV);</span></CodeLine>
<Link id="l01934" /><CodeLine lineNumber="1934"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01935" /><CodeLine lineNumber="1935"></CodeLine>
<Link id="l01936" /><CodeLine lineNumber="1936"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Branch to the return block.</span></CodeLine>
<Link id="l01937" /><CodeLine lineNumber="1937"><span class="doxyHighlight">    Branch-&gt;setSuccessor(0, ReturnBB);</span></CodeLine>
<Link id="l01938" /><CodeLine lineNumber="1938"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(ContinuationPhi);</span></CodeLine>
<Link id="l01939" /><CodeLine lineNumber="1939"><span class="doxyHighlight">    ContinuationPhi-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(<a href="/docs/api/namespaces/llvm/coro/#ad5c7ebab0ec481424c33db8902c652f4af11580a0250ef12842e64f487810cc70">Continuation</a>, SuspendBB);</span></CodeLine>
<Link id="l01940" /><CodeLine lineNumber="1940"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#91;Phi, VUse&#93; :</span></CodeLine>
<Link id="l01941" /><CodeLine lineNumber="1941"><span class="doxyHighlight">         <a href="/docs/api/namespaces/llvm/#a19010bf2388f505d1262e23f9f87a813">llvm::zip&#95;equal</a>(ReturnPHIs, Suspend-&gt;value&#95;operands()))</span></CodeLine>
<Link id="l01942" /><CodeLine lineNumber="1942"><span class="doxyHighlight">      Phi-&gt;addIncoming(VUse, SuspendBB);</span></CodeLine>
<Link id="l01943" /><CodeLine lineNumber="1943"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01944" /><CodeLine lineNumber="1944"></CodeLine>
<Link id="l01945" /><CodeLine lineNumber="1945"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Clones.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() == <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.CoroSuspends.size());</span></CodeLine>
<Link id="l01946" /><CodeLine lineNumber="1946"></CodeLine>
<Link id="l01947" /><CodeLine lineNumber="1947"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a91897d2d0da113b016f14ae110586ab1">MetadataSetTy</a> CommonDebugInfo&#123;collectCommonDebugInfo(<a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>)&#125;;</span></CodeLine>
<Link id="l01948" /><CodeLine lineNumber="1948"></CodeLine>
<Link id="l01949" /><CodeLine lineNumber="1949"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#91;Idx, CS&#93; : <a href="/docs/api/namespaces/llvm/#a206e2134ddd2312c3488d0632d98f554">llvm::enumerate</a>(<a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>.CoroSuspends)) &#123;</span></CodeLine>
<Link id="l01950" /><CodeLine lineNumber="1950"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Suspend = CS;</span></CodeLine>
<Link id="l01951" /><CodeLine lineNumber="1951"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Clone = Clones&#91;Idx&#93;;</span></CodeLine>
<Link id="l01952" /><CodeLine lineNumber="1952"></CodeLine>
<Link id="l01953" /><CodeLine lineNumber="1953"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/coro/basecloner/#a0db1d0e9931350a1fe08aa96d5b5eafc">coro::BaseCloner::createClone</a>(<a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>, </span><span class="doxyHighlightStringLiteral">&quot;resume.&quot;</span><span class="doxyHighlight"> + <a href="/docs/api/classes/llvm/twine">Twine</a>(Idx), <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>, Clone,</span></CodeLine>
<Link id="l01954" /><CodeLine lineNumber="1954"><span class="doxyHighlight">                                  Suspend, <a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>, CommonDebugInfo);</span></CodeLine>
<Link id="l01955" /><CodeLine lineNumber="1955"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01956" /><CodeLine lineNumber="1956"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01957" /><CodeLine lineNumber="1957"></CodeLine>
<Link id="l01958" /><CodeLine lineNumber="1958"><span class="doxyHighlightKeyword">namespace </span><span class="doxyHighlight">&#123;</span></CodeLine>
<Link id="l01959" /><CodeLine lineNumber="1959" lineLink="/docs/api/classes/anonymous-namespace-corosplit-cpp-/prettystacktracefunction"><span class="doxyHighlightKeyword">class </span><span class="doxyHighlight"><a href="/docs/api/classes/anonymous-namespace-corosplit-cpp-/prettystacktracefunction/#acfa7701f89abc7a7a7ddbe94095c0ba5">PrettyStackTraceFunction</a> : </span><span class="doxyHighlightKeyword">public</span><span class="doxyHighlight"> PrettyStackTraceEntry &#123;</span></CodeLine>
<Link id="l01960" /><CodeLine lineNumber="1960"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &amp;F;</span></CodeLine>
<Link id="l01961" /><CodeLine lineNumber="1961"></CodeLine>
<Link id="l01962" /><CodeLine lineNumber="1962"><span class="doxyHighlightKeyword">public</span><span class="doxyHighlight">:</span></CodeLine>
<Link id="l01963" /><CodeLine lineNumber="1963" lineLink="/docs/api/classes/anonymous-namespace-corosplit-cpp-/prettystacktracefunction/#acfa7701f89abc7a7a7ddbe94095c0ba5"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-corosplit-cpp-/prettystacktracefunction/#acfa7701f89abc7a7a7ddbe94095c0ba5">PrettyStackTraceFunction</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;F) : F(F) &#123;&#125;</span></CodeLine>
<Link id="l01964" /><CodeLine lineNumber="1964" lineLink="/docs/api/classes/anonymous-namespace-corosplit-cpp-/prettystacktracefunction/#af754b07f5c0b95b2a933d41b56b3b08b"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-corosplit-cpp-/prettystacktracefunction/#af754b07f5c0b95b2a933d41b56b3b08b">print</a>(<a href="/docs/api/classes/llvm/raw-ostream">raw&#95;ostream</a> &amp;OS)</span><span class="doxyHighlightKeyword"> const override </span><span class="doxyHighlight">&#123;</span></CodeLine>
<Link id="l01965" /><CodeLine lineNumber="1965"><span class="doxyHighlight">    OS &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;While splitting coroutine &quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01966" /><CodeLine lineNumber="1966"><span class="doxyHighlight">    F.printAsOperand(OS, </span><span class="doxyHighlightComment">/&#42;print type&#42;/</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">, F.getParent());</span></CodeLine>
<Link id="l01967" /><CodeLine lineNumber="1967"><span class="doxyHighlight">    OS &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01968" /><CodeLine lineNumber="1968"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01969" /><CodeLine lineNumber="1969"><span class="doxyHighlight">&#125;;</span></CodeLine>
<Link id="l01970" /><CodeLine lineNumber="1970"><span class="doxyHighlight">&#125; </span><span class="doxyHighlightComment">// namespace</span></CodeLine>
<Link id="l01971" /><CodeLine lineNumber="1971"></CodeLine>
<Link id="l01972" /><CodeLine lineNumber="1972"><span class="doxyHighlightComment">/// Remove calls to llvm.coro.end in the original function.</span></CodeLine>
<Link id="l01973" /><CodeLine lineNumber="1973" lineLink="#aa2ead3ae2cc059f459be46ce71ef20a5"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#aa2ead3ae2cc059f459be46ce71ef20a5">removeCoroEndsFromRampFunction</a>(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;Shape) &#123;</span></CodeLine>
<Link id="l01974" /><CodeLine lineNumber="1974"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Shape.<a href="/docs/api/structs/llvm/coro/shape/#a4e554c60419835fc3c74b91b28ca31c8">ABI</a> != <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">coro::ABI::Switch</a>) &#123;</span></CodeLine>
<Link id="l01975" /><CodeLine lineNumber="1975"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;End : Shape.<a href="/docs/api/structs/llvm/coro/shape/#adc470e92d3cd5fb8d54d7b9179841463">CoroEnds</a>) &#123;</span></CodeLine>
<Link id="l01976" /><CodeLine lineNumber="1976"><span class="doxyHighlight">      <a href="#ab289568caaa6647ee577a06e6e12499a">replaceCoroEnd</a>(End, Shape, Shape.<a href="/docs/api/structs/llvm/coro/shape/#a5eac2988672b484645dcbcd706430967">FramePtr</a>, </span><span class="doxyHighlightComment">/&#42;in resume&#42;/</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01977" /><CodeLine lineNumber="1977"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01978" /><CodeLine lineNumber="1978"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l01979" /><CodeLine lineNumber="1979"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/anycoroendinst">llvm::AnyCoroEndInst</a> &#42;End : Shape.<a href="/docs/api/structs/llvm/coro/shape/#adc470e92d3cd5fb8d54d7b9179841463">CoroEnds</a>) &#123;</span></CodeLine>
<Link id="l01980" /><CodeLine lineNumber="1980"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;Context = End-&gt;<a href="/docs/api/classes/llvm/value/#ab3fc0225d8aaf8434026c3573f961f2c">getContext</a>();</span></CodeLine>
<Link id="l01981" /><CodeLine lineNumber="1981"><span class="doxyHighlight">      End-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(<a href="/docs/api/classes/llvm/constantint/#aa7cce62ac5cc6df09cce0535874336b7">ConstantInt::getFalse</a>(Context));</span></CodeLine>
<Link id="l01982" /><CodeLine lineNumber="1982"><span class="doxyHighlight">      End-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</span></CodeLine>
<Link id="l01983" /><CodeLine lineNumber="1983"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01984" /><CodeLine lineNumber="1984"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01985" /><CodeLine lineNumber="1985"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01986" /><CodeLine lineNumber="1986"></CodeLine>
<Link id="l01987" /><CodeLine lineNumber="1987" lineLink="#a80552a6c7d2a87204a411292848a5af0"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#a80552a6c7d2a87204a411292848a5af0">hasSafeElideCaller</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l01988" /><CodeLine lineNumber="1988"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;U : <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.users()) &#123;</span></CodeLine>
<Link id="l01989" /><CodeLine lineNumber="1989"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CB = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CallBase&gt;</a>(U)) &#123;</span></CodeLine>
<Link id="l01990" /><CodeLine lineNumber="1990"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Caller = CB-&gt;getFunction();</span></CodeLine>
<Link id="l01991" /><CodeLine lineNumber="1991"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Caller &amp;&amp; Caller-&gt;isPresplitCoroutine() &amp;&amp;</span></CodeLine>
<Link id="l01992" /><CodeLine lineNumber="1992"><span class="doxyHighlight">          CB-&gt;hasFnAttr(llvm::Attribute::CoroElideSafe))</span></CodeLine>
<Link id="l01993" /><CodeLine lineNumber="1993"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01994" /><CodeLine lineNumber="1994"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01995" /><CodeLine lineNumber="1995"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01996" /><CodeLine lineNumber="1996"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01997" /><CodeLine lineNumber="1997"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01998" /><CodeLine lineNumber="1998"></CodeLine>
<Link id="l01999" /><CodeLine lineNumber="1999" lineLink="/docs/api/classes/llvm/coro/switchabi/#a21cb9b1f8d82f56bd100b1d4dade6b95"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/coro/switchabi/#a21cb9b1f8d82f56bd100b1d4dade6b95">coro::SwitchABI::splitCoroutine</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>, <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;<a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>,</span></CodeLine>
<Link id="l02000" /><CodeLine lineNumber="2000"><span class="doxyHighlight">                                     <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;Function &#42;&gt;</a> &amp;Clones,</span></CodeLine>
<Link id="l02001" /><CodeLine lineNumber="2001"><span class="doxyHighlight">                                     <a href="/docs/api/classes/llvm/targettransforminfo">TargetTransformInfo</a> &amp;<a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>) &#123;</span></CodeLine>
<Link id="l02002" /><CodeLine lineNumber="2002"><span class="doxyHighlight">  <a href="/docs/api/structs/anonymous-namespace-corosplit-cpp-/switchcoroutinesplitter/#af34178528cc721dfa273965733da1f37">SwitchCoroutineSplitter::split</a>(<a href="/docs/api/classes/llvm/coro/baseabi/#a5128305f9a3ef54320d10266e529489c">F</a>, <a href="/docs/api/classes/llvm/coro/baseabi/#ae208c041056adf7cd77a649cadfb07c1">Shape</a>, Clones, <a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>);</span></CodeLine>
<Link id="l02003" /><CodeLine lineNumber="2003"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02004" /><CodeLine lineNumber="2004"></CodeLine>
<Link id="l02005" /><CodeLine lineNumber="2005" lineLink="#a8bf580168c7138b15f7bfdd080416bec"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#a8bf580168c7138b15f7bfdd080416bec">doSplitCoroutine</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;Function &#42;&gt;</a> &amp;Clones,</span></CodeLine>
<Link id="l02006" /><CodeLine lineNumber="2006"><span class="doxyHighlight">                             <a href="/docs/api/classes/llvm/coro/baseabi">coro::BaseABI</a> &amp;ABI, <a href="/docs/api/classes/llvm/targettransforminfo">TargetTransformInfo</a> &amp;<a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>,</span></CodeLine>
<Link id="l02007" /><CodeLine lineNumber="2007"><span class="doxyHighlight">                             </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> OptimizeFrame) &#123;</span></CodeLine>
<Link id="l02008" /><CodeLine lineNumber="2008"><span class="doxyHighlight">  PrettyStackTraceFunction prettyStackTrace(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l02009" /><CodeLine lineNumber="2009"></CodeLine>
<Link id="l02010" /><CodeLine lineNumber="2010"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;Shape = ABI.<a href="/docs/api/structs/llvm/coro/shape/#a36882e56b196a358b82accb17fbaf3ee">Shape</a>;</span></CodeLine>
<Link id="l02011" /><CodeLine lineNumber="2011"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Shape.<a href="/docs/api/structs/llvm/coro/shape/#abfb56acef5d60fefb2edc417f0bfbda0">CoroBegin</a>);</span></CodeLine>
<Link id="l02012" /><CodeLine lineNumber="2012"></CodeLine>
<Link id="l02013" /><CodeLine lineNumber="2013"><span class="doxyHighlight">  <a href="#ab68c3421a2e14ba10398bfcd82d6161e">lowerAwaitSuspends</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, Shape);</span></CodeLine>
<Link id="l02014" /><CodeLine lineNumber="2014"></CodeLine>
<Link id="l02015" /><CodeLine lineNumber="2015"><span class="doxyHighlight">  <a href="#a76d02f8354cb0d3c8b30eb7812ae01b2">simplifySuspendPoints</a>(Shape);</span></CodeLine>
<Link id="l02016" /><CodeLine lineNumber="2016"></CodeLine>
<Link id="l02017" /><CodeLine lineNumber="2017"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/coro/#a8bd87bda26e6aac77644f79dbd06c340">normalizeCoroutine</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, Shape, <a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>);</span></CodeLine>
<Link id="l02018" /><CodeLine lineNumber="2018"><span class="doxyHighlight">  ABI.buildCoroutineFrame(OptimizeFrame);</span></CodeLine>
<Link id="l02019" /><CodeLine lineNumber="2019"><span class="doxyHighlight">  <a href="#a8543371395854bee27033b8e24836cb0">replaceFrameSizeAndAlignment</a>(Shape);</span></CodeLine>
<Link id="l02020" /><CodeLine lineNumber="2020"></CodeLine>
<Link id="l02021" /><CodeLine lineNumber="2021"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> isNoSuspendCoroutine = Shape.<a href="/docs/api/structs/llvm/coro/shape/#a5fd0aa934908c837c6d78097a2fd667b">CoroSuspends</a>.empty();</span></CodeLine>
<Link id="l02022" /><CodeLine lineNumber="2022"></CodeLine>
<Link id="l02023" /><CodeLine lineNumber="2023"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> shouldCreateNoAllocVariant =</span></CodeLine>
<Link id="l02024" /><CodeLine lineNumber="2024"><span class="doxyHighlight">      !isNoSuspendCoroutine &amp;&amp; Shape.<a href="/docs/api/structs/llvm/coro/shape/#a4e554c60419835fc3c74b91b28ca31c8">ABI</a> == <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">coro::ABI::Switch</a> &amp;&amp;</span></CodeLine>
<Link id="l02025" /><CodeLine lineNumber="2025"><span class="doxyHighlight">      <a href="#a80552a6c7d2a87204a411292848a5af0">hasSafeElideCaller</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &amp;&amp; !<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.hasFnAttribute(llvm::Attribute::NoInline);</span></CodeLine>
<Link id="l02026" /><CodeLine lineNumber="2026"></CodeLine>
<Link id="l02027" /><CodeLine lineNumber="2027"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If there are no suspend points, no split required, just remove</span></CodeLine>
<Link id="l02028" /><CodeLine lineNumber="2028"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the allocation and deallocation blocks, they are not needed.</span></CodeLine>
<Link id="l02029" /><CodeLine lineNumber="2029"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (isNoSuspendCoroutine) &#123;</span></CodeLine>
<Link id="l02030" /><CodeLine lineNumber="2030"><span class="doxyHighlight">    <a href="#ab7881567f602c3a94d11e2817f4464e0">handleNoSuspendCoroutine</a>(Shape);</span></CodeLine>
<Link id="l02031" /><CodeLine lineNumber="2031"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l02032" /><CodeLine lineNumber="2032"><span class="doxyHighlight">    ABI.splitCoroutine(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, Shape, Clones, <a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>);</span></CodeLine>
<Link id="l02033" /><CodeLine lineNumber="2033"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02034" /><CodeLine lineNumber="2034"></CodeLine>
<Link id="l02035" /><CodeLine lineNumber="2035"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Replace all the swifterror operations in the original function.</span></CodeLine>
<Link id="l02036" /><CodeLine lineNumber="2036"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// This invalidates SwiftErrorOps in the Shape.</span></CodeLine>
<Link id="l02037" /><CodeLine lineNumber="2037"><span class="doxyHighlight">  <a href="#a236935b2df66a03a0a54350a6b9b84bc">replaceSwiftErrorOps</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, Shape, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02038" /><CodeLine lineNumber="2038"></CodeLine>
<Link id="l02039" /><CodeLine lineNumber="2039"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Salvage debug intrinsics that point into the coroutine frame in the</span></CodeLine>
<Link id="l02040" /><CodeLine lineNumber="2040"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// original function. The Cloner has already salvaged debug info in the new</span></CodeLine>
<Link id="l02041" /><CodeLine lineNumber="2041"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// coroutine funclets.</span></CodeLine>
<Link id="l02042" /><CodeLine lineNumber="2042"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;Argument &#42;, AllocaInst &#42;, 4&gt;</a> ArgToAllocaMap;</span></CodeLine>
<Link id="l02043" /><CodeLine lineNumber="2043"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#91;DbgInsts, DbgVariableRecords&#93; = <a href="#a13dafea5ca0652a4011dd613a8f02494">collectDbgVariableIntrinsics</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l02044" /><CodeLine lineNumber="2044"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;DDI : DbgInsts)</span></CodeLine>
<Link id="l02045" /><CodeLine lineNumber="2045"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/coro/#a14553297713bc2c6012758ee13a2b917">coro::salvageDebugInfo</a>(ArgToAllocaMap, &#42;DDI, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight"> </span><span class="doxyHighlightComment">/&#42;UseEntryValue&#42;/</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02046" /><CodeLine lineNumber="2046"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/dbgvariablerecord">DbgVariableRecord</a> &#42;DVR : DbgVariableRecords)</span></CodeLine>
<Link id="l02047" /><CodeLine lineNumber="2047"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/coro/#a14553297713bc2c6012758ee13a2b917">coro::salvageDebugInfo</a>(ArgToAllocaMap, &#42;DVR, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight"> </span><span class="doxyHighlightComment">/&#42;UseEntryValue&#42;/</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02048" /><CodeLine lineNumber="2048"></CodeLine>
<Link id="l02049" /><CodeLine lineNumber="2049"><span class="doxyHighlight">  <a href="#aa2ead3ae2cc059f459be46ce71ef20a5">removeCoroEndsFromRampFunction</a>(Shape);</span></CodeLine>
<Link id="l02050" /><CodeLine lineNumber="2050"></CodeLine>
<Link id="l02051" /><CodeLine lineNumber="2051"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (shouldCreateNoAllocVariant)</span></CodeLine>
<Link id="l02052" /><CodeLine lineNumber="2052"><span class="doxyHighlight">    <a href="/docs/api/structs/anonymous-namespace-corosplit-cpp-/switchcoroutinesplitter/#af0793991541abccfec5c0d8831612b7b">SwitchCoroutineSplitter::createNoAllocVariant</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, Shape, Clones);</span></CodeLine>
<Link id="l02053" /><CodeLine lineNumber="2053"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02054" /><CodeLine lineNumber="2054"></CodeLine>
<Link id="l02055" /><CodeLine lineNumber="2055" lineLink="#a1d6bceebc19a80123ae26670c7645d1a"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/lazycallgraph/scc">LazyCallGraph::SCC</a> &amp;<a href="#a1d6bceebc19a80123ae26670c7645d1a">updateCallGraphAfterCoroutineSplit</a>(</span></CodeLine>
<Link id="l02056" /><CodeLine lineNumber="2056"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/lazycallgraph/node">LazyCallGraph::Node</a> &amp;<a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;Shape,</span></CodeLine>
<Link id="l02057" /><CodeLine lineNumber="2057"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;Function &#42;&gt;</a> &amp;Clones, <a href="/docs/api/classes/llvm/lazycallgraph/scc">LazyCallGraph::SCC</a> &amp;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>,</span></CodeLine>
<Link id="l02058" /><CodeLine lineNumber="2058"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/lazycallgraph">LazyCallGraph</a> &amp;CG, <a href="/docs/api/namespaces/llvm/#a571b2bbf074b46c75300bd8f14c5ab72">CGSCCAnalysisManager</a> &amp;AM, <a href="/docs/api/structs/llvm/cgsccupdateresult">CGSCCUpdateResult</a> &amp;UR,</span></CodeLine>
<Link id="l02059" /><CodeLine lineNumber="2059"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#adce09a5a0de0e3177eb00e932734af2f">FunctionAnalysisManager</a> &amp;<a href="/docs/api/files/lib/lib/passes/passbuilderbindings-cpp/#a83c7e5ca51099e4efa895791a02fb0ed">FAM</a>) &#123;</span></CodeLine>
<Link id="l02060" /><CodeLine lineNumber="2060"></CodeLine>
<Link id="l02061" /><CodeLine lineNumber="2061"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CurrentSCC = &amp;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>;</span></CodeLine>
<Link id="l02062" /><CodeLine lineNumber="2062"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Clones.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>()) &#123;</span></CodeLine>
<Link id="l02063" /><CodeLine lineNumber="2063"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (Shape.<a href="/docs/api/structs/llvm/coro/shape/#a4e554c60419835fc3c74b91b28ca31c8">ABI</a>) &#123;</span></CodeLine>
<Link id="l02064" /><CodeLine lineNumber="2064"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">coro::ABI::Switch</a>:</span></CodeLine>
<Link id="l02065" /><CodeLine lineNumber="2065"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Each clone in the Switch lowering is independent of the other clones.</span></CodeLine>
<Link id="l02066" /><CodeLine lineNumber="2066"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Let the LazyCallGraph know about each one separately.</span></CodeLine>
<Link id="l02067" /><CodeLine lineNumber="2067"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/function">Function</a> &#42;Clone : Clones)</span></CodeLine>
<Link id="l02068" /><CodeLine lineNumber="2068"><span class="doxyHighlight">        CG.<a href="/docs/api/classes/llvm/lazycallgraph/#a8d76834516af3608993c2add103b3a6f">addSplitFunction</a>(<a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>.getFunction(), &#42;Clone);</span></CodeLine>
<Link id="l02069" /><CodeLine lineNumber="2069"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02070" /><CodeLine lineNumber="2070"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a24aa4117da86c41684ad25742832dfa6">coro::ABI::Async</a>:</span></CodeLine>
<Link id="l02071" /><CodeLine lineNumber="2071"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380aad9d7f07127e321d1358b695c8720166">coro::ABI::Retcon</a>:</span></CodeLine>
<Link id="l02072" /><CodeLine lineNumber="2072"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a6ec6c15fe79ec2274d2c3e79ae4bcc41">coro::ABI::RetconOnce</a>:</span></CodeLine>
<Link id="l02073" /><CodeLine lineNumber="2073"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Each clone in the Async/Retcon lowering references of the other clones.</span></CodeLine>
<Link id="l02074" /><CodeLine lineNumber="2074"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Let the LazyCallGraph know about all of them at once.</span></CodeLine>
<Link id="l02075" /><CodeLine lineNumber="2075"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Clones.empty())</span></CodeLine>
<Link id="l02076" /><CodeLine lineNumber="2076"><span class="doxyHighlight">        CG.<a href="/docs/api/classes/llvm/lazycallgraph/#a952c8adfe8553406e169b98200072a69">addSplitRefRecursiveFunctions</a>(<a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>.getFunction(), Clones);</span></CodeLine>
<Link id="l02077" /><CodeLine lineNumber="2077"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02078" /><CodeLine lineNumber="2078"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02079" /><CodeLine lineNumber="2079"></CodeLine>
<Link id="l02080" /><CodeLine lineNumber="2080"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Let the CGSCC infra handle the changes to the original function.</span></CodeLine>
<Link id="l02081" /><CodeLine lineNumber="2081"><span class="doxyHighlight">    CurrentSCC = &amp;<a href="/docs/api/namespaces/llvm/#a2e739fb4907159062aacbbafea669592">updateCGAndAnalysisManagerForCGSCCPass</a>(CG, &#42;CurrentSCC, <a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>, AM,</span></CodeLine>
<Link id="l02082" /><CodeLine lineNumber="2082"><span class="doxyHighlight">                                                         UR, <a href="/docs/api/files/lib/lib/passes/passbuilderbindings-cpp/#a83c7e5ca51099e4efa895791a02fb0ed">FAM</a>);</span></CodeLine>
<Link id="l02083" /><CodeLine lineNumber="2083"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02084" /><CodeLine lineNumber="2084"></CodeLine>
<Link id="l02085" /><CodeLine lineNumber="2085"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Do some cleanup and let the CGSCC infra see if we&#39;ve cleaned up any edges</span></CodeLine>
<Link id="l02086" /><CodeLine lineNumber="2086"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// to the split functions.</span></CodeLine>
<Link id="l02087" /><CodeLine lineNumber="2087"><span class="doxyHighlight">  <a href="#ac2458e50c1358135964844abe8d8979d">postSplitCleanup</a>(<a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>.getFunction());</span></CodeLine>
<Link id="l02088" /><CodeLine lineNumber="2088"><span class="doxyHighlight">  CurrentSCC = &amp;<a href="/docs/api/namespaces/llvm/#a2a035e8c90cdcf756260ddd5ed0e9a26">updateCGAndAnalysisManagerForFunctionPass</a>(CG, &#42;CurrentSCC, <a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>,</span></CodeLine>
<Link id="l02089" /><CodeLine lineNumber="2089"><span class="doxyHighlight">                                                          AM, UR, <a href="/docs/api/files/lib/lib/passes/passbuilderbindings-cpp/#a83c7e5ca51099e4efa895791a02fb0ed">FAM</a>);</span></CodeLine>
<Link id="l02090" /><CodeLine lineNumber="2090"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &#42;CurrentSCC;</span></CodeLine>
<Link id="l02091" /><CodeLine lineNumber="2091"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02092" /><CodeLine lineNumber="2092"></CodeLine>
<Link id="l02093" /><CodeLine lineNumber="2093"><span class="doxyHighlightComment">/// Replace a call to llvm.coro.prepare.retcon.</span></CodeLine>
<Link id="l02094" /><CodeLine lineNumber="2094" lineLink="#acd162cfe23d841a49056ce6436dd2075"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#acd162cfe23d841a49056ce6436dd2075">replacePrepare</a>(<a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42;Prepare, <a href="/docs/api/classes/llvm/lazycallgraph">LazyCallGraph</a> &amp;CG,</span></CodeLine>
<Link id="l02095" /><CodeLine lineNumber="2095"><span class="doxyHighlight">                           <a href="/docs/api/classes/llvm/lazycallgraph/scc">LazyCallGraph::SCC</a> &amp;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>) &#123;</span></CodeLine>
<Link id="l02096" /><CodeLine lineNumber="2096"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> CastFn = Prepare-&gt;<a href="/docs/api/classes/llvm/callbase/#aabd76e6a8a23a5af1ce4d3c310d88bcd">getArgOperand</a>(0); </span><span class="doxyHighlightComment">// as an i8&#42;</span></CodeLine>
<Link id="l02097" /><CodeLine lineNumber="2097"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Fn = CastFn-&gt;<a href="/docs/api/classes/llvm/value/#a966eb231e7d4e572874d2cb49b18faea">stripPointerCasts</a>();   </span><span class="doxyHighlightComment">// as its original type</span></CodeLine>
<Link id="l02098" /><CodeLine lineNumber="2098"></CodeLine>
<Link id="l02099" /><CodeLine lineNumber="2099"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Attempt to peephole this pattern:</span></CodeLine>
<Link id="l02100" /><CodeLine lineNumber="2100"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    %0 = bitcast &#91;&#91;TYPE&#93;&#93; @some&#95;function to i8&#42;</span></CodeLine>
<Link id="l02101" /><CodeLine lineNumber="2101"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    %1 = call @llvm.coro.prepare.retcon(i8&#42; %0)</span></CodeLine>
<Link id="l02102" /><CodeLine lineNumber="2102"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    %2 = bitcast %1 to &#91;&#91;TYPE&#93;&#93;</span></CodeLine>
<Link id="l02103" /><CodeLine lineNumber="2103"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// ==&gt;</span></CodeLine>
<Link id="l02104" /><CodeLine lineNumber="2104"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    %2 = @some&#95;function</span></CodeLine>
<Link id="l02105" /><CodeLine lineNumber="2105"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/use">Use</a> &amp;U : <a href="/docs/api/namespaces/llvm/#a3d2cdc4a0db233678e7141c9d6ea3419">llvm::make&#95;early&#95;inc&#95;range</a>(Prepare-&gt;<a href="/docs/api/classes/llvm/value/#abf855b7cd63a0cd7f73759e396f280c9">uses</a>())) &#123;</span></CodeLine>
<Link id="l02106" /><CodeLine lineNumber="2106"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Look for bitcasts back to the original function type.</span></CodeLine>
<Link id="l02107" /><CodeLine lineNumber="2107"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Cast = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BitCastInst&gt;</a>(U.getUser());</span></CodeLine>
<Link id="l02108" /><CodeLine lineNumber="2108"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Cast || Cast-&gt;getType() != Fn-&gt;getType())</span></CodeLine>
<Link id="l02109" /><CodeLine lineNumber="2109"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02110" /><CodeLine lineNumber="2110"></CodeLine>
<Link id="l02111" /><CodeLine lineNumber="2111"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Replace and remove the cast.</span></CodeLine>
<Link id="l02112" /><CodeLine lineNumber="2112"><span class="doxyHighlight">    Cast-&gt;replaceAllUsesWith(Fn);</span></CodeLine>
<Link id="l02113" /><CodeLine lineNumber="2113"><span class="doxyHighlight">    Cast-&gt;eraseFromParent();</span></CodeLine>
<Link id="l02114" /><CodeLine lineNumber="2114"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02115" /><CodeLine lineNumber="2115"></CodeLine>
<Link id="l02116" /><CodeLine lineNumber="2116"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Replace any remaining uses with the function as an i8&#42;.</span></CodeLine>
<Link id="l02117" /><CodeLine lineNumber="2117"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// This can never directly be a callee, so we don&#39;t need to update CG.</span></CodeLine>
<Link id="l02118" /><CodeLine lineNumber="2118"><span class="doxyHighlight">  Prepare-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(CastFn);</span></CodeLine>
<Link id="l02119" /><CodeLine lineNumber="2119"><span class="doxyHighlight">  Prepare-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</span></CodeLine>
<Link id="l02120" /><CodeLine lineNumber="2120"></CodeLine>
<Link id="l02121" /><CodeLine lineNumber="2121"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Kill dead bitcasts.</span></CodeLine>
<Link id="l02122" /><CodeLine lineNumber="2122"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">while</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Cast = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BitCastInst&gt;</a>(CastFn)) &#123;</span></CodeLine>
<Link id="l02123" /><CodeLine lineNumber="2123"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Cast-&gt;use&#95;empty())</span></CodeLine>
<Link id="l02124" /><CodeLine lineNumber="2124"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02125" /><CodeLine lineNumber="2125"><span class="doxyHighlight">    CastFn = Cast-&gt;getOperand(0);</span></CodeLine>
<Link id="l02126" /><CodeLine lineNumber="2126"><span class="doxyHighlight">    Cast-&gt;eraseFromParent();</span></CodeLine>
<Link id="l02127" /><CodeLine lineNumber="2127"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02128" /><CodeLine lineNumber="2128"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02129" /><CodeLine lineNumber="2129"></CodeLine>
<Link id="l02130" /><CodeLine lineNumber="2130" lineLink="#a83664bf5c186d5e2d65853f2cce4ec3a"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#a83664bf5c186d5e2d65853f2cce4ec3a">replaceAllPrepares</a>(<a href="/docs/api/classes/llvm/function">Function</a> &#42;PrepareFn, <a href="/docs/api/classes/llvm/lazycallgraph">LazyCallGraph</a> &amp;CG,</span></CodeLine>
<Link id="l02131" /><CodeLine lineNumber="2131"><span class="doxyHighlight">                               <a href="/docs/api/classes/llvm/lazycallgraph/scc">LazyCallGraph::SCC</a> &amp;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>) &#123;</span></CodeLine>
<Link id="l02132" /><CodeLine lineNumber="2132"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a> = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02133" /><CodeLine lineNumber="2133"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/use">Use</a> &amp;<a href="/docs/api/files/lib/lib/option/option-cpp/#a04665169063c8ca1f2ea96c27fc7c2b2">P</a> : <a href="/docs/api/namespaces/llvm/#a3d2cdc4a0db233678e7141c9d6ea3419">llvm::make&#95;early&#95;inc&#95;range</a>(PrepareFn-&gt;<a href="/docs/api/classes/llvm/value/#abf855b7cd63a0cd7f73759e396f280c9">uses</a>())) &#123;</span></CodeLine>
<Link id="l02134" /><CodeLine lineNumber="2134"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Intrinsics can only be used in calls.</span></CodeLine>
<Link id="l02135" /><CodeLine lineNumber="2135"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Prepare = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CallInst&gt;</a>(<a href="/docs/api/files/lib/lib/option/option-cpp/#a04665169063c8ca1f2ea96c27fc7c2b2">P</a>.getUser());</span></CodeLine>
<Link id="l02136" /><CodeLine lineNumber="2136"><span class="doxyHighlight">    <a href="#acd162cfe23d841a49056ce6436dd2075">replacePrepare</a>(Prepare, CG, <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>);</span></CodeLine>
<Link id="l02137" /><CodeLine lineNumber="2137"><span class="doxyHighlight">    <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a> = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02138" /><CodeLine lineNumber="2138"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02139" /><CodeLine lineNumber="2139"></CodeLine>
<Link id="l02140" /><CodeLine lineNumber="2140"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a>;</span></CodeLine>
<Link id="l02141" /><CodeLine lineNumber="2141"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02142" /><CodeLine lineNumber="2142"></CodeLine>
<Link id="l02143" /><CodeLine lineNumber="2143" lineLink="#a68cd8d24134223f2dfaf5f482a56f1fd"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#a68cd8d24134223f2dfaf5f482a56f1fd">addPrepareFunction</a>(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/module">Module</a> &amp;M,</span></CodeLine>
<Link id="l02144" /><CodeLine lineNumber="2144"><span class="doxyHighlight">                               <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;Function &#42;&gt;</a> &amp;Fns,</span></CodeLine>
<Link id="l02145" /><CodeLine lineNumber="2145"><span class="doxyHighlight">                               <a href="/docs/api/classes/llvm/stringref">StringRef</a> Name) &#123;</span></CodeLine>
<Link id="l02146" /><CodeLine lineNumber="2146"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;PrepareFn = M.getFunction(Name);</span></CodeLine>
<Link id="l02147" /><CodeLine lineNumber="2147"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (PrepareFn &amp;&amp; !PrepareFn-&gt;use&#95;empty())</span></CodeLine>
<Link id="l02148" /><CodeLine lineNumber="2148"><span class="doxyHighlight">    Fns.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(PrepareFn);</span></CodeLine>
<Link id="l02149" /><CodeLine lineNumber="2149"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02150" /><CodeLine lineNumber="2150"></CodeLine>
<Link id="l02151" /><CodeLine lineNumber="2151"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> std::unique&#95;ptr&lt;coro::BaseABI&gt;</span></CodeLine>
<Link id="l02152" /><CodeLine lineNumber="2152" lineLink="#a88fd8d22fd3856c5ed785a7d9f2a736e"><span class="doxyHighlight"><a href="#a88fd8d22fd3856c5ed785a7d9f2a736e">CreateNewABI</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> &amp;S,</span></CodeLine>
<Link id="l02153" /><CodeLine lineNumber="2153"><span class="doxyHighlight">             std::function&lt;</span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight">(<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;)&gt; IsMatCallback,</span></CodeLine>
<Link id="l02154" /><CodeLine lineNumber="2154"><span class="doxyHighlight">             </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;CoroSplitPass::BaseABITy&gt;</a> GenCustomABIs) &#123;</span></CodeLine>
<Link id="l02155" /><CodeLine lineNumber="2155"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (S.<a href="/docs/api/structs/llvm/coro/shape/#abfb56acef5d60fefb2edc417f0bfbda0">CoroBegin</a>-&gt;<a href="/docs/api/classes/llvm/corobegininst/#ab257b8543b7b260ed9bd0cf11776f1d7">hasCustomABI</a>()) &#123;</span></CodeLine>
<Link id="l02156" /><CodeLine lineNumber="2156"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> CustomABI = S.<a href="/docs/api/structs/llvm/coro/shape/#abfb56acef5d60fefb2edc417f0bfbda0">CoroBegin</a>-&gt;<a href="/docs/api/classes/llvm/corobegininst/#ac55ea7c80f2d057ece6d44ce81ac2054">getCustomABI</a>();</span></CodeLine>
<Link id="l02157" /><CodeLine lineNumber="2157"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CustomABI &gt;= GenCustomABIs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>())</span></CodeLine>
<Link id="l02158" /><CodeLine lineNumber="2158"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/errorhandling-h/#ace243f5c25697a1107cce46626b3dc94">llvm&#95;unreachable</a>(</span><span class="doxyHighlightStringLiteral">&quot;Custom ABI not found amoung those specified&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02159" /><CodeLine lineNumber="2159"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> GenCustomABIs&#91;CustomABI&#93;(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, S);</span></CodeLine>
<Link id="l02160" /><CodeLine lineNumber="2160"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02161" /><CodeLine lineNumber="2161"></CodeLine>
<Link id="l02162" /><CodeLine lineNumber="2162"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (S.<a href="/docs/api/structs/llvm/coro/shape/#a4e554c60419835fc3c74b91b28ca31c8">ABI</a>) &#123;</span></CodeLine>
<Link id="l02163" /><CodeLine lineNumber="2163"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380abbc155fb2b111bf61c4f5ff892915e6b">coro::ABI::Switch</a>:</span></CodeLine>
<Link id="l02164" /><CodeLine lineNumber="2164"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> std::make&#95;unique&lt;coro::SwitchABI&gt;(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, S, IsMatCallback);</span></CodeLine>
<Link id="l02165" /><CodeLine lineNumber="2165"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a24aa4117da86c41684ad25742832dfa6">coro::ABI::Async</a>:</span></CodeLine>
<Link id="l02166" /><CodeLine lineNumber="2166"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> std::make&#95;unique&lt;coro::AsyncABI&gt;(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, S, IsMatCallback);</span></CodeLine>
<Link id="l02167" /><CodeLine lineNumber="2167"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380aad9d7f07127e321d1358b695c8720166">coro::ABI::Retcon</a>:</span></CodeLine>
<Link id="l02168" /><CodeLine lineNumber="2168"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> std::make&#95;unique&lt;coro::AnyRetconABI&gt;(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, S, IsMatCallback);</span></CodeLine>
<Link id="l02169" /><CodeLine lineNumber="2169"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/coro/#a36a5e731a6e92a83c26e5fee63d12380a6ec6c15fe79ec2274d2c3e79ae4bcc41">coro::ABI::RetconOnce</a>:</span></CodeLine>
<Link id="l02170" /><CodeLine lineNumber="2170"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> std::make&#95;unique&lt;coro::AnyRetconABI&gt;(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, S, IsMatCallback);</span></CodeLine>
<Link id="l02171" /><CodeLine lineNumber="2171"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02172" /><CodeLine lineNumber="2172"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/errorhandling-h/#ace243f5c25697a1107cce46626b3dc94">llvm&#95;unreachable</a>(</span><span class="doxyHighlightStringLiteral">&quot;Unknown ABI&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02173" /><CodeLine lineNumber="2173"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02174" /><CodeLine lineNumber="2174"></CodeLine>
<Link id="l02175" /><CodeLine lineNumber="2175" lineLink="/docs/api/structs/llvm/corosplitpass/#a5f0bac32eb02663f4b3c2cc0adc0b41f"><span class="doxyHighlight"><a href="/docs/api/structs/llvm/corosplitpass/#a5f0bac32eb02663f4b3c2cc0adc0b41f">CoroSplitPass::CoroSplitPass</a>(</span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/structs/llvm/corosplitpass/#acad6a8cfcddc1bd59394c0f2944f306e">OptimizeFrame</a>)</span></CodeLine>
<Link id="l02176" /><CodeLine lineNumber="2176"><span class="doxyHighlight">    : <a href="/docs/api/structs/llvm/corosplitpass/#a60948454dbcc254d144bfe52dc320595">CreateAndInitABI</a>(&#91;&#93;(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, <a href="/docs/api/namespaces/llvm/coro">coro</a>::Shape &amp;S) &#123;</span></CodeLine>
<Link id="l02177" /><CodeLine lineNumber="2177"><span class="doxyHighlight">        std::unique&#95;ptr&lt;coro::BaseABI&gt; ABI =</span></CodeLine>
<Link id="l02178" /><CodeLine lineNumber="2178"><span class="doxyHighlight">            <a href="#a88fd8d22fd3856c5ed785a7d9f2a736e">CreateNewABI</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, S, <a href="/docs/api/namespaces/llvm/coro/#ad2ae5b6314d4de7db633c2181e707132">coro::isTriviallyMaterializable</a>, &#123;&#125;);</span></CodeLine>
<Link id="l02179" /><CodeLine lineNumber="2179"><span class="doxyHighlight">        ABI-&gt;init();</span></CodeLine>
<Link id="l02180" /><CodeLine lineNumber="2180"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> ABI;</span></CodeLine>
<Link id="l02181" /><CodeLine lineNumber="2181"><span class="doxyHighlight">      &#125;),</span></CodeLine>
<Link id="l02182" /><CodeLine lineNumber="2182"><span class="doxyHighlight">      OptimizeFrame(OptimizeFrame) &#123;&#125;</span></CodeLine>
<Link id="l02183" /><CodeLine lineNumber="2183"></CodeLine>
<Link id="l02184" /><CodeLine lineNumber="2184" lineLink="/docs/api/structs/llvm/corosplitpass/#afa5e75aeef01520a39012a69184b317d"><span class="doxyHighlight"><a href="/docs/api/structs/llvm/corosplitpass/#a5f0bac32eb02663f4b3c2cc0adc0b41f">CoroSplitPass::CoroSplitPass</a>(</span></CodeLine>
<Link id="l02185" /><CodeLine lineNumber="2185"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;CoroSplitPass::BaseABITy&gt;</a> GenCustomABIs, </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/structs/llvm/corosplitpass/#acad6a8cfcddc1bd59394c0f2944f306e">OptimizeFrame</a>)</span></CodeLine>
<Link id="l02186" /><CodeLine lineNumber="2186"><span class="doxyHighlight">    : <a href="/docs/api/structs/llvm/corosplitpass/#a60948454dbcc254d144bfe52dc320595">CreateAndInitABI</a>(&#91;=&#93;(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, <a href="/docs/api/namespaces/llvm/coro">coro</a>::Shape &amp;S) &#123;</span></CodeLine>
<Link id="l02187" /><CodeLine lineNumber="2187"><span class="doxyHighlight">        std::unique&#95;ptr&lt;coro::BaseABI&gt; ABI =</span></CodeLine>
<Link id="l02188" /><CodeLine lineNumber="2188"><span class="doxyHighlight">            <a href="#a88fd8d22fd3856c5ed785a7d9f2a736e">CreateNewABI</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, S, <a href="/docs/api/namespaces/llvm/coro/#ad2ae5b6314d4de7db633c2181e707132">coro::isTriviallyMaterializable</a>, GenCustomABIs);</span></CodeLine>
<Link id="l02189" /><CodeLine lineNumber="2189"><span class="doxyHighlight">        ABI-&gt;init();</span></CodeLine>
<Link id="l02190" /><CodeLine lineNumber="2190"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> ABI;</span></CodeLine>
<Link id="l02191" /><CodeLine lineNumber="2191"><span class="doxyHighlight">      &#125;),</span></CodeLine>
<Link id="l02192" /><CodeLine lineNumber="2192"><span class="doxyHighlight">      OptimizeFrame(OptimizeFrame) &#123;&#125;</span></CodeLine>
<Link id="l02193" /><CodeLine lineNumber="2193"></CodeLine>
<Link id="l02194" /><CodeLine lineNumber="2194"><span class="doxyHighlightComment">// For back compatibility, constructor takes a materializable callback and</span></CodeLine>
<Link id="l02195" /><CodeLine lineNumber="2195"><span class="doxyHighlightComment">// creates a generator for an ABI with a modified materializable callback.</span></CodeLine>
<Link id="l02196" /><CodeLine lineNumber="2196" lineLink="/docs/api/structs/llvm/corosplitpass/#a076c212743064432c11c29e2ab0d3564"><span class="doxyHighlight"><a href="/docs/api/structs/llvm/corosplitpass/#a5f0bac32eb02663f4b3c2cc0adc0b41f">CoroSplitPass::CoroSplitPass</a>(std::function&lt;</span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight">(<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;)&gt; IsMatCallback,</span></CodeLine>
<Link id="l02197" /><CodeLine lineNumber="2197"><span class="doxyHighlight">                             </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/structs/llvm/corosplitpass/#acad6a8cfcddc1bd59394c0f2944f306e">OptimizeFrame</a>)</span></CodeLine>
<Link id="l02198" /><CodeLine lineNumber="2198"><span class="doxyHighlight">    : <a href="/docs/api/structs/llvm/corosplitpass/#a60948454dbcc254d144bfe52dc320595">CreateAndInitABI</a>(&#91;=&#93;(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, <a href="/docs/api/namespaces/llvm/coro">coro</a>::Shape &amp;S) &#123;</span></CodeLine>
<Link id="l02199" /><CodeLine lineNumber="2199"><span class="doxyHighlight">        std::unique&#95;ptr&lt;coro::BaseABI&gt; ABI =</span></CodeLine>
<Link id="l02200" /><CodeLine lineNumber="2200"><span class="doxyHighlight">            <a href="#a88fd8d22fd3856c5ed785a7d9f2a736e">CreateNewABI</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, S, IsMatCallback, &#123;&#125;);</span></CodeLine>
<Link id="l02201" /><CodeLine lineNumber="2201"><span class="doxyHighlight">        ABI-&gt;init();</span></CodeLine>
<Link id="l02202" /><CodeLine lineNumber="2202"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> ABI;</span></CodeLine>
<Link id="l02203" /><CodeLine lineNumber="2203"><span class="doxyHighlight">      &#125;),</span></CodeLine>
<Link id="l02204" /><CodeLine lineNumber="2204"><span class="doxyHighlight">      OptimizeFrame(OptimizeFrame) &#123;&#125;</span></CodeLine>
<Link id="l02205" /><CodeLine lineNumber="2205"></CodeLine>
<Link id="l02206" /><CodeLine lineNumber="2206"><span class="doxyHighlightComment">// For back compatibility, constructor takes a materializable callback and</span></CodeLine>
<Link id="l02207" /><CodeLine lineNumber="2207"><span class="doxyHighlightComment">// creates a generator for an ABI with a modified materializable callback.</span></CodeLine>
<Link id="l02208" /><CodeLine lineNumber="2208" lineLink="/docs/api/structs/llvm/corosplitpass/#a2b8dc4c3114b5872109bd5499f965f00"><span class="doxyHighlight"><a href="/docs/api/structs/llvm/corosplitpass/#a5f0bac32eb02663f4b3c2cc0adc0b41f">CoroSplitPass::CoroSplitPass</a>(</span></CodeLine>
<Link id="l02209" /><CodeLine lineNumber="2209"><span class="doxyHighlight">    std::function&lt;</span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight">(<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;)&gt; IsMatCallback,</span></CodeLine>
<Link id="l02210" /><CodeLine lineNumber="2210"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;CoroSplitPass::BaseABITy&gt;</a> GenCustomABIs, </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/structs/llvm/corosplitpass/#acad6a8cfcddc1bd59394c0f2944f306e">OptimizeFrame</a>)</span></CodeLine>
<Link id="l02211" /><CodeLine lineNumber="2211"><span class="doxyHighlight">    : <a href="/docs/api/structs/llvm/corosplitpass/#a60948454dbcc254d144bfe52dc320595">CreateAndInitABI</a>(&#91;=&#93;(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, <a href="/docs/api/namespaces/llvm/coro">coro</a>::Shape &amp;S) &#123;</span></CodeLine>
<Link id="l02212" /><CodeLine lineNumber="2212"><span class="doxyHighlight">        std::unique&#95;ptr&lt;coro::BaseABI&gt; ABI =</span></CodeLine>
<Link id="l02213" /><CodeLine lineNumber="2213"><span class="doxyHighlight">            <a href="#a88fd8d22fd3856c5ed785a7d9f2a736e">CreateNewABI</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, S, IsMatCallback, GenCustomABIs);</span></CodeLine>
<Link id="l02214" /><CodeLine lineNumber="2214"><span class="doxyHighlight">        ABI-&gt;init();</span></CodeLine>
<Link id="l02215" /><CodeLine lineNumber="2215"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> ABI;</span></CodeLine>
<Link id="l02216" /><CodeLine lineNumber="2216"><span class="doxyHighlight">      &#125;),</span></CodeLine>
<Link id="l02217" /><CodeLine lineNumber="2217"><span class="doxyHighlight">      OptimizeFrame(OptimizeFrame) &#123;&#125;</span></CodeLine>
<Link id="l02218" /><CodeLine lineNumber="2218"></CodeLine>
<Link id="l02219" /><CodeLine lineNumber="2219" lineLink="/docs/api/structs/llvm/corosplitpass/#a47f6589634ad33a13369ace133b9f4b2"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/preservedanalyses">PreservedAnalyses</a> <a href="/docs/api/structs/llvm/corosplitpass/#a47f6589634ad33a13369ace133b9f4b2">CoroSplitPass::run</a>(<a href="/docs/api/classes/llvm/lazycallgraph/scc">LazyCallGraph::SCC</a> &amp;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>,</span></CodeLine>
<Link id="l02220" /><CodeLine lineNumber="2220"><span class="doxyHighlight">                                     <a href="/docs/api/namespaces/llvm/#a571b2bbf074b46c75300bd8f14c5ab72">CGSCCAnalysisManager</a> &amp;AM,</span></CodeLine>
<Link id="l02221" /><CodeLine lineNumber="2221"><span class="doxyHighlight">                                     <a href="/docs/api/classes/llvm/lazycallgraph">LazyCallGraph</a> &amp;CG, <a href="/docs/api/structs/llvm/cgsccupdateresult">CGSCCUpdateResult</a> &amp;UR) &#123;</span></CodeLine>
<Link id="l02222" /><CodeLine lineNumber="2222"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// NB: One invariant of a valid LazyCallGraph::SCC is that it must contain a</span></CodeLine>
<Link id="l02223" /><CodeLine lineNumber="2223"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     non-zero number of nodes, so we assume that here and grab the first</span></CodeLine>
<Link id="l02224" /><CodeLine lineNumber="2224"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     node&#39;s function&#39;s module.</span></CodeLine>
<Link id="l02225" /><CodeLine lineNumber="2225"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/module">Module</a> &amp;M = &#42;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>.begin()-&gt;getFunction().getParent();</span></CodeLine>
<Link id="l02226" /><CodeLine lineNumber="2226"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;<a href="/docs/api/files/lib/lib/passes/passbuilderbindings-cpp/#a83c7e5ca51099e4efa895791a02fb0ed">FAM</a> =</span></CodeLine>
<Link id="l02227" /><CodeLine lineNumber="2227"><span class="doxyHighlight">      AM.<a href="/docs/api/classes/llvm/analysismanager/#aaab1fad63e4f3b8679469720a873fedd">getResult</a>&lt;<a href="/docs/api/classes/llvm/functionanalysismanagercgsccproxy">FunctionAnalysisManagerCGSCCProxy</a>&gt;(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, CG).getManager();</span></CodeLine>
<Link id="l02228" /><CodeLine lineNumber="2228"></CodeLine>
<Link id="l02229" /><CodeLine lineNumber="2229"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Check for uses of llvm.coro.prepare.retcon/async.</span></CodeLine>
<Link id="l02230" /><CodeLine lineNumber="2230"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Function &#42;, 2&gt;</a> PrepareFns;</span></CodeLine>
<Link id="l02231" /><CodeLine lineNumber="2231"><span class="doxyHighlight">  <a href="#a68cd8d24134223f2dfaf5f482a56f1fd">addPrepareFunction</a>(M, PrepareFns, </span><span class="doxyHighlightStringLiteral">&quot;llvm.coro.prepare.retcon&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02232" /><CodeLine lineNumber="2232"><span class="doxyHighlight">  <a href="#a68cd8d24134223f2dfaf5f482a56f1fd">addPrepareFunction</a>(M, PrepareFns, </span><span class="doxyHighlightStringLiteral">&quot;llvm.coro.prepare.async&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02233" /><CodeLine lineNumber="2233"></CodeLine>
<Link id="l02234" /><CodeLine lineNumber="2234"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Find coroutines for processing.</span></CodeLine>
<Link id="l02235" /><CodeLine lineNumber="2235"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;LazyCallGraph::Node &#42;&gt;</a> Coroutines;</span></CodeLine>
<Link id="l02236" /><CodeLine lineNumber="2236"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/lazycallgraph/node">LazyCallGraph::Node</a> &amp;<a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a> : <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>)</span></CodeLine>
<Link id="l02237" /><CodeLine lineNumber="2237"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>.getFunction().isPresplitCoroutine())</span></CodeLine>
<Link id="l02238" /><CodeLine lineNumber="2238"><span class="doxyHighlight">      Coroutines.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&amp;<a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>);</span></CodeLine>
<Link id="l02239" /><CodeLine lineNumber="2239"></CodeLine>
<Link id="l02240" /><CodeLine lineNumber="2240"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Coroutines.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>() &amp;&amp; PrepareFns.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>())</span></CodeLine>
<Link id="l02241" /><CodeLine lineNumber="2241"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/preservedanalyses/#a1258a1ff55557c27684010ebd7283712">PreservedAnalyses::all</a>();</span></CodeLine>
<Link id="l02242" /><CodeLine lineNumber="2242"></CodeLine>
<Link id="l02243" /><CodeLine lineNumber="2243"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CurrentSCC = &amp;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>;</span></CodeLine>
<Link id="l02244" /><CodeLine lineNumber="2244"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Split all the coroutines.</span></CodeLine>
<Link id="l02245" /><CodeLine lineNumber="2245"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/lazycallgraph/node">LazyCallGraph::Node</a> &#42;<a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a> : Coroutines) &#123;</span></CodeLine>
<Link id="l02246" /><CodeLine lineNumber="2246"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = <a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>-&gt;getFunction();</span></CodeLine>
<Link id="l02247" /><CodeLine lineNumber="2247"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;CoroSplit: Processing coroutine &#39;&quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getName()</span></CodeLine>
<Link id="l02248" /><CodeLine lineNumber="2248"><span class="doxyHighlight">                      &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02249" /><CodeLine lineNumber="2249"></CodeLine>
<Link id="l02250" /><CodeLine lineNumber="2250"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// The suspend-crossing algorithm in buildCoroutineFrame gets tripped up</span></CodeLine>
<Link id="l02251" /><CodeLine lineNumber="2251"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// by unreachable blocks, so remove them as a first pass. Remove the</span></CodeLine>
<Link id="l02252" /><CodeLine lineNumber="2252"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// unreachable blocks before collecting intrinsics into Shape.</span></CodeLine>
<Link id="l02253" /><CodeLine lineNumber="2253"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#aec88b7682025edff7984c3b6c8da8ac9">removeUnreachableBlocks</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l02254" /><CodeLine lineNumber="2254"></CodeLine>
<Link id="l02255" /><CodeLine lineNumber="2255"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/coro/shape">coro::Shape</a> Shape(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l02256" /><CodeLine lineNumber="2256"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Shape.<a href="/docs/api/structs/llvm/coro/shape/#abfb56acef5d60fefb2edc417f0bfbda0">CoroBegin</a>)</span></CodeLine>
<Link id="l02257" /><CodeLine lineNumber="2257"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02258" /><CodeLine lineNumber="2258"></CodeLine>
<Link id="l02259" /><CodeLine lineNumber="2259"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.setSplittedCoroutine();</span></CodeLine>
<Link id="l02260" /><CodeLine lineNumber="2260"></CodeLine>
<Link id="l02261" /><CodeLine lineNumber="2261"><span class="doxyHighlight">    std::unique&#95;ptr&lt;coro::BaseABI&gt; ABI = <a href="/docs/api/structs/llvm/corosplitpass/#a60948454dbcc254d144bfe52dc320595">CreateAndInitABI</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, Shape);</span></CodeLine>
<Link id="l02262" /><CodeLine lineNumber="2262"></CodeLine>
<Link id="l02263" /><CodeLine lineNumber="2263"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Function &#42;, 4&gt;</a> Clones;</span></CodeLine>
<Link id="l02264" /><CodeLine lineNumber="2264"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;<a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a> = <a href="/docs/api/files/lib/lib/passes/passbuilderbindings-cpp/#a83c7e5ca51099e4efa895791a02fb0ed">FAM</a>.getResult&lt;<a href="/docs/api/classes/llvm/targetiranalysis">TargetIRAnalysis</a>&gt;(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l02265" /><CodeLine lineNumber="2265"><span class="doxyHighlight">    <a href="#a8bf580168c7138b15f7bfdd080416bec">doSplitCoroutine</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, Clones, &#42;ABI, <a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>, <a href="/docs/api/structs/llvm/corosplitpass/#acad6a8cfcddc1bd59394c0f2944f306e">OptimizeFrame</a>);</span></CodeLine>
<Link id="l02266" /><CodeLine lineNumber="2266"><span class="doxyHighlight">    CurrentSCC = &amp;<a href="#a1d6bceebc19a80123ae26670c7645d1a">updateCallGraphAfterCoroutineSplit</a>(</span></CodeLine>
<Link id="l02267" /><CodeLine lineNumber="2267"><span class="doxyHighlight">        &#42;<a href="/docs/api/files/lib/lib/support/regcomp-c/#a0240ac851181b84ac374872dc5434ee4">N</a>, Shape, Clones, &#42;CurrentSCC, CG, AM, UR, <a href="/docs/api/files/lib/lib/passes/passbuilderbindings-cpp/#a83c7e5ca51099e4efa895791a02fb0ed">FAM</a>);</span></CodeLine>
<Link id="l02268" /><CodeLine lineNumber="2268"></CodeLine>
<Link id="l02269" /><CodeLine lineNumber="2269"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;ORE = <a href="/docs/api/files/lib/lib/passes/passbuilderbindings-cpp/#a83c7e5ca51099e4efa895791a02fb0ed">FAM</a>.getResult&lt;<a href="/docs/api/classes/llvm/optimizationremarkemitteranalysis">OptimizationRemarkEmitterAnalysis</a>&gt;(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l02270" /><CodeLine lineNumber="2270"><span class="doxyHighlight">    ORE.emit(&#91;&amp;&#93;() &#123;</span></CodeLine>
<Link id="l02271" /><CodeLine lineNumber="2271"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/optimizationremark">OptimizationRemark</a>(<a href="/docs/api/files/include/include/llvm/include/llvm/adt/genericcycleimpl-h/#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>, </span><span class="doxyHighlightStringLiteral">&quot;CoroSplit&quot;</span><span class="doxyHighlight">, &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>)</span></CodeLine>
<Link id="l02272" /><CodeLine lineNumber="2272"><span class="doxyHighlight">             &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Split &#39;&quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="/docs/api/namespaces/llvm/ore/#a5ca06dfbc998afac005414d8e9b7c234">ore::NV</a>(</span><span class="doxyHighlightStringLiteral">&quot;function&quot;</span><span class="doxyHighlight">, <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getName())</span></CodeLine>
<Link id="l02273" /><CodeLine lineNumber="2273"><span class="doxyHighlight">             &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;&#39; (frame&#95;size=&quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="/docs/api/namespaces/llvm/ore/#a5ca06dfbc998afac005414d8e9b7c234">ore::NV</a>(</span><span class="doxyHighlightStringLiteral">&quot;frame&#95;size&quot;</span><span class="doxyHighlight">, Shape.<a href="/docs/api/structs/llvm/coro/shape/#a742806b2e667a87817ae171e1ec59826">FrameSize</a>)</span></CodeLine>
<Link id="l02274" /><CodeLine lineNumber="2274"><span class="doxyHighlight">             &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;, align=&quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="/docs/api/namespaces/llvm/ore/#a5ca06dfbc998afac005414d8e9b7c234">ore::NV</a>(</span><span class="doxyHighlightStringLiteral">&quot;align&quot;</span><span class="doxyHighlight">, Shape.<a href="/docs/api/structs/llvm/coro/shape/#a0a1a8e48ba1e5d845e979d5da8de597d">FrameAlign</a>.<a href="/docs/api/structs/llvm/align/#a80735739b49cf97a491922c8f9af2cc1">value</a>()) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;)&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02275" /><CodeLine lineNumber="2275"><span class="doxyHighlight">    &#125;);</span></CodeLine>
<Link id="l02276" /><CodeLine lineNumber="2276"></CodeLine>
<Link id="l02277" /><CodeLine lineNumber="2277"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Shape.<a href="/docs/api/structs/llvm/coro/shape/#a5fd0aa934908c837c6d78097a2fd667b">CoroSuspends</a>.empty()) &#123;</span></CodeLine>
<Link id="l02278" /><CodeLine lineNumber="2278"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Run the CGSCC pipeline on the original and newly split functions.</span></CodeLine>
<Link id="l02279" /><CodeLine lineNumber="2279"><span class="doxyHighlight">      UR.<a href="/docs/api/structs/llvm/cgsccupdateresult/#a277c9d45b3b20308e166249fd56598ed">CWorklist</a>.insert(CurrentSCC);</span></CodeLine>
<Link id="l02280" /><CodeLine lineNumber="2280"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/function">Function</a> &#42;Clone : Clones)</span></CodeLine>
<Link id="l02281" /><CodeLine lineNumber="2281"><span class="doxyHighlight">        UR.<a href="/docs/api/structs/llvm/cgsccupdateresult/#a277c9d45b3b20308e166249fd56598ed">CWorklist</a>.insert(CG.<a href="/docs/api/classes/llvm/lazycallgraph/#ad234c24f90aaa0fa3f30ac9c750883b6">lookupSCC</a>(CG.<a href="/docs/api/classes/llvm/lazycallgraph/#ad03c103c6345a262195c485df88d2a21">get</a>(&#42;Clone)));</span></CodeLine>
<Link id="l02282" /><CodeLine lineNumber="2282"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02283" /><CodeLine lineNumber="2283"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02284" /><CodeLine lineNumber="2284"></CodeLine>
<Link id="l02285" /><CodeLine lineNumber="2285"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;PrepareFn : PrepareFns) &#123;</span></CodeLine>
<Link id="l02286" /><CodeLine lineNumber="2286"><span class="doxyHighlight">    <a href="#a83664bf5c186d5e2d65853f2cce4ec3a">replaceAllPrepares</a>(PrepareFn, CG, &#42;CurrentSCC);</span></CodeLine>
<Link id="l02287" /><CodeLine lineNumber="2287"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02288" /><CodeLine lineNumber="2288"></CodeLine>
<Link id="l02289" /><CodeLine lineNumber="2289"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/preservedanalyses/#a03797a73044a81cbc6a3409d6c72ee8f">PreservedAnalyses::none</a>();</span></CodeLine>
<Link id="l02290" /><CodeLine lineNumber="2290"><span class="doxyHighlight">&#125;</span></CodeLine>

</ProgramListing>


</DoxygenPage>
