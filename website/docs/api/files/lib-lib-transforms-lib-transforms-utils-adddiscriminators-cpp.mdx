---

# DO NOT EDIT!
# Automatically generated via docusaurus-plugin-doxygen by Doxygen.

slug: /api/files/lib/lib/transforms/lib/transforms/utils/adddiscriminators-cpp
custom_edit_url: null
keywords:
  - doxygen
  - reference
  - file

---

import Link from '@docusaurus/Link'
import CodeBlock from '@theme/CodeBlock'

import CodeLine from '@xpack/docusaurus-plugin-doxygen/components/CodeLine'
import DoxygenPage from '@xpack/docusaurus-plugin-doxygen/components/DoxygenPage'
import IncludesList from '@xpack/docusaurus-plugin-doxygen/components/IncludesList'
import IncludesListItem from '@xpack/docusaurus-plugin-doxygen/components/IncludesListItem'
import MemberDefinition from '@xpack/docusaurus-plugin-doxygen/components/MemberDefinition'
import MembersIndex from '@xpack/docusaurus-plugin-doxygen/components/MembersIndex'
import MembersIndexItem from '@xpack/docusaurus-plugin-doxygen/components/MembersIndexItem'
import ProgramListing from '@xpack/docusaurus-plugin-doxygen/components/ProgramListing'
import SectionDefinition from '@xpack/docusaurus-plugin-doxygen/components/SectionDefinition'

import pluginConfig from '@site/docusaurus-plugin-doxygen-config.json'

# The `AddDiscriminators.cpp` File Reference

<DoxygenPage pluginConfig={pluginConfig}>



## Included Headers

<IncludesList>
<IncludesListItem
  filePath="llvm/Transforms/Utils/AddDiscriminators.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/adddiscriminators-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/DenseMap.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/densemap-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/DenseSet.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/denseset-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/StringRef.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/stringref-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/BasicBlock.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/basicblock-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/DebugInfoMetadata.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/debuginfometadata-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Function.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/function-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Instruction.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/instruction-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Instructions.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/instructions-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/IntrinsicInst.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/intrinsicinst-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/PassManager.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/passmanager-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/Casting.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/casting-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/CommandLine.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/Debug.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/debug-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/raw_ostream.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/raw-ostream-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/SampleProfileLoaderBaseUtil.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/sampleprofileloaderbaseutil-h"
  isLocal="true" />
<IncludesListItem
  filePath="utility"
  permalink=""
  isLocal="false" />
</IncludesList>

## Functions Index

<MembersIndex>

<MembersIndexItem
  type="bool"
  name={<><a href="#a6201294406f0d7ffae87b86d867045f8">addDiscriminators</a> (Function &amp;F)</>}>
Assign DWARF discriminators. <a href="#a6201294406f0d7ffae87b86d867045f8">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a80b3b9cef1539f6a37cd6a19af09933e">shouldHaveDiscriminator</a> (const Instruction &#42;I)</>}>
</MembersIndexItem>

</MembersIndex>

## Variables Index

<MembersIndex>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a5337a668286392f40c0935dc25471710">NoDiscriminators</a></>}>
</MembersIndexItem>

</MembersIndex>

## Defines Index

<MembersIndex>

<MembersIndexItem
  type="#define"
  name={<><a href="#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>&nbsp;&nbsp;&nbsp;&quot;add-discriminators&quot;</>}>
</MembersIndexItem>

</MembersIndex>


<SectionDefinition>

## Functions

### addDiscriminators() {#a6201294406f0d7ffae87b86d867045f8}

<MemberDefinition
  prototype={<>static bool addDiscriminators (<a href="/docs/api/classes/llvm/function">Function</a> &amp; F)</>}
  labels = {["static"]}>
Assign DWARF discriminators.

To assign discriminators, we examine the boundaries of every basic block and its successors. Suppose there is a basic block B1 with successor B2. The last instruction I1 in B1 and the first instruction I2 in B2 are located at the same file and line number. This situation is illustrated in the following code snippet: 

<CodeBlock>
  if (i &lt; 10) x = i;

entry:
  br i1 %cmp, label %if.then, label %if.end, !dbg !10
if.then:
  %1 = load i32&#42; %i.addr, align 4, !dbg !10
  store i32 %1, i32&#42; %x, align 4, !dbg !10
  br label %if.end, !dbg !10
if.end:
  ret void, !dbg !12
</CodeBlock>

Notice how the branch instruction in block &#39;entry&#39; and all the instructions in block &#39;if.then&#39; have the exact same debug location information (!dbg !10).

To distinguish instructions in block &#39;entry&#39; from instructions in block &#39;if.then&#39;, we generate a new lexical block for all the instruction in block &#39;if.then&#39; that share the same file and line location with the last instruction of block &#39;entry&#39;.

This new lexical block will have the same location information as the previous one, but with a new DWARF discriminator value.

One of the main uses of this discriminator value is in runtime sample profilers. It allows the profiler to distinguish instructions at location !dbg !10 that execute on different basic blocks. This is important because while the predicate &#39;if (x &lt; 10)&#39; may have been executed millions of times, the assignment &#39;x = i&#39; may have only executed a handful of times (meaning that the entry-&gt;if.then edge is seldom taken).

If we did not have discriminator information, the profiler would assign the same weight to both blocks &#39;entry&#39; and &#39;if.then&#39;, which in turn will make it conclude that the entry-&gt;if.then edge is very hot.

To decide where to create new discriminator values, this function traverses the CFG and examines instruction at basic block boundaries. If the last instruction I1 of a block B1 is at the same file and line location as instruction I2 of successor B2, then it creates a new lexical block for I2 and all the instruction in B2 that share the same file and line location as I2. This new lexical block will have a different discriminator number than I1.

Definition at line <a href="#l00140">140</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/adddiscriminators-cpp">AddDiscriminators.cpp</a>.
</MemberDefinition>

### shouldHaveDiscriminator() {#a80b3b9cef1539f6a37cd6a19af09933e}

<MemberDefinition
  prototype={<>static bool shouldHaveDiscriminator (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42; I)</>}
  labels = {["static"]}>

Definition at line <a href="#l00085">85</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/adddiscriminators-cpp">AddDiscriminators.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Variables

### NoDiscriminators {#a5337a668286392f40c0935dc25471710}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; NoDiscriminators(&quot;no-discriminators&quot;, cl::init(false), cl::desc(&quot;Disable generation of discriminator information.&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00081">81</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/adddiscriminators-cpp">AddDiscriminators.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Defines

### DEBUG&#95;TYPE {#ad78e062f62e0d6e453941fb4ca843e4d}

<MemberDefinition
  prototype={<>#define DEBUG&#95;TYPE&nbsp;&nbsp;&nbsp;&quot;add-discriminators&quot;</>}>

Definition at line <a href="#l00076">76</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/adddiscriminators-cpp">AddDiscriminators.cpp</a>.
</MemberDefinition>

</SectionDefinition>

## File Listing

The file content with the documentation metadata removed is:

<ProgramListing>

<Link id="l00001" /><CodeLine lineNumber="1"><span class="doxyHighlightComment">//===- AddDiscriminators.cpp - Insert DWARF path discriminators -----------===//</span></CodeLine>
<Link id="l00002" /><CodeLine lineNumber="2"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00003" /><CodeLine lineNumber="3"><span class="doxyHighlightComment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</span></CodeLine>
<Link id="l00004" /><CodeLine lineNumber="4"><span class="doxyHighlightComment">// See https://llvm.org/LICENSE.txt for license information.</span></CodeLine>
<Link id="l00005" /><CodeLine lineNumber="5"><span class="doxyHighlightComment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</span></CodeLine>
<Link id="l00006" /><CodeLine lineNumber="6"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00007" /><CodeLine lineNumber="7"><span class="doxyHighlightComment">//===----------------------------------------------------------------------===//</span></CodeLine>
<Link id="l00008" /><CodeLine lineNumber="8"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00009" /><CodeLine lineNumber="9"><span class="doxyHighlightComment">// This file adds DWARF discriminators to the IR. Path discriminators are</span></CodeLine>
<Link id="l00010" /><CodeLine lineNumber="10"><span class="doxyHighlightComment">// used to decide what CFG path was taken inside sub-graphs whose instructions</span></CodeLine>
<Link id="l00011" /><CodeLine lineNumber="11"><span class="doxyHighlightComment">// share the same line and column number information.</span></CodeLine>
<Link id="l00012" /><CodeLine lineNumber="12"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00013" /><CodeLine lineNumber="13"><span class="doxyHighlightComment">// The main user of this is the sample profiler. Instruction samples are</span></CodeLine>
<Link id="l00014" /><CodeLine lineNumber="14"><span class="doxyHighlightComment">// mapped to line number information. Since a single line may be spread</span></CodeLine>
<Link id="l00015" /><CodeLine lineNumber="15"><span class="doxyHighlightComment">// out over several basic blocks, discriminators add more precise location</span></CodeLine>
<Link id="l00016" /><CodeLine lineNumber="16"><span class="doxyHighlightComment">// for the samples.</span></CodeLine>
<Link id="l00017" /><CodeLine lineNumber="17"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00018" /><CodeLine lineNumber="18"><span class="doxyHighlightComment">// For example,</span></CodeLine>
<Link id="l00019" /><CodeLine lineNumber="19"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00020" /><CodeLine lineNumber="20"><span class="doxyHighlightComment">//   1  #define ASSERT(P)</span></CodeLine>
<Link id="l00021" /><CodeLine lineNumber="21"><span class="doxyHighlightComment">//   2      if (!(P))</span></CodeLine>
<Link id="l00022" /><CodeLine lineNumber="22"><span class="doxyHighlightComment">//   3        abort()</span></CodeLine>
<Link id="l00023" /><CodeLine lineNumber="23"><span class="doxyHighlightComment">//   ...</span></CodeLine>
<Link id="l00024" /><CodeLine lineNumber="24"><span class="doxyHighlightComment">//   100   while (true) &#123;</span></CodeLine>
<Link id="l00025" /><CodeLine lineNumber="25"><span class="doxyHighlightComment">//   101     ASSERT (sum &lt; 0);</span></CodeLine>
<Link id="l00026" /><CodeLine lineNumber="26"><span class="doxyHighlightComment">//   102     ...</span></CodeLine>
<Link id="l00027" /><CodeLine lineNumber="27"><span class="doxyHighlightComment">//   130   &#125;</span></CodeLine>
<Link id="l00028" /><CodeLine lineNumber="28"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00029" /><CodeLine lineNumber="29"><span class="doxyHighlightComment">// when converted to IR, this snippet looks something like:</span></CodeLine>
<Link id="l00030" /><CodeLine lineNumber="30"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00031" /><CodeLine lineNumber="31"><span class="doxyHighlightComment">// while.body:                                       ; preds = %entry, %if.end</span></CodeLine>
<Link id="l00032" /><CodeLine lineNumber="32"><span class="doxyHighlightComment">//   %0 = load i32&#42; %sum, align 4, !dbg !15</span></CodeLine>
<Link id="l00033" /><CodeLine lineNumber="33"><span class="doxyHighlightComment">//   %cmp = icmp slt i32 %0, 0, !dbg !15</span></CodeLine>
<Link id="l00034" /><CodeLine lineNumber="34"><span class="doxyHighlightComment">//   br i1 %cmp, label %if.end, label %if.then, !dbg !15</span></CodeLine>
<Link id="l00035" /><CodeLine lineNumber="35"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00036" /><CodeLine lineNumber="36"><span class="doxyHighlightComment">// if.then:                                          ; preds = %while.body</span></CodeLine>
<Link id="l00037" /><CodeLine lineNumber="37"><span class="doxyHighlightComment">//   call void @abort(), !dbg !15</span></CodeLine>
<Link id="l00038" /><CodeLine lineNumber="38"><span class="doxyHighlightComment">//   br label %if.end, !dbg !15</span></CodeLine>
<Link id="l00039" /><CodeLine lineNumber="39"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00040" /><CodeLine lineNumber="40"><span class="doxyHighlightComment">// Notice that all the instructions in blocks &#39;while.body&#39; and &#39;if.then&#39;</span></CodeLine>
<Link id="l00041" /><CodeLine lineNumber="41"><span class="doxyHighlightComment">// have exactly the same debug information. When this program is sampled</span></CodeLine>
<Link id="l00042" /><CodeLine lineNumber="42"><span class="doxyHighlightComment">// at runtime, the profiler will assume that all these instructions are</span></CodeLine>
<Link id="l00043" /><CodeLine lineNumber="43"><span class="doxyHighlightComment">// equally frequent. This, in turn, will consider the edge while.body-&gt;if.then</span></CodeLine>
<Link id="l00044" /><CodeLine lineNumber="44"><span class="doxyHighlightComment">// to be frequently taken (which is incorrect).</span></CodeLine>
<Link id="l00045" /><CodeLine lineNumber="45"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00046" /><CodeLine lineNumber="46"><span class="doxyHighlightComment">// By adding a discriminator value to the instructions in block &#39;if.then&#39;,</span></CodeLine>
<Link id="l00047" /><CodeLine lineNumber="47"><span class="doxyHighlightComment">// we can distinguish instructions at line 101 with discriminator 0 from</span></CodeLine>
<Link id="l00048" /><CodeLine lineNumber="48"><span class="doxyHighlightComment">// the instructions at line 101 with discriminator 1</span></CodeLine>
<Link id="l00049" /><CodeLine lineNumber="49"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00050" /><CodeLine lineNumber="50"><span class="doxyHighlightComment">// For more details about DWARF discriminators, please visit</span></CodeLine>
<Link id="l00051" /><CodeLine lineNumber="51"><span class="doxyHighlightComment">// http://wiki.dwarfstd.org/index.php?title=Path&#95;Discriminators</span></CodeLine>
<Link id="l00052" /><CodeLine lineNumber="52"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00053" /><CodeLine lineNumber="53"><span class="doxyHighlightComment">//===----------------------------------------------------------------------===//</span></CodeLine>
<Link id="l00054" /><CodeLine lineNumber="54"></CodeLine>
<Link id="l00055" /><CodeLine lineNumber="55"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/adddiscriminators-h">llvm/Transforms/Utils/AddDiscriminators.h</a>&quot;</span></CodeLine>
<Link id="l00056" /><CodeLine lineNumber="56"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/densemap-h">llvm/ADT/DenseMap.h</a>&quot;</span></CodeLine>
<Link id="l00057" /><CodeLine lineNumber="57"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/denseset-h">llvm/ADT/DenseSet.h</a>&quot;</span></CodeLine>
<Link id="l00058" /><CodeLine lineNumber="58"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/stringref-h">llvm/ADT/StringRef.h</a>&quot;</span></CodeLine>
<Link id="l00059" /><CodeLine lineNumber="59"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/basicblock-h">llvm/IR/BasicBlock.h</a>&quot;</span></CodeLine>
<Link id="l00060" /><CodeLine lineNumber="60"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/debuginfometadata-h">llvm/IR/DebugInfoMetadata.h</a>&quot;</span></CodeLine>
<Link id="l00061" /><CodeLine lineNumber="61"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/function-h">llvm/IR/Function.h</a>&quot;</span></CodeLine>
<Link id="l00062" /><CodeLine lineNumber="62"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/instruction-h">llvm/IR/Instruction.h</a>&quot;</span></CodeLine>
<Link id="l00063" /><CodeLine lineNumber="63"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/instructions-h">llvm/IR/Instructions.h</a>&quot;</span></CodeLine>
<Link id="l00064" /><CodeLine lineNumber="64"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/intrinsicinst-h">llvm/IR/IntrinsicInst.h</a>&quot;</span></CodeLine>
<Link id="l00065" /><CodeLine lineNumber="65"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/passmanager-h">llvm/IR/PassManager.h</a>&quot;</span></CodeLine>
<Link id="l00066" /><CodeLine lineNumber="66"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/casting-h">llvm/Support/Casting.h</a>&quot;</span></CodeLine>
<Link id="l00067" /><CodeLine lineNumber="67"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h">llvm/Support/CommandLine.h</a>&quot;</span></CodeLine>
<Link id="l00068" /><CodeLine lineNumber="68"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h">llvm/Support/Debug.h</a>&quot;</span></CodeLine>
<Link id="l00069" /><CodeLine lineNumber="69"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/raw-ostream-h">llvm/Support/raw&#95;ostream.h</a>&quot;</span></CodeLine>
<Link id="l00070" /><CodeLine lineNumber="70"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/sampleprofileloaderbaseutil-h">llvm/Transforms/Utils/SampleProfileLoaderBaseUtil.h</a>&quot;</span></CodeLine>
<Link id="l00071" /><CodeLine lineNumber="71"><span class="doxyHighlightPreprocessor">#include &lt;utility&gt;</span></CodeLine>
<Link id="l00072" /><CodeLine lineNumber="72"></CodeLine>
<Link id="l00073" /><CodeLine lineNumber="73"><span class="doxyHighlightKeyword">using namespace </span><span class="doxyHighlight"><a href="/docs/api/namespaces/llvm">llvm</a>;</span></CodeLine>
<Link id="l00074" /><CodeLine lineNumber="74"><span class="doxyHighlightKeyword">using namespace </span><span class="doxyHighlight"><a href="/docs/api/namespaces/llvm/sampleprofutil">sampleprofutil</a>;</span></CodeLine>
<Link id="l00075" /><CodeLine lineNumber="75"></CodeLine>
<Link id="l00076" /><CodeLine lineNumber="76" lineLink="#ad78e062f62e0d6e453941fb4ca843e4d"><span class="doxyHighlightPreprocessor">#define DEBUG&#95;TYPE &quot;add-discriminators&quot;</span></CodeLine>
<Link id="l00077" /><CodeLine lineNumber="77"></CodeLine>
<Link id="l00078" /><CodeLine lineNumber="78"><span class="doxyHighlightComment">// Command line option to disable discriminator generation even in the</span></CodeLine>
<Link id="l00079" /><CodeLine lineNumber="79"><span class="doxyHighlightComment">// presence of debug information. This is only needed when debugging</span></CodeLine>
<Link id="l00080" /><CodeLine lineNumber="80"><span class="doxyHighlightComment">// debug info generation issues.</span></CodeLine>
<Link id="l00081" /><CodeLine lineNumber="81" lineLink="#a5337a668286392f40c0935dc25471710"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a5337a668286392f40c0935dc25471710">NoDiscriminators</a>(</span></CodeLine>
<Link id="l00082" /><CodeLine lineNumber="82"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;no-discriminators&quot;</span><span class="doxyHighlight">, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00083" /><CodeLine lineNumber="83"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Disable generation of discriminator information.&quot;</span><span class="doxyHighlight">));</span></CodeLine>
<Link id="l00084" /><CodeLine lineNumber="84"></CodeLine>
<Link id="l00085" /><CodeLine lineNumber="85" lineLink="#a80b3b9cef1539f6a37cd6a19af09933e"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#a80b3b9cef1539f6a37cd6a19af09933e">shouldHaveDiscriminator</a>(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &#123;</span></CodeLine>
<Link id="l00086" /><CodeLine lineNumber="86"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> !<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;IntrinsicInst&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) || <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;MemIntrinsic&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</span></CodeLine>
<Link id="l00087" /><CodeLine lineNumber="87"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00088" /><CodeLine lineNumber="88"></CodeLine>
<Link id="l00089" /><CodeLine lineNumber="89"><span class="doxyHighlightComment">/// Assign DWARF discriminators.</span></CodeLine>
<Link id="l00090" /><CodeLine lineNumber="90"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00091" /><CodeLine lineNumber="91"><span class="doxyHighlightComment">/// To assign discriminators, we examine the boundaries of every</span></CodeLine>
<Link id="l00092" /><CodeLine lineNumber="92"><span class="doxyHighlightComment">/// basic block and its successors. Suppose there is a basic block B1</span></CodeLine>
<Link id="l00093" /><CodeLine lineNumber="93"><span class="doxyHighlightComment">/// with successor B2. The last instruction I1 in B1 and the first</span></CodeLine>
<Link id="l00094" /><CodeLine lineNumber="94"><span class="doxyHighlightComment">/// instruction I2 in B2 are located at the same file and line number.</span></CodeLine>
<Link id="l00095" /><CodeLine lineNumber="95"><span class="doxyHighlightComment">/// This situation is illustrated in the following code snippet:</span></CodeLine>
<Link id="l00096" /><CodeLine lineNumber="96"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00097" /><CodeLine lineNumber="97"><span class="doxyHighlightComment">///       if (i &lt; 10) x = i;</span></CodeLine>
<Link id="l00098" /><CodeLine lineNumber="98"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00099" /><CodeLine lineNumber="99"><span class="doxyHighlightComment">///     entry:</span></CodeLine>
<Link id="l00100" /><CodeLine lineNumber="100"><span class="doxyHighlightComment">///       br i1 %cmp, label %if.then, label %if.end, !dbg !10</span></CodeLine>
<Link id="l00101" /><CodeLine lineNumber="101"><span class="doxyHighlightComment">///     if.then:</span></CodeLine>
<Link id="l00102" /><CodeLine lineNumber="102"><span class="doxyHighlightComment">///       %1 = load i32&#42; %i.addr, align 4, !dbg !10</span></CodeLine>
<Link id="l00103" /><CodeLine lineNumber="103"><span class="doxyHighlightComment">///       store i32 %1, i32&#42; %x, align 4, !dbg !10</span></CodeLine>
<Link id="l00104" /><CodeLine lineNumber="104"><span class="doxyHighlightComment">///       br label %if.end, !dbg !10</span></CodeLine>
<Link id="l00105" /><CodeLine lineNumber="105"><span class="doxyHighlightComment">///     if.end:</span></CodeLine>
<Link id="l00106" /><CodeLine lineNumber="106"><span class="doxyHighlightComment">///       ret void, !dbg !12</span></CodeLine>
<Link id="l00107" /><CodeLine lineNumber="107"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00108" /><CodeLine lineNumber="108"><span class="doxyHighlightComment">/// Notice how the branch instruction in block &#39;entry&#39; and all the</span></CodeLine>
<Link id="l00109" /><CodeLine lineNumber="109"><span class="doxyHighlightComment">/// instructions in block &#39;if.then&#39; have the exact same debug location</span></CodeLine>
<Link id="l00110" /><CodeLine lineNumber="110"><span class="doxyHighlightComment">/// information (!dbg !10).</span></CodeLine>
<Link id="l00111" /><CodeLine lineNumber="111"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00112" /><CodeLine lineNumber="112"><span class="doxyHighlightComment">/// To distinguish instructions in block &#39;entry&#39; from instructions in</span></CodeLine>
<Link id="l00113" /><CodeLine lineNumber="113"><span class="doxyHighlightComment">/// block &#39;if.then&#39;, we generate a new lexical block for all the</span></CodeLine>
<Link id="l00114" /><CodeLine lineNumber="114"><span class="doxyHighlightComment">/// instruction in block &#39;if.then&#39; that share the same file and line</span></CodeLine>
<Link id="l00115" /><CodeLine lineNumber="115"><span class="doxyHighlightComment">/// location with the last instruction of block &#39;entry&#39;.</span></CodeLine>
<Link id="l00116" /><CodeLine lineNumber="116"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00117" /><CodeLine lineNumber="117"><span class="doxyHighlightComment">/// This new lexical block will have the same location information as</span></CodeLine>
<Link id="l00118" /><CodeLine lineNumber="118"><span class="doxyHighlightComment">/// the previous one, but with a new DWARF discriminator value.</span></CodeLine>
<Link id="l00119" /><CodeLine lineNumber="119"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00120" /><CodeLine lineNumber="120"><span class="doxyHighlightComment">/// One of the main uses of this discriminator value is in runtime</span></CodeLine>
<Link id="l00121" /><CodeLine lineNumber="121"><span class="doxyHighlightComment">/// sample profilers. It allows the profiler to distinguish instructions</span></CodeLine>
<Link id="l00122" /><CodeLine lineNumber="122"><span class="doxyHighlightComment">/// at location !dbg !10 that execute on different basic blocks. This is</span></CodeLine>
<Link id="l00123" /><CodeLine lineNumber="123"><span class="doxyHighlightComment">/// important because while the predicate &#39;if (x &lt; 10)&#39; may have been</span></CodeLine>
<Link id="l00124" /><CodeLine lineNumber="124"><span class="doxyHighlightComment">/// executed millions of times, the assignment &#39;x = i&#39; may have only</span></CodeLine>
<Link id="l00125" /><CodeLine lineNumber="125"><span class="doxyHighlightComment">/// executed a handful of times (meaning that the entry-&gt;if.then edge is</span></CodeLine>
<Link id="l00126" /><CodeLine lineNumber="126"><span class="doxyHighlightComment">/// seldom taken).</span></CodeLine>
<Link id="l00127" /><CodeLine lineNumber="127"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00128" /><CodeLine lineNumber="128"><span class="doxyHighlightComment">/// If we did not have discriminator information, the profiler would</span></CodeLine>
<Link id="l00129" /><CodeLine lineNumber="129"><span class="doxyHighlightComment">/// assign the same weight to both blocks &#39;entry&#39; and &#39;if.then&#39;, which</span></CodeLine>
<Link id="l00130" /><CodeLine lineNumber="130"><span class="doxyHighlightComment">/// in turn will make it conclude that the entry-&gt;if.then edge is very</span></CodeLine>
<Link id="l00131" /><CodeLine lineNumber="131"><span class="doxyHighlightComment">/// hot.</span></CodeLine>
<Link id="l00132" /><CodeLine lineNumber="132"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00133" /><CodeLine lineNumber="133"><span class="doxyHighlightComment">/// To decide where to create new discriminator values, this function</span></CodeLine>
<Link id="l00134" /><CodeLine lineNumber="134"><span class="doxyHighlightComment">/// traverses the CFG and examines instruction at basic block boundaries.</span></CodeLine>
<Link id="l00135" /><CodeLine lineNumber="135"><span class="doxyHighlightComment">/// If the last instruction I1 of a block B1 is at the same file and line</span></CodeLine>
<Link id="l00136" /><CodeLine lineNumber="136"><span class="doxyHighlightComment">/// location as instruction I2 of successor B2, then it creates a new</span></CodeLine>
<Link id="l00137" /><CodeLine lineNumber="137"><span class="doxyHighlightComment">/// lexical block for I2 and all the instruction in B2 that share the same</span></CodeLine>
<Link id="l00138" /><CodeLine lineNumber="138"><span class="doxyHighlightComment">/// file and line location as I2. This new lexical block will have a</span></CodeLine>
<Link id="l00139" /><CodeLine lineNumber="139"><span class="doxyHighlightComment">/// different discriminator number than I1.</span></CodeLine>
<Link id="l00140" /><CodeLine lineNumber="140" lineLink="#a6201294406f0d7ffae87b86d867045f8"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#a6201294406f0d7ffae87b86d867045f8">addDiscriminators</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l00141" /><CodeLine lineNumber="141"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the function has debug information, but the user has disabled</span></CodeLine>
<Link id="l00142" /><CodeLine lineNumber="142"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// discriminators, do nothing.</span></CodeLine>
<Link id="l00143" /><CodeLine lineNumber="143"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Simlarly, if the function has no debug info, do nothing.</span></CodeLine>
<Link id="l00144" /><CodeLine lineNumber="144"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a5337a668286392f40c0935dc25471710">NoDiscriminators</a> || !<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getSubprogram())</span></CodeLine>
<Link id="l00145" /><CodeLine lineNumber="145"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00146" /><CodeLine lineNumber="146"></CodeLine>
<Link id="l00147" /><CodeLine lineNumber="147"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create FSDiscriminatorVariable if flow sensitive discriminators are used.</span></CodeLine>
<Link id="l00148" /><CodeLine lineNumber="148"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a61cf315897c96016607a2b8d5916a64d">EnableFSDiscriminator</a>)</span></CodeLine>
<Link id="l00149" /><CodeLine lineNumber="149"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/sampleprofutil/#a9495513e04a8f797cc8723887bdbd13c">createFSDiscriminatorVariable</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getParent());</span></CodeLine>
<Link id="l00150" /><CodeLine lineNumber="150"></CodeLine>
<Link id="l00151" /><CodeLine lineNumber="151"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a> = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00152" /><CodeLine lineNumber="152"></CodeLine>
<Link id="l00153" /><CodeLine lineNumber="153"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">using </span><span class="doxyHighlight">Location = std::pair&lt;StringRef, unsigned&gt;;</span></CodeLine>
<Link id="l00154" /><CodeLine lineNumber="154"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">using </span><span class="doxyHighlight">BBSet = <a href="/docs/api/classes/llvm/denseset">DenseSet&lt;const BasicBlock &#42;&gt;</a>;</span></CodeLine>
<Link id="l00155" /><CodeLine lineNumber="155"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">using </span><span class="doxyHighlight">LocationBBMap = <a href="/docs/api/classes/llvm/densemap">DenseMap&lt;Location, BBSet&gt;</a>;</span></CodeLine>
<Link id="l00156" /><CodeLine lineNumber="156"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">using </span><span class="doxyHighlight">LocationDiscriminatorMap = <a href="/docs/api/classes/llvm/densemap">DenseMap&lt;Location, unsigned&gt;</a>;</span></CodeLine>
<Link id="l00157" /><CodeLine lineNumber="157"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">using </span><span class="doxyHighlight">LocationSet = <a href="/docs/api/classes/llvm/denseset">DenseSet&lt;Location&gt;</a>;</span></CodeLine>
<Link id="l00158" /><CodeLine lineNumber="158"></CodeLine>
<Link id="l00159" /><CodeLine lineNumber="159"><span class="doxyHighlight">  LocationBBMap LBM;</span></CodeLine>
<Link id="l00160" /><CodeLine lineNumber="160"><span class="doxyHighlight">  LocationDiscriminatorMap LDM;</span></CodeLine>
<Link id="l00161" /><CodeLine lineNumber="161"></CodeLine>
<Link id="l00162" /><CodeLine lineNumber="162"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Traverse all instructions in the function. If the source line location</span></CodeLine>
<Link id="l00163" /><CodeLine lineNumber="163"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// of the instruction appears in other basic block, assign a new</span></CodeLine>
<Link id="l00164" /><CodeLine lineNumber="164"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// discriminator for this instruction.</span></CodeLine>
<Link id="l00165" /><CodeLine lineNumber="165"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a> : <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l00166" /><CodeLine lineNumber="166"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>) &#123;</span></CodeLine>
<Link id="l00167" /><CodeLine lineNumber="167"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Not all intrinsic calls should have a discriminator.</span></CodeLine>
<Link id="l00168" /><CodeLine lineNumber="168"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// We want to avoid a non-deterministic assignment of discriminators at</span></CodeLine>
<Link id="l00169" /><CodeLine lineNumber="169"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// different debug levels. We still allow discriminators on memory</span></CodeLine>
<Link id="l00170" /><CodeLine lineNumber="170"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// intrinsic calls because those can be early expanded by SROA into</span></CodeLine>
<Link id="l00171" /><CodeLine lineNumber="171"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// pairs of loads and stores, and the expanded load/store instructions</span></CodeLine>
<Link id="l00172" /><CodeLine lineNumber="172"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// should have a valid discriminator.</span></CodeLine>
<Link id="l00173" /><CodeLine lineNumber="173"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="#a80b3b9cef1539f6a37cd6a19af09933e">shouldHaveDiscriminator</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</span></CodeLine>
<Link id="l00174" /><CodeLine lineNumber="174"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00175" /><CodeLine lineNumber="175"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/dilocation">DILocation</a> &#42;DIL = <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getDebugLoc();</span></CodeLine>
<Link id="l00176" /><CodeLine lineNumber="176"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!DIL)</span></CodeLine>
<Link id="l00177" /><CodeLine lineNumber="177"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00178" /><CodeLine lineNumber="178"><span class="doxyHighlight">      Location L = std::make&#95;pair(DIL-&gt;getFilename(), DIL-&gt;getLine());</span></CodeLine>
<Link id="l00179" /><CodeLine lineNumber="179"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;BBMap = LBM&#91;L&#93;;</span></CodeLine>
<Link id="l00180" /><CodeLine lineNumber="180"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> R = BBMap.insert(&amp;<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>);</span></CodeLine>
<Link id="l00181" /><CodeLine lineNumber="181"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BBMap.size() == 1)</span></CodeLine>
<Link id="l00182" /><CodeLine lineNumber="182"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00183" /><CodeLine lineNumber="183"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If we could insert more than one block with the same line+file, a</span></CodeLine>
<Link id="l00184" /><CodeLine lineNumber="184"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// discriminator is needed to distinguish both instructions.</span></CodeLine>
<Link id="l00185" /><CodeLine lineNumber="185"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Only the lowest 7 bits are used to represent a discriminator to fit</span></CodeLine>
<Link id="l00186" /><CodeLine lineNumber="186"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// it in 1 byte ULEB128 representation.</span></CodeLine>
<Link id="l00187" /><CodeLine lineNumber="187"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> Discriminator = R.second ? ++LDM&#91;L&#93; : LDM&#91;L&#93;;</span></CodeLine>
<Link id="l00188" /><CodeLine lineNumber="188"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> NewDIL = DIL-&gt;<a href="/docs/api/classes/llvm/dilocation/#a839785a42c232b11d0e1b6b6c0ddba69">cloneWithBaseDiscriminator</a>(Discriminator);</span></CodeLine>
<Link id="l00189" /><CodeLine lineNumber="189"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!NewDIL) &#123;</span></CodeLine>
<Link id="l00190" /><CodeLine lineNumber="190"><span class="doxyHighlight">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Could not encode discriminator: &quot;</span></CodeLine>
<Link id="l00191" /><CodeLine lineNumber="191"><span class="doxyHighlight">                          &lt;&lt; DIL-&gt;getFilename() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;:&quot;</span><span class="doxyHighlight"> &lt;&lt; DIL-&gt;getLine() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;:&quot;</span></CodeLine>
<Link id="l00192" /><CodeLine lineNumber="192"><span class="doxyHighlight">                          &lt;&lt; DIL-&gt;getColumn() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;:&quot;</span><span class="doxyHighlight"> &lt;&lt; Discriminator &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; &quot;</span></CodeLine>
<Link id="l00193" /><CodeLine lineNumber="193"><span class="doxyHighlight">                          &lt;&lt; <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00194" /><CodeLine lineNumber="194"><span class="doxyHighlight">      &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00195" /><CodeLine lineNumber="195"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.setDebugLoc(&#42;NewDIL);</span></CodeLine>
<Link id="l00196" /><CodeLine lineNumber="196"><span class="doxyHighlight">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; DIL-&gt;getFilename() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;:&quot;</span><span class="doxyHighlight"> &lt;&lt; DIL-&gt;getLine() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;:&quot;</span></CodeLine>
<Link id="l00197" /><CodeLine lineNumber="197"><span class="doxyHighlight">                   &lt;&lt; DIL-&gt;getColumn() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;:&quot;</span><span class="doxyHighlight"> &lt;&lt; Discriminator &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a></span></CodeLine>
<Link id="l00198" /><CodeLine lineNumber="198"><span class="doxyHighlight">                   &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00199" /><CodeLine lineNumber="199"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00200" /><CodeLine lineNumber="200"><span class="doxyHighlight">      <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a> = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00201" /><CodeLine lineNumber="201"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00202" /><CodeLine lineNumber="202"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00203" /><CodeLine lineNumber="203"></CodeLine>
<Link id="l00204" /><CodeLine lineNumber="204"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Traverse all instructions and assign new discriminators to call</span></CodeLine>
<Link id="l00205" /><CodeLine lineNumber="205"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// instructions with the same lineno that are in the same basic block.</span></CodeLine>
<Link id="l00206" /><CodeLine lineNumber="206"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Sample base profile needs to distinguish different function calls within</span></CodeLine>
<Link id="l00207" /><CodeLine lineNumber="207"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// a same source line for correct profile annotation.</span></CodeLine>
<Link id="l00208" /><CodeLine lineNumber="208"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a> : <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l00209" /><CodeLine lineNumber="209"><span class="doxyHighlight">    LocationSet CallLocations;</span></CodeLine>
<Link id="l00210" /><CodeLine lineNumber="210"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>) &#123;</span></CodeLine>
<Link id="l00211" /><CodeLine lineNumber="211"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// We bypass intrinsic calls for the following two reasons:</span></CodeLine>
<Link id="l00212" /><CodeLine lineNumber="212"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//  1) We want to avoid a non-deterministic assignment of</span></CodeLine>
<Link id="l00213" /><CodeLine lineNumber="213"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//     discriminators.</span></CodeLine>
<Link id="l00214" /><CodeLine lineNumber="214"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//  2) We want to minimize the number of base discriminators used.</span></CodeLine>
<Link id="l00215" /><CodeLine lineNumber="215"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;InvokeInst&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &amp;&amp; (!<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;CallInst&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) || <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;IntrinsicInst&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)))  </span></CodeLine>
<Link id="l00216" /><CodeLine lineNumber="216"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00217" /><CodeLine lineNumber="217"></CodeLine>
<Link id="l00218" /><CodeLine lineNumber="218"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/dilocation">DILocation</a> &#42;CurrentDIL = <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getDebugLoc();</span></CodeLine>
<Link id="l00219" /><CodeLine lineNumber="219"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CurrentDIL)</span></CodeLine>
<Link id="l00220" /><CodeLine lineNumber="220"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00221" /><CodeLine lineNumber="221"><span class="doxyHighlight">      Location L =</span></CodeLine>
<Link id="l00222" /><CodeLine lineNumber="222"><span class="doxyHighlight">          std::make&#95;pair(CurrentDIL-&gt;getFilename(), CurrentDIL-&gt;getLine());</span></CodeLine>
<Link id="l00223" /><CodeLine lineNumber="223"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CallLocations.insert(L).second) &#123;</span></CodeLine>
<Link id="l00224" /><CodeLine lineNumber="224"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> Discriminator = ++LDM&#91;L&#93;;</span></CodeLine>
<Link id="l00225" /><CodeLine lineNumber="225"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> NewDIL = CurrentDIL-&gt;<a href="/docs/api/classes/llvm/dilocation/#a839785a42c232b11d0e1b6b6c0ddba69">cloneWithBaseDiscriminator</a>(Discriminator);</span></CodeLine>
<Link id="l00226" /><CodeLine lineNumber="226"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!NewDIL) &#123;</span></CodeLine>
<Link id="l00227" /><CodeLine lineNumber="227"><span class="doxyHighlight">          <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>()</span></CodeLine>
<Link id="l00228" /><CodeLine lineNumber="228"><span class="doxyHighlight">                     &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Could not encode discriminator: &quot;</span></CodeLine>
<Link id="l00229" /><CodeLine lineNumber="229"><span class="doxyHighlight">                     &lt;&lt; CurrentDIL-&gt;getFilename() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;:&quot;</span></CodeLine>
<Link id="l00230" /><CodeLine lineNumber="230"><span class="doxyHighlight">                     &lt;&lt; CurrentDIL-&gt;getLine() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;:&quot;</span><span class="doxyHighlight"> &lt;&lt; CurrentDIL-&gt;getColumn()</span></CodeLine>
<Link id="l00231" /><CodeLine lineNumber="231"><span class="doxyHighlight">                     &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;:&quot;</span><span class="doxyHighlight"> &lt;&lt; Discriminator &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00232" /><CodeLine lineNumber="232"><span class="doxyHighlight">        &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00233" /><CodeLine lineNumber="233"><span class="doxyHighlight">          <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.setDebugLoc(&#42;NewDIL);</span></CodeLine>
<Link id="l00234" /><CodeLine lineNumber="234"><span class="doxyHighlight">          <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a> = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00235" /><CodeLine lineNumber="235"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l00236" /><CodeLine lineNumber="236"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00237" /><CodeLine lineNumber="237"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00238" /><CodeLine lineNumber="238"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00239" /><CodeLine lineNumber="239"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a>;</span></CodeLine>
<Link id="l00240" /><CodeLine lineNumber="240"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00241" /><CodeLine lineNumber="241"></CodeLine>
<Link id="l00242" /><CodeLine lineNumber="242" lineLink="/docs/api/classes/llvm/adddiscriminatorspass/#a7c89dac3d04b8cda0fe7586df5429d28"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/preservedanalyses">PreservedAnalyses</a> <a href="/docs/api/classes/llvm/adddiscriminatorspass/#a7c89dac3d04b8cda0fe7586df5429d28">AddDiscriminatorsPass::run</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>,</span></CodeLine>
<Link id="l00243" /><CodeLine lineNumber="243"><span class="doxyHighlight">                                             <a href="/docs/api/namespaces/llvm/#adce09a5a0de0e3177eb00e932734af2f">FunctionAnalysisManager</a> &amp;AM) &#123;</span></CodeLine>
<Link id="l00244" /><CodeLine lineNumber="244"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="#a6201294406f0d7ffae87b86d867045f8">addDiscriminators</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>))</span></CodeLine>
<Link id="l00245" /><CodeLine lineNumber="245"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/preservedanalyses/#a1258a1ff55557c27684010ebd7283712">PreservedAnalyses::all</a>();</span></CodeLine>
<Link id="l00246" /><CodeLine lineNumber="246"></CodeLine>
<Link id="l00247" /><CodeLine lineNumber="247"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// FIXME: should be all()</span></CodeLine>
<Link id="l00248" /><CodeLine lineNumber="248"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/preservedanalyses/#a03797a73044a81cbc6a3409d6c72ee8f">PreservedAnalyses::none</a>();</span></CodeLine>
<Link id="l00249" /><CodeLine lineNumber="249"><span class="doxyHighlight">&#125;</span></CodeLine>

</ProgramListing>


</DoxygenPage>
