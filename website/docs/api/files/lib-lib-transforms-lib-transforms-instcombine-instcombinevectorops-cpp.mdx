---

# DO NOT EDIT!
# Automatically generated via docusaurus-plugin-doxygen by Doxygen.

slug: /api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp
custom_edit_url: null
keywords:
  - doxygen
  - reference
  - file

---

import Link from '@docusaurus/Link'

import CodeLine from '@xpack/docusaurus-plugin-doxygen/components/CodeLine'
import DoxygenPage from '@xpack/docusaurus-plugin-doxygen/components/DoxygenPage'
import IncludesList from '@xpack/docusaurus-plugin-doxygen/components/IncludesList'
import IncludesListItem from '@xpack/docusaurus-plugin-doxygen/components/IncludesListItem'
import MemberDefinition from '@xpack/docusaurus-plugin-doxygen/components/MemberDefinition'
import MembersIndex from '@xpack/docusaurus-plugin-doxygen/components/MembersIndex'
import MembersIndexItem from '@xpack/docusaurus-plugin-doxygen/components/MembersIndexItem'
import ProgramListing from '@xpack/docusaurus-plugin-doxygen/components/ProgramListing'
import SectionDefinition from '@xpack/docusaurus-plugin-doxygen/components/SectionDefinition'

import pluginConfig from '@site/docusaurus-plugin-doxygen-config.json'

# The `InstCombineVectorOps.cpp` File Reference

<DoxygenPage pluginConfig={pluginConfig}>



## Included Headers

<IncludesList>
<IncludesListItem
  filePath="InstCombineInternal.h"
  permalink="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombineinternal-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/APInt.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/apint-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/ArrayRef.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/arrayref-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/DenseMap.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/densemap-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/STLExtras.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/stlextras-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SmallBitVector.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/smallbitvector-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SmallVector.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/smallvector-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/Statistic.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/InstructionSimplify.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/instructionsimplify-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/VectorUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/vectorutils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/BasicBlock.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/basicblock-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Constant.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/constant-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Constants.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/constants-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/DerivedTypes.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/derivedtypes-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/InstrTypes.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/instrtypes-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Instruction.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/instruction-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Instructions.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/instructions-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Operator.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/operator-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/PatternMatch.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/patternmatch-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Type.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/type-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/User.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/user-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Value.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/value-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/Casting.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/casting-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/ErrorHandling.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/errorhandling-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/InstCombine/InstCombiner.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/instcombine/instcombiner-h"
  isLocal="true" />
<IncludesListItem
  filePath="cassert"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="cstdint"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="iterator"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="utility"
  permalink=""
  isLocal="false" />
</IncludesList>

## Classes Index

<MembersIndex>

<MembersIndexItem
  type="struct"
  name={<><a href="/docs/api/structs/binopelts">BinopElts</a></>}>
These are the ingredients in an alternate form binary operator as described below. <a href="/docs/api/structs/binopelts/#details">More...</a>
</MembersIndexItem>

</MembersIndex>

## Typedefs Index

<MembersIndex>

<MembersIndexItem
  type="using"
  name={<><a href="#a5ef308f5547e4c1a6dfe646dd7ea7abc">ShuffleOps</a> = std::pair&lt; <a href="/docs/api/classes/llvm/value">Value</a> &#42;, <a href="/docs/api/classes/llvm/value">Value</a> &#42; &gt;</>}>
We are building a shuffle to create V, which is a sequence of insertelement, extractelement pairs. <a href="#a5ef308f5547e4c1a6dfe646dd7ea7abc">More...</a>
</MembersIndexItem>

</MembersIndex>

## Functions Index

<MembersIndex>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/value">Value</a> &#42;</>}
  name={<><a href="#a8efa56ca3bfdd8c715939f9e0b24ccda">buildNew</a> (Instruction &#42;I, ArrayRef&lt; Value &#42; &gt; NewOps, IRBuilderBase &amp;Builder)</>}>
Rebuild a new instruction just like &#39;I&#39; but with the new operands given. <a href="#a8efa56ca3bfdd8c715939f9e0b24ccda">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a95fd07ca61f35098e091aa2329f9c8a6">canEvaluateShuffled</a> (Value &#42;V, ArrayRef&lt; int &gt; Mask, unsigned Depth=5)</>}>
Return true if we can evaluate the specified expression tree if the vector elements were shuffled in a different order. <a href="#a95fd07ca61f35098e091aa2329f9c8a6">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;</>}
  name={<><a href="#a6e6cf92e2cfe0eb48abec55606e0481e">canonicalizeInsertSplat</a> (ShuffleVectorInst &amp;Shuf, InstCombiner::BuilderTy &amp;Builder)</>}>
If we have an insert of a scalar to a non-zero element of an undefined vector and then shuffle that value, that&#39;s the same as inserting to the zero element and shuffling. <a href="#a6e6cf92e2cfe0eb48abec55606e0481e">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a89f5f0f536cc9b0bae261737f13786f7">cheapToScalarize</a> (Value &#42;V, Value &#42;EI)</>}>
Return true if the value is cheaper to scalarize than it is to leave as a vector operation. <a href="#a89f5f0f536cc9b0bae261737f13786f7">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="#a5ef308f5547e4c1a6dfe646dd7ea7abc">ShuffleOps</a></>}
  name={<><a href="#a1e502a1ec39cc64d6b86e9e68b29be89">collectShuffleElements</a> (Value &#42;V, SmallVectorImpl&lt; int &gt; &amp;Mask, Value &#42;PermittedRHS, InstCombinerImpl &amp;IC, bool &amp;Rerun)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a0f22159dceed07fd0d5d47915a80dc72">collectSingleShuffleElements</a> (Value &#42;V, Value &#42;LHS, Value &#42;RHS, SmallVectorImpl&lt; int &gt; &amp;Mask)</>}>
If V is a shuffle of values that ONLY returns elements from either LHS or RHS, return the shuffle mask and true. <a href="#a0f22159dceed07fd0d5d47915a80dc72">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/value">Value</a> &#42;</>}
  name={<><a href="#a06358c30f3e98d9e57f4ae9162f33c72">evaluateInDifferentElementOrder</a> (Value &#42;V, ArrayRef&lt; int &gt; Mask, IRBuilderBase &amp;Builder)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/apint">APInt</a></>}
  name={<><a href="#a1e71f36e9936f126265e383fd67440f7">findDemandedEltsByAllUsers</a> (Value &#42;V)</>}>
Find union of elements of V demanded by all its users. <a href="#a1e71f36e9936f126265e383fd67440f7">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/apint">APInt</a></>}
  name={<><a href="#aa5aa7648807905cd7b63153812029fe2">findDemandedEltsBySingleUser</a> (Value &#42;V, Instruction &#42;UserInstr)</>}>
Find elements of V demanded by UserInstr. <a href="#aa5aa7648807905cd7b63153812029fe2">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;</>}
  name={<><a href="#ab737e320d75547e2b43f6044fc3f3bcc">foldCastShuffle</a> (ShuffleVectorInst &amp;Shuf, InstCombiner::BuilderTy &amp;Builder)</>}>
Canonicalize casts after shuffle. <a href="#ab737e320d75547e2b43f6044fc3f3bcc">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;</>}
  name={<><a href="#a01aa2c4724ae9bf421d1cfff3a1c7fa5">foldConstantInsEltIntoShuffle</a> (InsertElementInst &amp;InsElt)</>}>
insertelt (shufflevector X, CVec, Mask|insertelt X, C1, CIndex1), C, CIndex --&gt; shufflevector X, CVec&#39;, Mask&#39; <a href="#a01aa2c4724ae9bf421d1cfff3a1c7fa5">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;</>}
  name={<><a href="#a42c33c78c903c369b359db824b70cb1b">foldIdentityExtractShuffle</a> (ShuffleVectorInst &amp;Shuf)</>}>
Try to fold an extract subvector operation. <a href="#a42c33c78c903c369b359db824b70cb1b">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;</>}
  name={<><a href="#a332e7f93c5c4782c1a628a1b11ab5032">foldIdentityPaddedShuffles</a> (ShuffleVectorInst &amp;Shuf)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;</>}
  name={<><a href="#ae13bc9134960231b8354f62cfa902782">foldInsEltIntoIdentityShuffle</a> (InsertElementInst &amp;InsElt)</>}>
Try to fold an extract+insert element into an existing identity shuffle by changing the shuffle&#39;s mask to include the index of this insert element. <a href="#ae13bc9134960231b8354f62cfa902782">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;</>}
  name={<><a href="#a542a88a5b133e2ac8bd9ceb3f8c77dc9">foldInsEltIntoSplat</a> (InsertElementInst &amp;InsElt)</>}>
Try to fold an insert element into an existing splat shuffle by changing the shuffle&#39;s mask to include the index of this insert element. <a href="#a542a88a5b133e2ac8bd9ceb3f8c77dc9">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;</>}
  name={<><a href="#ad3259dc4dae742caac6c6e4f577d1760">foldInsSequenceIntoSplat</a> (InsertElementInst &amp;InsElt)</>}>
Turn a chain of inserts that splats a value into an insert + shuffle: insertelt(insertelt(insertelt(insertelt X, k, 0), k, 1), k, 2) ... -&gt; shufflevector(insertelt(X, k, 0), poison, zero) <a href="#ad3259dc4dae742caac6c6e4f577d1760">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;</>}
  name={<><a href="#a98282716af42c878d4638603c6efb350">foldSelectShuffleOfSelectShuffle</a> (ShuffleVectorInst &amp;Shuf)</>}>
A select shuffle of a select shuffle with a shared operand can be reduced to a single select shuffle. <a href="#a98282716af42c878d4638603c6efb350">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;</>}
  name={<><a href="#a2c05df65ce7ce7ec1d78348be2452e8d">foldSelectShuffleWith1Binop</a> (ShuffleVectorInst &amp;Shuf, const SimplifyQuery &amp;SQ)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;</>}
  name={<><a href="#aabcb01976dc50b78faed7491a6d43042">foldShuffleOfUnaryOps</a> (ShuffleVectorInst &amp;Shuf, InstCombiner::BuilderTy &amp;Builder)</>}>
Canonicalize FP negate/abs after shuffle. <a href="#aabcb01976dc50b78faed7491a6d43042">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;</>}
  name={<><a href="#a661440047dc1b2af077911d9cf92236a">foldShuffleWithInsert</a> (ShuffleVectorInst &amp;Shuf, InstCombinerImpl &amp;IC)</>}>
Try to replace a shuffle with an insertelement or try to replace a shuffle operand with the operand of an insertelement. <a href="#a661440047dc1b2af077911d9cf92236a">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;</>}
  name={<><a href="#a1f6c8af64ed18f5f5810f78abf9b4f33">foldTruncInsEltPair</a> (InsertElementInst &amp;InsElt, bool IsBigEndian, InstCombiner::BuilderTy &amp;Builder)</>}>
If we are inserting 2 halves of a value into adjacent elements of a vector, try to convert to a single insert with appropriate bitcasts. <a href="#a1f6c8af64ed18f5f5810f78abf9b4f33">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;</>}
  name={<><a href="#a747cca8cf8e4c4e41b81bb1cbf146a11">foldTruncShuffle</a> (ShuffleVectorInst &amp;Shuf, bool IsBigEndian)</>}>
Convert a narrowing shuffle of a bitcasted vector into a vector truncate. <a href="#a747cca8cf8e4c4e41b81bb1cbf146a11">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/structs/binopelts">BinopElts</a></>}
  name={<><a href="#af7e7c9415c23ae336af651877798a377">getAlternateBinop</a> (BinaryOperator &#42;BO, const DataLayout &amp;DL)</>}>
Binops may be transformed into binops with different opcodes and operands. <a href="#af7e7c9415c23ae336af651877798a377">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;</>}
  name={<><a href="#ae67d970cf80e86c5789e52f9d57d0c70">getPreferredVectorIndex</a> (ConstantInt &#42;IndexC)</>}>
Given a constant index for a extractelement or insertelement instruction, return it with the canonical type if it isn&#39;t already canonical. <a href="#ae67d970cf80e86c5789e52f9d57d0c70">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;</>}
  name={<><a href="#a9a97530480ce0284bb6dace4356e906c">hoistInsEltConst</a> (InsertElementInst &amp;InsElt2, InstCombiner::BuilderTy &amp;Builder)</>}>
If we have an insertelement instruction feeding into another insertelement and the 2nd is inserting a constant into the vector, canonicalize that constant insertion before the insertion of a variable: <a href="#a9a97530480ce0284bb6dace4356e906c">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#ace7029cdad3163ebfb8172d25e8a59e3">isShuffleEquivalentToSelect</a> (ShuffleVectorInst &amp;Shuf)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#ae8f4745a87bae0a614d6bda1cc55ab01">isShuffleExtractingFromLHS</a> (ShuffleVectorInst &amp;SVI, ArrayRef&lt; int &gt; Mask)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;</>}
  name={<><a href="#acb762c0dfb2a90596163f59e2dfbd029">narrowInsElt</a> (InsertElementInst &amp;InsElt, InstCombiner::BuilderTy &amp;Builder)</>}>
If both the base vector and the inserted element are extended from the same type, do the insert element in the narrow source type followed by extend. <a href="#acb762c0dfb2a90596163f59e2dfbd029">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;</>}
  name={<><a href="#a746205e6d7f5c0bb265ecc8a911d5b82">narrowVectorSelect</a> (ShuffleVectorInst &amp;Shuf, InstCombiner::BuilderTy &amp;Builder)</>}>
Match a shuffle-select-shuffle pattern where the shuffles are widening and narrowing (concatenating with poison and extracting back to the original length). <a href="#a746205e6d7f5c0bb265ecc8a911d5b82">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a801d960feba2403acf8dbd07ee3f34b6">replaceExtractElements</a> (InsertElementInst &#42;InsElt, ExtractElementInst &#42;ExtElt, InstCombinerImpl &amp;IC)</>}>
If we have insertion into a vector that is wider than the vector that we are extracting from, try to widen the source vector to allow a single shufflevector to replace one or more insert/extract pairs. <a href="#a801d960feba2403acf8dbd07ee3f34b6">More...</a>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#ab245dabd64a95cc7914750e551aebafb">STATISTIC</a> (NumAggregateReconstructionsSimplified, &quot;Number of aggregate reconstructions turned into reuse of the &quot; &quot;original aggregate&quot;)</>}>
</MembersIndexItem>

</MembersIndex>

## Defines Index

<MembersIndex>

<MembersIndexItem
  type="#define"
  name={<><a href="#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>&nbsp;&nbsp;&nbsp;&quot;instcombine&quot;</>}>
</MembersIndexItem>

</MembersIndex>


<SectionDefinition>

## Typedefs

### ShuffleOps {#a5ef308f5547e4c1a6dfe646dd7ea7abc}

<MemberDefinition
  prototype={<>using ShuffleOps =  std::pair&lt;Value &#42;, Value &#42;&gt;</>}>
We are building a shuffle to create V, which is a sequence of insertelement, extractelement pairs.

If PermittedRHS is set, then we must either use it or not rely on the second vector source. Return a std::pair containing the left and right vectors of the proposed shuffle (or 0), and set the Mask parameter as required.

Note: we intentionally don&#39;t try to fold earlier shuffles since they have often been chosen carefully to be efficiently implementable on the target.

Definition at line <a href="#l00779">779</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Functions

### buildNew() {#a8efa56ca3bfdd8c715939f9e0b24ccda}

<MemberDefinition
  prototype={<>static Value &#42; buildNew (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42; I, <a href="/docs/api/classes/llvm/arrayref">ArrayRef</a>&lt; <a href="/docs/api/classes/llvm/value">Value</a> &#42; &gt; NewOps, <a href="/docs/api/classes/llvm/irbuilderbase">IRBuilderBase</a> &amp; Builder)</>}
  labels = {["static"]}>
Rebuild a new instruction just like &#39;I&#39; but with the new operands given.

In the event of type mismatch, the type of the operands is correct.

Definition at line <a href="#l01915">1915</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### canEvaluateShuffled() {#a95fd07ca61f35098e091aa2329f9c8a6}

<MemberDefinition
  prototype={<>static bool canEvaluateShuffled (<a href="/docs/api/classes/llvm/value">Value</a> &#42; V, <a href="/docs/api/classes/llvm/arrayref">ArrayRef</a>&lt; int &gt; Mask, unsigned Depth=5)</>}
  labels = {["static"]}>
Return true if we can evaluate the specified expression tree if the vector elements were shuffled in a different order.

Definition at line <a href="#l01827">1827</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### canonicalizeInsertSplat() {#a6e6cf92e2cfe0eb48abec55606e0481e}

<MemberDefinition
  prototype={<>static Instruction &#42; canonicalizeInsertSplat (<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp; Shuf, InstCombiner::BuilderTy &amp; Builder)</>}
  labels = {["static"]}>
If we have an insert of a scalar to a non-zero element of an undefined vector and then shuffle that value, that&#39;s the same as inserting to the zero element and shuffling.

Splatting from the zero element is recognized as the canonical form of splat.

Definition at line <a href="#l02281">2281</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### cheapToScalarize() {#a89f5f0f536cc9b0bae261737f13786f7}

<MemberDefinition
  prototype={<>static bool cheapToScalarize (<a href="/docs/api/classes/llvm/value">Value</a> &#42; V, <a href="/docs/api/classes/llvm/value">Value</a> &#42; EI)</>}
  labels = {["static"]}>
Return true if the value is cheaper to scalarize than it is to leave as a vector operation.

If the extract index <code>EI</code> is a constant integer then some operations may be cheap to scalarize.

FIXME: It&#39;s possible to create more instructions than previously existed.

Definition at line <a href="#l00058">58</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### collectShuffleElements() {#a1e502a1ec39cc64d6b86e9e68b29be89}

<MemberDefinition
  prototype={<>static ShuffleOps collectShuffleElements (<a href="/docs/api/classes/llvm/value">Value</a> &#42; V, <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt; int &gt; &amp; Mask, <a href="/docs/api/classes/llvm/value">Value</a> &#42; PermittedRHS, <a href="/docs/api/classes/llvm/instcombinerimpl">InstCombinerImpl</a> &amp; IC, bool &amp; Rerun)</>}
  labels = {["static"]}>

Definition at line <a href="#l00781">781</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### collectSingleShuffleElements() {#a0f22159dceed07fd0d5d47915a80dc72}

<MemberDefinition
  prototype={<>static bool collectSingleShuffleElements (<a href="/docs/api/classes/llvm/value">Value</a> &#42; V, <a href="/docs/api/classes/llvm/value">Value</a> &#42; LHS, <a href="/docs/api/classes/llvm/value">Value</a> &#42; RHS, <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt; int &gt; &amp; Mask)</>}
  labels = {["static"]}>
If V is a shuffle of values that ONLY returns elements from either LHS or RHS, return the shuffle mask and true.

Otherwise, return false.

Definition at line <a href="#l00621">621</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### evaluateInDifferentElementOrder() {#a06358c30f3e98d9e57f4ae9162f33c72}

<MemberDefinition
  prototype={<>static Value &#42; evaluateInDifferentElementOrder (<a href="/docs/api/classes/llvm/value">Value</a> &#42; V, <a href="/docs/api/classes/llvm/arrayref">ArrayRef</a>&lt; int &gt; Mask, <a href="/docs/api/classes/llvm/irbuilderbase">IRBuilderBase</a> &amp; Builder)</>}
  labels = {["static"]}>

Definition at line <a href="#l01991">1991</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### findDemandedEltsByAllUsers() {#a1e71f36e9936f126265e383fd67440f7}

<MemberDefinition
  prototype={<>static APInt findDemandedEltsByAllUsers (<a href="/docs/api/classes/llvm/value">Value</a> &#42; V)</>}
  labels = {["static"]}>
Find union of elements of V demanded by all its users.

If it is known by querying findDemandedEltsBySingleUser that no user demands an element of V, then the corresponding bit remains unset in the returned value.

Definition at line <a href="#l00367">367</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### findDemandedEltsBySingleUser() {#aa5aa7648807905cd7b63153812029fe2}

<MemberDefinition
  prototype={<>static APInt findDemandedEltsBySingleUser (<a href="/docs/api/classes/llvm/value">Value</a> &#42; V, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42; UserInstr)</>}
  labels = {["static"]}>
Find elements of V demanded by UserInstr.

Definition at line <a href="#l00323">323</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### foldCastShuffle() {#ab737e320d75547e2b43f6044fc3f3bcc}

<MemberDefinition
  prototype={<>static Instruction &#42; foldCastShuffle (<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp; Shuf, InstCombiner::BuilderTy &amp; Builder)</>}
  labels = {["static"]}>
Canonicalize casts after shuffle.

Definition at line <a href="#l02574">2574</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### foldConstantInsEltIntoShuffle() {#a01aa2c4724ae9bf421d1cfff3a1c7fa5}

<MemberDefinition
  prototype={<>static Instruction &#42; foldConstantInsEltIntoShuffle (<a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &amp; InsElt)</>}
  labels = {["static"]}>
insertelt (shufflevector X, CVec, Mask|insertelt X, C1, CIndex1), C, CIndex --&gt; shufflevector X, CVec&#39;, Mask&#39;

Definition at line <a href="#l01472">1472</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### foldIdentityExtractShuffle() {#a42c33c78c903c369b359db824b70cb1b}

<MemberDefinition
  prototype={<>static Instruction &#42; foldIdentityExtractShuffle (<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp; Shuf)</>}
  labels = {["static"]}>
Try to fold an extract subvector operation.

Definition at line <a href="#l02623">2623</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### foldIdentityPaddedShuffles() {#a332e7f93c5c4782c1a628a1b11ab5032}

<MemberDefinition
  prototype={<>static Instruction &#42; foldIdentityPaddedShuffles (<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp; Shuf)</>}
  labels = {["static"]}>

Definition at line <a href="#l02761">2761</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### foldInsEltIntoIdentityShuffle() {#ae13bc9134960231b8354f62cfa902782}

<MemberDefinition
  prototype={<>static Instruction &#42; foldInsEltIntoIdentityShuffle (<a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &amp; InsElt)</>}
  labels = {["static"]}>
Try to fold an extract+insert element into an existing identity shuffle by changing the shuffle&#39;s mask to include the index of this insert element.

Definition at line <a href="#l01390">1390</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### foldInsEltIntoSplat() {#a542a88a5b133e2ac8bd9ceb3f8c77dc9}

<MemberDefinition
  prototype={<>static Instruction &#42; foldInsEltIntoSplat (<a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &amp; InsElt)</>}
  labels = {["static"]}>
Try to fold an insert element into an existing splat shuffle by changing the shuffle&#39;s mask to include the index of this insert element.

Definition at line <a href="#l01353">1353</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### foldInsSequenceIntoSplat() {#ad3259dc4dae742caac6c6e4f577d1760}

<MemberDefinition
  prototype={<>static Instruction &#42; foldInsSequenceIntoSplat (<a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &amp; InsElt)</>}
  labels = {["static"]}>
Turn a chain of inserts that splats a value into an insert + shuffle: insertelt(insertelt(insertelt(insertelt X, k, 0), k, 1), k, 2) ... -&gt; shufflevector(insertelt(X, k, 0), poison, zero)

Definition at line <a href="#l01279">1279</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### foldSelectShuffleOfSelectShuffle() {#a98282716af42c878d4638603c6efb350}

<MemberDefinition
  prototype={<>static Instruction &#42; foldSelectShuffleOfSelectShuffle (<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp; Shuf)</>}
  labels = {["static"]}>
A select shuffle of a select shuffle with a shared operand can be reduced to a single select shuffle.

This is an obvious improvement in IR, and the backend is expected to lower select shuffles efficiently.

Definition at line <a href="#l02165">2165</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### foldSelectShuffleWith1Binop() {#a2c05df65ce7ce7ec1d78348be2452e8d}

<MemberDefinition
  prototype={<>static Instruction &#42; foldSelectShuffleWith1Binop (<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp; Shuf, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/structs/llvm/simplifyquery">SimplifyQuery</a> &amp; SQ)</>}
  labels = {["static"]}>

Definition at line <a href="#l02212">2212</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### foldShuffleOfUnaryOps() {#aabcb01976dc50b78faed7491a6d43042}

<MemberDefinition
  prototype={<>static Instruction &#42; foldShuffleOfUnaryOps (<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp; Shuf, InstCombiner::BuilderTy &amp; Builder)</>}
  labels = {["static"]}>
Canonicalize FP negate/abs after shuffle.

Definition at line <a href="#l02527">2527</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### foldShuffleWithInsert() {#a661440047dc1b2af077911d9cf92236a}

<MemberDefinition
  prototype={<>static Instruction &#42; foldShuffleWithInsert (<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp; Shuf, <a href="/docs/api/classes/llvm/instcombinerimpl">InstCombinerImpl</a> &amp; IC)</>}
  labels = {["static"]}>
Try to replace a shuffle with an insertelement or try to replace a shuffle operand with the operand of an insertelement.

Definition at line <a href="#l02673">2673</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### foldTruncInsEltPair() {#a1f6c8af64ed18f5f5810f78abf9b4f33}

<MemberDefinition
  prototype={<>static Instruction &#42; foldTruncInsEltPair (<a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &amp; InsElt, bool IsBigEndian, InstCombiner::BuilderTy &amp; Builder)</>}
  labels = {["static"]}>
If we are inserting 2 halves of a value into adjacent elements of a vector, try to convert to a single insert with appropriate bitcasts.

Definition at line <a href="#l01609">1609</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### foldTruncShuffle() {#a747cca8cf8e4c4e41b81bb1cbf146a11}

<MemberDefinition
  prototype={<>static Instruction &#42; foldTruncShuffle (<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp; Shuf, bool IsBigEndian)</>}
  labels = {["static"]}>
Convert a narrowing shuffle of a bitcasted vector into a vector truncate.

Example (little endian): shuf (bitcast &lt;4 x i16&gt; X to &lt;8 x i8&gt;), &lt;0, 2, 4, 6&gt; --&gt; trunc X to &lt;4 x i8&gt;

Definition at line <a href="#l02452">2452</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### getAlternateBinop() {#af7e7c9415c23ae336af651877798a377}

<MemberDefinition
  prototype={<>static BinopElts getAlternateBinop (<a href="/docs/api/classes/llvm/binaryoperator">BinaryOperator</a> &#42; BO, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/datalayout">DataLayout</a> &amp; DL)</>}
  labels = {["static"]}>
Binops may be transformed into binops with different opcodes and operands.

Reverse the usual canonicalization to enable folds with the non-canonical form of the binop. If a transform is possible, return the elements of the new binop. If not, return invalid elements.

Definition at line <a href="#l02130">2130</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### getPreferredVectorIndex() {#ae67d970cf80e86c5789e52f9d57d0c70}

<MemberDefinition
  prototype={<>static ConstantInt &#42; getPreferredVectorIndex (<a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42; IndexC)</>}
  labels = {["static"]}>
Given a constant index for a extractelement or insertelement instruction, return it with the canonical type if it isn&#39;t already canonical.

We arbitrarily pick 64 bit as our canonical type. The actual bitwidth doesn&#39;t matter, we just want a consistent type to simplify CSE.

Definition at line <a href="#l00390">390</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### hoistInsEltConst() {#a9a97530480ce0284bb6dace4356e906c}

<MemberDefinition
  prototype={<>static Instruction &#42; hoistInsEltConst (<a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &amp; InsElt2, InstCombiner::BuilderTy &amp; Builder)</>}
  labels = {["static"]}>
If we have an insertelement instruction feeding into another insertelement and the 2nd is inserting a constant into the vector, canonicalize that constant insertion before the insertion of a variable:

insertelement (insertelement X, Y, IdxC1), ScalarC, IdxC2 --&gt; insertelement (insertelement X, ScalarC, IdxC2), Y, IdxC1

This has the potential of eliminating the 2nd insertelement instruction via constant folding of the scalar constant into a vector constant.

Definition at line <a href="#l01449">1449</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### isShuffleEquivalentToSelect() {#ace7029cdad3163ebfb8172d25e8a59e3}

<MemberDefinition
  prototype={<>static bool isShuffleEquivalentToSelect (<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp; Shuf)</>}
  labels = {["static"]}>

Definition at line <a href="#l01251">1251</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### isShuffleExtractingFromLHS() {#ae8f4745a87bae0a614d6bda1cc55ab01}

<MemberDefinition
  prototype={<>static bool isShuffleExtractingFromLHS (<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp; SVI, <a href="/docs/api/classes/llvm/arrayref">ArrayRef</a>&lt; int &gt; Mask)</>}
  labels = {["static"]}>

Definition at line <a href="#l02099">2099</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### narrowInsElt() {#acb762c0dfb2a90596163f59e2dfbd029}

<MemberDefinition
  prototype={<>static Instruction &#42; narrowInsElt (<a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &amp; InsElt, InstCombiner::BuilderTy &amp; Builder)</>}
  labels = {["static"]}>
If both the base vector and the inserted element are extended from the same type, do the insert element in the narrow source type followed by extend.

TODO: This can be extended to include other cast opcodes, but particularly if we create a wider insertelement, make sure codegen is not harmed.

Definition at line <a href="#l01576">1576</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### narrowVectorSelect() {#a746205e6d7f5c0bb265ecc8a911d5b82}

<MemberDefinition
  prototype={<>static Instruction &#42; narrowVectorSelect (<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp; Shuf, InstCombiner::BuilderTy &amp; Builder)</>}
  labels = {["static"]}>
Match a shuffle-select-shuffle pattern where the shuffles are widening and narrowing (concatenating with poison and extracting back to the original length).

This allows replacing the wide select with a narrow select.

Definition at line <a href="#l02493">2493</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### replaceExtractElements() {#a801d960feba2403acf8dbd07ee3f34b6}

<MemberDefinition
  prototype={<>static bool replaceExtractElements (<a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &#42; InsElt, <a href="/docs/api/classes/llvm/extractelementinst">ExtractElementInst</a> &#42; ExtElt, <a href="/docs/api/classes/llvm/instcombinerimpl">InstCombinerImpl</a> &amp; IC)</>}
  labels = {["static"]}>
If we have insertion into a vector that is wider than the vector that we are extracting from, try to widen the source vector to allow a single shufflevector to replace one or more insert/extract pairs.

Definition at line <a href="#l00694">694</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

### STATISTIC() {#ab245dabd64a95cc7914750e551aebafb}

<MemberDefinition
  prototype={<>STATISTIC (NumAggregateReconstructionsSimplified, &quot;Number of aggregate reconstructions turned into reuse of the &quot; &quot;original aggregate&quot;)</>}>

Definition at line <a href="#l00049">49</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Defines

### DEBUG&#95;TYPE {#ad78e062f62e0d6e453941fb4ca843e4d}

<MemberDefinition
  prototype={<>#define DEBUG&#95;TYPE&nbsp;&nbsp;&nbsp;&quot;instcombine&quot;</>}>

Definition at line <a href="#l00044">44</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombinevectorops-cpp">InstCombineVectorOps.cpp</a>.
</MemberDefinition>

</SectionDefinition>

## File Listing

The file content with the documentation metadata removed is:

<ProgramListing>

<Link id="l00001" /><CodeLine lineNumber="1"><span class="doxyHighlightComment">//===- InstCombineVectorOps.cpp -------------------------------------------===//</span></CodeLine>
<Link id="l00002" /><CodeLine lineNumber="2"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00003" /><CodeLine lineNumber="3"><span class="doxyHighlightComment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</span></CodeLine>
<Link id="l00004" /><CodeLine lineNumber="4"><span class="doxyHighlightComment">// See https://llvm.org/LICENSE.txt for license information.</span></CodeLine>
<Link id="l00005" /><CodeLine lineNumber="5"><span class="doxyHighlightComment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</span></CodeLine>
<Link id="l00006" /><CodeLine lineNumber="6"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00007" /><CodeLine lineNumber="7"><span class="doxyHighlightComment">//===----------------------------------------------------------------------===//</span></CodeLine>
<Link id="l00008" /><CodeLine lineNumber="8"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00009" /><CodeLine lineNumber="9"><span class="doxyHighlightComment">// This file implements instcombine for ExtractElement, InsertElement and</span></CodeLine>
<Link id="l00010" /><CodeLine lineNumber="10"><span class="doxyHighlightComment">// ShuffleVector.</span></CodeLine>
<Link id="l00011" /><CodeLine lineNumber="11"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00012" /><CodeLine lineNumber="12"><span class="doxyHighlightComment">//===----------------------------------------------------------------------===//</span></CodeLine>
<Link id="l00013" /><CodeLine lineNumber="13"></CodeLine>
<Link id="l00014" /><CodeLine lineNumber="14"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/lib/lib/transforms/lib/transforms/instcombine/instcombineinternal-h">InstCombineInternal.h</a>&quot;</span></CodeLine>
<Link id="l00015" /><CodeLine lineNumber="15"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/apint-h">llvm/ADT/APInt.h</a>&quot;</span></CodeLine>
<Link id="l00016" /><CodeLine lineNumber="16"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/arrayref-h">llvm/ADT/ArrayRef.h</a>&quot;</span></CodeLine>
<Link id="l00017" /><CodeLine lineNumber="17"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/densemap-h">llvm/ADT/DenseMap.h</a>&quot;</span></CodeLine>
<Link id="l00018" /><CodeLine lineNumber="18"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/stlextras-h">llvm/ADT/STLExtras.h</a>&quot;</span></CodeLine>
<Link id="l00019" /><CodeLine lineNumber="19"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/smallbitvector-h">llvm/ADT/SmallBitVector.h</a>&quot;</span></CodeLine>
<Link id="l00020" /><CodeLine lineNumber="20"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/smallvector-h">llvm/ADT/SmallVector.h</a>&quot;</span></CodeLine>
<Link id="l00021" /><CodeLine lineNumber="21"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h">llvm/ADT/Statistic.h</a>&quot;</span></CodeLine>
<Link id="l00022" /><CodeLine lineNumber="22"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/instructionsimplify-h">llvm/Analysis/InstructionSimplify.h</a>&quot;</span></CodeLine>
<Link id="l00023" /><CodeLine lineNumber="23"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/vectorutils-h">llvm/Analysis/VectorUtils.h</a>&quot;</span></CodeLine>
<Link id="l00024" /><CodeLine lineNumber="24"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/basicblock-h">llvm/IR/BasicBlock.h</a>&quot;</span></CodeLine>
<Link id="l00025" /><CodeLine lineNumber="25"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/constant-h">llvm/IR/Constant.h</a>&quot;</span></CodeLine>
<Link id="l00026" /><CodeLine lineNumber="26"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/constants-h">llvm/IR/Constants.h</a>&quot;</span></CodeLine>
<Link id="l00027" /><CodeLine lineNumber="27"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/derivedtypes-h">llvm/IR/DerivedTypes.h</a>&quot;</span></CodeLine>
<Link id="l00028" /><CodeLine lineNumber="28"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/instrtypes-h">llvm/IR/InstrTypes.h</a>&quot;</span></CodeLine>
<Link id="l00029" /><CodeLine lineNumber="29"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/instruction-h">llvm/IR/Instruction.h</a>&quot;</span></CodeLine>
<Link id="l00030" /><CodeLine lineNumber="30"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/instructions-h">llvm/IR/Instructions.h</a>&quot;</span></CodeLine>
<Link id="l00031" /><CodeLine lineNumber="31"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/operator-h">llvm/IR/Operator.h</a>&quot;</span></CodeLine>
<Link id="l00032" /><CodeLine lineNumber="32"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/patternmatch-h">llvm/IR/PatternMatch.h</a>&quot;</span></CodeLine>
<Link id="l00033" /><CodeLine lineNumber="33"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/type-h">llvm/IR/Type.h</a>&quot;</span></CodeLine>
<Link id="l00034" /><CodeLine lineNumber="34"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/user-h">llvm/IR/User.h</a>&quot;</span></CodeLine>
<Link id="l00035" /><CodeLine lineNumber="35"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/value-h">llvm/IR/Value.h</a>&quot;</span></CodeLine>
<Link id="l00036" /><CodeLine lineNumber="36"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/casting-h">llvm/Support/Casting.h</a>&quot;</span></CodeLine>
<Link id="l00037" /><CodeLine lineNumber="37"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/errorhandling-h">llvm/Support/ErrorHandling.h</a>&quot;</span></CodeLine>
<Link id="l00038" /><CodeLine lineNumber="38"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/instcombine/instcombiner-h">llvm/Transforms/InstCombine/InstCombiner.h</a>&quot;</span></CodeLine>
<Link id="l00039" /><CodeLine lineNumber="39"><span class="doxyHighlightPreprocessor">#include &lt;cassert&gt;</span></CodeLine>
<Link id="l00040" /><CodeLine lineNumber="40"><span class="doxyHighlightPreprocessor">#include &lt;cstdint&gt;</span></CodeLine>
<Link id="l00041" /><CodeLine lineNumber="41"><span class="doxyHighlightPreprocessor">#include &lt;iterator&gt;</span></CodeLine>
<Link id="l00042" /><CodeLine lineNumber="42"><span class="doxyHighlightPreprocessor">#include &lt;utility&gt;</span></CodeLine>
<Link id="l00043" /><CodeLine lineNumber="43"></CodeLine>
<Link id="l00044" /><CodeLine lineNumber="44" lineLink="#ad78e062f62e0d6e453941fb4ca843e4d"><span class="doxyHighlightPreprocessor">#define DEBUG&#95;TYPE &quot;instcombine&quot;</span></CodeLine>
<Link id="l00045" /><CodeLine lineNumber="45"></CodeLine>
<Link id="l00046" /><CodeLine lineNumber="46"><span class="doxyHighlightKeyword">using namespace </span><span class="doxyHighlight"><a href="/docs/api/namespaces/llvm">llvm</a>;</span></CodeLine>
<Link id="l00047" /><CodeLine lineNumber="47"><span class="doxyHighlightKeyword">using namespace </span><span class="doxyHighlight"><a href="/docs/api/namespaces/llvm/patternmatch">PatternMatch</a>;</span></CodeLine>
<Link id="l00048" /><CodeLine lineNumber="48"></CodeLine>
<Link id="l00049" /><CodeLine lineNumber="49" lineLink="#ab245dabd64a95cc7914750e551aebafb"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumAggregateReconstructionsSimplified,</span></CodeLine>
<Link id="l00050" /><CodeLine lineNumber="50"><span class="doxyHighlight">          </span><span class="doxyHighlightStringLiteral">&quot;Number of aggregate reconstructions turned into reuse of the &quot;</span></CodeLine>
<Link id="l00051" /><CodeLine lineNumber="51"><span class="doxyHighlight">          </span><span class="doxyHighlightStringLiteral">&quot;original aggregate&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00052" /><CodeLine lineNumber="52"></CodeLine>
<Link id="l00053" /><CodeLine lineNumber="53"><span class="doxyHighlightComment">/// Return true if the value is cheaper to scalarize than it is to leave as a</span></CodeLine>
<Link id="l00054" /><CodeLine lineNumber="54"><span class="doxyHighlightComment">/// vector operation. If the extract index \\p EI is a constant integer then</span></CodeLine>
<Link id="l00055" /><CodeLine lineNumber="55"><span class="doxyHighlightComment">/// some operations may be cheap to scalarize.</span></CodeLine>
<Link id="l00056" /><CodeLine lineNumber="56"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00057" /><CodeLine lineNumber="57"><span class="doxyHighlightComment">/// FIXME: It&#39;s possible to create more instructions than previously existed.</span></CodeLine>
<Link id="l00058" /><CodeLine lineNumber="58" lineLink="#a89f5f0f536cc9b0bae261737f13786f7"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#a89f5f0f536cc9b0bae261737f13786f7">cheapToScalarize</a>(<a href="/docs/api/classes/llvm/value">Value</a> &#42;V, <a href="/docs/api/classes/llvm/value">Value</a> &#42;EI) &#123;</span></CodeLine>
<Link id="l00059" /><CodeLine lineNumber="59"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;CEI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ConstantInt&gt;</a>(EI);</span></CodeLine>
<Link id="l00060" /><CodeLine lineNumber="60"></CodeLine>
<Link id="l00061" /><CodeLine lineNumber="61"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we can pick a scalar constant value out of a vector, that is free.</span></CodeLine>
<Link id="l00062" /><CodeLine lineNumber="62"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Constant&gt;</a>(V))</span></CodeLine>
<Link id="l00063" /><CodeLine lineNumber="63"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> CEI || <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>-&gt;getSplatValue();</span></CodeLine>
<Link id="l00064" /><CodeLine lineNumber="64"></CodeLine>
<Link id="l00065" /><CodeLine lineNumber="65"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CEI &amp;&amp; <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(V, <a href="/docs/api/namespaces/llvm/patternmatch/#a3c0adc1054838f4498e0e860b637a22b">m&#95;Intrinsic&lt;Intrinsic::stepvector&gt;</a>())) &#123;</span></CodeLine>
<Link id="l00066" /><CodeLine lineNumber="66"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/elementcount">ElementCount</a> EC = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;VectorType&gt;</a>(V-&gt;getType())-&gt;getElementCount();</span></CodeLine>
<Link id="l00067" /><CodeLine lineNumber="67"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Index needs to be lower than the minimum size of the vector, because</span></CodeLine>
<Link id="l00068" /><CodeLine lineNumber="68"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// for scalable vector, the vector size is known at run time.</span></CodeLine>
<Link id="l00069" /><CodeLine lineNumber="69"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> CEI-&gt;<a href="/docs/api/classes/llvm/constantint/#af7e1934ed72a405ef073ea5f9bbe828e">getValue</a>().<a href="/docs/api/classes/llvm/apint/#a545e8d5dfa1688acea0d0e275b03682f">ult</a>(EC.getKnownMinValue());</span></CodeLine>
<Link id="l00070" /><CodeLine lineNumber="70"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00071" /><CodeLine lineNumber="71"></CodeLine>
<Link id="l00072" /><CodeLine lineNumber="72"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// An insertelement to the same constant index as our extract will simplify</span></CodeLine>
<Link id="l00073" /><CodeLine lineNumber="73"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// to the scalar inserted element. An insertelement to a different constant</span></CodeLine>
<Link id="l00074" /><CodeLine lineNumber="74"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// index is irrelevant to our extract.</span></CodeLine>
<Link id="l00075" /><CodeLine lineNumber="75"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(V, <a href="/docs/api/namespaces/llvm/patternmatch/#aec67d7d9e090f41ec66d0d10169a440e">m&#95;InsertElt</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(), <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>())))</span></CodeLine>
<Link id="l00076" /><CodeLine lineNumber="76"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> CEI;</span></CodeLine>
<Link id="l00077" /><CodeLine lineNumber="77"></CodeLine>
<Link id="l00078" /><CodeLine lineNumber="78"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(V, <a href="/docs/api/namespaces/llvm/patternmatch/#a5be13f3abb6bddf7ad9747b077da5a0e">m&#95;OneUse</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a6a512a71ae0746953ca6585669a4d47c">m&#95;Load</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>()))))</span></CodeLine>
<Link id="l00079" /><CodeLine lineNumber="79"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00080" /><CodeLine lineNumber="80"></CodeLine>
<Link id="l00081" /><CodeLine lineNumber="81"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(V, <a href="/docs/api/namespaces/llvm/patternmatch/#a5be13f3abb6bddf7ad9747b077da5a0e">m&#95;OneUse</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aa1610c81cbc4ec2f1499140e33de45d5">m&#95;UnOp</a>())))</span></CodeLine>
<Link id="l00082" /><CodeLine lineNumber="82"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00083" /><CodeLine lineNumber="83"></CodeLine>
<Link id="l00084" /><CodeLine lineNumber="84"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;V0, &#42;V1;</span></CodeLine>
<Link id="l00085" /><CodeLine lineNumber="85"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(V, <a href="/docs/api/namespaces/llvm/patternmatch/#a5be13f3abb6bddf7ad9747b077da5a0e">m&#95;OneUse</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a0698afabe907d2d3b87889d2e0349d47">m&#95;BinOp</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(V0), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(V1)))))</span></CodeLine>
<Link id="l00086" /><CodeLine lineNumber="86"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a89f5f0f536cc9b0bae261737f13786f7">cheapToScalarize</a>(V0, EI) || <a href="#a89f5f0f536cc9b0bae261737f13786f7">cheapToScalarize</a>(V1, EI))</span></CodeLine>
<Link id="l00087" /><CodeLine lineNumber="87"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00088" /><CodeLine lineNumber="88"></CodeLine>
<Link id="l00089" /><CodeLine lineNumber="89"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/cmppredicate">CmpPredicate</a> UnusedPred;</span></CodeLine>
<Link id="l00090" /><CodeLine lineNumber="90"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(V, <a href="/docs/api/namespaces/llvm/patternmatch/#a5be13f3abb6bddf7ad9747b077da5a0e">m&#95;OneUse</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a7d9ab823fe85606fa795c0c6fc75aca6">m&#95;Cmp</a>(UnusedPred, <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(V0), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(V1)))))</span></CodeLine>
<Link id="l00091" /><CodeLine lineNumber="91"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a89f5f0f536cc9b0bae261737f13786f7">cheapToScalarize</a>(V0, EI) || <a href="#a89f5f0f536cc9b0bae261737f13786f7">cheapToScalarize</a>(V1, EI))</span></CodeLine>
<Link id="l00092" /><CodeLine lineNumber="92"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00093" /><CodeLine lineNumber="93"></CodeLine>
<Link id="l00094" /><CodeLine lineNumber="94"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00095" /><CodeLine lineNumber="95"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00096" /><CodeLine lineNumber="96"></CodeLine>
<Link id="l00097" /><CodeLine lineNumber="97"><span class="doxyHighlightComment">// If we have a PHI node with a vector type that is only used to feed</span></CodeLine>
<Link id="l00098" /><CodeLine lineNumber="98"><span class="doxyHighlightComment">// itself and be an operand of extractelement at a constant location,</span></CodeLine>
<Link id="l00099" /><CodeLine lineNumber="99"><span class="doxyHighlightComment">// try to replace the PHI of the vector type with a PHI of a scalar type.</span></CodeLine>
<Link id="l00100" /><CodeLine lineNumber="100"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;InstCombinerImpl::scalarizePHI(<a href="/docs/api/classes/llvm/extractelementinst">ExtractElementInst</a> &amp;EI,</span></CodeLine>
<Link id="l00101" /><CodeLine lineNumber="101"><span class="doxyHighlight">                                            <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;PN) &#123;</span></CodeLine>
<Link id="l00102" /><CodeLine lineNumber="102"><span class="doxyHighlight">  SmallVector&lt;Instruction &#42;, 2&gt; Extracts;</span></CodeLine>
<Link id="l00103" /><CodeLine lineNumber="103"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The users we want the PHI to have are:</span></CodeLine>
<Link id="l00104" /><CodeLine lineNumber="104"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// 1) The EI ExtractElement (we already know this)</span></CodeLine>
<Link id="l00105" /><CodeLine lineNumber="105"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// 2) Possibly more ExtractElements with the same index.</span></CodeLine>
<Link id="l00106" /><CodeLine lineNumber="106"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// 3) Another operand, which will feed back into the PHI.</span></CodeLine>
<Link id="l00107" /><CodeLine lineNumber="107"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/sandboxir/#a75d3582b0f0bc7a5123de92ada301e97">Instruction</a> &#42;PHIUser = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00108" /><CodeLine lineNumber="108"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;U : PN-&gt;<a href="/docs/api/classes/llvm/value/#a411cf3e3932f209ce3374cb31adc1da6">users</a>()) &#123;</span></CodeLine>
<Link id="l00109" /><CodeLine lineNumber="109"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ExtractElementInst &#42;EU = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ExtractElementInst&gt;</a>(U)) &#123;</span></CodeLine>
<Link id="l00110" /><CodeLine lineNumber="110"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (EI.<a href="/docs/api/classes/llvm/extractelementinst/#aba9478635b356d769c5f10f92515d24b">getIndexOperand</a>() == EU-&gt;getIndexOperand())</span></CodeLine>
<Link id="l00111" /><CodeLine lineNumber="111"><span class="doxyHighlight">        Extracts.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(EU);</span></CodeLine>
<Link id="l00112" /><CodeLine lineNumber="112"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00113" /><CodeLine lineNumber="113"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00114" /><CodeLine lineNumber="114"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!PHIUser) &#123;</span></CodeLine>
<Link id="l00115" /><CodeLine lineNumber="115"><span class="doxyHighlight">      PHIUser = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Instruction&gt;</a>(U);</span></CodeLine>
<Link id="l00116" /><CodeLine lineNumber="116"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00117" /><CodeLine lineNumber="117"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00118" /><CodeLine lineNumber="118"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00119" /><CodeLine lineNumber="119"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00120" /><CodeLine lineNumber="120"></CodeLine>
<Link id="l00121" /><CodeLine lineNumber="121"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!PHIUser)</span></CodeLine>
<Link id="l00122" /><CodeLine lineNumber="122"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00123" /><CodeLine lineNumber="123"></CodeLine>
<Link id="l00124" /><CodeLine lineNumber="124"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Verify that this PHI user has one use, which is the PHI itself,</span></CodeLine>
<Link id="l00125" /><CodeLine lineNumber="125"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// and that it is a binary operation which is cheap to scalarize.</span></CodeLine>
<Link id="l00126" /><CodeLine lineNumber="126"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// otherwise return nullptr.</span></CodeLine>
<Link id="l00127" /><CodeLine lineNumber="127"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!PHIUser-&gt;<a href="/docs/api/classes/llvm/value/#a3a402430a1bbe70a9282dcb0e0b6a2cd">hasOneUse</a>() || !(PHIUser-&gt;<a href="/docs/api/classes/llvm/instruction/#a6609528bd67d5506a9bf9a2cce2d6f58">user&#95;back</a>() == PN) ||</span></CodeLine>
<Link id="l00128" /><CodeLine lineNumber="128"><span class="doxyHighlight">      !(<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;BinaryOperator&gt;</a>(PHIUser)) ||</span></CodeLine>
<Link id="l00129" /><CodeLine lineNumber="129"><span class="doxyHighlight">      !<a href="#a89f5f0f536cc9b0bae261737f13786f7">cheapToScalarize</a>(PHIUser, EI.<a href="/docs/api/classes/llvm/extractelementinst/#aba9478635b356d769c5f10f92515d24b">getIndexOperand</a>()))</span></CodeLine>
<Link id="l00130" /><CodeLine lineNumber="130"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00131" /><CodeLine lineNumber="131"></CodeLine>
<Link id="l00132" /><CodeLine lineNumber="132"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create a scalar PHI node that will replace the vector PHI node</span></CodeLine>
<Link id="l00133" /><CodeLine lineNumber="133"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// just before the current PHI node.</span></CodeLine>
<Link id="l00134" /><CodeLine lineNumber="134"><span class="doxyHighlight">  PHINode &#42;scalarPHI = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;PHINode&gt;</a>(<a href="/docs/api/classes/llvm/instcombiner/#a7ce29ca36c91b8c790b0f8b2560c3033">InsertNewInstWith</a>(</span></CodeLine>
<Link id="l00135" /><CodeLine lineNumber="135"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/phinode/#af4aba918a76ca15bde1be3e14572e475">PHINode::Create</a>(EI.<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>(), PN-&gt;<a href="/docs/api/classes/llvm/phinode/#aef51af4b490af6b3bf2dfbc8737a8f9f">getNumIncomingValues</a>(), </span><span class="doxyHighlightStringLiteral">&quot;&quot;</span><span class="doxyHighlight">), PN-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>()));</span></CodeLine>
<Link id="l00136" /><CodeLine lineNumber="136"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Scalarize each PHI operand.</span></CodeLine>
<Link id="l00137" /><CodeLine lineNumber="137"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> i = 0; i &lt; PN-&gt;<a href="/docs/api/classes/llvm/phinode/#aef51af4b490af6b3bf2dfbc8737a8f9f">getNumIncomingValues</a>(); i++) &#123;</span></CodeLine>
<Link id="l00138" /><CodeLine lineNumber="138"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a066e2a31a13d6520e52ae1944f194662">Value</a> &#42;PHIInVal = PN-&gt;<a href="/docs/api/classes/llvm/phinode/#aca1fd00f3ab63ec8f0f1ccc2093a9f6d">getIncomingValue</a>(i);</span></CodeLine>
<Link id="l00139" /><CodeLine lineNumber="139"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/isd/#a22ea9cec080dd5f4f47ba234c2f59110a8472e46f9e4db168c5610ecdfb05dbaf">BasicBlock</a> &#42;inBB = PN-&gt;<a href="/docs/api/classes/llvm/phinode/#ac53e1aabdf64e91b8b325bcac250d8a9">getIncomingBlock</a>(i);</span></CodeLine>
<Link id="l00140" /><CodeLine lineNumber="140"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a066e2a31a13d6520e52ae1944f194662">Value</a> &#42;Elt = EI.<a href="/docs/api/classes/llvm/extractelementinst/#aba9478635b356d769c5f10f92515d24b">getIndexOperand</a>();</span></CodeLine>
<Link id="l00141" /><CodeLine lineNumber="141"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If the operand is the PHI induction variable:</span></CodeLine>
<Link id="l00142" /><CodeLine lineNumber="142"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (PHIInVal == PHIUser) &#123;</span></CodeLine>
<Link id="l00143" /><CodeLine lineNumber="143"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Scalarize the binary operation. Its first operand is the</span></CodeLine>
<Link id="l00144" /><CodeLine lineNumber="144"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// scalar PHI, and the second operand is extracted from the other</span></CodeLine>
<Link id="l00145" /><CodeLine lineNumber="145"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// vector operand.</span></CodeLine>
<Link id="l00146" /><CodeLine lineNumber="146"><span class="doxyHighlight">      BinaryOperator &#42;B0 = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BinaryOperator&gt;</a>(PHIUser);</span></CodeLine>
<Link id="l00147" /><CodeLine lineNumber="147"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> opId = (B0-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0) == PN) ? 1 : 0;</span></CodeLine>
<Link id="l00148" /><CodeLine lineNumber="148"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#a066e2a31a13d6520e52ae1944f194662">Value</a> &#42;<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a> = <a href="/docs/api/classes/llvm/instcombiner/#a7ce29ca36c91b8c790b0f8b2560c3033">InsertNewInstWith</a>(</span></CodeLine>
<Link id="l00149" /><CodeLine lineNumber="149"><span class="doxyHighlight">          <a href="/docs/api/classes/llvm/extractelementinst/#a686bd809f72a2701d97b1bbd17f7db9f">ExtractElementInst::Create</a>(B0-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(opId), Elt,</span></CodeLine>
<Link id="l00150" /><CodeLine lineNumber="150"><span class="doxyHighlight">                                     B0-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(opId)-&gt;<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>() + </span><span class="doxyHighlightStringLiteral">&quot;.Elt&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00151" /><CodeLine lineNumber="151"><span class="doxyHighlight">          B0-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>());</span></CodeLine>
<Link id="l00152" /><CodeLine lineNumber="152"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#a066e2a31a13d6520e52ae1944f194662">Value</a> &#42;newPHIUser = <a href="/docs/api/classes/llvm/instcombiner/#a7ce29ca36c91b8c790b0f8b2560c3033">InsertNewInstWith</a>(</span></CodeLine>
<Link id="l00153" /><CodeLine lineNumber="153"><span class="doxyHighlight">          <a href="/docs/api/classes/llvm/binaryoperator/#ac80f39cdc458ec63d7ff5f7490498230">BinaryOperator::CreateWithCopiedFlags</a>(B0-&gt;<a href="/docs/api/classes/llvm/binaryoperator/#a31bf07f3f61525486633bc1d0bbaf029">getOpcode</a>(),</span></CodeLine>
<Link id="l00154" /><CodeLine lineNumber="154"><span class="doxyHighlight">                                                scalarPHI, <a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>, B0), B0-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>());</span></CodeLine>
<Link id="l00155" /><CodeLine lineNumber="155"><span class="doxyHighlight">      scalarPHI-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(newPHIUser, inBB);</span></CodeLine>
<Link id="l00156" /><CodeLine lineNumber="156"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00157" /><CodeLine lineNumber="157"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Scalarize PHI input:</span></CodeLine>
<Link id="l00158" /><CodeLine lineNumber="158"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/sandboxir/#a75d3582b0f0bc7a5123de92ada301e97">Instruction</a> &#42;newEI = <a href="/docs/api/classes/llvm/extractelementinst/#a686bd809f72a2701d97b1bbd17f7db9f">ExtractElementInst::Create</a>(PHIInVal, Elt, </span><span class="doxyHighlightStringLiteral">&quot;&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00159" /><CodeLine lineNumber="159"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Insert the new instruction into the predecessor basic block.</span></CodeLine>
<Link id="l00160" /><CodeLine lineNumber="160"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/sandboxir/#a75d3582b0f0bc7a5123de92ada301e97">Instruction</a> &#42;pos = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(PHIInVal);</span></CodeLine>
<Link id="l00161" /><CodeLine lineNumber="161"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> InsertPos;</span></CodeLine>
<Link id="l00162" /><CodeLine lineNumber="162"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (pos &amp;&amp; !<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;PHINode&gt;</a>(pos)) &#123;</span></CodeLine>
<Link id="l00163" /><CodeLine lineNumber="163"><span class="doxyHighlight">        InsertPos = ++pos-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>();</span></CodeLine>
<Link id="l00164" /><CodeLine lineNumber="164"><span class="doxyHighlight">      &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00165" /><CodeLine lineNumber="165"><span class="doxyHighlight">        InsertPos = inBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a161fd4e9fa5367f64c2a4c9e921c3ad3">getFirstInsertionPt</a>();</span></CodeLine>
<Link id="l00166" /><CodeLine lineNumber="166"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00167" /><CodeLine lineNumber="167"></CodeLine>
<Link id="l00168" /><CodeLine lineNumber="168"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/instcombiner/#a7ce29ca36c91b8c790b0f8b2560c3033">InsertNewInstWith</a>(newEI, InsertPos);</span></CodeLine>
<Link id="l00169" /><CodeLine lineNumber="169"></CodeLine>
<Link id="l00170" /><CodeLine lineNumber="170"><span class="doxyHighlight">      scalarPHI-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(newEI, inBB);</span></CodeLine>
<Link id="l00171" /><CodeLine lineNumber="171"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00172" /><CodeLine lineNumber="172"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00173" /><CodeLine lineNumber="173"></CodeLine>
<Link id="l00174" /><CodeLine lineNumber="174"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#abb2b3a60ccc38a28239e19a1646e0c8a">E</a> : Extracts) &#123;</span></CodeLine>
<Link id="l00175" /><CodeLine lineNumber="175"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/instcombiner/#a49f1bd0bdf0ef741bdd714cc1188d7c5">replaceInstUsesWith</a>(&#42;<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#abb2b3a60ccc38a28239e19a1646e0c8a">E</a>, scalarPHI);</span></CodeLine>
<Link id="l00176" /><CodeLine lineNumber="176"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Add old extract to worklist for DCE.</span></CodeLine>
<Link id="l00177" /><CodeLine lineNumber="177"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/instcombiner/#ab86d58ae73173328360a32cbbb0d5b14">addToWorklist</a>(<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#abb2b3a60ccc38a28239e19a1646e0c8a">E</a>);</span></CodeLine>
<Link id="l00178" /><CodeLine lineNumber="178"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00179" /><CodeLine lineNumber="179"></CodeLine>
<Link id="l00180" /><CodeLine lineNumber="180"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &amp;EI;</span></CodeLine>
<Link id="l00181" /><CodeLine lineNumber="181"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00182" /><CodeLine lineNumber="182"></CodeLine>
<Link id="l00183" /><CodeLine lineNumber="183"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;InstCombinerImpl::foldBitcastExtElt(<a href="/docs/api/classes/llvm/extractelementinst">ExtractElementInst</a> &amp;Ext) &#123;</span></CodeLine>
<Link id="l00184" /><CodeLine lineNumber="184"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a066e2a31a13d6520e52ae1944f194662">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>;</span></CodeLine>
<Link id="l00185" /><CodeLine lineNumber="185"><span class="doxyHighlight">  uint64&#95;t ExtIndexC;</span></CodeLine>
<Link id="l00186" /><CodeLine lineNumber="186"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(<a href="/docs/api/namespaces/llvm/mipsisd/#a422daf9aa810935178671306b651d69ba88a797f57846adb2c382b3732b471913">Ext</a>.getVectorOperand(), <a href="/docs/api/namespaces/llvm/patternmatch/#a99d8e67ed2343ad6717d7a8fdd3e7c7a">m&#95;BitCast</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>))) ||</span></CodeLine>
<Link id="l00187" /><CodeLine lineNumber="187"><span class="doxyHighlight">      !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(<a href="/docs/api/namespaces/llvm/mipsisd/#a422daf9aa810935178671306b651d69ba88a797f57846adb2c382b3732b471913">Ext</a>.getIndexOperand(), <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>(ExtIndexC)))</span></CodeLine>
<Link id="l00188" /><CodeLine lineNumber="188"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00189" /><CodeLine lineNumber="189"></CodeLine>
<Link id="l00190" /><CodeLine lineNumber="190"><span class="doxyHighlight">  ElementCount NumElts =</span></CodeLine>
<Link id="l00191" /><CodeLine lineNumber="191"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;VectorType&gt;</a>(<a href="/docs/api/namespaces/llvm/mipsisd/#a422daf9aa810935178671306b651d69ba88a797f57846adb2c382b3732b471913">Ext</a>.getVectorOperandType())-&gt;getElementCount();</span></CodeLine>
<Link id="l00192" /><CodeLine lineNumber="192"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/demangle/itaniumdemangle-h/#a88ee8e4eea43084bd8964682683da88caa1fa27779242b4902f7ae3bdd5c6d508">Type</a> &#42;DestTy = <a href="/docs/api/namespaces/llvm/mipsisd/#a422daf9aa810935178671306b651d69ba88a797f57846adb2c382b3732b471913">Ext</a>.getType();</span></CodeLine>
<Link id="l00193" /><CodeLine lineNumber="193"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> DestWidth = DestTy-&gt;<a href="/docs/api/classes/llvm/type/#a833daf718a49c5cd637d8c9ddeaebe07">getPrimitiveSizeInBits</a>();</span></CodeLine>
<Link id="l00194" /><CodeLine lineNumber="194"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> IsBigEndian = <a href="/docs/api/classes/llvm/instcombiner/#a878e8128a9a4e5626df91dcd91cba337">DL</a>.isBigEndian();</span></CodeLine>
<Link id="l00195" /><CodeLine lineNumber="195"></CodeLine>
<Link id="l00196" /><CodeLine lineNumber="196"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we are casting an integer to vector and extracting a portion, that is</span></CodeLine>
<Link id="l00197" /><CodeLine lineNumber="197"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// a shift-right and truncate.</span></CodeLine>
<Link id="l00198" /><CodeLine lineNumber="198"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;getType()-&gt;isIntegerTy()) &#123;</span></CodeLine>
<Link id="l00199" /><CodeLine lineNumber="199"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;FixedVectorType&gt;</a>(<a href="/docs/api/namespaces/llvm/mipsisd/#a422daf9aa810935178671306b651d69ba88a797f57846adb2c382b3732b471913">Ext</a>.getVectorOperand()-&gt;getType()) &amp;&amp;</span></CodeLine>
<Link id="l00200" /><CodeLine lineNumber="200"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;Expected fixed vector type for bitcast from scalar integer&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00201" /><CodeLine lineNumber="201"></CodeLine>
<Link id="l00202" /><CodeLine lineNumber="202"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Big endian requires adjusting the extract index since MSB is at index 0</span></CodeLine>
<Link id="l00203" /><CodeLine lineNumber="203"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// LittleEndian: extelt (bitcast i32 X to v4i8), 0 -&gt; trunc i32 X to i8</span></CodeLine>
<Link id="l00204" /><CodeLine lineNumber="204"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// BigEndian: extelt (bitcast i32 X to v4i8), 0 -&gt; trunc i32 (X &gt;&gt; 24) to i8</span></CodeLine>
<Link id="l00205" /><CodeLine lineNumber="205"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IsBigEndian)</span></CodeLine>
<Link id="l00206" /><CodeLine lineNumber="206"><span class="doxyHighlight">      ExtIndexC = NumElts.<a href="/docs/api/classes/llvm/details/fixedorscalablequantity/#ac4ab9dd9440c55bee1aa4a1195cee759">getKnownMinValue</a>() - 1 - ExtIndexC;</span></CodeLine>
<Link id="l00207" /><CodeLine lineNumber="207"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> ShiftAmountC = ExtIndexC &#42; DestWidth;</span></CodeLine>
<Link id="l00208" /><CodeLine lineNumber="208"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> ((!ShiftAmountC ||</span></CodeLine>
<Link id="l00209" /><CodeLine lineNumber="209"><span class="doxyHighlight">         isDesirableIntType(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;getType()-&gt;getPrimitiveSizeInBits())) &amp;&amp;</span></CodeLine>
<Link id="l00210" /><CodeLine lineNumber="210"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/mipsisd/#a422daf9aa810935178671306b651d69ba88a797f57846adb2c382b3732b471913">Ext</a>.getVectorOperand()-&gt;hasOneUse()) &#123;</span></CodeLine>
<Link id="l00211" /><CodeLine lineNumber="211"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ShiftAmountC)</span></CodeLine>
<Link id="l00212" /><CodeLine lineNumber="212"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a> = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateLShr(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, ShiftAmountC, </span><span class="doxyHighlightStringLiteral">&quot;extelt.offset&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00213" /><CodeLine lineNumber="213"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (DestTy-&gt;<a href="/docs/api/classes/llvm/type/#aac5759c83abd6a4af236401a7cfe7a0f">isFloatingPointTy</a>()) &#123;</span></CodeLine>
<Link id="l00214" /><CodeLine lineNumber="214"><span class="doxyHighlight">        <a href="/docs/api/files/include/include/llvm/include/llvm/demangle/itaniumdemangle-h/#a88ee8e4eea43084bd8964682683da88caa1fa27779242b4902f7ae3bdd5c6d508">Type</a> &#42;DstIntTy = <a href="/docs/api/classes/llvm/type/#acaf8e4c3e40e01e848c1fad5f05b81cd">IntegerType::getIntNTy</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;getContext(), DestWidth);</span></CodeLine>
<Link id="l00215" /><CodeLine lineNumber="215"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a066e2a31a13d6520e52ae1944f194662">Value</a> &#42;Trunc = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateTrunc(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, DstIntTy);</span></CodeLine>
<Link id="l00216" /><CodeLine lineNumber="216"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> BitCastInst(Trunc, DestTy);</span></CodeLine>
<Link id="l00217" /><CodeLine lineNumber="217"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00218" /><CodeLine lineNumber="218"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> TruncInst(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, DestTy);</span></CodeLine>
<Link id="l00219" /><CodeLine lineNumber="219"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00220" /><CodeLine lineNumber="220"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00221" /><CodeLine lineNumber="221"></CodeLine>
<Link id="l00222" /><CodeLine lineNumber="222"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;getType()-&gt;isVectorTy())</span></CodeLine>
<Link id="l00223" /><CodeLine lineNumber="223"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00224" /><CodeLine lineNumber="224"></CodeLine>
<Link id="l00225" /><CodeLine lineNumber="225"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If this extractelement is using a bitcast from a vector of the same number</span></CodeLine>
<Link id="l00226" /><CodeLine lineNumber="226"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// of elements, see if we can find the source element from the source vector:</span></CodeLine>
<Link id="l00227" /><CodeLine lineNumber="227"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// extelt (bitcast VecX), IndexC --&gt; bitcast X&#91;IndexC&#93;</span></CodeLine>
<Link id="l00228" /><CodeLine lineNumber="228"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;SrcTy = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;VectorType&gt;</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;getType());</span></CodeLine>
<Link id="l00229" /><CodeLine lineNumber="229"><span class="doxyHighlight">  ElementCount NumSrcElts = SrcTy-&gt;getElementCount();</span></CodeLine>
<Link id="l00230" /><CodeLine lineNumber="230"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NumSrcElts == NumElts)</span></CodeLine>
<Link id="l00231" /><CodeLine lineNumber="231"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a066e2a31a13d6520e52ae1944f194662">Value</a> &#42;Elt = <a href="/docs/api/namespaces/llvm/#ab09fc7dee4f7e02c60f7a9c928dc1603">findScalarElement</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, ExtIndexC))</span></CodeLine>
<Link id="l00232" /><CodeLine lineNumber="232"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> BitCastInst(Elt, DestTy);</span></CodeLine>
<Link id="l00233" /><CodeLine lineNumber="233"></CodeLine>
<Link id="l00234" /><CodeLine lineNumber="234"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(NumSrcElts.<a href="/docs/api/classes/llvm/details/fixedorscalablequantity/#a9188f84e1dd67530330dcab9cae787d7">isScalable</a>() == NumElts.<a href="/docs/api/classes/llvm/details/fixedorscalablequantity/#a9188f84e1dd67530330dcab9cae787d7">isScalable</a>() &amp;&amp;</span></CodeLine>
<Link id="l00235" /><CodeLine lineNumber="235"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;Src and Dst must be the same sort of vector type&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00236" /><CodeLine lineNumber="236"></CodeLine>
<Link id="l00237" /><CodeLine lineNumber="237"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the source elements are wider than the destination, try to shift and</span></CodeLine>
<Link id="l00238" /><CodeLine lineNumber="238"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// truncate a subset of scalar bits of an insert op.</span></CodeLine>
<Link id="l00239" /><CodeLine lineNumber="239"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NumSrcElts.<a href="/docs/api/classes/llvm/details/fixedorscalablequantity/#ac4ab9dd9440c55bee1aa4a1195cee759">getKnownMinValue</a>() &lt; NumElts.<a href="/docs/api/classes/llvm/details/fixedorscalablequantity/#ac4ab9dd9440c55bee1aa4a1195cee759">getKnownMinValue</a>()) &#123;</span></CodeLine>
<Link id="l00240" /><CodeLine lineNumber="240"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a066e2a31a13d6520e52ae1944f194662">Value</a> &#42;<a href="/docs/api/namespaces/llvm/nvptx/ptxldstinstcode/#a91119cbee2be000c528a690252aee07ca09c68d67f7dbfa6cc77eaf73aa535217">Scalar</a>;</span></CodeLine>
<Link id="l00241" /><CodeLine lineNumber="241"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a066e2a31a13d6520e52ae1944f194662">Value</a> &#42;Vec;</span></CodeLine>
<Link id="l00242" /><CodeLine lineNumber="242"><span class="doxyHighlight">    uint64&#95;t InsIndexC;</span></CodeLine>
<Link id="l00243" /><CodeLine lineNumber="243"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, <a href="/docs/api/namespaces/llvm/patternmatch/#aec67d7d9e090f41ec66d0d10169a440e">m&#95;InsertElt</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(Vec), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(Scalar),</span></CodeLine>
<Link id="l00244" /><CodeLine lineNumber="244"><span class="doxyHighlight">                              <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>(InsIndexC))))</span></CodeLine>
<Link id="l00245" /><CodeLine lineNumber="245"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00246" /><CodeLine lineNumber="246"></CodeLine>
<Link id="l00247" /><CodeLine lineNumber="247"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// The extract must be from the subset of vector elements that we inserted</span></CodeLine>
<Link id="l00248" /><CodeLine lineNumber="248"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// into. Example: if we inserted element 1 of a &lt;2 x i64&gt; and we are</span></CodeLine>
<Link id="l00249" /><CodeLine lineNumber="249"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// extracting an i16 (narrowing ratio = 4), then this extract must be from 1</span></CodeLine>
<Link id="l00250" /><CodeLine lineNumber="250"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// of elements 4-7 of the bitcasted vector.</span></CodeLine>
<Link id="l00251" /><CodeLine lineNumber="251"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NarrowingRatio =</span></CodeLine>
<Link id="l00252" /><CodeLine lineNumber="252"><span class="doxyHighlight">        NumElts.<a href="/docs/api/classes/llvm/details/fixedorscalablequantity/#ac4ab9dd9440c55bee1aa4a1195cee759">getKnownMinValue</a>() / NumSrcElts.<a href="/docs/api/classes/llvm/details/fixedorscalablequantity/#ac4ab9dd9440c55bee1aa4a1195cee759">getKnownMinValue</a>();</span></CodeLine>
<Link id="l00253" /><CodeLine lineNumber="253"></CodeLine>
<Link id="l00254" /><CodeLine lineNumber="254"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ExtIndexC / NarrowingRatio != InsIndexC) &#123;</span></CodeLine>
<Link id="l00255" /><CodeLine lineNumber="255"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Remove insertelement, if we don&#39;t use the inserted element.</span></CodeLine>
<Link id="l00256" /><CodeLine lineNumber="256"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// extractelement (bitcast (insertelement (Vec, b)), a) -&gt;</span></CodeLine>
<Link id="l00257" /><CodeLine lineNumber="257"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// extractelement (bitcast (Vec), a)</span></CodeLine>
<Link id="l00258" /><CodeLine lineNumber="258"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// FIXME: this should be removed to SimplifyDemandedVectorElts,</span></CodeLine>
<Link id="l00259" /><CodeLine lineNumber="259"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// once scale vectors are supported.</span></CodeLine>
<Link id="l00260" /><CodeLine lineNumber="260"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;hasOneUse() &amp;&amp; <a href="/docs/api/namespaces/llvm/mipsisd/#a422daf9aa810935178671306b651d69ba88a797f57846adb2c382b3732b471913">Ext</a>.getVectorOperand()-&gt;hasOneUse()) &#123;</span></CodeLine>
<Link id="l00261" /><CodeLine lineNumber="261"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a066e2a31a13d6520e52ae1944f194662">Value</a> &#42;NewBC = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateBitCast(Vec, <a href="/docs/api/namespaces/llvm/mipsisd/#a422daf9aa810935178671306b651d69ba88a797f57846adb2c382b3732b471913">Ext</a>.getVectorOperandType());</span></CodeLine>
<Link id="l00262" /><CodeLine lineNumber="262"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/extractelementinst/#a686bd809f72a2701d97b1bbd17f7db9f">ExtractElementInst::Create</a>(NewBC, <a href="/docs/api/namespaces/llvm/mipsisd/#a422daf9aa810935178671306b651d69ba88a797f57846adb2c382b3732b471913">Ext</a>.getIndexOperand());</span></CodeLine>
<Link id="l00263" /><CodeLine lineNumber="263"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00264" /><CodeLine lineNumber="264"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00265" /><CodeLine lineNumber="265"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00266" /><CodeLine lineNumber="266"></CodeLine>
<Link id="l00267" /><CodeLine lineNumber="267"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We are extracting part of the original scalar. How that scalar is</span></CodeLine>
<Link id="l00268" /><CodeLine lineNumber="268"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// inserted into the vector depends on the endian-ness. Example:</span></CodeLine>
<Link id="l00269" /><CodeLine lineNumber="269"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//              Vector Byte Elt Index:    0  1  2  3  4  5  6  7</span></CodeLine>
<Link id="l00270" /><CodeLine lineNumber="270"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//                                       +--+--+--+--+--+--+--+--+</span></CodeLine>
<Link id="l00271" /><CodeLine lineNumber="271"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// inselt &lt;2 x i32&gt; V, &lt;i32&gt; S, 1:       |V0|V1|V2|V3|S0|S1|S2|S3|</span></CodeLine>
<Link id="l00272" /><CodeLine lineNumber="272"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// extelt &lt;4 x i16&gt; V&#39;, 3:               |                 |S2|S3|</span></CodeLine>
<Link id="l00273" /><CodeLine lineNumber="273"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//                                       +--+--+--+--+--+--+--+--+</span></CodeLine>
<Link id="l00274" /><CodeLine lineNumber="274"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If this is little-endian, S2|S3 are the MSB of the 32-bit &#39;S&#39; value.</span></CodeLine>
<Link id="l00275" /><CodeLine lineNumber="275"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If this is big-endian, S2|S3 are the LSB of the 32-bit &#39;S&#39; value.</span></CodeLine>
<Link id="l00276" /><CodeLine lineNumber="276"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// In this example, we must right-shift little-endian. Big-endian is just a</span></CodeLine>
<Link id="l00277" /><CodeLine lineNumber="277"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// truncate.</span></CodeLine>
<Link id="l00278" /><CodeLine lineNumber="278"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> Chunk = ExtIndexC % NarrowingRatio;</span></CodeLine>
<Link id="l00279" /><CodeLine lineNumber="279"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IsBigEndian)</span></CodeLine>
<Link id="l00280" /><CodeLine lineNumber="280"><span class="doxyHighlight">      Chunk = NarrowingRatio - 1 - Chunk;</span></CodeLine>
<Link id="l00281" /><CodeLine lineNumber="281"></CodeLine>
<Link id="l00282" /><CodeLine lineNumber="282"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Bail out if this is an FP vector to FP vector sequence. That would take</span></CodeLine>
<Link id="l00283" /><CodeLine lineNumber="283"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// more instructions than we started with unless there is no shift, and it</span></CodeLine>
<Link id="l00284" /><CodeLine lineNumber="284"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// may not be handled as well in the backend.</span></CodeLine>
<Link id="l00285" /><CodeLine lineNumber="285"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> NeedSrcBitcast = SrcTy-&gt;getScalarType()-&gt;isFloatingPointTy();</span></CodeLine>
<Link id="l00286" /><CodeLine lineNumber="286"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> NeedDestBitcast = DestTy-&gt;<a href="/docs/api/classes/llvm/type/#aac5759c83abd6a4af236401a7cfe7a0f">isFloatingPointTy</a>();</span></CodeLine>
<Link id="l00287" /><CodeLine lineNumber="287"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NeedSrcBitcast &amp;&amp; NeedDestBitcast)</span></CodeLine>
<Link id="l00288" /><CodeLine lineNumber="288"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00289" /><CodeLine lineNumber="289"></CodeLine>
<Link id="l00290" /><CodeLine lineNumber="290"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> SrcWidth = SrcTy-&gt;getScalarSizeInBits();</span></CodeLine>
<Link id="l00291" /><CodeLine lineNumber="291"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> ShAmt = Chunk &#42; DestWidth;</span></CodeLine>
<Link id="l00292" /><CodeLine lineNumber="292"></CodeLine>
<Link id="l00293" /><CodeLine lineNumber="293"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// TODO: This limitation is more strict than necessary. We could sum the</span></CodeLine>
<Link id="l00294" /><CodeLine lineNumber="294"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// number of new instructions and subtract the number eliminated to know if</span></CodeLine>
<Link id="l00295" /><CodeLine lineNumber="295"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// we can proceed.</span></CodeLine>
<Link id="l00296" /><CodeLine lineNumber="296"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;hasOneUse() || !<a href="/docs/api/namespaces/llvm/mipsisd/#a422daf9aa810935178671306b651d69ba88a797f57846adb2c382b3732b471913">Ext</a>.getVectorOperand()-&gt;hasOneUse())</span></CodeLine>
<Link id="l00297" /><CodeLine lineNumber="297"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NeedSrcBitcast || NeedDestBitcast)</span></CodeLine>
<Link id="l00298" /><CodeLine lineNumber="298"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00299" /><CodeLine lineNumber="299"></CodeLine>
<Link id="l00300" /><CodeLine lineNumber="300"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NeedSrcBitcast) &#123;</span></CodeLine>
<Link id="l00301" /><CodeLine lineNumber="301"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/demangle/itaniumdemangle-h/#a88ee8e4eea43084bd8964682683da88caa1fa27779242b4902f7ae3bdd5c6d508">Type</a> &#42;SrcIntTy = <a href="/docs/api/classes/llvm/type/#acaf8e4c3e40e01e848c1fad5f05b81cd">IntegerType::getIntNTy</a>(<a href="/docs/api/namespaces/llvm/nvptx/ptxldstinstcode/#a91119cbee2be000c528a690252aee07ca09c68d67f7dbfa6cc77eaf73aa535217">Scalar</a>-&gt;getContext(), SrcWidth);</span></CodeLine>
<Link id="l00302" /><CodeLine lineNumber="302"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/nvptx/ptxldstinstcode/#a91119cbee2be000c528a690252aee07ca09c68d67f7dbfa6cc77eaf73aa535217">Scalar</a> = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateBitCast(Scalar, SrcIntTy);</span></CodeLine>
<Link id="l00303" /><CodeLine lineNumber="303"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00304" /><CodeLine lineNumber="304"></CodeLine>
<Link id="l00305" /><CodeLine lineNumber="305"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ShAmt) &#123;</span></CodeLine>
<Link id="l00306" /><CodeLine lineNumber="306"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Bail out if we could end with more instructions than we started with.</span></CodeLine>
<Link id="l00307" /><CodeLine lineNumber="307"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/mipsisd/#a422daf9aa810935178671306b651d69ba88a797f57846adb2c382b3732b471913">Ext</a>.getVectorOperand()-&gt;hasOneUse())</span></CodeLine>
<Link id="l00308" /><CodeLine lineNumber="308"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00309" /><CodeLine lineNumber="309"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/nvptx/ptxldstinstcode/#a91119cbee2be000c528a690252aee07ca09c68d67f7dbfa6cc77eaf73aa535217">Scalar</a> = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateLShr(Scalar, ShAmt);</span></CodeLine>
<Link id="l00310" /><CodeLine lineNumber="310"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00311" /><CodeLine lineNumber="311"></CodeLine>
<Link id="l00312" /><CodeLine lineNumber="312"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NeedDestBitcast) &#123;</span></CodeLine>
<Link id="l00313" /><CodeLine lineNumber="313"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/demangle/itaniumdemangle-h/#a88ee8e4eea43084bd8964682683da88caa1fa27779242b4902f7ae3bdd5c6d508">Type</a> &#42;DestIntTy = <a href="/docs/api/classes/llvm/type/#acaf8e4c3e40e01e848c1fad5f05b81cd">IntegerType::getIntNTy</a>(<a href="/docs/api/namespaces/llvm/nvptx/ptxldstinstcode/#a91119cbee2be000c528a690252aee07ca09c68d67f7dbfa6cc77eaf73aa535217">Scalar</a>-&gt;getContext(), DestWidth);</span></CodeLine>
<Link id="l00314" /><CodeLine lineNumber="314"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> BitCastInst(<a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateTrunc(Scalar, DestIntTy), DestTy);</span></CodeLine>
<Link id="l00315" /><CodeLine lineNumber="315"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00316" /><CodeLine lineNumber="316"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> TruncInst(Scalar, DestTy);</span></CodeLine>
<Link id="l00317" /><CodeLine lineNumber="317"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00318" /><CodeLine lineNumber="318"></CodeLine>
<Link id="l00319" /><CodeLine lineNumber="319"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00320" /><CodeLine lineNumber="320"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00321" /><CodeLine lineNumber="321"></CodeLine>
<Link id="l00322" /><CodeLine lineNumber="322"><span class="doxyHighlightComment">/// Find elements of V demanded by UserInstr.</span></CodeLine>
<Link id="l00323" /><CodeLine lineNumber="323" lineLink="#aa5aa7648807905cd7b63153812029fe2"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/apint">APInt</a> <a href="#aa5aa7648807905cd7b63153812029fe2">findDemandedEltsBySingleUser</a>(<a href="/docs/api/classes/llvm/value">Value</a> &#42;V, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;UserInstr) &#123;</span></CodeLine>
<Link id="l00324" /><CodeLine lineNumber="324"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> VWidth = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(V-&gt;getType())-&gt;getNumElements();</span></CodeLine>
<Link id="l00325" /><CodeLine lineNumber="325"></CodeLine>
<Link id="l00326" /><CodeLine lineNumber="326"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Conservatively assume that all elements are needed.</span></CodeLine>
<Link id="l00327" /><CodeLine lineNumber="327"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/apint">APInt</a> UsedElts(<a href="/docs/api/classes/llvm/apint/#a071e8d814b2b30b02544fad964227b8e">APInt::getAllOnes</a>(VWidth));</span></CodeLine>
<Link id="l00328" /><CodeLine lineNumber="328"></CodeLine>
<Link id="l00329" /><CodeLine lineNumber="329"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (UserInstr-&gt;<a href="/docs/api/classes/llvm/instruction/#ab4e05d690df389b8b1477c90387b575f">getOpcode</a>()) &#123;</span></CodeLine>
<Link id="l00330" /><CodeLine lineNumber="330"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::ExtractElement: &#123;</span></CodeLine>
<Link id="l00331" /><CodeLine lineNumber="331"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/extractelementinst">ExtractElementInst</a> &#42;EEI = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;ExtractElementInst&gt;</a>(UserInstr);</span></CodeLine>
<Link id="l00332" /><CodeLine lineNumber="332"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(EEI-&gt;<a href="/docs/api/classes/llvm/extractelementinst/#ab140abba7cc496d52d482be53d14ed6a">getVectorOperand</a>() == V);</span></CodeLine>
<Link id="l00333" /><CodeLine lineNumber="333"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;EEIIndexC = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ConstantInt&gt;</a>(EEI-&gt;<a href="/docs/api/classes/llvm/extractelementinst/#aba9478635b356d769c5f10f92515d24b">getIndexOperand</a>());</span></CodeLine>
<Link id="l00334" /><CodeLine lineNumber="334"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (EEIIndexC &amp;&amp; EEIIndexC-&gt;<a href="/docs/api/classes/llvm/constantint/#af7e1934ed72a405ef073ea5f9bbe828e">getValue</a>().<a href="/docs/api/classes/llvm/apint/#a545e8d5dfa1688acea0d0e275b03682f">ult</a>(VWidth)) &#123;</span></CodeLine>
<Link id="l00335" /><CodeLine lineNumber="335"><span class="doxyHighlight">      UsedElts = <a href="/docs/api/classes/llvm/apint/#aec662ee6ab1490a4cabebf2812e5b9ca">APInt::getOneBitSet</a>(VWidth, EEIIndexC-&gt;<a href="/docs/api/classes/llvm/constantint/#ac09a21c371a9c535cbc13e8f82503aec">getZExtValue</a>());</span></CodeLine>
<Link id="l00336" /><CodeLine lineNumber="336"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00337" /><CodeLine lineNumber="337"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00338" /><CodeLine lineNumber="338"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00339" /><CodeLine lineNumber="339"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::ShuffleVector: &#123;</span></CodeLine>
<Link id="l00340" /><CodeLine lineNumber="340"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &#42;Shuffle = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;ShuffleVectorInst&gt;</a>(UserInstr);</span></CodeLine>
<Link id="l00341" /><CodeLine lineNumber="341"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> MaskNumElts =</span></CodeLine>
<Link id="l00342" /><CodeLine lineNumber="342"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(UserInstr-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>())-&gt;getNumElements();</span></CodeLine>
<Link id="l00343" /><CodeLine lineNumber="343"></CodeLine>
<Link id="l00344" /><CodeLine lineNumber="344"><span class="doxyHighlight">    UsedElts = <a href="/docs/api/classes/llvm/apint">APInt</a>(VWidth, 0);</span></CodeLine>
<Link id="l00345" /><CodeLine lineNumber="345"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> i = 0; i &lt; MaskNumElts; i++) &#123;</span></CodeLine>
<Link id="l00346" /><CodeLine lineNumber="346"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> MaskVal = Shuffle-&gt;<a href="/docs/api/classes/llvm/shufflevectorinst/#a3fb8619f70f51242f81ef96da349c884">getMaskValue</a>(i);</span></CodeLine>
<Link id="l00347" /><CodeLine lineNumber="347"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (MaskVal == -1u || MaskVal &gt;= 2 &#42; VWidth)</span></CodeLine>
<Link id="l00348" /><CodeLine lineNumber="348"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00349" /><CodeLine lineNumber="349"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Shuffle-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0) == V &amp;&amp; (MaskVal &lt; VWidth))</span></CodeLine>
<Link id="l00350" /><CodeLine lineNumber="350"><span class="doxyHighlight">        UsedElts.<a href="/docs/api/classes/llvm/apint/#a33f9f862dca8ee0f23bff5941bf433d8">setBit</a>(MaskVal);</span></CodeLine>
<Link id="l00351" /><CodeLine lineNumber="351"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Shuffle-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1) == V &amp;&amp;</span></CodeLine>
<Link id="l00352" /><CodeLine lineNumber="352"><span class="doxyHighlight">          ((MaskVal &gt;= VWidth) &amp;&amp; (MaskVal &lt; 2 &#42; VWidth)))</span></CodeLine>
<Link id="l00353" /><CodeLine lineNumber="353"><span class="doxyHighlight">        UsedElts.<a href="/docs/api/classes/llvm/apint/#a33f9f862dca8ee0f23bff5941bf433d8">setBit</a>(MaskVal - VWidth);</span></CodeLine>
<Link id="l00354" /><CodeLine lineNumber="354"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00355" /><CodeLine lineNumber="355"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00356" /><CodeLine lineNumber="356"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00357" /><CodeLine lineNumber="357"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">default</span><span class="doxyHighlight">:</span></CodeLine>
<Link id="l00358" /><CodeLine lineNumber="358"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00359" /><CodeLine lineNumber="359"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00360" /><CodeLine lineNumber="360"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> UsedElts;</span></CodeLine>
<Link id="l00361" /><CodeLine lineNumber="361"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00362" /><CodeLine lineNumber="362"></CodeLine>
<Link id="l00363" /><CodeLine lineNumber="363"><span class="doxyHighlightComment">/// Find union of elements of V demanded by all its users.</span></CodeLine>
<Link id="l00364" /><CodeLine lineNumber="364"><span class="doxyHighlightComment">/// If it is known by querying findDemandedEltsBySingleUser that</span></CodeLine>
<Link id="l00365" /><CodeLine lineNumber="365"><span class="doxyHighlightComment">/// no user demands an element of V, then the corresponding bit</span></CodeLine>
<Link id="l00366" /><CodeLine lineNumber="366"><span class="doxyHighlightComment">/// remains unset in the returned value.</span></CodeLine>
<Link id="l00367" /><CodeLine lineNumber="367" lineLink="#a1e71f36e9936f126265e383fd67440f7"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/apint">APInt</a> <a href="#a1e71f36e9936f126265e383fd67440f7">findDemandedEltsByAllUsers</a>(<a href="/docs/api/classes/llvm/value">Value</a> &#42;V) &#123;</span></CodeLine>
<Link id="l00368" /><CodeLine lineNumber="368"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> VWidth = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(V-&gt;getType())-&gt;getNumElements();</span></CodeLine>
<Link id="l00369" /><CodeLine lineNumber="369"></CodeLine>
<Link id="l00370" /><CodeLine lineNumber="370"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/apint">APInt</a> UnionUsedElts(VWidth, 0);</span></CodeLine>
<Link id="l00371" /><CodeLine lineNumber="371"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/use">Use</a> &amp;U : V-&gt;<a href="/docs/api/classes/llvm/value/#abf855b7cd63a0cd7f73759e396f280c9">uses</a>()) &#123;</span></CodeLine>
<Link id="l00372" /><CodeLine lineNumber="372"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(U.getUser())) &#123;</span></CodeLine>
<Link id="l00373" /><CodeLine lineNumber="373"><span class="doxyHighlight">      UnionUsedElts |= <a href="#aa5aa7648807905cd7b63153812029fe2">findDemandedEltsBySingleUser</a>(V, <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</span></CodeLine>
<Link id="l00374" /><CodeLine lineNumber="374"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00375" /><CodeLine lineNumber="375"><span class="doxyHighlight">      UnionUsedElts = <a href="/docs/api/classes/llvm/apint/#a071e8d814b2b30b02544fad964227b8e">APInt::getAllOnes</a>(VWidth);</span></CodeLine>
<Link id="l00376" /><CodeLine lineNumber="376"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00377" /><CodeLine lineNumber="377"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00378" /><CodeLine lineNumber="378"></CodeLine>
<Link id="l00379" /><CodeLine lineNumber="379"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (UnionUsedElts.<a href="/docs/api/classes/llvm/apint/#a423e2c491de1408d54e35f0b47d076be">isAllOnes</a>())</span></CodeLine>
<Link id="l00380" /><CodeLine lineNumber="380"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00381" /><CodeLine lineNumber="381"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00382" /><CodeLine lineNumber="382"></CodeLine>
<Link id="l00383" /><CodeLine lineNumber="383"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> UnionUsedElts;</span></CodeLine>
<Link id="l00384" /><CodeLine lineNumber="384"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00385" /><CodeLine lineNumber="385"></CodeLine>
<Link id="l00386" /><CodeLine lineNumber="386"><span class="doxyHighlightComment">/// Given a constant index for a extractelement or insertelement instruction,</span></CodeLine>
<Link id="l00387" /><CodeLine lineNumber="387"><span class="doxyHighlightComment">/// return it with the canonical type if it isn&#39;t already canonical.  We</span></CodeLine>
<Link id="l00388" /><CodeLine lineNumber="388"><span class="doxyHighlightComment">/// arbitrarily pick 64 bit as our canonical type.  The actual bitwidth doesn&#39;t</span></CodeLine>
<Link id="l00389" /><CodeLine lineNumber="389"><span class="doxyHighlightComment">/// matter, we just want a consistent type to simplify CSE.</span></CodeLine>
<Link id="l00390" /><CodeLine lineNumber="390" lineLink="#ae67d970cf80e86c5789e52f9d57d0c70"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;<a href="#ae67d970cf80e86c5789e52f9d57d0c70">getPreferredVectorIndex</a>(<a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;IndexC) &#123;</span></CodeLine>
<Link id="l00391" /><CodeLine lineNumber="391"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> IndexBW = IndexC-&gt;<a href="/docs/api/classes/llvm/constantint/#ab240d0d30dfa9b392ef9d813f3f9e4be">getBitWidth</a>();</span></CodeLine>
<Link id="l00392" /><CodeLine lineNumber="392"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IndexBW == 64 || IndexC-&gt;<a href="/docs/api/classes/llvm/constantint/#af7e1934ed72a405ef073ea5f9bbe828e">getValue</a>().<a href="/docs/api/classes/llvm/apint/#a3015474e70e59c0a3ed4f9f0e8644b75">getActiveBits</a>() &gt; 64)</span></CodeLine>
<Link id="l00393" /><CodeLine lineNumber="393"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00394" /><CodeLine lineNumber="394"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> ConstantInt::get(IndexC-&gt;<a href="/docs/api/classes/llvm/value/#ab3fc0225d8aaf8434026c3573f961f2c">getContext</a>(),</span></CodeLine>
<Link id="l00395" /><CodeLine lineNumber="395"><span class="doxyHighlight">                          IndexC-&gt;<a href="/docs/api/classes/llvm/constantint/#af7e1934ed72a405ef073ea5f9bbe828e">getValue</a>().<a href="/docs/api/classes/llvm/apint/#a2ed912a28808268e35bd58e8f11251aa">zextOrTrunc</a>(64));</span></CodeLine>
<Link id="l00396" /><CodeLine lineNumber="396"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00397" /><CodeLine lineNumber="397"></CodeLine>
<Link id="l00398" /><CodeLine lineNumber="398" lineLink="/docs/api/classes/llvm/instcombinerimpl/#a71ef354bd1ea9e02d70146d7218a7d39"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/classes/llvm/instcombinerimpl/#a71ef354bd1ea9e02d70146d7218a7d39">InstCombinerImpl::visitExtractElementInst</a>(<a href="/docs/api/classes/llvm/extractelementinst">ExtractElementInst</a> &amp;EI) &#123;</span></CodeLine>
<Link id="l00399" /><CodeLine lineNumber="399"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;SrcVec = EI.<a href="/docs/api/classes/llvm/extractelementinst/#ab140abba7cc496d52d482be53d14ed6a">getVectorOperand</a>();</span></CodeLine>
<Link id="l00400" /><CodeLine lineNumber="400"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;Index = EI.<a href="/docs/api/classes/llvm/extractelementinst/#aba9478635b356d769c5f10f92515d24b">getIndexOperand</a>();</span></CodeLine>
<Link id="l00401" /><CodeLine lineNumber="401"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/value">Value</a> &#42;V = <a href="/docs/api/namespaces/llvm/#aee89448981f9fbc0d97fe68f354a8e82">simplifyExtractElementInst</a>(SrcVec, Index,</span></CodeLine>
<Link id="l00402" /><CodeLine lineNumber="402"><span class="doxyHighlight">                                            <a href="/docs/api/classes/llvm/instcombiner/#a067e49eb19f14e50f84cf4b4e7f6acde">SQ</a>.getWithInstruction(&amp;EI)))</span></CodeLine>
<Link id="l00403" /><CodeLine lineNumber="403"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instcombiner/#a49f1bd0bdf0ef741bdd714cc1188d7c5">replaceInstUsesWith</a>(EI, V);</span></CodeLine>
<Link id="l00404" /><CodeLine lineNumber="404"></CodeLine>
<Link id="l00405" /><CodeLine lineNumber="405"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// extractelt (select %x, %vec1, %vec2), %const -&gt;</span></CodeLine>
<Link id="l00406" /><CodeLine lineNumber="406"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// select %x, %vec1&#91;%const&#93;, %vec2&#91;%const&#93;</span></CodeLine>
<Link id="l00407" /><CodeLine lineNumber="407"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: Support constant folding of multiple select operands:</span></CodeLine>
<Link id="l00408" /><CodeLine lineNumber="408"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// extractelt (select %x, %vec1, %vec2), (select %x, %c1, %c2)</span></CodeLine>
<Link id="l00409" /><CodeLine lineNumber="409"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the extractelement will for instance try to do out of bounds accesses</span></CodeLine>
<Link id="l00410" /><CodeLine lineNumber="410"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// because of the values of %c1 and/or %c2, the sequence could be optimized</span></CodeLine>
<Link id="l00411" /><CodeLine lineNumber="411"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// early. This is currently not possible because constant folding will reach</span></CodeLine>
<Link id="l00412" /><CodeLine lineNumber="412"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// an unreachable assertion if it doesn&#39;t find a constant operand.</span></CodeLine>
<Link id="l00413" /><CodeLine lineNumber="413"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/selectinst">SelectInst</a> &#42;<a href="/docs/api/namespaces/llvm/si">SI</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;SelectInst&gt;</a>(EI.<a href="/docs/api/classes/llvm/extractelementinst/#ab140abba7cc496d52d482be53d14ed6a">getVectorOperand</a>()))</span></CodeLine>
<Link id="l00414" /><CodeLine lineNumber="414"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getCondition()-&gt;getType()-&gt;isIntegerTy() &amp;&amp;</span></CodeLine>
<Link id="l00415" /><CodeLine lineNumber="415"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;Constant&gt;</a>(EI.<a href="/docs/api/classes/llvm/extractelementinst/#aba9478635b356d769c5f10f92515d24b">getIndexOperand</a>()))</span></CodeLine>
<Link id="l00416" /><CodeLine lineNumber="416"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;R = <a href="/docs/api/classes/llvm/instcombinerimpl/#a039111728e11b1cdf25e60446ae17f2a">FoldOpIntoSelect</a>(EI, <a href="/docs/api/namespaces/llvm/si">SI</a>))</span></CodeLine>
<Link id="l00417" /><CodeLine lineNumber="417"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> R;</span></CodeLine>
<Link id="l00418" /><CodeLine lineNumber="418"></CodeLine>
<Link id="l00419" /><CodeLine lineNumber="419"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If extracting a specified index from the vector, see if we can recursively</span></CodeLine>
<Link id="l00420" /><CodeLine lineNumber="420"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// find a previously computed scalar that was inserted into the vector.</span></CodeLine>
<Link id="l00421" /><CodeLine lineNumber="421"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;IndexC = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ConstantInt&gt;</a>(Index);</span></CodeLine>
<Link id="l00422" /><CodeLine lineNumber="422"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> HasKnownValidIndex = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00423" /><CodeLine lineNumber="423"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IndexC) &#123;</span></CodeLine>
<Link id="l00424" /><CodeLine lineNumber="424"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Canonicalize type of constant indices to i64 to simplify CSE</span></CodeLine>
<Link id="l00425" /><CodeLine lineNumber="425"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewIdx = <a href="#ae67d970cf80e86c5789e52f9d57d0c70">getPreferredVectorIndex</a>(IndexC))</span></CodeLine>
<Link id="l00426" /><CodeLine lineNumber="426"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instcombiner/#ac2a56636a6f3742f5e495f67e67b6b36">replaceOperand</a>(EI, 1, NewIdx);</span></CodeLine>
<Link id="l00427" /><CodeLine lineNumber="427"></CodeLine>
<Link id="l00428" /><CodeLine lineNumber="428"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/elementcount">ElementCount</a> EC = EI.<a href="/docs/api/classes/llvm/extractelementinst/#acac09986a48f1f758f882cc7ba780c08">getVectorOperandType</a>()-&gt;<a href="/docs/api/classes/llvm/vectortype/#a59632c5deb0423a518ad984bdd04d41f">getElementCount</a>();</span></CodeLine>
<Link id="l00429" /><CodeLine lineNumber="429"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumElts = EC.getKnownMinValue();</span></CodeLine>
<Link id="l00430" /><CodeLine lineNumber="430"><span class="doxyHighlight">    HasKnownValidIndex = IndexC-&gt;getValue().ult(NumElts);</span></CodeLine>
<Link id="l00431" /><CodeLine lineNumber="431"></CodeLine>
<Link id="l00432" /><CodeLine lineNumber="432"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/intrinsicinst">IntrinsicInst</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;IntrinsicInst&gt;</a>(SrcVec)) &#123;</span></CodeLine>
<Link id="l00433" /><CodeLine lineNumber="433"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/intrinsic/#a80add6b3b1cdaec560907995127adc16">Intrinsic::ID</a> IID = <a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a>-&gt;getIntrinsicID();</span></CodeLine>
<Link id="l00434" /><CodeLine lineNumber="434"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Index needs to be lower than the minimum size of the vector, because</span></CodeLine>
<Link id="l00435" /><CodeLine lineNumber="435"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// for scalable vector, the vector size is known at run time.</span></CodeLine>
<Link id="l00436" /><CodeLine lineNumber="436"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IID == Intrinsic::stepvector &amp;&amp; IndexC-&gt;getValue().ult(NumElts)) &#123;</span></CodeLine>
<Link id="l00437" /><CodeLine lineNumber="437"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/type">Type</a> &#42;Ty = EI.<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>();</span></CodeLine>
<Link id="l00438" /><CodeLine lineNumber="438"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/#abee0df5f7f703bb4462aba260ba0a60f">BitWidth</a> = Ty-&gt;getIntegerBitWidth();</span></CodeLine>
<Link id="l00439" /><CodeLine lineNumber="439"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/value">Value</a> &#42;Idx;</span></CodeLine>
<Link id="l00440" /><CodeLine lineNumber="440"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Return index when its value does not exceed the allowed limit</span></CodeLine>
<Link id="l00441" /><CodeLine lineNumber="441"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// for the element type of the vector, otherwise return undefined.</span></CodeLine>
<Link id="l00442" /><CodeLine lineNumber="442"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IndexC-&gt;getValue().getActiveBits() &lt;= <a href="/docs/api/namespaces/llvm/#abee0df5f7f703bb4462aba260ba0a60f">BitWidth</a>)</span></CodeLine>
<Link id="l00443" /><CodeLine lineNumber="443"><span class="doxyHighlight">          Idx = ConstantInt::get(Ty, IndexC-&gt;getValue().zextOrTrunc(<a href="/docs/api/namespaces/llvm/#abee0df5f7f703bb4462aba260ba0a60f">BitWidth</a>));</span></CodeLine>
<Link id="l00444" /><CodeLine lineNumber="444"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00445" /><CodeLine lineNumber="445"><span class="doxyHighlight">          Idx = <a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(Ty);</span></CodeLine>
<Link id="l00446" /><CodeLine lineNumber="446"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instcombiner/#a49f1bd0bdf0ef741bdd714cc1188d7c5">replaceInstUsesWith</a>(EI, Idx);</span></CodeLine>
<Link id="l00447" /><CodeLine lineNumber="447"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00448" /><CodeLine lineNumber="448"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00449" /><CodeLine lineNumber="449"></CodeLine>
<Link id="l00450" /><CodeLine lineNumber="450"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// InstSimplify should handle cases where the index is invalid.</span></CodeLine>
<Link id="l00451" /><CodeLine lineNumber="451"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// For fixed-length vector, it&#39;s invalid to extract out-of-range element.</span></CodeLine>
<Link id="l00452" /><CodeLine lineNumber="452"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!EC.isScalable() &amp;&amp; IndexC-&gt;getValue().uge(NumElts))</span></CodeLine>
<Link id="l00453" /><CodeLine lineNumber="453"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00454" /><CodeLine lineNumber="454"></CodeLine>
<Link id="l00455" /><CodeLine lineNumber="455"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = foldBitcastExtElt(EI))</span></CodeLine>
<Link id="l00456" /><CodeLine lineNumber="456"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l00457" /><CodeLine lineNumber="457"></CodeLine>
<Link id="l00458" /><CodeLine lineNumber="458"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If there&#39;s a vector PHI feeding a scalar use through this extractelement</span></CodeLine>
<Link id="l00459" /><CodeLine lineNumber="459"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// instruction, try to scalarize the PHI.</span></CodeLine>
<Link id="l00460" /><CodeLine lineNumber="460"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Phi = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;PHINode&gt;</a>(SrcVec))</span></CodeLine>
<Link id="l00461" /><CodeLine lineNumber="461"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;ScalarPHI = scalarizePHI(EI, Phi))</span></CodeLine>
<Link id="l00462" /><CodeLine lineNumber="462"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> ScalarPHI;</span></CodeLine>
<Link id="l00463" /><CodeLine lineNumber="463"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00464" /><CodeLine lineNumber="464"></CodeLine>
<Link id="l00465" /><CodeLine lineNumber="465"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO come up with a n-ary matcher that subsumes both unary and</span></CodeLine>
<Link id="l00466" /><CodeLine lineNumber="466"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// binary matchers.</span></CodeLine>
<Link id="l00467" /><CodeLine lineNumber="467"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/unaryoperator">UnaryOperator</a> &#42;UO;</span></CodeLine>
<Link id="l00468" /><CodeLine lineNumber="468"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(SrcVec, <a href="/docs/api/namespaces/llvm/patternmatch/#aa1610c81cbc4ec2f1499140e33de45d5">m&#95;UnOp</a>(UO)) &amp;&amp; <a href="#a89f5f0f536cc9b0bae261737f13786f7">cheapToScalarize</a>(SrcVec, Index)) &#123;</span></CodeLine>
<Link id="l00469" /><CodeLine lineNumber="469"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// extelt (unop X), Index --&gt; unop (extelt X, Index)</span></CodeLine>
<Link id="l00470" /><CodeLine lineNumber="470"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a> = UO-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0);</span></CodeLine>
<Link id="l00471" /><CodeLine lineNumber="471"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;E = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateExtractElement(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, Index);</span></CodeLine>
<Link id="l00472" /><CodeLine lineNumber="472"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/unaryoperator/#a507eb6210c8a0ba429226156e43745a1">UnaryOperator::CreateWithCopiedFlags</a>(UO-&gt;<a href="/docs/api/classes/llvm/unaryoperator/#a7cece7ddf076c1dccc81f743e3b7bd36">getOpcode</a>(), E, UO);</span></CodeLine>
<Link id="l00473" /><CodeLine lineNumber="473"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00474" /><CodeLine lineNumber="474"></CodeLine>
<Link id="l00475" /><CodeLine lineNumber="475"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the binop is not speculatable, we cannot hoist the extractelement if</span></CodeLine>
<Link id="l00476" /><CodeLine lineNumber="476"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// it may make the operand poison.</span></CodeLine>
<Link id="l00477" /><CodeLine lineNumber="477"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/binaryoperator">BinaryOperator</a> &#42;BO;</span></CodeLine>
<Link id="l00478" /><CodeLine lineNumber="478"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(SrcVec, <a href="/docs/api/namespaces/llvm/patternmatch/#a0698afabe907d2d3b87889d2e0349d47">m&#95;BinOp</a>(BO)) &amp;&amp; <a href="#a89f5f0f536cc9b0bae261737f13786f7">cheapToScalarize</a>(SrcVec, Index) &amp;&amp;</span></CodeLine>
<Link id="l00479" /><CodeLine lineNumber="479"><span class="doxyHighlight">      (HasKnownValidIndex ||</span></CodeLine>
<Link id="l00480" /><CodeLine lineNumber="480"><span class="doxyHighlight">       <a href="/docs/api/namespaces/llvm/#a19ebaad52d11be3121c2bfcbd0f30193">isSafeToSpeculativelyExecuteWithVariableReplaced</a>(BO))) &#123;</span></CodeLine>
<Link id="l00481" /><CodeLine lineNumber="481"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// extelt (binop X, Y), Index --&gt; binop (extelt X, Index), (extelt Y, Index)</span></CodeLine>
<Link id="l00482" /><CodeLine lineNumber="482"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a> = BO-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0), &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a> = BO-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1);</span></CodeLine>
<Link id="l00483" /><CodeLine lineNumber="483"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;E0 = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateExtractElement(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, Index);</span></CodeLine>
<Link id="l00484" /><CodeLine lineNumber="484"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;E1 = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateExtractElement(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>, Index);</span></CodeLine>
<Link id="l00485" /><CodeLine lineNumber="485"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/binaryoperator/#ac80f39cdc458ec63d7ff5f7490498230">BinaryOperator::CreateWithCopiedFlags</a>(BO-&gt;<a href="/docs/api/classes/llvm/binaryoperator/#a31bf07f3f61525486633bc1d0bbaf029">getOpcode</a>(), E0, E1, BO);</span></CodeLine>
<Link id="l00486" /><CodeLine lineNumber="486"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00487" /><CodeLine lineNumber="487"></CodeLine>
<Link id="l00488" /><CodeLine lineNumber="488"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>;</span></CodeLine>
<Link id="l00489" /><CodeLine lineNumber="489"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/cmppredicate">CmpPredicate</a> Pred;</span></CodeLine>
<Link id="l00490" /><CodeLine lineNumber="490"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(SrcVec, <a href="/docs/api/namespaces/llvm/patternmatch/#a7d9ab823fe85606fa795c0c6fc75aca6">m&#95;Cmp</a>(Pred, <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>))) &amp;&amp;</span></CodeLine>
<Link id="l00491" /><CodeLine lineNumber="491"><span class="doxyHighlight">      <a href="#a89f5f0f536cc9b0bae261737f13786f7">cheapToScalarize</a>(SrcVec, Index)) &#123;</span></CodeLine>
<Link id="l00492" /><CodeLine lineNumber="492"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// extelt (cmp X, Y), Index --&gt; cmp (extelt X, Index), (extelt Y, Index)</span></CodeLine>
<Link id="l00493" /><CodeLine lineNumber="493"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;E0 = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateExtractElement(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, Index);</span></CodeLine>
<Link id="l00494" /><CodeLine lineNumber="494"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;E1 = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateExtractElement(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>, Index);</span></CodeLine>
<Link id="l00495" /><CodeLine lineNumber="495"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/cmpinst">CmpInst</a> &#42;SrcCmpInst = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CmpInst&gt;</a>(SrcVec);</span></CodeLine>
<Link id="l00496" /><CodeLine lineNumber="496"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cmpinst/#a6d0ee639690d0fa59e6c9e0af5adc5c2">CmpInst::CreateWithCopiedFlags</a>(SrcCmpInst-&gt;<a href="/docs/api/classes/llvm/cmpinst/#af4abe8e5b55577f35032131a6264fe4f">getOpcode</a>(), Pred, E0, E1,</span></CodeLine>
<Link id="l00497" /><CodeLine lineNumber="497"><span class="doxyHighlight">                                          SrcCmpInst);</span></CodeLine>
<Link id="l00498" /><CodeLine lineNumber="498"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00499" /><CodeLine lineNumber="499"></CodeLine>
<Link id="l00500" /><CodeLine lineNumber="500"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(SrcVec)) &#123;</span></CodeLine>
<Link id="l00501" /><CodeLine lineNumber="501"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;IE = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;InsertElementInst&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) &#123;</span></CodeLine>
<Link id="l00502" /><CodeLine lineNumber="502"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// instsimplify already handled the case where the indices are constants</span></CodeLine>
<Link id="l00503" /><CodeLine lineNumber="503"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// and equal by value, if both are constants, they must not be the same</span></CodeLine>
<Link id="l00504" /><CodeLine lineNumber="504"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// value, extract from the pre-inserted value instead.</span></CodeLine>
<Link id="l00505" /><CodeLine lineNumber="505"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;Constant&gt;</a>(IE-&gt;getOperand(2)) &amp;&amp; IndexC)</span></CodeLine>
<Link id="l00506" /><CodeLine lineNumber="506"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instcombiner/#ac2a56636a6f3742f5e495f67e67b6b36">replaceOperand</a>(EI, 0, IE-&gt;getOperand(0));</span></CodeLine>
<Link id="l00507" /><CodeLine lineNumber="507"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncommongep-cpp/#ad532e8710e50302e0a376b61c91fa91d">GEP</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;GetElementPtrInst&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) &#123;</span></CodeLine>
<Link id="l00508" /><CodeLine lineNumber="508"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;VecType = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;VectorType&gt;</a>(<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncommongep-cpp/#ad532e8710e50302e0a376b61c91fa91d">GEP</a>-&gt;getType());</span></CodeLine>
<Link id="l00509" /><CodeLine lineNumber="509"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/elementcount">ElementCount</a> EC = VecType-&gt;getElementCount();</span></CodeLine>
<Link id="l00510" /><CodeLine lineNumber="510"><span class="doxyHighlight">      uint64&#95;t IdxVal = IndexC ? IndexC-&gt;getZExtValue() : 0;</span></CodeLine>
<Link id="l00511" /><CodeLine lineNumber="511"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IndexC &amp;&amp; IdxVal &lt; EC.getKnownMinValue() &amp;&amp; <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncommongep-cpp/#ad532e8710e50302e0a376b61c91fa91d">GEP</a>-&gt;hasOneUse()) &#123;</span></CodeLine>
<Link id="l00512" /><CodeLine lineNumber="512"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Find out why we have a vector result - these are a few examples:</span></CodeLine>
<Link id="l00513" /><CodeLine lineNumber="513"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">//  1 We have a scalar pointer and a vector of indices, or</span></CodeLine>
<Link id="l00514" /><CodeLine lineNumber="514"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">//  2 We have a vector of pointers and a scalar index, or</span></CodeLine>
<Link id="l00515" /><CodeLine lineNumber="515"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">//  3 We have a vector of pointers and a vector of indices, etc.</span></CodeLine>
<Link id="l00516" /><CodeLine lineNumber="516"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Here we only consider combining when there is exactly one vector</span></CodeLine>
<Link id="l00517" /><CodeLine lineNumber="517"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// operand, since the optimization is less obviously a win due to</span></CodeLine>
<Link id="l00518" /><CodeLine lineNumber="518"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// needing more than one extractelements.</span></CodeLine>
<Link id="l00519" /><CodeLine lineNumber="519"></CodeLine>
<Link id="l00520" /><CodeLine lineNumber="520"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> VectorOps =</span></CodeLine>
<Link id="l00521" /><CodeLine lineNumber="521"><span class="doxyHighlight">            <a href="/docs/api/namespaces/llvm/#ac214df91cdc242f4710ea5a93939c678">llvm::count&#95;if</a>(<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncommongep-cpp/#ad532e8710e50302e0a376b61c91fa91d">GEP</a>-&gt;operands(), &#91;&#93;(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/value">Value</a> &#42;V) &#123;</span></CodeLine>
<Link id="l00522" /><CodeLine lineNumber="522"><span class="doxyHighlight">              return isa&lt;VectorType&gt;(V-&gt;getType());</span></CodeLine>
<Link id="l00523" /><CodeLine lineNumber="523"><span class="doxyHighlight">            &#125;);</span></CodeLine>
<Link id="l00524" /><CodeLine lineNumber="524"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (VectorOps == 1) &#123;</span></CodeLine>
<Link id="l00525" /><CodeLine lineNumber="525"><span class="doxyHighlight">          <a href="/docs/api/classes/llvm/value">Value</a> &#42;NewPtr = <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncommongep-cpp/#ad532e8710e50302e0a376b61c91fa91d">GEP</a>-&gt;getPointerOperand();</span></CodeLine>
<Link id="l00526" /><CodeLine lineNumber="526"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;VectorType&gt;</a>(NewPtr-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>()))</span></CodeLine>
<Link id="l00527" /><CodeLine lineNumber="527"><span class="doxyHighlight">            NewPtr = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateExtractElement(NewPtr, IndexC);</span></CodeLine>
<Link id="l00528" /><CodeLine lineNumber="528"></CodeLine>
<Link id="l00529" /><CodeLine lineNumber="529"><span class="doxyHighlight">          <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Value &#42;&gt;</a> NewOps;</span></CodeLine>
<Link id="l00530" /><CodeLine lineNumber="530"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = 1; <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> != <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncommongep-cpp/#ad532e8710e50302e0a376b61c91fa91d">GEP</a>-&gt;getNumOperands(); ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &#123;</span></CodeLine>
<Link id="l00531" /><CodeLine lineNumber="531"><span class="doxyHighlight">            <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a> = <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncommongep-cpp/#ad532e8710e50302e0a376b61c91fa91d">GEP</a>-&gt;getOperand(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</span></CodeLine>
<Link id="l00532" /><CodeLine lineNumber="532"><span class="doxyHighlight">            </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;VectorType&gt;</a>(<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>-&gt;getType()))</span></CodeLine>
<Link id="l00533" /><CodeLine lineNumber="533"><span class="doxyHighlight">              NewOps.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(<a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateExtractElement(<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>, IndexC));</span></CodeLine>
<Link id="l00534" /><CodeLine lineNumber="534"><span class="doxyHighlight">            </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00535" /><CodeLine lineNumber="535"><span class="doxyHighlight">              NewOps.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>);</span></CodeLine>
<Link id="l00536" /><CodeLine lineNumber="536"><span class="doxyHighlight">          &#125;</span></CodeLine>
<Link id="l00537" /><CodeLine lineNumber="537"></CodeLine>
<Link id="l00538" /><CodeLine lineNumber="538"><span class="doxyHighlight">          <a href="/docs/api/classes/llvm/getelementptrinst">GetElementPtrInst</a> &#42;NewGEP = <a href="/docs/api/classes/llvm/getelementptrinst/#a7e5d474f9fda4b2b2e5de3dcfefcc472">GetElementPtrInst::Create</a>(</span></CodeLine>
<Link id="l00539" /><CodeLine lineNumber="539"><span class="doxyHighlight">              <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncommongep-cpp/#ad532e8710e50302e0a376b61c91fa91d">GEP</a>-&gt;getSourceElementType(), NewPtr, NewOps);</span></CodeLine>
<Link id="l00540" /><CodeLine lineNumber="540"><span class="doxyHighlight">          NewGEP-&gt;<a href="/docs/api/classes/llvm/getelementptrinst/#a837e9f272fd070a5f8fc79c07a951106">setIsInBounds</a>(<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncommongep-cpp/#ad532e8710e50302e0a376b61c91fa91d">GEP</a>-&gt;isInBounds());</span></CodeLine>
<Link id="l00541" /><CodeLine lineNumber="541"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> NewGEP;</span></CodeLine>
<Link id="l00542" /><CodeLine lineNumber="542"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l00543" /><CodeLine lineNumber="543"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00544" /><CodeLine lineNumber="544"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;SVI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ShuffleVectorInst&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) &#123;</span></CodeLine>
<Link id="l00545" /><CodeLine lineNumber="545"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If this is extracting an element from a shufflevector, figure out where</span></CodeLine>
<Link id="l00546" /><CodeLine lineNumber="546"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// it came from and extract from the appropriate input element instead.</span></CodeLine>
<Link id="l00547" /><CodeLine lineNumber="547"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Restrict the following transformation to fixed-length vector.</span></CodeLine>
<Link id="l00548" /><CodeLine lineNumber="548"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;FixedVectorType&gt;</a>(SVI-&gt;getType()) &amp;&amp; <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;ConstantInt&gt;</a>(Index)) &#123;</span></CodeLine>
<Link id="l00549" /><CodeLine lineNumber="549"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> SrcIdx =</span></CodeLine>
<Link id="l00550" /><CodeLine lineNumber="550"><span class="doxyHighlight">            SVI-&gt;getMaskValue(<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;ConstantInt&gt;</a>(Index)-&gt;getZExtValue());</span></CodeLine>
<Link id="l00551" /><CodeLine lineNumber="551"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/value">Value</a> &#42;Src;</span></CodeLine>
<Link id="l00552" /><CodeLine lineNumber="552"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> LHSWidth = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(SVI-&gt;getOperand(0)-&gt;getType())</span></CodeLine>
<Link id="l00553" /><CodeLine lineNumber="553"><span class="doxyHighlight">                                -&gt;getNumElements();</span></CodeLine>
<Link id="l00554" /><CodeLine lineNumber="554"></CodeLine>
<Link id="l00555" /><CodeLine lineNumber="555"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SrcIdx &lt; 0)</span></CodeLine>
<Link id="l00556" /><CodeLine lineNumber="556"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instcombiner/#a49f1bd0bdf0ef741bdd714cc1188d7c5">replaceInstUsesWith</a>(EI, <a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(EI.<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>()));</span></CodeLine>
<Link id="l00557" /><CodeLine lineNumber="557"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SrcIdx &lt; (</span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight">)LHSWidth)</span></CodeLine>
<Link id="l00558" /><CodeLine lineNumber="558"><span class="doxyHighlight">          Src = SVI-&gt;getOperand(0);</span></CodeLine>
<Link id="l00559" /><CodeLine lineNumber="559"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00560" /><CodeLine lineNumber="560"><span class="doxyHighlight">          SrcIdx -= LHSWidth;</span></CodeLine>
<Link id="l00561" /><CodeLine lineNumber="561"><span class="doxyHighlight">          Src = SVI-&gt;getOperand(1);</span></CodeLine>
<Link id="l00562" /><CodeLine lineNumber="562"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l00563" /><CodeLine lineNumber="563"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/type">Type</a> &#42;Int64Ty = <a href="/docs/api/classes/llvm/type/#a05186fa23e4d11b9855a9599ba87a4b7">Type::getInt64Ty</a>(EI.<a href="/docs/api/classes/llvm/value/#ab3fc0225d8aaf8434026c3573f961f2c">getContext</a>());</span></CodeLine>
<Link id="l00564" /><CodeLine lineNumber="564"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/extractelementinst/#a686bd809f72a2701d97b1bbd17f7db9f">ExtractElementInst::Create</a>(</span></CodeLine>
<Link id="l00565" /><CodeLine lineNumber="565"><span class="doxyHighlight">            Src, ConstantInt::get(Int64Ty, SrcIdx, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">));</span></CodeLine>
<Link id="l00566" /><CodeLine lineNumber="566"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00567" /><CodeLine lineNumber="567"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CastInst&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) &#123;</span></CodeLine>
<Link id="l00568" /><CodeLine lineNumber="568"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Canonicalize extractelement(cast) -&gt; cast(extractelement).</span></CodeLine>
<Link id="l00569" /><CodeLine lineNumber="569"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Bitcasts can change the number of vector elements, and they cost</span></CodeLine>
<Link id="l00570" /><CodeLine lineNumber="570"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// nothing.</span></CodeLine>
<Link id="l00571" /><CodeLine lineNumber="571"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CI-&gt;hasOneUse() &amp;&amp; (CI-&gt;getOpcode() != Instruction::BitCast)) &#123;</span></CodeLine>
<Link id="l00572" /><CodeLine lineNumber="572"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/value">Value</a> &#42;EE = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateExtractElement(CI-&gt;getOperand(0), Index);</span></CodeLine>
<Link id="l00573" /><CodeLine lineNumber="573"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/castinst/#ad2e0ab6d7096fe67a2216fe349044387">CastInst::Create</a>(CI-&gt;getOpcode(), EE, EI.<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>());</span></CodeLine>
<Link id="l00574" /><CodeLine lineNumber="574"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00575" /><CodeLine lineNumber="575"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00576" /><CodeLine lineNumber="576"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00577" /><CodeLine lineNumber="577"></CodeLine>
<Link id="l00578" /><CodeLine lineNumber="578"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Run demanded elements after other transforms as this can drop flags on</span></CodeLine>
<Link id="l00579" /><CodeLine lineNumber="579"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// binops.  If there&#39;s two paths to the same final result, we prefer the</span></CodeLine>
<Link id="l00580" /><CodeLine lineNumber="580"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// one which doesn&#39;t force us to drop flags.</span></CodeLine>
<Link id="l00581" /><CodeLine lineNumber="581"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IndexC) &#123;</span></CodeLine>
<Link id="l00582" /><CodeLine lineNumber="582"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/elementcount">ElementCount</a> EC = EI.<a href="/docs/api/classes/llvm/extractelementinst/#acac09986a48f1f758f882cc7ba780c08">getVectorOperandType</a>()-&gt;<a href="/docs/api/classes/llvm/vectortype/#a59632c5deb0423a518ad984bdd04d41f">getElementCount</a>();</span></CodeLine>
<Link id="l00583" /><CodeLine lineNumber="583"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumElts = EC.getKnownMinValue();</span></CodeLine>
<Link id="l00584" /><CodeLine lineNumber="584"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// This instruction only demands the single element from the input vector.</span></CodeLine>
<Link id="l00585" /><CodeLine lineNumber="585"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Skip for scalable type, the number of elements is unknown at</span></CodeLine>
<Link id="l00586" /><CodeLine lineNumber="586"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// compile-time.</span></CodeLine>
<Link id="l00587" /><CodeLine lineNumber="587"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!EC.isScalable() &amp;&amp; NumElts != 1) &#123;</span></CodeLine>
<Link id="l00588" /><CodeLine lineNumber="588"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If the input vector has a single use, simplify it based on this use</span></CodeLine>
<Link id="l00589" /><CodeLine lineNumber="589"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// property.</span></CodeLine>
<Link id="l00590" /><CodeLine lineNumber="590"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SrcVec-&gt;<a href="/docs/api/classes/llvm/value/#a3a402430a1bbe70a9282dcb0e0b6a2cd">hasOneUse</a>()) &#123;</span></CodeLine>
<Link id="l00591" /><CodeLine lineNumber="591"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/apint">APInt</a> PoisonElts(NumElts, 0);</span></CodeLine>
<Link id="l00592" /><CodeLine lineNumber="592"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/apint">APInt</a> DemandedElts(NumElts, 0);</span></CodeLine>
<Link id="l00593" /><CodeLine lineNumber="593"><span class="doxyHighlight">        DemandedElts.<a href="/docs/api/classes/llvm/apint/#a33f9f862dca8ee0f23bff5941bf433d8">setBit</a>(IndexC-&gt;getZExtValue());</span></CodeLine>
<Link id="l00594" /><CodeLine lineNumber="594"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/value">Value</a> &#42;V =</span></CodeLine>
<Link id="l00595" /><CodeLine lineNumber="595"><span class="doxyHighlight">                <a href="/docs/api/classes/llvm/instcombinerimpl/#a37cce7aa1875173688e5971c5d6fa9e0">SimplifyDemandedVectorElts</a>(SrcVec, DemandedElts, PoisonElts))</span></CodeLine>
<Link id="l00596" /><CodeLine lineNumber="596"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instcombiner/#ac2a56636a6f3742f5e495f67e67b6b36">replaceOperand</a>(EI, 0, V);</span></CodeLine>
<Link id="l00597" /><CodeLine lineNumber="597"><span class="doxyHighlight">      &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00598" /><CodeLine lineNumber="598"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// If the input vector has multiple uses, simplify it based on a union</span></CodeLine>
<Link id="l00599" /><CodeLine lineNumber="599"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// of all elements used.</span></CodeLine>
<Link id="l00600" /><CodeLine lineNumber="600"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/apint">APInt</a> DemandedElts = <a href="#a1e71f36e9936f126265e383fd67440f7">findDemandedEltsByAllUsers</a>(SrcVec);</span></CodeLine>
<Link id="l00601" /><CodeLine lineNumber="601"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!DemandedElts.<a href="/docs/api/classes/llvm/apint/#a423e2c491de1408d54e35f0b47d076be">isAllOnes</a>()) &#123;</span></CodeLine>
<Link id="l00602" /><CodeLine lineNumber="602"><span class="doxyHighlight">          <a href="/docs/api/classes/llvm/apint">APInt</a> PoisonElts(NumElts, 0);</span></CodeLine>
<Link id="l00603" /><CodeLine lineNumber="603"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/value">Value</a> &#42;V = <a href="/docs/api/classes/llvm/instcombinerimpl/#a37cce7aa1875173688e5971c5d6fa9e0">SimplifyDemandedVectorElts</a>(</span></CodeLine>
<Link id="l00604" /><CodeLine lineNumber="604"><span class="doxyHighlight">                  SrcVec, DemandedElts, PoisonElts, 0 </span><span class="doxyHighlightComment">/&#42; Depth &#42;/</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00605" /><CodeLine lineNumber="605"><span class="doxyHighlight">                  </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight"> </span><span class="doxyHighlightComment">/&#42; AllowMultipleUsers &#42;/</span><span class="doxyHighlight">)) &#123;</span></CodeLine>
<Link id="l00606" /><CodeLine lineNumber="606"><span class="doxyHighlight">            </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (V != SrcVec) &#123;</span></CodeLine>
<Link id="l00607" /><CodeLine lineNumber="607"><span class="doxyHighlight">              <a href="/docs/api/classes/llvm/instcombiner/#a7b93340fbcab35a38a04bf49aa3113a0">Worklist</a>.addValue(SrcVec);</span></CodeLine>
<Link id="l00608" /><CodeLine lineNumber="608"><span class="doxyHighlight">              SrcVec-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(V);</span></CodeLine>
<Link id="l00609" /><CodeLine lineNumber="609"><span class="doxyHighlight">              </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &amp;EI;</span></CodeLine>
<Link id="l00610" /><CodeLine lineNumber="610"><span class="doxyHighlight">            &#125;</span></CodeLine>
<Link id="l00611" /><CodeLine lineNumber="611"><span class="doxyHighlight">          &#125;</span></CodeLine>
<Link id="l00612" /><CodeLine lineNumber="612"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l00613" /><CodeLine lineNumber="613"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00614" /><CodeLine lineNumber="614"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00615" /><CodeLine lineNumber="615"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00616" /><CodeLine lineNumber="616"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00617" /><CodeLine lineNumber="617"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00618" /><CodeLine lineNumber="618"></CodeLine>
<Link id="l00619" /><CodeLine lineNumber="619"><span class="doxyHighlightComment">/// If V is a shuffle of values that ONLY returns elements from either LHS or</span></CodeLine>
<Link id="l00620" /><CodeLine lineNumber="620"><span class="doxyHighlightComment">/// RHS, return the shuffle mask and true. Otherwise, return false.</span></CodeLine>
<Link id="l00621" /><CodeLine lineNumber="621" lineLink="#a0f22159dceed07fd0d5d47915a80dc72"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#a0f22159dceed07fd0d5d47915a80dc72">collectSingleShuffleElements</a>(<a href="/docs/api/classes/llvm/value">Value</a> &#42;V, <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>, <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>,</span></CodeLine>
<Link id="l00622" /><CodeLine lineNumber="622"><span class="doxyHighlight">                                         <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;int&gt;</a> &amp;Mask) &#123;</span></CodeLine>
<Link id="l00623" /><CodeLine lineNumber="623"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>-&gt;getType() == <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>-&gt;getType() &amp;&amp;</span></CodeLine>
<Link id="l00624" /><CodeLine lineNumber="624"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;Invalid CollectSingleShuffleElements&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00625" /><CodeLine lineNumber="625"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumElts = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(V-&gt;getType())-&gt;getNumElements();</span></CodeLine>
<Link id="l00626" /><CodeLine lineNumber="626"></CodeLine>
<Link id="l00627" /><CodeLine lineNumber="627"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(V, <a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>())) &#123;</span></CodeLine>
<Link id="l00628" /><CodeLine lineNumber="628"><span class="doxyHighlight">    Mask.assign(NumElts, -1);</span></CodeLine>
<Link id="l00629" /><CodeLine lineNumber="629"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00630" /><CodeLine lineNumber="630"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00631" /><CodeLine lineNumber="631"></CodeLine>
<Link id="l00632" /><CodeLine lineNumber="632"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (V == <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>) &#123;</span></CodeLine>
<Link id="l00633" /><CodeLine lineNumber="633"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> i = 0; i != NumElts; ++i)</span></CodeLine>
<Link id="l00634" /><CodeLine lineNumber="634"><span class="doxyHighlight">      Mask.push&#95;back(i);</span></CodeLine>
<Link id="l00635" /><CodeLine lineNumber="635"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00636" /><CodeLine lineNumber="636"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00637" /><CodeLine lineNumber="637"></CodeLine>
<Link id="l00638" /><CodeLine lineNumber="638"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (V == <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>) &#123;</span></CodeLine>
<Link id="l00639" /><CodeLine lineNumber="639"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> i = 0; i != NumElts; ++i)</span></CodeLine>
<Link id="l00640" /><CodeLine lineNumber="640"><span class="doxyHighlight">      Mask.push&#95;back(i + NumElts);</span></CodeLine>
<Link id="l00641" /><CodeLine lineNumber="641"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00642" /><CodeLine lineNumber="642"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00643" /><CodeLine lineNumber="643"></CodeLine>
<Link id="l00644" /><CodeLine lineNumber="644"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &#42;IEI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;InsertElementInst&gt;</a>(V)) &#123;</span></CodeLine>
<Link id="l00645" /><CodeLine lineNumber="645"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If this is an insert of an extract from some other vector, include it.</span></CodeLine>
<Link id="l00646" /><CodeLine lineNumber="646"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;VecOp    = IEI-&gt;getOperand(0);</span></CodeLine>
<Link id="l00647" /><CodeLine lineNumber="647"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;ScalarOp = IEI-&gt;getOperand(1);</span></CodeLine>
<Link id="l00648" /><CodeLine lineNumber="648"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;IdxOp    = IEI-&gt;getOperand(2);</span></CodeLine>
<Link id="l00649" /><CodeLine lineNumber="649"></CodeLine>
<Link id="l00650" /><CodeLine lineNumber="650"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;ConstantInt&gt;</a>(IdxOp))</span></CodeLine>
<Link id="l00651" /><CodeLine lineNumber="651"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00652" /><CodeLine lineNumber="652"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> InsertedIdx = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;ConstantInt&gt;</a>(IdxOp)-&gt;getZExtValue();</span></CodeLine>
<Link id="l00653" /><CodeLine lineNumber="653"></CodeLine>
<Link id="l00654" /><CodeLine lineNumber="654"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;PoisonValue&gt;</a>(ScalarOp)) &#123;  </span><span class="doxyHighlightComment">// inserting poison into vector.</span></CodeLine>
<Link id="l00655" /><CodeLine lineNumber="655"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// We can handle this if the vector we are inserting into is</span></CodeLine>
<Link id="l00656" /><CodeLine lineNumber="656"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// transitively ok.</span></CodeLine>
<Link id="l00657" /><CodeLine lineNumber="657"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a0f22159dceed07fd0d5d47915a80dc72">collectSingleShuffleElements</a>(VecOp, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>, Mask)) &#123;</span></CodeLine>
<Link id="l00658" /><CodeLine lineNumber="658"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// If so, update the mask to reflect the inserted poison.</span></CodeLine>
<Link id="l00659" /><CodeLine lineNumber="659"><span class="doxyHighlight">        Mask&#91;InsertedIdx&#93; = -1;</span></CodeLine>
<Link id="l00660" /><CodeLine lineNumber="660"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00661" /><CodeLine lineNumber="661"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00662" /><CodeLine lineNumber="662"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/extractelementinst">ExtractElementInst</a> &#42;EI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ExtractElementInst&gt;</a>(ScalarOp))&#123;</span></CodeLine>
<Link id="l00663" /><CodeLine lineNumber="663"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;ConstantInt&gt;</a>(EI-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1))) &#123;</span></CodeLine>
<Link id="l00664" /><CodeLine lineNumber="664"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> ExtractedIdx =</span></CodeLine>
<Link id="l00665" /><CodeLine lineNumber="665"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;ConstantInt&gt;</a>(EI-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1))-&gt;getZExtValue();</span></CodeLine>
<Link id="l00666" /><CodeLine lineNumber="666"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumLHSElts =</span></CodeLine>
<Link id="l00667" /><CodeLine lineNumber="667"><span class="doxyHighlight">            <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>-&gt;getType())-&gt;getNumElements();</span></CodeLine>
<Link id="l00668" /><CodeLine lineNumber="668"></CodeLine>
<Link id="l00669" /><CodeLine lineNumber="669"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// This must be extracting from either LHS or RHS.</span></CodeLine>
<Link id="l00670" /><CodeLine lineNumber="670"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (EI-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0) == <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a> || EI-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0) == <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>) &#123;</span></CodeLine>
<Link id="l00671" /><CodeLine lineNumber="671"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// We can handle this if the vector we are inserting into is</span></CodeLine>
<Link id="l00672" /><CodeLine lineNumber="672"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// transitively ok.</span></CodeLine>
<Link id="l00673" /><CodeLine lineNumber="673"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a0f22159dceed07fd0d5d47915a80dc72">collectSingleShuffleElements</a>(VecOp, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>, Mask)) &#123;</span></CodeLine>
<Link id="l00674" /><CodeLine lineNumber="674"><span class="doxyHighlight">            </span><span class="doxyHighlightComment">// If so, update the mask to reflect the inserted value.</span></CodeLine>
<Link id="l00675" /><CodeLine lineNumber="675"><span class="doxyHighlight">            </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (EI-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0) == <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>) &#123;</span></CodeLine>
<Link id="l00676" /><CodeLine lineNumber="676"><span class="doxyHighlight">              Mask&#91;InsertedIdx % NumElts&#93; = ExtractedIdx;</span></CodeLine>
<Link id="l00677" /><CodeLine lineNumber="677"><span class="doxyHighlight">            &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00678" /><CodeLine lineNumber="678"><span class="doxyHighlight">              <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(EI-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0) == <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>);</span></CodeLine>
<Link id="l00679" /><CodeLine lineNumber="679"><span class="doxyHighlight">              Mask&#91;InsertedIdx % NumElts&#93; = ExtractedIdx + NumLHSElts;</span></CodeLine>
<Link id="l00680" /><CodeLine lineNumber="680"><span class="doxyHighlight">            &#125;</span></CodeLine>
<Link id="l00681" /><CodeLine lineNumber="681"><span class="doxyHighlight">            </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00682" /><CodeLine lineNumber="682"><span class="doxyHighlight">          &#125;</span></CodeLine>
<Link id="l00683" /><CodeLine lineNumber="683"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l00684" /><CodeLine lineNumber="684"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00685" /><CodeLine lineNumber="685"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00686" /><CodeLine lineNumber="686"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00687" /><CodeLine lineNumber="687"></CodeLine>
<Link id="l00688" /><CodeLine lineNumber="688"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00689" /><CodeLine lineNumber="689"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00690" /><CodeLine lineNumber="690"></CodeLine>
<Link id="l00691" /><CodeLine lineNumber="691"><span class="doxyHighlightComment">/// If we have insertion into a vector that is wider than the vector that we</span></CodeLine>
<Link id="l00692" /><CodeLine lineNumber="692"><span class="doxyHighlightComment">/// are extracting from, try to widen the source vector to allow a single</span></CodeLine>
<Link id="l00693" /><CodeLine lineNumber="693"><span class="doxyHighlightComment">/// shufflevector to replace one or more insert/extract pairs.</span></CodeLine>
<Link id="l00694" /><CodeLine lineNumber="694" lineLink="#a801d960feba2403acf8dbd07ee3f34b6"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#a801d960feba2403acf8dbd07ee3f34b6">replaceExtractElements</a>(<a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &#42;InsElt,</span></CodeLine>
<Link id="l00695" /><CodeLine lineNumber="695"><span class="doxyHighlight">                                   <a href="/docs/api/classes/llvm/extractelementinst">ExtractElementInst</a> &#42;ExtElt,</span></CodeLine>
<Link id="l00696" /><CodeLine lineNumber="696"><span class="doxyHighlight">                                   <a href="/docs/api/classes/llvm/instcombinerimpl">InstCombinerImpl</a> &amp;IC) &#123;</span></CodeLine>
<Link id="l00697" /><CodeLine lineNumber="697"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;InsVecType = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(InsElt-&gt;<a href="/docs/api/classes/llvm/insertelementinst/#a49230ece74a48a27fb2bb1a4928b6e29">getType</a>());</span></CodeLine>
<Link id="l00698" /><CodeLine lineNumber="698"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;ExtVecType = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(ExtElt-&gt;<a href="/docs/api/classes/llvm/extractelementinst/#acac09986a48f1f758f882cc7ba780c08">getVectorOperandType</a>());</span></CodeLine>
<Link id="l00699" /><CodeLine lineNumber="699"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumInsElts = InsVecType-&gt;getNumElements();</span></CodeLine>
<Link id="l00700" /><CodeLine lineNumber="700"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumExtElts = ExtVecType-&gt;getNumElements();</span></CodeLine>
<Link id="l00701" /><CodeLine lineNumber="701"></CodeLine>
<Link id="l00702" /><CodeLine lineNumber="702"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The inserted-to vector must be wider than the extracted-from vector.</span></CodeLine>
<Link id="l00703" /><CodeLine lineNumber="703"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (InsVecType-&gt;getElementType() != ExtVecType-&gt;getElementType() ||</span></CodeLine>
<Link id="l00704" /><CodeLine lineNumber="704"><span class="doxyHighlight">      NumExtElts &gt;= NumInsElts)</span></CodeLine>
<Link id="l00705" /><CodeLine lineNumber="705"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00706" /><CodeLine lineNumber="706"></CodeLine>
<Link id="l00707" /><CodeLine lineNumber="707"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create a shuffle mask to widen the extended-from vector using poison</span></CodeLine>
<Link id="l00708" /><CodeLine lineNumber="708"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// values. The mask selects all of the values of the original vector followed</span></CodeLine>
<Link id="l00709" /><CodeLine lineNumber="709"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// by as many poison values as needed to create a vector of the same length</span></CodeLine>
<Link id="l00710" /><CodeLine lineNumber="710"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// as the inserted-to vector.</span></CodeLine>
<Link id="l00711" /><CodeLine lineNumber="711"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;int, 16&gt;</a> ExtendMask;</span></CodeLine>
<Link id="l00712" /><CodeLine lineNumber="712"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> i = 0; i &lt; NumExtElts; ++i)</span></CodeLine>
<Link id="l00713" /><CodeLine lineNumber="713"><span class="doxyHighlight">    ExtendMask.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(i);</span></CodeLine>
<Link id="l00714" /><CodeLine lineNumber="714"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> i = NumExtElts; i &lt; NumInsElts; ++i)</span></CodeLine>
<Link id="l00715" /><CodeLine lineNumber="715"><span class="doxyHighlight">    ExtendMask.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(-1);</span></CodeLine>
<Link id="l00716" /><CodeLine lineNumber="716"></CodeLine>
<Link id="l00717" /><CodeLine lineNumber="717"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;ExtVecOp = ExtElt-&gt;<a href="/docs/api/classes/llvm/extractelementinst/#ab140abba7cc496d52d482be53d14ed6a">getVectorOperand</a>();</span></CodeLine>
<Link id="l00718" /><CodeLine lineNumber="718"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;ExtVecOpInst = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(ExtVecOp);</span></CodeLine>
<Link id="l00719" /><CodeLine lineNumber="719"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;InsertionBlock = (ExtVecOpInst &amp;&amp; !<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;PHINode&gt;</a>(ExtVecOpInst))</span></CodeLine>
<Link id="l00720" /><CodeLine lineNumber="720"><span class="doxyHighlight">                                   ? ExtVecOpInst-&gt;<a href="/docs/api/classes/llvm/basicblock/#a1b4bf7c97cdc8159fd73d48063f0b250">getParent</a>()</span></CodeLine>
<Link id="l00721" /><CodeLine lineNumber="721"><span class="doxyHighlight">                                   : ExtElt-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>();</span></CodeLine>
<Link id="l00722" /><CodeLine lineNumber="722"></CodeLine>
<Link id="l00723" /><CodeLine lineNumber="723"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: This restriction matches the basic block check below when creating</span></CodeLine>
<Link id="l00724" /><CodeLine lineNumber="724"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// new extractelement instructions. If that limitation is removed, this one</span></CodeLine>
<Link id="l00725" /><CodeLine lineNumber="725"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// could also be removed. But for now, we just bail out to ensure that we</span></CodeLine>
<Link id="l00726" /><CodeLine lineNumber="726"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// will replace the extractelement instruction that is feeding our</span></CodeLine>
<Link id="l00727" /><CodeLine lineNumber="727"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// insertelement instruction. This allows the insertelement to then be</span></CodeLine>
<Link id="l00728" /><CodeLine lineNumber="728"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// replaced by a shufflevector. If the insertelement is not replaced, we can</span></CodeLine>
<Link id="l00729" /><CodeLine lineNumber="729"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// induce infinite looping because there&#39;s an optimization for extractelement</span></CodeLine>
<Link id="l00730" /><CodeLine lineNumber="730"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// that will delete our widening shuffle. This would trigger another attempt</span></CodeLine>
<Link id="l00731" /><CodeLine lineNumber="731"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// here to create that shuffle, and we spin forever.</span></CodeLine>
<Link id="l00732" /><CodeLine lineNumber="732"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (InsertionBlock != InsElt-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>())</span></CodeLine>
<Link id="l00733" /><CodeLine lineNumber="733"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00734" /><CodeLine lineNumber="734"></CodeLine>
<Link id="l00735" /><CodeLine lineNumber="735"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: This restriction matches the check in visitInsertElementInst() and</span></CodeLine>
<Link id="l00736" /><CodeLine lineNumber="736"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// prevents an infinite loop caused by not turning the extract/insert pair</span></CodeLine>
<Link id="l00737" /><CodeLine lineNumber="737"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// into a shuffle. We really should not need either check, but we&#39;re lacking</span></CodeLine>
<Link id="l00738" /><CodeLine lineNumber="738"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// folds for shufflevectors because we&#39;re afraid to generate shuffle masks</span></CodeLine>
<Link id="l00739" /><CodeLine lineNumber="739"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// that the backend can&#39;t handle.</span></CodeLine>
<Link id="l00740" /><CodeLine lineNumber="740"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (InsElt-&gt;<a href="/docs/api/classes/llvm/value/#a3a402430a1bbe70a9282dcb0e0b6a2cd">hasOneUse</a>() &amp;&amp; <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;InsertElementInst&gt;</a>(InsElt-&gt;<a href="/docs/api/classes/llvm/instruction/#a6609528bd67d5506a9bf9a2cce2d6f58">user&#95;back</a>()))</span></CodeLine>
<Link id="l00741" /><CodeLine lineNumber="741"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00742" /><CodeLine lineNumber="742"></CodeLine>
<Link id="l00743" /><CodeLine lineNumber="743"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;WideVec = </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a>(ExtVecOp, ExtendMask);</span></CodeLine>
<Link id="l00744" /><CodeLine lineNumber="744"></CodeLine>
<Link id="l00745" /><CodeLine lineNumber="745"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Insert the new shuffle after the vector operand of the extract is defined</span></CodeLine>
<Link id="l00746" /><CodeLine lineNumber="746"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// (as long as it&#39;s not a PHI) or at the start of the basic block of the</span></CodeLine>
<Link id="l00747" /><CodeLine lineNumber="747"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// extract, so any subsequent extracts in the same basic block can use it.</span></CodeLine>
<Link id="l00748" /><CodeLine lineNumber="748"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: Insert before the earliest ExtractElementInst that is replaced.</span></CodeLine>
<Link id="l00749" /><CodeLine lineNumber="749"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ExtVecOpInst &amp;&amp; !<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;PHINode&gt;</a>(ExtVecOpInst))</span></CodeLine>
<Link id="l00750" /><CodeLine lineNumber="750"><span class="doxyHighlight">    WideVec-&gt;insertAfter(ExtVecOpInst-&gt;getIterator());</span></CodeLine>
<Link id="l00751" /><CodeLine lineNumber="751"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00752" /><CodeLine lineNumber="752"><span class="doxyHighlight">    IC.<a href="/docs/api/classes/llvm/instcombiner/#a7ce29ca36c91b8c790b0f8b2560c3033">InsertNewInstWith</a>(WideVec, ExtElt-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>()-&gt;getFirstInsertionPt());</span></CodeLine>
<Link id="l00753" /><CodeLine lineNumber="753"></CodeLine>
<Link id="l00754" /><CodeLine lineNumber="754"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Replace extracts from the original narrow vector with extracts from the new</span></CodeLine>
<Link id="l00755" /><CodeLine lineNumber="755"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// wide vector.</span></CodeLine>
<Link id="l00756" /><CodeLine lineNumber="756"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/user">User</a> &#42;U : ExtVecOp-&gt;<a href="/docs/api/classes/llvm/value/#a411cf3e3932f209ce3374cb31adc1da6">users</a>()) &#123;</span></CodeLine>
<Link id="l00757" /><CodeLine lineNumber="757"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/extractelementinst">ExtractElementInst</a> &#42;OldExt = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ExtractElementInst&gt;</a>(U);</span></CodeLine>
<Link id="l00758" /><CodeLine lineNumber="758"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!OldExt || OldExt-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>() != WideVec-&gt;getParent())</span></CodeLine>
<Link id="l00759" /><CodeLine lineNumber="759"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00760" /><CodeLine lineNumber="760"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewExt = <a href="/docs/api/classes/llvm/extractelementinst/#a686bd809f72a2701d97b1bbd17f7db9f">ExtractElementInst::Create</a>(WideVec, OldExt-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1));</span></CodeLine>
<Link id="l00761" /><CodeLine lineNumber="761"><span class="doxyHighlight">    IC.<a href="/docs/api/classes/llvm/instcombiner/#a7ce29ca36c91b8c790b0f8b2560c3033">InsertNewInstWith</a>(NewExt, OldExt-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>());</span></CodeLine>
<Link id="l00762" /><CodeLine lineNumber="762"><span class="doxyHighlight">    IC.<a href="/docs/api/classes/llvm/instcombiner/#a49f1bd0bdf0ef741bdd714cc1188d7c5">replaceInstUsesWith</a>(&#42;OldExt, NewExt);</span></CodeLine>
<Link id="l00763" /><CodeLine lineNumber="763"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Add the old extracts to the worklist for DCE. We can&#39;t remove the</span></CodeLine>
<Link id="l00764" /><CodeLine lineNumber="764"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// extracts directly, because they may still be used by the calling code.</span></CodeLine>
<Link id="l00765" /><CodeLine lineNumber="765"><span class="doxyHighlight">    IC.<a href="/docs/api/classes/llvm/instcombiner/#ab86d58ae73173328360a32cbbb0d5b14">addToWorklist</a>(OldExt);</span></CodeLine>
<Link id="l00766" /><CodeLine lineNumber="766"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00767" /><CodeLine lineNumber="767"></CodeLine>
<Link id="l00768" /><CodeLine lineNumber="768"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00769" /><CodeLine lineNumber="769"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00770" /><CodeLine lineNumber="770"></CodeLine>
<Link id="l00771" /><CodeLine lineNumber="771"><span class="doxyHighlightComment">/// We are building a shuffle to create V, which is a sequence of insertelement,</span></CodeLine>
<Link id="l00772" /><CodeLine lineNumber="772"><span class="doxyHighlightComment">/// extractelement pairs. If PermittedRHS is set, then we must either use it or</span></CodeLine>
<Link id="l00773" /><CodeLine lineNumber="773"><span class="doxyHighlightComment">/// not rely on the second vector source. Return a std::pair containing the</span></CodeLine>
<Link id="l00774" /><CodeLine lineNumber="774"><span class="doxyHighlightComment">/// left and right vectors of the proposed shuffle (or 0), and set the Mask</span></CodeLine>
<Link id="l00775" /><CodeLine lineNumber="775"><span class="doxyHighlightComment">/// parameter as required.</span></CodeLine>
<Link id="l00776" /><CodeLine lineNumber="776"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00777" /><CodeLine lineNumber="777"><span class="doxyHighlightComment">/// Note: we intentionally don&#39;t try to fold earlier shuffles since they have</span></CodeLine>
<Link id="l00778" /><CodeLine lineNumber="778"><span class="doxyHighlightComment">/// often been chosen carefully to be efficiently implementable on the target.</span></CodeLine>
<Link id="l00779" /><CodeLine lineNumber="779" lineLink="#a5ef308f5547e4c1a6dfe646dd7ea7abc"><span class="doxyHighlightKeyword">using </span><span class="doxyHighlight"><a href="#a5ef308f5547e4c1a6dfe646dd7ea7abc">ShuffleOps</a> = std::pair&lt;Value &#42;, Value &#42;&gt;;</span></CodeLine>
<Link id="l00780" /><CodeLine lineNumber="780"></CodeLine>
<Link id="l00781" /><CodeLine lineNumber="781" lineLink="#a1e502a1ec39cc64d6b86e9e68b29be89"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="#a5ef308f5547e4c1a6dfe646dd7ea7abc">ShuffleOps</a> <a href="#a1e502a1ec39cc64d6b86e9e68b29be89">collectShuffleElements</a>(<a href="/docs/api/classes/llvm/value">Value</a> &#42;V, <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;int&gt;</a> &amp;Mask,</span></CodeLine>
<Link id="l00782" /><CodeLine lineNumber="782"><span class="doxyHighlight">                                         <a href="/docs/api/classes/llvm/value">Value</a> &#42;PermittedRHS,</span></CodeLine>
<Link id="l00783" /><CodeLine lineNumber="783"><span class="doxyHighlight">                                         <a href="/docs/api/classes/llvm/instcombinerimpl">InstCombinerImpl</a> &amp;IC, </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> &amp;Rerun) &#123;</span></CodeLine>
<Link id="l00784" /><CodeLine lineNumber="784"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(V-&gt;getType()-&gt;isVectorTy() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Invalid shuffle!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00785" /><CodeLine lineNumber="785"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumElts = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(V-&gt;getType())-&gt;getNumElements();</span></CodeLine>
<Link id="l00786" /><CodeLine lineNumber="786"></CodeLine>
<Link id="l00787" /><CodeLine lineNumber="787"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(V, <a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>())) &#123;</span></CodeLine>
<Link id="l00788" /><CodeLine lineNumber="788"><span class="doxyHighlight">    Mask.assign(NumElts, -1);</span></CodeLine>
<Link id="l00789" /><CodeLine lineNumber="789"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> std::make&#95;pair(</span></CodeLine>
<Link id="l00790" /><CodeLine lineNumber="790"><span class="doxyHighlight">        PermittedRHS ? <a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(PermittedRHS-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>()) : V, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00791" /><CodeLine lineNumber="791"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00792" /><CodeLine lineNumber="792"></CodeLine>
<Link id="l00793" /><CodeLine lineNumber="793"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;ConstantAggregateZero&gt;</a>(V)) &#123;</span></CodeLine>
<Link id="l00794" /><CodeLine lineNumber="794"><span class="doxyHighlight">    Mask.assign(NumElts, 0);</span></CodeLine>
<Link id="l00795" /><CodeLine lineNumber="795"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> std::make&#95;pair(V, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00796" /><CodeLine lineNumber="796"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00797" /><CodeLine lineNumber="797"></CodeLine>
<Link id="l00798" /><CodeLine lineNumber="798"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &#42;IEI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;InsertElementInst&gt;</a>(V)) &#123;</span></CodeLine>
<Link id="l00799" /><CodeLine lineNumber="799"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If this is an insert of an extract from some other vector, include it.</span></CodeLine>
<Link id="l00800" /><CodeLine lineNumber="800"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;VecOp    = IEI-&gt;getOperand(0);</span></CodeLine>
<Link id="l00801" /><CodeLine lineNumber="801"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;ScalarOp = IEI-&gt;getOperand(1);</span></CodeLine>
<Link id="l00802" /><CodeLine lineNumber="802"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;IdxOp    = IEI-&gt;getOperand(2);</span></CodeLine>
<Link id="l00803" /><CodeLine lineNumber="803"></CodeLine>
<Link id="l00804" /><CodeLine lineNumber="804"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/extractelementinst">ExtractElementInst</a> &#42;EI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ExtractElementInst&gt;</a>(ScalarOp)) &#123;</span></CodeLine>
<Link id="l00805" /><CodeLine lineNumber="805"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;ConstantInt&gt;</a>(EI-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1)) &amp;&amp; <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;ConstantInt&gt;</a>(IdxOp)) &#123;</span></CodeLine>
<Link id="l00806" /><CodeLine lineNumber="806"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> ExtractedIdx =</span></CodeLine>
<Link id="l00807" /><CodeLine lineNumber="807"><span class="doxyHighlight">          <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;ConstantInt&gt;</a>(EI-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1))-&gt;getZExtValue();</span></CodeLine>
<Link id="l00808" /><CodeLine lineNumber="808"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> InsertedIdx = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;ConstantInt&gt;</a>(IdxOp)-&gt;getZExtValue();</span></CodeLine>
<Link id="l00809" /><CodeLine lineNumber="809"></CodeLine>
<Link id="l00810" /><CodeLine lineNumber="810"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Either the extracted from or inserted into vector must be RHSVec,</span></CodeLine>
<Link id="l00811" /><CodeLine lineNumber="811"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// otherwise we&#39;d end up with a shuffle of three inputs.</span></CodeLine>
<Link id="l00812" /><CodeLine lineNumber="812"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (EI-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0) == PermittedRHS || PermittedRHS == </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">) &#123;</span></CodeLine>
<Link id="l00813" /><CodeLine lineNumber="813"><span class="doxyHighlight">          <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a> = EI-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0);</span></CodeLine>
<Link id="l00814" /><CodeLine lineNumber="814"><span class="doxyHighlight">          <a href="#a5ef308f5547e4c1a6dfe646dd7ea7abc">ShuffleOps</a> LR = <a href="#a1e502a1ec39cc64d6b86e9e68b29be89">collectShuffleElements</a>(VecOp, Mask, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>, IC, Rerun);</span></CodeLine>
<Link id="l00815" /><CodeLine lineNumber="815"><span class="doxyHighlight">          <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(LR.second == </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight"> || LR.second == <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>);</span></CodeLine>
<Link id="l00816" /><CodeLine lineNumber="816"></CodeLine>
<Link id="l00817" /><CodeLine lineNumber="817"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LR.first-&gt;getType() != <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>-&gt;getType()) &#123;</span></CodeLine>
<Link id="l00818" /><CodeLine lineNumber="818"><span class="doxyHighlight">            </span><span class="doxyHighlightComment">// Although we are giving up for now, see if we can create extracts</span></CodeLine>
<Link id="l00819" /><CodeLine lineNumber="819"><span class="doxyHighlight">            </span><span class="doxyHighlightComment">// that match the inserts for another round of combining.</span></CodeLine>
<Link id="l00820" /><CodeLine lineNumber="820"><span class="doxyHighlight">            </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a801d960feba2403acf8dbd07ee3f34b6">replaceExtractElements</a>(IEI, EI, IC))</span></CodeLine>
<Link id="l00821" /><CodeLine lineNumber="821"><span class="doxyHighlight">              Rerun = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00822" /><CodeLine lineNumber="822"></CodeLine>
<Link id="l00823" /><CodeLine lineNumber="823"><span class="doxyHighlight">            </span><span class="doxyHighlightComment">// We tried our best, but we can&#39;t find anything compatible with RHS</span></CodeLine>
<Link id="l00824" /><CodeLine lineNumber="824"><span class="doxyHighlight">            </span><span class="doxyHighlightComment">// further up the chain. Return a trivial shuffle.</span></CodeLine>
<Link id="l00825" /><CodeLine lineNumber="825"><span class="doxyHighlight">            </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> i = 0; i &lt; NumElts; ++i)</span></CodeLine>
<Link id="l00826" /><CodeLine lineNumber="826"><span class="doxyHighlight">              Mask&#91;i&#93; = i;</span></CodeLine>
<Link id="l00827" /><CodeLine lineNumber="827"><span class="doxyHighlight">            </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> std::make&#95;pair(V, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00828" /><CodeLine lineNumber="828"><span class="doxyHighlight">          &#125;</span></CodeLine>
<Link id="l00829" /><CodeLine lineNumber="829"></CodeLine>
<Link id="l00830" /><CodeLine lineNumber="830"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumLHSElts =</span></CodeLine>
<Link id="l00831" /><CodeLine lineNumber="831"><span class="doxyHighlight">              <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>-&gt;getType())-&gt;getNumElements();</span></CodeLine>
<Link id="l00832" /><CodeLine lineNumber="832"><span class="doxyHighlight">          Mask&#91;InsertedIdx % NumElts&#93; = NumLHSElts + ExtractedIdx;</span></CodeLine>
<Link id="l00833" /><CodeLine lineNumber="833"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> std::make&#95;pair(LR.first, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>);</span></CodeLine>
<Link id="l00834" /><CodeLine lineNumber="834"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l00835" /><CodeLine lineNumber="835"></CodeLine>
<Link id="l00836" /><CodeLine lineNumber="836"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (VecOp == PermittedRHS) &#123;</span></CodeLine>
<Link id="l00837" /><CodeLine lineNumber="837"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// We&#39;ve gone as far as we can: anything on the other side of the</span></CodeLine>
<Link id="l00838" /><CodeLine lineNumber="838"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// extractelement will already have been converted into a shuffle.</span></CodeLine>
<Link id="l00839" /><CodeLine lineNumber="839"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumLHSElts =</span></CodeLine>
<Link id="l00840" /><CodeLine lineNumber="840"><span class="doxyHighlight">              <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(EI-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0)-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>())</span></CodeLine>
<Link id="l00841" /><CodeLine lineNumber="841"><span class="doxyHighlight">                  -&gt;getNumElements();</span></CodeLine>
<Link id="l00842" /><CodeLine lineNumber="842"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> i = 0; i != NumElts; ++i)</span></CodeLine>
<Link id="l00843" /><CodeLine lineNumber="843"><span class="doxyHighlight">            Mask.push&#95;back(i == InsertedIdx ? ExtractedIdx : NumLHSElts + i);</span></CodeLine>
<Link id="l00844" /><CodeLine lineNumber="844"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> std::make&#95;pair(EI-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0), PermittedRHS);</span></CodeLine>
<Link id="l00845" /><CodeLine lineNumber="845"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l00846" /><CodeLine lineNumber="846"></CodeLine>
<Link id="l00847" /><CodeLine lineNumber="847"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// If this insertelement is a chain that comes from exactly these two</span></CodeLine>
<Link id="l00848" /><CodeLine lineNumber="848"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// vectors, return the vector and the effective shuffle.</span></CodeLine>
<Link id="l00849" /><CodeLine lineNumber="849"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (EI-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0)-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>() == PermittedRHS-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>() &amp;&amp;</span></CodeLine>
<Link id="l00850" /><CodeLine lineNumber="850"><span class="doxyHighlight">            <a href="#a0f22159dceed07fd0d5d47915a80dc72">collectSingleShuffleElements</a>(IEI, EI-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0), PermittedRHS,</span></CodeLine>
<Link id="l00851" /><CodeLine lineNumber="851"><span class="doxyHighlight">                                         Mask))</span></CodeLine>
<Link id="l00852" /><CodeLine lineNumber="852"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> std::make&#95;pair(EI-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0), PermittedRHS);</span></CodeLine>
<Link id="l00853" /><CodeLine lineNumber="853"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00854" /><CodeLine lineNumber="854"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00855" /><CodeLine lineNumber="855"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00856" /><CodeLine lineNumber="856"></CodeLine>
<Link id="l00857" /><CodeLine lineNumber="857"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Otherwise, we can&#39;t do anything fancy. Return an identity vector.</span></CodeLine>
<Link id="l00858" /><CodeLine lineNumber="858"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> i = 0; i != NumElts; ++i)</span></CodeLine>
<Link id="l00859" /><CodeLine lineNumber="859"><span class="doxyHighlight">    Mask.push&#95;back(i);</span></CodeLine>
<Link id="l00860" /><CodeLine lineNumber="860"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> std::make&#95;pair(V, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00861" /><CodeLine lineNumber="861"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00862" /><CodeLine lineNumber="862"></CodeLine>
<Link id="l00863" /><CodeLine lineNumber="863"><span class="doxyHighlightComment">/// Look for chain of insertvalue&#39;s that fully define an aggregate, and trace</span></CodeLine>
<Link id="l00864" /><CodeLine lineNumber="864"><span class="doxyHighlightComment">/// back the values inserted, see if they are all were extractvalue&#39;d from</span></CodeLine>
<Link id="l00865" /><CodeLine lineNumber="865"><span class="doxyHighlightComment">/// the same source aggregate from the exact same element indexes.</span></CodeLine>
<Link id="l00866" /><CodeLine lineNumber="866"><span class="doxyHighlightComment">/// If they were, just reuse the source aggregate.</span></CodeLine>
<Link id="l00867" /><CodeLine lineNumber="867"><span class="doxyHighlightComment">/// This potentially deals with PHI indirections.</span></CodeLine>
<Link id="l00868" /><CodeLine lineNumber="868" lineLink="/docs/api/classes/llvm/instcombinerimpl/#acad657182350311f85bc33387733e506"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/classes/llvm/instcombinerimpl/#acad657182350311f85bc33387733e506">InstCombinerImpl::foldAggregateConstructionIntoAggregateReuse</a>(</span></CodeLine>
<Link id="l00869" /><CodeLine lineNumber="869"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/insertvalueinst">InsertValueInst</a> &amp;OrigIVI) &#123;</span></CodeLine>
<Link id="l00870" /><CodeLine lineNumber="870"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/type">Type</a> &#42;AggTy = OrigIVI.<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>();</span></CodeLine>
<Link id="l00871" /><CodeLine lineNumber="871"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumAggElts;</span></CodeLine>
<Link id="l00872" /><CodeLine lineNumber="872"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (AggTy-&gt;<a href="/docs/api/classes/llvm/type/#ac7b0ed5c6d30bad74769c6e87ab0edb8">getTypeID</a>()) &#123;</span></CodeLine>
<Link id="l00873" /><CodeLine lineNumber="873"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/type/#a5e9e1c0dd93557be1b4ad72860f3cbdaa812a573d23fbb37aacd025e2a0588156">Type::StructTyID</a>:</span></CodeLine>
<Link id="l00874" /><CodeLine lineNumber="874"><span class="doxyHighlight">    NumAggElts = AggTy-&gt;<a href="/docs/api/classes/llvm/type/#a58e54adaa7672bbf72091254a5391137">getStructNumElements</a>();</span></CodeLine>
<Link id="l00875" /><CodeLine lineNumber="875"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00876" /><CodeLine lineNumber="876"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/type/#a5e9e1c0dd93557be1b4ad72860f3cbdaa2989d3024a84b4dda9d77419b1648554">Type::ArrayTyID</a>:</span></CodeLine>
<Link id="l00877" /><CodeLine lineNumber="877"><span class="doxyHighlight">    NumAggElts = AggTy-&gt;<a href="/docs/api/classes/llvm/type/#a5cfdb1cd5ccaae5daa8e4b29b3bb6b82">getArrayNumElements</a>();</span></CodeLine>
<Link id="l00878" /><CodeLine lineNumber="878"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00879" /><CodeLine lineNumber="879"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">default</span><span class="doxyHighlight">:</span></CodeLine>
<Link id="l00880" /><CodeLine lineNumber="880"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/errorhandling-h/#ace243f5c25697a1107cce46626b3dc94">llvm&#95;unreachable</a>(</span><span class="doxyHighlightStringLiteral">&quot;Unhandled aggregate type?&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00881" /><CodeLine lineNumber="881"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00882" /><CodeLine lineNumber="882"></CodeLine>
<Link id="l00883" /><CodeLine lineNumber="883"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Arbitrary aggregate size cut-off. Motivation for limit of 2 is to be able</span></CodeLine>
<Link id="l00884" /><CodeLine lineNumber="884"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// to handle clang C++ exception struct (which is hardcoded as &#123;i8&#42;, i32&#125;),</span></CodeLine>
<Link id="l00885" /><CodeLine lineNumber="885"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// FIXME: any interesting patterns to be caught with larger limit?</span></CodeLine>
<Link id="l00886" /><CodeLine lineNumber="886"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(NumAggElts &gt; 0 &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Aggregate should have elements.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00887" /><CodeLine lineNumber="887"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NumAggElts &gt; 2)</span></CodeLine>
<Link id="l00888" /><CodeLine lineNumber="888"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00889" /><CodeLine lineNumber="889"></CodeLine>
<Link id="l00890" /><CodeLine lineNumber="890"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">constexpr</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> NotFound = std::nullopt;</span></CodeLine>
<Link id="l00891" /><CodeLine lineNumber="891"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">constexpr</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> FoundMismatch = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00892" /><CodeLine lineNumber="892"></CodeLine>
<Link id="l00893" /><CodeLine lineNumber="893"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Try to find a value of each element of an aggregate.</span></CodeLine>
<Link id="l00894" /><CodeLine lineNumber="894"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// FIXME: deal with more complex, not one-dimensional, aggregate types</span></CodeLine>
<Link id="l00895" /><CodeLine lineNumber="895"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;std::optional&lt;Instruction &#42;&gt;</a>, 2&gt; AggElts(NumAggElts, NotFound);</span></CodeLine>
<Link id="l00896" /><CodeLine lineNumber="896"></CodeLine>
<Link id="l00897" /><CodeLine lineNumber="897"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Do we know values for each element of the aggregate?</span></CodeLine>
<Link id="l00898" /><CodeLine lineNumber="898"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> KnowAllElts = &#91;&amp;AggElts&#93;() &#123;</span></CodeLine>
<Link id="l00899" /><CodeLine lineNumber="899"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> !<a href="/docs/api/namespaces/llvm/#acd1cd968cb420c82d70926920fcdc7d7">llvm::is&#95;contained</a>(AggElts, NotFound);</span></CodeLine>
<Link id="l00900" /><CodeLine lineNumber="900"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l00901" /><CodeLine lineNumber="901"></CodeLine>
<Link id="l00902" /><CodeLine lineNumber="902"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06afe578efb7ca235af77fb0eef7edcf639">Depth</a> = 0;</span></CodeLine>
<Link id="l00903" /><CodeLine lineNumber="903"></CodeLine>
<Link id="l00904" /><CodeLine lineNumber="904"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Arbitrary &#96;insertvalue&#96; visitation depth limit. Let&#39;s be okay with</span></CodeLine>
<Link id="l00905" /><CodeLine lineNumber="905"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// every element being overwritten twice, which should never happen.</span></CodeLine>
<Link id="l00906" /><CodeLine lineNumber="906"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> DepthLimit = 2 &#42; NumAggElts;</span></CodeLine>
<Link id="l00907" /><CodeLine lineNumber="907"></CodeLine>
<Link id="l00908" /><CodeLine lineNumber="908"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Recurse up the chain of &#96;insertvalue&#96; aggregate operands until either we&#39;ve</span></CodeLine>
<Link id="l00909" /><CodeLine lineNumber="909"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// reconstructed full initializer or can&#39;t visit any more &#96;insertvalue&#96;&#39;s.</span></CodeLine>
<Link id="l00910" /><CodeLine lineNumber="910"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/insertvalueinst">InsertValueInst</a> &#42;CurrIVI = &amp;OrigIVI;</span></CodeLine>
<Link id="l00911" /><CodeLine lineNumber="911"><span class="doxyHighlight">       <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06afe578efb7ca235af77fb0eef7edcf639">Depth</a> &lt; DepthLimit &amp;&amp; CurrIVI &amp;&amp; !KnowAllElts();</span></CodeLine>
<Link id="l00912" /><CodeLine lineNumber="912"><span class="doxyHighlight">       CurrIVI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;InsertValueInst&gt;</a>(CurrIVI-&gt;getAggregateOperand()),</span></CodeLine>
<Link id="l00913" /><CodeLine lineNumber="913"><span class="doxyHighlight">                       ++<a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06afe578efb7ca235af77fb0eef7edcf639">Depth</a>) &#123;</span></CodeLine>
<Link id="l00914" /><CodeLine lineNumber="914"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;InsertedValue =</span></CodeLine>
<Link id="l00915" /><CodeLine lineNumber="915"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(CurrIVI-&gt;getInsertedValueOperand());</span></CodeLine>
<Link id="l00916" /><CodeLine lineNumber="916"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!InsertedValue)</span></CodeLine>
<Link id="l00917" /><CodeLine lineNumber="917"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">; </span><span class="doxyHighlightComment">// Inserted value must be produced by an instruction.</span></CodeLine>
<Link id="l00918" /><CodeLine lineNumber="918"></CodeLine>
<Link id="l00919" /><CodeLine lineNumber="919"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;unsigned int&gt;</a> Indices = CurrIVI-&gt;getIndices();</span></CodeLine>
<Link id="l00920" /><CodeLine lineNumber="920"></CodeLine>
<Link id="l00921" /><CodeLine lineNumber="921"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Don&#39;t bother with more than single-level aggregates.</span></CodeLine>
<Link id="l00922" /><CodeLine lineNumber="922"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Indices.<a href="/docs/api/classes/llvm/arrayref/#a85ffb6531d4cda988ea81f18d4e56fb7">size</a>() != 1)</span></CodeLine>
<Link id="l00923" /><CodeLine lineNumber="923"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">; </span><span class="doxyHighlightComment">// FIXME: deal with more complex aggregates?</span></CodeLine>
<Link id="l00924" /><CodeLine lineNumber="924"></CodeLine>
<Link id="l00925" /><CodeLine lineNumber="925"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Now, we may have already previously recorded the value for this element</span></CodeLine>
<Link id="l00926" /><CodeLine lineNumber="926"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// of an aggregate. If we did, that means the CurrIVI will later be</span></CodeLine>
<Link id="l00927" /><CodeLine lineNumber="927"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// overwritten with the already-recorded value. But if not, let&#39;s record it!</span></CodeLine>
<Link id="l00928" /><CodeLine lineNumber="928"><span class="doxyHighlight">    std::optional&lt;Instruction &#42;&gt; &amp;Elt = AggElts&#91;Indices.<a href="/docs/api/classes/llvm/arrayref/#a721fc555cb3d8dc2a1a680dcc2ce69b2">front</a>()&#93;;</span></CodeLine>
<Link id="l00929" /><CodeLine lineNumber="929"><span class="doxyHighlight">    Elt = Elt.value&#95;or(InsertedValue);</span></CodeLine>
<Link id="l00930" /><CodeLine lineNumber="930"></CodeLine>
<Link id="l00931" /><CodeLine lineNumber="931"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// FIXME: should we handle chain-terminating undef base operand?</span></CodeLine>
<Link id="l00932" /><CodeLine lineNumber="932"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00933" /><CodeLine lineNumber="933"></CodeLine>
<Link id="l00934" /><CodeLine lineNumber="934"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Was that sufficient to deduce the full initializer for the aggregate?</span></CodeLine>
<Link id="l00935" /><CodeLine lineNumber="935"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!KnowAllElts())</span></CodeLine>
<Link id="l00936" /><CodeLine lineNumber="936"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">; </span><span class="doxyHighlightComment">// Give up then.</span></CodeLine>
<Link id="l00937" /><CodeLine lineNumber="937"></CodeLine>
<Link id="l00938" /><CodeLine lineNumber="938"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We now want to find the source&#91;s&#93; of the aggregate elements we&#39;ve found.</span></CodeLine>
<Link id="l00939" /><CodeLine lineNumber="939"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// And with &quot;source&quot; we mean the original aggregate&#91;s&#93; from which</span></CodeLine>
<Link id="l00940" /><CodeLine lineNumber="940"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the inserted elements were extracted. This may require PHI translation.</span></CodeLine>
<Link id="l00941" /><CodeLine lineNumber="941"></CodeLine>
<Link id="l00942" /><CodeLine lineNumber="942"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">enum class</span><span class="doxyHighlight"> AggregateDescription &#123;</span></CodeLine>
<Link id="l00943" /><CodeLine lineNumber="943"><span class="doxyHighlightComment">    /// When analyzing the value that was inserted into an aggregate, we did</span></CodeLine>
<Link id="l00944" /><CodeLine lineNumber="944"><span class="doxyHighlightComment">    /// not manage to find defining &#96;extractvalue&#96; instruction to analyze.</span></CodeLine>
<Link id="l00945" /><CodeLine lineNumber="945"><span class="doxyHighlight">    NotFound,</span></CodeLine>
<Link id="l00946" /><CodeLine lineNumber="946"><span class="doxyHighlightComment">    /// When analyzing the value that was inserted into an aggregate, we did</span></CodeLine>
<Link id="l00947" /><CodeLine lineNumber="947"><span class="doxyHighlightComment">    /// manage to find defining &#96;extractvalue&#96; instruction&#91;s&#93;, and everything</span></CodeLine>
<Link id="l00948" /><CodeLine lineNumber="948"><span class="doxyHighlightComment">    /// matched perfectly - aggregate type, element insertion/extraction index.</span></CodeLine>
<Link id="l00949" /><CodeLine lineNumber="949"><span class="doxyHighlight">    Found,</span></CodeLine>
<Link id="l00950" /><CodeLine lineNumber="950"><span class="doxyHighlightComment">    /// When analyzing the value that was inserted into an aggregate, we did</span></CodeLine>
<Link id="l00951" /><CodeLine lineNumber="951"><span class="doxyHighlightComment">    /// manage to find defining &#96;extractvalue&#96; instruction, but there was</span></CodeLine>
<Link id="l00952" /><CodeLine lineNumber="952"><span class="doxyHighlightComment">    /// a mismatch: either the source type from which the extraction was didn&#39;t</span></CodeLine>
<Link id="l00953" /><CodeLine lineNumber="953"><span class="doxyHighlightComment">    /// match the aggregate type into which the insertion was,</span></CodeLine>
<Link id="l00954" /><CodeLine lineNumber="954"><span class="doxyHighlightComment">    /// or the extraction/insertion channels mismatched,</span></CodeLine>
<Link id="l00955" /><CodeLine lineNumber="955"><span class="doxyHighlightComment">    /// or different elements had different source aggregates.</span></CodeLine>
<Link id="l00956" /><CodeLine lineNumber="956"><span class="doxyHighlight">    FoundMismatch</span></CodeLine>
<Link id="l00957" /><CodeLine lineNumber="957"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l00958" /><CodeLine lineNumber="958"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Describe = &#91;&#93;(std::optional&lt;Value &#42;&gt; SourceAggregate) &#123;</span></CodeLine>
<Link id="l00959" /><CodeLine lineNumber="959"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SourceAggregate == NotFound)</span></CodeLine>
<Link id="l00960" /><CodeLine lineNumber="960"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> AggregateDescription::NotFound;</span></CodeLine>
<Link id="l00961" /><CodeLine lineNumber="961"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (&#42;SourceAggregate == FoundMismatch)</span></CodeLine>
<Link id="l00962" /><CodeLine lineNumber="962"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> AggregateDescription::FoundMismatch;</span></CodeLine>
<Link id="l00963" /><CodeLine lineNumber="963"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> AggregateDescription::Found;</span></CodeLine>
<Link id="l00964" /><CodeLine lineNumber="964"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l00965" /><CodeLine lineNumber="965"></CodeLine>
<Link id="l00966" /><CodeLine lineNumber="966"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If an aggregate element is defined in UseBB, we can&#39;t use it in PredBB.</span></CodeLine>
<Link id="l00967" /><CodeLine lineNumber="967"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> EltDefinedInUseBB = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00968" /><CodeLine lineNumber="968"></CodeLine>
<Link id="l00969" /><CodeLine lineNumber="969"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Given the value \\p Elt that was being inserted into element \\p EltIdx of an</span></CodeLine>
<Link id="l00970" /><CodeLine lineNumber="970"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// aggregate AggTy, see if \\p Elt was originally defined by an</span></CodeLine>
<Link id="l00971" /><CodeLine lineNumber="971"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// appropriate extractvalue (same element index, same aggregate type).</span></CodeLine>
<Link id="l00972" /><CodeLine lineNumber="972"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If found, return the source aggregate from which the extraction was.</span></CodeLine>
<Link id="l00973" /><CodeLine lineNumber="973"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If \\p PredBB is provided, does PHI translation of an \\p Elt first.</span></CodeLine>
<Link id="l00974" /><CodeLine lineNumber="974"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> FindSourceAggregate =</span></CodeLine>
<Link id="l00975" /><CodeLine lineNumber="975"><span class="doxyHighlight">      &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Elt, </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> EltIdx, std::optional&lt;BasicBlock &#42;&gt; UseBB,</span></CodeLine>
<Link id="l00976" /><CodeLine lineNumber="976"><span class="doxyHighlight">          std::optional&lt;BasicBlock &#42;&gt; PredBB) -&gt; std::optional&lt;Value &#42;&gt; &#123;</span></CodeLine>
<Link id="l00977" /><CodeLine lineNumber="977"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// For now(?), only deal with, at most, a single level of PHI indirection.</span></CodeLine>
<Link id="l00978" /><CodeLine lineNumber="978"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (UseBB &amp;&amp; PredBB) &#123;</span></CodeLine>
<Link id="l00979" /><CodeLine lineNumber="979"><span class="doxyHighlight">      Elt = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(Elt-&gt;<a href="/docs/api/classes/llvm/value/#a159bf794249e0567baf2a2a714d5c679">DoPHITranslation</a>(&#42;UseBB, &#42;PredBB));</span></CodeLine>
<Link id="l00980" /><CodeLine lineNumber="980"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Elt &amp;&amp; Elt-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>() == &#42;UseBB)</span></CodeLine>
<Link id="l00981" /><CodeLine lineNumber="981"><span class="doxyHighlight">        EltDefinedInUseBB = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00982" /><CodeLine lineNumber="982"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00983" /><CodeLine lineNumber="983"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// FIXME: deal with multiple levels of PHI indirection?</span></CodeLine>
<Link id="l00984" /><CodeLine lineNumber="984"></CodeLine>
<Link id="l00985" /><CodeLine lineNumber="985"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Did we find an extraction?</span></CodeLine>
<Link id="l00986" /><CodeLine lineNumber="986"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;EVI = <a href="/docs/api/namespaces/llvm/#a5f6182886dc2f96c204299e92c1565d5">dyn&#95;cast&#95;or&#95;null&lt;ExtractValueInst&gt;</a>(Elt);</span></CodeLine>
<Link id="l00987" /><CodeLine lineNumber="987"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!EVI)</span></CodeLine>
<Link id="l00988" /><CodeLine lineNumber="988"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> NotFound;</span></CodeLine>
<Link id="l00989" /><CodeLine lineNumber="989"></CodeLine>
<Link id="l00990" /><CodeLine lineNumber="990"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;SourceAggregate = EVI-&gt;getAggregateOperand();</span></CodeLine>
<Link id="l00991" /><CodeLine lineNumber="991"></CodeLine>
<Link id="l00992" /><CodeLine lineNumber="992"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Is the extraction from the same type into which the insertion was?</span></CodeLine>
<Link id="l00993" /><CodeLine lineNumber="993"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SourceAggregate-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>() != AggTy)</span></CodeLine>
<Link id="l00994" /><CodeLine lineNumber="994"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> FoundMismatch;</span></CodeLine>
<Link id="l00995" /><CodeLine lineNumber="995"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// And the element index doesn&#39;t change between extraction and insertion?</span></CodeLine>
<Link id="l00996" /><CodeLine lineNumber="996"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (EVI-&gt;getNumIndices() != 1 || EltIdx != EVI-&gt;getIndices().front())</span></CodeLine>
<Link id="l00997" /><CodeLine lineNumber="997"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> FoundMismatch;</span></CodeLine>
<Link id="l00998" /><CodeLine lineNumber="998"></CodeLine>
<Link id="l00999" /><CodeLine lineNumber="999"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> SourceAggregate; </span><span class="doxyHighlightComment">// AggregateDescription::Found</span></CodeLine>
<Link id="l01000" /><CodeLine lineNumber="1000"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l01001" /><CodeLine lineNumber="1001"></CodeLine>
<Link id="l01002" /><CodeLine lineNumber="1002"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Given elements AggElts that were constructing an aggregate OrigIVI,</span></CodeLine>
<Link id="l01003" /><CodeLine lineNumber="1003"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// see if we can find appropriate source aggregate for each of the elements,</span></CodeLine>
<Link id="l01004" /><CodeLine lineNumber="1004"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// and see it&#39;s the same aggregate for each element. If so, return it.</span></CodeLine>
<Link id="l01005" /><CodeLine lineNumber="1005"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> FindCommonSourceAggregate =</span></CodeLine>
<Link id="l01006" /><CodeLine lineNumber="1006"><span class="doxyHighlight">      &#91;&amp;&#93;(std::optional&lt;BasicBlock &#42;&gt; UseBB,</span></CodeLine>
<Link id="l01007" /><CodeLine lineNumber="1007"><span class="doxyHighlight">          std::optional&lt;BasicBlock &#42;&gt; PredBB) -&gt; std::optional&lt;Value &#42;&gt; &#123;</span></CodeLine>
<Link id="l01008" /><CodeLine lineNumber="1008"><span class="doxyHighlight">    std::optional&lt;Value &#42;&gt; SourceAggregate;</span></CodeLine>
<Link id="l01009" /><CodeLine lineNumber="1009"></CodeLine>
<Link id="l01010" /><CodeLine lineNumber="1010"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : <a href="/docs/api/namespaces/llvm/#a206e2134ddd2312c3488d0632d98f554">enumerate</a>(AggElts)) &#123;</span></CodeLine>
<Link id="l01011" /><CodeLine lineNumber="1011"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Describe(SourceAggregate) != AggregateDescription::FoundMismatch &amp;&amp;</span></CodeLine>
<Link id="l01012" /><CodeLine lineNumber="1012"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;We don&#39;t store nullptr in SourceAggregate!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01013" /><CodeLine lineNumber="1013"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((Describe(SourceAggregate) == AggregateDescription::Found) ==</span></CodeLine>
<Link id="l01014" /><CodeLine lineNumber="1014"><span class="doxyHighlight">                 (<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.index() != 0) &amp;&amp;</span></CodeLine>
<Link id="l01015" /><CodeLine lineNumber="1015"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;SourceAggregate should be valid after the first element,&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01016" /><CodeLine lineNumber="1016"></CodeLine>
<Link id="l01017" /><CodeLine lineNumber="1017"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// For this element, is there a plausible source aggregate?</span></CodeLine>
<Link id="l01018" /><CodeLine lineNumber="1018"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// FIXME: we could special-case undef element, IFF we know that in the</span></CodeLine>
<Link id="l01019" /><CodeLine lineNumber="1019"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//        source aggregate said element isn&#39;t poison.</span></CodeLine>
<Link id="l01020" /><CodeLine lineNumber="1020"><span class="doxyHighlight">      std::optional&lt;Value &#42;&gt; SourceAggregateForElement =</span></CodeLine>
<Link id="l01021" /><CodeLine lineNumber="1021"><span class="doxyHighlight">          FindSourceAggregate(&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.value(), <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.index(), UseBB, PredBB);</span></CodeLine>
<Link id="l01022" /><CodeLine lineNumber="1022"></CodeLine>
<Link id="l01023" /><CodeLine lineNumber="1023"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Okay, what have we found? Does that correlate with previous findings?</span></CodeLine>
<Link id="l01024" /><CodeLine lineNumber="1024"></CodeLine>
<Link id="l01025" /><CodeLine lineNumber="1025"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Regardless of whether or not we have previously found source</span></CodeLine>
<Link id="l01026" /><CodeLine lineNumber="1026"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// aggregate for previous elements (if any), if we didn&#39;t find one for</span></CodeLine>
<Link id="l01027" /><CodeLine lineNumber="1027"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// this element, passthrough whatever we have just found.</span></CodeLine>
<Link id="l01028" /><CodeLine lineNumber="1028"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Describe(SourceAggregateForElement) != AggregateDescription::Found)</span></CodeLine>
<Link id="l01029" /><CodeLine lineNumber="1029"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> SourceAggregateForElement;</span></CodeLine>
<Link id="l01030" /><CodeLine lineNumber="1030"></CodeLine>
<Link id="l01031" /><CodeLine lineNumber="1031"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Okay, we have found source aggregate for this element.</span></CodeLine>
<Link id="l01032" /><CodeLine lineNumber="1032"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Let&#39;s see what we already know from previous elements, if any.</span></CodeLine>
<Link id="l01033" /><CodeLine lineNumber="1033"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (Describe(SourceAggregate)) &#123;</span></CodeLine>
<Link id="l01034" /><CodeLine lineNumber="1034"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> AggregateDescription::NotFound:</span></CodeLine>
<Link id="l01035" /><CodeLine lineNumber="1035"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// This is apparently the first element that we have examined.</span></CodeLine>
<Link id="l01036" /><CodeLine lineNumber="1036"><span class="doxyHighlight">        SourceAggregate = SourceAggregateForElement; </span><span class="doxyHighlightComment">// Record the aggregate!</span></CodeLine>
<Link id="l01037" /><CodeLine lineNumber="1037"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">; </span><span class="doxyHighlightComment">// Great, now look at next element.</span></CodeLine>
<Link id="l01038" /><CodeLine lineNumber="1038"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> AggregateDescription::Found:</span></CodeLine>
<Link id="l01039" /><CodeLine lineNumber="1039"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// We have previously already successfully examined other elements.</span></CodeLine>
<Link id="l01040" /><CodeLine lineNumber="1040"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Is this the same source aggregate we&#39;ve found for other elements?</span></CodeLine>
<Link id="l01041" /><CodeLine lineNumber="1041"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (&#42;SourceAggregateForElement != &#42;SourceAggregate)</span></CodeLine>
<Link id="l01042" /><CodeLine lineNumber="1042"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> FoundMismatch;</span></CodeLine>
<Link id="l01043" /><CodeLine lineNumber="1043"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">; </span><span class="doxyHighlightComment">// Still the same aggregate, look at next element.</span></CodeLine>
<Link id="l01044" /><CodeLine lineNumber="1044"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> AggregateDescription::FoundMismatch:</span></CodeLine>
<Link id="l01045" /><CodeLine lineNumber="1045"><span class="doxyHighlight">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/errorhandling-h/#ace243f5c25697a1107cce46626b3dc94">llvm&#95;unreachable</a>(</span><span class="doxyHighlightStringLiteral">&quot;Can&#39;t happen. We would have early-exited then.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01046" /><CodeLine lineNumber="1046"><span class="doxyHighlight">      &#125;;</span></CodeLine>
<Link id="l01047" /><CodeLine lineNumber="1047"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01048" /><CodeLine lineNumber="1048"></CodeLine>
<Link id="l01049" /><CodeLine lineNumber="1049"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Describe(SourceAggregate) == AggregateDescription::Found &amp;&amp;</span></CodeLine>
<Link id="l01050" /><CodeLine lineNumber="1050"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;Must be a valid Value&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01051" /><CodeLine lineNumber="1051"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &#42;SourceAggregate;</span></CodeLine>
<Link id="l01052" /><CodeLine lineNumber="1052"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l01053" /><CodeLine lineNumber="1053"></CodeLine>
<Link id="l01054" /><CodeLine lineNumber="1054"><span class="doxyHighlight">  std::optional&lt;Value &#42;&gt; SourceAggregate;</span></CodeLine>
<Link id="l01055" /><CodeLine lineNumber="1055"></CodeLine>
<Link id="l01056" /><CodeLine lineNumber="1056"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Can we find the source aggregate without looking at predecessors?</span></CodeLine>
<Link id="l01057" /><CodeLine lineNumber="1057"><span class="doxyHighlight">  SourceAggregate = FindCommonSourceAggregate(</span><span class="doxyHighlightComment">/&#42;UseBB=&#42;/</span><span class="doxyHighlight">std::nullopt,</span></CodeLine>
<Link id="l01058" /><CodeLine lineNumber="1058"><span class="doxyHighlight">                                              </span><span class="doxyHighlightComment">/&#42;PredBB=&#42;/</span><span class="doxyHighlight">std::nullopt);</span></CodeLine>
<Link id="l01059" /><CodeLine lineNumber="1059"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Describe(SourceAggregate) != AggregateDescription::NotFound) &#123;</span></CodeLine>
<Link id="l01060" /><CodeLine lineNumber="1060"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Describe(SourceAggregate) == AggregateDescription::FoundMismatch)</span></CodeLine>
<Link id="l01061" /><CodeLine lineNumber="1061"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">; </span><span class="doxyHighlightComment">// Conflicting source aggregates!</span></CodeLine>
<Link id="l01062" /><CodeLine lineNumber="1062"><span class="doxyHighlight">    ++NumAggregateReconstructionsSimplified;</span></CodeLine>
<Link id="l01063" /><CodeLine lineNumber="1063"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instcombiner/#a49f1bd0bdf0ef741bdd714cc1188d7c5">replaceInstUsesWith</a>(OrigIVI, &#42;SourceAggregate);</span></CodeLine>
<Link id="l01064" /><CodeLine lineNumber="1064"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01065" /><CodeLine lineNumber="1065"></CodeLine>
<Link id="l01066" /><CodeLine lineNumber="1066"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Okay, apparently we need to look at predecessors.</span></CodeLine>
<Link id="l01067" /><CodeLine lineNumber="1067"></CodeLine>
<Link id="l01068" /><CodeLine lineNumber="1068"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We should be smart about picking the &quot;use&quot; basic block, which will be the</span></CodeLine>
<Link id="l01069" /><CodeLine lineNumber="1069"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// merge point for aggregate, where we&#39;ll insert the final PHI that will be</span></CodeLine>
<Link id="l01070" /><CodeLine lineNumber="1070"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// used instead of OrigIVI. Basic block of OrigIVI is &#42;not&#42; the right choice.</span></CodeLine>
<Link id="l01071" /><CodeLine lineNumber="1071"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We should look in which blocks each of the AggElts is being defined,</span></CodeLine>
<Link id="l01072" /><CodeLine lineNumber="1072"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// they all should be defined in the same basic block.</span></CodeLine>
<Link id="l01073" /><CodeLine lineNumber="1073"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;UseBB = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01074" /><CodeLine lineNumber="1074"></CodeLine>
<Link id="l01075" /><CodeLine lineNumber="1075"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> std::optional&lt;Instruction &#42;&gt; &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : AggElts) &#123;</span></CodeLine>
<Link id="l01076" /><CodeLine lineNumber="1076"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB = (&#42;I)-&gt;<a href="/docs/api/classes/llvm/basicblock/#a1b4bf7c97cdc8159fd73d48063f0b250">getParent</a>();</span></CodeLine>
<Link id="l01077" /><CodeLine lineNumber="1077"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If it&#39;s the first instruction we&#39;ve encountered, record the basic block.</span></CodeLine>
<Link id="l01078" /><CodeLine lineNumber="1078"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!UseBB) &#123;</span></CodeLine>
<Link id="l01079" /><CodeLine lineNumber="1079"><span class="doxyHighlight">      UseBB = BB;</span></CodeLine>
<Link id="l01080" /><CodeLine lineNumber="1080"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01081" /><CodeLine lineNumber="1081"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01082" /><CodeLine lineNumber="1082"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Otherwise, this must be the same basic block we&#39;ve seen previously.</span></CodeLine>
<Link id="l01083" /><CodeLine lineNumber="1083"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (UseBB != BB)</span></CodeLine>
<Link id="l01084" /><CodeLine lineNumber="1084"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01085" /><CodeLine lineNumber="1085"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01086" /><CodeLine lineNumber="1086"></CodeLine>
<Link id="l01087" /><CodeLine lineNumber="1087"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If &#42;all&#42; of the elements are basic-block-independent, meaning they are</span></CodeLine>
<Link id="l01088" /><CodeLine lineNumber="1088"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// either function arguments, or constant expressions, then if we didn&#39;t</span></CodeLine>
<Link id="l01089" /><CodeLine lineNumber="1089"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// handle them without predecessor-aware handling, we won&#39;t handle them now.</span></CodeLine>
<Link id="l01090" /><CodeLine lineNumber="1090"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!UseBB)</span></CodeLine>
<Link id="l01091" /><CodeLine lineNumber="1091"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01092" /><CodeLine lineNumber="1092"></CodeLine>
<Link id="l01093" /><CodeLine lineNumber="1093"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we didn&#39;t manage to find source aggregate without looking at</span></CodeLine>
<Link id="l01094" /><CodeLine lineNumber="1094"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// predecessors, and there are no predecessors to look at, then we&#39;re done.</span></CodeLine>
<Link id="l01095" /><CodeLine lineNumber="1095"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#ad66c4759666aab78529658362b498c74">pred&#95;empty</a>(UseBB))</span></CodeLine>
<Link id="l01096" /><CodeLine lineNumber="1096"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01097" /><CodeLine lineNumber="1097"></CodeLine>
<Link id="l01098" /><CodeLine lineNumber="1098"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Arbitrary predecessor count limit.</span></CodeLine>
<Link id="l01099" /><CodeLine lineNumber="1099"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> PredCountLimit = 64;</span></CodeLine>
<Link id="l01100" /><CodeLine lineNumber="1100"></CodeLine>
<Link id="l01101" /><CodeLine lineNumber="1101"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Cache the (non-uniqified!) list of predecessors in a vector,</span></CodeLine>
<Link id="l01102" /><CodeLine lineNumber="1102"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// checking the limit at the same time for efficiency.</span></CodeLine>
<Link id="l01103" /><CodeLine lineNumber="1103"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 4&gt;</a> Preds; </span><span class="doxyHighlightComment">// May have duplicates!</span></CodeLine>
<Link id="l01104" /><CodeLine lineNumber="1104"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Pred : <a href="/docs/api/namespaces/llvm/#acb22fb04083152eee862457e42e8dc31">predecessors</a>(UseBB)) &#123;</span></CodeLine>
<Link id="l01105" /><CodeLine lineNumber="1105"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Don&#39;t bother if there are too many predecessors.</span></CodeLine>
<Link id="l01106" /><CodeLine lineNumber="1106"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Preds.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() &gt;= PredCountLimit) </span><span class="doxyHighlightComment">// FIXME: only count duplicates once?</span></CodeLine>
<Link id="l01107" /><CodeLine lineNumber="1107"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01108" /><CodeLine lineNumber="1108"><span class="doxyHighlight">    Preds.<a href="/docs/api/classes/llvm/smallvectorimpl/#a396fcfee6914c76974b73c3d203da6a5">emplace&#95;back</a>(Pred);</span></CodeLine>
<Link id="l01109" /><CodeLine lineNumber="1109"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01110" /><CodeLine lineNumber="1110"></CodeLine>
<Link id="l01111" /><CodeLine lineNumber="1111"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For each predecessor, what is the source aggregate,</span></CodeLine>
<Link id="l01112" /><CodeLine lineNumber="1112"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// from which all the elements were originally extracted from?</span></CodeLine>
<Link id="l01113" /><CodeLine lineNumber="1113"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Note that we want for the map to have stable iteration order!</span></CodeLine>
<Link id="l01114" /><CodeLine lineNumber="1114"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;BasicBlock &#42;, Value &#42;, 4&gt;</a> SourceAggregates;</span></CodeLine>
<Link id="l01115" /><CodeLine lineNumber="1115"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> FoundSrcAgg = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01116" /><CodeLine lineNumber="1116"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Pred : Preds) &#123;</span></CodeLine>
<Link id="l01117" /><CodeLine lineNumber="1117"><span class="doxyHighlight">    std::pair&lt;</span><span class="doxyHighlightKeyword">decltype</span><span class="doxyHighlight">(SourceAggregates)<a href="/docs/api/classes/llvm/iplist">::iterator</a>, </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight">&gt; <a href="/docs/api/files/lib/lib/support/lib/support/blake3/blake3-impl-h/#a78823051d1dad34b9b3d8120112e674d">IV</a> =</span></CodeLine>
<Link id="l01118" /><CodeLine lineNumber="1118"><span class="doxyHighlight">        SourceAggregates.<a href="/docs/api/classes/llvm/densemapbase/#adb33f3ede2f5bfc9b3ee658aaf648492">insert</a>(&#123;Pred, nullptr&#125;);</span></CodeLine>
<Link id="l01119" /><CodeLine lineNumber="1119"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Did we already evaluate this predecessor?</span></CodeLine>
<Link id="l01120" /><CodeLine lineNumber="1120"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/support/lib/support/blake3/blake3-impl-h/#a78823051d1dad34b9b3d8120112e674d">IV</a>.second)</span></CodeLine>
<Link id="l01121" /><CodeLine lineNumber="1121"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01122" /><CodeLine lineNumber="1122"></CodeLine>
<Link id="l01123" /><CodeLine lineNumber="1123"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Let&#39;s hope that when coming from predecessor Pred, all elements of the</span></CodeLine>
<Link id="l01124" /><CodeLine lineNumber="1124"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// aggregate produced by OrigIVI must have been originally extracted from</span></CodeLine>
<Link id="l01125" /><CodeLine lineNumber="1125"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// the same aggregate. Is that so? Can we find said original aggregate?</span></CodeLine>
<Link id="l01126" /><CodeLine lineNumber="1126"><span class="doxyHighlight">    SourceAggregate = FindCommonSourceAggregate(UseBB, Pred);</span></CodeLine>
<Link id="l01127" /><CodeLine lineNumber="1127"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Describe(SourceAggregate) == AggregateDescription::Found) &#123;</span></CodeLine>
<Link id="l01128" /><CodeLine lineNumber="1128"><span class="doxyHighlight">      FoundSrcAgg = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01129" /><CodeLine lineNumber="1129"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/support/lib/support/blake3/blake3-impl-h/#a78823051d1dad34b9b3d8120112e674d">IV</a>.first-&gt;second = &#42;SourceAggregate;</span></CodeLine>
<Link id="l01130" /><CodeLine lineNumber="1130"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l01131" /><CodeLine lineNumber="1131"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If UseBB is the single successor of Pred, we can add InsertValue to</span></CodeLine>
<Link id="l01132" /><CodeLine lineNumber="1132"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Pred.</span></CodeLine>
<Link id="l01133" /><CodeLine lineNumber="1133"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;BI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BranchInst&gt;</a>(Pred-&gt;getTerminator());</span></CodeLine>
<Link id="l01134" /><CodeLine lineNumber="1134"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!BI || !BI-&gt;isUnconditional())</span></CodeLine>
<Link id="l01135" /><CodeLine lineNumber="1135"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01136" /><CodeLine lineNumber="1136"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01137" /><CodeLine lineNumber="1137"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01138" /><CodeLine lineNumber="1138"></CodeLine>
<Link id="l01139" /><CodeLine lineNumber="1139"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!FoundSrcAgg)</span></CodeLine>
<Link id="l01140" /><CodeLine lineNumber="1140"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01141" /><CodeLine lineNumber="1141"></CodeLine>
<Link id="l01142" /><CodeLine lineNumber="1142"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Do some sanity check if we need to add insertvalue into predecessors.</span></CodeLine>
<Link id="l01143" /><CodeLine lineNumber="1143"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> OrigBB = OrigIVI.<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>();</span></CodeLine>
<Link id="l01144" /><CodeLine lineNumber="1144"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;It : SourceAggregates) &#123;</span></CodeLine>
<Link id="l01145" /><CodeLine lineNumber="1145"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Describe(It.second) == AggregateDescription::Found)</span></CodeLine>
<Link id="l01146" /><CodeLine lineNumber="1146"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01147" /><CodeLine lineNumber="1147"></CodeLine>
<Link id="l01148" /><CodeLine lineNumber="1148"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Element is defined in UseBB, so it can&#39;t be used in predecessors.</span></CodeLine>
<Link id="l01149" /><CodeLine lineNumber="1149"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (EltDefinedInUseBB)</span></CodeLine>
<Link id="l01150" /><CodeLine lineNumber="1150"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01151" /><CodeLine lineNumber="1151"></CodeLine>
<Link id="l01152" /><CodeLine lineNumber="1152"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Do this transformation cross loop boundary may cause dead loop. So we</span></CodeLine>
<Link id="l01153" /><CodeLine lineNumber="1153"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// should avoid this situation. But LoopInfo is not generally available, we</span></CodeLine>
<Link id="l01154" /><CodeLine lineNumber="1154"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// must be conservative here.</span></CodeLine>
<Link id="l01155" /><CodeLine lineNumber="1155"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If OrigIVI is in UseBB and it&#39;s the only successor of PredBB, PredBB</span></CodeLine>
<Link id="l01156" /><CodeLine lineNumber="1156"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// can&#39;t be in inner loop.</span></CodeLine>
<Link id="l01157" /><CodeLine lineNumber="1157"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (UseBB != OrigBB)</span></CodeLine>
<Link id="l01158" /><CodeLine lineNumber="1158"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01159" /><CodeLine lineNumber="1159"></CodeLine>
<Link id="l01160" /><CodeLine lineNumber="1160"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Avoid constructing constant aggregate because constant value may expose</span></CodeLine>
<Link id="l01161" /><CodeLine lineNumber="1161"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// more optimizations.</span></CodeLine>
<Link id="l01162" /><CodeLine lineNumber="1162"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> ConstAgg = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01163" /><CodeLine lineNumber="1163"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Val : AggElts) &#123;</span></CodeLine>
<Link id="l01164" /><CodeLine lineNumber="1164"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;Elt = (&#42;Val)-&gt;<a href="/docs/api/classes/llvm/value/#a159bf794249e0567baf2a2a714d5c679">DoPHITranslation</a>(UseBB, It.first);</span></CodeLine>
<Link id="l01165" /><CodeLine lineNumber="1165"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;Constant&gt;</a>(Elt)) &#123;</span></CodeLine>
<Link id="l01166" /><CodeLine lineNumber="1166"><span class="doxyHighlight">        ConstAgg = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01167" /><CodeLine lineNumber="1167"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01168" /><CodeLine lineNumber="1168"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01169" /><CodeLine lineNumber="1169"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01170" /><CodeLine lineNumber="1170"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ConstAgg)</span></CodeLine>
<Link id="l01171" /><CodeLine lineNumber="1171"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01172" /><CodeLine lineNumber="1172"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01173" /><CodeLine lineNumber="1173"></CodeLine>
<Link id="l01174" /><CodeLine lineNumber="1174"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For predecessors without appropriate source aggregate, create one in the</span></CodeLine>
<Link id="l01175" /><CodeLine lineNumber="1175"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// predecessor.</span></CodeLine>
<Link id="l01176" /><CodeLine lineNumber="1176"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;It : SourceAggregates) &#123;</span></CodeLine>
<Link id="l01177" /><CodeLine lineNumber="1177"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Describe(It.second) == AggregateDescription::Found)</span></CodeLine>
<Link id="l01178" /><CodeLine lineNumber="1178"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01179" /><CodeLine lineNumber="1179"></CodeLine>
<Link id="l01180" /><CodeLine lineNumber="1180"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Pred = It.first;</span></CodeLine>
<Link id="l01181" /><CodeLine lineNumber="1181"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.SetInsertPoint(Pred-&gt;getTerminator());</span></CodeLine>
<Link id="l01182" /><CodeLine lineNumber="1182"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;V = <a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(AggTy);</span></CodeLine>
<Link id="l01183" /><CodeLine lineNumber="1183"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#91;Idx, Val&#93; : <a href="/docs/api/namespaces/llvm/#a206e2134ddd2312c3488d0632d98f554">enumerate</a>(AggElts)) &#123;</span></CodeLine>
<Link id="l01184" /><CodeLine lineNumber="1184"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;Elt = (&#42;Val)-&gt;<a href="/docs/api/classes/llvm/value/#a159bf794249e0567baf2a2a714d5c679">DoPHITranslation</a>(UseBB, Pred);</span></CodeLine>
<Link id="l01185" /><CodeLine lineNumber="1185"><span class="doxyHighlight">      V = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateInsertValue(V, Elt, Idx);</span></CodeLine>
<Link id="l01186" /><CodeLine lineNumber="1186"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01187" /><CodeLine lineNumber="1187"></CodeLine>
<Link id="l01188" /><CodeLine lineNumber="1188"><span class="doxyHighlight">    It.second = V;</span></CodeLine>
<Link id="l01189" /><CodeLine lineNumber="1189"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01190" /><CodeLine lineNumber="1190"></CodeLine>
<Link id="l01191" /><CodeLine lineNumber="1191"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// All good! Now we just need to thread the source aggregates here.</span></CodeLine>
<Link id="l01192" /><CodeLine lineNumber="1192"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Note that we have to insert the new PHI here, ourselves, because we can&#39;t</span></CodeLine>
<Link id="l01193" /><CodeLine lineNumber="1193"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// rely on InstCombinerImpl::run() inserting it into the right basic block.</span></CodeLine>
<Link id="l01194" /><CodeLine lineNumber="1194"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Note that the same block can be a predecessor more than once,</span></CodeLine>
<Link id="l01195" /><CodeLine lineNumber="1195"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// and we need to preserve that invariant for the PHI node.</span></CodeLine>
<Link id="l01196" /><CodeLine lineNumber="1196"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilderbase/insertpointguard">BuilderTy::InsertPointGuard</a> Guard(<a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>);</span></CodeLine>
<Link id="l01197" /><CodeLine lineNumber="1197"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.SetInsertPoint(UseBB, UseBB-&gt;getFirstNonPHIIt());</span></CodeLine>
<Link id="l01198" /><CodeLine lineNumber="1198"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a> =</span></CodeLine>
<Link id="l01199" /><CodeLine lineNumber="1199"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreatePHI(AggTy, Preds.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>(), OrigIVI.<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>() + </span><span class="doxyHighlightStringLiteral">&quot;.merged&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01200" /><CodeLine lineNumber="1200"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Pred : Preds)</span></CodeLine>
<Link id="l01201" /><CodeLine lineNumber="1201"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a>-&gt;addIncoming(SourceAggregates&#91;Pred&#93;, Pred);</span></CodeLine>
<Link id="l01202" /><CodeLine lineNumber="1202"></CodeLine>
<Link id="l01203" /><CodeLine lineNumber="1203"><span class="doxyHighlight">  ++NumAggregateReconstructionsSimplified;</span></CodeLine>
<Link id="l01204" /><CodeLine lineNumber="1204"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instcombiner/#a49f1bd0bdf0ef741bdd714cc1188d7c5">replaceInstUsesWith</a>(OrigIVI, <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a>);</span></CodeLine>
<Link id="l01205" /><CodeLine lineNumber="1205"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01206" /><CodeLine lineNumber="1206"></CodeLine>
<Link id="l01207" /><CodeLine lineNumber="1207"><span class="doxyHighlightComment">/// Try to find redundant insertvalue instructions, like the following ones:</span></CodeLine>
<Link id="l01208" /><CodeLine lineNumber="1208"><span class="doxyHighlightComment">///  %0 = insertvalue &#123; i8, i32 &#125; undef, i8 %x, 0</span></CodeLine>
<Link id="l01209" /><CodeLine lineNumber="1209"><span class="doxyHighlightComment">///  %1 = insertvalue &#123; i8, i32 &#125; %0,    i8 %y, 0</span></CodeLine>
<Link id="l01210" /><CodeLine lineNumber="1210"><span class="doxyHighlightComment">/// Here the second instruction inserts values at the same indices, as the</span></CodeLine>
<Link id="l01211" /><CodeLine lineNumber="1211"><span class="doxyHighlightComment">/// first one, making the first one redundant.</span></CodeLine>
<Link id="l01212" /><CodeLine lineNumber="1212"><span class="doxyHighlightComment">/// It should be transformed to:</span></CodeLine>
<Link id="l01213" /><CodeLine lineNumber="1213"><span class="doxyHighlightComment">///  %0 = insertvalue &#123; i8, i32 &#125; undef, i8 %y, 0</span></CodeLine>
<Link id="l01214" /><CodeLine lineNumber="1214" lineLink="/docs/api/classes/llvm/instcombinerimpl/#a643f8d7ef849e1312c83906b4b27b4aa"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/classes/llvm/instcombinerimpl/#a643f8d7ef849e1312c83906b4b27b4aa">InstCombinerImpl::visitInsertValueInst</a>(<a href="/docs/api/classes/llvm/insertvalueinst">InsertValueInst</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &#123;</span></CodeLine>
<Link id="l01215" /><CodeLine lineNumber="1215"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/value">Value</a> &#42;V = <a href="/docs/api/namespaces/llvm/#a94b67449bc2ce740bcec33d149769fe0">simplifyInsertValueInst</a>(</span></CodeLine>
<Link id="l01216" /><CodeLine lineNumber="1216"><span class="doxyHighlight">          <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getAggregateOperand(), <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getInsertedValueOperand(), <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getIndices(),</span></CodeLine>
<Link id="l01217" /><CodeLine lineNumber="1217"><span class="doxyHighlight">          <a href="/docs/api/classes/llvm/instcombiner/#a067e49eb19f14e50f84cf4b4e7f6acde">SQ</a>.getWithInstruction(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)))</span></CodeLine>
<Link id="l01218" /><CodeLine lineNumber="1218"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instcombiner/#a49f1bd0bdf0ef741bdd714cc1188d7c5">replaceInstUsesWith</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, V);</span></CodeLine>
<Link id="l01219" /><CodeLine lineNumber="1219"></CodeLine>
<Link id="l01220" /><CodeLine lineNumber="1220"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> IsRedundant = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01221" /><CodeLine lineNumber="1221"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;unsigned int&gt;</a> FirstIndices = <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getIndices();</span></CodeLine>
<Link id="l01222" /><CodeLine lineNumber="1222"></CodeLine>
<Link id="l01223" /><CodeLine lineNumber="1223"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If there is a chain of insertvalue instructions (each of them except the</span></CodeLine>
<Link id="l01224" /><CodeLine lineNumber="1224"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// last one has only one use and it&#39;s another insertvalue insn from this</span></CodeLine>
<Link id="l01225" /><CodeLine lineNumber="1225"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// chain), check if any of the &#39;children&#39; uses the same indices as the first</span></CodeLine>
<Link id="l01226" /><CodeLine lineNumber="1226"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// instruction. In this case, the first one is redundant.</span></CodeLine>
<Link id="l01227" /><CodeLine lineNumber="1227"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;V = &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l01228" /><CodeLine lineNumber="1228"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06afe578efb7ca235af77fb0eef7edcf639">Depth</a> = 0;</span></CodeLine>
<Link id="l01229" /><CodeLine lineNumber="1229"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">while</span><span class="doxyHighlight"> (V-&gt;hasOneUse() &amp;&amp; <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06afe578efb7ca235af77fb0eef7edcf639">Depth</a> &lt; 10) &#123;</span></CodeLine>
<Link id="l01230" /><CodeLine lineNumber="1230"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/user">User</a> &#42;U = V-&gt;<a href="/docs/api/classes/llvm/value/#a46db903db2484e1ef5062d094d6b0854">user&#95;back</a>();</span></CodeLine>
<Link id="l01231" /><CodeLine lineNumber="1231"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> UserInsInst = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;InsertValueInst&gt;</a>(U);</span></CodeLine>
<Link id="l01232" /><CodeLine lineNumber="1232"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!UserInsInst || U-&gt;getOperand(0) != V)</span></CodeLine>
<Link id="l01233" /><CodeLine lineNumber="1233"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01234" /><CodeLine lineNumber="1234"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (UserInsInst-&gt;getIndices() == FirstIndices) &#123;</span></CodeLine>
<Link id="l01235" /><CodeLine lineNumber="1235"><span class="doxyHighlight">      IsRedundant = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01236" /><CodeLine lineNumber="1236"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01237" /><CodeLine lineNumber="1237"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01238" /><CodeLine lineNumber="1238"><span class="doxyHighlight">    V = UserInsInst;</span></CodeLine>
<Link id="l01239" /><CodeLine lineNumber="1239"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06afe578efb7ca235af77fb0eef7edcf639">Depth</a>++;</span></CodeLine>
<Link id="l01240" /><CodeLine lineNumber="1240"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01241" /><CodeLine lineNumber="1241"></CodeLine>
<Link id="l01242" /><CodeLine lineNumber="1242"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IsRedundant)</span></CodeLine>
<Link id="l01243" /><CodeLine lineNumber="1243"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instcombiner/#a49f1bd0bdf0ef741bdd714cc1188d7c5">replaceInstUsesWith</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getOperand(0));</span></CodeLine>
<Link id="l01244" /><CodeLine lineNumber="1244"></CodeLine>
<Link id="l01245" /><CodeLine lineNumber="1245"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;NewI = <a href="/docs/api/classes/llvm/instcombinerimpl/#acad657182350311f85bc33387733e506">foldAggregateConstructionIntoAggregateReuse</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</span></CodeLine>
<Link id="l01246" /><CodeLine lineNumber="1246"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> NewI;</span></CodeLine>
<Link id="l01247" /><CodeLine lineNumber="1247"></CodeLine>
<Link id="l01248" /><CodeLine lineNumber="1248"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01249" /><CodeLine lineNumber="1249"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01250" /><CodeLine lineNumber="1250"></CodeLine>
<Link id="l01251" /><CodeLine lineNumber="1251" lineLink="#ace7029cdad3163ebfb8172d25e8a59e3"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#ace7029cdad3163ebfb8172d25e8a59e3">isShuffleEquivalentToSelect</a>(<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp;Shuf) &#123;</span></CodeLine>
<Link id="l01252" /><CodeLine lineNumber="1252"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Can not analyze scalable type, the number of elements is not a compile-time</span></CodeLine>
<Link id="l01253" /><CodeLine lineNumber="1253"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// constant.</span></CodeLine>
<Link id="l01254" /><CodeLine lineNumber="1254"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;ScalableVectorType&gt;</a>(Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0)-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>()))</span></CodeLine>
<Link id="l01255" /><CodeLine lineNumber="1255"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01256" /><CodeLine lineNumber="1256"></CodeLine>
<Link id="l01257" /><CodeLine lineNumber="1257"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> MaskSize = Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>().size();</span></CodeLine>
<Link id="l01258" /><CodeLine lineNumber="1258"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> VecSize =</span></CodeLine>
<Link id="l01259" /><CodeLine lineNumber="1259"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0)-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>())-&gt;getNumElements();</span></CodeLine>
<Link id="l01260" /><CodeLine lineNumber="1260"></CodeLine>
<Link id="l01261" /><CodeLine lineNumber="1261"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// A vector select does not change the size of the operands.</span></CodeLine>
<Link id="l01262" /><CodeLine lineNumber="1262"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (MaskSize != VecSize)</span></CodeLine>
<Link id="l01263" /><CodeLine lineNumber="1263"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01264" /><CodeLine lineNumber="1264"></CodeLine>
<Link id="l01265" /><CodeLine lineNumber="1265"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Each mask element must be undefined or choose a vector element from one of</span></CodeLine>
<Link id="l01266" /><CodeLine lineNumber="1266"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the source operands without crossing vector lanes.</span></CodeLine>
<Link id="l01267" /><CodeLine lineNumber="1267"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> i = 0; i != MaskSize; ++i) &#123;</span></CodeLine>
<Link id="l01268" /><CodeLine lineNumber="1268"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> Elt = Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a3fb8619f70f51242f81ef96da349c884">getMaskValue</a>(i);</span></CodeLine>
<Link id="l01269" /><CodeLine lineNumber="1269"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Elt != -1 &amp;&amp; Elt != i &amp;&amp; Elt != i + VecSize)</span></CodeLine>
<Link id="l01270" /><CodeLine lineNumber="1270"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01271" /><CodeLine lineNumber="1271"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01272" /><CodeLine lineNumber="1272"></CodeLine>
<Link id="l01273" /><CodeLine lineNumber="1273"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01274" /><CodeLine lineNumber="1274"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01275" /><CodeLine lineNumber="1275"></CodeLine>
<Link id="l01276" /><CodeLine lineNumber="1276"><span class="doxyHighlightComment">/// Turn a chain of inserts that splats a value into an insert + shuffle:</span></CodeLine>
<Link id="l01277" /><CodeLine lineNumber="1277"><span class="doxyHighlightComment">/// insertelt(insertelt(insertelt(insertelt X, %k, 0), %k, 1), %k, 2) ... -&gt;</span></CodeLine>
<Link id="l01278" /><CodeLine lineNumber="1278"><span class="doxyHighlightComment">/// shufflevector(insertelt(X, %k, 0), poison, zero)</span></CodeLine>
<Link id="l01279" /><CodeLine lineNumber="1279" lineLink="#ad3259dc4dae742caac6c6e4f577d1760"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="#ad3259dc4dae742caac6c6e4f577d1760">foldInsSequenceIntoSplat</a>(<a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &amp;InsElt) &#123;</span></CodeLine>
<Link id="l01280" /><CodeLine lineNumber="1280"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We are interested in the last insert in a chain. So if this insert has a</span></CodeLine>
<Link id="l01281" /><CodeLine lineNumber="1281"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// single user and that user is an insert, bail.</span></CodeLine>
<Link id="l01282" /><CodeLine lineNumber="1282"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (InsElt.<a href="/docs/api/classes/llvm/value/#a3a402430a1bbe70a9282dcb0e0b6a2cd">hasOneUse</a>() &amp;&amp; <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;InsertElementInst&gt;</a>(InsElt.<a href="/docs/api/classes/llvm/instruction/#a6609528bd67d5506a9bf9a2cce2d6f58">user&#95;back</a>()))</span></CodeLine>
<Link id="l01283" /><CodeLine lineNumber="1283"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01284" /><CodeLine lineNumber="1284"></CodeLine>
<Link id="l01285" /><CodeLine lineNumber="1285"><span class="doxyHighlight">  <a href="/docs/api/classes/vectortype">VectorType</a> &#42;VecTy = InsElt.<a href="/docs/api/classes/llvm/insertelementinst/#a49230ece74a48a27fb2bb1a4928b6e29">getType</a>();</span></CodeLine>
<Link id="l01286" /><CodeLine lineNumber="1286"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Can not handle scalable type, the number of elements is not a compile-time</span></CodeLine>
<Link id="l01287" /><CodeLine lineNumber="1287"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// constant.</span></CodeLine>
<Link id="l01288" /><CodeLine lineNumber="1288"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;ScalableVectorType&gt;</a>(VecTy))</span></CodeLine>
<Link id="l01289" /><CodeLine lineNumber="1289"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01290" /><CodeLine lineNumber="1290"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumElements = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(VecTy)-&gt;getNumElements();</span></CodeLine>
<Link id="l01291" /><CodeLine lineNumber="1291"></CodeLine>
<Link id="l01292" /><CodeLine lineNumber="1292"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Do not try to do this for a one-element vector, since that&#39;s a nop,</span></CodeLine>
<Link id="l01293" /><CodeLine lineNumber="1293"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// and will cause an inf-loop.</span></CodeLine>
<Link id="l01294" /><CodeLine lineNumber="1294"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NumElements == 1)</span></CodeLine>
<Link id="l01295" /><CodeLine lineNumber="1295"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01296" /><CodeLine lineNumber="1296"></CodeLine>
<Link id="l01297" /><CodeLine lineNumber="1297"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;SplatVal = InsElt.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1);</span></CodeLine>
<Link id="l01298" /><CodeLine lineNumber="1298"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &#42;CurrIE = &amp;InsElt;</span></CodeLine>
<Link id="l01299" /><CodeLine lineNumber="1299"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallbitvector">SmallBitVector</a> ElementPresent(NumElements, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01300" /><CodeLine lineNumber="1300"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &#42;FirstIE = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01301" /><CodeLine lineNumber="1301"></CodeLine>
<Link id="l01302" /><CodeLine lineNumber="1302"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Walk the chain backwards, keeping track of which indices we inserted into,</span></CodeLine>
<Link id="l01303" /><CodeLine lineNumber="1303"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// until we hit something that isn&#39;t an insert of the splatted value.</span></CodeLine>
<Link id="l01304" /><CodeLine lineNumber="1304"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">while</span><span class="doxyHighlight"> (CurrIE) &#123;</span></CodeLine>
<Link id="l01305" /><CodeLine lineNumber="1305"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Idx = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ConstantInt&gt;</a>(CurrIE-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(2));</span></CodeLine>
<Link id="l01306" /><CodeLine lineNumber="1306"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Idx || CurrIE-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1) != SplatVal)</span></CodeLine>
<Link id="l01307" /><CodeLine lineNumber="1307"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01308" /><CodeLine lineNumber="1308"></CodeLine>
<Link id="l01309" /><CodeLine lineNumber="1309"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NextIE = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;InsertElementInst&gt;</a>(CurrIE-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0));</span></CodeLine>
<Link id="l01310" /><CodeLine lineNumber="1310"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Check none of the intermediate steps have any additional uses, except</span></CodeLine>
<Link id="l01311" /><CodeLine lineNumber="1311"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// for the root insertelement instruction, which can be re-used, if it</span></CodeLine>
<Link id="l01312" /><CodeLine lineNumber="1312"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// inserts at position 0</span></CodeLine>
<Link id="l01313" /><CodeLine lineNumber="1313"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CurrIE != &amp;InsElt &amp;&amp;</span></CodeLine>
<Link id="l01314" /><CodeLine lineNumber="1314"><span class="doxyHighlight">        (!CurrIE-&gt;<a href="/docs/api/classes/llvm/value/#a3a402430a1bbe70a9282dcb0e0b6a2cd">hasOneUse</a>() &amp;&amp; (NextIE != </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight"> || !Idx-&gt;isZero())))</span></CodeLine>
<Link id="l01315" /><CodeLine lineNumber="1315"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01316" /><CodeLine lineNumber="1316"></CodeLine>
<Link id="l01317" /><CodeLine lineNumber="1317"><span class="doxyHighlight">    ElementPresent&#91;Idx-&gt;getZExtValue()&#93; = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01318" /><CodeLine lineNumber="1318"><span class="doxyHighlight">    FirstIE = CurrIE;</span></CodeLine>
<Link id="l01319" /><CodeLine lineNumber="1319"><span class="doxyHighlight">    CurrIE = NextIE;</span></CodeLine>
<Link id="l01320" /><CodeLine lineNumber="1320"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01321" /><CodeLine lineNumber="1321"></CodeLine>
<Link id="l01322" /><CodeLine lineNumber="1322"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If this is just a single insertelement (not a sequence), we are done.</span></CodeLine>
<Link id="l01323" /><CodeLine lineNumber="1323"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FirstIE == &amp;InsElt)</span></CodeLine>
<Link id="l01324" /><CodeLine lineNumber="1324"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01325" /><CodeLine lineNumber="1325"></CodeLine>
<Link id="l01326" /><CodeLine lineNumber="1326"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we are not inserting into a poison vector, make sure we&#39;ve seen an</span></CodeLine>
<Link id="l01327" /><CodeLine lineNumber="1327"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// insert into every element.</span></CodeLine>
<Link id="l01328" /><CodeLine lineNumber="1328"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: If the base vector is not undef, it might be better to create a splat</span></CodeLine>
<Link id="l01329" /><CodeLine lineNumber="1329"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//       and then a select-shuffle (blend) with the base vector.</span></CodeLine>
<Link id="l01330" /><CodeLine lineNumber="1330"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(FirstIE-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0), <a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>()))</span></CodeLine>
<Link id="l01331" /><CodeLine lineNumber="1331"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!ElementPresent.<a href="/docs/api/classes/llvm/smallbitvector/#a8cfcd92a373cdd7deefb939dd76b83e3">all</a>())</span></CodeLine>
<Link id="l01332" /><CodeLine lineNumber="1332"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01333" /><CodeLine lineNumber="1333"></CodeLine>
<Link id="l01334" /><CodeLine lineNumber="1334"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create the insert + shuffle.</span></CodeLine>
<Link id="l01335" /><CodeLine lineNumber="1335"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/type">Type</a> &#42;Int64Ty = <a href="/docs/api/classes/llvm/type/#a05186fa23e4d11b9855a9599ba87a4b7">Type::getInt64Ty</a>(InsElt.<a href="/docs/api/classes/llvm/value/#ab3fc0225d8aaf8434026c3573f961f2c">getContext</a>());</span></CodeLine>
<Link id="l01336" /><CodeLine lineNumber="1336"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/poisonvalue">PoisonValue</a> &#42;PoisonVec = <a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(VecTy);</span></CodeLine>
<Link id="l01337" /><CodeLine lineNumber="1337"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/constant">Constant</a> &#42;Zero = ConstantInt::get(Int64Ty, 0);</span></CodeLine>
<Link id="l01338" /><CodeLine lineNumber="1338"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;ConstantInt&gt;</a>(FirstIE-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(2))-&gt;isZero())</span></CodeLine>
<Link id="l01339" /><CodeLine lineNumber="1339"><span class="doxyHighlight">    FirstIE = <a href="/docs/api/classes/llvm/insertelementinst/#a3c7d92166c1f18129c2727c9dc808b29">InsertElementInst::Create</a>(PoisonVec, SplatVal, Zero, </span><span class="doxyHighlightStringLiteral">&quot;&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l01340" /><CodeLine lineNumber="1340"><span class="doxyHighlight">                                        InsElt.<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>());</span></CodeLine>
<Link id="l01341" /><CodeLine lineNumber="1341"></CodeLine>
<Link id="l01342" /><CodeLine lineNumber="1342"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Splat from element 0, but replace absent elements with poison in the mask.</span></CodeLine>
<Link id="l01343" /><CodeLine lineNumber="1343"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;int, 16&gt;</a> Mask(NumElements, 0);</span></CodeLine>
<Link id="l01344" /><CodeLine lineNumber="1344"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> i = 0; i != NumElements; ++i)</span></CodeLine>
<Link id="l01345" /><CodeLine lineNumber="1345"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!ElementPresent&#91;i&#93;)</span></CodeLine>
<Link id="l01346" /><CodeLine lineNumber="1346"><span class="doxyHighlight">      Mask&#91;i&#93; = -1;</span></CodeLine>
<Link id="l01347" /><CodeLine lineNumber="1347"></CodeLine>
<Link id="l01348" /><CodeLine lineNumber="1348"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a>(FirstIE, Mask);</span></CodeLine>
<Link id="l01349" /><CodeLine lineNumber="1349"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01350" /><CodeLine lineNumber="1350"></CodeLine>
<Link id="l01351" /><CodeLine lineNumber="1351"><span class="doxyHighlightComment">/// Try to fold an insert element into an existing splat shuffle by changing</span></CodeLine>
<Link id="l01352" /><CodeLine lineNumber="1352"><span class="doxyHighlightComment">/// the shuffle&#39;s mask to include the index of this insert element.</span></CodeLine>
<Link id="l01353" /><CodeLine lineNumber="1353" lineLink="#a542a88a5b133e2ac8bd9ceb3f8c77dc9"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="#a542a88a5b133e2ac8bd9ceb3f8c77dc9">foldInsEltIntoSplat</a>(<a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &amp;InsElt) &#123;</span></CodeLine>
<Link id="l01354" /><CodeLine lineNumber="1354"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Check if the vector operand of this insert is a canonical splat shuffle.</span></CodeLine>
<Link id="l01355" /><CodeLine lineNumber="1355"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Shuf = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ShuffleVectorInst&gt;</a>(InsElt.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0));</span></CodeLine>
<Link id="l01356" /><CodeLine lineNumber="1356"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Shuf || !Shuf-&gt;isZeroEltSplat())</span></CodeLine>
<Link id="l01357" /><CodeLine lineNumber="1357"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01358" /><CodeLine lineNumber="1358"></CodeLine>
<Link id="l01359" /><CodeLine lineNumber="1359"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Bail out early if shuffle is scalable type. The number of elements in</span></CodeLine>
<Link id="l01360" /><CodeLine lineNumber="1360"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuffle mask is unknown at compile-time.</span></CodeLine>
<Link id="l01361" /><CodeLine lineNumber="1361"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;ScalableVectorType&gt;</a>(Shuf-&gt;getType()))</span></CodeLine>
<Link id="l01362" /><CodeLine lineNumber="1362"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01363" /><CodeLine lineNumber="1363"></CodeLine>
<Link id="l01364" /><CodeLine lineNumber="1364"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Check for a constant insertion index.</span></CodeLine>
<Link id="l01365" /><CodeLine lineNumber="1365"><span class="doxyHighlight">  uint64&#95;t IdxC;</span></CodeLine>
<Link id="l01366" /><CodeLine lineNumber="1366"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(InsElt.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(2), <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>(IdxC)))</span></CodeLine>
<Link id="l01367" /><CodeLine lineNumber="1367"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01368" /><CodeLine lineNumber="1368"></CodeLine>
<Link id="l01369" /><CodeLine lineNumber="1369"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Check if the splat shuffle&#39;s input is the same as this insert&#39;s scalar op.</span></CodeLine>
<Link id="l01370" /><CodeLine lineNumber="1370"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a> = InsElt.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1);</span></CodeLine>
<Link id="l01371" /><CodeLine lineNumber="1371"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;Op0 = Shuf-&gt;getOperand(0);</span></CodeLine>
<Link id="l01372" /><CodeLine lineNumber="1372"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Op0, <a href="/docs/api/namespaces/llvm/patternmatch/#aec67d7d9e090f41ec66d0d10169a440e">m&#95;InsertElt</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#adea6dc2e42baa345b97be48b0370313d">m&#95;Undef</a>(), <a href="/docs/api/namespaces/llvm/patternmatch/#a2d9861feadd3a09792967a012559e7b2">m&#95;Specific</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>), <a href="/docs/api/namespaces/llvm/patternmatch/#a54d7212b9b2c57cced42037ae2fa7c61">m&#95;ZeroInt</a>())))</span></CodeLine>
<Link id="l01373" /><CodeLine lineNumber="1373"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01374" /><CodeLine lineNumber="1374"></CodeLine>
<Link id="l01375" /><CodeLine lineNumber="1375"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Replace the shuffle mask element at the index of this insert with a zero.</span></CodeLine>
<Link id="l01376" /><CodeLine lineNumber="1376"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For example:</span></CodeLine>
<Link id="l01377" /><CodeLine lineNumber="1377"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// inselt (shuf (inselt undef, X, 0), &#95;, &lt;0,undef,0,undef&gt;), X, 1</span></CodeLine>
<Link id="l01378" /><CodeLine lineNumber="1378"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   --&gt; shuf (inselt undef, X, 0), poison, &lt;0,0,0,undef&gt;</span></CodeLine>
<Link id="l01379" /><CodeLine lineNumber="1379"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumMaskElts =</span></CodeLine>
<Link id="l01380" /><CodeLine lineNumber="1380"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(Shuf-&gt;getType())-&gt;getNumElements();</span></CodeLine>
<Link id="l01381" /><CodeLine lineNumber="1381"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;int, 16&gt;</a> NewMask(NumMaskElts);</span></CodeLine>
<Link id="l01382" /><CodeLine lineNumber="1382"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> i = 0; i != NumMaskElts; ++i)</span></CodeLine>
<Link id="l01383" /><CodeLine lineNumber="1383"><span class="doxyHighlight">    NewMask&#91;i&#93; = i == IdxC ? 0 : Shuf-&gt;getMaskValue(i);</span></CodeLine>
<Link id="l01384" /><CodeLine lineNumber="1384"></CodeLine>
<Link id="l01385" /><CodeLine lineNumber="1385"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a>(Op0, NewMask);</span></CodeLine>
<Link id="l01386" /><CodeLine lineNumber="1386"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01387" /><CodeLine lineNumber="1387"></CodeLine>
<Link id="l01388" /><CodeLine lineNumber="1388"><span class="doxyHighlightComment">/// Try to fold an extract+insert element into an existing identity shuffle by</span></CodeLine>
<Link id="l01389" /><CodeLine lineNumber="1389"><span class="doxyHighlightComment">/// changing the shuffle&#39;s mask to include the index of this insert element.</span></CodeLine>
<Link id="l01390" /><CodeLine lineNumber="1390" lineLink="#ae13bc9134960231b8354f62cfa902782"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="#ae13bc9134960231b8354f62cfa902782">foldInsEltIntoIdentityShuffle</a>(<a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &amp;InsElt) &#123;</span></CodeLine>
<Link id="l01391" /><CodeLine lineNumber="1391"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Check if the vector operand of this insert is an identity shuffle.</span></CodeLine>
<Link id="l01392" /><CodeLine lineNumber="1392"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Shuf = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ShuffleVectorInst&gt;</a>(InsElt.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0));</span></CodeLine>
<Link id="l01393" /><CodeLine lineNumber="1393"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Shuf || !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Shuf-&gt;getOperand(1), <a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>()) ||</span></CodeLine>
<Link id="l01394" /><CodeLine lineNumber="1394"><span class="doxyHighlight">      !(Shuf-&gt;isIdentityWithExtract() || Shuf-&gt;isIdentityWithPadding()))</span></CodeLine>
<Link id="l01395" /><CodeLine lineNumber="1395"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01396" /><CodeLine lineNumber="1396"></CodeLine>
<Link id="l01397" /><CodeLine lineNumber="1397"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Bail out early if shuffle is scalable type. The number of elements in</span></CodeLine>
<Link id="l01398" /><CodeLine lineNumber="1398"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuffle mask is unknown at compile-time.</span></CodeLine>
<Link id="l01399" /><CodeLine lineNumber="1399"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;ScalableVectorType&gt;</a>(Shuf-&gt;getType()))</span></CodeLine>
<Link id="l01400" /><CodeLine lineNumber="1400"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01401" /><CodeLine lineNumber="1401"></CodeLine>
<Link id="l01402" /><CodeLine lineNumber="1402"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Check for a constant insertion index.</span></CodeLine>
<Link id="l01403" /><CodeLine lineNumber="1403"><span class="doxyHighlight">  uint64&#95;t IdxC;</span></CodeLine>
<Link id="l01404" /><CodeLine lineNumber="1404"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(InsElt.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(2), <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>(IdxC)))</span></CodeLine>
<Link id="l01405" /><CodeLine lineNumber="1405"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01406" /><CodeLine lineNumber="1406"></CodeLine>
<Link id="l01407" /><CodeLine lineNumber="1407"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Check if this insert&#39;s scalar op is extracted from the identity shuffle&#39;s</span></CodeLine>
<Link id="l01408" /><CodeLine lineNumber="1408"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// input vector.</span></CodeLine>
<Link id="l01409" /><CodeLine lineNumber="1409"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;Scalar = InsElt.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1);</span></CodeLine>
<Link id="l01410" /><CodeLine lineNumber="1410"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a> = Shuf-&gt;getOperand(0);</span></CodeLine>
<Link id="l01411" /><CodeLine lineNumber="1411"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Scalar, <a href="/docs/api/namespaces/llvm/patternmatch/#a36633f71df7e81c6155619890e65a8b2">m&#95;ExtractElt</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a2d9861feadd3a09792967a012559e7b2">m&#95;Specific</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>), <a href="/docs/api/namespaces/llvm/patternmatch/#a2471be3f1b50002f54bf45c590d8d41b">m&#95;SpecificInt</a>(IdxC))))</span></CodeLine>
<Link id="l01412" /><CodeLine lineNumber="1412"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01413" /><CodeLine lineNumber="1413"></CodeLine>
<Link id="l01414" /><CodeLine lineNumber="1414"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Replace the shuffle mask element at the index of this extract+insert with</span></CodeLine>
<Link id="l01415" /><CodeLine lineNumber="1415"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// that same index value.</span></CodeLine>
<Link id="l01416" /><CodeLine lineNumber="1416"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For example:</span></CodeLine>
<Link id="l01417" /><CodeLine lineNumber="1417"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// inselt (shuf X, IdMask), (extelt X, IdxC), IdxC --&gt; shuf X, IdMask&#39;</span></CodeLine>
<Link id="l01418" /><CodeLine lineNumber="1418"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumMaskElts =</span></CodeLine>
<Link id="l01419" /><CodeLine lineNumber="1419"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(Shuf-&gt;getType())-&gt;getNumElements();</span></CodeLine>
<Link id="l01420" /><CodeLine lineNumber="1420"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;int, 16&gt;</a> NewMask(NumMaskElts);</span></CodeLine>
<Link id="l01421" /><CodeLine lineNumber="1421"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;int&gt;</a> OldMask = Shuf-&gt;getShuffleMask();</span></CodeLine>
<Link id="l01422" /><CodeLine lineNumber="1422"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> i = 0; i != NumMaskElts; ++i) &#123;</span></CodeLine>
<Link id="l01423" /><CodeLine lineNumber="1423"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (i != IdxC) &#123;</span></CodeLine>
<Link id="l01424" /><CodeLine lineNumber="1424"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// All mask elements besides the inserted element remain the same.</span></CodeLine>
<Link id="l01425" /><CodeLine lineNumber="1425"><span class="doxyHighlight">      NewMask&#91;i&#93; = OldMask&#91;i&#93;;</span></CodeLine>
<Link id="l01426" /><CodeLine lineNumber="1426"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (OldMask&#91;i&#93; == (</span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight">)IdxC) &#123;</span></CodeLine>
<Link id="l01427" /><CodeLine lineNumber="1427"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If the mask element was already set, there&#39;s nothing to do</span></CodeLine>
<Link id="l01428" /><CodeLine lineNumber="1428"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// (demanded elements analysis may unset it later).</span></CodeLine>
<Link id="l01429" /><CodeLine lineNumber="1429"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01430" /><CodeLine lineNumber="1430"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l01431" /><CodeLine lineNumber="1431"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(OldMask&#91;i&#93; == <a href="/docs/api/namespaces/llvm/#a9965a6249be879ba3d336a75a4f3efa7">PoisonMaskElem</a> &amp;&amp;</span></CodeLine>
<Link id="l01432" /><CodeLine lineNumber="1432"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;Unexpected shuffle mask element for identity shuffle&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01433" /><CodeLine lineNumber="1433"><span class="doxyHighlight">      NewMask&#91;i&#93; = IdxC;</span></CodeLine>
<Link id="l01434" /><CodeLine lineNumber="1434"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01435" /><CodeLine lineNumber="1435"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01436" /><CodeLine lineNumber="1436"></CodeLine>
<Link id="l01437" /><CodeLine lineNumber="1437"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, Shuf-&gt;getOperand(1), NewMask);</span></CodeLine>
<Link id="l01438" /><CodeLine lineNumber="1438"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01439" /><CodeLine lineNumber="1439"></CodeLine>
<Link id="l01440" /><CodeLine lineNumber="1440"><span class="doxyHighlightComment">/// If we have an insertelement instruction feeding into another insertelement</span></CodeLine>
<Link id="l01441" /><CodeLine lineNumber="1441"><span class="doxyHighlightComment">/// and the 2nd is inserting a constant into the vector, canonicalize that</span></CodeLine>
<Link id="l01442" /><CodeLine lineNumber="1442"><span class="doxyHighlightComment">/// constant insertion before the insertion of a variable:</span></CodeLine>
<Link id="l01443" /><CodeLine lineNumber="1443"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01444" /><CodeLine lineNumber="1444"><span class="doxyHighlightComment">/// insertelement (insertelement X, Y, IdxC1), ScalarC, IdxC2 --&gt;</span></CodeLine>
<Link id="l01445" /><CodeLine lineNumber="1445"><span class="doxyHighlightComment">/// insertelement (insertelement X, ScalarC, IdxC2), Y, IdxC1</span></CodeLine>
<Link id="l01446" /><CodeLine lineNumber="1446"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01447" /><CodeLine lineNumber="1447"><span class="doxyHighlightComment">/// This has the potential of eliminating the 2nd insertelement instruction</span></CodeLine>
<Link id="l01448" /><CodeLine lineNumber="1448"><span class="doxyHighlightComment">/// via constant folding of the scalar constant into a vector constant.</span></CodeLine>
<Link id="l01449" /><CodeLine lineNumber="1449" lineLink="#a9a97530480ce0284bb6dace4356e906c"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="#a9a97530480ce0284bb6dace4356e906c">hoistInsEltConst</a>(<a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &amp;InsElt2,</span></CodeLine>
<Link id="l01450" /><CodeLine lineNumber="1450"><span class="doxyHighlight">                                     <a href="/docs/api/classes/llvm/instcombiner/#a19c4df37b96c2a73991556b696924584">InstCombiner::BuilderTy</a> &amp;Builder) &#123;</span></CodeLine>
<Link id="l01451" /><CodeLine lineNumber="1451"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;InsElt1 = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;InsertElementInst&gt;</a>(InsElt2.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0));</span></CodeLine>
<Link id="l01452" /><CodeLine lineNumber="1452"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!InsElt1 || !InsElt1-&gt;hasOneUse())</span></CodeLine>
<Link id="l01453" /><CodeLine lineNumber="1453"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01454" /><CodeLine lineNumber="1454"></CodeLine>
<Link id="l01455" /><CodeLine lineNumber="1455"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>;</span></CodeLine>
<Link id="l01456" /><CodeLine lineNumber="1456"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/constant">Constant</a> &#42;ScalarC;</span></CodeLine>
<Link id="l01457" /><CodeLine lineNumber="1457"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;IdxC1, &#42;IdxC2;</span></CodeLine>
<Link id="l01458" /><CodeLine lineNumber="1458"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(InsElt1-&gt;getOperand(0), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>)) &amp;&amp;</span></CodeLine>
<Link id="l01459" /><CodeLine lineNumber="1459"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(InsElt1-&gt;getOperand(1), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>)) &amp;&amp; !<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;Constant&gt;</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>) &amp;&amp;</span></CodeLine>
<Link id="l01460" /><CodeLine lineNumber="1460"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(InsElt1-&gt;getOperand(2), <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>(IdxC1)) &amp;&amp;</span></CodeLine>
<Link id="l01461" /><CodeLine lineNumber="1461"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(InsElt2.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1), <a href="/docs/api/namespaces/llvm/patternmatch/#a16be5fe0cce90e51f8c0e0c4d6c589f6">m&#95;Constant</a>(ScalarC)) &amp;&amp;</span></CodeLine>
<Link id="l01462" /><CodeLine lineNumber="1462"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(InsElt2.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(2), <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>(IdxC2)) &amp;&amp; IdxC1 != IdxC2) &#123;</span></CodeLine>
<Link id="l01463" /><CodeLine lineNumber="1463"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;NewInsElt1 = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a17320ebd77e834577a5ebd1063039625">CreateInsertElement</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, ScalarC, IdxC2);</span></CodeLine>
<Link id="l01464" /><CodeLine lineNumber="1464"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/insertelementinst/#a3c7d92166c1f18129c2727c9dc808b29">InsertElementInst::Create</a>(NewInsElt1, <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>, IdxC1);</span></CodeLine>
<Link id="l01465" /><CodeLine lineNumber="1465"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01466" /><CodeLine lineNumber="1466"></CodeLine>
<Link id="l01467" /><CodeLine lineNumber="1467"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01468" /><CodeLine lineNumber="1468"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01469" /><CodeLine lineNumber="1469"></CodeLine>
<Link id="l01470" /><CodeLine lineNumber="1470"><span class="doxyHighlightComment">/// insertelt (shufflevector X, CVec, Mask|insertelt X, C1, CIndex1), C, CIndex</span></CodeLine>
<Link id="l01471" /><CodeLine lineNumber="1471"><span class="doxyHighlightComment">/// --&gt; shufflevector X, CVec&#39;, Mask&#39;</span></CodeLine>
<Link id="l01472" /><CodeLine lineNumber="1472" lineLink="#a01aa2c4724ae9bf421d1cfff3a1c7fa5"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="#a01aa2c4724ae9bf421d1cfff3a1c7fa5">foldConstantInsEltIntoShuffle</a>(<a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &amp;InsElt) &#123;</span></CodeLine>
<Link id="l01473" /><CodeLine lineNumber="1473"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Inst = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(InsElt.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0));</span></CodeLine>
<Link id="l01474" /><CodeLine lineNumber="1474"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Bail out if the parent has more than one use. In that case, we&#39;d be</span></CodeLine>
<Link id="l01475" /><CodeLine lineNumber="1475"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// replacing the insertelt with a shuffle, and that&#39;s not a clear win.</span></CodeLine>
<Link id="l01476" /><CodeLine lineNumber="1476"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Inst || !Inst-&gt;hasOneUse())</span></CodeLine>
<Link id="l01477" /><CodeLine lineNumber="1477"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01478" /><CodeLine lineNumber="1478"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Shuf = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ShuffleVectorInst&gt;</a>(InsElt.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0))) &#123;</span></CodeLine>
<Link id="l01479" /><CodeLine lineNumber="1479"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// The shuffle must have a constant vector operand. The insertelt must have</span></CodeLine>
<Link id="l01480" /><CodeLine lineNumber="1480"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// a constant scalar being inserted at a constant position in the vector.</span></CodeLine>
<Link id="l01481" /><CodeLine lineNumber="1481"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/constant">Constant</a> &#42;ShufConstVec, &#42;InsEltScalar;</span></CodeLine>
<Link id="l01482" /><CodeLine lineNumber="1482"><span class="doxyHighlight">    uint64&#95;t InsEltIndex;</span></CodeLine>
<Link id="l01483" /><CodeLine lineNumber="1483"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Shuf-&gt;getOperand(1), <a href="/docs/api/namespaces/llvm/patternmatch/#a16be5fe0cce90e51f8c0e0c4d6c589f6">m&#95;Constant</a>(ShufConstVec)) ||</span></CodeLine>
<Link id="l01484" /><CodeLine lineNumber="1484"><span class="doxyHighlight">        !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(InsElt.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1), <a href="/docs/api/namespaces/llvm/patternmatch/#a16be5fe0cce90e51f8c0e0c4d6c589f6">m&#95;Constant</a>(InsEltScalar)) ||</span></CodeLine>
<Link id="l01485" /><CodeLine lineNumber="1485"><span class="doxyHighlight">        !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(InsElt.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(2), <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>(InsEltIndex)))</span></CodeLine>
<Link id="l01486" /><CodeLine lineNumber="1486"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01487" /><CodeLine lineNumber="1487"></CodeLine>
<Link id="l01488" /><CodeLine lineNumber="1488"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Adding an element to an arbitrary shuffle could be expensive, but a</span></CodeLine>
<Link id="l01489" /><CodeLine lineNumber="1489"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// shuffle that selects elements from vectors without crossing lanes is</span></CodeLine>
<Link id="l01490" /><CodeLine lineNumber="1490"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// assumed cheap.</span></CodeLine>
<Link id="l01491" /><CodeLine lineNumber="1491"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If we&#39;re just adding a constant into that shuffle, it will still be</span></CodeLine>
<Link id="l01492" /><CodeLine lineNumber="1492"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// cheap.</span></CodeLine>
<Link id="l01493" /><CodeLine lineNumber="1493"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="#ace7029cdad3163ebfb8172d25e8a59e3">isShuffleEquivalentToSelect</a>(&#42;Shuf))</span></CodeLine>
<Link id="l01494" /><CodeLine lineNumber="1494"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01495" /><CodeLine lineNumber="1495"></CodeLine>
<Link id="l01496" /><CodeLine lineNumber="1496"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// From the above &#39;select&#39; check, we know that the mask has the same number</span></CodeLine>
<Link id="l01497" /><CodeLine lineNumber="1497"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// of elements as the vector input operands. We also know that each constant</span></CodeLine>
<Link id="l01498" /><CodeLine lineNumber="1498"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// input element is used in its lane and can not be used more than once by</span></CodeLine>
<Link id="l01499" /><CodeLine lineNumber="1499"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// the shuffle. Therefore, replace the constant in the shuffle&#39;s constant</span></CodeLine>
<Link id="l01500" /><CodeLine lineNumber="1500"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// vector with the insertelt constant. Replace the constant in the shuffle&#39;s</span></CodeLine>
<Link id="l01501" /><CodeLine lineNumber="1501"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// mask vector with the insertelt index plus the length of the vector</span></CodeLine>
<Link id="l01502" /><CodeLine lineNumber="1502"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// (because the constant vector operand of a shuffle is always the 2nd</span></CodeLine>
<Link id="l01503" /><CodeLine lineNumber="1503"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// operand).</span></CodeLine>
<Link id="l01504" /><CodeLine lineNumber="1504"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;int&gt;</a> Mask = Shuf-&gt;getShuffleMask();</span></CodeLine>
<Link id="l01505" /><CodeLine lineNumber="1505"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumElts = Mask.size();</span></CodeLine>
<Link id="l01506" /><CodeLine lineNumber="1506"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Constant &#42;, 16&gt;</a> NewShufElts(NumElts);</span></CodeLine>
<Link id="l01507" /><CodeLine lineNumber="1507"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;int, 16&gt;</a> NewMaskElts(NumElts);</span></CodeLine>
<Link id="l01508" /><CodeLine lineNumber="1508"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = 0; <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> != NumElts; ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &#123;</span></CodeLine>
<Link id="l01509" /><CodeLine lineNumber="1509"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> == InsEltIndex) &#123;</span></CodeLine>
<Link id="l01510" /><CodeLine lineNumber="1510"><span class="doxyHighlight">        NewShufElts&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; = InsEltScalar;</span></CodeLine>
<Link id="l01511" /><CodeLine lineNumber="1511"><span class="doxyHighlight">        NewMaskElts&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; = InsEltIndex + NumElts;</span></CodeLine>
<Link id="l01512" /><CodeLine lineNumber="1512"><span class="doxyHighlight">      &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l01513" /><CodeLine lineNumber="1513"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Copy over the existing values.</span></CodeLine>
<Link id="l01514" /><CodeLine lineNumber="1514"><span class="doxyHighlight">        NewShufElts&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; = ShufConstVec-&gt;<a href="/docs/api/classes/llvm/constant/#acd530d0571f320d47d37e7ae51cf70ff">getAggregateElement</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</span></CodeLine>
<Link id="l01515" /><CodeLine lineNumber="1515"><span class="doxyHighlight">        NewMaskElts&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; = Mask&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93;;</span></CodeLine>
<Link id="l01516" /><CodeLine lineNumber="1516"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01517" /><CodeLine lineNumber="1517"></CodeLine>
<Link id="l01518" /><CodeLine lineNumber="1518"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Bail if we failed to find an element.</span></CodeLine>
<Link id="l01519" /><CodeLine lineNumber="1519"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!NewShufElts&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93;)</span></CodeLine>
<Link id="l01520" /><CodeLine lineNumber="1520"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01521" /><CodeLine lineNumber="1521"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01522" /><CodeLine lineNumber="1522"></CodeLine>
<Link id="l01523" /><CodeLine lineNumber="1523"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Create new operands for a shuffle that includes the constant of the</span></CodeLine>
<Link id="l01524" /><CodeLine lineNumber="1524"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// original insertelt. The old shuffle will be dead now.</span></CodeLine>
<Link id="l01525" /><CodeLine lineNumber="1525"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a>(Shuf-&gt;getOperand(0),</span></CodeLine>
<Link id="l01526" /><CodeLine lineNumber="1526"><span class="doxyHighlight">                                 <a href="/docs/api/classes/llvm/constantvector/#ade9fa017ca3aa82f7694a47090547bc1">ConstantVector::get</a>(NewShufElts), NewMaskElts);</span></CodeLine>
<Link id="l01527" /><CodeLine lineNumber="1527"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;IEI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;InsertElementInst&gt;</a>(Inst)) &#123;</span></CodeLine>
<Link id="l01528" /><CodeLine lineNumber="1528"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Transform sequences of insertelements ops with constant data/indexes into</span></CodeLine>
<Link id="l01529" /><CodeLine lineNumber="1529"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// a single shuffle op.</span></CodeLine>
<Link id="l01530" /><CodeLine lineNumber="1530"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Can not handle scalable type, the number of elements needed to create</span></CodeLine>
<Link id="l01531" /><CodeLine lineNumber="1531"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// shuffle mask is not a compile-time constant.</span></CodeLine>
<Link id="l01532" /><CodeLine lineNumber="1532"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;ScalableVectorType&gt;</a>(InsElt.<a href="/docs/api/classes/llvm/insertelementinst/#a49230ece74a48a27fb2bb1a4928b6e29">getType</a>()))</span></CodeLine>
<Link id="l01533" /><CodeLine lineNumber="1533"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01534" /><CodeLine lineNumber="1534"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumElts =</span></CodeLine>
<Link id="l01535" /><CodeLine lineNumber="1535"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(InsElt.<a href="/docs/api/classes/llvm/insertelementinst/#a49230ece74a48a27fb2bb1a4928b6e29">getType</a>())-&gt;getNumElements();</span></CodeLine>
<Link id="l01536" /><CodeLine lineNumber="1536"></CodeLine>
<Link id="l01537" /><CodeLine lineNumber="1537"><span class="doxyHighlight">    uint64&#95;t InsertIdx&#91;2&#93;;</span></CodeLine>
<Link id="l01538" /><CodeLine lineNumber="1538"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/constant">Constant</a> &#42;Val&#91;2&#93;;</span></CodeLine>
<Link id="l01539" /><CodeLine lineNumber="1539"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(InsElt.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(2), <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>(InsertIdx&#91;0&#93;)) ||</span></CodeLine>
<Link id="l01540" /><CodeLine lineNumber="1540"><span class="doxyHighlight">        !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(InsElt.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1), <a href="/docs/api/namespaces/llvm/patternmatch/#a16be5fe0cce90e51f8c0e0c4d6c589f6">m&#95;Constant</a>(Val&#91;0&#93;)) ||</span></CodeLine>
<Link id="l01541" /><CodeLine lineNumber="1541"><span class="doxyHighlight">        !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(IEI-&gt;getOperand(2), <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>(InsertIdx&#91;1&#93;)) ||</span></CodeLine>
<Link id="l01542" /><CodeLine lineNumber="1542"><span class="doxyHighlight">        !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(IEI-&gt;getOperand(1), <a href="/docs/api/namespaces/llvm/patternmatch/#a16be5fe0cce90e51f8c0e0c4d6c589f6">m&#95;Constant</a>(Val&#91;1&#93;)))</span></CodeLine>
<Link id="l01543" /><CodeLine lineNumber="1543"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01544" /><CodeLine lineNumber="1544"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Constant &#42;, 16&gt;</a> Values(NumElts);</span></CodeLine>
<Link id="l01545" /><CodeLine lineNumber="1545"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;int, 16&gt;</a> Mask(NumElts);</span></CodeLine>
<Link id="l01546" /><CodeLine lineNumber="1546"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> ValI = std::begin(Val);</span></CodeLine>
<Link id="l01547" /><CodeLine lineNumber="1547"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Generate new constant vector and mask.</span></CodeLine>
<Link id="l01548" /><CodeLine lineNumber="1548"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We have 2 values/masks from the insertelements instructions. Insert them</span></CodeLine>
<Link id="l01549" /><CodeLine lineNumber="1549"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// into new value/mask vectors.</span></CodeLine>
<Link id="l01550" /><CodeLine lineNumber="1550"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (uint64&#95;t <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : InsertIdx) &#123;</span></CodeLine>
<Link id="l01551" /><CodeLine lineNumber="1551"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Values&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93;) &#123;</span></CodeLine>
<Link id="l01552" /><CodeLine lineNumber="1552"><span class="doxyHighlight">        Values&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; = &#42;ValI;</span></CodeLine>
<Link id="l01553" /><CodeLine lineNumber="1553"><span class="doxyHighlight">        Mask&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; = NumElts + <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l01554" /><CodeLine lineNumber="1554"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01555" /><CodeLine lineNumber="1555"><span class="doxyHighlight">      ++ValI;</span></CodeLine>
<Link id="l01556" /><CodeLine lineNumber="1556"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01557" /><CodeLine lineNumber="1557"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Remaining values are filled with &#39;poison&#39; values.</span></CodeLine>
<Link id="l01558" /><CodeLine lineNumber="1558"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = 0; <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> &lt; NumElts; ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &#123;</span></CodeLine>
<Link id="l01559" /><CodeLine lineNumber="1559"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Values&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93;) &#123;</span></CodeLine>
<Link id="l01560" /><CodeLine lineNumber="1560"><span class="doxyHighlight">        Values&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; = <a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(InsElt.<a href="/docs/api/classes/llvm/insertelementinst/#a49230ece74a48a27fb2bb1a4928b6e29">getType</a>()-&gt;<a href="/docs/api/classes/llvm/vectortype/#afdce715c901d62e2c1367a0ff5248175">getElementType</a>());</span></CodeLine>
<Link id="l01561" /><CodeLine lineNumber="1561"><span class="doxyHighlight">        Mask&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; = <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l01562" /><CodeLine lineNumber="1562"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01563" /><CodeLine lineNumber="1563"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01564" /><CodeLine lineNumber="1564"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Create new operands for a shuffle that includes the constant of the</span></CodeLine>
<Link id="l01565" /><CodeLine lineNumber="1565"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// original insertelt.</span></CodeLine>
<Link id="l01566" /><CodeLine lineNumber="1566"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a>(IEI-&gt;getOperand(0),</span></CodeLine>
<Link id="l01567" /><CodeLine lineNumber="1567"><span class="doxyHighlight">                                 <a href="/docs/api/classes/llvm/constantvector/#ade9fa017ca3aa82f7694a47090547bc1">ConstantVector::get</a>(Values), Mask);</span></CodeLine>
<Link id="l01568" /><CodeLine lineNumber="1568"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01569" /><CodeLine lineNumber="1569"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01570" /><CodeLine lineNumber="1570"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01571" /><CodeLine lineNumber="1571"></CodeLine>
<Link id="l01572" /><CodeLine lineNumber="1572"><span class="doxyHighlightComment">/// If both the base vector and the inserted element are extended from the same</span></CodeLine>
<Link id="l01573" /><CodeLine lineNumber="1573"><span class="doxyHighlightComment">/// type, do the insert element in the narrow source type followed by extend.</span></CodeLine>
<Link id="l01574" /><CodeLine lineNumber="1574"><span class="doxyHighlightComment">/// TODO: This can be extended to include other cast opcodes, but particularly</span></CodeLine>
<Link id="l01575" /><CodeLine lineNumber="1575"><span class="doxyHighlightComment">///       if we create a wider insertelement, make sure codegen is not harmed.</span></CodeLine>
<Link id="l01576" /><CodeLine lineNumber="1576" lineLink="#acb762c0dfb2a90596163f59e2dfbd029"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="#acb762c0dfb2a90596163f59e2dfbd029">narrowInsElt</a>(<a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &amp;InsElt,</span></CodeLine>
<Link id="l01577" /><CodeLine lineNumber="1577"><span class="doxyHighlight">                                 <a href="/docs/api/classes/llvm/instcombiner/#a19c4df37b96c2a73991556b696924584">InstCombiner::BuilderTy</a> &amp;Builder) &#123;</span></CodeLine>
<Link id="l01578" /><CodeLine lineNumber="1578"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We are creating a vector extend. If the original vector extend has another</span></CodeLine>
<Link id="l01579" /><CodeLine lineNumber="1579"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// use, that would mean we end up with 2 vector extends, so avoid that.</span></CodeLine>
<Link id="l01580" /><CodeLine lineNumber="1580"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: We could ease the use-clause to &quot;if at least one op has one use&quot;</span></CodeLine>
<Link id="l01581" /><CodeLine lineNumber="1581"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//       (assuming that the source types match - see next TODO comment).</span></CodeLine>
<Link id="l01582" /><CodeLine lineNumber="1582"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;Vec = InsElt.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0);</span></CodeLine>
<Link id="l01583" /><CodeLine lineNumber="1583"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Vec-&gt;<a href="/docs/api/classes/llvm/value/#a3a402430a1bbe70a9282dcb0e0b6a2cd">hasOneUse</a>())</span></CodeLine>
<Link id="l01584" /><CodeLine lineNumber="1584"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01585" /><CodeLine lineNumber="1585"></CodeLine>
<Link id="l01586" /><CodeLine lineNumber="1586"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;Scalar = InsElt.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1);</span></CodeLine>
<Link id="l01587" /><CodeLine lineNumber="1587"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>;</span></CodeLine>
<Link id="l01588" /><CodeLine lineNumber="1588"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/instruction/#afa0b2fa29ba074f2b6ec9ac11163f2d9">CastInst::CastOps</a> CastOpcode;</span></CodeLine>
<Link id="l01589" /><CodeLine lineNumber="1589"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Vec, <a href="/docs/api/namespaces/llvm/patternmatch/#a66f6b638df59d75afc83d660a173f53d">m&#95;FPExt</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>))) &amp;&amp; <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Scalar, <a href="/docs/api/namespaces/llvm/patternmatch/#a66f6b638df59d75afc83d660a173f53d">m&#95;FPExt</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>))))</span></CodeLine>
<Link id="l01590" /><CodeLine lineNumber="1590"><span class="doxyHighlight">    CastOpcode = Instruction::FPExt;</span></CodeLine>
<Link id="l01591" /><CodeLine lineNumber="1591"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Vec, <a href="/docs/api/namespaces/llvm/patternmatch/#ae5cf2b09af0c75d08cf9e5e8f2818a66">m&#95;SExt</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>))) &amp;&amp; <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Scalar, <a href="/docs/api/namespaces/llvm/patternmatch/#ae5cf2b09af0c75d08cf9e5e8f2818a66">m&#95;SExt</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>))))</span></CodeLine>
<Link id="l01592" /><CodeLine lineNumber="1592"><span class="doxyHighlight">    CastOpcode = Instruction::SExt;</span></CodeLine>
<Link id="l01593" /><CodeLine lineNumber="1593"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Vec, <a href="/docs/api/namespaces/llvm/patternmatch/#a6ba4022cd30993a84d111871dd0f6ba6">m&#95;ZExt</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>))) &amp;&amp; <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Scalar, <a href="/docs/api/namespaces/llvm/patternmatch/#a6ba4022cd30993a84d111871dd0f6ba6">m&#95;ZExt</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>))))</span></CodeLine>
<Link id="l01594" /><CodeLine lineNumber="1594"><span class="doxyHighlight">    CastOpcode = Instruction::ZExt;</span></CodeLine>
<Link id="l01595" /><CodeLine lineNumber="1595"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l01596" /><CodeLine lineNumber="1596"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01597" /><CodeLine lineNumber="1597"></CodeLine>
<Link id="l01598" /><CodeLine lineNumber="1598"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: We can allow mismatched types by creating an intermediate cast.</span></CodeLine>
<Link id="l01599" /><CodeLine lineNumber="1599"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;getType()-&gt;getScalarType() != <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>-&gt;getType())</span></CodeLine>
<Link id="l01600" /><CodeLine lineNumber="1600"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01601" /><CodeLine lineNumber="1601"></CodeLine>
<Link id="l01602" /><CodeLine lineNumber="1602"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// inselt (ext X), (ext Y), Index --&gt; ext (inselt X, Y, Index)</span></CodeLine>
<Link id="l01603" /><CodeLine lineNumber="1603"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;NewInsElt = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a17320ebd77e834577a5ebd1063039625">CreateInsertElement</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>, InsElt.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(2));</span></CodeLine>
<Link id="l01604" /><CodeLine lineNumber="1604"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/castinst/#ad2e0ab6d7096fe67a2216fe349044387">CastInst::Create</a>(CastOpcode, NewInsElt, InsElt.<a href="/docs/api/classes/llvm/insertelementinst/#a49230ece74a48a27fb2bb1a4928b6e29">getType</a>());</span></CodeLine>
<Link id="l01605" /><CodeLine lineNumber="1605"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01606" /><CodeLine lineNumber="1606"></CodeLine>
<Link id="l01607" /><CodeLine lineNumber="1607"><span class="doxyHighlightComment">/// If we are inserting 2 halves of a value into adjacent elements of a vector,</span></CodeLine>
<Link id="l01608" /><CodeLine lineNumber="1608"><span class="doxyHighlightComment">/// try to convert to a single insert with appropriate bitcasts.</span></CodeLine>
<Link id="l01609" /><CodeLine lineNumber="1609" lineLink="#a1f6c8af64ed18f5f5810f78abf9b4f33"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="#a1f6c8af64ed18f5f5810f78abf9b4f33">foldTruncInsEltPair</a>(<a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &amp;InsElt,</span></CodeLine>
<Link id="l01610" /><CodeLine lineNumber="1610"><span class="doxyHighlight">                                        </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> IsBigEndian,</span></CodeLine>
<Link id="l01611" /><CodeLine lineNumber="1611"><span class="doxyHighlight">                                        <a href="/docs/api/classes/llvm/instcombiner/#a19c4df37b96c2a73991556b696924584">InstCombiner::BuilderTy</a> &amp;Builder) &#123;</span></CodeLine>
<Link id="l01612" /><CodeLine lineNumber="1612"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;VecOp    = InsElt.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0);</span></CodeLine>
<Link id="l01613" /><CodeLine lineNumber="1613"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;ScalarOp = InsElt.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1);</span></CodeLine>
<Link id="l01614" /><CodeLine lineNumber="1614"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;IndexOp  = InsElt.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(2);</span></CodeLine>
<Link id="l01615" /><CodeLine lineNumber="1615"></CodeLine>
<Link id="l01616" /><CodeLine lineNumber="1616"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Pattern depends on endian because we expect lower index is inserted first.</span></CodeLine>
<Link id="l01617" /><CodeLine lineNumber="1617"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Big endian:</span></CodeLine>
<Link id="l01618" /><CodeLine lineNumber="1618"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// inselt (inselt BaseVec, (trunc (lshr X, BW/2), Index0), (trunc X), Index1</span></CodeLine>
<Link id="l01619" /><CodeLine lineNumber="1619"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Little endian:</span></CodeLine>
<Link id="l01620" /><CodeLine lineNumber="1620"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// inselt (inselt BaseVec, (trunc X), Index0), (trunc (lshr X, BW/2)), Index1</span></CodeLine>
<Link id="l01621" /><CodeLine lineNumber="1621"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Note: It is not safe to do this transform with an arbitrary base vector</span></CodeLine>
<Link id="l01622" /><CodeLine lineNumber="1622"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//       because the bitcast of that vector to fewer/larger elements could</span></CodeLine>
<Link id="l01623" /><CodeLine lineNumber="1623"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//       allow poison to spill into an element that was not poison before.</span></CodeLine>
<Link id="l01624" /><CodeLine lineNumber="1624"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: Detect smaller fractions of the scalar.</span></CodeLine>
<Link id="l01625" /><CodeLine lineNumber="1625"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: One-use checks are conservative.</span></CodeLine>
<Link id="l01626" /><CodeLine lineNumber="1626"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;VTy = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;FixedVectorType&gt;</a>(InsElt.<a href="/docs/api/classes/llvm/insertelementinst/#a49230ece74a48a27fb2bb1a4928b6e29">getType</a>());</span></CodeLine>
<Link id="l01627" /><CodeLine lineNumber="1627"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;Scalar0, &#42;BaseVec;</span></CodeLine>
<Link id="l01628" /><CodeLine lineNumber="1628"><span class="doxyHighlight">  uint64&#95;t Index0, Index1;</span></CodeLine>
<Link id="l01629" /><CodeLine lineNumber="1629"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!VTy || (VTy-&gt;getNumElements() &amp; 1) ||</span></CodeLine>
<Link id="l01630" /><CodeLine lineNumber="1630"><span class="doxyHighlight">      !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(IndexOp, <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>(Index1)) ||</span></CodeLine>
<Link id="l01631" /><CodeLine lineNumber="1631"><span class="doxyHighlight">      !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(VecOp, <a href="/docs/api/namespaces/llvm/patternmatch/#aec67d7d9e090f41ec66d0d10169a440e">m&#95;InsertElt</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(BaseVec), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(Scalar0),</span></CodeLine>
<Link id="l01632" /><CodeLine lineNumber="1632"><span class="doxyHighlight">                                <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>(Index0))) ||</span></CodeLine>
<Link id="l01633" /><CodeLine lineNumber="1633"><span class="doxyHighlight">      !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(BaseVec, <a href="/docs/api/namespaces/llvm/patternmatch/#adea6dc2e42baa345b97be48b0370313d">m&#95;Undef</a>()))</span></CodeLine>
<Link id="l01634" /><CodeLine lineNumber="1634"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01635" /><CodeLine lineNumber="1635"></CodeLine>
<Link id="l01636" /><CodeLine lineNumber="1636"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The first insert must be to the index one less than this one, and</span></CodeLine>
<Link id="l01637" /><CodeLine lineNumber="1637"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the first insert must be to an even index.</span></CodeLine>
<Link id="l01638" /><CodeLine lineNumber="1638"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Index0 + 1 != Index1 || Index0 &amp; 1)</span></CodeLine>
<Link id="l01639" /><CodeLine lineNumber="1639"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01640" /><CodeLine lineNumber="1640"></CodeLine>
<Link id="l01641" /><CodeLine lineNumber="1641"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For big endian, the high half of the value should be inserted first.</span></CodeLine>
<Link id="l01642" /><CodeLine lineNumber="1642"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For little endian, the low half of the value should be inserted first.</span></CodeLine>
<Link id="l01643" /><CodeLine lineNumber="1643"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>;</span></CodeLine>
<Link id="l01644" /><CodeLine lineNumber="1644"><span class="doxyHighlight">  uint64&#95;t ShAmt;</span></CodeLine>
<Link id="l01645" /><CodeLine lineNumber="1645"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IsBigEndian) &#123;</span></CodeLine>
<Link id="l01646" /><CodeLine lineNumber="1646"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(ScalarOp, <a href="/docs/api/namespaces/llvm/patternmatch/#a1b8442c10c9ed6e0e07160b54541450e">m&#95;Trunc</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>))) ||</span></CodeLine>
<Link id="l01647" /><CodeLine lineNumber="1647"><span class="doxyHighlight">        !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Scalar0, <a href="/docs/api/namespaces/llvm/patternmatch/#a1b8442c10c9ed6e0e07160b54541450e">m&#95;Trunc</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#ab8546ee1aaa68d6f4990e6241e24464c">m&#95;LShr</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a2d9861feadd3a09792967a012559e7b2">m&#95;Specific</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>), <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>(ShAmt)))))</span></CodeLine>
<Link id="l01648" /><CodeLine lineNumber="1648"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01649" /><CodeLine lineNumber="1649"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l01650" /><CodeLine lineNumber="1650"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Scalar0, <a href="/docs/api/namespaces/llvm/patternmatch/#a1b8442c10c9ed6e0e07160b54541450e">m&#95;Trunc</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>))) ||</span></CodeLine>
<Link id="l01651" /><CodeLine lineNumber="1651"><span class="doxyHighlight">        !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(ScalarOp, <a href="/docs/api/namespaces/llvm/patternmatch/#a1b8442c10c9ed6e0e07160b54541450e">m&#95;Trunc</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#ab8546ee1aaa68d6f4990e6241e24464c">m&#95;LShr</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a2d9861feadd3a09792967a012559e7b2">m&#95;Specific</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>), <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>(ShAmt)))))</span></CodeLine>
<Link id="l01652" /><CodeLine lineNumber="1652"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01653" /><CodeLine lineNumber="1653"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01654" /><CodeLine lineNumber="1654"></CodeLine>
<Link id="l01655" /><CodeLine lineNumber="1655"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/type">Type</a> &#42;SrcTy = <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;getType();</span></CodeLine>
<Link id="l01656" /><CodeLine lineNumber="1656"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> ScalarWidth = SrcTy-&gt;getScalarSizeInBits();</span></CodeLine>
<Link id="l01657" /><CodeLine lineNumber="1657"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> VecEltWidth = VTy-&gt;getScalarSizeInBits();</span></CodeLine>
<Link id="l01658" /><CodeLine lineNumber="1658"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ScalarWidth != VecEltWidth &#42; 2 || ShAmt != VecEltWidth)</span></CodeLine>
<Link id="l01659" /><CodeLine lineNumber="1659"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01660" /><CodeLine lineNumber="1660"></CodeLine>
<Link id="l01661" /><CodeLine lineNumber="1661"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Bitcast the base vector to a vector type with the source element type.</span></CodeLine>
<Link id="l01662" /><CodeLine lineNumber="1662"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/type">Type</a> &#42;CastTy = <a href="/docs/api/classes/llvm/fixedvectortype/#af9a870d5df50fe0133a410b7c9114c80">FixedVectorType::get</a>(SrcTy, VTy-&gt;getNumElements() / 2);</span></CodeLine>
<Link id="l01663" /><CodeLine lineNumber="1663"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;CastBaseVec = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a932f08e32ea37a7019902ee467beb268">CreateBitCast</a>(BaseVec, CastTy);</span></CodeLine>
<Link id="l01664" /><CodeLine lineNumber="1664"></CodeLine>
<Link id="l01665" /><CodeLine lineNumber="1665"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Scale the insert index for a vector with half as many elements.</span></CodeLine>
<Link id="l01666" /><CodeLine lineNumber="1666"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// bitcast (inselt (bitcast BaseVec), X, NewIndex)</span></CodeLine>
<Link id="l01667" /><CodeLine lineNumber="1667"><span class="doxyHighlight">  uint64&#95;t NewIndex = IsBigEndian ? Index1 / 2 : Index0 / 2;</span></CodeLine>
<Link id="l01668" /><CodeLine lineNumber="1668"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;NewInsert = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a17320ebd77e834577a5ebd1063039625">CreateInsertElement</a>(CastBaseVec, <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, NewIndex);</span></CodeLine>
<Link id="l01669" /><CodeLine lineNumber="1669"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/bitcastinst">BitCastInst</a>(NewInsert, VTy);</span></CodeLine>
<Link id="l01670" /><CodeLine lineNumber="1670"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01671" /><CodeLine lineNumber="1671"></CodeLine>
<Link id="l01672" /><CodeLine lineNumber="1672" lineLink="/docs/api/classes/llvm/instcombinerimpl/#a687fa4390149f0cb751d8ad89dca6a3c"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/classes/llvm/instcombinerimpl/#a687fa4390149f0cb751d8ad89dca6a3c">InstCombinerImpl::visitInsertElementInst</a>(<a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &amp;IE) &#123;</span></CodeLine>
<Link id="l01673" /><CodeLine lineNumber="1673"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;VecOp    = IE.getOperand(0);</span></CodeLine>
<Link id="l01674" /><CodeLine lineNumber="1674"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;ScalarOp = IE.getOperand(1);</span></CodeLine>
<Link id="l01675" /><CodeLine lineNumber="1675"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;IdxOp    = IE.getOperand(2);</span></CodeLine>
<Link id="l01676" /><CodeLine lineNumber="1676"></CodeLine>
<Link id="l01677" /><CodeLine lineNumber="1677"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;V = <a href="/docs/api/namespaces/llvm/#abdf4b5f9e1dc6887cac393ee643c10b6">simplifyInsertElementInst</a>(</span></CodeLine>
<Link id="l01678" /><CodeLine lineNumber="1678"><span class="doxyHighlight">          VecOp, ScalarOp, IdxOp, <a href="/docs/api/classes/llvm/instcombiner/#a067e49eb19f14e50f84cf4b4e7f6acde">SQ</a>.getWithInstruction(&amp;IE)))</span></CodeLine>
<Link id="l01679" /><CodeLine lineNumber="1679"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instcombiner/#a49f1bd0bdf0ef741bdd714cc1188d7c5">replaceInstUsesWith</a>(IE, V);</span></CodeLine>
<Link id="l01680" /><CodeLine lineNumber="1680"></CodeLine>
<Link id="l01681" /><CodeLine lineNumber="1681"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Canonicalize type of constant indices to i64 to simplify CSE</span></CodeLine>
<Link id="l01682" /><CodeLine lineNumber="1682"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;IndexC = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ConstantInt&gt;</a>(IdxOp)) &#123;</span></CodeLine>
<Link id="l01683" /><CodeLine lineNumber="1683"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewIdx = <a href="#ae67d970cf80e86c5789e52f9d57d0c70">getPreferredVectorIndex</a>(IndexC))</span></CodeLine>
<Link id="l01684" /><CodeLine lineNumber="1684"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instcombiner/#ac2a56636a6f3742f5e495f67e67b6b36">replaceOperand</a>(IE, 2, NewIdx);</span></CodeLine>
<Link id="l01685" /><CodeLine lineNumber="1685"></CodeLine>
<Link id="l01686" /><CodeLine lineNumber="1686"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;BaseVec, &#42;OtherScalar;</span></CodeLine>
<Link id="l01687" /><CodeLine lineNumber="1687"><span class="doxyHighlight">    uint64&#95;t OtherIndexVal;</span></CodeLine>
<Link id="l01688" /><CodeLine lineNumber="1688"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(VecOp, <a href="/docs/api/namespaces/llvm/patternmatch/#a5be13f3abb6bddf7ad9747b077da5a0e">m&#95;OneUse</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aec67d7d9e090f41ec66d0d10169a440e">m&#95;InsertElt</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(BaseVec),</span></CodeLine>
<Link id="l01689" /><CodeLine lineNumber="1689"><span class="doxyHighlight">                                          <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(OtherScalar),</span></CodeLine>
<Link id="l01690" /><CodeLine lineNumber="1690"><span class="doxyHighlight">                                          <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>(OtherIndexVal)))) &amp;&amp;</span></CodeLine>
<Link id="l01691" /><CodeLine lineNumber="1691"><span class="doxyHighlight">        !<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;Constant&gt;</a>(OtherScalar) &amp;&amp; OtherIndexVal &gt; IndexC-&gt;getZExtValue()) &#123;</span></CodeLine>
<Link id="l01692" /><CodeLine lineNumber="1692"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;NewIns = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateInsertElement(BaseVec, ScalarOp, IdxOp);</span></CodeLine>
<Link id="l01693" /><CodeLine lineNumber="1693"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/insertelementinst/#a3c7d92166c1f18129c2727c9dc808b29">InsertElementInst::Create</a>(NewIns, OtherScalar,</span></CodeLine>
<Link id="l01694" /><CodeLine lineNumber="1694"><span class="doxyHighlight">                                       <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.getInt64(OtherIndexVal));</span></CodeLine>
<Link id="l01695" /><CodeLine lineNumber="1695"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01696" /><CodeLine lineNumber="1696"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01697" /><CodeLine lineNumber="1697"></CodeLine>
<Link id="l01698" /><CodeLine lineNumber="1698"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the scalar is bitcast and inserted into undef, do the insert in the</span></CodeLine>
<Link id="l01699" /><CodeLine lineNumber="1699"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// source type followed by bitcast.</span></CodeLine>
<Link id="l01700" /><CodeLine lineNumber="1700"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: Generalize for insert into any constant, not just undef?</span></CodeLine>
<Link id="l01701" /><CodeLine lineNumber="1701"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;ScalarSrc;</span></CodeLine>
<Link id="l01702" /><CodeLine lineNumber="1702"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(VecOp, <a href="/docs/api/namespaces/llvm/patternmatch/#adea6dc2e42baa345b97be48b0370313d">m&#95;Undef</a>()) &amp;&amp;</span></CodeLine>
<Link id="l01703" /><CodeLine lineNumber="1703"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(ScalarOp, <a href="/docs/api/namespaces/llvm/patternmatch/#a5be13f3abb6bddf7ad9747b077da5a0e">m&#95;OneUse</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a99d8e67ed2343ad6717d7a8fdd3e7c7a">m&#95;BitCast</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(ScalarSrc)))) &amp;&amp;</span></CodeLine>
<Link id="l01704" /><CodeLine lineNumber="1704"><span class="doxyHighlight">      (ScalarSrc-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>()-&gt;<a href="/docs/api/classes/llvm/type/#ac6d28a9b11139182134a9618028a0d07">isIntegerTy</a>() ||</span></CodeLine>
<Link id="l01705" /><CodeLine lineNumber="1705"><span class="doxyHighlight">       ScalarSrc-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>()-&gt;<a href="/docs/api/classes/llvm/type/#aac5759c83abd6a4af236401a7cfe7a0f">isFloatingPointTy</a>())) &#123;</span></CodeLine>
<Link id="l01706" /><CodeLine lineNumber="1706"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// inselt undef, (bitcast ScalarSrc), IdxOp --&gt;</span></CodeLine>
<Link id="l01707" /><CodeLine lineNumber="1707"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//   bitcast (inselt undef, ScalarSrc, IdxOp)</span></CodeLine>
<Link id="l01708" /><CodeLine lineNumber="1708"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/type">Type</a> &#42;ScalarTy = ScalarSrc-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>();</span></CodeLine>
<Link id="l01709" /><CodeLine lineNumber="1709"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/type">Type</a> &#42;VecTy = <a href="/docs/api/classes/llvm/vectortype/#a861be1e2092622462053c6d31dddbfd5">VectorType::get</a>(ScalarTy, IE.getType()-&gt;getElementCount());</span></CodeLine>
<Link id="l01710" /><CodeLine lineNumber="1710"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/constant">Constant</a> &#42;NewUndef = <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;PoisonValue&gt;</a>(VecOp) ? <a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(VecTy)</span></CodeLine>
<Link id="l01711" /><CodeLine lineNumber="1711"><span class="doxyHighlight">                                                 : <a href="/docs/api/classes/llvm/undefvalue/#a4ae5ff22b700a42bcc5d889233721335">UndefValue::get</a>(VecTy);</span></CodeLine>
<Link id="l01712" /><CodeLine lineNumber="1712"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;NewInsElt = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateInsertElement(NewUndef, ScalarSrc, IdxOp);</span></CodeLine>
<Link id="l01713" /><CodeLine lineNumber="1713"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/bitcastinst">BitCastInst</a>(NewInsElt, IE.getType());</span></CodeLine>
<Link id="l01714" /><CodeLine lineNumber="1714"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01715" /><CodeLine lineNumber="1715"></CodeLine>
<Link id="l01716" /><CodeLine lineNumber="1716"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the vector and scalar are both bitcast from the same element type, do</span></CodeLine>
<Link id="l01717" /><CodeLine lineNumber="1717"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the insert in that source type followed by bitcast.</span></CodeLine>
<Link id="l01718" /><CodeLine lineNumber="1718"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;VecSrc;</span></CodeLine>
<Link id="l01719" /><CodeLine lineNumber="1719"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(VecOp, <a href="/docs/api/namespaces/llvm/patternmatch/#a99d8e67ed2343ad6717d7a8fdd3e7c7a">m&#95;BitCast</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(VecSrc))) &amp;&amp;</span></CodeLine>
<Link id="l01720" /><CodeLine lineNumber="1720"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(ScalarOp, <a href="/docs/api/namespaces/llvm/patternmatch/#a99d8e67ed2343ad6717d7a8fdd3e7c7a">m&#95;BitCast</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(ScalarSrc))) &amp;&amp;</span></CodeLine>
<Link id="l01721" /><CodeLine lineNumber="1721"><span class="doxyHighlight">      (VecOp-&gt;<a href="/docs/api/classes/llvm/value/#a3a402430a1bbe70a9282dcb0e0b6a2cd">hasOneUse</a>() || ScalarOp-&gt;<a href="/docs/api/classes/llvm/value/#a3a402430a1bbe70a9282dcb0e0b6a2cd">hasOneUse</a>()) &amp;&amp;</span></CodeLine>
<Link id="l01722" /><CodeLine lineNumber="1722"><span class="doxyHighlight">      VecSrc-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>()-&gt;<a href="/docs/api/classes/llvm/type/#a1bc022868b23918efa44df511f4d5b61">isVectorTy</a>() &amp;&amp; !ScalarSrc-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>()-&gt;<a href="/docs/api/classes/llvm/type/#a1bc022868b23918efa44df511f4d5b61">isVectorTy</a>() &amp;&amp;</span></CodeLine>
<Link id="l01723" /><CodeLine lineNumber="1723"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;VectorType&gt;</a>(VecSrc-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>())-&gt;getElementType() ==</span></CodeLine>
<Link id="l01724" /><CodeLine lineNumber="1724"><span class="doxyHighlight">          ScalarSrc-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>()) &#123;</span></CodeLine>
<Link id="l01725" /><CodeLine lineNumber="1725"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// inselt (bitcast VecSrc), (bitcast ScalarSrc), IdxOp --&gt;</span></CodeLine>
<Link id="l01726" /><CodeLine lineNumber="1726"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//   bitcast (inselt VecSrc, ScalarSrc, IdxOp)</span></CodeLine>
<Link id="l01727" /><CodeLine lineNumber="1727"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;NewInsElt = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateInsertElement(VecSrc, ScalarSrc, IdxOp);</span></CodeLine>
<Link id="l01728" /><CodeLine lineNumber="1728"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/bitcastinst">BitCastInst</a>(NewInsElt, IE.getType());</span></CodeLine>
<Link id="l01729" /><CodeLine lineNumber="1729"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01730" /><CodeLine lineNumber="1730"></CodeLine>
<Link id="l01731" /><CodeLine lineNumber="1731"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the inserted element was extracted from some other fixed-length vector</span></CodeLine>
<Link id="l01732" /><CodeLine lineNumber="1732"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// and both indexes are valid constants, try to turn this into a shuffle.</span></CodeLine>
<Link id="l01733" /><CodeLine lineNumber="1733"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Can not handle scalable vector type, the number of elements needed to</span></CodeLine>
<Link id="l01734" /><CodeLine lineNumber="1734"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// create shuffle mask is not a compile-time constant.</span></CodeLine>
<Link id="l01735" /><CodeLine lineNumber="1735"><span class="doxyHighlight">  uint64&#95;t InsertedIdx, ExtractedIdx;</span></CodeLine>
<Link id="l01736" /><CodeLine lineNumber="1736"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;ExtVecOp;</span></CodeLine>
<Link id="l01737" /><CodeLine lineNumber="1737"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;FixedVectorType&gt;</a>(IE.getType()) &amp;&amp;</span></CodeLine>
<Link id="l01738" /><CodeLine lineNumber="1738"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(IdxOp, <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>(InsertedIdx)) &amp;&amp;</span></CodeLine>
<Link id="l01739" /><CodeLine lineNumber="1739"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(ScalarOp,</span></CodeLine>
<Link id="l01740" /><CodeLine lineNumber="1740"><span class="doxyHighlight">            <a href="/docs/api/namespaces/llvm/patternmatch/#a36633f71df7e81c6155619890e65a8b2">m&#95;ExtractElt</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(ExtVecOp), <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>(ExtractedIdx))) &amp;&amp;</span></CodeLine>
<Link id="l01741" /><CodeLine lineNumber="1741"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;FixedVectorType&gt;</a>(ExtVecOp-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>()) &amp;&amp;</span></CodeLine>
<Link id="l01742" /><CodeLine lineNumber="1742"><span class="doxyHighlight">      ExtractedIdx &lt;</span></CodeLine>
<Link id="l01743" /><CodeLine lineNumber="1743"><span class="doxyHighlight">          <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(ExtVecOp-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>())-&gt;getNumElements()) &#123;</span></CodeLine>
<Link id="l01744" /><CodeLine lineNumber="1744"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// TODO: Looking at the user(s) to determine if this insert is a</span></CodeLine>
<Link id="l01745" /><CodeLine lineNumber="1745"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// fold-to-shuffle opportunity does not match the usual instcombine</span></CodeLine>
<Link id="l01746" /><CodeLine lineNumber="1746"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// constraints. We should decide if the transform is worthy based only</span></CodeLine>
<Link id="l01747" /><CodeLine lineNumber="1747"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// on this instruction and its operands, but that may not work currently.</span></CodeLine>
<Link id="l01748" /><CodeLine lineNumber="1748"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01749" /><CodeLine lineNumber="1749"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Here, we are trying to avoid creating shuffles before reaching</span></CodeLine>
<Link id="l01750" /><CodeLine lineNumber="1750"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// the end of a chain of extract-insert pairs. This is complicated because</span></CodeLine>
<Link id="l01751" /><CodeLine lineNumber="1751"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// we do not generally form arbitrary shuffle masks in instcombine</span></CodeLine>
<Link id="l01752" /><CodeLine lineNumber="1752"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// (because those may codegen poorly), but collectShuffleElements() does</span></CodeLine>
<Link id="l01753" /><CodeLine lineNumber="1753"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// exactly that.</span></CodeLine>
<Link id="l01754" /><CodeLine lineNumber="1754"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01755" /><CodeLine lineNumber="1755"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// The rules for determining what is an acceptable target-independent</span></CodeLine>
<Link id="l01756" /><CodeLine lineNumber="1756"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// shuffle mask are fuzzy because they evolve based on the backend&#39;s</span></CodeLine>
<Link id="l01757" /><CodeLine lineNumber="1757"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// capabilities and real-world impact.</span></CodeLine>
<Link id="l01758" /><CodeLine lineNumber="1758"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> isShuffleRootCandidate = &#91;&#93;(<a href="/docs/api/classes/llvm/insertelementinst">InsertElementInst</a> &amp;Insert) &#123;</span></CodeLine>
<Link id="l01759" /><CodeLine lineNumber="1759"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Insert.hasOneUse())</span></CodeLine>
<Link id="l01760" /><CodeLine lineNumber="1760"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01761" /><CodeLine lineNumber="1761"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;InsertUser = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;InsertElementInst&gt;</a>(Insert.user&#95;back());</span></CodeLine>
<Link id="l01762" /><CodeLine lineNumber="1762"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!InsertUser)</span></CodeLine>
<Link id="l01763" /><CodeLine lineNumber="1763"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01764" /><CodeLine lineNumber="1764"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01765" /><CodeLine lineNumber="1765"><span class="doxyHighlight">    &#125;;</span></CodeLine>
<Link id="l01766" /><CodeLine lineNumber="1766"></CodeLine>
<Link id="l01767" /><CodeLine lineNumber="1767"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Try to form a shuffle from a chain of extract-insert ops.</span></CodeLine>
<Link id="l01768" /><CodeLine lineNumber="1768"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (isShuffleRootCandidate(IE)) &#123;</span></CodeLine>
<Link id="l01769" /><CodeLine lineNumber="1769"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> Rerun = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01770" /><CodeLine lineNumber="1770"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">while</span><span class="doxyHighlight"> (Rerun) &#123;</span></CodeLine>
<Link id="l01771" /><CodeLine lineNumber="1771"><span class="doxyHighlight">        Rerun = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01772" /><CodeLine lineNumber="1772"></CodeLine>
<Link id="l01773" /><CodeLine lineNumber="1773"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;int, 16&gt;</a> Mask;</span></CodeLine>
<Link id="l01774" /><CodeLine lineNumber="1774"><span class="doxyHighlight">        <a href="#a5ef308f5547e4c1a6dfe646dd7ea7abc">ShuffleOps</a> LR =</span></CodeLine>
<Link id="l01775" /><CodeLine lineNumber="1775"><span class="doxyHighlight">            <a href="#a1e502a1ec39cc64d6b86e9e68b29be89">collectShuffleElements</a>(&amp;IE, Mask, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">, &#42;</span><span class="doxyHighlightKeyword">this</span><span class="doxyHighlight">, Rerun);</span></CodeLine>
<Link id="l01776" /><CodeLine lineNumber="1776"></CodeLine>
<Link id="l01777" /><CodeLine lineNumber="1777"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// The proposed shuffle may be trivial, in which case we shouldn&#39;t</span></CodeLine>
<Link id="l01778" /><CodeLine lineNumber="1778"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// perform the combine.</span></CodeLine>
<Link id="l01779" /><CodeLine lineNumber="1779"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LR.first != &amp;IE &amp;&amp; LR.second != &amp;IE) &#123;</span></CodeLine>
<Link id="l01780" /><CodeLine lineNumber="1780"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// We now have a shuffle of LHS, RHS, Mask.</span></CodeLine>
<Link id="l01781" /><CodeLine lineNumber="1781"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LR.second == </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l01782" /><CodeLine lineNumber="1782"><span class="doxyHighlight">            LR.second = <a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(LR.first-&gt;getType());</span></CodeLine>
<Link id="l01783" /><CodeLine lineNumber="1783"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a>(LR.first, LR.second, Mask);</span></CodeLine>
<Link id="l01784" /><CodeLine lineNumber="1784"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l01785" /><CodeLine lineNumber="1785"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01786" /><CodeLine lineNumber="1786"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01787" /><CodeLine lineNumber="1787"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01788" /><CodeLine lineNumber="1788"></CodeLine>
<Link id="l01789" /><CodeLine lineNumber="1789"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> VecTy = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;FixedVectorType&gt;</a>(VecOp-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>())) &#123;</span></CodeLine>
<Link id="l01790" /><CodeLine lineNumber="1790"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> VWidth = VecTy-&gt;getNumElements();</span></CodeLine>
<Link id="l01791" /><CodeLine lineNumber="1791"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/apint">APInt</a> PoisonElts(VWidth, 0);</span></CodeLine>
<Link id="l01792" /><CodeLine lineNumber="1792"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/apint">APInt</a> AllOnesEltMask(<a href="/docs/api/classes/llvm/apint/#a071e8d814b2b30b02544fad964227b8e">APInt::getAllOnes</a>(VWidth));</span></CodeLine>
<Link id="l01793" /><CodeLine lineNumber="1793"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/value">Value</a> &#42;V = <a href="/docs/api/classes/llvm/instcombinerimpl/#a37cce7aa1875173688e5971c5d6fa9e0">SimplifyDemandedVectorElts</a>(&amp;IE, AllOnesEltMask,</span></CodeLine>
<Link id="l01794" /><CodeLine lineNumber="1794"><span class="doxyHighlight">                                              PoisonElts)) &#123;</span></CodeLine>
<Link id="l01795" /><CodeLine lineNumber="1795"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (V != &amp;IE)</span></CodeLine>
<Link id="l01796" /><CodeLine lineNumber="1796"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instcombiner/#a49f1bd0bdf0ef741bdd714cc1188d7c5">replaceInstUsesWith</a>(IE, V);</span></CodeLine>
<Link id="l01797" /><CodeLine lineNumber="1797"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &amp;IE;</span></CodeLine>
<Link id="l01798" /><CodeLine lineNumber="1798"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01799" /><CodeLine lineNumber="1799"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01800" /><CodeLine lineNumber="1800"></CodeLine>
<Link id="l01801" /><CodeLine lineNumber="1801"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Shuf = <a href="#a01aa2c4724ae9bf421d1cfff3a1c7fa5">foldConstantInsEltIntoShuffle</a>(IE))</span></CodeLine>
<Link id="l01802" /><CodeLine lineNumber="1802"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Shuf;</span></CodeLine>
<Link id="l01803" /><CodeLine lineNumber="1803"></CodeLine>
<Link id="l01804" /><CodeLine lineNumber="1804"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;NewInsElt = <a href="#a9a97530480ce0284bb6dace4356e906c">hoistInsEltConst</a>(IE, <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>))</span></CodeLine>
<Link id="l01805" /><CodeLine lineNumber="1805"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> NewInsElt;</span></CodeLine>
<Link id="l01806" /><CodeLine lineNumber="1806"></CodeLine>
<Link id="l01807" /><CodeLine lineNumber="1807"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Broadcast = <a href="#ad3259dc4dae742caac6c6e4f577d1760">foldInsSequenceIntoSplat</a>(IE))</span></CodeLine>
<Link id="l01808" /><CodeLine lineNumber="1808"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Broadcast;</span></CodeLine>
<Link id="l01809" /><CodeLine lineNumber="1809"></CodeLine>
<Link id="l01810" /><CodeLine lineNumber="1810"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/namespaces/llvm/#a766456df1dd21e804cd4596304e10764a5b9bf50c6579a978e5c1104bf8787651">Splat</a> = <a href="#a542a88a5b133e2ac8bd9ceb3f8c77dc9">foldInsEltIntoSplat</a>(IE))</span></CodeLine>
<Link id="l01811" /><CodeLine lineNumber="1811"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/#a766456df1dd21e804cd4596304e10764a5b9bf50c6579a978e5c1104bf8787651">Splat</a>;</span></CodeLine>
<Link id="l01812" /><CodeLine lineNumber="1812"></CodeLine>
<Link id="l01813" /><CodeLine lineNumber="1813"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;IdentityShuf = <a href="#ae13bc9134960231b8354f62cfa902782">foldInsEltIntoIdentityShuffle</a>(IE))</span></CodeLine>
<Link id="l01814" /><CodeLine lineNumber="1814"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> IdentityShuf;</span></CodeLine>
<Link id="l01815" /><CodeLine lineNumber="1815"></CodeLine>
<Link id="l01816" /><CodeLine lineNumber="1816"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Ext = <a href="#acb762c0dfb2a90596163f59e2dfbd029">narrowInsElt</a>(IE, <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>))</span></CodeLine>
<Link id="l01817" /><CodeLine lineNumber="1817"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Ext;</span></CodeLine>
<Link id="l01818" /><CodeLine lineNumber="1818"></CodeLine>
<Link id="l01819" /><CodeLine lineNumber="1819"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Ext = <a href="#a1f6c8af64ed18f5f5810f78abf9b4f33">foldTruncInsEltPair</a>(IE, <a href="/docs/api/classes/llvm/instcombiner/#a878e8128a9a4e5626df91dcd91cba337">DL</a>.isBigEndian(), <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>))</span></CodeLine>
<Link id="l01820" /><CodeLine lineNumber="1820"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Ext;</span></CodeLine>
<Link id="l01821" /><CodeLine lineNumber="1821"></CodeLine>
<Link id="l01822" /><CodeLine lineNumber="1822"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01823" /><CodeLine lineNumber="1823"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01824" /><CodeLine lineNumber="1824"></CodeLine>
<Link id="l01825" /><CodeLine lineNumber="1825"><span class="doxyHighlightComment">/// Return true if we can evaluate the specified expression tree if the vector</span></CodeLine>
<Link id="l01826" /><CodeLine lineNumber="1826"><span class="doxyHighlightComment">/// elements were shuffled in a different order.</span></CodeLine>
<Link id="l01827" /><CodeLine lineNumber="1827" lineLink="#a95fd07ca61f35098e091aa2329f9c8a6"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#a95fd07ca61f35098e091aa2329f9c8a6">canEvaluateShuffled</a>(<a href="/docs/api/classes/llvm/value">Value</a> &#42;V, <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;int&gt;</a> Mask,</span></CodeLine>
<Link id="l01828" /><CodeLine lineNumber="1828"><span class="doxyHighlight">                                </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06afe578efb7ca235af77fb0eef7edcf639">Depth</a> = 5) &#123;</span></CodeLine>
<Link id="l01829" /><CodeLine lineNumber="1829"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We can always reorder the elements of a constant.</span></CodeLine>
<Link id="l01830" /><CodeLine lineNumber="1830"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;Constant&gt;</a>(V))</span></CodeLine>
<Link id="l01831" /><CodeLine lineNumber="1831"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01832" /><CodeLine lineNumber="1832"></CodeLine>
<Link id="l01833" /><CodeLine lineNumber="1833"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We won&#39;t reorder vector arguments. No IPO here.</span></CodeLine>
<Link id="l01834" /><CodeLine lineNumber="1834"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(V);</span></CodeLine>
<Link id="l01835" /><CodeLine lineNumber="1835"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01836" /><CodeLine lineNumber="1836"></CodeLine>
<Link id="l01837" /><CodeLine lineNumber="1837"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Two users may expect different orders of the elements. Don&#39;t try it.</span></CodeLine>
<Link id="l01838" /><CodeLine lineNumber="1838"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;hasOneUse())</span></CodeLine>
<Link id="l01839" /><CodeLine lineNumber="1839"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01840" /><CodeLine lineNumber="1840"></CodeLine>
<Link id="l01841" /><CodeLine lineNumber="1841"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06afe578efb7ca235af77fb0eef7edcf639">Depth</a> == 0) </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01842" /><CodeLine lineNumber="1842"></CodeLine>
<Link id="l01843" /><CodeLine lineNumber="1843"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOpcode()) &#123;</span></CodeLine>
<Link id="l01844" /><CodeLine lineNumber="1844"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::UDiv:</span></CodeLine>
<Link id="l01845" /><CodeLine lineNumber="1845"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::SDiv:</span></CodeLine>
<Link id="l01846" /><CodeLine lineNumber="1846"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::URem:</span></CodeLine>
<Link id="l01847" /><CodeLine lineNumber="1847"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::SRem:</span></CodeLine>
<Link id="l01848" /><CodeLine lineNumber="1848"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Propagating an undefined shuffle mask element to integer div/rem is not</span></CodeLine>
<Link id="l01849" /><CodeLine lineNumber="1849"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// allowed because those opcodes can create immediate undefined behavior</span></CodeLine>
<Link id="l01850" /><CodeLine lineNumber="1850"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// from an undefined element in an operand.</span></CodeLine>
<Link id="l01851" /><CodeLine lineNumber="1851"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#acd1cd968cb420c82d70926920fcdc7d7">llvm::is&#95;contained</a>(Mask, -1))</span></CodeLine>
<Link id="l01852" /><CodeLine lineNumber="1852"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01853" /><CodeLine lineNumber="1853"><span class="doxyHighlight">      &#91;&#91;fallthrough&#93;&#93;;</span></CodeLine>
<Link id="l01854" /><CodeLine lineNumber="1854"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Add:</span></CodeLine>
<Link id="l01855" /><CodeLine lineNumber="1855"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FAdd:</span></CodeLine>
<Link id="l01856" /><CodeLine lineNumber="1856"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Sub:</span></CodeLine>
<Link id="l01857" /><CodeLine lineNumber="1857"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FSub:</span></CodeLine>
<Link id="l01858" /><CodeLine lineNumber="1858"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Mul:</span></CodeLine>
<Link id="l01859" /><CodeLine lineNumber="1859"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FMul:</span></CodeLine>
<Link id="l01860" /><CodeLine lineNumber="1860"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FDiv:</span></CodeLine>
<Link id="l01861" /><CodeLine lineNumber="1861"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FRem:</span></CodeLine>
<Link id="l01862" /><CodeLine lineNumber="1862"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Shl:</span></CodeLine>
<Link id="l01863" /><CodeLine lineNumber="1863"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::LShr:</span></CodeLine>
<Link id="l01864" /><CodeLine lineNumber="1864"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::AShr:</span></CodeLine>
<Link id="l01865" /><CodeLine lineNumber="1865"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::And:</span></CodeLine>
<Link id="l01866" /><CodeLine lineNumber="1866"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Or:</span></CodeLine>
<Link id="l01867" /><CodeLine lineNumber="1867"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Xor:</span></CodeLine>
<Link id="l01868" /><CodeLine lineNumber="1868"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::ICmp:</span></CodeLine>
<Link id="l01869" /><CodeLine lineNumber="1869"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FCmp:</span></CodeLine>
<Link id="l01870" /><CodeLine lineNumber="1870"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Trunc:</span></CodeLine>
<Link id="l01871" /><CodeLine lineNumber="1871"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::ZExt:</span></CodeLine>
<Link id="l01872" /><CodeLine lineNumber="1872"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::SExt:</span></CodeLine>
<Link id="l01873" /><CodeLine lineNumber="1873"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FPToUI:</span></CodeLine>
<Link id="l01874" /><CodeLine lineNumber="1874"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FPToSI:</span></CodeLine>
<Link id="l01875" /><CodeLine lineNumber="1875"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::UIToFP:</span></CodeLine>
<Link id="l01876" /><CodeLine lineNumber="1876"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::SIToFP:</span></CodeLine>
<Link id="l01877" /><CodeLine lineNumber="1877"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FPTrunc:</span></CodeLine>
<Link id="l01878" /><CodeLine lineNumber="1878"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FPExt:</span></CodeLine>
<Link id="l01879" /><CodeLine lineNumber="1879"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::GetElementPtr: &#123;</span></CodeLine>
<Link id="l01880" /><CodeLine lineNumber="1880"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Bail out if we would create longer vector ops. We could allow creating</span></CodeLine>
<Link id="l01881" /><CodeLine lineNumber="1881"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// longer vector ops, but that may result in more expensive codegen.</span></CodeLine>
<Link id="l01882" /><CodeLine lineNumber="1882"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/type">Type</a> &#42;ITy = <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getType();</span></CodeLine>
<Link id="l01883" /><CodeLine lineNumber="1883"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ITy-&gt;<a href="/docs/api/classes/llvm/type/#a1bc022868b23918efa44df511f4d5b61">isVectorTy</a>() &amp;&amp;</span></CodeLine>
<Link id="l01884" /><CodeLine lineNumber="1884"><span class="doxyHighlight">          Mask.size() &gt; <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(ITy)-&gt;getNumElements())</span></CodeLine>
<Link id="l01885" /><CodeLine lineNumber="1885"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01886" /><CodeLine lineNumber="1886"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/value">Value</a> &#42;Operand : <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;operands()) &#123;</span></CodeLine>
<Link id="l01887" /><CodeLine lineNumber="1887"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="#a95fd07ca61f35098e091aa2329f9c8a6">canEvaluateShuffled</a>(Operand, Mask, <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06afe578efb7ca235af77fb0eef7edcf639">Depth</a> - 1))</span></CodeLine>
<Link id="l01888" /><CodeLine lineNumber="1888"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01889" /><CodeLine lineNumber="1889"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01890" /><CodeLine lineNumber="1890"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01891" /><CodeLine lineNumber="1891"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01892" /><CodeLine lineNumber="1892"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::InsertElement: &#123;</span></CodeLine>
<Link id="l01893" /><CodeLine lineNumber="1893"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;CI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ConstantInt&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOperand(2));</span></CodeLine>
<Link id="l01894" /><CodeLine lineNumber="1894"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CI) </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01895" /><CodeLine lineNumber="1895"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> ElementNumber = CI-&gt;<a href="/docs/api/classes/llvm/constantint/#a31e8da5adf63afd38b4ab94bca823150">getLimitedValue</a>();</span></CodeLine>
<Link id="l01896" /><CodeLine lineNumber="1896"></CodeLine>
<Link id="l01897" /><CodeLine lineNumber="1897"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Verify that &#39;CI&#39; does not occur twice in Mask. A single &#39;insertelement&#39;</span></CodeLine>
<Link id="l01898" /><CodeLine lineNumber="1898"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// can&#39;t put an element into multiple indices.</span></CodeLine>
<Link id="l01899" /><CodeLine lineNumber="1899"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> SeenOnce = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01900" /><CodeLine lineNumber="1900"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : Mask) &#123;</span></CodeLine>
<Link id="l01901" /><CodeLine lineNumber="1901"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> == ElementNumber) &#123;</span></CodeLine>
<Link id="l01902" /><CodeLine lineNumber="1902"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SeenOnce)</span></CodeLine>
<Link id="l01903" /><CodeLine lineNumber="1903"><span class="doxyHighlight">            </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01904" /><CodeLine lineNumber="1904"><span class="doxyHighlight">          SeenOnce = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01905" /><CodeLine lineNumber="1905"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l01906" /><CodeLine lineNumber="1906"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01907" /><CodeLine lineNumber="1907"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="#a95fd07ca61f35098e091aa2329f9c8a6">canEvaluateShuffled</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOperand(0), Mask, <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06afe578efb7ca235af77fb0eef7edcf639">Depth</a> - 1);</span></CodeLine>
<Link id="l01908" /><CodeLine lineNumber="1908"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01909" /><CodeLine lineNumber="1909"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01910" /><CodeLine lineNumber="1910"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01911" /><CodeLine lineNumber="1911"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01912" /><CodeLine lineNumber="1912"></CodeLine>
<Link id="l01913" /><CodeLine lineNumber="1913"><span class="doxyHighlightComment">/// Rebuild a new instruction just like &#39;I&#39; but with the new operands given.</span></CodeLine>
<Link id="l01914" /><CodeLine lineNumber="1914"><span class="doxyHighlightComment">/// In the event of type mismatch, the type of the operands is correct.</span></CodeLine>
<Link id="l01915" /><CodeLine lineNumber="1915" lineLink="#a8efa56ca3bfdd8c715939f9e0b24ccda"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="#a8efa56ca3bfdd8c715939f9e0b24ccda">buildNew</a>(<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;Value&#42;&gt;</a> NewOps,</span></CodeLine>
<Link id="l01916" /><CodeLine lineNumber="1916"><span class="doxyHighlight">                       <a href="/docs/api/classes/llvm/irbuilderbase">IRBuilderBase</a> &amp;Builder) &#123;</span></CodeLine>
<Link id="l01917" /><CodeLine lineNumber="1917"><span class="doxyHighlight">  Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#ace45cae6925c65e9d6916e09dd5b17cc">SetInsertPoint</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</span></CodeLine>
<Link id="l01918" /><CodeLine lineNumber="1918"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOpcode()) &#123;</span></CodeLine>
<Link id="l01919" /><CodeLine lineNumber="1919"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Add:</span></CodeLine>
<Link id="l01920" /><CodeLine lineNumber="1920"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FAdd:</span></CodeLine>
<Link id="l01921" /><CodeLine lineNumber="1921"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Sub:</span></CodeLine>
<Link id="l01922" /><CodeLine lineNumber="1922"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FSub:</span></CodeLine>
<Link id="l01923" /><CodeLine lineNumber="1923"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Mul:</span></CodeLine>
<Link id="l01924" /><CodeLine lineNumber="1924"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FMul:</span></CodeLine>
<Link id="l01925" /><CodeLine lineNumber="1925"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::UDiv:</span></CodeLine>
<Link id="l01926" /><CodeLine lineNumber="1926"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::SDiv:</span></CodeLine>
<Link id="l01927" /><CodeLine lineNumber="1927"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FDiv:</span></CodeLine>
<Link id="l01928" /><CodeLine lineNumber="1928"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::URem:</span></CodeLine>
<Link id="l01929" /><CodeLine lineNumber="1929"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::SRem:</span></CodeLine>
<Link id="l01930" /><CodeLine lineNumber="1930"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FRem:</span></CodeLine>
<Link id="l01931" /><CodeLine lineNumber="1931"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Shl:</span></CodeLine>
<Link id="l01932" /><CodeLine lineNumber="1932"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::LShr:</span></CodeLine>
<Link id="l01933" /><CodeLine lineNumber="1933"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::AShr:</span></CodeLine>
<Link id="l01934" /><CodeLine lineNumber="1934"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::And:</span></CodeLine>
<Link id="l01935" /><CodeLine lineNumber="1935"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Or:</span></CodeLine>
<Link id="l01936" /><CodeLine lineNumber="1936"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Xor: &#123;</span></CodeLine>
<Link id="l01937" /><CodeLine lineNumber="1937"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/binaryoperator">BinaryOperator</a> &#42;BO = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BinaryOperator&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</span></CodeLine>
<Link id="l01938" /><CodeLine lineNumber="1938"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(NewOps.<a href="/docs/api/classes/llvm/arrayref/#a85ffb6531d4cda988ea81f18d4e56fb7">size</a>() == 2 &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;binary operator with #ops != 2&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01939" /><CodeLine lineNumber="1939"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;New = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aba5d97f3a14427982c1b86dafd033320">CreateBinOp</a>(<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BinaryOperator&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)-&gt;<a href="/docs/api/files/lib/lib/transforms/lib/transforms/vectorize/vplanslp-cpp/#a06b4f19004df11b338ccc7e73bf47ab4">getOpcode</a>(),</span></CodeLine>
<Link id="l01940" /><CodeLine lineNumber="1940"><span class="doxyHighlight">                                       NewOps&#91;0&#93;, NewOps&#91;1&#93;);</span></CodeLine>
<Link id="l01941" /><CodeLine lineNumber="1941"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(New)) &#123;</span></CodeLine>
<Link id="l01942" /><CodeLine lineNumber="1942"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;OverflowingBinaryOperator&gt;</a>(BO)) &#123;</span></CodeLine>
<Link id="l01943" /><CodeLine lineNumber="1943"><span class="doxyHighlight">          NewI-&gt;setHasNoUnsignedWrap(BO-&gt;<a href="/docs/api/classes/llvm/instruction/#a100c666f9253331dd1d166a863248326">hasNoUnsignedWrap</a>());</span></CodeLine>
<Link id="l01944" /><CodeLine lineNumber="1944"><span class="doxyHighlight">          NewI-&gt;setHasNoSignedWrap(BO-&gt;<a href="/docs/api/classes/llvm/instruction/#a350f4fdc01c770b5cf6a8be2624ae3e5">hasNoSignedWrap</a>());</span></CodeLine>
<Link id="l01945" /><CodeLine lineNumber="1945"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l01946" /><CodeLine lineNumber="1946"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;PossiblyExactOperator&gt;</a>(BO)) &#123;</span></CodeLine>
<Link id="l01947" /><CodeLine lineNumber="1947"><span class="doxyHighlight">          NewI-&gt;setIsExact(BO-&gt;<a href="/docs/api/classes/llvm/instruction/#a689a03df5b4ae094d6a3a1bd13dac574">isExact</a>());</span></CodeLine>
<Link id="l01948" /><CodeLine lineNumber="1948"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l01949" /><CodeLine lineNumber="1949"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;FPMathOperator&gt;</a>(BO))</span></CodeLine>
<Link id="l01950" /><CodeLine lineNumber="1950"><span class="doxyHighlight">          NewI-&gt;copyFastMathFlags(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</span></CodeLine>
<Link id="l01951" /><CodeLine lineNumber="1951"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01952" /><CodeLine lineNumber="1952"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> New;</span></CodeLine>
<Link id="l01953" /><CodeLine lineNumber="1953"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01954" /><CodeLine lineNumber="1954"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::ICmp:</span></CodeLine>
<Link id="l01955" /><CodeLine lineNumber="1955"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(NewOps.<a href="/docs/api/classes/llvm/arrayref/#a85ffb6531d4cda988ea81f18d4e56fb7">size</a>() == 2 &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;icmp with #ops != 2&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01956" /><CodeLine lineNumber="1956"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#ae0bd6c2fab2d18443038a8f3a2b64856">CreateICmp</a>(<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;ICmpInst&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)-&gt;getPredicate(), NewOps&#91;0&#93;,</span></CodeLine>
<Link id="l01957" /><CodeLine lineNumber="1957"><span class="doxyHighlight">                                NewOps&#91;1&#93;);</span></CodeLine>
<Link id="l01958" /><CodeLine lineNumber="1958"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FCmp:</span></CodeLine>
<Link id="l01959" /><CodeLine lineNumber="1959"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(NewOps.<a href="/docs/api/classes/llvm/arrayref/#a85ffb6531d4cda988ea81f18d4e56fb7">size</a>() == 2 &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;fcmp with #ops != 2&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01960" /><CodeLine lineNumber="1960"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a168f682d44a3697eba421b802787f6bf">CreateFCmp</a>(<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FCmpInst&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)-&gt;getPredicate(), NewOps&#91;0&#93;,</span></CodeLine>
<Link id="l01961" /><CodeLine lineNumber="1961"><span class="doxyHighlight">                                NewOps&#91;1&#93;);</span></CodeLine>
<Link id="l01962" /><CodeLine lineNumber="1962"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Trunc:</span></CodeLine>
<Link id="l01963" /><CodeLine lineNumber="1963"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::ZExt:</span></CodeLine>
<Link id="l01964" /><CodeLine lineNumber="1964"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::SExt:</span></CodeLine>
<Link id="l01965" /><CodeLine lineNumber="1965"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FPToUI:</span></CodeLine>
<Link id="l01966" /><CodeLine lineNumber="1966"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FPToSI:</span></CodeLine>
<Link id="l01967" /><CodeLine lineNumber="1967"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::UIToFP:</span></CodeLine>
<Link id="l01968" /><CodeLine lineNumber="1968"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::SIToFP:</span></CodeLine>
<Link id="l01969" /><CodeLine lineNumber="1969"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FPTrunc:</span></CodeLine>
<Link id="l01970" /><CodeLine lineNumber="1970"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FPExt: &#123;</span></CodeLine>
<Link id="l01971" /><CodeLine lineNumber="1971"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// It&#39;s possible that the mask has a different number of elements from</span></CodeLine>
<Link id="l01972" /><CodeLine lineNumber="1972"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// the original cast. We recompute the destination type to match the mask.</span></CodeLine>
<Link id="l01973" /><CodeLine lineNumber="1973"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/type">Type</a> &#42;DestTy = <a href="/docs/api/classes/llvm/vectortype/#a861be1e2092622462053c6d31dddbfd5">VectorType::get</a>(</span></CodeLine>
<Link id="l01974" /><CodeLine lineNumber="1974"><span class="doxyHighlight">          <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getType()-&gt;getScalarType(),</span></CodeLine>
<Link id="l01975" /><CodeLine lineNumber="1975"><span class="doxyHighlight">          <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;VectorType&gt;</a>(NewOps&#91;0&#93;-&gt;getType())-&gt;getElementCount());</span></CodeLine>
<Link id="l01976" /><CodeLine lineNumber="1976"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(NewOps.<a href="/docs/api/classes/llvm/arrayref/#a85ffb6531d4cda988ea81f18d4e56fb7">size</a>() == 1 &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;cast with #ops != 1&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01977" /><CodeLine lineNumber="1977"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a5b7f6dddc76bf7954b8df6abbd974436">CreateCast</a>(<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CastInst&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)-&gt;<a href="/docs/api/files/lib/lib/transforms/lib/transforms/vectorize/vplanslp-cpp/#a06b4f19004df11b338ccc7e73bf47ab4">getOpcode</a>(), NewOps&#91;0&#93;,</span></CodeLine>
<Link id="l01978" /><CodeLine lineNumber="1978"><span class="doxyHighlight">                                DestTy);</span></CodeLine>
<Link id="l01979" /><CodeLine lineNumber="1979"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01980" /><CodeLine lineNumber="1980"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::GetElementPtr: &#123;</span></CodeLine>
<Link id="l01981" /><CodeLine lineNumber="1981"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/analysis/targetlibraryinfo-cpp/#aca185e6d0e9f423dbb24440206454872a11dbf501abf829b3ab7049c2d3a8a053">Ptr</a> = NewOps&#91;0&#93;;</span></CodeLine>
<Link id="l01982" /><CodeLine lineNumber="1982"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;Value&#42;&gt;</a> Idx = NewOps.<a href="/docs/api/classes/llvm/arrayref/#aebf6ca7590d4f766b894044015a0fa31">slice</a>(1);</span></CodeLine>
<Link id="l01983" /><CodeLine lineNumber="1983"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a73e0482b96d9d0cdfcc90c0a34f5b0db">CreateGEP</a>(<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;GEPOperator&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)-&gt;getSourceElementType(),</span></CodeLine>
<Link id="l01984" /><CodeLine lineNumber="1984"><span class="doxyHighlight">                               <a href="/docs/api/files/lib/lib/analysis/targetlibraryinfo-cpp/#aca185e6d0e9f423dbb24440206454872a11dbf501abf829b3ab7049c2d3a8a053">Ptr</a>, Idx, </span><span class="doxyHighlightStringLiteral">&quot;&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l01985" /><CodeLine lineNumber="1985"><span class="doxyHighlight">                               <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;GEPOperator&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)-&gt;isInBounds());</span></CodeLine>
<Link id="l01986" /><CodeLine lineNumber="1986"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01987" /><CodeLine lineNumber="1987"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01988" /><CodeLine lineNumber="1988"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/errorhandling-h/#ace243f5c25697a1107cce46626b3dc94">llvm&#95;unreachable</a>(</span><span class="doxyHighlightStringLiteral">&quot;failed to rebuild vector instructions&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01989" /><CodeLine lineNumber="1989"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01990" /><CodeLine lineNumber="1990"></CodeLine>
<Link id="l01991" /><CodeLine lineNumber="1991" lineLink="#a06358c30f3e98d9e57f4ae9162f33c72"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="#a06358c30f3e98d9e57f4ae9162f33c72">evaluateInDifferentElementOrder</a>(<a href="/docs/api/classes/llvm/value">Value</a> &#42;V, <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;int&gt;</a> Mask,</span></CodeLine>
<Link id="l01992" /><CodeLine lineNumber="1992"><span class="doxyHighlight">                                              <a href="/docs/api/classes/llvm/irbuilderbase">IRBuilderBase</a> &amp;Builder) &#123;</span></CodeLine>
<Link id="l01993" /><CodeLine lineNumber="1993"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Mask.size() does not need to be equal to the number of vector elements.</span></CodeLine>
<Link id="l01994" /><CodeLine lineNumber="1994"></CodeLine>
<Link id="l01995" /><CodeLine lineNumber="1995"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(V-&gt;getType()-&gt;isVectorTy() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;can&#39;t reorder non-vector elements&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01996" /><CodeLine lineNumber="1996"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/type">Type</a> &#42;EltTy = V-&gt;getType()-&gt;<a href="/docs/api/classes/llvm/type/#a7c742b32ebcd73d6dc851afac295b0f2">getScalarType</a>();</span></CodeLine>
<Link id="l01997" /><CodeLine lineNumber="1997"></CodeLine>
<Link id="l01998" /><CodeLine lineNumber="1998"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;PoisonValue&gt;</a>(V))</span></CodeLine>
<Link id="l01999" /><CodeLine lineNumber="1999"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(<a href="/docs/api/classes/llvm/fixedvectortype/#af9a870d5df50fe0133a410b7c9114c80">FixedVectorType::get</a>(EltTy, Mask.size()));</span></CodeLine>
<Link id="l02000" /><CodeLine lineNumber="2000"></CodeLine>
<Link id="l02001" /><CodeLine lineNumber="2001"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(V, <a href="/docs/api/namespaces/llvm/patternmatch/#adea6dc2e42baa345b97be48b0370313d">m&#95;Undef</a>()))</span></CodeLine>
<Link id="l02002" /><CodeLine lineNumber="2002"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/undefvalue/#a4ae5ff22b700a42bcc5d889233721335">UndefValue::get</a>(<a href="/docs/api/classes/llvm/fixedvectortype/#af9a870d5df50fe0133a410b7c9114c80">FixedVectorType::get</a>(EltTy, Mask.size()));</span></CodeLine>
<Link id="l02003" /><CodeLine lineNumber="2003"></CodeLine>
<Link id="l02004" /><CodeLine lineNumber="2004"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;ConstantAggregateZero&gt;</a>(V))</span></CodeLine>
<Link id="l02005" /><CodeLine lineNumber="2005"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/constantaggregatezero/#abfa1cf8b4348407b167f93bc7c01055f">ConstantAggregateZero::get</a>(<a href="/docs/api/classes/llvm/fixedvectortype/#af9a870d5df50fe0133a410b7c9114c80">FixedVectorType::get</a>(EltTy, Mask.size()));</span></CodeLine>
<Link id="l02006" /><CodeLine lineNumber="2006"></CodeLine>
<Link id="l02007" /><CodeLine lineNumber="2007"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/constant">Constant</a> &#42;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Constant&gt;</a>(V))</span></CodeLine>
<Link id="l02008" /><CodeLine lineNumber="2008"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/constantexpr/#a6f6506f0bc515fe29da3b58565300017">ConstantExpr::getShuffleVector</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, <a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>-&gt;getType()),</span></CodeLine>
<Link id="l02009" /><CodeLine lineNumber="2009"><span class="doxyHighlight">                                          Mask);</span></CodeLine>
<Link id="l02010" /><CodeLine lineNumber="2010"></CodeLine>
<Link id="l02011" /><CodeLine lineNumber="2011"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Instruction&gt;</a>(V);</span></CodeLine>
<Link id="l02012" /><CodeLine lineNumber="2012"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOpcode()) &#123;</span></CodeLine>
<Link id="l02013" /><CodeLine lineNumber="2013"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Add:</span></CodeLine>
<Link id="l02014" /><CodeLine lineNumber="2014"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FAdd:</span></CodeLine>
<Link id="l02015" /><CodeLine lineNumber="2015"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Sub:</span></CodeLine>
<Link id="l02016" /><CodeLine lineNumber="2016"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FSub:</span></CodeLine>
<Link id="l02017" /><CodeLine lineNumber="2017"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Mul:</span></CodeLine>
<Link id="l02018" /><CodeLine lineNumber="2018"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FMul:</span></CodeLine>
<Link id="l02019" /><CodeLine lineNumber="2019"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::UDiv:</span></CodeLine>
<Link id="l02020" /><CodeLine lineNumber="2020"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::SDiv:</span></CodeLine>
<Link id="l02021" /><CodeLine lineNumber="2021"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FDiv:</span></CodeLine>
<Link id="l02022" /><CodeLine lineNumber="2022"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::URem:</span></CodeLine>
<Link id="l02023" /><CodeLine lineNumber="2023"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::SRem:</span></CodeLine>
<Link id="l02024" /><CodeLine lineNumber="2024"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FRem:</span></CodeLine>
<Link id="l02025" /><CodeLine lineNumber="2025"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Shl:</span></CodeLine>
<Link id="l02026" /><CodeLine lineNumber="2026"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::LShr:</span></CodeLine>
<Link id="l02027" /><CodeLine lineNumber="2027"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::AShr:</span></CodeLine>
<Link id="l02028" /><CodeLine lineNumber="2028"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::And:</span></CodeLine>
<Link id="l02029" /><CodeLine lineNumber="2029"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Or:</span></CodeLine>
<Link id="l02030" /><CodeLine lineNumber="2030"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Xor:</span></CodeLine>
<Link id="l02031" /><CodeLine lineNumber="2031"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::ICmp:</span></CodeLine>
<Link id="l02032" /><CodeLine lineNumber="2032"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FCmp:</span></CodeLine>
<Link id="l02033" /><CodeLine lineNumber="2033"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Trunc:</span></CodeLine>
<Link id="l02034" /><CodeLine lineNumber="2034"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::ZExt:</span></CodeLine>
<Link id="l02035" /><CodeLine lineNumber="2035"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::SExt:</span></CodeLine>
<Link id="l02036" /><CodeLine lineNumber="2036"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FPToUI:</span></CodeLine>
<Link id="l02037" /><CodeLine lineNumber="2037"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FPToSI:</span></CodeLine>
<Link id="l02038" /><CodeLine lineNumber="2038"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::UIToFP:</span></CodeLine>
<Link id="l02039" /><CodeLine lineNumber="2039"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::SIToFP:</span></CodeLine>
<Link id="l02040" /><CodeLine lineNumber="2040"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FPTrunc:</span></CodeLine>
<Link id="l02041" /><CodeLine lineNumber="2041"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FPExt:</span></CodeLine>
<Link id="l02042" /><CodeLine lineNumber="2042"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Select:</span></CodeLine>
<Link id="l02043" /><CodeLine lineNumber="2043"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::GetElementPtr: &#123;</span></CodeLine>
<Link id="l02044" /><CodeLine lineNumber="2044"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Value&#42;, 8&gt;</a> NewOps;</span></CodeLine>
<Link id="l02045" /><CodeLine lineNumber="2045"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> NeedsRebuild =</span></CodeLine>
<Link id="l02046" /><CodeLine lineNumber="2046"><span class="doxyHighlight">          (Mask.size() !=</span></CodeLine>
<Link id="l02047" /><CodeLine lineNumber="2047"><span class="doxyHighlight">           <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getType())-&gt;getNumElements());</span></CodeLine>
<Link id="l02048" /><CodeLine lineNumber="2048"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> i = 0, e = <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getNumOperands(); i != e; ++i) &#123;</span></CodeLine>
<Link id="l02049" /><CodeLine lineNumber="2049"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/value">Value</a> &#42;V;</span></CodeLine>
<Link id="l02050" /><CodeLine lineNumber="2050"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Recursively call evaluateInDifferentElementOrder on vector arguments</span></CodeLine>
<Link id="l02051" /><CodeLine lineNumber="2051"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// as well. E.g. GetElementPtr may have scalar operands even if the</span></CodeLine>
<Link id="l02052" /><CodeLine lineNumber="2052"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// return value is a vector, so we need to examine the operand type.</span></CodeLine>
<Link id="l02053" /><CodeLine lineNumber="2053"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOperand(i)-&gt;getType()-&gt;isVectorTy())</span></CodeLine>
<Link id="l02054" /><CodeLine lineNumber="2054"><span class="doxyHighlight">          V = <a href="#a06358c30f3e98d9e57f4ae9162f33c72">evaluateInDifferentElementOrder</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOperand(i), Mask, Builder);</span></CodeLine>
<Link id="l02055" /><CodeLine lineNumber="2055"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l02056" /><CodeLine lineNumber="2056"><span class="doxyHighlight">          V = <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOperand(i);</span></CodeLine>
<Link id="l02057" /><CodeLine lineNumber="2057"><span class="doxyHighlight">        NewOps.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(V);</span></CodeLine>
<Link id="l02058" /><CodeLine lineNumber="2058"><span class="doxyHighlight">        NeedsRebuild |= (V != <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOperand(i));</span></CodeLine>
<Link id="l02059" /><CodeLine lineNumber="2059"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l02060" /><CodeLine lineNumber="2060"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NeedsRebuild)</span></CodeLine>
<Link id="l02061" /><CodeLine lineNumber="2061"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="#a8efa56ca3bfdd8c715939f9e0b24ccda">buildNew</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, NewOps, Builder);</span></CodeLine>
<Link id="l02062" /><CodeLine lineNumber="2062"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l02063" /><CodeLine lineNumber="2063"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02064" /><CodeLine lineNumber="2064"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::InsertElement: &#123;</span></CodeLine>
<Link id="l02065" /><CodeLine lineNumber="2065"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> Element = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;ConstantInt&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOperand(2))-&gt;getLimitedValue();</span></CodeLine>
<Link id="l02066" /><CodeLine lineNumber="2066"></CodeLine>
<Link id="l02067" /><CodeLine lineNumber="2067"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// The insertelement was inserting at Element. Figure out which element</span></CodeLine>
<Link id="l02068" /><CodeLine lineNumber="2068"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// that becomes after shuffling. The answer is guaranteed to be unique</span></CodeLine>
<Link id="l02069" /><CodeLine lineNumber="2069"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// by CanEvaluateShuffled.</span></CodeLine>
<Link id="l02070" /><CodeLine lineNumber="2070"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> Found = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02071" /><CodeLine lineNumber="2071"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> Index = 0;</span></CodeLine>
<Link id="l02072" /><CodeLine lineNumber="2072"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> e = Mask.size(); Index != e; ++Index) &#123;</span></CodeLine>
<Link id="l02073" /><CodeLine lineNumber="2073"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Mask&#91;Index&#93; == Element) &#123;</span></CodeLine>
<Link id="l02074" /><CodeLine lineNumber="2074"><span class="doxyHighlight">          Found = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02075" /><CodeLine lineNumber="2075"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02076" /><CodeLine lineNumber="2076"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l02077" /><CodeLine lineNumber="2077"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l02078" /><CodeLine lineNumber="2078"></CodeLine>
<Link id="l02079" /><CodeLine lineNumber="2079"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If element is not in Mask, no need to handle the operand 1 (element to</span></CodeLine>
<Link id="l02080" /><CodeLine lineNumber="2080"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// be inserted). Just evaluate values in operand 0 according to Mask.</span></CodeLine>
<Link id="l02081" /><CodeLine lineNumber="2081"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Found)</span></CodeLine>
<Link id="l02082" /><CodeLine lineNumber="2082"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="#a06358c30f3e98d9e57f4ae9162f33c72">evaluateInDifferentElementOrder</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOperand(0), Mask, Builder);</span></CodeLine>
<Link id="l02083" /><CodeLine lineNumber="2083"></CodeLine>
<Link id="l02084" /><CodeLine lineNumber="2084"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;V = <a href="#a06358c30f3e98d9e57f4ae9162f33c72">evaluateInDifferentElementOrder</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOperand(0), Mask,</span></CodeLine>
<Link id="l02085" /><CodeLine lineNumber="2085"><span class="doxyHighlight">                                                 Builder);</span></CodeLine>
<Link id="l02086" /><CodeLine lineNumber="2086"><span class="doxyHighlight">      Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#ace45cae6925c65e9d6916e09dd5b17cc">SetInsertPoint</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</span></CodeLine>
<Link id="l02087" /><CodeLine lineNumber="2087"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a17320ebd77e834577a5ebd1063039625">CreateInsertElement</a>(V, <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOperand(1), Index);</span></CodeLine>
<Link id="l02088" /><CodeLine lineNumber="2088"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02089" /><CodeLine lineNumber="2089"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02090" /><CodeLine lineNumber="2090"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/errorhandling-h/#ace243f5c25697a1107cce46626b3dc94">llvm&#95;unreachable</a>(</span><span class="doxyHighlightStringLiteral">&quot;failed to reorder elements of vector instruction!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02091" /><CodeLine lineNumber="2091"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02092" /><CodeLine lineNumber="2092"></CodeLine>
<Link id="l02093" /><CodeLine lineNumber="2093"><span class="doxyHighlightComment">// Returns true if the shuffle is extracting a contiguous range of values from</span></CodeLine>
<Link id="l02094" /><CodeLine lineNumber="2094"><span class="doxyHighlightComment">// LHS, for example:</span></CodeLine>
<Link id="l02095" /><CodeLine lineNumber="2095"><span class="doxyHighlightComment">//                 +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span></CodeLine>
<Link id="l02096" /><CodeLine lineNumber="2096"><span class="doxyHighlightComment">//   Input:        |AA|BB|CC|DD|EE|FF|GG|HH|II|JJ|KK|LL|MM|NN|OO|PP|</span></CodeLine>
<Link id="l02097" /><CodeLine lineNumber="2097"><span class="doxyHighlightComment">//   Shuffles to:  |EE|FF|GG|HH|</span></CodeLine>
<Link id="l02098" /><CodeLine lineNumber="2098"><span class="doxyHighlightComment">//                 +--+--+--+--+</span></CodeLine>
<Link id="l02099" /><CodeLine lineNumber="2099" lineLink="#ae8f4745a87bae0a614d6bda1cc55ab01"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#ae8f4745a87bae0a614d6bda1cc55ab01">isShuffleExtractingFromLHS</a>(<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp;SVI,</span></CodeLine>
<Link id="l02100" /><CodeLine lineNumber="2100"><span class="doxyHighlight">                                       <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;int&gt;</a> Mask) &#123;</span></CodeLine>
<Link id="l02101" /><CodeLine lineNumber="2101"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> LHSElems =</span></CodeLine>
<Link id="l02102" /><CodeLine lineNumber="2102"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(SVI.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0)-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>())-&gt;getNumElements();</span></CodeLine>
<Link id="l02103" /><CodeLine lineNumber="2103"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> MaskElems = Mask.size();</span></CodeLine>
<Link id="l02104" /><CodeLine lineNumber="2104"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> BegIdx = Mask.front();</span></CodeLine>
<Link id="l02105" /><CodeLine lineNumber="2105"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> EndIdx = Mask.back();</span></CodeLine>
<Link id="l02106" /><CodeLine lineNumber="2106"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BegIdx &gt; EndIdx || EndIdx &gt;= LHSElems || EndIdx - BegIdx != MaskElems - 1)</span></CodeLine>
<Link id="l02107" /><CodeLine lineNumber="2107"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02108" /><CodeLine lineNumber="2108"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = 0; <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> != MaskElems; ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)</span></CodeLine>
<Link id="l02109" /><CodeLine lineNumber="2109"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">static&#95;cast&lt;</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlightKeyword">&gt;</span><span class="doxyHighlight">(Mask&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93;) != BegIdx + <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)</span></CodeLine>
<Link id="l02110" /><CodeLine lineNumber="2110"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02111" /><CodeLine lineNumber="2111"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02112" /><CodeLine lineNumber="2112"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02113" /><CodeLine lineNumber="2113"></CodeLine>
<Link id="l02114" /><CodeLine lineNumber="2114"><span class="doxyHighlightComment">/// These are the ingredients in an alternate form binary operator as described</span></CodeLine>
<Link id="l02115" /><CodeLine lineNumber="2115"><span class="doxyHighlightComment">/// below.</span></CodeLine>
<Link id="l02116" /><CodeLine lineNumber="2116" lineLink="/docs/api/structs/binopelts"><span class="doxyHighlightKeyword">struct </span><span class="doxyHighlight"><a href="/docs/api/structs/binopelts/#a085a4f7976730eeaeb8c7037fe8c7aab">BinopElts</a> &#123;</span></CodeLine>
<Link id="l02117" /><CodeLine lineNumber="2117" lineLink="/docs/api/structs/binopelts/#a0b1dcc01090bf24bebc2584f6a17b0d8"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/instruction/#ac26154a24f393f523c87cc5f8239f36c">BinaryOperator::BinaryOps</a> <a href="/docs/api/structs/binopelts/#a0b1dcc01090bf24bebc2584f6a17b0d8">Opcode</a>;</span></CodeLine>
<Link id="l02118" /><CodeLine lineNumber="2118" lineLink="/docs/api/structs/binopelts/#a7eb0f39f02b88e3c97ba994ee191f148"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/structs/binopelts/#a7eb0f39f02b88e3c97ba994ee191f148">Op0</a>;</span></CodeLine>
<Link id="l02119" /><CodeLine lineNumber="2119" lineLink="/docs/api/structs/binopelts/#a507629db7779162187dcbdc907798b45"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/structs/binopelts/#a507629db7779162187dcbdc907798b45">Op1</a>;</span></CodeLine>
<Link id="l02120" /><CodeLine lineNumber="2120" lineLink="/docs/api/structs/binopelts/#a085a4f7976730eeaeb8c7037fe8c7aab"><span class="doxyHighlight">  <a href="/docs/api/structs/binopelts/#a085a4f7976730eeaeb8c7037fe8c7aab">BinopElts</a>(<a href="/docs/api/classes/llvm/instruction/#ac26154a24f393f523c87cc5f8239f36c">BinaryOperator::BinaryOps</a> Opc = (<a href="/docs/api/classes/llvm/instruction/#ac26154a24f393f523c87cc5f8239f36c">BinaryOperator::BinaryOps</a>)0,</span></CodeLine>
<Link id="l02121" /><CodeLine lineNumber="2121"><span class="doxyHighlight">            <a href="/docs/api/classes/llvm/value">Value</a> &#42;V0 = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">, <a href="/docs/api/classes/llvm/value">Value</a> &#42;V1 = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">) :</span></CodeLine>
<Link id="l02122" /><CodeLine lineNumber="2122"><span class="doxyHighlight">      <a href="/docs/api/structs/binopelts/#a0b1dcc01090bf24bebc2584f6a17b0d8">Opcode</a>(Opc), <a href="/docs/api/structs/binopelts/#a7eb0f39f02b88e3c97ba994ee191f148">Op0</a>(V0), <a href="/docs/api/structs/binopelts/#a507629db7779162187dcbdc907798b45">Op1</a>(V1) &#123;&#125;</span></CodeLine>
<Link id="l02123" /><CodeLine lineNumber="2123" lineLink="/docs/api/structs/binopelts/#a8865792409d2961bde1ac9c62bd75f93"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">operator</span><span class="doxyHighlight"> bool()</span><span class="doxyHighlightKeyword"> const </span><span class="doxyHighlight">&#123; </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/structs/binopelts/#a0b1dcc01090bf24bebc2584f6a17b0d8">Opcode</a> != 0; &#125;</span></CodeLine>
<Link id="l02124" /><CodeLine lineNumber="2124"><span class="doxyHighlight">&#125;;</span></CodeLine>
<Link id="l02125" /><CodeLine lineNumber="2125"></CodeLine>
<Link id="l02126" /><CodeLine lineNumber="2126"><span class="doxyHighlightComment">/// Binops may be transformed into binops with different opcodes and operands.</span></CodeLine>
<Link id="l02127" /><CodeLine lineNumber="2127"><span class="doxyHighlightComment">/// Reverse the usual canonicalization to enable folds with the non-canonical</span></CodeLine>
<Link id="l02128" /><CodeLine lineNumber="2128"><span class="doxyHighlightComment">/// form of the binop. If a transform is possible, return the elements of the</span></CodeLine>
<Link id="l02129" /><CodeLine lineNumber="2129"><span class="doxyHighlightComment">/// new binop. If not, return invalid elements.</span></CodeLine>
<Link id="l02130" /><CodeLine lineNumber="2130" lineLink="#af7e7c9415c23ae336af651877798a377"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/structs/binopelts">BinopElts</a> <a href="#af7e7c9415c23ae336af651877798a377">getAlternateBinop</a>(<a href="/docs/api/classes/llvm/binaryoperator">BinaryOperator</a> &#42;BO, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/datalayout">DataLayout</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>) &#123;</span></CodeLine>
<Link id="l02131" /><CodeLine lineNumber="2131"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;BO0 = BO-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0), &#42;BO1 = BO-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1);</span></CodeLine>
<Link id="l02132" /><CodeLine lineNumber="2132"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/type">Type</a> &#42;Ty = BO-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>();</span></CodeLine>
<Link id="l02133" /><CodeLine lineNumber="2133"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (BO-&gt;<a href="/docs/api/classes/llvm/binaryoperator/#a31bf07f3f61525486633bc1d0bbaf029">getOpcode</a>()) &#123;</span></CodeLine>
<Link id="l02134" /><CodeLine lineNumber="2134"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Shl: &#123;</span></CodeLine>
<Link id="l02135" /><CodeLine lineNumber="2135"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// shl X, C --&gt; mul X, (1 &lt;&lt; C)</span></CodeLine>
<Link id="l02136" /><CodeLine lineNumber="2136"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/constant">Constant</a> &#42;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>;</span></CodeLine>
<Link id="l02137" /><CodeLine lineNumber="2137"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(BO1, <a href="/docs/api/namespaces/llvm/patternmatch/#a5f6c38f6f64c2118341c829f97e26396">m&#95;ImmConstant</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>))) &#123;</span></CodeLine>
<Link id="l02138" /><CodeLine lineNumber="2138"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/constant">Constant</a> &#42;ShlOne = <a href="/docs/api/namespaces/llvm/#a964455f36837281d37f2a44e2fcb4cca">ConstantFoldBinaryOpOperands</a>(</span></CodeLine>
<Link id="l02139" /><CodeLine lineNumber="2139"><span class="doxyHighlight">          Instruction::Shl, ConstantInt::get(Ty, 1), <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>);</span></CodeLine>
<Link id="l02140" /><CodeLine lineNumber="2140"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(ShlOne &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Constant folding of immediate constants failed&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02141" /><CodeLine lineNumber="2141"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &#123;Instruction::Mul, BO0, ShlOne&#125;;</span></CodeLine>
<Link id="l02142" /><CodeLine lineNumber="2142"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02143" /><CodeLine lineNumber="2143"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02144" /><CodeLine lineNumber="2144"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02145" /><CodeLine lineNumber="2145"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Or: &#123;</span></CodeLine>
<Link id="l02146" /><CodeLine lineNumber="2146"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// or disjoin X, C --&gt; add X, C</span></CodeLine>
<Link id="l02147" /><CodeLine lineNumber="2147"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;PossiblyDisjointInst&gt;</a>(BO)-&gt;isDisjoint())</span></CodeLine>
<Link id="l02148" /><CodeLine lineNumber="2148"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &#123;Instruction::Add, BO0, BO1&#125;;</span></CodeLine>
<Link id="l02149" /><CodeLine lineNumber="2149"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02150" /><CodeLine lineNumber="2150"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02151" /><CodeLine lineNumber="2151"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Sub:</span></CodeLine>
<Link id="l02152" /><CodeLine lineNumber="2152"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// sub 0, X --&gt; mul X, -1</span></CodeLine>
<Link id="l02153" /><CodeLine lineNumber="2153"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(BO0, <a href="/docs/api/namespaces/llvm/patternmatch/#a54d7212b9b2c57cced42037ae2fa7c61">m&#95;ZeroInt</a>()))</span></CodeLine>
<Link id="l02154" /><CodeLine lineNumber="2154"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &#123;Instruction::Mul, BO1, <a href="/docs/api/classes/llvm/constant/#a4d51384de6e1798bb6aa875aebeea9f0">ConstantInt::getAllOnesValue</a>(Ty)&#125;;</span></CodeLine>
<Link id="l02155" /><CodeLine lineNumber="2155"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02156" /><CodeLine lineNumber="2156"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">default</span><span class="doxyHighlight">:</span></CodeLine>
<Link id="l02157" /><CodeLine lineNumber="2157"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02158" /><CodeLine lineNumber="2158"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02159" /><CodeLine lineNumber="2159"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &#123;&#125;;</span></CodeLine>
<Link id="l02160" /><CodeLine lineNumber="2160"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02161" /><CodeLine lineNumber="2161"></CodeLine>
<Link id="l02162" /><CodeLine lineNumber="2162"><span class="doxyHighlightComment">/// A select shuffle of a select shuffle with a shared operand can be reduced</span></CodeLine>
<Link id="l02163" /><CodeLine lineNumber="2163"><span class="doxyHighlightComment">/// to a single select shuffle. This is an obvious improvement in IR, and the</span></CodeLine>
<Link id="l02164" /><CodeLine lineNumber="2164"><span class="doxyHighlightComment">/// backend is expected to lower select shuffles efficiently.</span></CodeLine>
<Link id="l02165" /><CodeLine lineNumber="2165" lineLink="#a98282716af42c878d4638603c6efb350"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="#a98282716af42c878d4638603c6efb350">foldSelectShuffleOfSelectShuffle</a>(<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp;Shuf) &#123;</span></CodeLine>
<Link id="l02166" /><CodeLine lineNumber="2166"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a747673ac3ea44aadc3907c6b9fd86237">isSelect</a>() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Must have select-equivalent shuffle&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02167" /><CodeLine lineNumber="2167"></CodeLine>
<Link id="l02168" /><CodeLine lineNumber="2168"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;Op0 = Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0), &#42;Op1 = Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1);</span></CodeLine>
<Link id="l02169" /><CodeLine lineNumber="2169"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;int, 16&gt;</a> Mask;</span></CodeLine>
<Link id="l02170" /><CodeLine lineNumber="2170"><span class="doxyHighlight">  Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>(Mask);</span></CodeLine>
<Link id="l02171" /><CodeLine lineNumber="2171"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumElts = Mask.size();</span></CodeLine>
<Link id="l02172" /><CodeLine lineNumber="2172"></CodeLine>
<Link id="l02173" /><CodeLine lineNumber="2173"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Canonicalize a select shuffle with common operand as Op1.</span></CodeLine>
<Link id="l02174" /><CodeLine lineNumber="2174"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;ShufOp = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ShuffleVectorInst&gt;</a>(Op0);</span></CodeLine>
<Link id="l02175" /><CodeLine lineNumber="2175"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ShufOp &amp;&amp; ShufOp-&gt;isSelect() &amp;&amp;</span></CodeLine>
<Link id="l02176" /><CodeLine lineNumber="2176"><span class="doxyHighlight">      (ShufOp-&gt;getOperand(0) == Op1 || ShufOp-&gt;getOperand(1) == Op1)) &#123;</span></CodeLine>
<Link id="l02177" /><CodeLine lineNumber="2177"><span class="doxyHighlight">    <a href="/docs/api/namespaces/std/#ab8424022895aee3e366fb9a32f2883cb">std::swap</a>(Op0, Op1);</span></CodeLine>
<Link id="l02178" /><CodeLine lineNumber="2178"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/shufflevectorinst/#a9874bec83353914ed1e9309d5d9ccea0">ShuffleVectorInst::commuteShuffleMask</a>(Mask, NumElts);</span></CodeLine>
<Link id="l02179" /><CodeLine lineNumber="2179"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02180" /><CodeLine lineNumber="2180"></CodeLine>
<Link id="l02181" /><CodeLine lineNumber="2181"><span class="doxyHighlight">  ShufOp = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ShuffleVectorInst&gt;</a>(Op1);</span></CodeLine>
<Link id="l02182" /><CodeLine lineNumber="2182"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!ShufOp || !ShufOp-&gt;isSelect() ||</span></CodeLine>
<Link id="l02183" /><CodeLine lineNumber="2183"><span class="doxyHighlight">      (ShufOp-&gt;getOperand(0) != Op0 &amp;&amp; ShufOp-&gt;getOperand(1) != Op0))</span></CodeLine>
<Link id="l02184" /><CodeLine lineNumber="2184"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02185" /><CodeLine lineNumber="2185"></CodeLine>
<Link id="l02186" /><CodeLine lineNumber="2186"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a> = ShufOp-&gt;getOperand(0), &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a> = ShufOp-&gt;getOperand(1);</span></CodeLine>
<Link id="l02187" /><CodeLine lineNumber="2187"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;int, 16&gt;</a> Mask1;</span></CodeLine>
<Link id="l02188" /><CodeLine lineNumber="2188"><span class="doxyHighlight">  ShufOp-&gt;getShuffleMask(Mask1);</span></CodeLine>
<Link id="l02189" /><CodeLine lineNumber="2189"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Mask1.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() == NumElts &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Vector size changed with select shuffle&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02190" /><CodeLine lineNumber="2190"></CodeLine>
<Link id="l02191" /><CodeLine lineNumber="2191"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Canonicalize common operand (Op0) as X (first operand of first shuffle).</span></CodeLine>
<Link id="l02192" /><CodeLine lineNumber="2192"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a> == Op0) &#123;</span></CodeLine>
<Link id="l02193" /><CodeLine lineNumber="2193"><span class="doxyHighlight">    <a href="/docs/api/namespaces/std/#ab8424022895aee3e366fb9a32f2883cb">std::swap</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>);</span></CodeLine>
<Link id="l02194" /><CodeLine lineNumber="2194"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/shufflevectorinst/#a9874bec83353914ed1e9309d5d9ccea0">ShuffleVectorInst::commuteShuffleMask</a>(Mask1, NumElts);</span></CodeLine>
<Link id="l02195" /><CodeLine lineNumber="2195"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02196" /><CodeLine lineNumber="2196"></CodeLine>
<Link id="l02197" /><CodeLine lineNumber="2197"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the mask chooses from X (operand 0), it stays the same.</span></CodeLine>
<Link id="l02198" /><CodeLine lineNumber="2198"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the mask chooses from the earlier shuffle, the other mask value is</span></CodeLine>
<Link id="l02199" /><CodeLine lineNumber="2199"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// transferred to the combined select shuffle:</span></CodeLine>
<Link id="l02200" /><CodeLine lineNumber="2200"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuf X, (shuf X, Y, M1), M --&gt; shuf X, Y, M&#39;</span></CodeLine>
<Link id="l02201" /><CodeLine lineNumber="2201"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;int, 16&gt;</a> NewMask(NumElts);</span></CodeLine>
<Link id="l02202" /><CodeLine lineNumber="2202"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> i = 0; i != NumElts; ++i)</span></CodeLine>
<Link id="l02203" /><CodeLine lineNumber="2203"><span class="doxyHighlight">    NewMask&#91;i&#93; = Mask&#91;i&#93; &lt; (</span><span class="doxyHighlightKeywordType">signed</span><span class="doxyHighlight">)NumElts ? Mask&#91;i&#93; : Mask1&#91;i&#93;;</span></CodeLine>
<Link id="l02204" /><CodeLine lineNumber="2204"></CodeLine>
<Link id="l02205" /><CodeLine lineNumber="2205"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// A select mask with undef elements might look like an identity mask.</span></CodeLine>
<Link id="l02206" /><CodeLine lineNumber="2206"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((<a href="/docs/api/classes/llvm/shufflevectorinst/#a527e61685c56e6fab3cd424f74fa71ec">ShuffleVectorInst::isSelectMask</a>(NewMask, NumElts) ||</span></CodeLine>
<Link id="l02207" /><CodeLine lineNumber="2207"><span class="doxyHighlight">          <a href="/docs/api/classes/llvm/shufflevectorinst/#a81aa4ff7f63f7988abea1abbe9eb0342">ShuffleVectorInst::isIdentityMask</a>(NewMask, NumElts)) &amp;&amp;</span></CodeLine>
<Link id="l02208" /><CodeLine lineNumber="2208"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;Unexpected shuffle mask&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02209" /><CodeLine lineNumber="2209"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>, NewMask);</span></CodeLine>
<Link id="l02210" /><CodeLine lineNumber="2210"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02211" /><CodeLine lineNumber="2211"></CodeLine>
<Link id="l02212" /><CodeLine lineNumber="2212" lineLink="#a2c05df65ce7ce7ec1d78348be2452e8d"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="#a2c05df65ce7ce7ec1d78348be2452e8d">foldSelectShuffleWith1Binop</a>(<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp;Shuf,</span></CodeLine>
<Link id="l02213" /><CodeLine lineNumber="2213"><span class="doxyHighlight">                                                </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/structs/llvm/simplifyquery">SimplifyQuery</a> &amp;SQ) &#123;</span></CodeLine>
<Link id="l02214" /><CodeLine lineNumber="2214"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a747673ac3ea44aadc3907c6b9fd86237">isSelect</a>() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Must have select-equivalent shuffle&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02215" /><CodeLine lineNumber="2215"></CodeLine>
<Link id="l02216" /><CodeLine lineNumber="2216"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Are we shuffling together some value and that same value after it has been</span></CodeLine>
<Link id="l02217" /><CodeLine lineNumber="2217"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// modified by a binop with a constant?</span></CodeLine>
<Link id="l02218" /><CodeLine lineNumber="2218"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;Op0 = Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0), &#42;Op1 = Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1);</span></CodeLine>
<Link id="l02219" /><CodeLine lineNumber="2219"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/constant">Constant</a> &#42;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>;</span></CodeLine>
<Link id="l02220" /><CodeLine lineNumber="2220"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> Op0IsBinop;</span></CodeLine>
<Link id="l02221" /><CodeLine lineNumber="2221"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Op0, <a href="/docs/api/namespaces/llvm/patternmatch/#a0698afabe907d2d3b87889d2e0349d47">m&#95;BinOp</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a2d9861feadd3a09792967a012559e7b2">m&#95;Specific</a>(Op1), <a href="/docs/api/namespaces/llvm/patternmatch/#a16be5fe0cce90e51f8c0e0c4d6c589f6">m&#95;Constant</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>))))</span></CodeLine>
<Link id="l02222" /><CodeLine lineNumber="2222"><span class="doxyHighlight">    Op0IsBinop = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02223" /><CodeLine lineNumber="2223"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Op1, <a href="/docs/api/namespaces/llvm/patternmatch/#a0698afabe907d2d3b87889d2e0349d47">m&#95;BinOp</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a2d9861feadd3a09792967a012559e7b2">m&#95;Specific</a>(Op0), <a href="/docs/api/namespaces/llvm/patternmatch/#a16be5fe0cce90e51f8c0e0c4d6c589f6">m&#95;Constant</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>))))</span></CodeLine>
<Link id="l02224" /><CodeLine lineNumber="2224"><span class="doxyHighlight">    Op0IsBinop = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02225" /><CodeLine lineNumber="2225"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l02226" /><CodeLine lineNumber="2226"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02227" /><CodeLine lineNumber="2227"></CodeLine>
<Link id="l02228" /><CodeLine lineNumber="2228"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The identity constant for a binop leaves a variable operand unchanged. For</span></CodeLine>
<Link id="l02229" /><CodeLine lineNumber="2229"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// a vector, this is a splat of something like 0, -1, or 1</span></CodeLine>
<Link id="l02230" /><CodeLine lineNumber="2230"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If there&#39;s no identity constant for this binop, we&#39;re done.</span></CodeLine>
<Link id="l02231" /><CodeLine lineNumber="2231"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;BO = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BinaryOperator&gt;</a>(Op0IsBinop ? Op0 : Op1);</span></CodeLine>
<Link id="l02232" /><CodeLine lineNumber="2232"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/instruction/#ac26154a24f393f523c87cc5f8239f36c">BinaryOperator::BinaryOps</a> BOpcode = BO-&gt;getOpcode();</span></CodeLine>
<Link id="l02233" /><CodeLine lineNumber="2233"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/constant">Constant</a> &#42;IdC = <a href="/docs/api/classes/llvm/constantexpr/#ae9c2f00a962cb8e0316cf3548a5d8029">ConstantExpr::getBinOpIdentity</a>(BOpcode, Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a59c34209e9206120edf7ce3c5da4f872">getType</a>(), </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02234" /><CodeLine lineNumber="2234"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!IdC)</span></CodeLine>
<Link id="l02235" /><CodeLine lineNumber="2235"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02236" /><CodeLine lineNumber="2236"></CodeLine>
<Link id="l02237" /><CodeLine lineNumber="2237"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a> = Op0IsBinop ? Op1 : Op0;</span></CodeLine>
<Link id="l02238" /><CodeLine lineNumber="2238"></CodeLine>
<Link id="l02239" /><CodeLine lineNumber="2239"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Prevent folding in the case the non-binop operand might have NaN values.</span></CodeLine>
<Link id="l02240" /><CodeLine lineNumber="2240"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If X can have NaN elements then we have that the floating point math</span></CodeLine>
<Link id="l02241" /><CodeLine lineNumber="2241"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// operation in the transformed code may not preserve the exact NaN</span></CodeLine>
<Link id="l02242" /><CodeLine lineNumber="2242"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// bit-pattern -- e.g. &#96;fadd sNaN, 0 -&gt; qNaN&#96;.</span></CodeLine>
<Link id="l02243" /><CodeLine lineNumber="2243"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// This makes the transformation incorrect since the original program would</span></CodeLine>
<Link id="l02244" /><CodeLine lineNumber="2244"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// have preserved the exact NaN bit-pattern.</span></CodeLine>
<Link id="l02245" /><CodeLine lineNumber="2245"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Avoid the folding if X can have NaN elements.</span></CodeLine>
<Link id="l02246" /><CodeLine lineNumber="2246"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a59c34209e9206120edf7ce3c5da4f872">getType</a>()-&gt;<a href="/docs/api/classes/llvm/vectortype/#afdce715c901d62e2c1367a0ff5248175">getElementType</a>()-&gt;<a href="/docs/api/classes/llvm/type/#aac5759c83abd6a4af236401a7cfe7a0f">isFloatingPointTy</a>() &amp;&amp;</span></CodeLine>
<Link id="l02247" /><CodeLine lineNumber="2247"><span class="doxyHighlight">      !<a href="/docs/api/namespaces/llvm/#adb004c066abda7e0738004a08bc1827f">isKnownNeverNaN</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, 0, SQ))</span></CodeLine>
<Link id="l02248" /><CodeLine lineNumber="2248"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02249" /><CodeLine lineNumber="2249"></CodeLine>
<Link id="l02250" /><CodeLine lineNumber="2250"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Shuffle identity constants into the lanes that return the original value.</span></CodeLine>
<Link id="l02251" /><CodeLine lineNumber="2251"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Example: shuf (mul X, &#123;-1,-2,-3,-4&#125;), X, &#123;0,5,6,3&#125; --&gt; mul X, &#123;-1,1,1,-4&#125;</span></CodeLine>
<Link id="l02252" /><CodeLine lineNumber="2252"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Example: shuf X, (add X, &#123;-1,-2,-3,-4&#125;), &#123;0,1,6,7&#125; --&gt; add X, &#123;0,0,-3,-4&#125;</span></CodeLine>
<Link id="l02253" /><CodeLine lineNumber="2253"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The existing binop constant vector remains in the same operand position.</span></CodeLine>
<Link id="l02254" /><CodeLine lineNumber="2254"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;int&gt;</a> Mask = Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>();</span></CodeLine>
<Link id="l02255" /><CodeLine lineNumber="2255"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/constant">Constant</a> &#42;NewC = Op0IsBinop ? <a href="/docs/api/classes/llvm/constantexpr/#a6f6506f0bc515fe29da3b58565300017">ConstantExpr::getShuffleVector</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, IdC, Mask) :</span></CodeLine>
<Link id="l02256" /><CodeLine lineNumber="2256"><span class="doxyHighlight">                                <a href="/docs/api/classes/llvm/constantexpr/#a6f6506f0bc515fe29da3b58565300017">ConstantExpr::getShuffleVector</a>(IdC, <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, Mask);</span></CodeLine>
<Link id="l02257" /><CodeLine lineNumber="2257"></CodeLine>
<Link id="l02258" /><CodeLine lineNumber="2258"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> MightCreatePoisonOrUB =</span></CodeLine>
<Link id="l02259" /><CodeLine lineNumber="2259"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#acd1cd968cb420c82d70926920fcdc7d7">is&#95;contained</a>(Mask, <a href="/docs/api/namespaces/llvm/#a9965a6249be879ba3d336a75a4f3efa7">PoisonMaskElem</a>) &amp;&amp;</span></CodeLine>
<Link id="l02260" /><CodeLine lineNumber="2260"><span class="doxyHighlight">      (<a href="/docs/api/classes/llvm/instruction/#af9c2825ab53adf1bf8c9fa19ec89d986">Instruction::isIntDivRem</a>(BOpcode) || <a href="/docs/api/classes/llvm/instruction/#ac5984d6827f6e6922bed00bf03ba9552">Instruction::isShift</a>(BOpcode));</span></CodeLine>
<Link id="l02261" /><CodeLine lineNumber="2261"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (MightCreatePoisonOrUB)</span></CodeLine>
<Link id="l02262" /><CodeLine lineNumber="2262"><span class="doxyHighlight">    NewC = <a href="/docs/api/classes/llvm/instcombiner/#acf9cbfcb493b0042022c94230e9350e2">InstCombiner::getSafeVectorConstantForBinop</a>(BOpcode, NewC, </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02263" /><CodeLine lineNumber="2263"></CodeLine>
<Link id="l02264" /><CodeLine lineNumber="2264"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuf (bop X, C), X, M --&gt; bop X, C&#39;</span></CodeLine>
<Link id="l02265" /><CodeLine lineNumber="2265"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuf X, (bop X, C), M --&gt; bop X, C&#39;</span></CodeLine>
<Link id="l02266" /><CodeLine lineNumber="2266"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;NewBO = <a href="/docs/api/classes/llvm/binaryoperator/#a8f385eda0f71b4e8199b296fbc8e0da9">BinaryOperator::Create</a>(BOpcode, <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, NewC);</span></CodeLine>
<Link id="l02267" /><CodeLine lineNumber="2267"><span class="doxyHighlight">  NewBO-&gt;<a href="/docs/api/classes/llvm/instruction/#a3e6d2896c39a84cfa6c47f34cdc584ff">copyIRFlags</a>(BO);</span></CodeLine>
<Link id="l02268" /><CodeLine lineNumber="2268"></CodeLine>
<Link id="l02269" /><CodeLine lineNumber="2269"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// An undef shuffle mask element may propagate as an undef constant element in</span></CodeLine>
<Link id="l02270" /><CodeLine lineNumber="2270"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the new binop. That would produce poison where the original code might not.</span></CodeLine>
<Link id="l02271" /><CodeLine lineNumber="2271"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we already made a safe constant, then there&#39;s no danger.</span></CodeLine>
<Link id="l02272" /><CodeLine lineNumber="2272"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#acd1cd968cb420c82d70926920fcdc7d7">is&#95;contained</a>(Mask, <a href="/docs/api/namespaces/llvm/#a9965a6249be879ba3d336a75a4f3efa7">PoisonMaskElem</a>) &amp;&amp; !MightCreatePoisonOrUB)</span></CodeLine>
<Link id="l02273" /><CodeLine lineNumber="2273"><span class="doxyHighlight">    NewBO-&gt;<a href="/docs/api/classes/llvm/instruction/#ad4613def4002aa69721553e567ca4187">dropPoisonGeneratingFlags</a>();</span></CodeLine>
<Link id="l02274" /><CodeLine lineNumber="2274"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> NewBO;</span></CodeLine>
<Link id="l02275" /><CodeLine lineNumber="2275"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02276" /><CodeLine lineNumber="2276"></CodeLine>
<Link id="l02277" /><CodeLine lineNumber="2277"><span class="doxyHighlightComment">/// If we have an insert of a scalar to a non-zero element of an undefined</span></CodeLine>
<Link id="l02278" /><CodeLine lineNumber="2278"><span class="doxyHighlightComment">/// vector and then shuffle that value, that&#39;s the same as inserting to the zero</span></CodeLine>
<Link id="l02279" /><CodeLine lineNumber="2279"><span class="doxyHighlightComment">/// element and shuffling. Splatting from the zero element is recognized as the</span></CodeLine>
<Link id="l02280" /><CodeLine lineNumber="2280"><span class="doxyHighlightComment">/// canonical form of splat.</span></CodeLine>
<Link id="l02281" /><CodeLine lineNumber="2281" lineLink="#a6e6cf92e2cfe0eb48abec55606e0481e"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="#a6e6cf92e2cfe0eb48abec55606e0481e">canonicalizeInsertSplat</a>(<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp;Shuf,</span></CodeLine>
<Link id="l02282" /><CodeLine lineNumber="2282"><span class="doxyHighlight">                                            <a href="/docs/api/classes/llvm/instcombiner/#a19c4df37b96c2a73991556b696924584">InstCombiner::BuilderTy</a> &amp;Builder) &#123;</span></CodeLine>
<Link id="l02283" /><CodeLine lineNumber="2283"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;Op0 = Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0), &#42;Op1 = Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1);</span></CodeLine>
<Link id="l02284" /><CodeLine lineNumber="2284"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;int&gt;</a> Mask = Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>();</span></CodeLine>
<Link id="l02285" /><CodeLine lineNumber="2285"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>;</span></CodeLine>
<Link id="l02286" /><CodeLine lineNumber="2286"><span class="doxyHighlight">  uint64&#95;t IndexC;</span></CodeLine>
<Link id="l02287" /><CodeLine lineNumber="2287"></CodeLine>
<Link id="l02288" /><CodeLine lineNumber="2288"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Match a shuffle that is a splat to a non-zero element.</span></CodeLine>
<Link id="l02289" /><CodeLine lineNumber="2289"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Op0, <a href="/docs/api/namespaces/llvm/patternmatch/#a5be13f3abb6bddf7ad9747b077da5a0e">m&#95;OneUse</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aec67d7d9e090f41ec66d0d10169a440e">m&#95;InsertElt</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>(), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>),</span></CodeLine>
<Link id="l02290" /><CodeLine lineNumber="2290"><span class="doxyHighlight">                                       <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>(IndexC)))) ||</span></CodeLine>
<Link id="l02291" /><CodeLine lineNumber="2291"><span class="doxyHighlight">      !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Op1, <a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>()) || <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Mask, <a href="/docs/api/structs/llvm/patternmatch/m-zeromask">m&#95;ZeroMask</a>()) || IndexC == 0)</span></CodeLine>
<Link id="l02292" /><CodeLine lineNumber="2292"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02293" /><CodeLine lineNumber="2293"></CodeLine>
<Link id="l02294" /><CodeLine lineNumber="2294"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Insert into element 0 of a poison vector.</span></CodeLine>
<Link id="l02295" /><CodeLine lineNumber="2295"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/poisonvalue">PoisonValue</a> &#42;PoisonVec = <a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a59c34209e9206120edf7ce3c5da4f872">getType</a>());</span></CodeLine>
<Link id="l02296" /><CodeLine lineNumber="2296"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;NewIns = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a17320ebd77e834577a5ebd1063039625">CreateInsertElement</a>(PoisonVec, <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, (uint64&#95;t)0);</span></CodeLine>
<Link id="l02297" /><CodeLine lineNumber="2297"></CodeLine>
<Link id="l02298" /><CodeLine lineNumber="2298"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Splat from element 0 Any mask element that is poison remains poison.</span></CodeLine>
<Link id="l02299" /><CodeLine lineNumber="2299"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For example:</span></CodeLine>
<Link id="l02300" /><CodeLine lineNumber="2300"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuf (inselt poison, X, 2), &#95;, &lt;2,2,undef&gt;</span></CodeLine>
<Link id="l02301" /><CodeLine lineNumber="2301"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   --&gt; shuf (inselt poison, X, 0), poison, &lt;0,0,undef&gt;</span></CodeLine>
<Link id="l02302" /><CodeLine lineNumber="2302"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumMaskElts =</span></CodeLine>
<Link id="l02303" /><CodeLine lineNumber="2303"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a59c34209e9206120edf7ce3c5da4f872">getType</a>())-&gt;getNumElements();</span></CodeLine>
<Link id="l02304" /><CodeLine lineNumber="2304"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;int, 16&gt;</a> NewMask(NumMaskElts, 0);</span></CodeLine>
<Link id="l02305" /><CodeLine lineNumber="2305"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> i = 0; i != NumMaskElts; ++i)</span></CodeLine>
<Link id="l02306" /><CodeLine lineNumber="2306"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Mask&#91;i&#93; == <a href="/docs/api/namespaces/llvm/#a9965a6249be879ba3d336a75a4f3efa7">PoisonMaskElem</a>)</span></CodeLine>
<Link id="l02307" /><CodeLine lineNumber="2307"><span class="doxyHighlight">      NewMask&#91;i&#93; = Mask&#91;i&#93;;</span></CodeLine>
<Link id="l02308" /><CodeLine lineNumber="2308"></CodeLine>
<Link id="l02309" /><CodeLine lineNumber="2309"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a>(NewIns, NewMask);</span></CodeLine>
<Link id="l02310" /><CodeLine lineNumber="2310"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02311" /><CodeLine lineNumber="2311"></CodeLine>
<Link id="l02312" /><CodeLine lineNumber="2312"><span class="doxyHighlightComment">/// Try to fold shuffles that are the equivalent of a vector select.</span></CodeLine>
<Link id="l02313" /><CodeLine lineNumber="2313" lineLink="/docs/api/classes/llvm/instcombinerimpl/#a3b73df3a995af9ca26c9d024c957c45a"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/classes/llvm/instcombinerimpl/#a3b73df3a995af9ca26c9d024c957c45a">InstCombinerImpl::foldSelectShuffle</a>(<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp;Shuf) &#123;</span></CodeLine>
<Link id="l02314" /><CodeLine lineNumber="2314"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a747673ac3ea44aadc3907c6b9fd86237">isSelect</a>())</span></CodeLine>
<Link id="l02315" /><CodeLine lineNumber="2315"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02316" /><CodeLine lineNumber="2316"></CodeLine>
<Link id="l02317" /><CodeLine lineNumber="2317"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Canonicalize to choose from operand 0 first unless operand 1 is undefined.</span></CodeLine>
<Link id="l02318" /><CodeLine lineNumber="2318"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Commuting undef to operand 0 conflicts with another canonicalization.</span></CodeLine>
<Link id="l02319" /><CodeLine lineNumber="2319"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumElts = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a59c34209e9206120edf7ce3c5da4f872">getType</a>())-&gt;getNumElements();</span></CodeLine>
<Link id="l02320" /><CodeLine lineNumber="2320"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1), <a href="/docs/api/namespaces/llvm/patternmatch/#adea6dc2e42baa345b97be48b0370313d">m&#95;Undef</a>()) &amp;&amp;</span></CodeLine>
<Link id="l02321" /><CodeLine lineNumber="2321"><span class="doxyHighlight">      Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a3fb8619f70f51242f81ef96da349c884">getMaskValue</a>(0) &gt;= (</span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight">)NumElts) &#123;</span></CodeLine>
<Link id="l02322" /><CodeLine lineNumber="2322"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// TODO: Can we assert that both operands of a shuffle-select are not undef</span></CodeLine>
<Link id="l02323" /><CodeLine lineNumber="2323"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// (otherwise, it would have been folded by instsimplify?</span></CodeLine>
<Link id="l02324" /><CodeLine lineNumber="2324"><span class="doxyHighlight">    Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#aa94c68d274d913e05b0423c7b2fded00">commute</a>();</span></CodeLine>
<Link id="l02325" /><CodeLine lineNumber="2325"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &amp;Shuf;</span></CodeLine>
<Link id="l02326" /><CodeLine lineNumber="2326"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02327" /><CodeLine lineNumber="2327"></CodeLine>
<Link id="l02328" /><CodeLine lineNumber="2328"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="#a98282716af42c878d4638603c6efb350">foldSelectShuffleOfSelectShuffle</a>(Shuf))</span></CodeLine>
<Link id="l02329" /><CodeLine lineNumber="2329"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l02330" /><CodeLine lineNumber="2330"></CodeLine>
<Link id="l02331" /><CodeLine lineNumber="2331"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="#a2c05df65ce7ce7ec1d78348be2452e8d">foldSelectShuffleWith1Binop</a>(</span></CodeLine>
<Link id="l02332" /><CodeLine lineNumber="2332"><span class="doxyHighlight">          Shuf, <a href="/docs/api/classes/llvm/instcombiner/#af56f7a148b00922368e55ab9c4948724">getSimplifyQuery</a>().getWithInstruction(&amp;Shuf)))</span></CodeLine>
<Link id="l02333" /><CodeLine lineNumber="2333"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l02334" /><CodeLine lineNumber="2334"></CodeLine>
<Link id="l02335" /><CodeLine lineNumber="2335"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/binaryoperator">BinaryOperator</a> &#42;B0, &#42;B1;</span></CodeLine>
<Link id="l02336" /><CodeLine lineNumber="2336"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0), <a href="/docs/api/namespaces/llvm/patternmatch/#a0698afabe907d2d3b87889d2e0349d47">m&#95;BinOp</a>(B0)) ||</span></CodeLine>
<Link id="l02337" /><CodeLine lineNumber="2337"><span class="doxyHighlight">      !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1), <a href="/docs/api/namespaces/llvm/patternmatch/#a0698afabe907d2d3b87889d2e0349d47">m&#95;BinOp</a>(B1)))</span></CodeLine>
<Link id="l02338" /><CodeLine lineNumber="2338"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02339" /><CodeLine lineNumber="2339"></CodeLine>
<Link id="l02340" /><CodeLine lineNumber="2340"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If one operand is &quot;0 - X&quot;, allow that to be viewed as &quot;X &#42; -1&quot;</span></CodeLine>
<Link id="l02341" /><CodeLine lineNumber="2341"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// (ConstantsAreOp1) by getAlternateBinop below. If the neg is not paired</span></CodeLine>
<Link id="l02342" /><CodeLine lineNumber="2342"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// with a multiply, we will exit because C0/C1 will not be set.</span></CodeLine>
<Link id="l02343" /><CodeLine lineNumber="2343"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>;</span></CodeLine>
<Link id="l02344" /><CodeLine lineNumber="2344"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/constant">Constant</a> &#42;C0 = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">, &#42;C1 = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02345" /><CodeLine lineNumber="2345"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> ConstantsAreOp1;</span></CodeLine>
<Link id="l02346" /><CodeLine lineNumber="2346"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(B0, <a href="/docs/api/namespaces/llvm/patternmatch/#a0698afabe907d2d3b87889d2e0349d47">m&#95;BinOp</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a16be5fe0cce90e51f8c0e0c4d6c589f6">m&#95;Constant</a>(C0), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>))) &amp;&amp;</span></CodeLine>
<Link id="l02347" /><CodeLine lineNumber="2347"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(B1, <a href="/docs/api/namespaces/llvm/patternmatch/#a0698afabe907d2d3b87889d2e0349d47">m&#95;BinOp</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a16be5fe0cce90e51f8c0e0c4d6c589f6">m&#95;Constant</a>(C1), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>))))</span></CodeLine>
<Link id="l02348" /><CodeLine lineNumber="2348"><span class="doxyHighlight">    ConstantsAreOp1 = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02349" /><CodeLine lineNumber="2349"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(B0, <a href="/docs/api/namespaces/llvm/patternmatch/#afc43bc5ec4b20c7c5d663bef90da6066">m&#95;CombineOr</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a0698afabe907d2d3b87889d2e0349d47">m&#95;BinOp</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>), <a href="/docs/api/namespaces/llvm/patternmatch/#a16be5fe0cce90e51f8c0e0c4d6c589f6">m&#95;Constant</a>(C0)),</span></CodeLine>
<Link id="l02350" /><CodeLine lineNumber="2350"><span class="doxyHighlight">                                 <a href="/docs/api/namespaces/llvm/patternmatch/#a5d295dcffba83c3c5a17d2fb3273b434">m&#95;Neg</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>)))) &amp;&amp;</span></CodeLine>
<Link id="l02351" /><CodeLine lineNumber="2351"><span class="doxyHighlight">           <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(B1, <a href="/docs/api/namespaces/llvm/patternmatch/#afc43bc5ec4b20c7c5d663bef90da6066">m&#95;CombineOr</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a0698afabe907d2d3b87889d2e0349d47">m&#95;BinOp</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>), <a href="/docs/api/namespaces/llvm/patternmatch/#a16be5fe0cce90e51f8c0e0c4d6c589f6">m&#95;Constant</a>(C1)),</span></CodeLine>
<Link id="l02352" /><CodeLine lineNumber="2352"><span class="doxyHighlight">                                 <a href="/docs/api/namespaces/llvm/patternmatch/#a5d295dcffba83c3c5a17d2fb3273b434">m&#95;Neg</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>)))))</span></CodeLine>
<Link id="l02353" /><CodeLine lineNumber="2353"><span class="doxyHighlight">    ConstantsAreOp1 = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02354" /><CodeLine lineNumber="2354"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l02355" /><CodeLine lineNumber="2355"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02356" /><CodeLine lineNumber="2356"></CodeLine>
<Link id="l02357" /><CodeLine lineNumber="2357"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We need matching binops to fold the lanes together.</span></CodeLine>
<Link id="l02358" /><CodeLine lineNumber="2358"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/instruction/#ac26154a24f393f523c87cc5f8239f36c">BinaryOperator::BinaryOps</a> Opc0 = B0-&gt;<a href="/docs/api/classes/llvm/binaryoperator/#a31bf07f3f61525486633bc1d0bbaf029">getOpcode</a>();</span></CodeLine>
<Link id="l02359" /><CodeLine lineNumber="2359"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/instruction/#ac26154a24f393f523c87cc5f8239f36c">BinaryOperator::BinaryOps</a> Opc1 = B1-&gt;<a href="/docs/api/classes/llvm/binaryoperator/#a31bf07f3f61525486633bc1d0bbaf029">getOpcode</a>();</span></CodeLine>
<Link id="l02360" /><CodeLine lineNumber="2360"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> DropNSW = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02361" /><CodeLine lineNumber="2361"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ConstantsAreOp1 &amp;&amp; Opc0 != Opc1) &#123;</span></CodeLine>
<Link id="l02362" /><CodeLine lineNumber="2362"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// TODO: We drop &quot;nsw&quot; if shift is converted into multiply because it may</span></CodeLine>
<Link id="l02363" /><CodeLine lineNumber="2363"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// not be correct when the shift amount is BitWidth - 1 We could examine</span></CodeLine>
<Link id="l02364" /><CodeLine lineNumber="2364"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// each vector element to determine if it is safe to keep that flag.</span></CodeLine>
<Link id="l02365" /><CodeLine lineNumber="2365"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Opc0 == Instruction::Shl || Opc1 == Instruction::Shl)</span></CodeLine>
<Link id="l02366" /><CodeLine lineNumber="2366"><span class="doxyHighlight">      DropNSW = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02367" /><CodeLine lineNumber="2367"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/structs/binopelts">BinopElts</a> AltB0 = <a href="#af7e7c9415c23ae336af651877798a377">getAlternateBinop</a>(B0, <a href="/docs/api/classes/llvm/instcombiner/#a878e8128a9a4e5626df91dcd91cba337">DL</a>)) &#123;</span></CodeLine>
<Link id="l02368" /><CodeLine lineNumber="2368"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;Constant&gt;</a>(AltB0.Op1) &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Expecting constant with alt binop&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02369" /><CodeLine lineNumber="2369"><span class="doxyHighlight">      Opc0 = AltB0.Opcode;</span></CodeLine>
<Link id="l02370" /><CodeLine lineNumber="2370"><span class="doxyHighlight">      C0 = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Constant&gt;</a>(AltB0.Op1);</span></CodeLine>
<Link id="l02371" /><CodeLine lineNumber="2371"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/structs/binopelts">BinopElts</a> AltB1 = <a href="#af7e7c9415c23ae336af651877798a377">getAlternateBinop</a>(B1, <a href="/docs/api/classes/llvm/instcombiner/#a878e8128a9a4e5626df91dcd91cba337">DL</a>)) &#123;</span></CodeLine>
<Link id="l02372" /><CodeLine lineNumber="2372"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;Constant&gt;</a>(AltB1.Op1) &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Expecting constant with alt binop&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02373" /><CodeLine lineNumber="2373"><span class="doxyHighlight">      Opc1 = AltB1.Opcode;</span></CodeLine>
<Link id="l02374" /><CodeLine lineNumber="2374"><span class="doxyHighlight">      C1 = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Constant&gt;</a>(AltB1.Op1);</span></CodeLine>
<Link id="l02375" /><CodeLine lineNumber="2375"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02376" /><CodeLine lineNumber="2376"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02377" /><CodeLine lineNumber="2377"></CodeLine>
<Link id="l02378" /><CodeLine lineNumber="2378"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Opc0 != Opc1 || !C0 || !C1)</span></CodeLine>
<Link id="l02379" /><CodeLine lineNumber="2379"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02380" /><CodeLine lineNumber="2380"></CodeLine>
<Link id="l02381" /><CodeLine lineNumber="2381"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The opcodes must be the same. Use a new name to make that clear.</span></CodeLine>
<Link id="l02382" /><CodeLine lineNumber="2382"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/instruction/#ac26154a24f393f523c87cc5f8239f36c">BinaryOperator::BinaryOps</a> BOpc = Opc0;</span></CodeLine>
<Link id="l02383" /><CodeLine lineNumber="2383"></CodeLine>
<Link id="l02384" /><CodeLine lineNumber="2384"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Select the constant elements needed for the single binop.</span></CodeLine>
<Link id="l02385" /><CodeLine lineNumber="2385"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;int&gt;</a> Mask = Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>();</span></CodeLine>
<Link id="l02386" /><CodeLine lineNumber="2386"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/constant">Constant</a> &#42;NewC = <a href="/docs/api/classes/llvm/constantexpr/#a6f6506f0bc515fe29da3b58565300017">ConstantExpr::getShuffleVector</a>(C0, C1, Mask);</span></CodeLine>
<Link id="l02387" /><CodeLine lineNumber="2387"></CodeLine>
<Link id="l02388" /><CodeLine lineNumber="2388"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We are moving a binop after a shuffle. When a shuffle has an undefined</span></CodeLine>
<Link id="l02389" /><CodeLine lineNumber="2389"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// mask element, the result is undefined, but it is not poison or undefined</span></CodeLine>
<Link id="l02390" /><CodeLine lineNumber="2390"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// behavior. That is not necessarily true for div/rem/shift.</span></CodeLine>
<Link id="l02391" /><CodeLine lineNumber="2391"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> MightCreatePoisonOrUB =</span></CodeLine>
<Link id="l02392" /><CodeLine lineNumber="2392"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#acd1cd968cb420c82d70926920fcdc7d7">is&#95;contained</a>(Mask, <a href="/docs/api/namespaces/llvm/#a9965a6249be879ba3d336a75a4f3efa7">PoisonMaskElem</a>) &amp;&amp;</span></CodeLine>
<Link id="l02393" /><CodeLine lineNumber="2393"><span class="doxyHighlight">      (<a href="/docs/api/classes/llvm/instruction/#af9c2825ab53adf1bf8c9fa19ec89d986">Instruction::isIntDivRem</a>(BOpc) || <a href="/docs/api/classes/llvm/instruction/#ac5984d6827f6e6922bed00bf03ba9552">Instruction::isShift</a>(BOpc));</span></CodeLine>
<Link id="l02394" /><CodeLine lineNumber="2394"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (MightCreatePoisonOrUB)</span></CodeLine>
<Link id="l02395" /><CodeLine lineNumber="2395"><span class="doxyHighlight">    NewC = <a href="/docs/api/classes/llvm/instcombiner/#acf9cbfcb493b0042022c94230e9350e2">InstCombiner::getSafeVectorConstantForBinop</a>(BOpc, NewC,</span></CodeLine>
<Link id="l02396" /><CodeLine lineNumber="2396"><span class="doxyHighlight">                                                       ConstantsAreOp1);</span></CodeLine>
<Link id="l02397" /><CodeLine lineNumber="2397"></CodeLine>
<Link id="l02398" /><CodeLine lineNumber="2398"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;V;</span></CodeLine>
<Link id="l02399" /><CodeLine lineNumber="2399"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a> == <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>) &#123;</span></CodeLine>
<Link id="l02400" /><CodeLine lineNumber="2400"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Remove a binop and the shuffle by rearranging the constant:</span></CodeLine>
<Link id="l02401" /><CodeLine lineNumber="2401"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// shuffle (op V, C0), (op V, C1), M --&gt; op V, C&#39;</span></CodeLine>
<Link id="l02402" /><CodeLine lineNumber="2402"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// shuffle (op C0, V), (op C1, V), M --&gt; op C&#39;, V</span></CodeLine>
<Link id="l02403" /><CodeLine lineNumber="2403"><span class="doxyHighlight">    V = <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>;</span></CodeLine>
<Link id="l02404" /><CodeLine lineNumber="2404"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l02405" /><CodeLine lineNumber="2405"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If there are 2 different variable operands, we must create a new shuffle</span></CodeLine>
<Link id="l02406" /><CodeLine lineNumber="2406"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// (select) first, so check uses to ensure that we don&#39;t end up with more</span></CodeLine>
<Link id="l02407" /><CodeLine lineNumber="2407"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// instructions than we started with.</span></CodeLine>
<Link id="l02408" /><CodeLine lineNumber="2408"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!B0-&gt;<a href="/docs/api/classes/llvm/value/#a3a402430a1bbe70a9282dcb0e0b6a2cd">hasOneUse</a>() &amp;&amp; !B1-&gt;<a href="/docs/api/classes/llvm/value/#a3a402430a1bbe70a9282dcb0e0b6a2cd">hasOneUse</a>())</span></CodeLine>
<Link id="l02409" /><CodeLine lineNumber="2409"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02410" /><CodeLine lineNumber="2410"></CodeLine>
<Link id="l02411" /><CodeLine lineNumber="2411"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If we use the original shuffle mask and op1 is &#42;variable&#42;, we would be</span></CodeLine>
<Link id="l02412" /><CodeLine lineNumber="2412"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// putting an undef into operand 1 of div/rem/shift. This is either UB or</span></CodeLine>
<Link id="l02413" /><CodeLine lineNumber="2413"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// poison. We do not have to guard against UB when &#42;constants&#42; are op1</span></CodeLine>
<Link id="l02414" /><CodeLine lineNumber="2414"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// because safe constants guarantee that we do not overflow sdiv/srem (and</span></CodeLine>
<Link id="l02415" /><CodeLine lineNumber="2415"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// there&#39;s no danger for other opcodes).</span></CodeLine>
<Link id="l02416" /><CodeLine lineNumber="2416"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// TODO: To allow this case, create a new shuffle mask with no undefs.</span></CodeLine>
<Link id="l02417" /><CodeLine lineNumber="2417"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (MightCreatePoisonOrUB &amp;&amp; !ConstantsAreOp1)</span></CodeLine>
<Link id="l02418" /><CodeLine lineNumber="2418"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02419" /><CodeLine lineNumber="2419"></CodeLine>
<Link id="l02420" /><CodeLine lineNumber="2420"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Note: In general, we do not create new shuffles in InstCombine because we</span></CodeLine>
<Link id="l02421" /><CodeLine lineNumber="2421"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// do not know if a target can lower an arbitrary shuffle optimally. In this</span></CodeLine>
<Link id="l02422" /><CodeLine lineNumber="2422"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// case, the shuffle uses the existing mask, so there is no additional risk.</span></CodeLine>
<Link id="l02423" /><CodeLine lineNumber="2423"></CodeLine>
<Link id="l02424" /><CodeLine lineNumber="2424"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Select the variable vectors first, then perform the binop:</span></CodeLine>
<Link id="l02425" /><CodeLine lineNumber="2425"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// shuffle (op X, C0), (op Y, C1), M --&gt; op (shuffle X, Y, M), C&#39;</span></CodeLine>
<Link id="l02426" /><CodeLine lineNumber="2426"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// shuffle (op C0, X), (op C1, Y), M --&gt; op C&#39;, (shuffle X, Y, M)</span></CodeLine>
<Link id="l02427" /><CodeLine lineNumber="2427"><span class="doxyHighlight">    V = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateShuffleVector(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>, Mask);</span></CodeLine>
<Link id="l02428" /><CodeLine lineNumber="2428"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02429" /><CodeLine lineNumber="2429"></CodeLine>
<Link id="l02430" /><CodeLine lineNumber="2430"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;NewBO = ConstantsAreOp1 ? <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateBinOp(BOpc, V, NewC) :</span></CodeLine>
<Link id="l02431" /><CodeLine lineNumber="2431"><span class="doxyHighlight">                                   <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateBinOp(BOpc, NewC, V);</span></CodeLine>
<Link id="l02432" /><CodeLine lineNumber="2432"></CodeLine>
<Link id="l02433" /><CodeLine lineNumber="2433"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Flags are intersected from the 2 source binops. But there are 2 exceptions:</span></CodeLine>
<Link id="l02434" /><CodeLine lineNumber="2434"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// 1 If we changed an opcode, poison conditions might have changed.</span></CodeLine>
<Link id="l02435" /><CodeLine lineNumber="2435"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// 2 If the shuffle had undef mask elements, the new binop might have undefs</span></CodeLine>
<Link id="l02436" /><CodeLine lineNumber="2436"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    where the original code did not. But if we already made a safe constant,</span></CodeLine>
<Link id="l02437" /><CodeLine lineNumber="2437"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    then there&#39;s no danger.</span></CodeLine>
<Link id="l02438" /><CodeLine lineNumber="2438"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(NewBO)) &#123;</span></CodeLine>
<Link id="l02439" /><CodeLine lineNumber="2439"><span class="doxyHighlight">    NewI-&gt;copyIRFlags(B0);</span></CodeLine>
<Link id="l02440" /><CodeLine lineNumber="2440"><span class="doxyHighlight">    NewI-&gt;andIRFlags(B1);</span></CodeLine>
<Link id="l02441" /><CodeLine lineNumber="2441"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (DropNSW)</span></CodeLine>
<Link id="l02442" /><CodeLine lineNumber="2442"><span class="doxyHighlight">      NewI-&gt;setHasNoSignedWrap(</span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02443" /><CodeLine lineNumber="2443"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#acd1cd968cb420c82d70926920fcdc7d7">is&#95;contained</a>(Mask, <a href="/docs/api/namespaces/llvm/#a9965a6249be879ba3d336a75a4f3efa7">PoisonMaskElem</a>) &amp;&amp; !MightCreatePoisonOrUB)</span></CodeLine>
<Link id="l02444" /><CodeLine lineNumber="2444"><span class="doxyHighlight">      NewI-&gt;dropPoisonGeneratingFlags();</span></CodeLine>
<Link id="l02445" /><CodeLine lineNumber="2445"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02446" /><CodeLine lineNumber="2446"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instcombiner/#a49f1bd0bdf0ef741bdd714cc1188d7c5">replaceInstUsesWith</a>(Shuf, NewBO);</span></CodeLine>
<Link id="l02447" /><CodeLine lineNumber="2447"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02448" /><CodeLine lineNumber="2448"></CodeLine>
<Link id="l02449" /><CodeLine lineNumber="2449"><span class="doxyHighlightComment">/// Convert a narrowing shuffle of a bitcasted vector into a vector truncate.</span></CodeLine>
<Link id="l02450" /><CodeLine lineNumber="2450"><span class="doxyHighlightComment">/// Example (little endian):</span></CodeLine>
<Link id="l02451" /><CodeLine lineNumber="2451"><span class="doxyHighlightComment">/// shuf (bitcast &lt;4 x i16&gt; X to &lt;8 x i8&gt;), &lt;0, 2, 4, 6&gt; --&gt; trunc X to &lt;4 x i8&gt;</span></CodeLine>
<Link id="l02452" /><CodeLine lineNumber="2452" lineLink="#a747cca8cf8e4c4e41b81bb1cbf146a11"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="#a747cca8cf8e4c4e41b81bb1cbf146a11">foldTruncShuffle</a>(<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp;Shuf,</span></CodeLine>
<Link id="l02453" /><CodeLine lineNumber="2453"><span class="doxyHighlight">                                     </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> IsBigEndian) &#123;</span></CodeLine>
<Link id="l02454" /><CodeLine lineNumber="2454"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// This must be a bitcasted shuffle of 1 vector integer operand.</span></CodeLine>
<Link id="l02455" /><CodeLine lineNumber="2455"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/type">Type</a> &#42;DestType = Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a59c34209e9206120edf7ce3c5da4f872">getType</a>();</span></CodeLine>
<Link id="l02456" /><CodeLine lineNumber="2456"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>;</span></CodeLine>
<Link id="l02457" /><CodeLine lineNumber="2457"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0), <a href="/docs/api/namespaces/llvm/patternmatch/#a99d8e67ed2343ad6717d7a8fdd3e7c7a">m&#95;BitCast</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>))) ||</span></CodeLine>
<Link id="l02458" /><CodeLine lineNumber="2458"><span class="doxyHighlight">      !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1), <a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>()) || !DestType-&gt;<a href="/docs/api/classes/llvm/type/#a34ee40bb2f4f5ece47ef19e5f1f57e3c">isIntOrIntVectorTy</a>())</span></CodeLine>
<Link id="l02459" /><CodeLine lineNumber="2459"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02460" /><CodeLine lineNumber="2460"></CodeLine>
<Link id="l02461" /><CodeLine lineNumber="2461"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The source type must have the same number of elements as the shuffle,</span></CodeLine>
<Link id="l02462" /><CodeLine lineNumber="2462"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// and the source element type must be larger than the shuffle element type.</span></CodeLine>
<Link id="l02463" /><CodeLine lineNumber="2463"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/type">Type</a> &#42;SrcType = <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;getType();</span></CodeLine>
<Link id="l02464" /><CodeLine lineNumber="2464"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!SrcType-&gt;isVectorTy() || !SrcType-&gt;isIntOrIntVectorTy() ||</span></CodeLine>
<Link id="l02465" /><CodeLine lineNumber="2465"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(SrcType)-&gt;getNumElements() !=</span></CodeLine>
<Link id="l02466" /><CodeLine lineNumber="2466"><span class="doxyHighlight">          <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(DestType)-&gt;getNumElements() ||</span></CodeLine>
<Link id="l02467" /><CodeLine lineNumber="2467"><span class="doxyHighlight">      SrcType-&gt;getScalarSizeInBits() % DestType-&gt;<a href="/docs/api/classes/llvm/type/#a9f382207d841377156d4c7868b66b9a5">getScalarSizeInBits</a>() != 0)</span></CodeLine>
<Link id="l02468" /><CodeLine lineNumber="2468"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02469" /><CodeLine lineNumber="2469"></CodeLine>
<Link id="l02470" /><CodeLine lineNumber="2470"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a1552dc44fac81fb75a474feaa2ffdab8">changesLength</a>() &amp;&amp; !Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a6315811e3cc527c8f1ab15ae0c789b93">increasesLength</a>() &amp;&amp;</span></CodeLine>
<Link id="l02471" /><CodeLine lineNumber="2471"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;Expected a shuffle that decreases length&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02472" /><CodeLine lineNumber="2472"></CodeLine>
<Link id="l02473" /><CodeLine lineNumber="2473"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Last, check that the mask chooses the correct low bits for each narrow</span></CodeLine>
<Link id="l02474" /><CodeLine lineNumber="2474"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// element in the result.</span></CodeLine>
<Link id="l02475" /><CodeLine lineNumber="2475"><span class="doxyHighlight">  uint64&#95;t TruncRatio =</span></CodeLine>
<Link id="l02476" /><CodeLine lineNumber="2476"><span class="doxyHighlight">      SrcType-&gt;getScalarSizeInBits() / DestType-&gt;<a href="/docs/api/classes/llvm/type/#a9f382207d841377156d4c7868b66b9a5">getScalarSizeInBits</a>();</span></CodeLine>
<Link id="l02477" /><CodeLine lineNumber="2477"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;int&gt;</a> Mask = Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>();</span></CodeLine>
<Link id="l02478" /><CodeLine lineNumber="2478"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> i = 0, e = Mask.size(); i != e; ++i) &#123;</span></CodeLine>
<Link id="l02479" /><CodeLine lineNumber="2479"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Mask&#91;i&#93; == <a href="/docs/api/namespaces/llvm/#a9965a6249be879ba3d336a75a4f3efa7">PoisonMaskElem</a>)</span></CodeLine>
<Link id="l02480" /><CodeLine lineNumber="2480"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02481" /><CodeLine lineNumber="2481"><span class="doxyHighlight">    uint64&#95;t LSBIndex = IsBigEndian ? (i + 1) &#42; TruncRatio - 1 : i &#42; TruncRatio;</span></CodeLine>
<Link id="l02482" /><CodeLine lineNumber="2482"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(LSBIndex &lt;= INT32&#95;MAX &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Overflowed 32-bits&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02483" /><CodeLine lineNumber="2483"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Mask&#91;i&#93; != (</span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight">)LSBIndex)</span></CodeLine>
<Link id="l02484" /><CodeLine lineNumber="2484"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02485" /><CodeLine lineNumber="2485"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02486" /><CodeLine lineNumber="2486"></CodeLine>
<Link id="l02487" /><CodeLine lineNumber="2487"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/truncinst">TruncInst</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, DestType);</span></CodeLine>
<Link id="l02488" /><CodeLine lineNumber="2488"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02489" /><CodeLine lineNumber="2489"></CodeLine>
<Link id="l02490" /><CodeLine lineNumber="2490"><span class="doxyHighlightComment">/// Match a shuffle-select-shuffle pattern where the shuffles are widening and</span></CodeLine>
<Link id="l02491" /><CodeLine lineNumber="2491"><span class="doxyHighlightComment">/// narrowing (concatenating with poison and extracting back to the original</span></CodeLine>
<Link id="l02492" /><CodeLine lineNumber="2492"><span class="doxyHighlightComment">/// length). This allows replacing the wide select with a narrow select.</span></CodeLine>
<Link id="l02493" /><CodeLine lineNumber="2493" lineLink="#a746205e6d7f5c0bb265ecc8a911d5b82"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86isellowering-cpp/#a309d56d62904382ce197ab216f4ec43f">narrowVectorSelect</a>(<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp;Shuf,</span></CodeLine>
<Link id="l02494" /><CodeLine lineNumber="2494"><span class="doxyHighlight">                                       <a href="/docs/api/classes/llvm/instcombiner/#a19c4df37b96c2a73991556b696924584">InstCombiner::BuilderTy</a> &amp;Builder) &#123;</span></CodeLine>
<Link id="l02495" /><CodeLine lineNumber="2495"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// This must be a narrowing identity shuffle. It extracts the 1st N elements</span></CodeLine>
<Link id="l02496" /><CodeLine lineNumber="2496"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// of the 1st vector operand of a shuffle.</span></CodeLine>
<Link id="l02497" /><CodeLine lineNumber="2497"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1), <a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>()) || !Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a64a379276cb10c6cc61146d8a95cd1a7">isIdentityWithExtract</a>())</span></CodeLine>
<Link id="l02498" /><CodeLine lineNumber="2498"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02499" /><CodeLine lineNumber="2499"></CodeLine>
<Link id="l02500" /><CodeLine lineNumber="2500"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The vector being shuffled must be a vector select that we can eliminate.</span></CodeLine>
<Link id="l02501" /><CodeLine lineNumber="2501"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: The one-use requirement could be eased if X and/or Y are constants.</span></CodeLine>
<Link id="l02502" /><CodeLine lineNumber="2502"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>;</span></CodeLine>
<Link id="l02503" /><CodeLine lineNumber="2503"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0),</span></CodeLine>
<Link id="l02504" /><CodeLine lineNumber="2504"><span class="doxyHighlight">             <a href="/docs/api/namespaces/llvm/patternmatch/#a5be13f3abb6bddf7ad9747b077da5a0e">m&#95;OneUse</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a3ccd94f6a7507492b47c7351e3fb78c6">m&#95;Select</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>)))))</span></CodeLine>
<Link id="l02505" /><CodeLine lineNumber="2505"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02506" /><CodeLine lineNumber="2506"></CodeLine>
<Link id="l02507" /><CodeLine lineNumber="2507"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We need a narrow condition value. It must be extended with poison elements</span></CodeLine>
<Link id="l02508" /><CodeLine lineNumber="2508"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// and have the same number of elements as this shuffle.</span></CodeLine>
<Link id="l02509" /><CodeLine lineNumber="2509"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NarrowNumElts =</span></CodeLine>
<Link id="l02510" /><CodeLine lineNumber="2510"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a59c34209e9206120edf7ce3c5da4f872">getType</a>())-&gt;getNumElements();</span></CodeLine>
<Link id="l02511" /><CodeLine lineNumber="2511"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;NarrowCond;</span></CodeLine>
<Link id="l02512" /><CodeLine lineNumber="2512"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, <a href="/docs/api/namespaces/llvm/patternmatch/#a5be13f3abb6bddf7ad9747b077da5a0e">m&#95;OneUse</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a5eee6cdb006c1d88b1123400f7f462d1">m&#95;Shuffle</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(NarrowCond), <a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>()))) ||</span></CodeLine>
<Link id="l02513" /><CodeLine lineNumber="2513"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(NarrowCond-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>())-&gt;getNumElements() !=</span></CodeLine>
<Link id="l02514" /><CodeLine lineNumber="2514"><span class="doxyHighlight">          NarrowNumElts ||</span></CodeLine>
<Link id="l02515" /><CodeLine lineNumber="2515"><span class="doxyHighlight">      !<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;ShuffleVectorInst&gt;</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>)-&gt;isIdentityWithPadding())</span></CodeLine>
<Link id="l02516" /><CodeLine lineNumber="2516"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02517" /><CodeLine lineNumber="2517"></CodeLine>
<Link id="l02518" /><CodeLine lineNumber="2518"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuf (sel (shuf NarrowCond, poison, WideMask), X, Y), poison, NarrowMask)</span></CodeLine>
<Link id="l02519" /><CodeLine lineNumber="2519"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// --&gt;</span></CodeLine>
<Link id="l02520" /><CodeLine lineNumber="2520"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// sel NarrowCond, (shuf X, poison, NarrowMask), (shuf Y, poison, NarrowMask)</span></CodeLine>
<Link id="l02521" /><CodeLine lineNumber="2521"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;NarrowX = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aa226d30eebf99ef84a0c2b1afcfc98b2">CreateShuffleVector</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>());</span></CodeLine>
<Link id="l02522" /><CodeLine lineNumber="2522"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;NarrowY = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aa226d30eebf99ef84a0c2b1afcfc98b2">CreateShuffleVector</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>, Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>());</span></CodeLine>
<Link id="l02523" /><CodeLine lineNumber="2523"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/selectinst/#a09d8760fa31a7b8739acf71a4d2ac9d9">SelectInst::Create</a>(NarrowCond, NarrowX, NarrowY);</span></CodeLine>
<Link id="l02524" /><CodeLine lineNumber="2524"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02525" /><CodeLine lineNumber="2525"></CodeLine>
<Link id="l02526" /><CodeLine lineNumber="2526"><span class="doxyHighlightComment">/// Canonicalize FP negate/abs after shuffle.</span></CodeLine>
<Link id="l02527" /><CodeLine lineNumber="2527" lineLink="#aabcb01976dc50b78faed7491a6d43042"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="#aabcb01976dc50b78faed7491a6d43042">foldShuffleOfUnaryOps</a>(<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp;Shuf,</span></CodeLine>
<Link id="l02528" /><CodeLine lineNumber="2528"><span class="doxyHighlight">                                          <a href="/docs/api/classes/llvm/instcombiner/#a19c4df37b96c2a73991556b696924584">InstCombiner::BuilderTy</a> &amp;Builder) &#123;</span></CodeLine>
<Link id="l02529" /><CodeLine lineNumber="2529"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;S0 = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0));</span></CodeLine>
<Link id="l02530" /><CodeLine lineNumber="2530"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>;</span></CodeLine>
<Link id="l02531" /><CodeLine lineNumber="2531"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!S0 || !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(S0, <a href="/docs/api/namespaces/llvm/patternmatch/#afc43bc5ec4b20c7c5d663bef90da6066">m&#95;CombineOr</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aba7473bfa862dd9eadf04a6fefc6aa69">m&#95;FNeg</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>)), <a href="/docs/api/namespaces/llvm/patternmatch/#af07397df05f8eb1838b6d79871791e38">m&#95;FAbs</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>)))))</span></CodeLine>
<Link id="l02532" /><CodeLine lineNumber="2532"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02533" /><CodeLine lineNumber="2533"></CodeLine>
<Link id="l02534" /><CodeLine lineNumber="2534"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> IsFNeg = S0-&gt;getOpcode() == Instruction::FNeg;</span></CodeLine>
<Link id="l02535" /><CodeLine lineNumber="2535"></CodeLine>
<Link id="l02536" /><CodeLine lineNumber="2536"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Match 1-input (unary) shuffle.</span></CodeLine>
<Link id="l02537" /><CodeLine lineNumber="2537"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuffle (fneg/fabs X), Mask --&gt; fneg/fabs (shuffle X, Mask)</span></CodeLine>
<Link id="l02538" /><CodeLine lineNumber="2538"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (S0-&gt;hasOneUse() &amp;&amp; <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1), <a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>())) &#123;</span></CodeLine>
<Link id="l02539" /><CodeLine lineNumber="2539"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;NewShuf = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aa226d30eebf99ef84a0c2b1afcfc98b2">CreateShuffleVector</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>());</span></CodeLine>
<Link id="l02540" /><CodeLine lineNumber="2540"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IsFNeg)</span></CodeLine>
<Link id="l02541" /><CodeLine lineNumber="2541"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/unaryoperator/#ab0b2c048acdd570e834bc51018589a2e">UnaryOperator::CreateFNegFMF</a>(NewShuf, S0);</span></CodeLine>
<Link id="l02542" /><CodeLine lineNumber="2542"></CodeLine>
<Link id="l02543" /><CodeLine lineNumber="2543"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/function">Function</a> &#42;FAbs = <a href="/docs/api/namespaces/llvm/intrinsic/#a0cff8be0190d8e20b7cf13646f34afa2">Intrinsic::getOrInsertDeclaration</a>(</span></CodeLine>
<Link id="l02544" /><CodeLine lineNumber="2544"><span class="doxyHighlight">        Shuf.<a href="/docs/api/classes/llvm/instruction/#a4ba3a5be6c0e9b9e8a525de055836733">getModule</a>(), Intrinsic::fabs, Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a59c34209e9206120edf7ce3c5da4f872">getType</a>());</span></CodeLine>
<Link id="l02545" /><CodeLine lineNumber="2545"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42;NewF = <a href="/docs/api/classes/llvm/callinst/#aa04721251be00370fbde6d21f47fed1a">CallInst::Create</a>(FAbs, &#123;NewShuf&#125;);</span></CodeLine>
<Link id="l02546" /><CodeLine lineNumber="2546"><span class="doxyHighlight">    NewF-&gt;<a href="/docs/api/classes/llvm/instruction/#a5ca8aa62fa8b3fe5bc0e8fbe5d8b8b7a">setFastMathFlags</a>(S0-&gt;getFastMathFlags());</span></CodeLine>
<Link id="l02547" /><CodeLine lineNumber="2547"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> NewF;</span></CodeLine>
<Link id="l02548" /><CodeLine lineNumber="2548"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02549" /><CodeLine lineNumber="2549"></CodeLine>
<Link id="l02550" /><CodeLine lineNumber="2550"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Match 2-input (binary) shuffle.</span></CodeLine>
<Link id="l02551" /><CodeLine lineNumber="2551"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpulegalizerinfo-cpp/#a22eabd3566ae5f32cb6f594f4f343399">S1</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1));</span></CodeLine>
<Link id="l02552" /><CodeLine lineNumber="2552"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>;</span></CodeLine>
<Link id="l02553" /><CodeLine lineNumber="2553"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpulegalizerinfo-cpp/#a22eabd3566ae5f32cb6f594f4f343399">S1</a> || !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpulegalizerinfo-cpp/#a22eabd3566ae5f32cb6f594f4f343399">S1</a>, <a href="/docs/api/namespaces/llvm/patternmatch/#afc43bc5ec4b20c7c5d663bef90da6066">m&#95;CombineOr</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aba7473bfa862dd9eadf04a6fefc6aa69">m&#95;FNeg</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>)), <a href="/docs/api/namespaces/llvm/patternmatch/#af07397df05f8eb1838b6d79871791e38">m&#95;FAbs</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>)))) ||</span></CodeLine>
<Link id="l02554" /><CodeLine lineNumber="2554"><span class="doxyHighlight">      S0-&gt;getOpcode() != <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpulegalizerinfo-cpp/#a22eabd3566ae5f32cb6f594f4f343399">S1</a>-&gt;getOpcode() ||</span></CodeLine>
<Link id="l02555" /><CodeLine lineNumber="2555"><span class="doxyHighlight">      (!S0-&gt;hasOneUse() &amp;&amp; !<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpulegalizerinfo-cpp/#a22eabd3566ae5f32cb6f594f4f343399">S1</a>-&gt;hasOneUse()))</span></CodeLine>
<Link id="l02556" /><CodeLine lineNumber="2556"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02557" /><CodeLine lineNumber="2557"></CodeLine>
<Link id="l02558" /><CodeLine lineNumber="2558"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuf (fneg/fabs X), (fneg/fabs Y), Mask --&gt; fneg/fabs (shuf X, Y, Mask)</span></CodeLine>
<Link id="l02559" /><CodeLine lineNumber="2559"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;NewShuf = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aa226d30eebf99ef84a0c2b1afcfc98b2">CreateShuffleVector</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>, Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>());</span></CodeLine>
<Link id="l02560" /><CodeLine lineNumber="2560"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;NewF;</span></CodeLine>
<Link id="l02561" /><CodeLine lineNumber="2561"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IsFNeg) &#123;</span></CodeLine>
<Link id="l02562" /><CodeLine lineNumber="2562"><span class="doxyHighlight">    NewF = UnaryOperator::CreateFNeg(NewShuf);</span></CodeLine>
<Link id="l02563" /><CodeLine lineNumber="2563"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l02564" /><CodeLine lineNumber="2564"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/function">Function</a> &#42;FAbs = <a href="/docs/api/namespaces/llvm/intrinsic/#a0cff8be0190d8e20b7cf13646f34afa2">Intrinsic::getOrInsertDeclaration</a>(</span></CodeLine>
<Link id="l02565" /><CodeLine lineNumber="2565"><span class="doxyHighlight">        Shuf.<a href="/docs/api/classes/llvm/instruction/#a4ba3a5be6c0e9b9e8a525de055836733">getModule</a>(), Intrinsic::fabs, Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a59c34209e9206120edf7ce3c5da4f872">getType</a>());</span></CodeLine>
<Link id="l02566" /><CodeLine lineNumber="2566"><span class="doxyHighlight">    NewF = <a href="/docs/api/classes/llvm/callinst/#aa04721251be00370fbde6d21f47fed1a">CallInst::Create</a>(FAbs, &#123;NewShuf&#125;);</span></CodeLine>
<Link id="l02567" /><CodeLine lineNumber="2567"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02568" /><CodeLine lineNumber="2568"><span class="doxyHighlight">  NewF-&gt;<a href="/docs/api/classes/llvm/instruction/#a3e6d2896c39a84cfa6c47f34cdc584ff">copyIRFlags</a>(S0);</span></CodeLine>
<Link id="l02569" /><CodeLine lineNumber="2569"><span class="doxyHighlight">  NewF-&gt;<a href="/docs/api/classes/llvm/instruction/#a4ea9acbe7fd20332ea6ccdb0183d6395">andIRFlags</a>(<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpulegalizerinfo-cpp/#a22eabd3566ae5f32cb6f594f4f343399">S1</a>);</span></CodeLine>
<Link id="l02570" /><CodeLine lineNumber="2570"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> NewF;</span></CodeLine>
<Link id="l02571" /><CodeLine lineNumber="2571"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02572" /><CodeLine lineNumber="2572"></CodeLine>
<Link id="l02573" /><CodeLine lineNumber="2573"><span class="doxyHighlightComment">/// Canonicalize casts after shuffle.</span></CodeLine>
<Link id="l02574" /><CodeLine lineNumber="2574" lineLink="#ab737e320d75547e2b43f6044fc3f3bcc"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="#ab737e320d75547e2b43f6044fc3f3bcc">foldCastShuffle</a>(<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp;Shuf,</span></CodeLine>
<Link id="l02575" /><CodeLine lineNumber="2575"><span class="doxyHighlight">                                    <a href="/docs/api/classes/llvm/instcombiner/#a19c4df37b96c2a73991556b696924584">InstCombiner::BuilderTy</a> &amp;Builder) &#123;</span></CodeLine>
<Link id="l02576" /><CodeLine lineNumber="2576"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Do we have 2 matching cast operands?</span></CodeLine>
<Link id="l02577" /><CodeLine lineNumber="2577"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Cast0 = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CastInst&gt;</a>(Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0));</span></CodeLine>
<Link id="l02578" /><CodeLine lineNumber="2578"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Cast1 = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CastInst&gt;</a>(Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1));</span></CodeLine>
<Link id="l02579" /><CodeLine lineNumber="2579"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Cast0 || !Cast1 || Cast0-&gt;getOpcode() != Cast1-&gt;getOpcode() ||</span></CodeLine>
<Link id="l02580" /><CodeLine lineNumber="2580"><span class="doxyHighlight">      Cast0-&gt;getSrcTy() != Cast1-&gt;getSrcTy())</span></CodeLine>
<Link id="l02581" /><CodeLine lineNumber="2581"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02582" /><CodeLine lineNumber="2582"></CodeLine>
<Link id="l02583" /><CodeLine lineNumber="2583"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: Allow other opcodes? That would require easing the type restrictions</span></CodeLine>
<Link id="l02584" /><CodeLine lineNumber="2584"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//       below here.</span></CodeLine>
<Link id="l02585" /><CodeLine lineNumber="2585"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/instruction/#afa0b2fa29ba074f2b6ec9ac11163f2d9">CastInst::CastOps</a> CastOpcode = Cast0-&gt;getOpcode();</span></CodeLine>
<Link id="l02586" /><CodeLine lineNumber="2586"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (CastOpcode) &#123;</span></CodeLine>
<Link id="l02587" /><CodeLine lineNumber="2587"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FPToSI:</span></CodeLine>
<Link id="l02588" /><CodeLine lineNumber="2588"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::FPToUI:</span></CodeLine>
<Link id="l02589" /><CodeLine lineNumber="2589"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::SIToFP:</span></CodeLine>
<Link id="l02590" /><CodeLine lineNumber="2590"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::UIToFP:</span></CodeLine>
<Link id="l02591" /><CodeLine lineNumber="2591"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02592" /><CodeLine lineNumber="2592"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">default</span><span class="doxyHighlight">:</span></CodeLine>
<Link id="l02593" /><CodeLine lineNumber="2593"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02594" /><CodeLine lineNumber="2594"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02595" /><CodeLine lineNumber="2595"></CodeLine>
<Link id="l02596" /><CodeLine lineNumber="2596"><span class="doxyHighlight">  <a href="/docs/api/classes/vectortype">VectorType</a> &#42;ShufTy = Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a59c34209e9206120edf7ce3c5da4f872">getType</a>();</span></CodeLine>
<Link id="l02597" /><CodeLine lineNumber="2597"><span class="doxyHighlight">  <a href="/docs/api/classes/vectortype">VectorType</a> &#42;ShufOpTy = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;VectorType&gt;</a>(Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0)-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>());</span></CodeLine>
<Link id="l02598" /><CodeLine lineNumber="2598"><span class="doxyHighlight">  <a href="/docs/api/classes/vectortype">VectorType</a> &#42;CastSrcTy = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;VectorType&gt;</a>(Cast0-&gt;getSrcTy());</span></CodeLine>
<Link id="l02599" /><CodeLine lineNumber="2599"></CodeLine>
<Link id="l02600" /><CodeLine lineNumber="2600"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: Allow length-increasing shuffles?</span></CodeLine>
<Link id="l02601" /><CodeLine lineNumber="2601"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ShufTy-&gt;getElementCount().getKnownMinValue() &gt;</span></CodeLine>
<Link id="l02602" /><CodeLine lineNumber="2602"><span class="doxyHighlight">      ShufOpTy-&gt;getElementCount().getKnownMinValue())</span></CodeLine>
<Link id="l02603" /><CodeLine lineNumber="2603"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02604" /><CodeLine lineNumber="2604"></CodeLine>
<Link id="l02605" /><CodeLine lineNumber="2605"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: Allow element-size-decreasing casts (ex: fptosi float to i8)?</span></CodeLine>
<Link id="l02606" /><CodeLine lineNumber="2606"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;FixedVectorType&gt;</a>(CastSrcTy) &amp;&amp; <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;FixedVectorType&gt;</a>(ShufOpTy) &amp;&amp;</span></CodeLine>
<Link id="l02607" /><CodeLine lineNumber="2607"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;Expected fixed vector operands for casts and binary shuffle&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02608" /><CodeLine lineNumber="2608"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CastSrcTy-&gt;getPrimitiveSizeInBits() &gt; ShufOpTy-&gt;getPrimitiveSizeInBits())</span></CodeLine>
<Link id="l02609" /><CodeLine lineNumber="2609"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02610" /><CodeLine lineNumber="2610"></CodeLine>
<Link id="l02611" /><CodeLine lineNumber="2611"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// At least one of the operands must have only one use (the shuffle).</span></CodeLine>
<Link id="l02612" /><CodeLine lineNumber="2612"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Cast0-&gt;hasOneUse() &amp;&amp; !Cast1-&gt;hasOneUse())</span></CodeLine>
<Link id="l02613" /><CodeLine lineNumber="2613"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02614" /><CodeLine lineNumber="2614"></CodeLine>
<Link id="l02615" /><CodeLine lineNumber="2615"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuffle (cast X), (cast Y), Mask --&gt; cast (shuffle X, Y, Mask)</span></CodeLine>
<Link id="l02616" /><CodeLine lineNumber="2616"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a> = Cast0-&gt;getOperand(0);</span></CodeLine>
<Link id="l02617" /><CodeLine lineNumber="2617"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a> = Cast1-&gt;getOperand(0);</span></CodeLine>
<Link id="l02618" /><CodeLine lineNumber="2618"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;NewShuf = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aa226d30eebf99ef84a0c2b1afcfc98b2">CreateShuffleVector</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>, Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>());</span></CodeLine>
<Link id="l02619" /><CodeLine lineNumber="2619"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/castinst/#ad2e0ab6d7096fe67a2216fe349044387">CastInst::Create</a>(CastOpcode, NewShuf, ShufTy);</span></CodeLine>
<Link id="l02620" /><CodeLine lineNumber="2620"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02621" /><CodeLine lineNumber="2621"></CodeLine>
<Link id="l02622" /><CodeLine lineNumber="2622"><span class="doxyHighlightComment">/// Try to fold an extract subvector operation.</span></CodeLine>
<Link id="l02623" /><CodeLine lineNumber="2623" lineLink="#a42c33c78c903c369b359db824b70cb1b"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="#a42c33c78c903c369b359db824b70cb1b">foldIdentityExtractShuffle</a>(<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp;Shuf) &#123;</span></CodeLine>
<Link id="l02624" /><CodeLine lineNumber="2624"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;Op0 = Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0), &#42;Op1 = Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1);</span></CodeLine>
<Link id="l02625" /><CodeLine lineNumber="2625"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a64a379276cb10c6cc61146d8a95cd1a7">isIdentityWithExtract</a>() || !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Op1, <a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>()))</span></CodeLine>
<Link id="l02626" /><CodeLine lineNumber="2626"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02627" /><CodeLine lineNumber="2627"></CodeLine>
<Link id="l02628" /><CodeLine lineNumber="2628"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Check if we are extracting all bits of an inserted scalar:</span></CodeLine>
<Link id="l02629" /><CodeLine lineNumber="2629"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// extract-subvec (bitcast (inselt ?, X, 0) --&gt; bitcast X to subvec type</span></CodeLine>
<Link id="l02630" /><CodeLine lineNumber="2630"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>;</span></CodeLine>
<Link id="l02631" /><CodeLine lineNumber="2631"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Op0, <a href="/docs/api/namespaces/llvm/patternmatch/#a99d8e67ed2343ad6717d7a8fdd3e7c7a">m&#95;BitCast</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aec67d7d9e090f41ec66d0d10169a440e">m&#95;InsertElt</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>), <a href="/docs/api/namespaces/llvm/patternmatch/#ae77be336e228cf9aa00709a8606dfb98">m&#95;Zero</a>()))) &amp;&amp;</span></CodeLine>
<Link id="l02632" /><CodeLine lineNumber="2632"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;getType()-&gt;getPrimitiveSizeInBits() ==</span></CodeLine>
<Link id="l02633" /><CodeLine lineNumber="2633"><span class="doxyHighlight">          Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a59c34209e9206120edf7ce3c5da4f872">getType</a>()-&gt;<a href="/docs/api/classes/llvm/type/#a833daf718a49c5cd637d8c9ddeaebe07">getPrimitiveSizeInBits</a>())</span></CodeLine>
<Link id="l02634" /><CodeLine lineNumber="2634"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/bitcastinst">BitCastInst</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a59c34209e9206120edf7ce3c5da4f872">getType</a>());</span></CodeLine>
<Link id="l02635" /><CodeLine lineNumber="2635"></CodeLine>
<Link id="l02636" /><CodeLine lineNumber="2636"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Try to combine 2 shuffles into 1 shuffle by concatenating a shuffle mask.</span></CodeLine>
<Link id="l02637" /><CodeLine lineNumber="2637"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>;</span></CodeLine>
<Link id="l02638" /><CodeLine lineNumber="2638"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;int&gt;</a> Mask;</span></CodeLine>
<Link id="l02639" /><CodeLine lineNumber="2639"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Op0, <a href="/docs/api/namespaces/llvm/patternmatch/#a5eee6cdb006c1d88b1123400f7f462d1">m&#95;Shuffle</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>), <a href="/docs/api/structs/llvm/patternmatch/m-mask">m&#95;Mask</a>(Mask))))</span></CodeLine>
<Link id="l02640" /><CodeLine lineNumber="2640"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02641" /><CodeLine lineNumber="2641"></CodeLine>
<Link id="l02642" /><CodeLine lineNumber="2642"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Be conservative with shuffle transforms. If we can&#39;t kill the 1st shuffle,</span></CodeLine>
<Link id="l02643" /><CodeLine lineNumber="2643"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// then combining may result in worse codegen.</span></CodeLine>
<Link id="l02644" /><CodeLine lineNumber="2644"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Op0-&gt;<a href="/docs/api/classes/llvm/value/#a3a402430a1bbe70a9282dcb0e0b6a2cd">hasOneUse</a>())</span></CodeLine>
<Link id="l02645" /><CodeLine lineNumber="2645"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02646" /><CodeLine lineNumber="2646"></CodeLine>
<Link id="l02647" /><CodeLine lineNumber="2647"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We are extracting a subvector from a shuffle. Remove excess elements from</span></CodeLine>
<Link id="l02648" /><CodeLine lineNumber="2648"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the 1st shuffle mask to eliminate the extract.</span></CodeLine>
<Link id="l02649" /><CodeLine lineNumber="2649"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l02650" /><CodeLine lineNumber="2650"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// This transform is conservatively limited to identity extracts because we do</span></CodeLine>
<Link id="l02651" /><CodeLine lineNumber="2651"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// not allow arbitrary shuffle mask creation as a target-independent transform</span></CodeLine>
<Link id="l02652" /><CodeLine lineNumber="2652"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// (because we can&#39;t guarantee that will lower efficiently).</span></CodeLine>
<Link id="l02653" /><CodeLine lineNumber="2653"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l02654" /><CodeLine lineNumber="2654"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the extracting shuffle has an poison mask element, it transfers to the</span></CodeLine>
<Link id="l02655" /><CodeLine lineNumber="2655"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// new shuffle mask. Otherwise, copy the original mask element. Example:</span></CodeLine>
<Link id="l02656" /><CodeLine lineNumber="2656"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   shuf (shuf X, Y, &lt;C0, C1, C2, poison, C4&gt;), poison, &lt;0, poison, 2, 3&gt; --&gt;</span></CodeLine>
<Link id="l02657" /><CodeLine lineNumber="2657"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   shuf X, Y, &lt;C0, poison, C2, poison&gt;</span></CodeLine>
<Link id="l02658" /><CodeLine lineNumber="2658"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumElts = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a59c34209e9206120edf7ce3c5da4f872">getType</a>())-&gt;getNumElements();</span></CodeLine>
<Link id="l02659" /><CodeLine lineNumber="2659"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;int, 16&gt;</a> NewMask(NumElts);</span></CodeLine>
<Link id="l02660" /><CodeLine lineNumber="2660"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(NumElts &lt; Mask.size() &amp;&amp;</span></CodeLine>
<Link id="l02661" /><CodeLine lineNumber="2661"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;Identity with extract must have less elements than its inputs&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02662" /><CodeLine lineNumber="2662"></CodeLine>
<Link id="l02663" /><CodeLine lineNumber="2663"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> i = 0; i != NumElts; ++i) &#123;</span></CodeLine>
<Link id="l02664" /><CodeLine lineNumber="2664"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> ExtractMaskElt = Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a3fb8619f70f51242f81ef96da349c884">getMaskValue</a>(i);</span></CodeLine>
<Link id="l02665" /><CodeLine lineNumber="2665"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> MaskElt = Mask&#91;i&#93;;</span></CodeLine>
<Link id="l02666" /><CodeLine lineNumber="2666"><span class="doxyHighlight">    NewMask&#91;i&#93; = ExtractMaskElt == <a href="/docs/api/namespaces/llvm/#a9965a6249be879ba3d336a75a4f3efa7">PoisonMaskElem</a> ? ExtractMaskElt : MaskElt;</span></CodeLine>
<Link id="l02667" /><CodeLine lineNumber="2667"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02668" /><CodeLine lineNumber="2668"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>, NewMask);</span></CodeLine>
<Link id="l02669" /><CodeLine lineNumber="2669"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02670" /><CodeLine lineNumber="2670"></CodeLine>
<Link id="l02671" /><CodeLine lineNumber="2671"><span class="doxyHighlightComment">/// Try to replace a shuffle with an insertelement or try to replace a shuffle</span></CodeLine>
<Link id="l02672" /><CodeLine lineNumber="2672"><span class="doxyHighlightComment">/// operand with the operand of an insertelement.</span></CodeLine>
<Link id="l02673" /><CodeLine lineNumber="2673" lineLink="#a661440047dc1b2af077911d9cf92236a"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="#a661440047dc1b2af077911d9cf92236a">foldShuffleWithInsert</a>(<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp;Shuf,</span></CodeLine>
<Link id="l02674" /><CodeLine lineNumber="2674"><span class="doxyHighlight">                                          <a href="/docs/api/classes/llvm/instcombinerimpl">InstCombinerImpl</a> &amp;IC) &#123;</span></CodeLine>
<Link id="l02675" /><CodeLine lineNumber="2675"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;V0 = Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0), &#42;V1 = Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1);</span></CodeLine>
<Link id="l02676" /><CodeLine lineNumber="2676"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;int, 16&gt;</a> Mask;</span></CodeLine>
<Link id="l02677" /><CodeLine lineNumber="2677"><span class="doxyHighlight">  Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>(Mask);</span></CodeLine>
<Link id="l02678" /><CodeLine lineNumber="2678"></CodeLine>
<Link id="l02679" /><CodeLine lineNumber="2679"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> NumElts = Mask.size();</span></CodeLine>
<Link id="l02680" /><CodeLine lineNumber="2680"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> InpNumElts = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(V0-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>())-&gt;getNumElements();</span></CodeLine>
<Link id="l02681" /><CodeLine lineNumber="2681"></CodeLine>
<Link id="l02682" /><CodeLine lineNumber="2682"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// This is a specialization of a fold in SimplifyDemandedVectorElts. We may</span></CodeLine>
<Link id="l02683" /><CodeLine lineNumber="2683"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// not be able to handle it there if the insertelement has &gt;1 use.</span></CodeLine>
<Link id="l02684" /><CodeLine lineNumber="2684"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the shuffle has an insertelement operand but does not choose the</span></CodeLine>
<Link id="l02685" /><CodeLine lineNumber="2685"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// inserted scalar element from that value, then we can replace that shuffle</span></CodeLine>
<Link id="l02686" /><CodeLine lineNumber="2686"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// operand with the source vector of the insertelement.</span></CodeLine>
<Link id="l02687" /><CodeLine lineNumber="2687"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>;</span></CodeLine>
<Link id="l02688" /><CodeLine lineNumber="2688"><span class="doxyHighlight">  uint64&#95;t IdxC;</span></CodeLine>
<Link id="l02689" /><CodeLine lineNumber="2689"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(V0, <a href="/docs/api/namespaces/llvm/patternmatch/#aec67d7d9e090f41ec66d0d10169a440e">m&#95;InsertElt</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(), <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>(IdxC)))) &#123;</span></CodeLine>
<Link id="l02690" /><CodeLine lineNumber="2690"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// shuf (inselt X, ?, IdxC), ?, Mask --&gt; shuf X, ?, Mask</span></CodeLine>
<Link id="l02691" /><CodeLine lineNumber="2691"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/#acd1cd968cb420c82d70926920fcdc7d7">is&#95;contained</a>(Mask, (</span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight">)IdxC))</span></CodeLine>
<Link id="l02692" /><CodeLine lineNumber="2692"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> IC.<a href="/docs/api/classes/llvm/instcombiner/#ac2a56636a6f3742f5e495f67e67b6b36">replaceOperand</a>(Shuf, 0, <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>);</span></CodeLine>
<Link id="l02693" /><CodeLine lineNumber="2693"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02694" /><CodeLine lineNumber="2694"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(V1, <a href="/docs/api/namespaces/llvm/patternmatch/#aec67d7d9e090f41ec66d0d10169a440e">m&#95;InsertElt</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(), <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>(IdxC)))) &#123;</span></CodeLine>
<Link id="l02695" /><CodeLine lineNumber="2695"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Offset the index constant by the vector width because we are checking for</span></CodeLine>
<Link id="l02696" /><CodeLine lineNumber="2696"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// accesses to the 2nd vector input of the shuffle.</span></CodeLine>
<Link id="l02697" /><CodeLine lineNumber="2697"><span class="doxyHighlight">    IdxC += InpNumElts;</span></CodeLine>
<Link id="l02698" /><CodeLine lineNumber="2698"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// shuf ?, (inselt X, ?, IdxC), Mask --&gt; shuf ?, X, Mask</span></CodeLine>
<Link id="l02699" /><CodeLine lineNumber="2699"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/#acd1cd968cb420c82d70926920fcdc7d7">is&#95;contained</a>(Mask, (</span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight">)IdxC))</span></CodeLine>
<Link id="l02700" /><CodeLine lineNumber="2700"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> IC.<a href="/docs/api/classes/llvm/instcombiner/#ac2a56636a6f3742f5e495f67e67b6b36">replaceOperand</a>(Shuf, 1, <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>);</span></CodeLine>
<Link id="l02701" /><CodeLine lineNumber="2701"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02702" /><CodeLine lineNumber="2702"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For the rest of the transform, the shuffle must not change vector sizes.</span></CodeLine>
<Link id="l02703" /><CodeLine lineNumber="2703"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: This restriction could be removed if the insert has only one use</span></CodeLine>
<Link id="l02704" /><CodeLine lineNumber="2704"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//       (because the transform would require a new length-changing shuffle).</span></CodeLine>
<Link id="l02705" /><CodeLine lineNumber="2705"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NumElts != InpNumElts)</span></CodeLine>
<Link id="l02706" /><CodeLine lineNumber="2706"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02707" /><CodeLine lineNumber="2707"></CodeLine>
<Link id="l02708" /><CodeLine lineNumber="2708"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuffle (insert ?, Scalar, IndexC), V1, Mask --&gt; insert V1, Scalar, IndexC&#39;</span></CodeLine>
<Link id="l02709" /><CodeLine lineNumber="2709"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> isShufflingScalarIntoOp1 = &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/value">Value</a> &#42;&amp;Scalar, <a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;&amp;IndexC) &#123;</span></CodeLine>
<Link id="l02710" /><CodeLine lineNumber="2710"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We need an insertelement with a constant index.</span></CodeLine>
<Link id="l02711" /><CodeLine lineNumber="2711"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(V0, <a href="/docs/api/namespaces/llvm/patternmatch/#aec67d7d9e090f41ec66d0d10169a440e">m&#95;InsertElt</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(Scalar),</span></CodeLine>
<Link id="l02712" /><CodeLine lineNumber="2712"><span class="doxyHighlight">                               <a href="/docs/api/namespaces/llvm/patternmatch/#a3aa1f5d3cd54d36e7e47f401a0118aeb">m&#95;ConstantInt</a>(IndexC))))</span></CodeLine>
<Link id="l02713" /><CodeLine lineNumber="2713"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02714" /><CodeLine lineNumber="2714"></CodeLine>
<Link id="l02715" /><CodeLine lineNumber="2715"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Test the shuffle mask to see if it splices the inserted scalar into the</span></CodeLine>
<Link id="l02716" /><CodeLine lineNumber="2716"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// operand 1 vector of the shuffle.</span></CodeLine>
<Link id="l02717" /><CodeLine lineNumber="2717"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> NewInsIndex = -1;</span></CodeLine>
<Link id="l02718" /><CodeLine lineNumber="2718"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> i = 0; i != NumElts; ++i) &#123;</span></CodeLine>
<Link id="l02719" /><CodeLine lineNumber="2719"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Ignore undef mask elements.</span></CodeLine>
<Link id="l02720" /><CodeLine lineNumber="2720"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Mask&#91;i&#93; == -1)</span></CodeLine>
<Link id="l02721" /><CodeLine lineNumber="2721"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02722" /><CodeLine lineNumber="2722"></CodeLine>
<Link id="l02723" /><CodeLine lineNumber="2723"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// The shuffle takes elements of operand 1 without lane changes.</span></CodeLine>
<Link id="l02724" /><CodeLine lineNumber="2724"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Mask&#91;i&#93; == NumElts + i)</span></CodeLine>
<Link id="l02725" /><CodeLine lineNumber="2725"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02726" /><CodeLine lineNumber="2726"></CodeLine>
<Link id="l02727" /><CodeLine lineNumber="2727"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// The shuffle must choose the inserted scalar exactly once.</span></CodeLine>
<Link id="l02728" /><CodeLine lineNumber="2728"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NewInsIndex != -1 || Mask&#91;i&#93; != IndexC-&gt;getSExtValue())</span></CodeLine>
<Link id="l02729" /><CodeLine lineNumber="2729"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02730" /><CodeLine lineNumber="2730"></CodeLine>
<Link id="l02731" /><CodeLine lineNumber="2731"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// The shuffle is placing the inserted scalar into element i.</span></CodeLine>
<Link id="l02732" /><CodeLine lineNumber="2732"><span class="doxyHighlight">      NewInsIndex = i;</span></CodeLine>
<Link id="l02733" /><CodeLine lineNumber="2733"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02734" /><CodeLine lineNumber="2734"></CodeLine>
<Link id="l02735" /><CodeLine lineNumber="2735"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(NewInsIndex != -1 &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Did not fold shuffle with unused operand?&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02736" /><CodeLine lineNumber="2736"></CodeLine>
<Link id="l02737" /><CodeLine lineNumber="2737"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Index is updated to the potentially translated insertion lane.</span></CodeLine>
<Link id="l02738" /><CodeLine lineNumber="2738"><span class="doxyHighlight">    IndexC = ConstantInt::get(IndexC-&gt;getIntegerType(), NewInsIndex);</span></CodeLine>
<Link id="l02739" /><CodeLine lineNumber="2739"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02740" /><CodeLine lineNumber="2740"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l02741" /><CodeLine lineNumber="2741"></CodeLine>
<Link id="l02742" /><CodeLine lineNumber="2742"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the shuffle is unnecessary, insert the scalar operand directly into</span></CodeLine>
<Link id="l02743" /><CodeLine lineNumber="2743"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// operand 1 of the shuffle. Example:</span></CodeLine>
<Link id="l02744" /><CodeLine lineNumber="2744"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuffle (insert ?, S, 1), V1, &lt;1, 5, 6, 7&gt; --&gt; insert V1, S, 0</span></CodeLine>
<Link id="l02745" /><CodeLine lineNumber="2745"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;Scalar;</span></CodeLine>
<Link id="l02746" /><CodeLine lineNumber="2746"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;IndexC;</span></CodeLine>
<Link id="l02747" /><CodeLine lineNumber="2747"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (isShufflingScalarIntoOp1(Scalar, IndexC))</span></CodeLine>
<Link id="l02748" /><CodeLine lineNumber="2748"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/insertelementinst/#a3c7d92166c1f18129c2727c9dc808b29">InsertElementInst::Create</a>(V1, Scalar, IndexC);</span></CodeLine>
<Link id="l02749" /><CodeLine lineNumber="2749"></CodeLine>
<Link id="l02750" /><CodeLine lineNumber="2750"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Try again after commuting shuffle. Example:</span></CodeLine>
<Link id="l02751" /><CodeLine lineNumber="2751"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuffle V0, (insert ?, S, 0), &lt;0, 1, 2, 4&gt; --&gt;</span></CodeLine>
<Link id="l02752" /><CodeLine lineNumber="2752"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuffle (insert ?, S, 0), V0, &lt;4, 5, 6, 0&gt; --&gt; insert V0, S, 3</span></CodeLine>
<Link id="l02753" /><CodeLine lineNumber="2753"><span class="doxyHighlight">  <a href="/docs/api/namespaces/std/#ab8424022895aee3e366fb9a32f2883cb">std::swap</a>(V0, V1);</span></CodeLine>
<Link id="l02754" /><CodeLine lineNumber="2754"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/shufflevectorinst/#a9874bec83353914ed1e9309d5d9ccea0">ShuffleVectorInst::commuteShuffleMask</a>(Mask, NumElts);</span></CodeLine>
<Link id="l02755" /><CodeLine lineNumber="2755"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (isShufflingScalarIntoOp1(Scalar, IndexC))</span></CodeLine>
<Link id="l02756" /><CodeLine lineNumber="2756"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/insertelementinst/#a3c7d92166c1f18129c2727c9dc808b29">InsertElementInst::Create</a>(V1, Scalar, IndexC);</span></CodeLine>
<Link id="l02757" /><CodeLine lineNumber="2757"></CodeLine>
<Link id="l02758" /><CodeLine lineNumber="2758"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02759" /><CodeLine lineNumber="2759"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02760" /><CodeLine lineNumber="2760"></CodeLine>
<Link id="l02761" /><CodeLine lineNumber="2761" lineLink="#a332e7f93c5c4782c1a628a1b11ab5032"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="#a332e7f93c5c4782c1a628a1b11ab5032">foldIdentityPaddedShuffles</a>(<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp;Shuf) &#123;</span></CodeLine>
<Link id="l02762" /><CodeLine lineNumber="2762"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Match the operands as identity with padding (also known as concatenation</span></CodeLine>
<Link id="l02763" /><CodeLine lineNumber="2763"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// with undef) shuffles of the same source type. The backend is expected to</span></CodeLine>
<Link id="l02764" /><CodeLine lineNumber="2764"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// recreate these concatenations from a shuffle of narrow operands.</span></CodeLine>
<Link id="l02765" /><CodeLine lineNumber="2765"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Shuffle0 = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ShuffleVectorInst&gt;</a>(Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0));</span></CodeLine>
<Link id="l02766" /><CodeLine lineNumber="2766"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Shuffle1 = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ShuffleVectorInst&gt;</a>(Shuf.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1));</span></CodeLine>
<Link id="l02767" /><CodeLine lineNumber="2767"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Shuffle0 || !Shuffle0-&gt;isIdentityWithPadding() ||</span></CodeLine>
<Link id="l02768" /><CodeLine lineNumber="2768"><span class="doxyHighlight">      !Shuffle1 || !Shuffle1-&gt;isIdentityWithPadding())</span></CodeLine>
<Link id="l02769" /><CodeLine lineNumber="2769"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02770" /><CodeLine lineNumber="2770"></CodeLine>
<Link id="l02771" /><CodeLine lineNumber="2771"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We limit this transform to power-of-2 types because we expect that the</span></CodeLine>
<Link id="l02772" /><CodeLine lineNumber="2772"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// backend can convert the simplified IR patterns to identical nodes as the</span></CodeLine>
<Link id="l02773" /><CodeLine lineNumber="2773"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// original IR.</span></CodeLine>
<Link id="l02774" /><CodeLine lineNumber="2774"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: If we can verify the same behavior for arbitrary types, the</span></CodeLine>
<Link id="l02775" /><CodeLine lineNumber="2775"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//       power-of-2 checks can be removed.</span></CodeLine>
<Link id="l02776" /><CodeLine lineNumber="2776"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a> = Shuffle0-&gt;getOperand(0);</span></CodeLine>
<Link id="l02777" /><CodeLine lineNumber="2777"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a> = Shuffle1-&gt;getOperand(0);</span></CodeLine>
<Link id="l02778" /><CodeLine lineNumber="2778"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;getType() != <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>-&gt;getType() ||</span></CodeLine>
<Link id="l02779" /><CodeLine lineNumber="2779"><span class="doxyHighlight">      !<a href="/docs/api/namespaces/llvm/#a6dec2b5d3e04b47adf4d918d678e81c9">isPowerOf2&#95;32</a>(<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a59c34209e9206120edf7ce3c5da4f872">getType</a>())-&gt;getNumElements()) ||</span></CodeLine>
<Link id="l02780" /><CodeLine lineNumber="2780"><span class="doxyHighlight">      !<a href="/docs/api/namespaces/llvm/#a6dec2b5d3e04b47adf4d918d678e81c9">isPowerOf2&#95;32</a>(</span></CodeLine>
<Link id="l02781" /><CodeLine lineNumber="2781"><span class="doxyHighlight">          <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(Shuffle0-&gt;getType())-&gt;getNumElements()) ||</span></CodeLine>
<Link id="l02782" /><CodeLine lineNumber="2782"><span class="doxyHighlight">      !<a href="/docs/api/namespaces/llvm/#a6dec2b5d3e04b47adf4d918d678e81c9">isPowerOf2&#95;32</a>(<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;getType())-&gt;getNumElements()) ||</span></CodeLine>
<Link id="l02783" /><CodeLine lineNumber="2783"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, <a href="/docs/api/namespaces/llvm/patternmatch/#adea6dc2e42baa345b97be48b0370313d">m&#95;Undef</a>()) || <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>, <a href="/docs/api/namespaces/llvm/patternmatch/#adea6dc2e42baa345b97be48b0370313d">m&#95;Undef</a>()))</span></CodeLine>
<Link id="l02784" /><CodeLine lineNumber="2784"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02785" /><CodeLine lineNumber="2785"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Shuffle0-&gt;getOperand(1), <a href="/docs/api/namespaces/llvm/patternmatch/#adea6dc2e42baa345b97be48b0370313d">m&#95;Undef</a>()) &amp;&amp;</span></CodeLine>
<Link id="l02786" /><CodeLine lineNumber="2786"><span class="doxyHighlight">         <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Shuffle1-&gt;getOperand(1), <a href="/docs/api/namespaces/llvm/patternmatch/#adea6dc2e42baa345b97be48b0370313d">m&#95;Undef</a>()) &amp;&amp;</span></CodeLine>
<Link id="l02787" /><CodeLine lineNumber="2787"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;Unexpected operand for identity shuffle&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02788" /><CodeLine lineNumber="2788"></CodeLine>
<Link id="l02789" /><CodeLine lineNumber="2789"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// This is a shuffle of 2 widening shuffles. We can shuffle the narrow source</span></CodeLine>
<Link id="l02790" /><CodeLine lineNumber="2790"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// operands directly by adjusting the shuffle mask to account for the narrower</span></CodeLine>
<Link id="l02791" /><CodeLine lineNumber="2791"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// types:</span></CodeLine>
<Link id="l02792" /><CodeLine lineNumber="2792"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuf (widen X), (widen Y), Mask --&gt; shuf X, Y, Mask&#39;</span></CodeLine>
<Link id="l02793" /><CodeLine lineNumber="2793"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> NarrowElts = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;getType())-&gt;getNumElements();</span></CodeLine>
<Link id="l02794" /><CodeLine lineNumber="2794"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> WideElts = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(Shuffle0-&gt;getType())-&gt;getNumElements();</span></CodeLine>
<Link id="l02795" /><CodeLine lineNumber="2795"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(WideElts &gt; NarrowElts &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Unexpected types for identity with padding&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02796" /><CodeLine lineNumber="2796"></CodeLine>
<Link id="l02797" /><CodeLine lineNumber="2797"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;int&gt;</a> Mask = Shuf.<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>();</span></CodeLine>
<Link id="l02798" /><CodeLine lineNumber="2798"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;int, 16&gt;</a> NewMask(Mask.size(), -1);</span></CodeLine>
<Link id="l02799" /><CodeLine lineNumber="2799"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> i = 0, e = Mask.size(); i != e; ++i) &#123;</span></CodeLine>
<Link id="l02800" /><CodeLine lineNumber="2800"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Mask&#91;i&#93; == -1)</span></CodeLine>
<Link id="l02801" /><CodeLine lineNumber="2801"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02802" /><CodeLine lineNumber="2802"></CodeLine>
<Link id="l02803" /><CodeLine lineNumber="2803"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If this shuffle is choosing an undef element from 1 of the sources, that</span></CodeLine>
<Link id="l02804" /><CodeLine lineNumber="2804"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// element is undef.</span></CodeLine>
<Link id="l02805" /><CodeLine lineNumber="2805"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Mask&#91;i&#93; &lt; WideElts) &#123;</span></CodeLine>
<Link id="l02806" /><CodeLine lineNumber="2806"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Shuffle0-&gt;getMaskValue(Mask&#91;i&#93;) == -1)</span></CodeLine>
<Link id="l02807" /><CodeLine lineNumber="2807"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02808" /><CodeLine lineNumber="2808"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l02809" /><CodeLine lineNumber="2809"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Shuffle1-&gt;getMaskValue(Mask&#91;i&#93; - WideElts) == -1)</span></CodeLine>
<Link id="l02810" /><CodeLine lineNumber="2810"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02811" /><CodeLine lineNumber="2811"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02812" /><CodeLine lineNumber="2812"></CodeLine>
<Link id="l02813" /><CodeLine lineNumber="2813"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If this shuffle is choosing from the 1st narrow op, the mask element is</span></CodeLine>
<Link id="l02814" /><CodeLine lineNumber="2814"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// the same. If this shuffle is choosing from the 2nd narrow op, the mask</span></CodeLine>
<Link id="l02815" /><CodeLine lineNumber="2815"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// element is offset down to adjust for the narrow vector widths.</span></CodeLine>
<Link id="l02816" /><CodeLine lineNumber="2816"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Mask&#91;i&#93; &lt; WideElts) &#123;</span></CodeLine>
<Link id="l02817" /><CodeLine lineNumber="2817"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Mask&#91;i&#93; &lt; NarrowElts &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Unexpected shuffle mask&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02818" /><CodeLine lineNumber="2818"><span class="doxyHighlight">      NewMask&#91;i&#93; = Mask&#91;i&#93;;</span></CodeLine>
<Link id="l02819" /><CodeLine lineNumber="2819"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l02820" /><CodeLine lineNumber="2820"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Mask&#91;i&#93; &lt; (WideElts + NarrowElts) &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Unexpected shuffle mask&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02821" /><CodeLine lineNumber="2821"><span class="doxyHighlight">      NewMask&#91;i&#93; = Mask&#91;i&#93; - (WideElts - NarrowElts);</span></CodeLine>
<Link id="l02822" /><CodeLine lineNumber="2822"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02823" /><CodeLine lineNumber="2823"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02824" /><CodeLine lineNumber="2824"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>, NewMask);</span></CodeLine>
<Link id="l02825" /><CodeLine lineNumber="2825"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02826" /><CodeLine lineNumber="2826"></CodeLine>
<Link id="l02827" /><CodeLine lineNumber="2827"><span class="doxyHighlightComment">// Splatting the first element of the result of a BinOp, where any of the</span></CodeLine>
<Link id="l02828" /><CodeLine lineNumber="2828"><span class="doxyHighlightComment">// BinOp&#39;s operands are the result of a first element splat can be simplified to</span></CodeLine>
<Link id="l02829" /><CodeLine lineNumber="2829"><span class="doxyHighlightComment">// splatting the first element of the result of the BinOp</span></CodeLine>
<Link id="l02830" /><CodeLine lineNumber="2830" lineLink="/docs/api/classes/llvm/instcombinerimpl/#ab18666f9305cc63df7009c9e4ec0e35a"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/classes/llvm/instcombinerimpl/#ab18666f9305cc63df7009c9e4ec0e35a">InstCombinerImpl::simplifyBinOpSplats</a>(<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp;SVI) &#123;</span></CodeLine>
<Link id="l02831" /><CodeLine lineNumber="2831"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(SVI.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1), <a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>()) ||</span></CodeLine>
<Link id="l02832" /><CodeLine lineNumber="2832"><span class="doxyHighlight">      !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(SVI.<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>(), <a href="/docs/api/structs/llvm/patternmatch/m-zeromask">m&#95;ZeroMask</a>()) ||</span></CodeLine>
<Link id="l02833" /><CodeLine lineNumber="2833"><span class="doxyHighlight">      !SVI.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0)-&gt;<a href="/docs/api/classes/llvm/value/#a3a402430a1bbe70a9282dcb0e0b6a2cd">hasOneUse</a>())</span></CodeLine>
<Link id="l02834" /><CodeLine lineNumber="2834"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02835" /><CodeLine lineNumber="2835"></CodeLine>
<Link id="l02836" /><CodeLine lineNumber="2836"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;Op0 = SVI.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0);</span></CodeLine>
<Link id="l02837" /><CodeLine lineNumber="2837"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>;</span></CodeLine>
<Link id="l02838" /><CodeLine lineNumber="2838"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Op0, <a href="/docs/api/namespaces/llvm/patternmatch/#a0698afabe907d2d3b87889d2e0349d47">m&#95;BinOp</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a5eee6cdb006c1d88b1123400f7f462d1">m&#95;Shuffle</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>), <a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>(), <a href="/docs/api/structs/llvm/patternmatch/m-zeromask">m&#95;ZeroMask</a>()),</span></CodeLine>
<Link id="l02839" /><CodeLine lineNumber="2839"><span class="doxyHighlight">                          <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>))) &amp;&amp;</span></CodeLine>
<Link id="l02840" /><CodeLine lineNumber="2840"><span class="doxyHighlight">      !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Op0, <a href="/docs/api/namespaces/llvm/patternmatch/#a0698afabe907d2d3b87889d2e0349d47">m&#95;BinOp</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>),</span></CodeLine>
<Link id="l02841" /><CodeLine lineNumber="2841"><span class="doxyHighlight">                          <a href="/docs/api/namespaces/llvm/patternmatch/#a5eee6cdb006c1d88b1123400f7f462d1">m&#95;Shuffle</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>), <a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>(), <a href="/docs/api/structs/llvm/patternmatch/m-zeromask">m&#95;ZeroMask</a>()))))</span></CodeLine>
<Link id="l02842" /><CodeLine lineNumber="2842"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02843" /><CodeLine lineNumber="2843"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;getType() != <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>-&gt;getType())</span></CodeLine>
<Link id="l02844" /><CodeLine lineNumber="2844"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02845" /><CodeLine lineNumber="2845"></CodeLine>
<Link id="l02846" /><CodeLine lineNumber="2846"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;BinOp = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BinaryOperator&gt;</a>(Op0);</span></CodeLine>
<Link id="l02847" /><CodeLine lineNumber="2847"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/#a19ebaad52d11be3121c2bfcbd0f30193">isSafeToSpeculativelyExecuteWithVariableReplaced</a>(BinOp))</span></CodeLine>
<Link id="l02848" /><CodeLine lineNumber="2848"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02849" /><CodeLine lineNumber="2849"></CodeLine>
<Link id="l02850" /><CodeLine lineNumber="2850"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;NewBO = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateBinOp(BinOp-&gt;getOpcode(), <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>);</span></CodeLine>
<Link id="l02851" /><CodeLine lineNumber="2851"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> NewBOI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(NewBO))</span></CodeLine>
<Link id="l02852" /><CodeLine lineNumber="2852"><span class="doxyHighlight">    NewBOI-&gt;copyIRFlags(BinOp);</span></CodeLine>
<Link id="l02853" /><CodeLine lineNumber="2853"></CodeLine>
<Link id="l02854" /><CodeLine lineNumber="2854"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a>(NewBO, SVI.<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>());</span></CodeLine>
<Link id="l02855" /><CodeLine lineNumber="2855"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02856" /><CodeLine lineNumber="2856"></CodeLine>
<Link id="l02857" /><CodeLine lineNumber="2857" lineLink="/docs/api/classes/llvm/instcombinerimpl/#ad31108b4f7156db7565eadba1285c93a"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/classes/llvm/instcombinerimpl/#ad31108b4f7156db7565eadba1285c93a">InstCombinerImpl::visitShuffleVectorInst</a>(<a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a> &amp;SVI) &#123;</span></CodeLine>
<Link id="l02858" /><CodeLine lineNumber="2858"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;LHS = SVI.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0);</span></CodeLine>
<Link id="l02859" /><CodeLine lineNumber="2859"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;RHS = SVI.<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1);</span></CodeLine>
<Link id="l02860" /><CodeLine lineNumber="2860"><span class="doxyHighlight">  <a href="/docs/api/structs/llvm/simplifyquery">SimplifyQuery</a> ShufQuery = <a href="/docs/api/classes/llvm/instcombiner/#a067e49eb19f14e50f84cf4b4e7f6acde">SQ</a>.getWithInstruction(&amp;SVI);</span></CodeLine>
<Link id="l02861" /><CodeLine lineNumber="2861"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;V = <a href="/docs/api/namespaces/llvm/#a4e04471ed9ac60e70f5cf2d81f49b8c4">simplifyShuffleVectorInst</a>(LHS, RHS, SVI.<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>(),</span></CodeLine>
<Link id="l02862" /><CodeLine lineNumber="2862"><span class="doxyHighlight">                                          SVI.<a href="/docs/api/classes/llvm/shufflevectorinst/#a59c34209e9206120edf7ce3c5da4f872">getType</a>(), ShufQuery))</span></CodeLine>
<Link id="l02863" /><CodeLine lineNumber="2863"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instcombiner/#a49f1bd0bdf0ef741bdd714cc1188d7c5">replaceInstUsesWith</a>(SVI, V);</span></CodeLine>
<Link id="l02864" /><CodeLine lineNumber="2864"></CodeLine>
<Link id="l02865" /><CodeLine lineNumber="2865"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="/docs/api/classes/llvm/instcombinerimpl/#ab18666f9305cc63df7009c9e4ec0e35a">simplifyBinOpSplats</a>(SVI))</span></CodeLine>
<Link id="l02866" /><CodeLine lineNumber="2866"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l02867" /><CodeLine lineNumber="2867"></CodeLine>
<Link id="l02868" /><CodeLine lineNumber="2868"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Canonicalize splat shuffle to use poison RHS. Handle this explicitly in</span></CodeLine>
<Link id="l02869" /><CodeLine lineNumber="2869"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// order to support scalable vectors.</span></CodeLine>
<Link id="l02870" /><CodeLine lineNumber="2870"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(SVI.<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>(), <a href="/docs/api/structs/llvm/patternmatch/m-zeromask">m&#95;ZeroMask</a>()) &amp;&amp; !<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;PoisonValue&gt;</a>(RHS))</span></CodeLine>
<Link id="l02871" /><CodeLine lineNumber="2871"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instcombiner/#ac2a56636a6f3742f5e495f67e67b6b36">replaceOperand</a>(SVI, 1, <a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(RHS-&gt;getType()));</span></CodeLine>
<Link id="l02872" /><CodeLine lineNumber="2872"></CodeLine>
<Link id="l02873" /><CodeLine lineNumber="2873"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;ScalableVectorType&gt;</a>(LHS-&gt;getType()))</span></CodeLine>
<Link id="l02874" /><CodeLine lineNumber="2874"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02875" /><CodeLine lineNumber="2875"></CodeLine>
<Link id="l02876" /><CodeLine lineNumber="2876"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> VWidth = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(SVI.<a href="/docs/api/classes/llvm/shufflevectorinst/#a59c34209e9206120edf7ce3c5da4f872">getType</a>())-&gt;getNumElements();</span></CodeLine>
<Link id="l02877" /><CodeLine lineNumber="2877"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> LHSWidth = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(LHS-&gt;getType())-&gt;getNumElements();</span></CodeLine>
<Link id="l02878" /><CodeLine lineNumber="2878"></CodeLine>
<Link id="l02879" /><CodeLine lineNumber="2879"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuffle (bitcast X), (bitcast Y), Mask --&gt; bitcast (shuffle X, Y, Mask)</span></CodeLine>
<Link id="l02880" /><CodeLine lineNumber="2880"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l02881" /><CodeLine lineNumber="2881"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// if X and Y are of the same (vector) type, and the element size is not</span></CodeLine>
<Link id="l02882" /><CodeLine lineNumber="2882"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// changed by the bitcasts, we can distribute the bitcasts through the</span></CodeLine>
<Link id="l02883" /><CodeLine lineNumber="2883"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuffle, hopefully reducing the number of instructions. We make sure that</span></CodeLine>
<Link id="l02884" /><CodeLine lineNumber="2884"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// at least one bitcast only has one use, so we don&#39;t &#42;increase&#42; the number of</span></CodeLine>
<Link id="l02885" /><CodeLine lineNumber="2885"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// instructions here.</span></CodeLine>
<Link id="l02886" /><CodeLine lineNumber="2886"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>;</span></CodeLine>
<Link id="l02887" /><CodeLine lineNumber="2887"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(LHS, <a href="/docs/api/namespaces/llvm/patternmatch/#a99d8e67ed2343ad6717d7a8fdd3e7c7a">m&#95;BitCast</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>))) &amp;&amp; <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(RHS, <a href="/docs/api/namespaces/llvm/patternmatch/#a99d8e67ed2343ad6717d7a8fdd3e7c7a">m&#95;BitCast</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>))) &amp;&amp;</span></CodeLine>
<Link id="l02888" /><CodeLine lineNumber="2888"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;getType()-&gt;isVectorTy() &amp;&amp; <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;getType() == <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>-&gt;getType() &amp;&amp;</span></CodeLine>
<Link id="l02889" /><CodeLine lineNumber="2889"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;getType()-&gt;getScalarSizeInBits() ==</span></CodeLine>
<Link id="l02890" /><CodeLine lineNumber="2890"><span class="doxyHighlight">          SVI.<a href="/docs/api/classes/llvm/shufflevectorinst/#a59c34209e9206120edf7ce3c5da4f872">getType</a>()-&gt;<a href="/docs/api/classes/llvm/type/#a9f382207d841377156d4c7868b66b9a5">getScalarSizeInBits</a>() &amp;&amp;</span></CodeLine>
<Link id="l02891" /><CodeLine lineNumber="2891"><span class="doxyHighlight">      (LHS-&gt;hasOneUse() || RHS-&gt;hasOneUse())) &#123;</span></CodeLine>
<Link id="l02892" /><CodeLine lineNumber="2892"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;V = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateShuffleVector(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>, SVI.<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>(),</span></CodeLine>
<Link id="l02893" /><CodeLine lineNumber="2893"><span class="doxyHighlight">                                           SVI.<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>() + </span><span class="doxyHighlightStringLiteral">&quot;.uncasted&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02894" /><CodeLine lineNumber="2894"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/bitcastinst">BitCastInst</a>(V, SVI.<a href="/docs/api/classes/llvm/shufflevectorinst/#a59c34209e9206120edf7ce3c5da4f872">getType</a>());</span></CodeLine>
<Link id="l02895" /><CodeLine lineNumber="2895"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02896" /><CodeLine lineNumber="2896"></CodeLine>
<Link id="l02897" /><CodeLine lineNumber="2897"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;int&gt;</a> Mask = SVI.<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>();</span></CodeLine>
<Link id="l02898" /><CodeLine lineNumber="2898"></CodeLine>
<Link id="l02899" /><CodeLine lineNumber="2899"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Peek through a bitcasted shuffle operand by scaling the mask. If the</span></CodeLine>
<Link id="l02900" /><CodeLine lineNumber="2900"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// simulated shuffle can simplify, then this shuffle is unnecessary:</span></CodeLine>
<Link id="l02901" /><CodeLine lineNumber="2901"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuf (bitcast X), undef, Mask --&gt; bitcast X&#39;</span></CodeLine>
<Link id="l02902" /><CodeLine lineNumber="2902"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: This could be extended to allow length-changing shuffles.</span></CodeLine>
<Link id="l02903" /><CodeLine lineNumber="2903"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//       The transform might also be obsoleted if we allowed canonicalization</span></CodeLine>
<Link id="l02904" /><CodeLine lineNumber="2904"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//       of bitcasted shuffles.</span></CodeLine>
<Link id="l02905" /><CodeLine lineNumber="2905"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(LHS, <a href="/docs/api/namespaces/llvm/patternmatch/#a99d8e67ed2343ad6717d7a8fdd3e7c7a">m&#95;BitCast</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>))) &amp;&amp; <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(RHS, <a href="/docs/api/namespaces/llvm/patternmatch/#adea6dc2e42baa345b97be48b0370313d">m&#95;Undef</a>()) &amp;&amp;</span></CodeLine>
<Link id="l02906" /><CodeLine lineNumber="2906"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;getType()-&gt;isVectorTy() &amp;&amp; VWidth == LHSWidth) &#123;</span></CodeLine>
<Link id="l02907" /><CodeLine lineNumber="2907"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Try to create a scaled mask constant.</span></CodeLine>
<Link id="l02908" /><CodeLine lineNumber="2908"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;XType = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;getType());</span></CodeLine>
<Link id="l02909" /><CodeLine lineNumber="2909"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> XNumElts = XType-&gt;getNumElements();</span></CodeLine>
<Link id="l02910" /><CodeLine lineNumber="2910"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;int, 16&gt;</a> ScaledMask;</span></CodeLine>
<Link id="l02911" /><CodeLine lineNumber="2911"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#afae6f658a8b4ed82cfac2bc1ada047d8">scaleShuffleMaskElts</a>(XNumElts, Mask, ScaledMask)) &#123;</span></CodeLine>
<Link id="l02912" /><CodeLine lineNumber="2912"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If the shuffled source vector simplifies, cast that value to this</span></CodeLine>
<Link id="l02913" /><CodeLine lineNumber="2913"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// shuffle&#39;s type.</span></CodeLine>
<Link id="l02914" /><CodeLine lineNumber="2914"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;V = <a href="/docs/api/namespaces/llvm/#a4e04471ed9ac60e70f5cf2d81f49b8c4">simplifyShuffleVectorInst</a>(<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>, <a href="/docs/api/classes/llvm/undefvalue/#a4ae5ff22b700a42bcc5d889233721335">UndefValue::get</a>(XType),</span></CodeLine>
<Link id="l02915" /><CodeLine lineNumber="2915"><span class="doxyHighlight">                                              ScaledMask, XType, ShufQuery))</span></CodeLine>
<Link id="l02916" /><CodeLine lineNumber="2916"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/castinst/#ad2e0ab6d7096fe67a2216fe349044387">BitCastInst::Create</a>(Instruction::BitCast, V, SVI.<a href="/docs/api/classes/llvm/shufflevectorinst/#a59c34209e9206120edf7ce3c5da4f872">getType</a>());</span></CodeLine>
<Link id="l02917" /><CodeLine lineNumber="2917"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02918" /><CodeLine lineNumber="2918"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02919" /><CodeLine lineNumber="2919"></CodeLine>
<Link id="l02920" /><CodeLine lineNumber="2920"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuffle x, x, mask --&gt; shuffle x, undef, mask&#39;</span></CodeLine>
<Link id="l02921" /><CodeLine lineNumber="2921"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LHS == RHS) &#123;</span></CodeLine>
<Link id="l02922" /><CodeLine lineNumber="2922"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(RHS, <a href="/docs/api/namespaces/llvm/patternmatch/#adea6dc2e42baa345b97be48b0370313d">m&#95;Undef</a>()) &amp;&amp;</span></CodeLine>
<Link id="l02923" /><CodeLine lineNumber="2923"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;Shuffle with 2 undef ops not simplified?&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02924" /><CodeLine lineNumber="2924"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a>(LHS, <a href="/docs/api/namespaces/llvm/#a2bea09503a438b76b5c9253327118af5">createUnaryMask</a>(Mask, LHSWidth));</span></CodeLine>
<Link id="l02925" /><CodeLine lineNumber="2925"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02926" /><CodeLine lineNumber="2926"></CodeLine>
<Link id="l02927" /><CodeLine lineNumber="2927"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuffle undef, x, mask --&gt; shuffle x, undef, mask&#39;</span></CodeLine>
<Link id="l02928" /><CodeLine lineNumber="2928"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(LHS, <a href="/docs/api/namespaces/llvm/patternmatch/#adea6dc2e42baa345b97be48b0370313d">m&#95;Undef</a>())) &#123;</span></CodeLine>
<Link id="l02929" /><CodeLine lineNumber="2929"><span class="doxyHighlight">    SVI.<a href="/docs/api/classes/llvm/shufflevectorinst/#aa94c68d274d913e05b0423c7b2fded00">commute</a>();</span></CodeLine>
<Link id="l02930" /><CodeLine lineNumber="2930"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &amp;SVI;</span></CodeLine>
<Link id="l02931" /><CodeLine lineNumber="2931"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02932" /><CodeLine lineNumber="2932"></CodeLine>
<Link id="l02933" /><CodeLine lineNumber="2933"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="#a6e6cf92e2cfe0eb48abec55606e0481e">canonicalizeInsertSplat</a>(SVI, <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>))</span></CodeLine>
<Link id="l02934" /><CodeLine lineNumber="2934"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l02935" /><CodeLine lineNumber="2935"></CodeLine>
<Link id="l02936" /><CodeLine lineNumber="2936"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="/docs/api/classes/llvm/instcombinerimpl/#a3b73df3a995af9ca26c9d024c957c45a">foldSelectShuffle</a>(SVI))</span></CodeLine>
<Link id="l02937" /><CodeLine lineNumber="2937"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l02938" /><CodeLine lineNumber="2938"></CodeLine>
<Link id="l02939" /><CodeLine lineNumber="2939"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="#a747cca8cf8e4c4e41b81bb1cbf146a11">foldTruncShuffle</a>(SVI, <a href="/docs/api/classes/llvm/instcombiner/#a878e8128a9a4e5626df91dcd91cba337">DL</a>.isBigEndian()))</span></CodeLine>
<Link id="l02940" /><CodeLine lineNumber="2940"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l02941" /><CodeLine lineNumber="2941"></CodeLine>
<Link id="l02942" /><CodeLine lineNumber="2942"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86isellowering-cpp/#a309d56d62904382ce197ab216f4ec43f">narrowVectorSelect</a>(SVI, <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>))</span></CodeLine>
<Link id="l02943" /><CodeLine lineNumber="2943"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l02944" /><CodeLine lineNumber="2944"></CodeLine>
<Link id="l02945" /><CodeLine lineNumber="2945"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="#aabcb01976dc50b78faed7491a6d43042">foldShuffleOfUnaryOps</a>(SVI, <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>))</span></CodeLine>
<Link id="l02946" /><CodeLine lineNumber="2946"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l02947" /><CodeLine lineNumber="2947"></CodeLine>
<Link id="l02948" /><CodeLine lineNumber="2948"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="#ab737e320d75547e2b43f6044fc3f3bcc">foldCastShuffle</a>(SVI, <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>))</span></CodeLine>
<Link id="l02949" /><CodeLine lineNumber="2949"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l02950" /><CodeLine lineNumber="2950"></CodeLine>
<Link id="l02951" /><CodeLine lineNumber="2951"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/apint">APInt</a> PoisonElts(VWidth, 0);</span></CodeLine>
<Link id="l02952" /><CodeLine lineNumber="2952"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/apint">APInt</a> AllOnesEltMask(<a href="/docs/api/classes/llvm/apint/#a071e8d814b2b30b02544fad964227b8e">APInt::getAllOnes</a>(VWidth));</span></CodeLine>
<Link id="l02953" /><CodeLine lineNumber="2953"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/value">Value</a> &#42;V = <a href="/docs/api/classes/llvm/instcombinerimpl/#a37cce7aa1875173688e5971c5d6fa9e0">SimplifyDemandedVectorElts</a>(&amp;SVI, AllOnesEltMask, PoisonElts)) &#123;</span></CodeLine>
<Link id="l02954" /><CodeLine lineNumber="2954"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (V != &amp;SVI)</span></CodeLine>
<Link id="l02955" /><CodeLine lineNumber="2955"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instcombiner/#a49f1bd0bdf0ef741bdd714cc1188d7c5">replaceInstUsesWith</a>(SVI, V);</span></CodeLine>
<Link id="l02956" /><CodeLine lineNumber="2956"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &amp;SVI;</span></CodeLine>
<Link id="l02957" /><CodeLine lineNumber="2957"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02958" /><CodeLine lineNumber="2958"></CodeLine>
<Link id="l02959" /><CodeLine lineNumber="2959"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="#a42c33c78c903c369b359db824b70cb1b">foldIdentityExtractShuffle</a>(SVI))</span></CodeLine>
<Link id="l02960" /><CodeLine lineNumber="2960"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l02961" /><CodeLine lineNumber="2961"></CodeLine>
<Link id="l02962" /><CodeLine lineNumber="2962"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// These transforms have the potential to lose undef knowledge, so they are</span></CodeLine>
<Link id="l02963" /><CodeLine lineNumber="2963"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// intentionally placed after SimplifyDemandedVectorElts().</span></CodeLine>
<Link id="l02964" /><CodeLine lineNumber="2964"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="#a661440047dc1b2af077911d9cf92236a">foldShuffleWithInsert</a>(SVI, &#42;</span><span class="doxyHighlightKeyword">this</span><span class="doxyHighlight">))</span></CodeLine>
<Link id="l02965" /><CodeLine lineNumber="2965"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l02966" /><CodeLine lineNumber="2966"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="#a332e7f93c5c4782c1a628a1b11ab5032">foldIdentityPaddedShuffles</a>(SVI))</span></CodeLine>
<Link id="l02967" /><CodeLine lineNumber="2967"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l02968" /><CodeLine lineNumber="2968"></CodeLine>
<Link id="l02969" /><CodeLine lineNumber="2969"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(RHS, <a href="/docs/api/namespaces/llvm/patternmatch/#a16be5fe0cce90e51f8c0e0c4d6c589f6">m&#95;Constant</a>())) &#123;</span></CodeLine>
<Link id="l02970" /><CodeLine lineNumber="2970"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/namespaces/llvm/si">SI</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;SelectInst&gt;</a>(LHS)) &#123;</span></CodeLine>
<Link id="l02971" /><CodeLine lineNumber="2971"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// We cannot do this fold for elementwise select since ShuffleVector is</span></CodeLine>
<Link id="l02972" /><CodeLine lineNumber="2972"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// not elementwise.</span></CodeLine>
<Link id="l02973" /><CodeLine lineNumber="2973"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getCondition()-&gt;getType()-&gt;isIntegerTy() &amp;&amp;</span></CodeLine>
<Link id="l02974" /><CodeLine lineNumber="2974"><span class="doxyHighlight">          (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;PoisonValue&gt;</a>(RHS) ||</span></CodeLine>
<Link id="l02975" /><CodeLine lineNumber="2975"><span class="doxyHighlight">           <a href="/docs/api/namespaces/llvm/#ae058c4750de2c85f12a1f96841ac9ae3">isGuaranteedNotToBePoison</a>(<a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getCondition()))) &#123;</span></CodeLine>
<Link id="l02976" /><CodeLine lineNumber="2976"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="/docs/api/classes/llvm/instcombinerimpl/#a039111728e11b1cdf25e60446ae17f2a">FoldOpIntoSelect</a>(SVI, <a href="/docs/api/namespaces/llvm/si">SI</a>))</span></CodeLine>
<Link id="l02977" /><CodeLine lineNumber="2977"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l02978" /><CodeLine lineNumber="2978"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l02979" /><CodeLine lineNumber="2979"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02980" /><CodeLine lineNumber="2980"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;PN = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;PHINode&gt;</a>(LHS)) &#123;</span></CodeLine>
<Link id="l02981" /><CodeLine lineNumber="2981"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="/docs/api/classes/llvm/instcombinerimpl/#a2fc50d227d302eb98914f04bcc6634e1">foldOpIntoPhi</a>(SVI, PN, </span><span class="doxyHighlightComment">/&#42;AllowMultipleUses=&#42;/</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">))</span></CodeLine>
<Link id="l02982" /><CodeLine lineNumber="2982"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l02983" /><CodeLine lineNumber="2983"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02984" /><CodeLine lineNumber="2984"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02985" /><CodeLine lineNumber="2985"></CodeLine>
<Link id="l02986" /><CodeLine lineNumber="2986"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(RHS, <a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>()) &amp;&amp; <a href="#a95fd07ca61f35098e091aa2329f9c8a6">canEvaluateShuffled</a>(LHS, Mask)) &#123;</span></CodeLine>
<Link id="l02987" /><CodeLine lineNumber="2987"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;V = <a href="#a06358c30f3e98d9e57f4ae9162f33c72">evaluateInDifferentElementOrder</a>(LHS, Mask, <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>);</span></CodeLine>
<Link id="l02988" /><CodeLine lineNumber="2988"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instcombiner/#a49f1bd0bdf0ef741bdd714cc1188d7c5">replaceInstUsesWith</a>(SVI, V);</span></CodeLine>
<Link id="l02989" /><CodeLine lineNumber="2989"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02990" /><CodeLine lineNumber="2990"></CodeLine>
<Link id="l02991" /><CodeLine lineNumber="2991"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// SROA generates shuffle+bitcast when the extracted sub-vector is bitcast to</span></CodeLine>
<Link id="l02992" /><CodeLine lineNumber="2992"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// a non-vector type. We can instead bitcast the original vector followed by</span></CodeLine>
<Link id="l02993" /><CodeLine lineNumber="2993"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// an extract of the desired element:</span></CodeLine>
<Link id="l02994" /><CodeLine lineNumber="2994"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l02995" /><CodeLine lineNumber="2995"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   %sroa = shufflevector &lt;16 x i8&gt; %in, &lt;16 x i8&gt; undef,</span></CodeLine>
<Link id="l02996" /><CodeLine lineNumber="2996"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//                         &lt;4 x i32&gt; &lt;i32 0, i32 1, i32 2, i32 3&gt;</span></CodeLine>
<Link id="l02997" /><CodeLine lineNumber="2997"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   %1 = bitcast &lt;4 x i8&gt; %sroa to i32</span></CodeLine>
<Link id="l02998" /><CodeLine lineNumber="2998"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Becomes:</span></CodeLine>
<Link id="l02999" /><CodeLine lineNumber="2999"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   %bc = bitcast &lt;16 x i8&gt; %in to &lt;4 x i32&gt;</span></CodeLine>
<Link id="l03000" /><CodeLine lineNumber="3000"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   %ext = extractelement &lt;4 x i32&gt; %bc, i32 0</span></CodeLine>
<Link id="l03001" /><CodeLine lineNumber="3001"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l03002" /><CodeLine lineNumber="3002"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the shuffle is extracting a contiguous range of values from the input</span></CodeLine>
<Link id="l03003" /><CodeLine lineNumber="3003"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// vector then each use which is a bitcast of the extracted size can be</span></CodeLine>
<Link id="l03004" /><CodeLine lineNumber="3004"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// replaced. This will work if the vector types are compatible, and the begin</span></CodeLine>
<Link id="l03005" /><CodeLine lineNumber="3005"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// index is aligned to a value in the casted vector type. If the begin index</span></CodeLine>
<Link id="l03006" /><CodeLine lineNumber="3006"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// isn&#39;t aligned then we can shuffle the original vector (keeping the same</span></CodeLine>
<Link id="l03007" /><CodeLine lineNumber="3007"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// vector type) before extracting.</span></CodeLine>
<Link id="l03008" /><CodeLine lineNumber="3008"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l03009" /><CodeLine lineNumber="3009"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// This code will bail out if the target type is fundamentally incompatible</span></CodeLine>
<Link id="l03010" /><CodeLine lineNumber="3010"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// with vectors of the source type.</span></CodeLine>
<Link id="l03011" /><CodeLine lineNumber="3011"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l03012" /><CodeLine lineNumber="3012"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Example of &lt;16 x i8&gt;, target type i32:</span></CodeLine>
<Link id="l03013" /><CodeLine lineNumber="3013"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Index range &#91;4,8):         v-----------v Will work.</span></CodeLine>
<Link id="l03014" /><CodeLine lineNumber="3014"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//                +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span></CodeLine>
<Link id="l03015" /><CodeLine lineNumber="3015"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     &lt;16 x i8&gt;: |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |</span></CodeLine>
<Link id="l03016" /><CodeLine lineNumber="3016"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     &lt;4 x i32&gt;: |           |           |           |           |</span></CodeLine>
<Link id="l03017" /><CodeLine lineNumber="3017"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//                +-----------+-----------+-----------+-----------+</span></CodeLine>
<Link id="l03018" /><CodeLine lineNumber="3018"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Index range &#91;6,10):              ^-----------^ Needs an extra shuffle.</span></CodeLine>
<Link id="l03019" /><CodeLine lineNumber="3019"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Target type i40:           ^--------------^ Won&#39;t work, bail.</span></CodeLine>
<Link id="l03020" /><CodeLine lineNumber="3020"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> MadeChange = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03021" /><CodeLine lineNumber="3021"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#ae8f4745a87bae0a614d6bda1cc55ab01">isShuffleExtractingFromLHS</a>(SVI, Mask)) &#123;</span></CodeLine>
<Link id="l03022" /><CodeLine lineNumber="3022"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;V = LHS;</span></CodeLine>
<Link id="l03023" /><CodeLine lineNumber="3023"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> MaskElems = Mask.size();</span></CodeLine>
<Link id="l03024" /><CodeLine lineNumber="3024"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;SrcTy = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(V-&gt;getType());</span></CodeLine>
<Link id="l03025" /><CodeLine lineNumber="3025"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> VecBitWidth = SrcTy-&gt;getPrimitiveSizeInBits().getFixedValue();</span></CodeLine>
<Link id="l03026" /><CodeLine lineNumber="3026"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> SrcElemBitWidth = <a href="/docs/api/classes/llvm/instcombiner/#a878e8128a9a4e5626df91dcd91cba337">DL</a>.getTypeSizeInBits(SrcTy-&gt;getElementType());</span></CodeLine>
<Link id="l03027" /><CodeLine lineNumber="3027"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(SrcElemBitWidth &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;vector elements must have a bitwidth&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l03028" /><CodeLine lineNumber="3028"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> SrcNumElems = SrcTy-&gt;getNumElements();</span></CodeLine>
<Link id="l03029" /><CodeLine lineNumber="3029"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BitCastInst &#42;, 8&gt;</a> BCs;</span></CodeLine>
<Link id="l03030" /><CodeLine lineNumber="3030"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/densemap">DenseMap&lt;Type &#42;, Value &#42;&gt;</a> NewBCs;</span></CodeLine>
<Link id="l03031" /><CodeLine lineNumber="3031"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/user">User</a> &#42;U : SVI.<a href="/docs/api/classes/llvm/value/#a411cf3e3932f209ce3374cb31adc1da6">users</a>())</span></CodeLine>
<Link id="l03032" /><CodeLine lineNumber="3032"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/bitcastinst">BitCastInst</a> &#42;BC = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BitCastInst&gt;</a>(U)) &#123;</span></CodeLine>
<Link id="l03033" /><CodeLine lineNumber="3033"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Only visit bitcasts that weren&#39;t previously handled.</span></CodeLine>
<Link id="l03034" /><CodeLine lineNumber="3034"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BC-&gt;use&#95;empty())</span></CodeLine>
<Link id="l03035" /><CodeLine lineNumber="3035"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03036" /><CodeLine lineNumber="3036"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Prefer to combine bitcasts of bitcasts before attempting this fold.</span></CodeLine>
<Link id="l03037" /><CodeLine lineNumber="3037"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BC-&gt;hasOneUse()) &#123;</span></CodeLine>
<Link id="l03038" /><CodeLine lineNumber="3038"><span class="doxyHighlight">          </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;BC2 = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BitCastInst&gt;</a>(BC-&gt;user&#95;back());</span></CodeLine>
<Link id="l03039" /><CodeLine lineNumber="3039"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BC2 &amp;&amp; isEliminableCastPair(BC, BC2))</span></CodeLine>
<Link id="l03040" /><CodeLine lineNumber="3040"><span class="doxyHighlight">            </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03041" /><CodeLine lineNumber="3041"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l03042" /><CodeLine lineNumber="3042"><span class="doxyHighlight">        BCs.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(BC);</span></CodeLine>
<Link id="l03043" /><CodeLine lineNumber="3043"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l03044" /><CodeLine lineNumber="3044"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/bitcastinst">BitCastInst</a> &#42;BC : BCs) &#123;</span></CodeLine>
<Link id="l03045" /><CodeLine lineNumber="3045"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> BegIdx = Mask.front();</span></CodeLine>
<Link id="l03046" /><CodeLine lineNumber="3046"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/type">Type</a> &#42;TgtTy = BC-&gt;getDestTy();</span></CodeLine>
<Link id="l03047" /><CodeLine lineNumber="3047"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> TgtElemBitWidth = <a href="/docs/api/classes/llvm/instcombiner/#a878e8128a9a4e5626df91dcd91cba337">DL</a>.getTypeSizeInBits(TgtTy);</span></CodeLine>
<Link id="l03048" /><CodeLine lineNumber="3048"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!TgtElemBitWidth)</span></CodeLine>
<Link id="l03049" /><CodeLine lineNumber="3049"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03050" /><CodeLine lineNumber="3050"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> TgtNumElems = VecBitWidth / TgtElemBitWidth;</span></CodeLine>
<Link id="l03051" /><CodeLine lineNumber="3051"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> VecBitWidthsEqual = VecBitWidth == TgtNumElems &#42; TgtElemBitWidth;</span></CodeLine>
<Link id="l03052" /><CodeLine lineNumber="3052"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> BegIsAligned = 0 == ((SrcElemBitWidth &#42; BegIdx) % TgtElemBitWidth);</span></CodeLine>
<Link id="l03053" /><CodeLine lineNumber="3053"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!VecBitWidthsEqual)</span></CodeLine>
<Link id="l03054" /><CodeLine lineNumber="3054"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03055" /><CodeLine lineNumber="3055"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/classes/llvm/vectortype/#aa6a2194fc011669faabe43322d7c6c5f">VectorType::isValidElementType</a>(TgtTy))</span></CodeLine>
<Link id="l03056" /><CodeLine lineNumber="3056"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03057" /><CodeLine lineNumber="3057"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CastSrcTy = <a href="/docs/api/classes/llvm/fixedvectortype/#af9a870d5df50fe0133a410b7c9114c80">FixedVectorType::get</a>(TgtTy, TgtNumElems);</span></CodeLine>
<Link id="l03058" /><CodeLine lineNumber="3058"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!BegIsAligned) &#123;</span></CodeLine>
<Link id="l03059" /><CodeLine lineNumber="3059"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Shuffle the input so &#91;0,NumElements) contains the output, and</span></CodeLine>
<Link id="l03060" /><CodeLine lineNumber="3060"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// &#91;NumElems,SrcNumElems) is undef.</span></CodeLine>
<Link id="l03061" /><CodeLine lineNumber="3061"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;int, 16&gt;</a> ShuffleMask(SrcNumElems, -1);</span></CodeLine>
<Link id="l03062" /><CodeLine lineNumber="3062"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = 0, E = MaskElems, Idx = BegIdx; <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> != E; ++Idx, ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)</span></CodeLine>
<Link id="l03063" /><CodeLine lineNumber="3063"><span class="doxyHighlight">          ShuffleMask&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; = Idx;</span></CodeLine>
<Link id="l03064" /><CodeLine lineNumber="3064"><span class="doxyHighlight">        V = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateShuffleVector(V, ShuffleMask,</span></CodeLine>
<Link id="l03065" /><CodeLine lineNumber="3065"><span class="doxyHighlight">                                        SVI.<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>() + </span><span class="doxyHighlightStringLiteral">&quot;.extract&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l03066" /><CodeLine lineNumber="3066"><span class="doxyHighlight">        BegIdx = 0;</span></CodeLine>
<Link id="l03067" /><CodeLine lineNumber="3067"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l03068" /><CodeLine lineNumber="3068"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> SrcElemsPerTgtElem = TgtElemBitWidth / SrcElemBitWidth;</span></CodeLine>
<Link id="l03069" /><CodeLine lineNumber="3069"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(SrcElemsPerTgtElem);</span></CodeLine>
<Link id="l03070" /><CodeLine lineNumber="3070"><span class="doxyHighlight">      BegIdx /= SrcElemsPerTgtElem;</span></CodeLine>
<Link id="l03071" /><CodeLine lineNumber="3071"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#91;It, Inserted&#93; = NewBCs.<a href="/docs/api/classes/llvm/densemapbase/#a1a245b31aced1374f28f45d2b297f402">try&#95;emplace</a>(CastSrcTy);</span></CodeLine>
<Link id="l03072" /><CodeLine lineNumber="3072"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Inserted)</span></CodeLine>
<Link id="l03073" /><CodeLine lineNumber="3073"><span class="doxyHighlight">        It-&gt;second = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateBitCast(V, CastSrcTy, SVI.<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>() + </span><span class="doxyHighlightStringLiteral">&quot;.bc&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l03074" /><CodeLine lineNumber="3074"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Ext = <a href="/docs/api/classes/llvm/instcombiner/#ae1d331bc844ecb92bdeb0b706ae04396">Builder</a>.CreateExtractElement(It-&gt;second, BegIdx,</span></CodeLine>
<Link id="l03075" /><CodeLine lineNumber="3075"><span class="doxyHighlight">                                               SVI.<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>() + </span><span class="doxyHighlightStringLiteral">&quot;.extract&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l03076" /><CodeLine lineNumber="3076"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// The shufflevector isn&#39;t being replaced: the bitcast that used it</span></CodeLine>
<Link id="l03077" /><CodeLine lineNumber="3077"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// is. InstCombine will visit the newly-created instructions.</span></CodeLine>
<Link id="l03078" /><CodeLine lineNumber="3078"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/instcombiner/#a49f1bd0bdf0ef741bdd714cc1188d7c5">replaceInstUsesWith</a>(&#42;BC, Ext);</span></CodeLine>
<Link id="l03079" /><CodeLine lineNumber="3079"><span class="doxyHighlight">      MadeChange = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03080" /><CodeLine lineNumber="3080"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03081" /><CodeLine lineNumber="3081"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03082" /><CodeLine lineNumber="3082"></CodeLine>
<Link id="l03083" /><CodeLine lineNumber="3083"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the LHS is a shufflevector itself, see if we can combine it with this</span></CodeLine>
<Link id="l03084" /><CodeLine lineNumber="3084"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// one without producing an unusual shuffle.</span></CodeLine>
<Link id="l03085" /><CodeLine lineNumber="3085"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Cases that might be simplified:</span></CodeLine>
<Link id="l03086" /><CodeLine lineNumber="3086"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// 1</span></CodeLine>
<Link id="l03087" /><CodeLine lineNumber="3087"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// x1=shuffle(v1,v2,mask1)</span></CodeLine>
<Link id="l03088" /><CodeLine lineNumber="3088"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  x=shuffle(x1,undef,mask)</span></CodeLine>
<Link id="l03089" /><CodeLine lineNumber="3089"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//        ==&gt;</span></CodeLine>
<Link id="l03090" /><CodeLine lineNumber="3090"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  x=shuffle(v1,undef,newMask)</span></CodeLine>
<Link id="l03091" /><CodeLine lineNumber="3091"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// newMask&#91;i&#93; = (mask&#91;i&#93; &lt; x1.size()) ? mask1&#91;mask&#91;i&#93;&#93; : -1</span></CodeLine>
<Link id="l03092" /><CodeLine lineNumber="3092"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// 2</span></CodeLine>
<Link id="l03093" /><CodeLine lineNumber="3093"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// x1=shuffle(v1,undef,mask1)</span></CodeLine>
<Link id="l03094" /><CodeLine lineNumber="3094"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  x=shuffle(x1,x2,mask)</span></CodeLine>
<Link id="l03095" /><CodeLine lineNumber="3095"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// where v1.size() == mask1.size()</span></CodeLine>
<Link id="l03096" /><CodeLine lineNumber="3096"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//        ==&gt;</span></CodeLine>
<Link id="l03097" /><CodeLine lineNumber="3097"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  x=shuffle(v1,x2,newMask)</span></CodeLine>
<Link id="l03098" /><CodeLine lineNumber="3098"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// newMask&#91;i&#93; = (mask&#91;i&#93; &lt; x1.size()) ? mask1&#91;mask&#91;i&#93;&#93; : mask&#91;i&#93;</span></CodeLine>
<Link id="l03099" /><CodeLine lineNumber="3099"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// 3</span></CodeLine>
<Link id="l03100" /><CodeLine lineNumber="3100"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// x2=shuffle(v2,undef,mask2)</span></CodeLine>
<Link id="l03101" /><CodeLine lineNumber="3101"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  x=shuffle(x1,x2,mask)</span></CodeLine>
<Link id="l03102" /><CodeLine lineNumber="3102"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// where v2.size() == mask2.size()</span></CodeLine>
<Link id="l03103" /><CodeLine lineNumber="3103"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//        ==&gt;</span></CodeLine>
<Link id="l03104" /><CodeLine lineNumber="3104"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  x=shuffle(x1,v2,newMask)</span></CodeLine>
<Link id="l03105" /><CodeLine lineNumber="3105"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// newMask&#91;i&#93; = (mask&#91;i&#93; &lt; x1.size())</span></CodeLine>
<Link id="l03106" /><CodeLine lineNumber="3106"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//              ? mask&#91;i&#93; : mask2&#91;mask&#91;i&#93;-x1.size()&#93;+x1.size()</span></CodeLine>
<Link id="l03107" /><CodeLine lineNumber="3107"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// 4</span></CodeLine>
<Link id="l03108" /><CodeLine lineNumber="3108"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// x1=shuffle(v1,undef,mask1)</span></CodeLine>
<Link id="l03109" /><CodeLine lineNumber="3109"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// x2=shuffle(v2,undef,mask2)</span></CodeLine>
<Link id="l03110" /><CodeLine lineNumber="3110"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  x=shuffle(x1,x2,mask)</span></CodeLine>
<Link id="l03111" /><CodeLine lineNumber="3111"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// where v1.size() == v2.size()</span></CodeLine>
<Link id="l03112" /><CodeLine lineNumber="3112"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//        ==&gt;</span></CodeLine>
<Link id="l03113" /><CodeLine lineNumber="3113"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  x=shuffle(v1,v2,newMask)</span></CodeLine>
<Link id="l03114" /><CodeLine lineNumber="3114"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// newMask&#91;i&#93; = (mask&#91;i&#93; &lt; x1.size())</span></CodeLine>
<Link id="l03115" /><CodeLine lineNumber="3115"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//              ? mask1&#91;mask&#91;i&#93;&#93; : mask2&#91;mask&#91;i&#93;-x1.size()&#93;+v1.size()</span></CodeLine>
<Link id="l03116" /><CodeLine lineNumber="3116"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l03117" /><CodeLine lineNumber="3117"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Here we are really conservative:</span></CodeLine>
<Link id="l03118" /><CodeLine lineNumber="3118"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// we are absolutely afraid of producing a shuffle mask not in the input</span></CodeLine>
<Link id="l03119" /><CodeLine lineNumber="3119"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// program, because the code gen may not be smart enough to turn a merged</span></CodeLine>
<Link id="l03120" /><CodeLine lineNumber="3120"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shuffle into two specific shuffles: it may produce worse code.  As such,</span></CodeLine>
<Link id="l03121" /><CodeLine lineNumber="3121"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// we only merge two shuffles if the result is either a splat or one of the</span></CodeLine>
<Link id="l03122" /><CodeLine lineNumber="3122"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// input shuffle masks.  In this case, merging the shuffles just removes</span></CodeLine>
<Link id="l03123" /><CodeLine lineNumber="3123"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// one instruction, which we know is safe.  This is good for things like</span></CodeLine>
<Link id="l03124" /><CodeLine lineNumber="3124"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// turning: (splat(splat)) -&gt; splat, or</span></CodeLine>
<Link id="l03125" /><CodeLine lineNumber="3125"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// merge(V&#91;0..n&#93;, V&#91;n+1..2n&#93;) -&gt; V&#91;0..2n&#93;</span></CodeLine>
<Link id="l03126" /><CodeLine lineNumber="3126"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a>&#42; LHSShuffle = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ShuffleVectorInst&gt;</a>(LHS);</span></CodeLine>
<Link id="l03127" /><CodeLine lineNumber="3127"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a>&#42; RHSShuffle = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ShuffleVectorInst&gt;</a>(RHS);</span></CodeLine>
<Link id="l03128" /><CodeLine lineNumber="3128"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LHSShuffle)</span></CodeLine>
<Link id="l03129" /><CodeLine lineNumber="3129"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(LHSShuffle-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1), <a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>()) &amp;&amp;</span></CodeLine>
<Link id="l03130" /><CodeLine lineNumber="3130"><span class="doxyHighlight">        !<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(RHS, <a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>()))</span></CodeLine>
<Link id="l03131" /><CodeLine lineNumber="3131"><span class="doxyHighlight">      LHSShuffle = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03132" /><CodeLine lineNumber="3132"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (RHSShuffle)</span></CodeLine>
<Link id="l03133" /><CodeLine lineNumber="3133"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(RHSShuffle-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1), <a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>()))</span></CodeLine>
<Link id="l03134" /><CodeLine lineNumber="3134"><span class="doxyHighlight">      RHSShuffle = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03135" /><CodeLine lineNumber="3135"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!LHSShuffle &amp;&amp; !RHSShuffle)</span></CodeLine>
<Link id="l03136" /><CodeLine lineNumber="3136"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> MadeChange ? &amp;SVI : </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03137" /><CodeLine lineNumber="3137"></CodeLine>
<Link id="l03138" /><CodeLine lineNumber="3138"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a>&#42; LHSOp0 = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03139" /><CodeLine lineNumber="3139"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a>&#42; LHSOp1 = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03140" /><CodeLine lineNumber="3140"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a>&#42; RHSOp0 = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03141" /><CodeLine lineNumber="3141"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> LHSOp0Width = 0;</span></CodeLine>
<Link id="l03142" /><CodeLine lineNumber="3142"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> RHSOp0Width = 0;</span></CodeLine>
<Link id="l03143" /><CodeLine lineNumber="3143"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LHSShuffle) &#123;</span></CodeLine>
<Link id="l03144" /><CodeLine lineNumber="3144"><span class="doxyHighlight">    LHSOp0 = LHSShuffle-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0);</span></CodeLine>
<Link id="l03145" /><CodeLine lineNumber="3145"><span class="doxyHighlight">    LHSOp1 = LHSShuffle-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1);</span></CodeLine>
<Link id="l03146" /><CodeLine lineNumber="3146"><span class="doxyHighlight">    LHSOp0Width = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(LHSOp0-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>())-&gt;getNumElements();</span></CodeLine>
<Link id="l03147" /><CodeLine lineNumber="3147"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03148" /><CodeLine lineNumber="3148"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (RHSShuffle) &#123;</span></CodeLine>
<Link id="l03149" /><CodeLine lineNumber="3149"><span class="doxyHighlight">    RHSOp0 = RHSShuffle-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0);</span></CodeLine>
<Link id="l03150" /><CodeLine lineNumber="3150"><span class="doxyHighlight">    RHSOp0Width = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;FixedVectorType&gt;</a>(RHSOp0-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>())-&gt;getNumElements();</span></CodeLine>
<Link id="l03151" /><CodeLine lineNumber="3151"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03152" /><CodeLine lineNumber="3152"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a>&#42; newLHS = LHS;</span></CodeLine>
<Link id="l03153" /><CodeLine lineNumber="3153"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a>&#42; newRHS = RHS;</span></CodeLine>
<Link id="l03154" /><CodeLine lineNumber="3154"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LHSShuffle) &#123;</span></CodeLine>
<Link id="l03155" /><CodeLine lineNumber="3155"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// case 1</span></CodeLine>
<Link id="l03156" /><CodeLine lineNumber="3156"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(RHS, <a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>())) &#123;</span></CodeLine>
<Link id="l03157" /><CodeLine lineNumber="3157"><span class="doxyHighlight">      newLHS = LHSOp0;</span></CodeLine>
<Link id="l03158" /><CodeLine lineNumber="3158"><span class="doxyHighlight">      newRHS = LHSOp1;</span></CodeLine>
<Link id="l03159" /><CodeLine lineNumber="3159"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03160" /><CodeLine lineNumber="3160"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// case 2 or 4</span></CodeLine>
<Link id="l03161" /><CodeLine lineNumber="3161"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LHSOp0Width == LHSWidth) &#123;</span></CodeLine>
<Link id="l03162" /><CodeLine lineNumber="3162"><span class="doxyHighlight">      newLHS = LHSOp0;</span></CodeLine>
<Link id="l03163" /><CodeLine lineNumber="3163"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03164" /><CodeLine lineNumber="3164"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03165" /><CodeLine lineNumber="3165"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// case 3 or 4</span></CodeLine>
<Link id="l03166" /><CodeLine lineNumber="3166"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (RHSShuffle &amp;&amp; RHSOp0Width == LHSWidth) &#123;</span></CodeLine>
<Link id="l03167" /><CodeLine lineNumber="3167"><span class="doxyHighlight">    newRHS = RHSOp0;</span></CodeLine>
<Link id="l03168" /><CodeLine lineNumber="3168"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03169" /><CodeLine lineNumber="3169"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// case 4</span></CodeLine>
<Link id="l03170" /><CodeLine lineNumber="3170"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LHSOp0 == RHSOp0) &#123;</span></CodeLine>
<Link id="l03171" /><CodeLine lineNumber="3171"><span class="doxyHighlight">    newLHS = LHSOp0;</span></CodeLine>
<Link id="l03172" /><CodeLine lineNumber="3172"><span class="doxyHighlight">    newRHS = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03173" /><CodeLine lineNumber="3173"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03174" /><CodeLine lineNumber="3174"></CodeLine>
<Link id="l03175" /><CodeLine lineNumber="3175"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (newLHS == LHS &amp;&amp; newRHS == RHS)</span></CodeLine>
<Link id="l03176" /><CodeLine lineNumber="3176"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> MadeChange ? &amp;SVI : </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03177" /><CodeLine lineNumber="3177"></CodeLine>
<Link id="l03178" /><CodeLine lineNumber="3178"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;int&gt;</a> LHSMask;</span></CodeLine>
<Link id="l03179" /><CodeLine lineNumber="3179"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;int&gt;</a> RHSMask;</span></CodeLine>
<Link id="l03180" /><CodeLine lineNumber="3180"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (newLHS != LHS)</span></CodeLine>
<Link id="l03181" /><CodeLine lineNumber="3181"><span class="doxyHighlight">    LHSMask = LHSShuffle-&gt;<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>();</span></CodeLine>
<Link id="l03182" /><CodeLine lineNumber="3182"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (RHSShuffle &amp;&amp; newRHS != RHS)</span></CodeLine>
<Link id="l03183" /><CodeLine lineNumber="3183"><span class="doxyHighlight">    RHSMask = RHSShuffle-&gt;<a href="/docs/api/classes/llvm/shufflevectorinst/#a6eaff12d0d3ead952f2a2a2781df56ac">getShuffleMask</a>();</span></CodeLine>
<Link id="l03184" /><CodeLine lineNumber="3184"></CodeLine>
<Link id="l03185" /><CodeLine lineNumber="3185"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> newLHSWidth = (newLHS != LHS) ? LHSOp0Width : LHSWidth;</span></CodeLine>
<Link id="l03186" /><CodeLine lineNumber="3186"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;int, 16&gt;</a> newMask;</span></CodeLine>
<Link id="l03187" /><CodeLine lineNumber="3187"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/lowermatrixintrinsics-cpp/#a6a2164e5aeea9c3e9a02eab3747efd8c">isSplat</a> = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03188" /><CodeLine lineNumber="3188"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> SplatElt = -1;</span></CodeLine>
<Link id="l03189" /><CodeLine lineNumber="3189"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create a new mask for the new ShuffleVectorInst so that the new</span></CodeLine>
<Link id="l03190" /><CodeLine lineNumber="3190"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// ShuffleVectorInst is equivalent to the original one.</span></CodeLine>
<Link id="l03191" /><CodeLine lineNumber="3191"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> i = 0; i &lt; VWidth; ++i) &#123;</span></CodeLine>
<Link id="l03192" /><CodeLine lineNumber="3192"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> eltMask;</span></CodeLine>
<Link id="l03193" /><CodeLine lineNumber="3193"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Mask&#91;i&#93; &lt; 0) &#123;</span></CodeLine>
<Link id="l03194" /><CodeLine lineNumber="3194"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// This element is a poison value.</span></CodeLine>
<Link id="l03195" /><CodeLine lineNumber="3195"><span class="doxyHighlight">      eltMask = -1;</span></CodeLine>
<Link id="l03196" /><CodeLine lineNumber="3196"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Mask&#91;i&#93; &lt; (</span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight">)LHSWidth) &#123;</span></CodeLine>
<Link id="l03197" /><CodeLine lineNumber="3197"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// This element is from left hand side vector operand.</span></CodeLine>
<Link id="l03198" /><CodeLine lineNumber="3198"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l03199" /><CodeLine lineNumber="3199"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If LHS is going to be replaced (case 1, 2, or 4), calculate the</span></CodeLine>
<Link id="l03200" /><CodeLine lineNumber="3200"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// new mask value for the element.</span></CodeLine>
<Link id="l03201" /><CodeLine lineNumber="3201"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (newLHS != LHS) &#123;</span></CodeLine>
<Link id="l03202" /><CodeLine lineNumber="3202"><span class="doxyHighlight">        eltMask = LHSMask&#91;Mask&#91;i&#93;&#93;;</span></CodeLine>
<Link id="l03203" /><CodeLine lineNumber="3203"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// If the value selected is an poison value, explicitly specify it</span></CodeLine>
<Link id="l03204" /><CodeLine lineNumber="3204"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// with a -1 mask value.</span></CodeLine>
<Link id="l03205" /><CodeLine lineNumber="3205"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (eltMask &gt;= (</span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight">)LHSOp0Width &amp;&amp; <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;PoisonValue&gt;</a>(LHSOp1))</span></CodeLine>
<Link id="l03206" /><CodeLine lineNumber="3206"><span class="doxyHighlight">          eltMask = -1;</span></CodeLine>
<Link id="l03207" /><CodeLine lineNumber="3207"><span class="doxyHighlight">      &#125; </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l03208" /><CodeLine lineNumber="3208"><span class="doxyHighlight">        eltMask = Mask&#91;i&#93;;</span></CodeLine>
<Link id="l03209" /><CodeLine lineNumber="3209"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l03210" /><CodeLine lineNumber="3210"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// This element is from right hand side vector operand</span></CodeLine>
<Link id="l03211" /><CodeLine lineNumber="3211"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l03212" /><CodeLine lineNumber="3212"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If the value selected is a poison value, explicitly specify it</span></CodeLine>
<Link id="l03213" /><CodeLine lineNumber="3213"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// with a -1 mask value. (case 1)</span></CodeLine>
<Link id="l03214" /><CodeLine lineNumber="3214"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(RHS, <a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>()))</span></CodeLine>
<Link id="l03215" /><CodeLine lineNumber="3215"><span class="doxyHighlight">        eltMask = -1;</span></CodeLine>
<Link id="l03216" /><CodeLine lineNumber="3216"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If RHS is going to be replaced (case 3 or 4), calculate the</span></CodeLine>
<Link id="l03217" /><CodeLine lineNumber="3217"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// new mask value for the element.</span></CodeLine>
<Link id="l03218" /><CodeLine lineNumber="3218"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (newRHS != RHS) &#123;</span></CodeLine>
<Link id="l03219" /><CodeLine lineNumber="3219"><span class="doxyHighlight">        eltMask = RHSMask&#91;Mask&#91;i&#93;-LHSWidth&#93;;</span></CodeLine>
<Link id="l03220" /><CodeLine lineNumber="3220"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// If the value selected is an poison value, explicitly specify it</span></CodeLine>
<Link id="l03221" /><CodeLine lineNumber="3221"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// with a -1 mask value.</span></CodeLine>
<Link id="l03222" /><CodeLine lineNumber="3222"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (eltMask &gt;= (</span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight">)RHSOp0Width) &#123;</span></CodeLine>
<Link id="l03223" /><CodeLine lineNumber="3223"><span class="doxyHighlight">          <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(RHSShuffle-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1), <a href="/docs/api/namespaces/llvm/patternmatch/#a0108cb60d944ff177beaa8f419c91d72">m&#95;Poison</a>()) &amp;&amp;</span></CodeLine>
<Link id="l03224" /><CodeLine lineNumber="3224"><span class="doxyHighlight">                 </span><span class="doxyHighlightStringLiteral">&quot;should have been check above&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l03225" /><CodeLine lineNumber="3225"><span class="doxyHighlight">          eltMask = -1;</span></CodeLine>
<Link id="l03226" /><CodeLine lineNumber="3226"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l03227" /><CodeLine lineNumber="3227"><span class="doxyHighlight">      &#125; </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l03228" /><CodeLine lineNumber="3228"><span class="doxyHighlight">        eltMask = Mask&#91;i&#93;-LHSWidth;</span></CodeLine>
<Link id="l03229" /><CodeLine lineNumber="3229"></CodeLine>
<Link id="l03230" /><CodeLine lineNumber="3230"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If LHS&#39;s width is changed, shift the mask value accordingly.</span></CodeLine>
<Link id="l03231" /><CodeLine lineNumber="3231"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If newRHS == nullptr, i.e. LHSOp0 == RHSOp0, we want to remap any</span></CodeLine>
<Link id="l03232" /><CodeLine lineNumber="3232"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// references from RHSOp0 to LHSOp0, so we don&#39;t need to shift the mask.</span></CodeLine>
<Link id="l03233" /><CodeLine lineNumber="3233"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If newRHS == newLHS, we want to remap any references from newRHS to</span></CodeLine>
<Link id="l03234" /><CodeLine lineNumber="3234"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// newLHS so that we can properly identify splats that may occur due to</span></CodeLine>
<Link id="l03235" /><CodeLine lineNumber="3235"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// obfuscation across the two vectors.</span></CodeLine>
<Link id="l03236" /><CodeLine lineNumber="3236"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (eltMask &gt;= 0 &amp;&amp; newRHS != </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight"> &amp;&amp; newLHS != newRHS)</span></CodeLine>
<Link id="l03237" /><CodeLine lineNumber="3237"><span class="doxyHighlight">        eltMask += newLHSWidth;</span></CodeLine>
<Link id="l03238" /><CodeLine lineNumber="3238"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03239" /><CodeLine lineNumber="3239"></CodeLine>
<Link id="l03240" /><CodeLine lineNumber="3240"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Check if this could still be a splat.</span></CodeLine>
<Link id="l03241" /><CodeLine lineNumber="3241"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (eltMask &gt;= 0) &#123;</span></CodeLine>
<Link id="l03242" /><CodeLine lineNumber="3242"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SplatElt &gt;= 0 &amp;&amp; SplatElt != eltMask)</span></CodeLine>
<Link id="l03243" /><CodeLine lineNumber="3243"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/lowermatrixintrinsics-cpp/#a6a2164e5aeea9c3e9a02eab3747efd8c">isSplat</a> = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03244" /><CodeLine lineNumber="3244"><span class="doxyHighlight">      SplatElt = eltMask;</span></CodeLine>
<Link id="l03245" /><CodeLine lineNumber="3245"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03246" /><CodeLine lineNumber="3246"></CodeLine>
<Link id="l03247" /><CodeLine lineNumber="3247"><span class="doxyHighlight">    newMask.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(eltMask);</span></CodeLine>
<Link id="l03248" /><CodeLine lineNumber="3248"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03249" /><CodeLine lineNumber="3249"></CodeLine>
<Link id="l03250" /><CodeLine lineNumber="3250"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the result mask is equal to one of the original shuffle masks,</span></CodeLine>
<Link id="l03251" /><CodeLine lineNumber="3251"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// or is a splat, do the replacement.</span></CodeLine>
<Link id="l03252" /><CodeLine lineNumber="3252"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/lowermatrixintrinsics-cpp/#a6a2164e5aeea9c3e9a02eab3747efd8c">isSplat</a> || newMask == LHSMask || newMask == RHSMask || newMask == Mask) &#123;</span></CodeLine>
<Link id="l03253" /><CodeLine lineNumber="3253"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!newRHS)</span></CodeLine>
<Link id="l03254" /><CodeLine lineNumber="3254"><span class="doxyHighlight">      newRHS = <a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(newLHS-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>());</span></CodeLine>
<Link id="l03255" /><CodeLine lineNumber="3255"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/shufflevectorinst">ShuffleVectorInst</a>(newLHS, newRHS, newMask);</span></CodeLine>
<Link id="l03256" /><CodeLine lineNumber="3256"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03257" /><CodeLine lineNumber="3257"></CodeLine>
<Link id="l03258" /><CodeLine lineNumber="3258"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> MadeChange ? &amp;SVI : </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03259" /><CodeLine lineNumber="3259"><span class="doxyHighlight">&#125;</span></CodeLine>

</ProgramListing>


</DoxygenPage>
