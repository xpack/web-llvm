---

# DO NOT EDIT!
# Automatically generated via docusaurus-plugin-doxygen by Doxygen.

slug: /api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp
custom_edit_url: null
keywords:
  - doxygen
  - reference
  - file

---

import Link from '@docusaurus/Link'

import CodeLine from '@xpack/docusaurus-plugin-doxygen/components/CodeLine'
import DoxygenPage from '@xpack/docusaurus-plugin-doxygen/components/DoxygenPage'
import Highlight from '@xpack/docusaurus-plugin-doxygen/components/Highlight'
import IncludesList from '@xpack/docusaurus-plugin-doxygen/components/IncludesList'
import IncludesListItem from '@xpack/docusaurus-plugin-doxygen/components/IncludesListItem'
import MemberDefinition from '@xpack/docusaurus-plugin-doxygen/components/MemberDefinition'
import MembersIndex from '@xpack/docusaurus-plugin-doxygen/components/MembersIndex'
import MembersIndexItem from '@xpack/docusaurus-plugin-doxygen/components/MembersIndexItem'
import ProgramListing from '@xpack/docusaurus-plugin-doxygen/components/ProgramListing'
import SectionDefinition from '@xpack/docusaurus-plugin-doxygen/components/SectionDefinition'

import pluginConfig from '@site/docusaurus-plugin-doxygen-config.json'

# The `PlaceSafepoints.cpp` File Reference

<DoxygenPage pluginConfig={pluginConfig}>



## Included Headers

<IncludesList>
<IncludesListItem
  filePath="llvm/Transforms/Scalar/PlaceSafepoints.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/scalar/placesafepoints-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/InitializePasses.h"
  permalink="/docs/api/files/include/include/llvm/initializepasses-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Pass.h"
  permalink="/docs/api/files/include/include/llvm/pass-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SetVector.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/setvector-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/Statistic.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/CFG.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/cfg-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/LoopInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/loopinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/ScalarEvolution.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/scalarevolution-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/TargetLibraryInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/targetlibraryinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Dominators.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/dominators-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/IntrinsicInst.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/intrinsicinst-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/LegacyPassManager.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/legacypassmanager-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Module.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/module-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Statepoint.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/statepoint-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/CommandLine.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/Debug.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/debug-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Scalar.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/scalar-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/BasicBlockUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/basicblockutils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/Cloning.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/cloning-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/Local.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/local-h"
  isLocal="true" />
</IncludesList>

## Namespaces Index

<MembersIndex>

<MembersIndexItem
  type="namespace"
  name={<><a href="/docs/api/namespaces/anonymous-placesafepoints-cpp-">anonymous&#123;PlaceSafepoints.cpp&#125;</a></>}>
</MembersIndexItem>

</MembersIndex>

## Classes Index

<MembersIndex>

<MembersIndexItem
  type="class"
  name={<><a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass">PlaceBackedgeSafepointsLegacyPass</a></>}>
An analysis pass whose purpose is to identify each of the backedges in the function which require a safepoint poll to be inserted. <a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#details">More...</a>
</MembersIndexItem>

</MembersIndex>

## Functions Index

<MembersIndex>

<MembersIndexItem
  type="place backedge safepoints Place Backedge static false bool"
  name={<><a href="#aa2cbc07e426705bbdb98c0f6ae7e3f72">containsUnconditionalCallSafepoint</a> (Loop &#42;L, BasicBlock &#42;Header, BasicBlock &#42;Pred, DominatorTree &amp;DT, const TargetLibraryInfo &amp;TLI)</>}>
Returns true if this loop is known to contain a call safepoint which must unconditionally execute on any iteration of the loop which returns to the loop header via an edge from Pred. <a href="#aa2cbc07e426705bbdb98c0f6ae7e3f72">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#ab79294a2bb06a12d7f4dc32f80b8f935">doesNotRequireEntrySafepointBefore</a> (CallBase &#42;Call)</>}>
Returns true if an entry safepoint is not required before this callsite in the caller function. <a href="#ab79294a2bb06a12d7f4dc32f80b8f935">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#ade6d0f7cc42acd42e21c6154bd713afa">enableBackedgeSafepoints</a> (Function &amp;F)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a3a3b930c659333a27bb598ea5960fe52">enableCallSafepoints</a> (Function &amp;F)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a4021e064e9d2a5e5762d1d4a1dcd7db9">enableEntrySafepoints</a> (Function &amp;F)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;</>}
  name={<><a href="#a893c7586e2537bc37a83a57a0190f67f">findLocationForEntrySafepoint</a> (Function &amp;F, DominatorTree &amp;DT)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#ad1700270c8c097e34addb88dc823bf77">INITIALIZE&#95;PASS&#95;BEGIN</a> (PlaceBackedgeSafepointsLegacyPass, &quot;place-backedge-safepoints-impl&quot;, &quot;Place Backedge Safepoints&quot;, false, false) INITIALIZE&#95;PASS&#95;END(PlaceBackedgeSafepointsLegacyPass</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a05dd87a2da7ddff8ce97716e3b479b2e">InsertSafepointPoll</a> (BasicBlock::iterator InsertBefore, std::vector&lt; CallBase &#42; &gt; &amp;ParsePointsNeeded, const TargetLibraryInfo &amp;TLI)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a61ab641b03f16e1f3ad916913ce89903">isGCSafepointPoll</a> (Function &amp;F)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a2003053288ba4f0e1cd9ebf82b6a1987">mustBeFiniteCountedLoop</a> (Loop &#42;L, ScalarEvolution &#42;SE, BasicBlock &#42;Pred)</>}>
Returns true if this loop is known to terminate in a finite number of iterations. <a href="#a2003053288ba4f0e1cd9ebf82b6a1987">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a798de004bec543c0f9059f8c5fc78f92">needsStatepoint</a> (CallBase &#42;Call, const TargetLibraryInfo &amp;TLI)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a826d7a5a20d56ef31ee4111073700c93">scanInlinedCode</a> (Instruction &#42;Start, Instruction &#42;End, std::vector&lt; CallInst &#42; &gt; &amp;Calls, DenseSet&lt; BasicBlock &#42; &gt; &amp;Seen)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#afe210701ce0a3abfea9278d2538a6470">scanOneBB</a> (Instruction &#42;Start, Instruction &#42;End, std::vector&lt; CallInst &#42; &gt; &amp;Calls, DenseSet&lt; BasicBlock &#42; &gt; &amp;Seen, std::vector&lt; BasicBlock &#42; &gt; &amp;Worklist)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a737f3181d1ae8ed5fe159b4003d024d1">shouldRewriteFunction</a> (Function &amp;F)</>}>
Returns true if this function should be rewritten to include safepoint polls and parseable call sites. <a href="#a737f3181d1ae8ed5fe159b4003d024d1">More...</a>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#a382f84ef1b61ce7798e971d73d497a0b">STATISTIC</a> (NumEntrySafepoints, &quot;Number of entry safepoints inserted&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#adcb0b2d1bcb7c38b5e3ef700e2653adf">STATISTIC</a> (NumBackedgeSafepoints, &quot;Number of backedge safepoints inserted&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#acede0fd61d2e0d5d0202850570a38084">STATISTIC</a> (CallInLoop, &quot;Number of loops without safepoints due to calls in loop&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#a361b194e1c4dba3d4e157838ec64c19f">STATISTIC</a> (FiniteExecution, &quot;Number of loops without safepoints finite execution&quot;)</>}>
</MembersIndexItem>

</MembersIndex>

## Variables Index

<MembersIndex>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a18c9f542c1712e969a8c0d0ab7755198">AllBackedges</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; int &gt;</>}
  name={<><a href="#af19488cdbe65bf6c4cc7ff922bdab375">CountedLoopTripWidth</a></>}>
How narrow does the trip count of a loop have to be to have to be considered &quot;counted&quot;? <a href="#af19488cdbe65bf6c4cc7ff922bdab375">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="place backedge safepoints Place Backedge"
  name={<><a href="#a459936a2872de62d06126d0fdb67fff5">false</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> char</>}
  name={<><a href="#a0d2900c2047fa60ef8138dae263123ff">GCSafepointPollName</a> = &quot;gc.safepoint&#95;poll&quot;</>}>
</MembersIndexItem>

<MembersIndexItem
  type="place backedge safepoints"
  name={<><a href="#abd1ccb1bf511e1965414eb1d2e137302">impl</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#ac2cc2564a989cc024c9fec30a0513fac">NoBackedge</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#ab83017c62afe3ecae730eba7a1920baa">NoCall</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a4c12206227b4e8c2c86eb6b358ac6b40">NoEntry</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type="place backedge safepoints Place Backedge"
  name={<><a href="#ac374f48de5a20a58a5d22cb67f90249f">Safepoints</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a903a0c956da2425ebdf39f8995f2a900">SplitBackedge</a></>}>
</MembersIndexItem>

</MembersIndex>

## Defines Index

<MembersIndex>

<MembersIndexItem
  type="#define"
  name={<><a href="#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>&nbsp;&nbsp;&nbsp;&quot;place-safepoints&quot;</>}>
</MembersIndexItem>

</MembersIndex>


<SectionDefinition>

## Functions

### containsUnconditionalCallSafepoint() {#aa2cbc07e426705bbdb98c0f6ae7e3f72}

<MemberDefinition
  prototype={<>static bool containsUnconditionalCallSafepoint (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42; L, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; Header, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; Pred, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/targetlibraryinfo">TargetLibraryInfo</a> &amp; TLI)</>}
  labels = {["static"]}>
Returns true if this loop is known to contain a call safepoint which must unconditionally execute on any iteration of the loop which returns to the loop header via an edge from Pred.

Returns a conservative correct answer; i.e. false is always valid.

Definition at line <a href="#l00403">403</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### doesNotRequireEntrySafepointBefore() {#ab79294a2bb06a12d7f4dc32f80b8f935}

<MemberDefinition
  prototype={<>static bool doesNotRequireEntrySafepointBefore (<a href="/docs/api/classes/llvm/callbase">CallBase</a> &#42; Call)</>}
  labels = {["static"]}>
Returns true if an entry safepoint is not required before this callsite in the caller function.

Definition at line <a href="#l00513">513</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### enableBackedgeSafepoints() {#ade6d0f7cc42acd42e21c6154bd713afa}

<MemberDefinition
  prototype={<>static bool enableBackedgeSafepoints (<a href="/docs/api/classes/llvm/function">Function</a> &amp; F)</>}
  labels = {["static"]}>

Definition at line <a href="#l00613">613</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### enableCallSafepoints() {#a3a3b930c659333a27bb598ea5960fe52}

<MemberDefinition
  prototype={<>static bool enableCallSafepoints (<a href="/docs/api/classes/llvm/function">Function</a> &amp; F)</>}
  labels = {["static"]}>

Definition at line <a href="#l00614">614</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### enableEntrySafepoints() {#a4021e064e9d2a5e5762d1d4a1dcd7db9}

<MemberDefinition
  prototype={<>static bool enableEntrySafepoints (<a href="/docs/api/classes/llvm/function">Function</a> &amp; F)</>}
  labels = {["static"]}>

Definition at line <a href="#l00612">612</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### findLocationForEntrySafepoint() {#a893c7586e2537bc37a83a57a0190f67f}

<MemberDefinition
  prototype={<>static Instruction &#42; findLocationForEntrySafepoint (<a href="/docs/api/classes/llvm/function">Function</a> &amp; F, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT)</>}
  labels = {["static"]}>

Definition at line <a href="#l00536">536</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### INITIALIZE&#95;PASS&#95;BEGIN() {#ad1700270c8c097e34addb88dc823bf77}

<MemberDefinition
  prototype={<>INITIALIZE&#95;PASS&#95;BEGIN (PlaceBackedgeSafepointsLegacyPass, &quot;place-backedge-safepoints-impl&quot;, &quot;Place Backedge Safepoints&quot;, false, false)</>}>

Definition at line <a href="#l00166">166</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### InsertSafepointPoll() {#a05dd87a2da7ddff8ce97716e3b479b2e}

<MemberDefinition
  prototype={<>static void InsertSafepointPoll (<a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> InsertBefore, <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpupromotealloca-cpp/#ac760e37eba1d852d0a28011a1a0ce05f">std::vector</a>&lt; <a href="/docs/api/classes/llvm/callbase">CallBase</a> &#42; &gt; &amp; ParsePointsNeeded, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/targetlibraryinfo">TargetLibraryInfo</a> &amp; TLI)</>}
  labels = {["static"]}>

Definition at line <a href="#l00620">620</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### isGCSafepointPoll() {#a61ab641b03f16e1f3ad916913ce89903}

<MemberDefinition
  prototype={<>static bool isGCSafepointPoll (<a href="/docs/api/classes/llvm/function">Function</a> &amp; F)</>}
  labels = {["static"]}>

Definition at line <a href="#l00591">591</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### mustBeFiniteCountedLoop() {#a2003053288ba4f0e1cd9ebf82b6a1987}

<MemberDefinition
  prototype={<>static bool mustBeFiniteCountedLoop (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42; L, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42; SE, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; Pred)</>}
  labels = {["static"]}>
Returns true if this loop is known to terminate in a finite number of iterations.

Note that this function may return false for a loop which does actual terminate in a finite constant number of iterations due to conservatism in the analysis.

Definition at line <a href="#l00445">445</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### needsStatepoint() {#a798de004bec543c0f9059f8c5fc78f92}

<MemberDefinition
  prototype={<>static bool needsStatepoint (<a href="/docs/api/classes/llvm/callbase">CallBase</a> &#42; Call, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/targetlibraryinfo">TargetLibraryInfo</a> &amp; TLI)</>}
  labels = {["static"]}>

Definition at line <a href="#l00387">387</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### scanInlinedCode() {#a826d7a5a20d56ef31ee4111073700c93}

<MemberDefinition
  prototype={<>static void scanInlinedCode (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42; Start, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42; End, <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpupromotealloca-cpp/#ac760e37eba1d852d0a28011a1a0ce05f">std::vector</a>&lt; <a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42; &gt; &amp; Calls, <a href="/docs/api/classes/llvm/denseset">DenseSet</a>&lt; <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; &gt; &amp; Seen)</>}
  labels = {["static"]}>

Definition at line <a href="#l00497">497</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### scanOneBB() {#afe210701ce0a3abfea9278d2538a6470}

<MemberDefinition
  prototype={<>static void scanOneBB (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42; Start, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42; End, <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpupromotealloca-cpp/#ac760e37eba1d852d0a28011a1a0ce05f">std::vector</a>&lt; <a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42; &gt; &amp; Calls, <a href="/docs/api/classes/llvm/denseset">DenseSet</a>&lt; <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; &gt; &amp; Seen, <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpupromotealloca-cpp/#ac760e37eba1d852d0a28011a1a0ce05f">std::vector</a>&lt; <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; &gt; &amp; Worklist)</>}
  labels = {["static"]}>

Definition at line <a href="#l00470">470</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### shouldRewriteFunction() {#a737f3181d1ae8ed5fe159b4003d024d1}

<MemberDefinition
  prototype={<>static bool shouldRewriteFunction (<a href="/docs/api/classes/llvm/function">Function</a> &amp; F)</>}
  labels = {["static"]}>
Returns true if this function should be rewritten to include safepoint polls and parseable call sites.

The main point of this function is to be an extension point for custom logic.

Definition at line <a href="#l00598">598</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### STATISTIC() {#a382f84ef1b61ce7798e971d73d497a0b}

<MemberDefinition
  prototype={<>STATISTIC (NumEntrySafepoints, &quot;Number of entry safepoints inserted&quot;)</>}>

Definition at line <a href="#l00076">76</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### STATISTIC() {#adcb0b2d1bcb7c38b5e3ef700e2653adf}

<MemberDefinition
  prototype={<>STATISTIC (NumBackedgeSafepoints, &quot;Number of backedge safepoints inserted&quot;)</>}>

Definition at line <a href="#l00077">77</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### STATISTIC() {#acede0fd61d2e0d5d0202850570a38084}

<MemberDefinition
  prototype={<>STATISTIC (CallInLoop, &quot;Number of <a href="/docs/api/files/lib/lib/analysis/loopinfo-cpp/#a49ae40a9c91d665793aaed656c26ca30">loops</a> without safepoints due to calls in loop&quot;)</>}>

Definition at line <a href="#l00079">79</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### STATISTIC() {#a361b194e1c4dba3d4e157838ec64c19f}

<MemberDefinition
  prototype={<>STATISTIC (FiniteExecution, &quot;Number of <a href="/docs/api/files/lib/lib/analysis/loopinfo-cpp/#a49ae40a9c91d665793aaed656c26ca30">loops</a> without safepoints finite execution&quot;)</>}>

Definition at line <a href="#l00081">81</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Variables

### AllBackedges {#a18c9f542c1712e969a8c0d0ab7755198}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; AllBackedges(&quot;spp-all-backedges&quot;, cl::Hidden, cl::init(false))</>}
  labels = {["static"]}>

Definition at line <a href="#l00086">86</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### CountedLoopTripWidth {#af19488cdbe65bf6c4cc7ff922bdab375}

<MemberDefinition
  prototype={<>cl::opt&lt; int &gt; CountedLoopTripWidth(&quot;spp-counted-loop-trip-width&quot;, cl::Hidden, cl::init(32))</>}
  labels = {["static"]}>
How narrow does the trip count of a loop have to be to have to be considered &quot;counted&quot;?

Counted loops do not get safepoints at backedges.

Definition at line <a href="#l00091">91</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### false {#a459936a2872de62d06126d0fdb67fff5}

<MemberDefinition
  prototype="place backedge safepoints Place Backedge false">

Definition at line <a href="#l00174">174</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### GCSafepointPollName {#a0d2900c2047fa60ef8138dae263123ff}

<MemberDefinition
  prototype={<>const char GCSafepointPollName&#91;&#93; = &quot;gc.safepoint&#95;poll&quot;</>}>

Definition at line <a href="#l00589">589</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### impl {#abd1ccb1bf511e1965414eb1d2e137302}

<MemberDefinition
  prototype="place backedge safepoints impl">

Definition at line <a href="#l00173">173</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### NoBackedge {#ac2cc2564a989cc024c9fec30a0513fac}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; NoBackedge(&quot;spp-no-backedge&quot;, cl::Hidden, cl::init(false))</>}
  labels = {["static"]}>

Definition at line <a href="#l00162">162</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### NoCall {#ab83017c62afe3ecae730eba7a1920baa}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; NoCall(&quot;spp-no-call&quot;, cl::Hidden, cl::init(false))</>}
  labels = {["static"]}>

Definition at line <a href="#l00161">161</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### NoEntry {#a4c12206227b4e8c2c86eb6b358ac6b40}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; NoEntry(&quot;spp-no-entry&quot;, cl::Hidden, cl::init(false))</>}
  labels = {["static"]}>

Definition at line <a href="#l00160">160</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### Safepoints {#ac374f48de5a20a58a5d22cb67f90249f}

<MemberDefinition
  prototype="place backedge safepoints Place Backedge Safepoints">

Definition at line <a href="#l00174">174</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

### SplitBackedge {#a903a0c956da2425ebdf39f8995f2a900}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; SplitBackedge(&quot;spp-split-backedge&quot;, cl::Hidden, cl::init(false))</>}
  labels = {["static"]}>

Definition at line <a href="#l00098">98</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Defines

### DEBUG&#95;TYPE {#ad78e062f62e0d6e453941fb4ca843e4d}

<MemberDefinition
  prototype={<>#define DEBUG&#95;TYPE&nbsp;&nbsp;&nbsp;&quot;place-safepoints&quot;</>}>

Definition at line <a href="#l00074">74</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/placesafepoints-cpp">PlaceSafepoints.cpp</a>.
</MemberDefinition>

</SectionDefinition>

## File Listing

The file content with the documentation metadata removed is:

<ProgramListing>

<Link id="l00001" /><CodeLine lineNumber="1"><Highlight kind="comment">//===- PlaceSafepoints.cpp - Place GC Safepoints --------------------------===//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00002" /><CodeLine lineNumber="2"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00003" /><CodeLine lineNumber="3"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00004" /><CodeLine lineNumber="4"><Highlight kind="normal"></Highlight><Highlight kind="comment">// See https://llvm.org/LICENSE.txt for license information.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00005" /><CodeLine lineNumber="5"><Highlight kind="normal"></Highlight><Highlight kind="comment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00006" /><CodeLine lineNumber="6"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00007" /><CodeLine lineNumber="7"><Highlight kind="normal"></Highlight><Highlight kind="comment">//===----------------------------------------------------------------------===//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00008" /><CodeLine lineNumber="8"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00009" /><CodeLine lineNumber="9"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Place garbage collection safepoints at appropriate locations in the IR. This</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00010" /><CodeLine lineNumber="10"><Highlight kind="normal"></Highlight><Highlight kind="comment">// does not make relocation semantics or variable liveness explicit.  That&#39;s</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00011" /><CodeLine lineNumber="11"><Highlight kind="normal"></Highlight><Highlight kind="comment">// done by RewriteStatepointsForGC.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00012" /><CodeLine lineNumber="12"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00013" /><CodeLine lineNumber="13"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Terminology:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00014" /><CodeLine lineNumber="14"><Highlight kind="normal"></Highlight><Highlight kind="comment">// - A call is said to be &quot;parseable&quot; if there is a stack map generated for the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00015" /><CodeLine lineNumber="15"><Highlight kind="normal"></Highlight><Highlight kind="comment">// return PC of the call.  A runtime can determine where values listed in the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00016" /><CodeLine lineNumber="16"><Highlight kind="normal"></Highlight><Highlight kind="comment">// deopt arguments and (after RewriteStatepointsForGC) gc arguments are located</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00017" /><CodeLine lineNumber="17"><Highlight kind="normal"></Highlight><Highlight kind="comment">// on the stack when the code is suspended inside such a call.  Every parse</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00018" /><CodeLine lineNumber="18"><Highlight kind="normal"></Highlight><Highlight kind="comment">// point is represented by a call wrapped in an gc.statepoint intrinsic.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00019" /><CodeLine lineNumber="19"><Highlight kind="normal"></Highlight><Highlight kind="comment">// - A &quot;poll&quot; is an explicit check in the generated code to determine if the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00020" /><CodeLine lineNumber="20"><Highlight kind="normal"></Highlight><Highlight kind="comment">// runtime needs the generated code to cooperate by calling a helper routine</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00021" /><CodeLine lineNumber="21"><Highlight kind="normal"></Highlight><Highlight kind="comment">// and thus suspending its execution at a known state. The call to the helper</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00022" /><CodeLine lineNumber="22"><Highlight kind="normal"></Highlight><Highlight kind="comment">// routine will be parseable.  The (gc &amp; runtime specific) logic of a poll is</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00023" /><CodeLine lineNumber="23"><Highlight kind="normal"></Highlight><Highlight kind="comment">// assumed to be provided in a function of the name &quot;gc.safepoint&#95;poll&quot;.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00024" /><CodeLine lineNumber="24"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00025" /><CodeLine lineNumber="25"><Highlight kind="normal"></Highlight><Highlight kind="comment">// We aim to insert polls such that running code can quickly be brought to a</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00026" /><CodeLine lineNumber="26"><Highlight kind="normal"></Highlight><Highlight kind="comment">// well defined state for inspection by the collector.  In the current</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00027" /><CodeLine lineNumber="27"><Highlight kind="normal"></Highlight><Highlight kind="comment">// implementation, this is done via the insertion of poll sites at method entry</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00028" /><CodeLine lineNumber="28"><Highlight kind="normal"></Highlight><Highlight kind="comment">// and the backedge of most loops.  We try to avoid inserting more polls than</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00029" /><CodeLine lineNumber="29"><Highlight kind="normal"></Highlight><Highlight kind="comment">// are necessary to ensure a finite period between poll sites.  This is not</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00030" /><CodeLine lineNumber="30"><Highlight kind="normal"></Highlight><Highlight kind="comment">// because the poll itself is expensive in the generated code; it&#39;s not.  Polls</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00031" /><CodeLine lineNumber="31"><Highlight kind="normal"></Highlight><Highlight kind="comment">// do tend to impact the optimizer itself in negative ways; we&#39;d like to avoid</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00032" /><CodeLine lineNumber="32"><Highlight kind="normal"></Highlight><Highlight kind="comment">// perturbing the optimization of the method as much as we can.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00033" /><CodeLine lineNumber="33"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00034" /><CodeLine lineNumber="34"><Highlight kind="normal"></Highlight><Highlight kind="comment">// We also need to make most call sites parseable.  The callee might execute a</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00035" /><CodeLine lineNumber="35"><Highlight kind="normal"></Highlight><Highlight kind="comment">// poll (or otherwise be inspected by the GC).  If so, the entire stack</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00036" /><CodeLine lineNumber="36"><Highlight kind="normal"></Highlight><Highlight kind="comment">// (including the suspended frame of the current method) must be parseable.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00037" /><CodeLine lineNumber="37"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00038" /><CodeLine lineNumber="38"><Highlight kind="normal"></Highlight><Highlight kind="comment">// This pass will insert:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00039" /><CodeLine lineNumber="39"><Highlight kind="normal"></Highlight><Highlight kind="comment">// - Call parse points (&quot;call safepoints&quot;) for any call which may need to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00040" /><CodeLine lineNumber="40"><Highlight kind="normal"></Highlight><Highlight kind="comment">// reach a safepoint during the execution of the callee function.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00041" /><CodeLine lineNumber="41"><Highlight kind="normal"></Highlight><Highlight kind="comment">// - Backedge safepoint polls and entry safepoint polls to ensure that</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00042" /><CodeLine lineNumber="42"><Highlight kind="normal"></Highlight><Highlight kind="comment">// executing code reaches a safepoint poll in a finite amount of time.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00043" /><CodeLine lineNumber="43"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00044" /><CodeLine lineNumber="44"><Highlight kind="normal"></Highlight><Highlight kind="comment">// We do not currently support return statepoints, but adding them would not</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00045" /><CodeLine lineNumber="45"><Highlight kind="normal"></Highlight><Highlight kind="comment">// be hard.  They are not required for correctness - entry safepoints are an</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00046" /><CodeLine lineNumber="46"><Highlight kind="normal"></Highlight><Highlight kind="comment">// alternative - but some GCs may prefer them.  Patches welcome.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00047" /><CodeLine lineNumber="47"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00048" /><CodeLine lineNumber="48"><Highlight kind="normal"></Highlight><Highlight kind="comment">//===----------------------------------------------------------------------===//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00049" /><CodeLine lineNumber="49"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00050" /><CodeLine lineNumber="50"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/scalar/placesafepoints-h">llvm/Transforms/Scalar/PlaceSafepoints.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00051" /><CodeLine lineNumber="51"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/initializepasses-h">llvm/InitializePasses.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00052" /><CodeLine lineNumber="52"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/pass-h">llvm/Pass.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00053" /><CodeLine lineNumber="53"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00054" /><CodeLine lineNumber="54"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/setvector-h">llvm/ADT/SetVector.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00055" /><CodeLine lineNumber="55"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h">llvm/ADT/Statistic.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00056" /><CodeLine lineNumber="56"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/cfg-h">llvm/Analysis/CFG.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00057" /><CodeLine lineNumber="57"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/loopinfo-h">llvm/Analysis/LoopInfo.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00058" /><CodeLine lineNumber="58"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/scalarevolution-h">llvm/Analysis/ScalarEvolution.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00059" /><CodeLine lineNumber="59"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/targetlibraryinfo-h">llvm/Analysis/TargetLibraryInfo.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00060" /><CodeLine lineNumber="60"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/dominators-h">llvm/IR/Dominators.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00061" /><CodeLine lineNumber="61"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/intrinsicinst-h">llvm/IR/IntrinsicInst.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00062" /><CodeLine lineNumber="62"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/legacypassmanager-h">llvm/IR/LegacyPassManager.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00063" /><CodeLine lineNumber="63"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/module-h">llvm/IR/Module.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00064" /><CodeLine lineNumber="64"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/statepoint-h">llvm/IR/Statepoint.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00065" /><CodeLine lineNumber="65"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h">llvm/Support/CommandLine.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00066" /><CodeLine lineNumber="66"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h">llvm/Support/Debug.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00067" /><CodeLine lineNumber="67"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/scalar-h">llvm/Transforms/Scalar.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00068" /><CodeLine lineNumber="68"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/basicblockutils-h">llvm/Transforms/Utils/BasicBlockUtils.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00069" /><CodeLine lineNumber="69"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/cloning-h">llvm/Transforms/Utils/Cloning.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00070" /><CodeLine lineNumber="70"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/local-h">llvm/Transforms/Utils/Local.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00071" /><CodeLine lineNumber="71"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00072" /><CodeLine lineNumber="72"><Highlight kind="normal"></Highlight><Highlight kind="keyword">using namespace </Highlight><Highlight kind="normal"><a href="/docs/api/namespaces/llvm">llvm</a>;</Highlight></CodeLine>
<Link id="l00073" /><CodeLine lineNumber="73"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00074" /><CodeLine lineNumber="74" lineLink="#ad78e062f62e0d6e453941fb4ca843e4d"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#define DEBUG&#95;TYPE &quot;place-safepoints&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00075" /><CodeLine lineNumber="75"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00076" /><CodeLine lineNumber="76" lineLink="#a382f84ef1b61ce7798e971d73d497a0b"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumEntrySafepoints, </Highlight><Highlight kind="stringliteral">&quot;Number of entry safepoints inserted&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00077" /><CodeLine lineNumber="77" lineLink="#adcb0b2d1bcb7c38b5e3ef700e2653adf"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumBackedgeSafepoints, </Highlight><Highlight kind="stringliteral">&quot;Number of backedge safepoints inserted&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00078" /><CodeLine lineNumber="78"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00079" /><CodeLine lineNumber="79" lineLink="#acede0fd61d2e0d5d0202850570a38084"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(CallInLoop,</Highlight></CodeLine>
<Link id="l00080" /><CodeLine lineNumber="80"><Highlight kind="normal">          </Highlight><Highlight kind="stringliteral">&quot;Number of loops without safepoints due to calls in loop&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00081" /><CodeLine lineNumber="81" lineLink="#a361b194e1c4dba3d4e157838ec64c19f"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(FiniteExecution,</Highlight></CodeLine>
<Link id="l00082" /><CodeLine lineNumber="82"><Highlight kind="normal">          </Highlight><Highlight kind="stringliteral">&quot;Number of loops without safepoints finite execution&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00083" /><CodeLine lineNumber="83"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00084" /><CodeLine lineNumber="84"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Ignore opportunities to avoid placing safepoints on backedges, useful for</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00085" /><CodeLine lineNumber="85"><Highlight kind="normal"></Highlight><Highlight kind="comment">// validation</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00086" /><CodeLine lineNumber="86" lineLink="#a18c9f542c1712e969a8c0d0ab7755198"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a18c9f542c1712e969a8c0d0ab7755198">AllBackedges</a>(</Highlight><Highlight kind="stringliteral">&quot;spp-all-backedges&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</Highlight></CodeLine>
<Link id="l00087" /><CodeLine lineNumber="87"><Highlight kind="normal">                                  <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00088" /><CodeLine lineNumber="88"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00089" /><CodeLine lineNumber="89"><Highlight kind="comment">/// How narrow does the trip count of a loop have to be to have to be considered</Highlight></CodeLine>
<Link id="l00090" /><CodeLine lineNumber="90"><Highlight kind="comment">/// &quot;counted&quot;?  Counted loops do not get safepoints at backedges.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00091" /><CodeLine lineNumber="91" lineLink="#af19488cdbe65bf6c4cc7ff922bdab375"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;int&gt;</a> <a href="#af19488cdbe65bf6c4cc7ff922bdab375">CountedLoopTripWidth</a>(</Highlight><Highlight kind="stringliteral">&quot;spp-counted-loop-trip-width&quot;</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l00092" /><CodeLine lineNumber="92"><Highlight kind="normal">                                         <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(32));</Highlight></CodeLine>
<Link id="l00093" /><CodeLine lineNumber="93"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00094" /><CodeLine lineNumber="94"><Highlight kind="normal"></Highlight><Highlight kind="comment">// If true, split the backedge of a loop when placing the safepoint, otherwise</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00095" /><CodeLine lineNumber="95"><Highlight kind="normal"></Highlight><Highlight kind="comment">// split the latch block itself.  Both are useful to support for</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00096" /><CodeLine lineNumber="96"><Highlight kind="normal"></Highlight><Highlight kind="comment">// experimentation, but in practice, it looks like splitting the backedge</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00097" /><CodeLine lineNumber="97"><Highlight kind="normal"></Highlight><Highlight kind="comment">// optimizes better.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00098" /><CodeLine lineNumber="98" lineLink="#a903a0c956da2425ebdf39f8995f2a900"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a903a0c956da2425ebdf39f8995f2a900">SplitBackedge</a>(</Highlight><Highlight kind="stringliteral">&quot;spp-split-backedge&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</Highlight></CodeLine>
<Link id="l00099" /><CodeLine lineNumber="99"><Highlight kind="normal">                                   <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00100" /><CodeLine lineNumber="100"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00101" /><CodeLine lineNumber="101" lineLink="/docs/api/namespaces/anonymous-placesafepoints-cpp-"><Highlight kind="normal"></Highlight><Highlight kind="keyword">namespace </Highlight><Highlight kind="normal">&#123;</Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00102" /><CodeLine lineNumber="102"><Highlight kind="comment">/// An analysis pass whose purpose is to identify each of the backedges in</Highlight></CodeLine>
<Link id="l00103" /><CodeLine lineNumber="103"><Highlight kind="comment">/// the function which require a safepoint poll to be inserted.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00104" /><CodeLine lineNumber="104" lineLink="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass"><Highlight kind="normal"></Highlight><Highlight kind="keyword">class </Highlight><Highlight kind="normal"><a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#ad4fe890aa81f74897049f012831850f2">PlaceBackedgeSafepointsLegacyPass</a> : </Highlight><Highlight kind="keyword">public</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/functionpass/#a7691d83e3561f781cae4ce4a01bdfa93">FunctionPass</a> &#123;</Highlight></CodeLine>
<Link id="l00105" /><CodeLine lineNumber="105"><Highlight kind="normal"></Highlight><Highlight kind="keyword">public</Highlight><Highlight kind="normal">:</Highlight></CodeLine>
<Link id="l00106" /><CodeLine lineNumber="106" lineLink="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#a043ff4faad1c595d6da027ef16ee7e4b"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">char</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#a043ff4faad1c595d6da027ef16ee7e4b">ID</a>;</Highlight></CodeLine>
<Link id="l00107" /><CodeLine lineNumber="107"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00108" /><CodeLine lineNumber="108"><Highlight kind="comment">  /// The output of the pass - gives a list of each backedge (described by</Highlight></CodeLine>
<Link id="l00109" /><CodeLine lineNumber="109"><Highlight kind="comment">  /// pointing at the branch) which need a poll inserted.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00110" /><CodeLine lineNumber="110" lineLink="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#a3a640a568c83529b9550f3fcbeecf537"><Highlight kind="normal">  std::vector&lt;Instruction &#42;&gt; <a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#a3a640a568c83529b9550f3fcbeecf537">PollLocations</a>;</Highlight></CodeLine>
<Link id="l00111" /><CodeLine lineNumber="111"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00112" /><CodeLine lineNumber="112"><Highlight kind="comment">  /// True unless we&#39;re running spp-no-calls in which case we need to disable</Highlight></CodeLine>
<Link id="l00113" /><CodeLine lineNumber="113"><Highlight kind="comment">  /// the call-dependent placement opts.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00114" /><CodeLine lineNumber="114" lineLink="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#adae57e401de3569a13bda4a82fd2d034"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#adae57e401de3569a13bda4a82fd2d034">CallSafepointsEnabled</a>;</Highlight></CodeLine>
<Link id="l00115" /><CodeLine lineNumber="115"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00116" /><CodeLine lineNumber="116" lineLink="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#ad4fe890aa81f74897049f012831850f2"><Highlight kind="normal">  <a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#ad4fe890aa81f74897049f012831850f2">PlaceBackedgeSafepointsLegacyPass</a>(</Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> CallSafepoints = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">)</Highlight></CodeLine>
<Link id="l00117" /><CodeLine lineNumber="117"><Highlight kind="normal">      : <a href="/docs/api/classes/llvm/functionpass/#a7691d83e3561f781cae4ce4a01bdfa93">FunctionPass</a>(<a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#a043ff4faad1c595d6da027ef16ee7e4b">ID</a>), <a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#adae57e401de3569a13bda4a82fd2d034">CallSafepointsEnabled</a>(CallSafepoints) &#123;</Highlight></CodeLine>
<Link id="l00118" /><CodeLine lineNumber="118"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a65dbe1d40704c19d5743dcfd841e6fda">initializePlaceBackedgeSafepointsLegacyPassPass</a>(</Highlight></CodeLine>
<Link id="l00119" /><CodeLine lineNumber="119"><Highlight kind="normal">        &#42;<a href="/docs/api/classes/llvm/passregistry/#a05a729900b76c89e808c6c3094921b2f">PassRegistry::getPassRegistry</a>());</Highlight></CodeLine>
<Link id="l00120" /><CodeLine lineNumber="120"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00121" /><CodeLine lineNumber="121"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00122" /><CodeLine lineNumber="122"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> runOnLoop(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;);</Highlight></CodeLine>
<Link id="l00123" /><CodeLine lineNumber="123"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00124" /><CodeLine lineNumber="124" lineLink="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#a6c3d540da57e61a201b1d42332de95f2"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#a6c3d540da57e61a201b1d42332de95f2">runOnLoopAndSubLoops</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L) &#123;</Highlight></CodeLine>
<Link id="l00125" /><CodeLine lineNumber="125"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Visit all the subloops</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00126" /><CodeLine lineNumber="126"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : &#42;L)</Highlight></CodeLine>
<Link id="l00127" /><CodeLine lineNumber="127"><Highlight kind="normal">      <a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#a6c3d540da57e61a201b1d42332de95f2">runOnLoopAndSubLoops</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</Highlight></CodeLine>
<Link id="l00128" /><CodeLine lineNumber="128"><Highlight kind="normal">    <a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#a2aeb026149b4828fce3670b7c14834b2">runOnLoop</a>(L);</Highlight></CodeLine>
<Link id="l00129" /><CodeLine lineNumber="129"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00130" /><CodeLine lineNumber="130"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00131" /><CodeLine lineNumber="131" lineLink="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#affd1850125d61f01b3542b64a7d9e6fc"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#affd1850125d61f01b3542b64a7d9e6fc">runOnFunction</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>)</Highlight><Highlight kind="keyword"> override </Highlight><Highlight kind="normal">&#123;</Highlight></CodeLine>
<Link id="l00132" /><CodeLine lineNumber="132"><Highlight kind="normal">    SE = &amp;<a href="/docs/api/classes/llvm/pass/#a4863e5e463fb79955269fbf7fbf52b80">getAnalysis&lt;ScalarEvolutionWrapperPass&gt;</a>().getSE();</Highlight></CodeLine>
<Link id="l00133" /><CodeLine lineNumber="133"><Highlight kind="normal">    DT = &amp;<a href="/docs/api/classes/llvm/pass/#a4863e5e463fb79955269fbf7fbf52b80">getAnalysis&lt;DominatorTreeWrapperPass&gt;</a>().getDomTree();</Highlight></CodeLine>
<Link id="l00134" /><CodeLine lineNumber="134"><Highlight kind="normal">    LI = &amp;<a href="/docs/api/classes/llvm/pass/#a4863e5e463fb79955269fbf7fbf52b80">getAnalysis&lt;LoopInfoWrapperPass&gt;</a>().getLoopInfo();</Highlight></CodeLine>
<Link id="l00135" /><CodeLine lineNumber="135"><Highlight kind="normal">    TLI = &amp;<a href="/docs/api/classes/llvm/pass/#a4863e5e463fb79955269fbf7fbf52b80">getAnalysis&lt;TargetLibraryInfoWrapperPass&gt;</a>().getTLI(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</Highlight></CodeLine>
<Link id="l00136" /><CodeLine lineNumber="136"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : &#42;LI) &#123;</Highlight></CodeLine>
<Link id="l00137" /><CodeLine lineNumber="137"><Highlight kind="normal">      <a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#a6c3d540da57e61a201b1d42332de95f2">runOnLoopAndSubLoops</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</Highlight></CodeLine>
<Link id="l00138" /><CodeLine lineNumber="138"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00139" /><CodeLine lineNumber="139"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00140" /><CodeLine lineNumber="140"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00141" /><CodeLine lineNumber="141"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00142" /><CodeLine lineNumber="142" lineLink="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#acdbf6d8b413ffb81652cf8c434ee423a"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#acdbf6d8b413ffb81652cf8c434ee423a">getAnalysisUsage</a>(<a href="/docs/api/classes/llvm/analysisusage">AnalysisUsage</a> &amp;AU)</Highlight><Highlight kind="keyword"> const override </Highlight><Highlight kind="normal">&#123;</Highlight></CodeLine>
<Link id="l00143" /><CodeLine lineNumber="143"><Highlight kind="normal">    AU.<a href="/docs/api/classes/llvm/analysisusage/#ae0adcccca08fb686c9ce00f9397b660c">addRequired</a>&lt;<a href="/docs/api/classes/llvm/dominatortreewrapperpass">DominatorTreeWrapperPass</a>&gt;();</Highlight></CodeLine>
<Link id="l00144" /><CodeLine lineNumber="144"><Highlight kind="normal">    AU.<a href="/docs/api/classes/llvm/analysisusage/#ae0adcccca08fb686c9ce00f9397b660c">addRequired</a>&lt;<a href="/docs/api/classes/llvm/scalarevolutionwrapperpass">ScalarEvolutionWrapperPass</a>&gt;();</Highlight></CodeLine>
<Link id="l00145" /><CodeLine lineNumber="145"><Highlight kind="normal">    AU.<a href="/docs/api/classes/llvm/analysisusage/#ae0adcccca08fb686c9ce00f9397b660c">addRequired</a>&lt;<a href="/docs/api/classes/llvm/loopinfowrapperpass">LoopInfoWrapperPass</a>&gt;();</Highlight></CodeLine>
<Link id="l00146" /><CodeLine lineNumber="146"><Highlight kind="normal">    AU.<a href="/docs/api/classes/llvm/analysisusage/#ae0adcccca08fb686c9ce00f9397b660c">addRequired</a>&lt;<a href="/docs/api/classes/llvm/targetlibraryinfowrapperpass">TargetLibraryInfoWrapperPass</a>&gt;();</Highlight></CodeLine>
<Link id="l00147" /><CodeLine lineNumber="147"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We no longer modify the IR at all in this pass.  Thus all</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00148" /><CodeLine lineNumber="148"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// analysis are preserved.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00149" /><CodeLine lineNumber="149"><Highlight kind="normal">    AU.<a href="/docs/api/classes/llvm/analysisusage/#af22b06a6a4f9df80454071685a0d6a02">setPreservesAll</a>();</Highlight></CodeLine>
<Link id="l00150" /><CodeLine lineNumber="150"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00151" /><CodeLine lineNumber="151"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00152" /><CodeLine lineNumber="152"><Highlight kind="normal"></Highlight><Highlight kind="keyword">private</Highlight><Highlight kind="normal">:</Highlight></CodeLine>
<Link id="l00153" /><CodeLine lineNumber="153"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42;SE = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00154" /><CodeLine lineNumber="154"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &#42;DT = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00155" /><CodeLine lineNumber="155"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &#42;LI = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00156" /><CodeLine lineNumber="156"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/targetlibraryinfo">TargetLibraryInfo</a> &#42;TLI = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00157" /><CodeLine lineNumber="157"><Highlight kind="normal">&#125;;</Highlight></CodeLine>
<Link id="l00158" /><CodeLine lineNumber="158"><Highlight kind="normal">&#125; </Highlight><Highlight kind="comment">// namespace</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00159" /><CodeLine lineNumber="159"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00160" /><CodeLine lineNumber="160" lineLink="#a4c12206227b4e8c2c86eb6b358ac6b40"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a4c12206227b4e8c2c86eb6b358ac6b40">NoEntry</a>(</Highlight><Highlight kind="stringliteral">&quot;spp-no-entry&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00161" /><CodeLine lineNumber="161" lineLink="#ab83017c62afe3ecae730eba7a1920baa"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#ab83017c62afe3ecae730eba7a1920baa">NoCall</a>(</Highlight><Highlight kind="stringliteral">&quot;spp-no-call&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00162" /><CodeLine lineNumber="162" lineLink="#ac2cc2564a989cc024c9fec30a0513fac"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#ac2cc2564a989cc024c9fec30a0513fac">NoBackedge</a>(</Highlight><Highlight kind="stringliteral">&quot;spp-no-backedge&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00163" /><CodeLine lineNumber="163"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00164" /><CodeLine lineNumber="164"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">char</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#a043ff4faad1c595d6da027ef16ee7e4b">PlaceBackedgeSafepointsLegacyPass::ID</a> = 0;</Highlight></CodeLine>
<Link id="l00165" /><CodeLine lineNumber="165"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00166" /><CodeLine lineNumber="166" lineLink="#ad1700270c8c097e34addb88dc823bf77"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/passsupport-h/#aaa970fc931c1c63037a8182e028d04b1">INITIALIZE&#95;PASS&#95;BEGIN</a>(<a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#ad4fe890aa81f74897049f012831850f2">PlaceBackedgeSafepointsLegacyPass</a>,</Highlight></CodeLine>
<Link id="l00167" /><CodeLine lineNumber="167"><Highlight kind="normal">                      </Highlight><Highlight kind="stringliteral">&quot;place-backedge-safepoints-impl&quot;</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l00168" /><CodeLine lineNumber="168"><Highlight kind="normal">                      </Highlight><Highlight kind="stringliteral">&quot;Place Backedge Safepoints&quot;</Highlight><Highlight kind="normal">, </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">, </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">)</Highlight></CodeLine>
<Link id="l00169" /><CodeLine lineNumber="169"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/passsupport-h/#a14724f1ccf528e73bb29bc9230737967">INITIALIZE&#95;PASS&#95;DEPENDENCY</a>(<a href="/docs/api/classes/llvm/scalarevolutionwrapperpass">ScalarEvolutionWrapperPass</a>)</Highlight></CodeLine>
<Link id="l00170" /><CodeLine lineNumber="170"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/passsupport-h/#a14724f1ccf528e73bb29bc9230737967">INITIALIZE&#95;PASS&#95;DEPENDENCY</a>(<a href="/docs/api/classes/llvm/dominatortreewrapperpass">DominatorTreeWrapperPass</a>)</Highlight></CodeLine>
<Link id="l00171" /><CodeLine lineNumber="171"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/passsupport-h/#a14724f1ccf528e73bb29bc9230737967">INITIALIZE&#95;PASS&#95;DEPENDENCY</a>(<a href="/docs/api/classes/llvm/loopinfowrapperpass">LoopInfoWrapperPass</a>)</Highlight></CodeLine>
<Link id="l00172" /><CodeLine lineNumber="172"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/passsupport-h/#a74ce8276b89067e806f67c45a6d92575">INITIALIZE&#95;PASS&#95;END</a>(<a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#ad4fe890aa81f74897049f012831850f2">PlaceBackedgeSafepointsLegacyPass</a>,</Highlight></CodeLine>
<Link id="l00173" /><CodeLine lineNumber="173" lineLink="#abd1ccb1bf511e1965414eb1d2e137302"><Highlight kind="normal">                    </Highlight><Highlight kind="stringliteral">&quot;place-backedge-safepoints-impl&quot;</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l00174" /><CodeLine lineNumber="174" lineLink="#a459936a2872de62d06126d0fdb67fff5"><Highlight kind="normal">                    </Highlight><Highlight kind="stringliteral">&quot;Place Backedge Safepoints&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/false">false</a>, <a href="/docs/api/namespaces/false">false</a>)</Highlight></CodeLine>
<Link id="l00175" /><CodeLine lineNumber="175"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00176" /><CodeLine lineNumber="176"><Highlight kind="normal">static </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#aa2cbc07e426705bbdb98c0f6ae7e3f72">containsUnconditionalCallSafepoint</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Header,</Highlight></CodeLine>
<Link id="l00177" /><CodeLine lineNumber="177"><Highlight kind="normal">                                               <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Pred,</Highlight></CodeLine>
<Link id="l00178" /><CodeLine lineNumber="178"><Highlight kind="normal">                                               <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT,</Highlight></CodeLine>
<Link id="l00179" /><CodeLine lineNumber="179"><Highlight kind="normal">                                               <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/targetlibraryinfo">TargetLibraryInfo</a> &amp;TLI);</Highlight></CodeLine>
<Link id="l00180" /><CodeLine lineNumber="180"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00181" /><CodeLine lineNumber="181"><Highlight kind="normal">static </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a2003053288ba4f0e1cd9ebf82b6a1987">mustBeFiniteCountedLoop</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42;SE,</Highlight></CodeLine>
<Link id="l00182" /><CodeLine lineNumber="182"><Highlight kind="normal">                                    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Pred);</Highlight></CodeLine>
<Link id="l00183" /><CodeLine lineNumber="183"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00184" /><CodeLine lineNumber="184"><Highlight kind="normal">static <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="#a893c7586e2537bc37a83a57a0190f67f">findLocationForEntrySafepoint</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>,</Highlight></CodeLine>
<Link id="l00185" /><CodeLine lineNumber="185"><Highlight kind="normal">                                                  <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT);</Highlight></CodeLine>
<Link id="l00186" /><CodeLine lineNumber="186"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00187" /><CodeLine lineNumber="187"><Highlight kind="normal">static </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a61ab641b03f16e1f3ad916913ce89903">isGCSafepointPoll</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</Highlight></CodeLine>
<Link id="l00188" /><CodeLine lineNumber="188"><Highlight kind="normal">static </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a737f3181d1ae8ed5fe159b4003d024d1">shouldRewriteFunction</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</Highlight></CodeLine>
<Link id="l00189" /><CodeLine lineNumber="189"><Highlight kind="normal">static </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a4021e064e9d2a5e5762d1d4a1dcd7db9">enableEntrySafepoints</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</Highlight></CodeLine>
<Link id="l00190" /><CodeLine lineNumber="190"><Highlight kind="normal">static </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#ade6d0f7cc42acd42e21c6154bd713afa">enableBackedgeSafepoints</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</Highlight></CodeLine>
<Link id="l00191" /><CodeLine lineNumber="191"><Highlight kind="normal">static </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a3a3b930c659333a27bb598ea5960fe52">enableCallSafepoints</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</Highlight></CodeLine>
<Link id="l00192" /><CodeLine lineNumber="192"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00193" /><CodeLine lineNumber="193"><Highlight kind="normal">static </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00194" /><CodeLine lineNumber="194"><Highlight kind="normal"><a href="#a05dd87a2da7ddff8ce97716e3b479b2e">InsertSafepointPoll</a>(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a>::<a href="/docs/api/classes/llvm/iplist">iterator</a> InsertBefore,</Highlight></CodeLine>
<Link id="l00195" /><CodeLine lineNumber="195"><Highlight kind="normal">                    <a href="/docs/api/namespaces/std">std</a>::<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpupromotealloca-cpp/#ac760e37eba1d852d0a28011a1a0ce05f">vector</a>&lt;<a href="/docs/api/classes/llvm/callbase">CallBase</a> &#42;&gt; &amp;ParsePointsNeeded </Highlight><Highlight kind="comment">/&#42;rval&#42;/</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l00196" /><CodeLine lineNumber="196"><Highlight kind="normal">                    <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/targetlibraryinfo">TargetLibraryInfo</a> &amp;TLI);</Highlight></CodeLine>
<Link id="l00197" /><CodeLine lineNumber="197"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00198" /><CodeLine lineNumber="198" lineLink="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#a2aeb026149b4828fce3670b7c14834b2"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#ad4fe890aa81f74897049f012831850f2">PlaceBackedgeSafepointsLegacyPass</a>::<a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#a2aeb026149b4828fce3670b7c14834b2">runOnLoop</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L) &#123;</Highlight></CodeLine>
<Link id="l00199" /><CodeLine lineNumber="199"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Loop through all loop latches (branches controlling backedges).  We need</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00200" /><CodeLine lineNumber="200"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// to place a safepoint on every backedge (potentially).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00201" /><CodeLine lineNumber="201"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Note: In common usage, there will be only one edge due to LoopSimplify</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00202" /><CodeLine lineNumber="202"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// having run sometime earlier in the pipeline, but this code must be correct</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00203" /><CodeLine lineNumber="203"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// w.r.t. loops with multiple backedges.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00204" /><CodeLine lineNumber="204"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Header = L-&gt;getHeader();</Highlight></CodeLine>
<Link id="l00205" /><CodeLine lineNumber="205"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 16&gt;</a> LoopLatches;</Highlight></CodeLine>
<Link id="l00206" /><CodeLine lineNumber="206"><Highlight kind="normal">  L-&gt;getLoopLatches(LoopLatches);</Highlight></CodeLine>
<Link id="l00207" /><CodeLine lineNumber="207"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Pred : LoopLatches) &#123;</Highlight></CodeLine>
<Link id="l00208" /><CodeLine lineNumber="208"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(L-&gt;contains(Pred));</Highlight></CodeLine>
<Link id="l00209" /><CodeLine lineNumber="209"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00210" /><CodeLine lineNumber="210"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Make a policy decision about whether this loop needs a safepoint or</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00211" /><CodeLine lineNumber="211"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// not.  Note that this is about unburdening the optimizer in loops, not</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00212" /><CodeLine lineNumber="212"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// avoiding the runtime cost of the actual safepoint.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00213" /><CodeLine lineNumber="213"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="#a18c9f542c1712e969a8c0d0ab7755198">AllBackedges</a>) &#123;</Highlight></CodeLine>
<Link id="l00214" /><CodeLine lineNumber="214"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#a2003053288ba4f0e1cd9ebf82b6a1987">mustBeFiniteCountedLoop</a>(L, SE, Pred)) &#123;</Highlight></CodeLine>
<Link id="l00215" /><CodeLine lineNumber="215"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;skipping safepoint placement in finite loop\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00216" /><CodeLine lineNumber="216"><Highlight kind="normal">        FiniteExecution++;</Highlight></CodeLine>
<Link id="l00217" /><CodeLine lineNumber="217"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00218" /><CodeLine lineNumber="218"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00219" /><CodeLine lineNumber="219"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#adae57e401de3569a13bda4a82fd2d034">CallSafepointsEnabled</a> &amp;&amp;</Highlight></CodeLine>
<Link id="l00220" /><CodeLine lineNumber="220"><Highlight kind="normal">          <a href="#aa2cbc07e426705bbdb98c0f6ae7e3f72">containsUnconditionalCallSafepoint</a>(L, Header, Pred, &#42;DT, &#42;TLI)) &#123;</Highlight></CodeLine>
<Link id="l00221" /><CodeLine lineNumber="221"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Note: This is only semantically legal since we won&#39;t do any further</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00222" /><CodeLine lineNumber="222"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// IPO or inlining before the actual call insertion..  If we hadn&#39;t, we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00223" /><CodeLine lineNumber="223"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// might latter loose this call safepoint.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00224" /><CodeLine lineNumber="224"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(</Highlight></CodeLine>
<Link id="l00225" /><CodeLine lineNumber="225"><Highlight kind="normal">            <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>()</Highlight></CodeLine>
<Link id="l00226" /><CodeLine lineNumber="226"><Highlight kind="normal">            &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;skipping safepoint placement due to unconditional call\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00227" /><CodeLine lineNumber="227"><Highlight kind="normal">        CallInLoop++;</Highlight></CodeLine>
<Link id="l00228" /><CodeLine lineNumber="228"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00229" /><CodeLine lineNumber="229"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00230" /><CodeLine lineNumber="230"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00231" /><CodeLine lineNumber="231"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00232" /><CodeLine lineNumber="232"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// TODO: We can create an inner loop which runs a finite number of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00233" /><CodeLine lineNumber="233"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// iterations with an outer loop which contains a safepoint.  This would</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00234" /><CodeLine lineNumber="234"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// not help runtime performance that much, but it might help our ability to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00235" /><CodeLine lineNumber="235"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// optimize the inner loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00236" /><CodeLine lineNumber="236"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00237" /><CodeLine lineNumber="237"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Safepoint insertion would involve creating a new basic block (as the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00238" /><CodeLine lineNumber="238"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// target of the current backedge) which does the safepoint (of all live</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00239" /><CodeLine lineNumber="239"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// variables) and branches to the true header</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00240" /><CodeLine lineNumber="240"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Term = Pred-&gt;getTerminator();</Highlight></CodeLine>
<Link id="l00241" /><CodeLine lineNumber="241"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00242" /><CodeLine lineNumber="242"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;&#91;LSP&#93; terminator instruction: &quot;</Highlight><Highlight kind="normal"> &lt;&lt; &#42;Term);</Highlight></CodeLine>
<Link id="l00243" /><CodeLine lineNumber="243"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00244" /><CodeLine lineNumber="244"><Highlight kind="normal">    <a href="/docs/api/classes/anonymous-namespace-placesafepoints-cpp-/placebackedgesafepointslegacypass/#a3a640a568c83529b9550f3fcbeecf537">PollLocations</a>.push&#95;back(Term);</Highlight></CodeLine>
<Link id="l00245" /><CodeLine lineNumber="245"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00246" /><CodeLine lineNumber="246"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00247" /><CodeLine lineNumber="247"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00248" /><CodeLine lineNumber="248"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00249" /><CodeLine lineNumber="249"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00250" /><CodeLine lineNumber="250" lineLink="/docs/api/classes/llvm/placesafepointspass/#adcb87ee7d8b9f08bc82da9cae1c74429"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/placesafepointspass/#adcb87ee7d8b9f08bc82da9cae1c74429">PlaceSafepointsPass::runImpl</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/targetlibraryinfo">TargetLibraryInfo</a> &amp;TLI) &#123;</Highlight></CodeLine>
<Link id="l00251" /><CodeLine lineNumber="251"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.isDeclaration() || <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.empty()) &#123;</Highlight></CodeLine>
<Link id="l00252" /><CodeLine lineNumber="252"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// This is a declaration, nothing to do.  Must exit early to avoid crash in</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00253" /><CodeLine lineNumber="253"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// dom tree calculation</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00254" /><CodeLine lineNumber="254"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00255" /><CodeLine lineNumber="255"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00256" /><CodeLine lineNumber="256"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00257" /><CodeLine lineNumber="257"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#a61ab641b03f16e1f3ad916913ce89903">isGCSafepointPoll</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>)) &#123;</Highlight></CodeLine>
<Link id="l00258" /><CodeLine lineNumber="258"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Given we&#39;re inlining this inside of safepoint poll insertion, this</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00259" /><CodeLine lineNumber="259"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// doesn&#39;t make any sense.  Note that we do make any contained calls</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00260" /><CodeLine lineNumber="260"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// parseable after we inline a poll.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00261" /><CodeLine lineNumber="261"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00262" /><CodeLine lineNumber="262"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00263" /><CodeLine lineNumber="263"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00264" /><CodeLine lineNumber="264"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="#a737f3181d1ae8ed5fe159b4003d024d1">shouldRewriteFunction</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>))</Highlight></CodeLine>
<Link id="l00265" /><CodeLine lineNumber="265"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00266" /><CodeLine lineNumber="266"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00267" /><CodeLine lineNumber="267"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/loopdeletion-cpp/#a0f1c83c3d08d80b12c424962a5e94ce8a35e0c8c0b180c95d4e122e55ed62cc64">Modified</a> = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00268" /><CodeLine lineNumber="268"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00269" /><CodeLine lineNumber="269"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// In various bits below, we rely on the fact that uses are reachable from</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00270" /><CodeLine lineNumber="270"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// defs.  When there are basic blocks unreachable from the entry, dominance</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00271" /><CodeLine lineNumber="271"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// and reachablity queries return non-sensical results.  Thus, we preprocess</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00272" /><CodeLine lineNumber="272"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the function to ensure these properties hold.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00273" /><CodeLine lineNumber="273"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/loopdeletion-cpp/#a0f1c83c3d08d80b12c424962a5e94ce8a35e0c8c0b180c95d4e122e55ed62cc64">Modified</a> |= <a href="/docs/api/namespaces/llvm/#aec88b7682025edff7984c3b6c8da8ac9">removeUnreachableBlocks</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</Highlight></CodeLine>
<Link id="l00274" /><CodeLine lineNumber="274"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00275" /><CodeLine lineNumber="275"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// STEP 1 - Insert the safepoint polling locations.  We do not need to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00276" /><CodeLine lineNumber="276"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// actually insert parse points yet.  That will be done for all polls and</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00277" /><CodeLine lineNumber="277"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// calls in a single pass.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00278" /><CodeLine lineNumber="278"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00279" /><CodeLine lineNumber="279"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> DT;</Highlight></CodeLine>
<Link id="l00280" /><CodeLine lineNumber="280"><Highlight kind="normal">  DT.<a href="/docs/api/classes/llvm/dominatortreebase/#aa0641ae965656ff9988d67a35140e4d9">recalculate</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</Highlight></CodeLine>
<Link id="l00281" /><CodeLine lineNumber="281"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00282" /><CodeLine lineNumber="282"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Instruction &#42;, 16&gt;</a> PollsNeeded;</Highlight></CodeLine>
<Link id="l00283" /><CodeLine lineNumber="283"><Highlight kind="normal">  std::vector&lt;CallBase &#42;&gt; ParsePointNeeded;</Highlight></CodeLine>
<Link id="l00284" /><CodeLine lineNumber="284"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00285" /><CodeLine lineNumber="285"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#ade6d0f7cc42acd42e21c6154bd713afa">enableBackedgeSafepoints</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>)) &#123;</Highlight></CodeLine>
<Link id="l00286" /><CodeLine lineNumber="286"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Construct a pass manager to run the LoopPass backedge logic.  We</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00287" /><CodeLine lineNumber="287"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// need the pass manager to handle scheduling all the loop passes</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00288" /><CodeLine lineNumber="288"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// appropriately.  Doing this by hand is painful and just not worth messing</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00289" /><CodeLine lineNumber="289"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// with for the moment.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00290" /><CodeLine lineNumber="290"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/legacy/functionpassmanager">legacy::FunctionPassManager</a> FPM(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getParent());</Highlight></CodeLine>
<Link id="l00291" /><CodeLine lineNumber="291"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> CanAssumeCallSafepoints = <a href="#a3a3b930c659333a27bb598ea5960fe52">enableCallSafepoints</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</Highlight></CodeLine>
<Link id="l00292" /><CodeLine lineNumber="292"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00293" /><CodeLine lineNumber="293"><Highlight kind="normal">    FPM.<a href="/docs/api/classes/llvm/legacy/functionpassmanager/#a1bec72c759c38b748ff60434eb4d0c80">add</a>(</Highlight><Highlight kind="keyword">new</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/targetlibraryinfowrapperpass">TargetLibraryInfoWrapperPass</a>(TLI));</Highlight></CodeLine>
<Link id="l00294" /><CodeLine lineNumber="294"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;PBS = </Highlight><Highlight kind="keyword">new</Highlight><Highlight kind="normal"> PlaceBackedgeSafepointsLegacyPass(CanAssumeCallSafepoints);</Highlight></CodeLine>
<Link id="l00295" /><CodeLine lineNumber="295"><Highlight kind="normal">    FPM.<a href="/docs/api/classes/llvm/legacy/functionpassmanager/#a1bec72c759c38b748ff60434eb4d0c80">add</a>(PBS);</Highlight></CodeLine>
<Link id="l00296" /><CodeLine lineNumber="296"><Highlight kind="normal">    FPM.<a href="/docs/api/classes/llvm/legacy/functionpassmanager/#a02e592cc8ca8a049fbe052f809514c73">run</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</Highlight></CodeLine>
<Link id="l00297" /><CodeLine lineNumber="297"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00298" /><CodeLine lineNumber="298"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We preserve dominance information when inserting the poll, otherwise</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00299" /><CodeLine lineNumber="299"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// we&#39;d have to recalculate this on every insert</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00300" /><CodeLine lineNumber="300"><Highlight kind="normal">    DT.<a href="/docs/api/classes/llvm/dominatortreebase/#aa0641ae965656ff9988d67a35140e4d9">recalculate</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</Highlight></CodeLine>
<Link id="l00301" /><CodeLine lineNumber="301"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00302" /><CodeLine lineNumber="302"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;PollLocations = PBS-&gt;PollLocations;</Highlight></CodeLine>
<Link id="l00303" /><CodeLine lineNumber="303"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00304" /><CodeLine lineNumber="304"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> OrderByBBName = &#91;&#93;(<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;a, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;b) &#123;</Highlight></CodeLine>
<Link id="l00305" /><CodeLine lineNumber="305"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> a-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>()-&gt;getName() &lt; b-&gt;getParent()-&gt;getName();</Highlight></CodeLine>
<Link id="l00306" /><CodeLine lineNumber="306"><Highlight kind="normal">    &#125;;</Highlight></CodeLine>
<Link id="l00307" /><CodeLine lineNumber="307"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We need the order of list to be stable so that naming ends up stable</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00308" /><CodeLine lineNumber="308"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// when we split edges.  This makes test cases much easier to write.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00309" /><CodeLine lineNumber="309"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a74cdbd1e4f731e7d7cd83461b8b1de0b">llvm::sort</a>(PollLocations, OrderByBBName);</Highlight></CodeLine>
<Link id="l00310" /><CodeLine lineNumber="310"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00311" /><CodeLine lineNumber="311"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We can sometimes end up with duplicate poll locations.  This happens if</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00312" /><CodeLine lineNumber="312"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// a single loop is visited more than once.   The fact this happens seems</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00313" /><CodeLine lineNumber="313"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// wrong, but it does happen for the split-backedge.ll test case.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00314" /><CodeLine lineNumber="314"><Highlight kind="normal">    PollLocations.erase(<a href="/docs/api/namespaces/llvm/#a48f85da577c6ce7d9aed90437dc0d07c">llvm::unique</a>(PollLocations), PollLocations.end());</Highlight></CodeLine>
<Link id="l00315" /><CodeLine lineNumber="315"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00316" /><CodeLine lineNumber="316"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Insert a poll at each point the analysis pass identified</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00317" /><CodeLine lineNumber="317"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// The poll location must be the terminator of a loop latch block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00318" /><CodeLine lineNumber="318"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Term : PollLocations) &#123;</Highlight></CodeLine>
<Link id="l00319" /><CodeLine lineNumber="319"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We are inserting a poll, the function is modified</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00320" /><CodeLine lineNumber="320"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/loopdeletion-cpp/#a0f1c83c3d08d80b12c424962a5e94ce8a35e0c8c0b180c95d4e122e55ed62cc64">Modified</a> = </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00321" /><CodeLine lineNumber="321"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00322" /><CodeLine lineNumber="322"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#a903a0c956da2425ebdf39f8995f2a900">SplitBackedge</a>) &#123;</Highlight></CodeLine>
<Link id="l00323" /><CodeLine lineNumber="323"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Split the backedge of the loop and insert the poll within that new</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00324" /><CodeLine lineNumber="324"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// basic block.  This creates a loop with two latches per original</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00325" /><CodeLine lineNumber="325"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// latch (which is non-ideal), but this appears to be easier to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00326" /><CodeLine lineNumber="326"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// optimize in practice than inserting the poll immediately before the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00327" /><CodeLine lineNumber="327"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// latch test.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00328" /><CodeLine lineNumber="328"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00329" /><CodeLine lineNumber="329"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Since this is a latch, at least one of the successors must dominate</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00330" /><CodeLine lineNumber="330"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// it. Its possible that we have a) duplicate edges to the same header</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00331" /><CodeLine lineNumber="331"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// and b) edges to distinct loop headers.  We need to insert pools on</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00332" /><CodeLine lineNumber="332"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// each.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00333" /><CodeLine lineNumber="333"><Highlight kind="normal">        <a href="/docs/api/classes/llvm/setvector">SetVector&lt;BasicBlock &#42;&gt;</a> Headers;</Highlight></CodeLine>
<Link id="l00334" /><CodeLine lineNumber="334"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Succ : <a href="/docs/api/namespaces/llvm/#a26e2a938b431eaa6eca2beaa96410c9d">successors</a>(Term-&gt;getParent()))</Highlight></CodeLine>
<Link id="l00335" /><CodeLine lineNumber="335"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DT.<a href="/docs/api/classes/llvm/dominatortree/#a5c69311e8d44898dac36a155c3d8691d">dominates</a>(Succ, Term-&gt;getParent()))</Highlight></CodeLine>
<Link id="l00336" /><CodeLine lineNumber="336"><Highlight kind="normal">            Headers.<a href="/docs/api/classes/llvm/setvector/#af34eb71cc483e84d2eca80575cb9ccde">insert</a>(Succ);</Highlight></CodeLine>
<Link id="l00337" /><CodeLine lineNumber="337"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!Headers.<a href="/docs/api/classes/llvm/setvector/#ac178f4fc4e4a0642610c374256b9fb27">empty</a>() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;poll location is not a loop latch?&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00338" /><CodeLine lineNumber="338"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00339" /><CodeLine lineNumber="339"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// The split loop structure here is so that we only need to recalculate</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00340" /><CodeLine lineNumber="340"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// the dominator tree once.  Alternatively, we could just keep it up to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00341" /><CodeLine lineNumber="341"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// date and use a more natural merged loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00342" /><CodeLine lineNumber="342"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Header : Headers) &#123;</Highlight></CodeLine>
<Link id="l00343" /><CodeLine lineNumber="343"><Highlight kind="normal">          <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewBB = <a href="/docs/api/namespaces/llvm/#adf83581f514774264d616eef5706cf6e">SplitEdge</a>(Term-&gt;getParent(), Header, &amp;DT);</Highlight></CodeLine>
<Link id="l00344" /><CodeLine lineNumber="344"><Highlight kind="normal">          PollsNeeded.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(NewBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l00345" /><CodeLine lineNumber="345"><Highlight kind="normal">          NumBackedgeSafepoints++;</Highlight></CodeLine>
<Link id="l00346" /><CodeLine lineNumber="346"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l00347" /><CodeLine lineNumber="347"><Highlight kind="normal">      &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00348" /><CodeLine lineNumber="348"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Split the latch block itself, right before the terminator.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00349" /><CodeLine lineNumber="349"><Highlight kind="normal">        PollsNeeded.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(Term);</Highlight></CodeLine>
<Link id="l00350" /><CodeLine lineNumber="350"><Highlight kind="normal">        NumBackedgeSafepoints++;</Highlight></CodeLine>
<Link id="l00351" /><CodeLine lineNumber="351"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00352" /><CodeLine lineNumber="352"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00353" /><CodeLine lineNumber="353"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00354" /><CodeLine lineNumber="354"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00355" /><CodeLine lineNumber="355"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#a4021e064e9d2a5e5762d1d4a1dcd7db9">enableEntrySafepoints</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>)) &#123;</Highlight></CodeLine>
<Link id="l00356" /><CodeLine lineNumber="356"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Location = <a href="#a893c7586e2537bc37a83a57a0190f67f">findLocationForEntrySafepoint</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, DT)) &#123;</Highlight></CodeLine>
<Link id="l00357" /><CodeLine lineNumber="357"><Highlight kind="normal">      PollsNeeded.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(Location);</Highlight></CodeLine>
<Link id="l00358" /><CodeLine lineNumber="358"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/loopdeletion-cpp/#a0f1c83c3d08d80b12c424962a5e94ce8a35e0c8c0b180c95d4e122e55ed62cc64">Modified</a> = </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00359" /><CodeLine lineNumber="359"><Highlight kind="normal">      NumEntrySafepoints++;</Highlight></CodeLine>
<Link id="l00360" /><CodeLine lineNumber="360"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00361" /><CodeLine lineNumber="361"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// TODO: else we should assert that there was, in fact, a policy choice to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00362" /><CodeLine lineNumber="362"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// not insert a entry safepoint poll.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00363" /><CodeLine lineNumber="363"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00364" /><CodeLine lineNumber="364"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00365" /><CodeLine lineNumber="365"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now that we&#39;ve identified all the needed safepoint poll locations, insert</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00366" /><CodeLine lineNumber="366"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// safepoint polls themselves.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00367" /><CodeLine lineNumber="367"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;PollLocation : PollsNeeded) &#123;</Highlight></CodeLine>
<Link id="l00368" /><CodeLine lineNumber="368"><Highlight kind="normal">    std::vector&lt;CallBase &#42;&gt; RuntimeCalls;</Highlight></CodeLine>
<Link id="l00369" /><CodeLine lineNumber="369"><Highlight kind="normal">    <a href="#a05dd87a2da7ddff8ce97716e3b479b2e">InsertSafepointPoll</a>(PollLocation-&gt;getIterator(), RuntimeCalls, TLI);</Highlight></CodeLine>
<Link id="l00370" /><CodeLine lineNumber="370"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a39d3d23a084c4544ee5903203db10e8a">llvm::append&#95;range</a>(ParsePointNeeded, RuntimeCalls);</Highlight></CodeLine>
<Link id="l00371" /><CodeLine lineNumber="371"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00372" /><CodeLine lineNumber="372"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00373" /><CodeLine lineNumber="373"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/loopdeletion-cpp/#a0f1c83c3d08d80b12c424962a5e94ce8a35e0c8c0b180c95d4e122e55ed62cc64">Modified</a>;</Highlight></CodeLine>
<Link id="l00374" /><CodeLine lineNumber="374"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00375" /><CodeLine lineNumber="375"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00376" /><CodeLine lineNumber="376" lineLink="/docs/api/classes/llvm/placesafepointspass/#a4c1a6d3206d9f1278836bdc314e56141"><Highlight kind="normal"><a href="/docs/api/classes/llvm/preservedanalyses">PreservedAnalyses</a> <a href="/docs/api/classes/llvm/placesafepointspass/#a4c1a6d3206d9f1278836bdc314e56141">PlaceSafepointsPass::run</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>,</Highlight></CodeLine>
<Link id="l00377" /><CodeLine lineNumber="377"><Highlight kind="normal">                                           <a href="/docs/api/namespaces/llvm/#adce09a5a0de0e3177eb00e932734af2f">FunctionAnalysisManager</a> &amp;AM) &#123;</Highlight></CodeLine>
<Link id="l00378" /><CodeLine lineNumber="378"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;TLI = AM.<a href="/docs/api/classes/llvm/analysismanager/#aaab1fad63e4f3b8679469720a873fedd">getResult</a>&lt;<a href="/docs/api/classes/llvm/targetlibraryanalysis">TargetLibraryAnalysis</a>&gt;(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</Highlight></CodeLine>
<Link id="l00379" /><CodeLine lineNumber="379"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00380" /><CodeLine lineNumber="380"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/classes/llvm/placesafepointspass/#adcb87ee7d8b9f08bc82da9cae1c74429">runImpl</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, TLI))</Highlight></CodeLine>
<Link id="l00381" /><CodeLine lineNumber="381"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/preservedanalyses/#a1258a1ff55557c27684010ebd7283712">PreservedAnalyses::all</a>();</Highlight></CodeLine>
<Link id="l00382" /><CodeLine lineNumber="382"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00383" /><CodeLine lineNumber="383"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// TODO: can we preserve more?</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00384" /><CodeLine lineNumber="384"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/preservedanalyses/#a03797a73044a81cbc6a3409d6c72ee8f">PreservedAnalyses::none</a>();</Highlight></CodeLine>
<Link id="l00385" /><CodeLine lineNumber="385"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00386" /><CodeLine lineNumber="386"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00387" /><CodeLine lineNumber="387" lineLink="#a798de004bec543c0f9059f8c5fc78f92"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a798de004bec543c0f9059f8c5fc78f92">needsStatepoint</a>(<a href="/docs/api/classes/llvm/callbase">CallBase</a> &#42;<a href="/docs/api/groups/arcopt/#ga9c9cf6ad55eb23d77d083a184e416c09">Call</a>, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/targetlibraryinfo">TargetLibraryInfo</a> &amp;TLI) &#123;</Highlight></CodeLine>
<Link id="l00388" /><CodeLine lineNumber="388"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#af75ecbb2ce891821d146a047f17d4dd1">callsGCLeafFunction</a>(<a href="/docs/api/groups/arcopt/#ga9c9cf6ad55eb23d77d083a184e416c09">Call</a>, TLI))</Highlight></CodeLine>
<Link id="l00389" /><CodeLine lineNumber="389"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00390" /><CodeLine lineNumber="390"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;CI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CallInst&gt;</a>(<a href="/docs/api/groups/arcopt/#ga9c9cf6ad55eb23d77d083a184e416c09">Call</a>)) &#123;</Highlight></CodeLine>
<Link id="l00391" /><CodeLine lineNumber="391"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (CI-&gt;isInlineAsm())</Highlight></CodeLine>
<Link id="l00392" /><CodeLine lineNumber="392"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00393" /><CodeLine lineNumber="393"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00394" /><CodeLine lineNumber="394"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00395" /><CodeLine lineNumber="395"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> !(<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;GCStatepointInst&gt;</a>(<a href="/docs/api/groups/arcopt/#ga9c9cf6ad55eb23d77d083a184e416c09">Call</a>) || <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;GCRelocateInst&gt;</a>(<a href="/docs/api/groups/arcopt/#ga9c9cf6ad55eb23d77d083a184e416c09">Call</a>) ||</Highlight></CodeLine>
<Link id="l00396" /><CodeLine lineNumber="396"><Highlight kind="normal">           <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;GCResultInst&gt;</a>(<a href="/docs/api/groups/arcopt/#ga9c9cf6ad55eb23d77d083a184e416c09">Call</a>));</Highlight></CodeLine>
<Link id="l00397" /><CodeLine lineNumber="397"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00398" /><CodeLine lineNumber="398"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00399" /><CodeLine lineNumber="399"><Highlight kind="comment">/// Returns true if this loop is known to contain a call safepoint which</Highlight></CodeLine>
<Link id="l00400" /><CodeLine lineNumber="400"><Highlight kind="comment">/// must unconditionally execute on any iteration of the loop which returns</Highlight></CodeLine>
<Link id="l00401" /><CodeLine lineNumber="401"><Highlight kind="comment">/// to the loop header via an edge from Pred.  Returns a conservative correct</Highlight></CodeLine>
<Link id="l00402" /><CodeLine lineNumber="402"><Highlight kind="comment">/// answer; i.e. false is always valid.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00403" /><CodeLine lineNumber="403" lineLink="#aa2cbc07e426705bbdb98c0f6ae7e3f72"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#aa2cbc07e426705bbdb98c0f6ae7e3f72">containsUnconditionalCallSafepoint</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Header,</Highlight></CodeLine>
<Link id="l00404" /><CodeLine lineNumber="404"><Highlight kind="normal">                                               <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Pred,</Highlight></CodeLine>
<Link id="l00405" /><CodeLine lineNumber="405"><Highlight kind="normal">                                               <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT,</Highlight></CodeLine>
<Link id="l00406" /><CodeLine lineNumber="406"><Highlight kind="normal">                                               </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/targetlibraryinfo">TargetLibraryInfo</a> &amp;TLI) &#123;</Highlight></CodeLine>
<Link id="l00407" /><CodeLine lineNumber="407"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// In general, we&#39;re looking for any cut of the graph which ensures</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00408" /><CodeLine lineNumber="408"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// there&#39;s a call safepoint along every edge between Header and Pred.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00409" /><CodeLine lineNumber="409"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// For the moment, we look only for the &#39;cuts&#39; that consist of a single call</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00410" /><CodeLine lineNumber="410"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// instruction in a block which is dominated by the Header and dominates the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00411" /><CodeLine lineNumber="411"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// loop latch (Pred) block.  Somewhat surprisingly, walking the entire chain</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00412" /><CodeLine lineNumber="412"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// of such dominating blocks gets substantially more occurrences than just</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00413" /><CodeLine lineNumber="413"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// checking the Pred and Header blocks themselves.  This may be due to the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00414" /><CodeLine lineNumber="414"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// density of loop exit conditions caused by range and null checks.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00415" /><CodeLine lineNumber="415"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// TODO: structure this as an analysis pass, cache the result for subloops,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00416" /><CodeLine lineNumber="416"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// avoid dom tree recalculations</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00417" /><CodeLine lineNumber="417"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(DT.<a href="/docs/api/classes/llvm/dominatortree/#a5c69311e8d44898dac36a155c3d8691d">dominates</a>(Header, Pred) &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;loop latch not dominated by header?&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00418" /><CodeLine lineNumber="418"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00419" /><CodeLine lineNumber="419"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Current = Pred;</Highlight></CodeLine>
<Link id="l00420" /><CodeLine lineNumber="420"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">) &#123;</Highlight></CodeLine>
<Link id="l00421" /><CodeLine lineNumber="421"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : &#42;Current) &#123;</Highlight></CodeLine>
<Link id="l00422" /><CodeLine lineNumber="422"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;<a href="/docs/api/groups/arcopt/#ga9c9cf6ad55eb23d77d083a184e416c09">Call</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CallBase&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</Highlight></CodeLine>
<Link id="l00423" /><CodeLine lineNumber="423"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Note: Technically, needing a safepoint isn&#39;t quite the right</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00424" /><CodeLine lineNumber="424"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// condition here.  We should instead be checking if the target method</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00425" /><CodeLine lineNumber="425"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// has an</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00426" /><CodeLine lineNumber="426"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// unconditional poll. In practice, this is only a theoretical concern</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00427" /><CodeLine lineNumber="427"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// since we don&#39;t have any methods with conditional-only safepoint</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00428" /><CodeLine lineNumber="428"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// polls.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00429" /><CodeLine lineNumber="429"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#a798de004bec543c0f9059f8c5fc78f92">needsStatepoint</a>(<a href="/docs/api/groups/arcopt/#ga9c9cf6ad55eb23d77d083a184e416c09">Call</a>, TLI))</Highlight></CodeLine>
<Link id="l00430" /><CodeLine lineNumber="430"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00431" /><CodeLine lineNumber="431"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00432" /><CodeLine lineNumber="432"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00433" /><CodeLine lineNumber="433"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Current == Header)</Highlight></CodeLine>
<Link id="l00434" /><CodeLine lineNumber="434"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">break</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00435" /><CodeLine lineNumber="435"><Highlight kind="normal">    Current = DT.<a href="/docs/api/classes/llvm/dominatortreebase/#ad8295b9b507d1d847cd46856f8255eab">getNode</a>(Current)-&gt;<a href="/docs/api/classes/llvm/domtreenodebase/#a453de62c2dadf7b4b8df04e89f6ab4e0">getIDom</a>()-&gt;<a href="/docs/api/classes/llvm/domtreenodebase/#aab2bf365c9f4b976adc7479576dfd5bb">getBlock</a>();</Highlight></CodeLine>
<Link id="l00436" /><CodeLine lineNumber="436"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00437" /><CodeLine lineNumber="437"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00438" /><CodeLine lineNumber="438"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00439" /><CodeLine lineNumber="439"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00440" /><CodeLine lineNumber="440"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00441" /><CodeLine lineNumber="441"><Highlight kind="comment">/// Returns true if this loop is known to terminate in a finite number of</Highlight></CodeLine>
<Link id="l00442" /><CodeLine lineNumber="442"><Highlight kind="comment">/// iterations.  Note that this function may return false for a loop which</Highlight></CodeLine>
<Link id="l00443" /><CodeLine lineNumber="443"><Highlight kind="comment">/// does actual terminate in a finite constant number of iterations due to</Highlight></CodeLine>
<Link id="l00444" /><CodeLine lineNumber="444"><Highlight kind="comment">/// conservatism in the analysis.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00445" /><CodeLine lineNumber="445" lineLink="#a2003053288ba4f0e1cd9ebf82b6a1987"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a2003053288ba4f0e1cd9ebf82b6a1987">mustBeFiniteCountedLoop</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42;SE,</Highlight></CodeLine>
<Link id="l00446" /><CodeLine lineNumber="446"><Highlight kind="normal">                                    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Pred) &#123;</Highlight></CodeLine>
<Link id="l00447" /><CodeLine lineNumber="447"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// A conservative bound on the loop as a whole.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00448" /><CodeLine lineNumber="448"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;MaxTrips = SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a0182f006bb2ae6411c2111427d58f242">getConstantMaxBackedgeTakenCount</a>(L);</Highlight></CodeLine>
<Link id="l00449" /><CodeLine lineNumber="449"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;SCEVCouldNotCompute&gt;</a>(MaxTrips) &amp;&amp;</Highlight></CodeLine>
<Link id="l00450" /><CodeLine lineNumber="450"><Highlight kind="normal">      SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a7593d52f91ebe342de9fa72846ebe755">getUnsignedRange</a>(MaxTrips).<a href="/docs/api/classes/llvm/constantrange/#ab7f67c2ed8b2799c64ec64ca31d75c60">getUnsignedMax</a>().<a href="/docs/api/classes/llvm/apint/#ae00c35cb040107c05f3fe00c15bb3da0">isIntN</a>(</Highlight></CodeLine>
<Link id="l00451" /><CodeLine lineNumber="451"><Highlight kind="normal">          <a href="#af19488cdbe65bf6c4cc7ff922bdab375">CountedLoopTripWidth</a>))</Highlight></CodeLine>
<Link id="l00452" /><CodeLine lineNumber="452"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00453" /><CodeLine lineNumber="453"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00454" /><CodeLine lineNumber="454"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If this is a conditional branch to the header with the alternate path</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00455" /><CodeLine lineNumber="455"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// being outside the loop, we can ask questions about the execution frequency</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00456" /><CodeLine lineNumber="456"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// of the exit block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00457" /><CodeLine lineNumber="457"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L-&gt;isLoopExiting(Pred)) &#123;</Highlight></CodeLine>
<Link id="l00458" /><CodeLine lineNumber="458"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// This returns an exact expression only.  TODO: We really only need an</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00459" /><CodeLine lineNumber="459"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// upper bound here, but SE doesn&#39;t expose that.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00460" /><CodeLine lineNumber="460"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;MaxExec = SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#ab24add5df0874cdfa47b47b1d9926e9e">getExitCount</a>(L, Pred);</Highlight></CodeLine>
<Link id="l00461" /><CodeLine lineNumber="461"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;SCEVCouldNotCompute&gt;</a>(MaxExec) &amp;&amp;</Highlight></CodeLine>
<Link id="l00462" /><CodeLine lineNumber="462"><Highlight kind="normal">        SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a7593d52f91ebe342de9fa72846ebe755">getUnsignedRange</a>(MaxExec).<a href="/docs/api/classes/llvm/constantrange/#ab7f67c2ed8b2799c64ec64ca31d75c60">getUnsignedMax</a>().<a href="/docs/api/classes/llvm/apint/#ae00c35cb040107c05f3fe00c15bb3da0">isIntN</a>(</Highlight></CodeLine>
<Link id="l00463" /><CodeLine lineNumber="463"><Highlight kind="normal">            <a href="#af19488cdbe65bf6c4cc7ff922bdab375">CountedLoopTripWidth</a>))</Highlight></CodeLine>
<Link id="l00464" /><CodeLine lineNumber="464"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00465" /><CodeLine lineNumber="465"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00466" /><CodeLine lineNumber="466"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00467" /><CodeLine lineNumber="467"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="comment">/&#42; not finite &#42;/</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00468" /><CodeLine lineNumber="468"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00469" /><CodeLine lineNumber="469"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00470" /><CodeLine lineNumber="470" lineLink="#afe210701ce0a3abfea9278d2538a6470"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#afe210701ce0a3abfea9278d2538a6470">scanOneBB</a>(<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Start, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;End,</Highlight></CodeLine>
<Link id="l00471" /><CodeLine lineNumber="471"><Highlight kind="normal">                      std::vector&lt;CallInst &#42;&gt; &amp;Calls,</Highlight></CodeLine>
<Link id="l00472" /><CodeLine lineNumber="472"><Highlight kind="normal">                      <a href="/docs/api/classes/llvm/denseset">DenseSet&lt;BasicBlock &#42;&gt;</a> &amp;Seen,</Highlight></CodeLine>
<Link id="l00473" /><CodeLine lineNumber="473"><Highlight kind="normal">                      std::vector&lt;BasicBlock &#42;&gt; &amp;Worklist) &#123;</Highlight></CodeLine>
<Link id="l00474" /><CodeLine lineNumber="474"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> BBI(Start), BBE0 = Start-&gt;getParent()-&gt;end(),</Highlight></CodeLine>
<Link id="l00475" /><CodeLine lineNumber="475"><Highlight kind="normal">                                        BBE1 = <a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a>(End);</Highlight></CodeLine>
<Link id="l00476" /><CodeLine lineNumber="476"><Highlight kind="normal">       BBI != BBE0 &amp;&amp; BBI != BBE1; BBI++) &#123;</Highlight></CodeLine>
<Link id="l00477" /><CodeLine lineNumber="477"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42;CI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CallInst&gt;</a>(&amp;&#42;BBI))</Highlight></CodeLine>
<Link id="l00478" /><CodeLine lineNumber="478"><Highlight kind="normal">      Calls.push&#95;back(CI);</Highlight></CodeLine>
<Link id="l00479" /><CodeLine lineNumber="479"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00480" /><CodeLine lineNumber="480"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// FIXME: This code does not handle invokes</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00481" /><CodeLine lineNumber="481"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;InvokeInst&gt;</a>(&amp;&#42;BBI) &amp;&amp;</Highlight></CodeLine>
<Link id="l00482" /><CodeLine lineNumber="482"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;support for invokes in poll code needed&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00483" /><CodeLine lineNumber="483"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00484" /><CodeLine lineNumber="484"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Only add the successor blocks if we reach the terminator instruction</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00485" /><CodeLine lineNumber="485"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// without encountering end first</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00486" /><CodeLine lineNumber="486"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BBI-&gt;isTerminator()) &#123;</Highlight></CodeLine>
<Link id="l00487" /><CodeLine lineNumber="487"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB = BBI-&gt;<a href="/docs/api/classes/llvm/basicblock/#a1b4bf7c97cdc8159fd73d48063f0b250">getParent</a>();</Highlight></CodeLine>
<Link id="l00488" /><CodeLine lineNumber="488"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Succ : <a href="/docs/api/namespaces/llvm/#a26e2a938b431eaa6eca2beaa96410c9d">successors</a>(BB)) &#123;</Highlight></CodeLine>
<Link id="l00489" /><CodeLine lineNumber="489"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Seen.<a href="/docs/api/classes/llvm/detail/densesetimpl/#a1b0f3ebdced8fce4b22c6a63b25d9525">insert</a>(Succ).second) &#123;</Highlight></CodeLine>
<Link id="l00490" /><CodeLine lineNumber="490"><Highlight kind="normal">          Worklist.push&#95;back(Succ);</Highlight></CodeLine>
<Link id="l00491" /><CodeLine lineNumber="491"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l00492" /><CodeLine lineNumber="492"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00493" /><CodeLine lineNumber="493"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00494" /><CodeLine lineNumber="494"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00495" /><CodeLine lineNumber="495"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00496" /><CodeLine lineNumber="496"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00497" /><CodeLine lineNumber="497" lineLink="#a826d7a5a20d56ef31ee4111073700c93"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#a826d7a5a20d56ef31ee4111073700c93">scanInlinedCode</a>(<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Start, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;End,</Highlight></CodeLine>
<Link id="l00498" /><CodeLine lineNumber="498"><Highlight kind="normal">                            std::vector&lt;CallInst &#42;&gt; &amp;Calls,</Highlight></CodeLine>
<Link id="l00499" /><CodeLine lineNumber="499"><Highlight kind="normal">                            <a href="/docs/api/classes/llvm/denseset">DenseSet&lt;BasicBlock &#42;&gt;</a> &amp;Seen) &#123;</Highlight></CodeLine>
<Link id="l00500" /><CodeLine lineNumber="500"><Highlight kind="normal">  Calls.clear();</Highlight></CodeLine>
<Link id="l00501" /><CodeLine lineNumber="501"><Highlight kind="normal">  std::vector&lt;BasicBlock &#42;&gt; Worklist;</Highlight></CodeLine>
<Link id="l00502" /><CodeLine lineNumber="502"><Highlight kind="normal">  Seen.<a href="/docs/api/classes/llvm/detail/densesetimpl/#a1b0f3ebdced8fce4b22c6a63b25d9525">insert</a>(Start-&gt;getParent());</Highlight></CodeLine>
<Link id="l00503" /><CodeLine lineNumber="503"><Highlight kind="normal">  <a href="#afe210701ce0a3abfea9278d2538a6470">scanOneBB</a>(Start, End, Calls, Seen, Worklist);</Highlight></CodeLine>
<Link id="l00504" /><CodeLine lineNumber="504"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (!Worklist.empty()) &#123;</Highlight></CodeLine>
<Link id="l00505" /><CodeLine lineNumber="505"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB = Worklist.back();</Highlight></CodeLine>
<Link id="l00506" /><CodeLine lineNumber="506"><Highlight kind="normal">    Worklist.pop&#95;back();</Highlight></CodeLine>
<Link id="l00507" /><CodeLine lineNumber="507"><Highlight kind="normal">    <a href="#afe210701ce0a3abfea9278d2538a6470">scanOneBB</a>(&amp;&#42;BB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a0ed5f3ab3c2e4196ee0cffffa080c062">begin</a>(), End, Calls, Seen, Worklist);</Highlight></CodeLine>
<Link id="l00508" /><CodeLine lineNumber="508"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00509" /><CodeLine lineNumber="509"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00510" /><CodeLine lineNumber="510"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00511" /><CodeLine lineNumber="511"><Highlight kind="comment">/// Returns true if an entry safepoint is not required before this callsite in</Highlight></CodeLine>
<Link id="l00512" /><CodeLine lineNumber="512"><Highlight kind="comment">/// the caller function.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00513" /><CodeLine lineNumber="513" lineLink="#ab79294a2bb06a12d7f4dc32f80b8f935"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#ab79294a2bb06a12d7f4dc32f80b8f935">doesNotRequireEntrySafepointBefore</a>(<a href="/docs/api/classes/llvm/callbase">CallBase</a> &#42;<a href="/docs/api/groups/arcopt/#ga9c9cf6ad55eb23d77d083a184e416c09">Call</a>) &#123;</Highlight></CodeLine>
<Link id="l00514" /><CodeLine lineNumber="514"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/intrinsicinst">IntrinsicInst</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;IntrinsicInst&gt;</a>(<a href="/docs/api/groups/arcopt/#ga9c9cf6ad55eb23d77d083a184e416c09">Call</a>)) &#123;</Highlight></CodeLine>
<Link id="l00515" /><CodeLine lineNumber="515"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">switch</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a>-&gt;getIntrinsicID()) &#123;</Highlight></CodeLine>
<Link id="l00516" /><CodeLine lineNumber="516"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> Intrinsic::experimental&#95;gc&#95;statepoint:</Highlight></CodeLine>
<Link id="l00517" /><CodeLine lineNumber="517"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> Intrinsic::experimental&#95;patchpoint&#95;void:</Highlight></CodeLine>
<Link id="l00518" /><CodeLine lineNumber="518"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> Intrinsic::experimental&#95;patchpoint:</Highlight></CodeLine>
<Link id="l00519" /><CodeLine lineNumber="519"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// The can wrap an actual call which may grow the stack by an unbounded</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00520" /><CodeLine lineNumber="520"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// amount or run forever.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00521" /><CodeLine lineNumber="521"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00522" /><CodeLine lineNumber="522"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">default</Highlight><Highlight kind="normal">:</Highlight></CodeLine>
<Link id="l00523" /><CodeLine lineNumber="523"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Most LLVM intrinsics are things which do not expand to actual calls, or</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00524" /><CodeLine lineNumber="524"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// at least if they do, are leaf functions that cause only finite stack</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00525" /><CodeLine lineNumber="525"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// growth.  In particular, the optimizer likes to form things like memsets</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00526" /><CodeLine lineNumber="526"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// out of stores in the original IR.  Another important example is</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00527" /><CodeLine lineNumber="527"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// llvm.localescape which must occur in the entry block.  Inserting a</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00528" /><CodeLine lineNumber="528"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// safepoint before it is not legal since it could push the localescape</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00529" /><CodeLine lineNumber="529"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// out of the entry block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00530" /><CodeLine lineNumber="530"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00531" /><CodeLine lineNumber="531"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00532" /><CodeLine lineNumber="532"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00533" /><CodeLine lineNumber="533"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00534" /><CodeLine lineNumber="534"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00535" /><CodeLine lineNumber="535"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00536" /><CodeLine lineNumber="536" lineLink="#a893c7586e2537bc37a83a57a0190f67f"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="#a893c7586e2537bc37a83a57a0190f67f">findLocationForEntrySafepoint</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>,</Highlight></CodeLine>
<Link id="l00537" /><CodeLine lineNumber="537"><Highlight kind="normal">                                                  <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT) &#123;</Highlight></CodeLine>
<Link id="l00538" /><CodeLine lineNumber="538"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00539" /><CodeLine lineNumber="539"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Conceptually, this poll needs to be on method entry, but in</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00540" /><CodeLine lineNumber="540"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// practice, we place it as late in the entry block as possible.  We</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00541" /><CodeLine lineNumber="541"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// can place it as late as we want as long as it dominates all calls</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00542" /><CodeLine lineNumber="542"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// that can grow the stack.  This, combined with backedge polls,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00543" /><CodeLine lineNumber="543"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// give us all the progress guarantees we need.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00544" /><CodeLine lineNumber="544"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00545" /><CodeLine lineNumber="545"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// hasNextInstruction and nextInstruction are used to iterate</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00546" /><CodeLine lineNumber="546"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// through a &quot;straight line&quot; execution sequence.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00547" /><CodeLine lineNumber="547"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00548" /><CodeLine lineNumber="548"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> HasNextInstruction = &#91;&#93;(<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &#123;</Highlight></CodeLine>
<Link id="l00549" /><CodeLine lineNumber="549"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;isTerminator())</Highlight></CodeLine>
<Link id="l00550" /><CodeLine lineNumber="550"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00551" /><CodeLine lineNumber="551"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00552" /><CodeLine lineNumber="552"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;nextBB = <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getParent()-&gt;getUniqueSuccessor();</Highlight></CodeLine>
<Link id="l00553" /><CodeLine lineNumber="553"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> nextBB &amp;&amp; (nextBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a74aa9daea070e2ad3394a3ec58b7316a">getUniquePredecessor</a>() != </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00554" /><CodeLine lineNumber="554"><Highlight kind="normal">  &#125;;</Highlight></CodeLine>
<Link id="l00555" /><CodeLine lineNumber="555"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00556" /><CodeLine lineNumber="556"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> NextInstruction = &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &#123;</Highlight></CodeLine>
<Link id="l00557" /><CodeLine lineNumber="557"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(HasNextInstruction(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &amp;&amp;</Highlight></CodeLine>
<Link id="l00558" /><CodeLine lineNumber="558"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;first check if there is a next instruction!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00559" /><CodeLine lineNumber="559"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00560" /><CodeLine lineNumber="560"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;isTerminator())</Highlight></CodeLine>
<Link id="l00561" /><CodeLine lineNumber="561"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getParent()-&gt;getUniqueSuccessor()-&gt;front();</Highlight></CodeLine>
<Link id="l00562" /><CodeLine lineNumber="562"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> &amp;&#42;++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getIterator();</Highlight></CodeLine>
<Link id="l00563" /><CodeLine lineNumber="563"><Highlight kind="normal">  &#125;;</Highlight></CodeLine>
<Link id="l00564" /><CodeLine lineNumber="564"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00565" /><CodeLine lineNumber="565"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Cursor = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00566" /><CodeLine lineNumber="566"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (Cursor = &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getEntryBlock().front(); HasNextInstruction(Cursor);</Highlight></CodeLine>
<Link id="l00567" /><CodeLine lineNumber="567"><Highlight kind="normal">       Cursor = NextInstruction(Cursor)) &#123;</Highlight></CodeLine>
<Link id="l00568" /><CodeLine lineNumber="568"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00569" /><CodeLine lineNumber="569"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We need to ensure a safepoint poll occurs before any &#39;real&#39; call.  The</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00570" /><CodeLine lineNumber="570"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// easiest way to ensure finite execution between safepoints in the face of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00571" /><CodeLine lineNumber="571"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// recursive and mutually recursive functions is to enforce that each take</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00572" /><CodeLine lineNumber="572"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// a safepoint.  Additionally, we need to ensure a poll before any call</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00573" /><CodeLine lineNumber="573"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// which can grow the stack by an unbounded amount.  This isn&#39;t required</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00574" /><CodeLine lineNumber="574"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// for GC semantics per se, but is a common requirement for languages</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00575" /><CodeLine lineNumber="575"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// which detect stack overflow via guard pages and then throw exceptions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00576" /><CodeLine lineNumber="576"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;<a href="/docs/api/groups/arcopt/#ga9c9cf6ad55eb23d77d083a184e416c09">Call</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CallBase&gt;</a>(Cursor)) &#123;</Highlight></CodeLine>
<Link id="l00577" /><CodeLine lineNumber="577"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#ab79294a2bb06a12d7f4dc32f80b8f935">doesNotRequireEntrySafepointBefore</a>(<a href="/docs/api/groups/arcopt/#ga9c9cf6ad55eb23d77d083a184e416c09">Call</a>))</Highlight></CodeLine>
<Link id="l00578" /><CodeLine lineNumber="578"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00579" /><CodeLine lineNumber="579"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">break</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00580" /><CodeLine lineNumber="580"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00581" /><CodeLine lineNumber="581"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00582" /><CodeLine lineNumber="582"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00583" /><CodeLine lineNumber="583"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((HasNextInstruction(Cursor) || Cursor-&gt;<a href="/docs/api/classes/llvm/instruction/#a7653277511df1034148a37520a585bb5">isTerminator</a>()) &amp;&amp;</Highlight></CodeLine>
<Link id="l00584" /><CodeLine lineNumber="584"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;either we stopped because of a call, or because of terminator&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00585" /><CodeLine lineNumber="585"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00586" /><CodeLine lineNumber="586"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> Cursor;</Highlight></CodeLine>
<Link id="l00587" /><CodeLine lineNumber="587"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00588" /><CodeLine lineNumber="588"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00589" /><CodeLine lineNumber="589" lineLink="#a0d2900c2047fa60ef8138dae263123ff"><Highlight kind="normal"></Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">char</Highlight><Highlight kind="normal"> <a href="#a0d2900c2047fa60ef8138dae263123ff">GCSafepointPollName</a>&#91;&#93; = </Highlight><Highlight kind="stringliteral">&quot;gc.safepoint&#95;poll&quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00590" /><CodeLine lineNumber="590"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00591" /><CodeLine lineNumber="591" lineLink="#a61ab641b03f16e1f3ad916913ce89903"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a61ab641b03f16e1f3ad916913ce89903">isGCSafepointPoll</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</Highlight></CodeLine>
<Link id="l00592" /><CodeLine lineNumber="592"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getName() == <a href="#a0d2900c2047fa60ef8138dae263123ff">GCSafepointPollName</a>;</Highlight></CodeLine>
<Link id="l00593" /><CodeLine lineNumber="593"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00594" /><CodeLine lineNumber="594"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00595" /><CodeLine lineNumber="595"><Highlight kind="comment">/// Returns true if this function should be rewritten to include safepoint</Highlight></CodeLine>
<Link id="l00596" /><CodeLine lineNumber="596"><Highlight kind="comment">/// polls and parseable call sites.  The main point of this function is to be</Highlight></CodeLine>
<Link id="l00597" /><CodeLine lineNumber="597"><Highlight kind="comment">/// an extension point for custom logic.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00598" /><CodeLine lineNumber="598" lineLink="#a737f3181d1ae8ed5fe159b4003d024d1"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a737f3181d1ae8ed5fe159b4003d024d1">shouldRewriteFunction</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</Highlight></CodeLine>
<Link id="l00599" /><CodeLine lineNumber="599"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// TODO: This should check the GCStrategy</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00600" /><CodeLine lineNumber="600"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.hasGC()) &#123;</Highlight></CodeLine>
<Link id="l00601" /><CodeLine lineNumber="601"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;FunctionGCName = <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getGC();</Highlight></CodeLine>
<Link id="l00602" /><CodeLine lineNumber="602"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/stringref">StringRef</a> StatepointExampleName(</Highlight><Highlight kind="stringliteral">&quot;statepoint-example&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00603" /><CodeLine lineNumber="603"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/stringref">StringRef</a> CoreCLRName(</Highlight><Highlight kind="stringliteral">&quot;coreclr&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00604" /><CodeLine lineNumber="604"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> (StatepointExampleName == FunctionGCName) ||</Highlight></CodeLine>
<Link id="l00605" /><CodeLine lineNumber="605"><Highlight kind="normal">           (CoreCLRName == FunctionGCName);</Highlight></CodeLine>
<Link id="l00606" /><CodeLine lineNumber="606"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00607" /><CodeLine lineNumber="607"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00608" /><CodeLine lineNumber="608"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00609" /><CodeLine lineNumber="609"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00610" /><CodeLine lineNumber="610"><Highlight kind="normal"></Highlight><Highlight kind="comment">// TODO: These should become properties of the GCStrategy, possibly with</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00611" /><CodeLine lineNumber="611"><Highlight kind="normal"></Highlight><Highlight kind="comment">// command line overrides.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00612" /><CodeLine lineNumber="612" lineLink="#a4021e064e9d2a5e5762d1d4a1dcd7db9"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a4021e064e9d2a5e5762d1d4a1dcd7db9">enableEntrySafepoints</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123; </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> !<a href="#a4c12206227b4e8c2c86eb6b358ac6b40">NoEntry</a>; &#125;</Highlight></CodeLine>
<Link id="l00613" /><CodeLine lineNumber="613" lineLink="#ade6d0f7cc42acd42e21c6154bd713afa"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#ade6d0f7cc42acd42e21c6154bd713afa">enableBackedgeSafepoints</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123; </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> !<a href="#ac2cc2564a989cc024c9fec30a0513fac">NoBackedge</a>; &#125;</Highlight></CodeLine>
<Link id="l00614" /><CodeLine lineNumber="614" lineLink="#a3a3b930c659333a27bb598ea5960fe52"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a3a3b930c659333a27bb598ea5960fe52">enableCallSafepoints</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123; </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> !<a href="#ab83017c62afe3ecae730eba7a1920baa">NoCall</a>; &#125;</Highlight></CodeLine>
<Link id="l00615" /><CodeLine lineNumber="615"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00616" /><CodeLine lineNumber="616"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Insert a safepoint poll immediately before the given instruction.  Does</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00617" /><CodeLine lineNumber="617"><Highlight kind="normal"></Highlight><Highlight kind="comment">// not handle the parsability of state at the runtime call, that&#39;s the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00618" /><CodeLine lineNumber="618"><Highlight kind="normal"></Highlight><Highlight kind="comment">// callers job.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00619" /><CodeLine lineNumber="619"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00620" /><CodeLine lineNumber="620" lineLink="#a05dd87a2da7ddff8ce97716e3b479b2e"><Highlight kind="normal"><a href="#a05dd87a2da7ddff8ce97716e3b479b2e">InsertSafepointPoll</a>(<a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> InsertBefore,</Highlight></CodeLine>
<Link id="l00621" /><CodeLine lineNumber="621"><Highlight kind="normal">                    std::vector&lt;CallBase &#42;&gt; &amp;ParsePointsNeeded </Highlight><Highlight kind="comment">/&#42;rval&#42;/</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l00622" /><CodeLine lineNumber="622"><Highlight kind="normal">                    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/targetlibraryinfo">TargetLibraryInfo</a> &amp;TLI) &#123;</Highlight></CodeLine>
<Link id="l00623" /><CodeLine lineNumber="623"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;OrigBB = InsertBefore-&gt;<a href="/docs/api/classes/llvm/basicblock/#a1b4bf7c97cdc8159fd73d48063f0b250">getParent</a>();</Highlight></CodeLine>
<Link id="l00624" /><CodeLine lineNumber="624"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/module">Module</a> &#42;M = InsertBefore-&gt;getModule();</Highlight></CodeLine>
<Link id="l00625" /><CodeLine lineNumber="625"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(M &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;must be part of a module&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00626" /><CodeLine lineNumber="626"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00627" /><CodeLine lineNumber="627"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Inline the safepoint poll implementation - this will get all the branch,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00628" /><CodeLine lineNumber="628"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// control flow, etc..  Most importantly, it will introduce the actual slow</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00629" /><CodeLine lineNumber="629"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// path call - where we need to insert a safepoint (parsepoint).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00630" /><CodeLine lineNumber="630"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00631" /><CodeLine lineNumber="631"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = M-&gt;getFunction(<a href="#a0d2900c2047fa60ef8138dae263123ff">GCSafepointPollName</a>);</Highlight></CodeLine>
<Link id="l00632" /><CodeLine lineNumber="632"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;gc.safepoint&#95;poll function is missing&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00633" /><CodeLine lineNumber="633"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getValueType() ==</Highlight></CodeLine>
<Link id="l00634" /><CodeLine lineNumber="634"><Highlight kind="normal">         <a href="/docs/api/classes/llvm/functiontype/#af8be7844c269f201ebcee1e15048c378">FunctionType::get</a>(<a href="/docs/api/classes/llvm/type/#a6e20e76960d952de088354cbcd14c3ab">Type::getVoidTy</a>(M-&gt;getContext()), </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">) &amp;&amp;</Highlight></CodeLine>
<Link id="l00635" /><CodeLine lineNumber="635"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;gc.safepoint&#95;poll declared with wrong type&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00636" /><CodeLine lineNumber="636"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;empty() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;gc.safepoint&#95;poll must be a non-empty function&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00637" /><CodeLine lineNumber="637"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42;PollCall = <a href="/docs/api/classes/llvm/callinst/#aa04721251be00370fbde6d21f47fed1a">CallInst::Create</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, </Highlight><Highlight kind="stringliteral">&quot;&quot;</Highlight><Highlight kind="normal">, InsertBefore);</Highlight></CodeLine>
<Link id="l00638" /><CodeLine lineNumber="638"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00639" /><CodeLine lineNumber="639"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Record some information about the call site we&#39;re replacing</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00640" /><CodeLine lineNumber="640"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> <a href="/docs/api/files/lib/lib/passes/standardinstrumentations-cpp/#a6f1bbcae7288f05872dcfe811d0388baa9060587edeb01a63e3d3edc959678d1e">Before</a>(PollCall), <a href="/docs/api/files/lib/lib/passes/standardinstrumentations-cpp/#a6f1bbcae7288f05872dcfe811d0388baa7bfcadb5535fe8aad5032762b7bfe159">After</a>(PollCall);</Highlight></CodeLine>
<Link id="l00641" /><CodeLine lineNumber="641"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> IsBegin = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00642" /><CodeLine lineNumber="642"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/passes/standardinstrumentations-cpp/#a6f1bbcae7288f05872dcfe811d0388baa9060587edeb01a63e3d3edc959678d1e">Before</a> == OrigBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a0ed5f3ab3c2e4196ee0cffffa080c062">begin</a>())</Highlight></CodeLine>
<Link id="l00643" /><CodeLine lineNumber="643"><Highlight kind="normal">    IsBegin = </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00644" /><CodeLine lineNumber="644"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00645" /><CodeLine lineNumber="645"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/passes/standardinstrumentations-cpp/#a6f1bbcae7288f05872dcfe811d0388baa9060587edeb01a63e3d3edc959678d1e">Before</a>--;</Highlight></CodeLine>
<Link id="l00646" /><CodeLine lineNumber="646"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00647" /><CodeLine lineNumber="647"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/passes/standardinstrumentations-cpp/#a6f1bbcae7288f05872dcfe811d0388baa7bfcadb5535fe8aad5032762b7bfe159">After</a>++;</Highlight></CodeLine>
<Link id="l00648" /><CodeLine lineNumber="648"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/files/lib/lib/passes/standardinstrumentations-cpp/#a6f1bbcae7288f05872dcfe811d0388baa7bfcadb5535fe8aad5032762b7bfe159">After</a> != OrigBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a0b4e7bee9b8575cc7db73329f1a561bd">end</a>() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;must have successor&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00649" /><CodeLine lineNumber="649"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00650" /><CodeLine lineNumber="650"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Do the actual inlining</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00651" /><CodeLine lineNumber="651"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/inlinefunctioninfo">InlineFunctionInfo</a> IFI;</Highlight></CodeLine>
<Link id="l00652" /><CodeLine lineNumber="652"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> InlineStatus = <a href="/docs/api/namespaces/llvm/#ab5a3ac0a249da0743dac1bd816d8e5d5">InlineFunction</a>(&#42;PollCall, IFI).<a href="/docs/api/classes/llvm/inlineresult/#af279070ae6350a3acd0e80ba7da7d397">isSuccess</a>();</Highlight></CodeLine>
<Link id="l00653" /><CodeLine lineNumber="653"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(InlineStatus &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;inline must succeed&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00654" /><CodeLine lineNumber="654"><Highlight kind="normal">  (void)InlineStatus; </Highlight><Highlight kind="comment">// suppress warning in release-asserts</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00655" /><CodeLine lineNumber="655"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00656" /><CodeLine lineNumber="656"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Check post-conditions</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00657" /><CodeLine lineNumber="657"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(IFI.<a href="/docs/api/classes/llvm/inlinefunctioninfo/#a9c259c76065eb3b4ce3697ce346008ce">StaticAllocas</a>.empty() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;can&#39;t have allocs&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00658" /><CodeLine lineNumber="658"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00659" /><CodeLine lineNumber="659"><Highlight kind="normal">  std::vector&lt;CallInst &#42;&gt; Calls; </Highlight><Highlight kind="comment">// new calls</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00660" /><CodeLine lineNumber="660"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/denseset">DenseSet&lt;BasicBlock &#42;&gt;</a> BBs;    </Highlight><Highlight kind="comment">// new BBs + insertee</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00661" /><CodeLine lineNumber="661"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00662" /><CodeLine lineNumber="662"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Include only the newly inserted instructions, Note: begin may not be valid</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00663" /><CodeLine lineNumber="663"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// if we inserted to the beginning of the basic block</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00664" /><CodeLine lineNumber="664"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> Start = IsBegin ? OrigBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a0ed5f3ab3c2e4196ee0cffffa080c062">begin</a>() : std::next(<a href="/docs/api/files/lib/lib/passes/standardinstrumentations-cpp/#a6f1bbcae7288f05872dcfe811d0388baa9060587edeb01a63e3d3edc959678d1e">Before</a>);</Highlight></CodeLine>
<Link id="l00665" /><CodeLine lineNumber="665"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00666" /><CodeLine lineNumber="666"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If your poll function includes an unreachable at the end, that&#39;s not</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00667" /><CodeLine lineNumber="667"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// valid.  Bugpoint likes to create this, so check for it.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00668" /><CodeLine lineNumber="668"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/#affedc93ead6b25c57a7196d32ff11e89">isPotentiallyReachable</a>(&amp;&#42;Start, &amp;&#42;<a href="/docs/api/files/lib/lib/passes/standardinstrumentations-cpp/#a6f1bbcae7288f05872dcfe811d0388baa7bfcadb5535fe8aad5032762b7bfe159">After</a>) &amp;&amp;</Highlight></CodeLine>
<Link id="l00669" /><CodeLine lineNumber="669"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;malformed poll function&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00670" /><CodeLine lineNumber="670"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00671" /><CodeLine lineNumber="671"><Highlight kind="normal">  <a href="#a826d7a5a20d56ef31ee4111073700c93">scanInlinedCode</a>(&amp;&#42;Start, &amp;&#42;<a href="/docs/api/files/lib/lib/passes/standardinstrumentations-cpp/#a6f1bbcae7288f05872dcfe811d0388baa7bfcadb5535fe8aad5032762b7bfe159">After</a>, Calls, BBs);</Highlight></CodeLine>
<Link id="l00672" /><CodeLine lineNumber="672"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!Calls.empty() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;slow path not found for safepoint poll&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00673" /><CodeLine lineNumber="673"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00674" /><CodeLine lineNumber="674"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Record the fact we need a parsable state at the runtime call contained in</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00675" /><CodeLine lineNumber="675"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the poll function.  This is required so that the runtime knows how to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00676" /><CodeLine lineNumber="676"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// parse the last frame when we actually take  the safepoint (i.e. execute</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00677" /><CodeLine lineNumber="677"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the slow path)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00678" /><CodeLine lineNumber="678"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(ParsePointsNeeded.empty());</Highlight></CodeLine>
<Link id="l00679" /><CodeLine lineNumber="679"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;CI : Calls) &#123;</Highlight></CodeLine>
<Link id="l00680" /><CodeLine lineNumber="680"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// No safepoint needed or wanted</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00681" /><CodeLine lineNumber="681"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="#a798de004bec543c0f9059f8c5fc78f92">needsStatepoint</a>(CI, TLI))</Highlight></CodeLine>
<Link id="l00682" /><CodeLine lineNumber="682"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00683" /><CodeLine lineNumber="683"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00684" /><CodeLine lineNumber="684"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// These are likely runtime calls.  Should we assert that via calling</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00685" /><CodeLine lineNumber="685"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// convention or something?</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00686" /><CodeLine lineNumber="686"><Highlight kind="normal">    ParsePointsNeeded.push&#95;back(CI);</Highlight></CodeLine>
<Link id="l00687" /><CodeLine lineNumber="687"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00688" /><CodeLine lineNumber="688"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(ParsePointsNeeded.size() &lt;= Calls.size());</Highlight></CodeLine>
<Link id="l00689" /><CodeLine lineNumber="689"><Highlight kind="normal">&#125;</Highlight></CodeLine>

</ProgramListing>


</DoxygenPage>
