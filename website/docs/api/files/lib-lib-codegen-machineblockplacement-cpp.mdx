---

# DO NOT EDIT!
# Automatically generated via docusaurus-plugin-doxygen by Doxygen.

slug: /api/files/lib/lib/codegen/machineblockplacement-cpp
custom_edit_url: null
keywords:
  - doxygen
  - reference
  - file

---

import Link from '@docusaurus/Link'

import CodeLine from '@xpack/docusaurus-plugin-doxygen/components/CodeLine'
import DoxygenPage from '@xpack/docusaurus-plugin-doxygen/components/DoxygenPage'
import IncludesList from '@xpack/docusaurus-plugin-doxygen/components/IncludesList'
import IncludesListItem from '@xpack/docusaurus-plugin-doxygen/components/IncludesListItem'
import MemberDefinition from '@xpack/docusaurus-plugin-doxygen/components/MemberDefinition'
import MembersIndex from '@xpack/docusaurus-plugin-doxygen/components/MembersIndex'
import MembersIndexItem from '@xpack/docusaurus-plugin-doxygen/components/MembersIndexItem'
import ProgramListing from '@xpack/docusaurus-plugin-doxygen/components/ProgramListing'
import SectionDefinition from '@xpack/docusaurus-plugin-doxygen/components/SectionDefinition'

import pluginConfig from '@site/docusaurus-plugin-doxygen-config.json'

# The `MachineBlockPlacement.cpp` File Reference

<DoxygenPage pluginConfig={pluginConfig}>



## Included Headers

<IncludesList>
<IncludesListItem
  filePath="BranchFolding.h"
  permalink="/docs/api/files/lib/lib/codegen/branchfolding-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/ArrayRef.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/arrayref-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/DenseMap.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/densemap-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/STLExtras.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/stlextras-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SetVector.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/setvector-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SmallPtrSet.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/smallptrset-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SmallVector.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/smallvector-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/Statistic.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/BlockFrequencyInfoImpl.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/blockfrequencyinfoimpl-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/ProfileSummaryInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/profilesummaryinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MBFIWrapper.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/mbfiwrapper-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineBasicBlock.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machinebasicblock-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineBlockFrequencyInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machineblockfrequencyinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineBranchProbabilityInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machinebranchprobabilityinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineFunction.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machinefunction-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineFunctionPass.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machinefunctionpass-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineLoopInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machineloopinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachinePostDominators.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machinepostdominators-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineSizeOpts.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machinesizeopts-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/TailDuplicator.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/tailduplicator-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/TargetInstrInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/targetinstrinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/TargetLowering.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/targetlowering-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/TargetPassConfig.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/targetpassconfig-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/TargetSubtargetInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/targetsubtargetinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/DebugLoc.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/debugloc-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Function.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/function-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/PrintPasses.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/printpasses-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/InitializePasses.h"
  permalink="/docs/api/files/include/include/llvm/initializepasses-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Pass.h"
  permalink="/docs/api/files/include/include/llvm/pass-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/Allocator.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/allocator-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/BlockFrequency.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/blockfrequency-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/BranchProbability.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/branchprobability-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/CodeGen.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/codegen-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/CommandLine.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/Compiler.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/compiler-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/Debug.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/debug-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/raw_ostream.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/raw-ostream-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Target/TargetMachine.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/target/targetmachine-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/CodeLayout.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/codelayout-h"
  isLocal="true" />
<IncludesListItem
  filePath="algorithm"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="cassert"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="cstdint"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="iterator"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="memory"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="string"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="tuple"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="utility"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="vector"
  permalink=""
  isLocal="false" />
</IncludesList>

## Namespaces Index

<MembersIndex>

<MembersIndexItem
  type="namespace"
  name={<><a href="/docs/api/namespaces/llvm">llvm</a></>}>
This is an optimization pass for GlobalISel generic memory operations. <a href="/docs/api/namespaces/llvm/#details">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="namespace"
  name={<><a href="/docs/api/namespaces/anonymous-machineblockplacement-cpp-">anonymous&#123;MachineBlockPlacement.cpp&#125;</a></>}>
</MembersIndexItem>

</MembersIndex>

## Classes Index

<MembersIndex>

<MembersIndexItem
  type="class"
  name={<><a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain">BlockChain</a></>}>
A chain of blocks which will be laid out contiguously. <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#details">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="class"
  name={<><a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement">MachineBlockPlacement</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type="struct"
  name={<><a href="/docs/api/structs/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/blockandtaildupresult">BlockAndTailDupResult</a></>}>
Pair struct containing basic block and taildup profitability. <a href="/docs/api/structs/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/blockandtaildupresult/#details">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="struct"
  name={<><a href="/docs/api/structs/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/weightededge">WeightedEdge</a></>}>
<a href="/docs/api/classes/llvm/triple">Triple</a> struct containing edge weight and the edge. <a href="/docs/api/structs/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/weightededge/#details">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="class"
  name={<><a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacementstats">MachineBlockPlacementStats</a></>}>
A pass to compute block placement statistics. <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacementstats/#details">More...</a>
</MembersIndexItem>

</MembersIndex>

## Functions Index

<MembersIndex>

<MembersIndexItem
  type={<>uint64&#95;t</>}
  name={<><a href="#ac20133598c564acc81e5abadc5a1d637">countMBBInstruction</a> (MachineBasicBlock &#42;MBB)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a></>}
  name={<><a href="#a0a894de03271c0ccc991e40f4cdd2623">getAdjustedProbability</a> (BranchProbability OrigProb, BranchProbability AdjustedSumProb)</>}>
The helper function returns the branch probability that is adjusted or normalized over the new total <code>AdjustedSumProb</code>. <a href="#a0a894de03271c0ccc991e40f4cdd2623">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<>Branch Probability Basic Block static false <a href="/docs/api/files/include/include/llvm/include/llvm/demangle/itaniumdemangle-h/#ae2b0d0345572d6718e219aa76d1d54edab45cffe084dd3d20d928bee85e7b0f21">std::string</a></>}
  name={<><a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a> (const MachineBasicBlock &#42;BB)</>}>
Helper to print the name of a MBB. <a href="#a8f9ee7f9ffc036496a8663335da175fa">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a></>}
  name={<><a href="#a3d135a8abf70dc93455708cc087cc0b0">getLayoutSuccessorProbThreshold</a> (const MachineBasicBlock &#42;BB)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a73743365177645c3db889f210cd5ad1d">greaterWithBias</a> (BlockFrequency A, BlockFrequency B, BlockFrequency EntryFreq)</>}>
Compare 2 <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>&#39;s with a small penalty for <code>A</code>. <a href="#a73743365177645c3db889f210cd5ad1d">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#ab20068697df3d13ab12e09852d99b7f7">hasSameSuccessors</a> (MachineBasicBlock &amp;BB, SmallPtrSetImpl&lt; const MachineBasicBlock &#42; &gt; &amp;Successors)</>}>
<a href="/docs/api/namespaces/llvm/check">Check</a> if <code>BB</code> has exactly the successors in <code>Successors</code>. <a href="#ab20068697df3d13ab12e09852d99b7f7">More...</a>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#aa4d0eea634133a91f99ee833a4d073ef">INITIALIZE&#95;PASS&#95;BEGIN</a> (MachineBlockPlacement, DEBUG&#95;TYPE, &quot;Branch Probability Basic Block Placement&quot;, false, false) INITIALIZE&#95;PASS&#95;END(MachineBlockPlacement</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#ace73c7d6fee046409626ebb1799d0454">INITIALIZE&#95;PASS&#95;BEGIN</a> (MachineBlockPlacementStats, &quot;block-placement-stats&quot;, &quot;Basic Block Placement Stats&quot;, false, false) INITIALIZE&#95;PASS&#95;END(MachineBlockPlacementStats</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#ad05af0aa86e2b12cf42ab78461b937cd">STATISTIC</a> (NumCondBranches, &quot;Number of conditional branches&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#a0b86f72bc30eb2255f4c0a22ffab9d3d">STATISTIC</a> (NumUncondBranches, &quot;Number of unconditional branches&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#ad2d61a27d105b8e831a92e20acdeca10">STATISTIC</a> (CondBranchTakenFreq, &quot;Potential frequency of taking conditional branches&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#a6eeb8d383eae14ff1d8952fe471fb841">STATISTIC</a> (UncondBranchTakenFreq, &quot;Potential frequency of taking unconditional branches&quot;)</>}>
</MembersIndexItem>

</MembersIndex>

## Variables Index

<MembersIndex>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#a1f1e40c7ec4c37b42f76da67c75e638d">AlignAllBlock</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#a4dbf76303569b68b0d3719627c88e9fe">AlignAllNonFallThruBlocks</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a956f6faccd85fe2a75302e0ac3ecc606">ApplyExtTspForSize</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a84ae0b35deb4cbcffc27c3d52a781fca">BranchFoldPlacement</a></>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#a030569d5a541b6110f2ae1b6a3413a58">DEBUG&#95;TYPE</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#a41cd121b4df30e5c0dc17f0c479e843a">ExitBlockBias</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#a1160412b923427430e8bf4c819d79a93">ExtTspBlockPlacementMaxBlocks</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type="Branch Probability Basic Block"
  name={<><a href="#a80b3a35dc5c2cb6840ae523bc8d1902a">false</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a3ede40cd3f6f158cb8cbbc9de3844d98">ForceLoopColdBlock</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#ae71e7939345cee7ef0596b40d1ad068b">ForcePreciseRotationCost</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#a72b387cbb4c16dbf0558135dd26ddfd0">JumpInstCost</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#acba0c508ce2e626b58485ceb28068cf1">LoopToColdBlockRatio</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#a7713277c884a7bf39711c1c0d6cf9c26">MaxBytesForAlignmentOverride</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#a75fe07dfba15c73225c8ca4cd720049d">MisfetchCost</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type="Branch Probability Basic Block"
  name={<><a href="#a10783a549bfb83fd142ae4e645a283ef">Placement</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a0d30337c58d278817264718434f122ca">PreciseRotationCost</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#ad1fed248fc2af534bd094b35c9f0c64b">RenumberBlocksBeforeView</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/unifyloopexits-cpp/#a4741a07a0e5675f89cfed122008e0a76">block</a> placement</>}
  name={<><a href="#a971b2fc3751cade0a6b2f76c92774317">stats</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/unifyloopexits-cpp/#a4741a07a0e5675f89cfed122008e0a76">block</a> placement Basic Block <a href="#a10783a549bfb83fd142ae4e645a283ef">Placement</a></>}
  name={<><a href="#a086f939e29b718dc5a01e4bcfe6af2a1">Stats</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#abf71e6f582691ae8bdf8ed170fb11ae6">TailDupPlacement</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#adc8acb8291add6a055468711f701e78d">TailDupPlacementAggressiveThreshold</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#a7344284dac6ba9b8e48d9be67c954bfc">TailDupPlacementPenalty</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#a707021480bba6c165b873f9e238859c5">TailDupPlacementThreshold</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#a84dfb254ed1062bc06a43d2365974bd2">TailDupProfilePercentThreshold</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#a8ac66559c601e390e9477131019ee0ca">TriangleChainCount</a></>}>
</MembersIndexItem>

</MembersIndex>

## Defines Index

<MembersIndex>

<MembersIndexItem
  type="#define"
  name={<><a href="#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>&nbsp;&nbsp;&nbsp;&quot;block-placement&quot;</>}>
</MembersIndexItem>

</MembersIndex>


<SectionDefinition>

## Functions

### countMBBInstruction() {#ac20133598c564acc81e5abadc5a1d637}

<MemberDefinition
  prototype={<>static uint64&#95;t countMBBInstruction (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42; MBB)</>}
  labels = {["static"]}>

Definition at line <a href="#l03272">3272</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### getAdjustedProbability() {#a0a894de03271c0ccc991e40f4cdd2623}

<MemberDefinition
  prototype={<>static BranchProbability getAdjustedProbability (<a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> OrigProb, <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> AdjustedSumProb)</>}
  labels = {["static"]}>
The helper function returns the branch probability that is adjusted or normalized over the new total <code>AdjustedSumProb</code>.

Definition at line <a href="#l00769">769</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### getBlockName() {#a8f9ee7f9ffc036496a8663335da175fa}

<MemberDefinition
  prototype={<>Branch Probability Basic Block static false std::string getBlockName (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42; BB)</>}
  labels = {["static"]}>
Helper to print the name of a MBB.

Only used by debug logging.

Definition at line <a href="#l00657">657</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### getLayoutSuccessorProbThreshold() {#a3d135a8abf70dc93455708cc087cc0b0}

<MemberDefinition
  prototype={<>static BranchProbability getLayoutSuccessorProbThreshold (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42; BB)</>}
  labels = {["static"]}>

Definition at line <a href="#l01397">1397</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### greaterWithBias() {#a73743365177645c3db889f210cd5ad1d}

<MemberDefinition
  prototype={<>static bool greaterWithBias (<a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> A, <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> B, <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> EntryFreq)</>}
  labels = {["static"]}>
Compare 2 <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>&#39;s with a small penalty for <code>A</code>.

In order to be conservative, we apply a X% penalty to account for increased icache pressure and static heuristics. For small frequencies we use only the numerators to improve accuracy. For simplicity, we assume the penalty is less than 100% TODO(iteratee): <a href="/docs/api/classes/llvm/use">Use</a> 64-bit fixed point edge frequencies everywhere.

Definition at line <a href="#l00817">817</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### hasSameSuccessors() {#ab20068697df3d13ab12e09852d99b7f7}

<MemberDefinition
  prototype={<>static bool hasSameSuccessors (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp; BB, <a href="/docs/api/classes/llvm/smallptrsetimpl">SmallPtrSetImpl</a>&lt; <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42; &gt; &amp; Successors)</>}
  labels = {["static"]}>
<a href="/docs/api/namespaces/llvm/check">Check</a> if <code>BB</code> has exactly the successors in <code>Successors</code>.

Definition at line <a href="#l00784">784</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### INITIALIZE&#95;PASS&#95;BEGIN() {#aa4d0eea634133a91f99ee833a4d073ef}

<MemberDefinition
  prototype={<>INITIALIZE&#95;PASS&#95;BEGIN (MachineBlockPlacement, <a href="/docs/api/files/include/include/llvm/include/llvm/adt/genericcycleimpl-h/#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>, &quot;Branch Probability Basic Block Placement&quot;, false, false)</>}>

Definition at line <a href="#l00643">643</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### INITIALIZE&#95;PASS&#95;BEGIN() {#ace73c7d6fee046409626ebb1799d0454}

<MemberDefinition
  prototype={<>INITIALIZE&#95;PASS&#95;BEGIN (MachineBlockPlacementStats, &quot;block-placement-stats&quot;, &quot;Basic Block <a href="#a10783a549bfb83fd142ae4e645a283ef">Placement</a> Stats&quot;, false, false)</>}>

Definition at line <a href="#l03809">3809</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### STATISTIC() {#ad05af0aa86e2b12cf42ab78461b937cd}

<MemberDefinition
  prototype={<>STATISTIC (NumCondBranches, &quot;Number of conditional branches&quot;)</>}>

Definition at line <a href="#l00080">80</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### STATISTIC() {#a0b86f72bc30eb2255f4c0a22ffab9d3d}

<MemberDefinition
  prototype={<>STATISTIC (NumUncondBranches, &quot;Number of unconditional branches&quot;)</>}>

Definition at line <a href="#l00081">81</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### STATISTIC() {#ad2d61a27d105b8e831a92e20acdeca10}

<MemberDefinition
  prototype={<>STATISTIC (CondBranchTakenFreq, &quot;Potential frequency of taking conditional branches&quot;)</>}>

Definition at line <a href="#l00082">82</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### STATISTIC() {#a6eeb8d383eae14ff1d8952fe471fb841}

<MemberDefinition
  prototype={<>STATISTIC (UncondBranchTakenFreq, &quot;Potential frequency of taking unconditional branches&quot;)</>}>

Definition at line <a href="#l00084">84</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Variables

### AlignAllBlock {#a1f1e40c7ec4c37b42f76da67c75e638d}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; AlignAllBlock(&quot;align-all-blocks&quot;, cl::desc(&quot;Force the alignment of all blocks in the function in log2 format &quot; &quot;(e.g 4 means align on 16B boundaries).&quot;), cl::init(0), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00087">87</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### AlignAllNonFallThruBlocks {#a4dbf76303569b68b0d3719627c88e9fe}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; AlignAllNonFallThruBlocks(&quot;align-all-nofallthru-blocks&quot;, cl::desc(&quot;Force the alignment of all blocks that have no fall-through &quot; &quot;predecessors (i.e. don&#39;t add nops that are executed). In log2 &quot; &quot;format (e.g 4 means align on 16B boundaries).&quot;), cl::init(0), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00093">93</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### ApplyExtTspForSize {#a956f6faccd85fe2a75302e0ac3ecc606}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; ApplyExtTspForSize(&quot;apply-ext-tsp-for-size&quot;, cl::init(false), cl::Hidden, cl::desc(&quot;Use ext-tsp for size-aware block placement.&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00223">223</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### BranchFoldPlacement {#a84ae0b35deb4cbcffc27c3d52a781fca}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; BranchFoldPlacement(&quot;branch-fold-placement&quot;, cl::desc(&quot;Perform branch folding during placement. &quot; &quot;Reduces code size.&quot;), cl::init(true), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00157">157</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### DEBUG&#95;TYPE {#a030569d5a541b6110f2ae1b6a3413a58}

<MemberDefinition
  prototype={<>DEBUG&#95;TYPE</>}>

Definition at line <a href="#l00650">650</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### ExitBlockBias {#a41cd121b4df30e5c0dc17f0c479e843a}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; ExitBlockBias(&quot;block-placement-exit-block-bias&quot;, cl::desc(&quot;Block frequency percentage a loop exit block needs &quot; &quot;over the original exit to be considered the new exit.&quot;), cl::init(0), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00107">107</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### ExtTspBlockPlacementMaxBlocks {#a1160412b923427430e8bf4c819d79a93}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; ExtTspBlockPlacementMaxBlocks(&quot;ext-tsp-block-placement-max-blocks&quot;, cl::desc(&quot;Maximum number of basic blocks in a function to run ext-TSP &quot; &quot;block placement.&quot;), cl::init(UINT&#95;MAX), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00215">215</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### false {#a80b3a35dc5c2cb6840ae523bc8d1902a}

<MemberDefinition
  prototype="block placement Basic Block Placement false">

Definition at line <a href="#l00651">651</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### ForceLoopColdBlock {#a3ede40cd3f6f158cb8cbbc9de3844d98}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; ForceLoopColdBlock(&quot;force-loop-cold-block&quot;, cl::desc(&quot;Force outlining cold blocks from loops.&quot;), cl::init(false), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00123">123</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### ForcePreciseRotationCost {#ae71e7939345cee7ef0596b40d1ad068b}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; ForcePreciseRotationCost(&quot;force-precise-rotation-cost&quot;, cl::desc(&quot;Force the use of precise cost &quot; &quot;loop rotation strategy.&quot;), cl::init(false), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00134">134</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### JumpInstCost {#a72b387cbb4c16dbf0558135dd26ddfd0}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; JumpInstCost(&quot;jump-inst-cost&quot;, cl::desc(&quot;Cost of jump instructions.&quot;), cl::init(1), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00146">146</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### LoopToColdBlockRatio {#acba0c508ce2e626b58485ceb28068cf1}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; LoopToColdBlockRatio(&quot;loop-to-cold-block-ratio&quot;, cl::desc(&quot;Outline loop blocks from loop chain if (frequency of loop) / &quot; &quot;(frequency of block) is greater than this ratio&quot;), cl::init(5), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00116">116</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### MaxBytesForAlignmentOverride {#a7713277c884a7bf39711c1c0d6cf9c26}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; MaxBytesForAlignmentOverride(&quot;max-bytes-for-alignment&quot;, cl::desc(&quot;Forces the maximum bytes allowed to be emitted when padding for &quot; &quot;alignment&quot;), cl::init(0), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00100">100</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### MisfetchCost {#a75fe07dfba15c73225c8ca4cd720049d}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; MisfetchCost(&quot;misfetch-cost&quot;, cl::desc(&quot;Cost that models the probabilistic risk of an instruction &quot; &quot;misfetch due to a jump comparing to falling through, whose cost &quot; &quot;is zero.&quot;), cl::init(1), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00139">139</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### Placement {#a10783a549bfb83fd142ae4e645a283ef}

<MemberDefinition
  prototype="Branch Probability Basic Block Placement">

Definition at line <a href="#l00651">651</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### PreciseRotationCost {#a0d30337c58d278817264718434f122ca}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; PreciseRotationCost(&quot;precise-rotation-cost&quot;, cl::desc(&quot;Model the cost of loop rotation more &quot; &quot;precisely by using profile data.&quot;), cl::init(false), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00128">128</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### RenumberBlocksBeforeView {#ad1fed248fc2af534bd094b35c9f0c64b}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; RenumberBlocksBeforeView(&quot;renumber-blocks-before-view&quot;, cl::desc( &quot;If true, basic blocks are re-numbered before MBP layout is printed &quot; &quot;into a dot graph. Only used when a function is being printed.&quot;), cl::init(false), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00208">208</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### stats {#a971b2fc3751cade0a6b2f76c92774317}

<MemberDefinition
  prototype="block placement stats">

Definition at line <a href="#l03813">3813</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### Stats {#a086f939e29b718dc5a01e4bcfe6af2a1}

<MemberDefinition
  prototype="block placement Basic Block Placement Stats">

Definition at line <a href="#l03814">3814</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### TailDupPlacement {#abf71e6f582691ae8bdf8ed170fb11ae6}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; TailDupPlacement(&quot;tail-dup-placement&quot;, cl::desc(&quot;Perform tail duplication during placement. &quot; &quot;Creates more fallthrough opportunities in &quot; &quot;outline branches.&quot;), cl::init(true), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00150">150</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### TailDupPlacementAggressiveThreshold {#adc8acb8291add6a055468711f701e78d}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; TailDupPlacementAggressiveThreshold(&quot;tail-dup-placement-aggressive-threshold&quot;, cl::desc(&quot;Instruction cutoff for aggressive tail duplication during &quot; &quot;layout. Used at -O3. Tail merging during layout is forced to &quot; &quot;have a threshold that won&#39;t conflict.&quot;), cl::init(4), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00171">171</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### TailDupPlacementPenalty {#a7344284dac6ba9b8e48d9be67c954bfc}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; TailDupPlacementPenalty(&quot;tail-dup-placement-penalty&quot;, cl::desc( &quot;Cost penalty for blocks that can avoid breaking CFG by copying. &quot; &quot;Copying can increase fallthrough, but it also increases icache &quot; &quot;pressure. This parameter controls the penalty to account for that. &quot; &quot;Percent as integer.&quot;), cl::init(2), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00179">179</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### TailDupPlacementThreshold {#a707021480bba6c165b873f9e238859c5}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; TailDupPlacementThreshold(&quot;tail-dup-placement-threshold&quot;, cl::desc(&quot;Instruction cutoff for tail duplication during layout. &quot; &quot;Tail merging during layout is forced to have a threshold &quot; &quot;that won&#39;t conflict.&quot;), cl::init(2), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00163">163</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### TailDupProfilePercentThreshold {#a84dfb254ed1062bc06a43d2365974bd2}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; TailDupProfilePercentThreshold(&quot;tail-dup-profile-percent-threshold&quot;, cl::desc(&quot;If profile count information is used in tail duplication cost &quot; &quot;model, the gained fall through number from tail duplication &quot; &quot;should be at least this percent of hot count.&quot;), cl::init(50), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00189">189</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

### TriangleChainCount {#a8ac66559c601e390e9477131019ee0ca}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; TriangleChainCount(&quot;triangle-chain-count&quot;, cl::desc(&quot;Number of triangle-shaped-CFG&#39;s that need to be in a row for the &quot; &quot;triangle tail duplication heuristic to kick in. 0 to disable.&quot;), cl::init(2), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00197">197</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Defines

### DEBUG&#95;TYPE {#ad78e062f62e0d6e453941fb4ca843e4d}

<MemberDefinition
  prototype={<>#define DEBUG&#95;TYPE&nbsp;&nbsp;&nbsp;&quot;block-placement&quot;</>}>

Definition at line <a href="#l00078">78</a> of file <a href="/docs/api/files/lib/lib/codegen/machineblockplacement-cpp">MachineBlockPlacement.cpp</a>.
</MemberDefinition>

</SectionDefinition>

## File Listing

The file content with the documentation metadata removed is:

<ProgramListing>

<Link id="l00001" /><CodeLine lineNumber="1"><span class="doxyHighlightComment">//===- MachineBlockPlacement.cpp - Basic Block Code Layout optimization ---===//</span></CodeLine>
<Link id="l00002" /><CodeLine lineNumber="2"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00003" /><CodeLine lineNumber="3"><span class="doxyHighlightComment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</span></CodeLine>
<Link id="l00004" /><CodeLine lineNumber="4"><span class="doxyHighlightComment">// See https://llvm.org/LICENSE.txt for license information.</span></CodeLine>
<Link id="l00005" /><CodeLine lineNumber="5"><span class="doxyHighlightComment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</span></CodeLine>
<Link id="l00006" /><CodeLine lineNumber="6"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00007" /><CodeLine lineNumber="7"><span class="doxyHighlightComment">//===----------------------------------------------------------------------===//</span></CodeLine>
<Link id="l00008" /><CodeLine lineNumber="8"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00009" /><CodeLine lineNumber="9"><span class="doxyHighlightComment">// This file implements basic block placement transformations using the CFG</span></CodeLine>
<Link id="l00010" /><CodeLine lineNumber="10"><span class="doxyHighlightComment">// structure and branch probability estimates.</span></CodeLine>
<Link id="l00011" /><CodeLine lineNumber="11"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00012" /><CodeLine lineNumber="12"><span class="doxyHighlightComment">// The pass strives to preserve the structure of the CFG (that is, retain</span></CodeLine>
<Link id="l00013" /><CodeLine lineNumber="13"><span class="doxyHighlightComment">// a topological ordering of basic blocks) in the absence of a &#42;strong&#42; signal</span></CodeLine>
<Link id="l00014" /><CodeLine lineNumber="14"><span class="doxyHighlightComment">// to the contrary from probabilities. However, within the CFG structure, it</span></CodeLine>
<Link id="l00015" /><CodeLine lineNumber="15"><span class="doxyHighlightComment">// attempts to choose an ordering which favors placing more likely sequences of</span></CodeLine>
<Link id="l00016" /><CodeLine lineNumber="16"><span class="doxyHighlightComment">// blocks adjacent to each other.</span></CodeLine>
<Link id="l00017" /><CodeLine lineNumber="17"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00018" /><CodeLine lineNumber="18"><span class="doxyHighlightComment">// The algorithm works from the inner-most loop within a function outward, and</span></CodeLine>
<Link id="l00019" /><CodeLine lineNumber="19"><span class="doxyHighlightComment">// at each stage walks through the basic blocks, trying to coalesce them into</span></CodeLine>
<Link id="l00020" /><CodeLine lineNumber="20"><span class="doxyHighlightComment">// sequential chains where allowed by the CFG (or demanded by heavy</span></CodeLine>
<Link id="l00021" /><CodeLine lineNumber="21"><span class="doxyHighlightComment">// probabilities). Finally, it walks the blocks in topological order, and the</span></CodeLine>
<Link id="l00022" /><CodeLine lineNumber="22"><span class="doxyHighlightComment">// first time it reaches a chain of basic blocks, it schedules them in the</span></CodeLine>
<Link id="l00023" /><CodeLine lineNumber="23"><span class="doxyHighlightComment">// function in-order.</span></CodeLine>
<Link id="l00024" /><CodeLine lineNumber="24"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00025" /><CodeLine lineNumber="25"><span class="doxyHighlightComment">//===----------------------------------------------------------------------===//</span></CodeLine>
<Link id="l00026" /><CodeLine lineNumber="26"></CodeLine>
<Link id="l00027" /><CodeLine lineNumber="27"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/lib/lib/codegen/branchfolding-h">BranchFolding.h</a>&quot;</span></CodeLine>
<Link id="l00028" /><CodeLine lineNumber="28"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/arrayref-h">llvm/ADT/ArrayRef.h</a>&quot;</span></CodeLine>
<Link id="l00029" /><CodeLine lineNumber="29"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/densemap-h">llvm/ADT/DenseMap.h</a>&quot;</span></CodeLine>
<Link id="l00030" /><CodeLine lineNumber="30"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/stlextras-h">llvm/ADT/STLExtras.h</a>&quot;</span></CodeLine>
<Link id="l00031" /><CodeLine lineNumber="31"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/setvector-h">llvm/ADT/SetVector.h</a>&quot;</span></CodeLine>
<Link id="l00032" /><CodeLine lineNumber="32"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/smallptrset-h">llvm/ADT/SmallPtrSet.h</a>&quot;</span></CodeLine>
<Link id="l00033" /><CodeLine lineNumber="33"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/smallvector-h">llvm/ADT/SmallVector.h</a>&quot;</span></CodeLine>
<Link id="l00034" /><CodeLine lineNumber="34"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h">llvm/ADT/Statistic.h</a>&quot;</span></CodeLine>
<Link id="l00035" /><CodeLine lineNumber="35"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/blockfrequencyinfoimpl-h">llvm/Analysis/BlockFrequencyInfoImpl.h</a>&quot;</span></CodeLine>
<Link id="l00036" /><CodeLine lineNumber="36"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/profilesummaryinfo-h">llvm/Analysis/ProfileSummaryInfo.h</a>&quot;</span></CodeLine>
<Link id="l00037" /><CodeLine lineNumber="37"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/mbfiwrapper-h">llvm/CodeGen/MBFIWrapper.h</a>&quot;</span></CodeLine>
<Link id="l00038" /><CodeLine lineNumber="38"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machinebasicblock-h">llvm/CodeGen/MachineBasicBlock.h</a>&quot;</span></CodeLine>
<Link id="l00039" /><CodeLine lineNumber="39"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machineblockfrequencyinfo-h">llvm/CodeGen/MachineBlockFrequencyInfo.h</a>&quot;</span></CodeLine>
<Link id="l00040" /><CodeLine lineNumber="40"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machinebranchprobabilityinfo-h">llvm/CodeGen/MachineBranchProbabilityInfo.h</a>&quot;</span></CodeLine>
<Link id="l00041" /><CodeLine lineNumber="41"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machinefunction-h">llvm/CodeGen/MachineFunction.h</a>&quot;</span></CodeLine>
<Link id="l00042" /><CodeLine lineNumber="42"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machinefunctionpass-h">llvm/CodeGen/MachineFunctionPass.h</a>&quot;</span></CodeLine>
<Link id="l00043" /><CodeLine lineNumber="43"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machineloopinfo-h">llvm/CodeGen/MachineLoopInfo.h</a>&quot;</span></CodeLine>
<Link id="l00044" /><CodeLine lineNumber="44"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machinepostdominators-h">llvm/CodeGen/MachinePostDominators.h</a>&quot;</span></CodeLine>
<Link id="l00045" /><CodeLine lineNumber="45"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machinesizeopts-h">llvm/CodeGen/MachineSizeOpts.h</a>&quot;</span></CodeLine>
<Link id="l00046" /><CodeLine lineNumber="46"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/tailduplicator-h">llvm/CodeGen/TailDuplicator.h</a>&quot;</span></CodeLine>
<Link id="l00047" /><CodeLine lineNumber="47"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/targetinstrinfo-h">llvm/CodeGen/TargetInstrInfo.h</a>&quot;</span></CodeLine>
<Link id="l00048" /><CodeLine lineNumber="48"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/targetlowering-h">llvm/CodeGen/TargetLowering.h</a>&quot;</span></CodeLine>
<Link id="l00049" /><CodeLine lineNumber="49"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/targetpassconfig-h">llvm/CodeGen/TargetPassConfig.h</a>&quot;</span></CodeLine>
<Link id="l00050" /><CodeLine lineNumber="50"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/targetsubtargetinfo-h">llvm/CodeGen/TargetSubtargetInfo.h</a>&quot;</span></CodeLine>
<Link id="l00051" /><CodeLine lineNumber="51"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/debugloc-h">llvm/IR/DebugLoc.h</a>&quot;</span></CodeLine>
<Link id="l00052" /><CodeLine lineNumber="52"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/function-h">llvm/IR/Function.h</a>&quot;</span></CodeLine>
<Link id="l00053" /><CodeLine lineNumber="53"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/printpasses-h">llvm/IR/PrintPasses.h</a>&quot;</span></CodeLine>
<Link id="l00054" /><CodeLine lineNumber="54"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/initializepasses-h">llvm/InitializePasses.h</a>&quot;</span></CodeLine>
<Link id="l00055" /><CodeLine lineNumber="55"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/pass-h">llvm/Pass.h</a>&quot;</span></CodeLine>
<Link id="l00056" /><CodeLine lineNumber="56"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/allocator-h">llvm/Support/Allocator.h</a>&quot;</span></CodeLine>
<Link id="l00057" /><CodeLine lineNumber="57"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/blockfrequency-h">llvm/Support/BlockFrequency.h</a>&quot;</span></CodeLine>
<Link id="l00058" /><CodeLine lineNumber="58"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/branchprobability-h">llvm/Support/BranchProbability.h</a>&quot;</span></CodeLine>
<Link id="l00059" /><CodeLine lineNumber="59"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/codegen-h">llvm/Support/CodeGen.h</a>&quot;</span></CodeLine>
<Link id="l00060" /><CodeLine lineNumber="60"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h">llvm/Support/CommandLine.h</a>&quot;</span></CodeLine>
<Link id="l00061" /><CodeLine lineNumber="61"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/compiler-h">llvm/Support/Compiler.h</a>&quot;</span></CodeLine>
<Link id="l00062" /><CodeLine lineNumber="62"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h">llvm/Support/Debug.h</a>&quot;</span></CodeLine>
<Link id="l00063" /><CodeLine lineNumber="63"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/raw-ostream-h">llvm/Support/raw&#95;ostream.h</a>&quot;</span></CodeLine>
<Link id="l00064" /><CodeLine lineNumber="64"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/target/targetmachine-h">llvm/Target/TargetMachine.h</a>&quot;</span></CodeLine>
<Link id="l00065" /><CodeLine lineNumber="65"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/codelayout-h">llvm/Transforms/Utils/CodeLayout.h</a>&quot;</span></CodeLine>
<Link id="l00066" /><CodeLine lineNumber="66"><span class="doxyHighlightPreprocessor">#include &lt;algorithm&gt;</span></CodeLine>
<Link id="l00067" /><CodeLine lineNumber="67"><span class="doxyHighlightPreprocessor">#include &lt;cassert&gt;</span></CodeLine>
<Link id="l00068" /><CodeLine lineNumber="68"><span class="doxyHighlightPreprocessor">#include &lt;cstdint&gt;</span></CodeLine>
<Link id="l00069" /><CodeLine lineNumber="69"><span class="doxyHighlightPreprocessor">#include &lt;iterator&gt;</span></CodeLine>
<Link id="l00070" /><CodeLine lineNumber="70"><span class="doxyHighlightPreprocessor">#include &lt;memory&gt;</span></CodeLine>
<Link id="l00071" /><CodeLine lineNumber="71"><span class="doxyHighlightPreprocessor">#include &lt;string&gt;</span></CodeLine>
<Link id="l00072" /><CodeLine lineNumber="72"><span class="doxyHighlightPreprocessor">#include &lt;tuple&gt;</span></CodeLine>
<Link id="l00073" /><CodeLine lineNumber="73"><span class="doxyHighlightPreprocessor">#include &lt;utility&gt;</span></CodeLine>
<Link id="l00074" /><CodeLine lineNumber="74"><span class="doxyHighlightPreprocessor">#include &lt;vector&gt;</span></CodeLine>
<Link id="l00075" /><CodeLine lineNumber="75"></CodeLine>
<Link id="l00076" /><CodeLine lineNumber="76"><span class="doxyHighlightKeyword">using namespace </span><span class="doxyHighlight"><a href="/docs/api/namespaces/llvm">llvm</a>;</span></CodeLine>
<Link id="l00077" /><CodeLine lineNumber="77"></CodeLine>
<Link id="l00078" /><CodeLine lineNumber="78" lineLink="#ad78e062f62e0d6e453941fb4ca843e4d"><span class="doxyHighlightPreprocessor">#define DEBUG&#95;TYPE &quot;block-placement&quot;</span></CodeLine>
<Link id="l00079" /><CodeLine lineNumber="79"></CodeLine>
<Link id="l00080" /><CodeLine lineNumber="80" lineLink="#ad05af0aa86e2b12cf42ab78461b937cd"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumCondBranches, </span><span class="doxyHighlightStringLiteral">&quot;Number of conditional branches&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00081" /><CodeLine lineNumber="81" lineLink="#a0b86f72bc30eb2255f4c0a22ffab9d3d"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumUncondBranches, </span><span class="doxyHighlightStringLiteral">&quot;Number of unconditional branches&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00082" /><CodeLine lineNumber="82" lineLink="#ad2d61a27d105b8e831a92e20acdeca10"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(CondBranchTakenFreq,</span></CodeLine>
<Link id="l00083" /><CodeLine lineNumber="83"><span class="doxyHighlight">          </span><span class="doxyHighlightStringLiteral">&quot;Potential frequency of taking conditional branches&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00084" /><CodeLine lineNumber="84" lineLink="#a6eeb8d383eae14ff1d8952fe471fb841"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(UncondBranchTakenFreq,</span></CodeLine>
<Link id="l00085" /><CodeLine lineNumber="85"><span class="doxyHighlight">          </span><span class="doxyHighlightStringLiteral">&quot;Potential frequency of taking unconditional branches&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00086" /><CodeLine lineNumber="86"></CodeLine>
<Link id="l00087" /><CodeLine lineNumber="87" lineLink="#a1f1e40c7ec4c37b42f76da67c75e638d"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="#a1f1e40c7ec4c37b42f76da67c75e638d">AlignAllBlock</a>(</span></CodeLine>
<Link id="l00088" /><CodeLine lineNumber="88"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;align-all-blocks&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00089" /><CodeLine lineNumber="89"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Force the alignment of all blocks in the function in log2 format &quot;</span></CodeLine>
<Link id="l00090" /><CodeLine lineNumber="90"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;(e.g 4 means align on 16B boundaries).&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00091" /><CodeLine lineNumber="91"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(0), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00092" /><CodeLine lineNumber="92"></CodeLine>
<Link id="l00093" /><CodeLine lineNumber="93" lineLink="#a4dbf76303569b68b0d3719627c88e9fe"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="#a4dbf76303569b68b0d3719627c88e9fe">AlignAllNonFallThruBlocks</a>(</span></CodeLine>
<Link id="l00094" /><CodeLine lineNumber="94"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;align-all-nofallthru-blocks&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00095" /><CodeLine lineNumber="95"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Force the alignment of all blocks that have no fall-through &quot;</span></CodeLine>
<Link id="l00096" /><CodeLine lineNumber="96"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;predecessors (i.e. don&#39;t add nops that are executed). In log2 &quot;</span></CodeLine>
<Link id="l00097" /><CodeLine lineNumber="97"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;format (e.g 4 means align on 16B boundaries).&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00098" /><CodeLine lineNumber="98"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(0), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00099" /><CodeLine lineNumber="99"></CodeLine>
<Link id="l00100" /><CodeLine lineNumber="100" lineLink="#a7713277c884a7bf39711c1c0d6cf9c26"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="#a7713277c884a7bf39711c1c0d6cf9c26">MaxBytesForAlignmentOverride</a>(</span></CodeLine>
<Link id="l00101" /><CodeLine lineNumber="101"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;max-bytes-for-alignment&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00102" /><CodeLine lineNumber="102"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Forces the maximum bytes allowed to be emitted when padding for &quot;</span></CodeLine>
<Link id="l00103" /><CodeLine lineNumber="103"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;alignment&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00104" /><CodeLine lineNumber="104"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(0), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00105" /><CodeLine lineNumber="105"></CodeLine>
<Link id="l00106" /><CodeLine lineNumber="106"><span class="doxyHighlightComment">// FIXME: Find a good default for this flag and remove the flag.</span></CodeLine>
<Link id="l00107" /><CodeLine lineNumber="107" lineLink="#a41cd121b4df30e5c0dc17f0c479e843a"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="#a41cd121b4df30e5c0dc17f0c479e843a">ExitBlockBias</a>(</span></CodeLine>
<Link id="l00108" /><CodeLine lineNumber="108"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;block-placement-exit-block-bias&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00109" /><CodeLine lineNumber="109"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Block frequency percentage a loop exit block needs &quot;</span></CodeLine>
<Link id="l00110" /><CodeLine lineNumber="110"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;over the original exit to be considered the new exit.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00111" /><CodeLine lineNumber="111"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(0), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00112" /><CodeLine lineNumber="112"></CodeLine>
<Link id="l00113" /><CodeLine lineNumber="113"><span class="doxyHighlightComment">// Definition:</span></CodeLine>
<Link id="l00114" /><CodeLine lineNumber="114"><span class="doxyHighlightComment">// - Outlining: placement of a basic block outside the chain or hot path.</span></CodeLine>
<Link id="l00115" /><CodeLine lineNumber="115"></CodeLine>
<Link id="l00116" /><CodeLine lineNumber="116" lineLink="#acba0c508ce2e626b58485ceb28068cf1"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="#acba0c508ce2e626b58485ceb28068cf1">LoopToColdBlockRatio</a>(</span></CodeLine>
<Link id="l00117" /><CodeLine lineNumber="117"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;loop-to-cold-block-ratio&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00118" /><CodeLine lineNumber="118"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Outline loop blocks from loop chain if (frequency of loop) / &quot;</span></CodeLine>
<Link id="l00119" /><CodeLine lineNumber="119"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;(frequency of block) is greater than this ratio&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00120" /><CodeLine lineNumber="120"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(5), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00121" /><CodeLine lineNumber="121"></CodeLine>
<Link id="l00122" /><CodeLine lineNumber="122"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a></span></CodeLine>
<Link id="l00123" /><CodeLine lineNumber="123" lineLink="#a3ede40cd3f6f158cb8cbbc9de3844d98"><span class="doxyHighlight">    <a href="#a3ede40cd3f6f158cb8cbbc9de3844d98">ForceLoopColdBlock</a>(</span><span class="doxyHighlightStringLiteral">&quot;force-loop-cold-block&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00124" /><CodeLine lineNumber="124"><span class="doxyHighlight">                       <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Force outlining cold blocks from loops.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00125" /><CodeLine lineNumber="125"><span class="doxyHighlight">                       <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00126" /><CodeLine lineNumber="126"></CodeLine>
<Link id="l00127" /><CodeLine lineNumber="127"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a></span></CodeLine>
<Link id="l00128" /><CodeLine lineNumber="128" lineLink="#a0d30337c58d278817264718434f122ca"><span class="doxyHighlight">    <a href="#a0d30337c58d278817264718434f122ca">PreciseRotationCost</a>(</span><span class="doxyHighlightStringLiteral">&quot;precise-rotation-cost&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00129" /><CodeLine lineNumber="129"><span class="doxyHighlight">                        <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Model the cost of loop rotation more &quot;</span></CodeLine>
<Link id="l00130" /><CodeLine lineNumber="130"><span class="doxyHighlight">                                 </span><span class="doxyHighlightStringLiteral">&quot;precisely by using profile data.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00131" /><CodeLine lineNumber="131"><span class="doxyHighlight">                        <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00132" /><CodeLine lineNumber="132"></CodeLine>
<Link id="l00133" /><CodeLine lineNumber="133"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a></span></CodeLine>
<Link id="l00134" /><CodeLine lineNumber="134" lineLink="#ae71e7939345cee7ef0596b40d1ad068b"><span class="doxyHighlight">    <a href="#ae71e7939345cee7ef0596b40d1ad068b">ForcePreciseRotationCost</a>(</span><span class="doxyHighlightStringLiteral">&quot;force-precise-rotation-cost&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00135" /><CodeLine lineNumber="135"><span class="doxyHighlight">                             <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Force the use of precise cost &quot;</span></CodeLine>
<Link id="l00136" /><CodeLine lineNumber="136"><span class="doxyHighlight">                                      </span><span class="doxyHighlightStringLiteral">&quot;loop rotation strategy.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00137" /><CodeLine lineNumber="137"><span class="doxyHighlight">                             <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00138" /><CodeLine lineNumber="138"></CodeLine>
<Link id="l00139" /><CodeLine lineNumber="139" lineLink="#a75fe07dfba15c73225c8ca4cd720049d"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="#a75fe07dfba15c73225c8ca4cd720049d">MisfetchCost</a>(</span></CodeLine>
<Link id="l00140" /><CodeLine lineNumber="140"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;misfetch-cost&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00141" /><CodeLine lineNumber="141"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Cost that models the probabilistic risk of an instruction &quot;</span></CodeLine>
<Link id="l00142" /><CodeLine lineNumber="142"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;misfetch due to a jump comparing to falling through, whose cost &quot;</span></CodeLine>
<Link id="l00143" /><CodeLine lineNumber="143"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;is zero.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00144" /><CodeLine lineNumber="144"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(1), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00145" /><CodeLine lineNumber="145"></CodeLine>
<Link id="l00146" /><CodeLine lineNumber="146" lineLink="#a72b387cbb4c16dbf0558135dd26ddfd0"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="#a72b387cbb4c16dbf0558135dd26ddfd0">JumpInstCost</a>(</span><span class="doxyHighlightStringLiteral">&quot;jump-inst-cost&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00147" /><CodeLine lineNumber="147"><span class="doxyHighlight">                                      <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Cost of jump instructions.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00148" /><CodeLine lineNumber="148"><span class="doxyHighlight">                                      <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(1), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00149" /><CodeLine lineNumber="149"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a></span></CodeLine>
<Link id="l00150" /><CodeLine lineNumber="150" lineLink="#abf71e6f582691ae8bdf8ed170fb11ae6"><span class="doxyHighlight">    <a href="#abf71e6f582691ae8bdf8ed170fb11ae6">TailDupPlacement</a>(</span><span class="doxyHighlightStringLiteral">&quot;tail-dup-placement&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00151" /><CodeLine lineNumber="151"><span class="doxyHighlight">                     <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Perform tail duplication during placement. &quot;</span></CodeLine>
<Link id="l00152" /><CodeLine lineNumber="152"><span class="doxyHighlight">                              </span><span class="doxyHighlightStringLiteral">&quot;Creates more fallthrough opportunities in &quot;</span></CodeLine>
<Link id="l00153" /><CodeLine lineNumber="153"><span class="doxyHighlight">                              </span><span class="doxyHighlightStringLiteral">&quot;outline branches.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00154" /><CodeLine lineNumber="154"><span class="doxyHighlight">                     <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00155" /><CodeLine lineNumber="155"></CodeLine>
<Link id="l00156" /><CodeLine lineNumber="156"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a></span></CodeLine>
<Link id="l00157" /><CodeLine lineNumber="157" lineLink="#a84ae0b35deb4cbcffc27c3d52a781fca"><span class="doxyHighlight">    <a href="#a84ae0b35deb4cbcffc27c3d52a781fca">BranchFoldPlacement</a>(</span><span class="doxyHighlightStringLiteral">&quot;branch-fold-placement&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00158" /><CodeLine lineNumber="158"><span class="doxyHighlight">                        <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Perform branch folding during placement. &quot;</span></CodeLine>
<Link id="l00159" /><CodeLine lineNumber="159"><span class="doxyHighlight">                                 </span><span class="doxyHighlightStringLiteral">&quot;Reduces code size.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00160" /><CodeLine lineNumber="160"><span class="doxyHighlight">                        <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00161" /><CodeLine lineNumber="161"></CodeLine>
<Link id="l00162" /><CodeLine lineNumber="162"><span class="doxyHighlightComment">// Heuristic for tail duplication.</span></CodeLine>
<Link id="l00163" /><CodeLine lineNumber="163" lineLink="#a707021480bba6c165b873f9e238859c5"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="#a707021480bba6c165b873f9e238859c5">TailDupPlacementThreshold</a>(</span></CodeLine>
<Link id="l00164" /><CodeLine lineNumber="164"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;tail-dup-placement-threshold&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00165" /><CodeLine lineNumber="165"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Instruction cutoff for tail duplication during layout. &quot;</span></CodeLine>
<Link id="l00166" /><CodeLine lineNumber="166"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;Tail merging during layout is forced to have a threshold &quot;</span></CodeLine>
<Link id="l00167" /><CodeLine lineNumber="167"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;that won&#39;t conflict.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00168" /><CodeLine lineNumber="168"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(2), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00169" /><CodeLine lineNumber="169"></CodeLine>
<Link id="l00170" /><CodeLine lineNumber="170"><span class="doxyHighlightComment">// Heuristic for aggressive tail duplication.</span></CodeLine>
<Link id="l00171" /><CodeLine lineNumber="171" lineLink="#adc8acb8291add6a055468711f701e78d"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="#adc8acb8291add6a055468711f701e78d">TailDupPlacementAggressiveThreshold</a>(</span></CodeLine>
<Link id="l00172" /><CodeLine lineNumber="172"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;tail-dup-placement-aggressive-threshold&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00173" /><CodeLine lineNumber="173"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Instruction cutoff for aggressive tail duplication during &quot;</span></CodeLine>
<Link id="l00174" /><CodeLine lineNumber="174"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;layout. Used at -O3. Tail merging during layout is forced to &quot;</span></CodeLine>
<Link id="l00175" /><CodeLine lineNumber="175"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;have a threshold that won&#39;t conflict.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00176" /><CodeLine lineNumber="176"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(4), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00177" /><CodeLine lineNumber="177"></CodeLine>
<Link id="l00178" /><CodeLine lineNumber="178"><span class="doxyHighlightComment">// Heuristic for tail duplication.</span></CodeLine>
<Link id="l00179" /><CodeLine lineNumber="179" lineLink="#a7344284dac6ba9b8e48d9be67c954bfc"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="#a7344284dac6ba9b8e48d9be67c954bfc">TailDupPlacementPenalty</a>(</span></CodeLine>
<Link id="l00180" /><CodeLine lineNumber="180"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;tail-dup-placement-penalty&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00181" /><CodeLine lineNumber="181"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span></CodeLine>
<Link id="l00182" /><CodeLine lineNumber="182"><span class="doxyHighlight">        </span><span class="doxyHighlightStringLiteral">&quot;Cost penalty for blocks that can avoid breaking CFG by copying. &quot;</span></CodeLine>
<Link id="l00183" /><CodeLine lineNumber="183"><span class="doxyHighlight">        </span><span class="doxyHighlightStringLiteral">&quot;Copying can increase fallthrough, but it also increases icache &quot;</span></CodeLine>
<Link id="l00184" /><CodeLine lineNumber="184"><span class="doxyHighlight">        </span><span class="doxyHighlightStringLiteral">&quot;pressure. This parameter controls the penalty to account for that. &quot;</span></CodeLine>
<Link id="l00185" /><CodeLine lineNumber="185"><span class="doxyHighlight">        </span><span class="doxyHighlightStringLiteral">&quot;Percent as integer.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00186" /><CodeLine lineNumber="186"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(2), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00187" /><CodeLine lineNumber="187"></CodeLine>
<Link id="l00188" /><CodeLine lineNumber="188"><span class="doxyHighlightComment">// Heuristic for tail duplication if profile count is used in cost model.</span></CodeLine>
<Link id="l00189" /><CodeLine lineNumber="189" lineLink="#a84dfb254ed1062bc06a43d2365974bd2"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="#a84dfb254ed1062bc06a43d2365974bd2">TailDupProfilePercentThreshold</a>(</span></CodeLine>
<Link id="l00190" /><CodeLine lineNumber="190"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;tail-dup-profile-percent-threshold&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00191" /><CodeLine lineNumber="191"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;If profile count information is used in tail duplication cost &quot;</span></CodeLine>
<Link id="l00192" /><CodeLine lineNumber="192"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;model, the gained fall through number from tail duplication &quot;</span></CodeLine>
<Link id="l00193" /><CodeLine lineNumber="193"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;should be at least this percent of hot count.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00194" /><CodeLine lineNumber="194"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(50), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00195" /><CodeLine lineNumber="195"></CodeLine>
<Link id="l00196" /><CodeLine lineNumber="196"><span class="doxyHighlightComment">// Heuristic for triangle chains.</span></CodeLine>
<Link id="l00197" /><CodeLine lineNumber="197" lineLink="#a8ac66559c601e390e9477131019ee0ca"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="#a8ac66559c601e390e9477131019ee0ca">TriangleChainCount</a>(</span></CodeLine>
<Link id="l00198" /><CodeLine lineNumber="198"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;triangle-chain-count&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00199" /><CodeLine lineNumber="199"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Number of triangle-shaped-CFG&#39;s that need to be in a row for the &quot;</span></CodeLine>
<Link id="l00200" /><CodeLine lineNumber="200"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;triangle tail duplication heuristic to kick in. 0 to disable.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00201" /><CodeLine lineNumber="201"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(2), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00202" /><CodeLine lineNumber="202"></CodeLine>
<Link id="l00203" /><CodeLine lineNumber="203"><span class="doxyHighlightComment">// Use case: When block layout is visualized after MBP pass, the basic blocks</span></CodeLine>
<Link id="l00204" /><CodeLine lineNumber="204"><span class="doxyHighlightComment">// are labeled in layout order; meanwhile blocks could be numbered in a</span></CodeLine>
<Link id="l00205" /><CodeLine lineNumber="205"><span class="doxyHighlightComment">// different order. It&#39;s hard to map between the graph and pass output.</span></CodeLine>
<Link id="l00206" /><CodeLine lineNumber="206"><span class="doxyHighlightComment">// With this option on, the basic blocks are renumbered in function layout</span></CodeLine>
<Link id="l00207" /><CodeLine lineNumber="207"><span class="doxyHighlightComment">// order. For debugging only.</span></CodeLine>
<Link id="l00208" /><CodeLine lineNumber="208" lineLink="#ad1fed248fc2af534bd094b35c9f0c64b"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#ad1fed248fc2af534bd094b35c9f0c64b">RenumberBlocksBeforeView</a>(</span></CodeLine>
<Link id="l00209" /><CodeLine lineNumber="209"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;renumber-blocks-before-view&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00210" /><CodeLine lineNumber="210"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span></CodeLine>
<Link id="l00211" /><CodeLine lineNumber="211"><span class="doxyHighlight">        </span><span class="doxyHighlightStringLiteral">&quot;If true, basic blocks are re-numbered before MBP layout is printed &quot;</span></CodeLine>
<Link id="l00212" /><CodeLine lineNumber="212"><span class="doxyHighlight">        </span><span class="doxyHighlightStringLiteral">&quot;into a dot graph. Only used when a function is being printed.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00213" /><CodeLine lineNumber="213"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00214" /><CodeLine lineNumber="214"></CodeLine>
<Link id="l00215" /><CodeLine lineNumber="215" lineLink="#a1160412b923427430e8bf4c819d79a93"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="#a1160412b923427430e8bf4c819d79a93">ExtTspBlockPlacementMaxBlocks</a>(</span></CodeLine>
<Link id="l00216" /><CodeLine lineNumber="216"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;ext-tsp-block-placement-max-blocks&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00217" /><CodeLine lineNumber="217"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Maximum number of basic blocks in a function to run ext-TSP &quot;</span></CodeLine>
<Link id="l00218" /><CodeLine lineNumber="218"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;block placement.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00219" /><CodeLine lineNumber="219"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(UINT&#95;MAX), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00220" /><CodeLine lineNumber="220"></CodeLine>
<Link id="l00221" /><CodeLine lineNumber="221"><span class="doxyHighlightComment">// Apply the ext-tsp algorithm minimizing the size of a binary.</span></CodeLine>
<Link id="l00222" /><CodeLine lineNumber="222"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a></span></CodeLine>
<Link id="l00223" /><CodeLine lineNumber="223" lineLink="#a956f6faccd85fe2a75302e0ac3ecc606"><span class="doxyHighlight">    <a href="#a956f6faccd85fe2a75302e0ac3ecc606">ApplyExtTspForSize</a>(</span><span class="doxyHighlightStringLiteral">&quot;apply-ext-tsp-for-size&quot;</span><span class="doxyHighlight">, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</span></CodeLine>
<Link id="l00224" /><CodeLine lineNumber="224"><span class="doxyHighlight">                       <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Use ext-tsp for size-aware block placement.&quot;</span><span class="doxyHighlight">));</span></CodeLine>
<Link id="l00225" /><CodeLine lineNumber="225"></CodeLine>
<Link id="l00226" /><CodeLine lineNumber="226"><span class="doxyHighlightKeyword">namespace </span><span class="doxyHighlight"><a href="/docs/api/namespaces/llvm">llvm</a> &#123;</span></CodeLine>
<Link id="l00227" /><CodeLine lineNumber="227"><span class="doxyHighlightKeyword">extern</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="/docs/api/namespaces/llvm/#ae4599fe5d1385154f1bfbc41a10495c5">EnableExtTspBlockPlacement</a>;</span></CodeLine>
<Link id="l00228" /><CodeLine lineNumber="228"><span class="doxyHighlightKeyword">extern</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="/docs/api/namespaces/llvm/#a2dee051dfc0746e4fbf6e26175ece121">ApplyExtTspWithoutProfile</a>;</span></CodeLine>
<Link id="l00229" /><CodeLine lineNumber="229"><span class="doxyHighlightKeyword">extern</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="/docs/api/namespaces/llvm/#a75dea20875e2199efbf65662db1234d8">StaticLikelyProb</a>;</span></CodeLine>
<Link id="l00230" /><CodeLine lineNumber="230"><span class="doxyHighlightKeyword">extern</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="/docs/api/namespaces/llvm/#a4de1c8a569d0350e16d8c5e0746d5bbf">ProfileLikelyProb</a>;</span></CodeLine>
<Link id="l00231" /><CodeLine lineNumber="231"></CodeLine>
<Link id="l00232" /><CodeLine lineNumber="232"><span class="doxyHighlightComment">// Internal option used to control BFI display only after MBP pass.</span></CodeLine>
<Link id="l00233" /><CodeLine lineNumber="233"><span class="doxyHighlightComment">// Defined in CodeGen/MachineBlockFrequencyInfo.cpp:</span></CodeLine>
<Link id="l00234" /><CodeLine lineNumber="234"><span class="doxyHighlightComment">// -view-block-layout-with-bfi=</span></CodeLine>
<Link id="l00235" /><CodeLine lineNumber="235" lineLink="/docs/api/namespaces/llvm/#a7cc8a419725f3a9ce1d23c2db21ea143"><span class="doxyHighlightKeyword">extern</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;GVDAGType&gt;</a> <a href="/docs/api/namespaces/llvm/#a7cc8a419725f3a9ce1d23c2db21ea143">ViewBlockLayoutWithBFI</a>;</span></CodeLine>
<Link id="l00236" /><CodeLine lineNumber="236"></CodeLine>
<Link id="l00237" /><CodeLine lineNumber="237"><span class="doxyHighlightComment">// Command line option to specify the name of the function for CFG dump</span></CodeLine>
<Link id="l00238" /><CodeLine lineNumber="238"><span class="doxyHighlightComment">// Defined in Analysis/BlockFrequencyInfo.cpp:  -view-bfi-func-name=</span></CodeLine>
<Link id="l00239" /><CodeLine lineNumber="239"><span class="doxyHighlightKeyword">extern</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;std::string&gt;</a> <a href="/docs/api/namespaces/llvm/#a6391a34afa5b4ed1a5e556a8cc4d971b">ViewBlockFreqFuncName</a>;</span></CodeLine>
<Link id="l00240" /><CodeLine lineNumber="240"><span class="doxyHighlight">&#125; </span><span class="doxyHighlightComment">// namespace llvm</span></CodeLine>
<Link id="l00241" /><CodeLine lineNumber="241"></CodeLine>
<Link id="l00242" /><CodeLine lineNumber="242" lineLink="/docs/api/namespaces/anonymous-machineblockplacement-cpp-"><span class="doxyHighlightKeyword">namespace </span><span class="doxyHighlight">&#123;</span></CodeLine>
<Link id="l00243" /><CodeLine lineNumber="243"></CodeLine>
<Link id="l00244" /><CodeLine lineNumber="244"><span class="doxyHighlightKeyword">class </span><span class="doxyHighlight"><a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain">BlockChain</a>;</span></CodeLine>
<Link id="l00245" /><CodeLine lineNumber="245"></CodeLine>
<Link id="l00246" /><CodeLine lineNumber="246"><span class="doxyHighlightComment">/// Type for our function-wide basic block -&gt; block chain mapping.</span></CodeLine>
<Link id="l00247" /><CodeLine lineNumber="247" lineLink="/docs/api/namespaces/anonymous-machineblockplacement-cpp-/#a2e9703f1f38a15be415246106144a16d"><span class="doxyHighlightKeyword">using </span><span class="doxyHighlight"><a href="/docs/api/namespaces/anonymous-machineblockplacement-cpp-/#a2e9703f1f38a15be415246106144a16d">BlockToChainMapType</a> = <a href="/docs/api/classes/llvm/densemap">DenseMap&lt;const MachineBasicBlock &#42;, BlockChain &#42;&gt;</a>;</span></CodeLine>
<Link id="l00248" /><CodeLine lineNumber="248"></CodeLine>
<Link id="l00249" /><CodeLine lineNumber="249"><span class="doxyHighlightComment">/// A chain of blocks which will be laid out contiguously.</span></CodeLine>
<Link id="l00250" /><CodeLine lineNumber="250"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00251" /><CodeLine lineNumber="251"><span class="doxyHighlightComment">/// This is the datastructure representing a chain of consecutive blocks that</span></CodeLine>
<Link id="l00252" /><CodeLine lineNumber="252"><span class="doxyHighlightComment">/// are profitable to layout together in order to maximize fallthrough</span></CodeLine>
<Link id="l00253" /><CodeLine lineNumber="253"><span class="doxyHighlightComment">/// probabilities and code locality. We also can use a block chain to represent</span></CodeLine>
<Link id="l00254" /><CodeLine lineNumber="254"><span class="doxyHighlightComment">/// a sequence of basic blocks which have some external (correctness)</span></CodeLine>
<Link id="l00255" /><CodeLine lineNumber="255"><span class="doxyHighlightComment">/// requirement for sequential layout.</span></CodeLine>
<Link id="l00256" /><CodeLine lineNumber="256"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00257" /><CodeLine lineNumber="257"><span class="doxyHighlightComment">/// Chains can be built around a single basic block and can be merged to grow</span></CodeLine>
<Link id="l00258" /><CodeLine lineNumber="258"><span class="doxyHighlightComment">/// them. They participate in a block-to-chain mapping, which is updated</span></CodeLine>
<Link id="l00259" /><CodeLine lineNumber="259"><span class="doxyHighlightComment">/// automatically as chains are merged together.</span></CodeLine>
<Link id="l00260" /><CodeLine lineNumber="260" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain"><span class="doxyHighlightKeyword">class </span><span class="doxyHighlight"><a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#123;</span></CodeLine>
<Link id="l00261" /><CodeLine lineNumber="261"><span class="doxyHighlightComment">  /// The sequence of blocks belonging to this chain.</span></CodeLine>
<Link id="l00262" /><CodeLine lineNumber="262"><span class="doxyHighlightComment">  ///</span></CodeLine>
<Link id="l00263" /><CodeLine lineNumber="263"><span class="doxyHighlightComment">  /// This is the sequence of blocks for a particular chain. These will be laid</span></CodeLine>
<Link id="l00264" /><CodeLine lineNumber="264"><span class="doxyHighlightComment">  /// out in-order within the function.</span></CodeLine>
<Link id="l00265" /><CodeLine lineNumber="265"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineBasicBlock &#42;, 4&gt;</a> Blocks;</span></CodeLine>
<Link id="l00266" /><CodeLine lineNumber="266"></CodeLine>
<Link id="l00267" /><CodeLine lineNumber="267"><span class="doxyHighlightComment">  /// A handle to the function-wide basic block to block chain mapping.</span></CodeLine>
<Link id="l00268" /><CodeLine lineNumber="268"><span class="doxyHighlightComment">  ///</span></CodeLine>
<Link id="l00269" /><CodeLine lineNumber="269"><span class="doxyHighlightComment">  /// This is retained in each block chain to simplify the computation of child</span></CodeLine>
<Link id="l00270" /><CodeLine lineNumber="270"><span class="doxyHighlightComment">  /// block chains for SCC-formation and iteration. We store the edges to child</span></CodeLine>
<Link id="l00271" /><CodeLine lineNumber="271"><span class="doxyHighlightComment">  /// basic blocks, and map them back to their associated chains using this</span></CodeLine>
<Link id="l00272" /><CodeLine lineNumber="272"><span class="doxyHighlightComment">  /// structure.</span></CodeLine>
<Link id="l00273" /><CodeLine lineNumber="273"><span class="doxyHighlight">  <a href="/docs/api/namespaces/anonymous-machineblockplacement-cpp-/#a2e9703f1f38a15be415246106144a16d">BlockToChainMapType</a> &amp;BlockToChain;</span></CodeLine>
<Link id="l00274" /><CodeLine lineNumber="274"></CodeLine>
<Link id="l00275" /><CodeLine lineNumber="275"><span class="doxyHighlightKeyword">public</span><span class="doxyHighlight">:</span></CodeLine>
<Link id="l00276" /><CodeLine lineNumber="276"><span class="doxyHighlightComment">  /// Construct a new BlockChain.</span></CodeLine>
<Link id="l00277" /><CodeLine lineNumber="277"><span class="doxyHighlightComment">  ///</span></CodeLine>
<Link id="l00278" /><CodeLine lineNumber="278"><span class="doxyHighlightComment">  /// This builds a new block chain representing a single basic block in the</span></CodeLine>
<Link id="l00279" /><CodeLine lineNumber="279"><span class="doxyHighlightComment">  /// function. It also registers itself as the chain that block participates</span></CodeLine>
<Link id="l00280" /><CodeLine lineNumber="280"><span class="doxyHighlightComment">  /// in with the BlockToChain mapping.</span></CodeLine>
<Link id="l00281" /><CodeLine lineNumber="281" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a>(<a href="/docs/api/namespaces/anonymous-machineblockplacement-cpp-/#a2e9703f1f38a15be415246106144a16d">BlockToChainMapType</a> &amp;BlockToChain, <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB)</span></CodeLine>
<Link id="l00282" /><CodeLine lineNumber="282"><span class="doxyHighlight">      : Blocks(1, BB), BlockToChain(BlockToChain) &#123;</span></CodeLine>
<Link id="l00283" /><CodeLine lineNumber="283"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BB &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Cannot create a chain with a null basic block&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00284" /><CodeLine lineNumber="284"><span class="doxyHighlight">    BlockToChain&#91;BB&#93; = </span><span class="doxyHighlightKeyword">this</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00285" /><CodeLine lineNumber="285"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00286" /><CodeLine lineNumber="286"></CodeLine>
<Link id="l00287" /><CodeLine lineNumber="287"><span class="doxyHighlightComment">  /// Iterator over blocks within the chain.</span></CodeLine>
<Link id="l00288" /><CodeLine lineNumber="288" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#aac2485344159ae07cfd3aa75113f50f5"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">using </span><span class="doxyHighlight"><a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#aac2485344159ae07cfd3aa75113f50f5">iterator</a> = <a href="/docs/api/classes/llvm/smallvectorimpl/#ac5b936169badf0b703567eb960278648">SmallVectorImpl&lt;MachineBasicBlock &#42;&gt;::iterator</a>;</span></CodeLine>
<Link id="l00289" /><CodeLine lineNumber="289" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#a4b69724989408455732d7e436d4da6be"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">using </span><span class="doxyHighlight"><a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#a4b69724989408455732d7e436d4da6be">const&#95;iterator</a> = <a href="/docs/api/classes/llvm/smallvectorimpl/#a641b0782e0cc309372855bfc19fdfd97">SmallVectorImpl&lt;MachineBasicBlock &#42;&gt;::const&#95;iterator</a>;</span></CodeLine>
<Link id="l00290" /><CodeLine lineNumber="290"></CodeLine>
<Link id="l00291" /><CodeLine lineNumber="291"><span class="doxyHighlightComment">  /// Beginning of blocks within the chain.</span></CodeLine>
<Link id="l00292" /><CodeLine lineNumber="292" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#afdac6ad64953988f2ba10ecc1df333c5"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#aac2485344159ae07cfd3aa75113f50f5">iterator</a> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#afdac6ad64953988f2ba10ecc1df333c5">begin</a>() &#123; </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Blocks.begin(); &#125;</span></CodeLine>
<Link id="l00293" /><CodeLine lineNumber="293" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#a5c35917ea8f9b30658afaa6a5753048a"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#a4b69724989408455732d7e436d4da6be">const&#95;iterator</a> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#a5c35917ea8f9b30658afaa6a5753048a">begin</a>()</span><span class="doxyHighlightKeyword"> const </span><span class="doxyHighlight">&#123; </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Blocks.begin(); &#125;</span></CodeLine>
<Link id="l00294" /><CodeLine lineNumber="294"></CodeLine>
<Link id="l00295" /><CodeLine lineNumber="295"><span class="doxyHighlightComment">  /// End of blocks within the chain.</span></CodeLine>
<Link id="l00296" /><CodeLine lineNumber="296" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#a273f25cc15e7c494d9e5dd29cb07a88b"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#aac2485344159ae07cfd3aa75113f50f5">iterator</a> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#a273f25cc15e7c494d9e5dd29cb07a88b">end</a>() &#123; </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Blocks.end(); &#125;</span></CodeLine>
<Link id="l00297" /><CodeLine lineNumber="297" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#a25661224cb2e0ab5b2985319276fbfce"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#a4b69724989408455732d7e436d4da6be">const&#95;iterator</a> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#a25661224cb2e0ab5b2985319276fbfce">end</a>()</span><span class="doxyHighlightKeyword"> const </span><span class="doxyHighlight">&#123; </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Blocks.end(); &#125;</span></CodeLine>
<Link id="l00298" /><CodeLine lineNumber="298"></CodeLine>
<Link id="l00299" /><CodeLine lineNumber="299" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#aa6a5128cead90f00a37234c186692340"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#aa6a5128cead90f00a37234c186692340">remove</a>(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB) &#123;</span></CodeLine>
<Link id="l00300" /><CodeLine lineNumber="300"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#aac2485344159ae07cfd3aa75113f50f5">iterator</a> i = <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#afdac6ad64953988f2ba10ecc1df333c5">begin</a>(); i != <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#a273f25cc15e7c494d9e5dd29cb07a88b">end</a>(); ++i) &#123;</span></CodeLine>
<Link id="l00301" /><CodeLine lineNumber="301"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (&#42;i == BB) &#123;</span></CodeLine>
<Link id="l00302" /><CodeLine lineNumber="302"><span class="doxyHighlight">        Blocks.erase(i);</span></CodeLine>
<Link id="l00303" /><CodeLine lineNumber="303"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00304" /><CodeLine lineNumber="304"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00305" /><CodeLine lineNumber="305"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00306" /><CodeLine lineNumber="306"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00307" /><CodeLine lineNumber="307"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00308" /><CodeLine lineNumber="308"></CodeLine>
<Link id="l00309" /><CodeLine lineNumber="309"><span class="doxyHighlightComment">  /// Merge a block chain into this one.</span></CodeLine>
<Link id="l00310" /><CodeLine lineNumber="310"><span class="doxyHighlightComment">  ///</span></CodeLine>
<Link id="l00311" /><CodeLine lineNumber="311"><span class="doxyHighlightComment">  /// This routine merges a block chain into this one. It takes care of forming</span></CodeLine>
<Link id="l00312" /><CodeLine lineNumber="312"><span class="doxyHighlightComment">  /// a contiguous sequence of basic blocks, updating the edge list, and</span></CodeLine>
<Link id="l00313" /><CodeLine lineNumber="313"><span class="doxyHighlightComment">  /// updating the block -&gt; chain mapping. It does not free or tear down the</span></CodeLine>
<Link id="l00314" /><CodeLine lineNumber="314"><span class="doxyHighlightComment">  /// old chain, but the old chain&#39;s block list is no longer valid.</span></CodeLine>
<Link id="l00315" /><CodeLine lineNumber="315" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#a939be2486e7faed5e6e1fd9d02311273"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#a939be2486e7faed5e6e1fd9d02311273">merge</a>(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB, <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;Chain) &#123;</span></CodeLine>
<Link id="l00316" /><CodeLine lineNumber="316"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BB &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Can&#39;t merge a null block.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00317" /><CodeLine lineNumber="317"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!Blocks.empty() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Can&#39;t merge into an empty chain.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00318" /><CodeLine lineNumber="318"></CodeLine>
<Link id="l00319" /><CodeLine lineNumber="319"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Fast path in case we don&#39;t have a chain already.</span></CodeLine>
<Link id="l00320" /><CodeLine lineNumber="320"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Chain) &#123;</span></CodeLine>
<Link id="l00321" /><CodeLine lineNumber="321"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!BlockToChain&#91;BB&#93; &amp;&amp;</span></CodeLine>
<Link id="l00322" /><CodeLine lineNumber="322"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;Passed chain is null, but BB has entry in BlockToChain.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00323" /><CodeLine lineNumber="323"><span class="doxyHighlight">      Blocks.push&#95;back(BB);</span></CodeLine>
<Link id="l00324" /><CodeLine lineNumber="324"><span class="doxyHighlight">      BlockToChain&#91;BB&#93; = </span><span class="doxyHighlightKeyword">this</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00325" /><CodeLine lineNumber="325"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00326" /><CodeLine lineNumber="326"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00327" /><CodeLine lineNumber="327"></CodeLine>
<Link id="l00328" /><CodeLine lineNumber="328"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BB == &#42;Chain-&gt;<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a8a045d250952c0867382a9840ee18fdf">begin</a>() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Passed BB is not head of Chain.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00329" /><CodeLine lineNumber="329"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Chain-&gt;<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a8a045d250952c0867382a9840ee18fdf">begin</a>() != Chain-&gt;<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a075e34e98605d0e7c289763a104869ac">end</a>());</span></CodeLine>
<Link id="l00330" /><CodeLine lineNumber="330"></CodeLine>
<Link id="l00331" /><CodeLine lineNumber="331"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Update the incoming blocks to point to this chain, and add them to the</span></CodeLine>
<Link id="l00332" /><CodeLine lineNumber="332"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// chain structure.</span></CodeLine>
<Link id="l00333" /><CodeLine lineNumber="333"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;ChainBB : &#42;Chain) &#123;</span></CodeLine>
<Link id="l00334" /><CodeLine lineNumber="334"><span class="doxyHighlight">      Blocks.push&#95;back(ChainBB);</span></CodeLine>
<Link id="l00335" /><CodeLine lineNumber="335"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BlockToChain&#91;ChainBB&#93; == Chain &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Incoming blocks not in chain.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00336" /><CodeLine lineNumber="336"><span class="doxyHighlight">      BlockToChain&#91;ChainBB&#93; = </span><span class="doxyHighlightKeyword">this</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00337" /><CodeLine lineNumber="337"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00338" /><CodeLine lineNumber="338"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00339" /><CodeLine lineNumber="339"></CodeLine>
<Link id="l00340" /><CodeLine lineNumber="340"><span class="doxyHighlightPreprocessor">#ifndef NDEBUG</span></CodeLine>
<Link id="l00341" /><CodeLine lineNumber="341"><span class="doxyHighlightComment">  /// Dump the blocks in this chain.</span></CodeLine>
<Link id="l00342" /><CodeLine lineNumber="342" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#aa8b7b149176869053e12294206134631"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/compiler-h/#aa863693eef567397d9c292da5bf22d34">LLVM&#95;DUMP&#95;METHOD</a> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#aa8b7b149176869053e12294206134631">dump</a>() &#123;</span></CodeLine>
<Link id="l00343" /><CodeLine lineNumber="343"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : &#42;</span><span class="doxyHighlightKeyword">this</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l00344" /><CodeLine lineNumber="344"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>-&gt;dump();</span></CodeLine>
<Link id="l00345" /><CodeLine lineNumber="345"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00346" /><CodeLine lineNumber="346"><span class="doxyHighlightPreprocessor">#endif </span><span class="doxyHighlightComment">// NDEBUG</span></CodeLine>
<Link id="l00347" /><CodeLine lineNumber="347"></CodeLine>
<Link id="l00348" /><CodeLine lineNumber="348"><span class="doxyHighlightComment">  /// Count of predecessors of any block within the chain which have not</span></CodeLine>
<Link id="l00349" /><CodeLine lineNumber="349"><span class="doxyHighlightComment">  /// yet been scheduled.  In general, we will delay scheduling this chain</span></CodeLine>
<Link id="l00350" /><CodeLine lineNumber="350"><span class="doxyHighlightComment">  /// until those predecessors are scheduled (or we find a sufficiently good</span></CodeLine>
<Link id="l00351" /><CodeLine lineNumber="351"><span class="doxyHighlightComment">  /// reason to override this heuristic.)  Note that when forming loop chains,</span></CodeLine>
<Link id="l00352" /><CodeLine lineNumber="352"><span class="doxyHighlightComment">  /// blocks outside the loop are ignored and treated as if they were already</span></CodeLine>
<Link id="l00353" /><CodeLine lineNumber="353"><span class="doxyHighlightComment">  /// scheduled.</span></CodeLine>
<Link id="l00354" /><CodeLine lineNumber="354"><span class="doxyHighlightComment">  ///</span></CodeLine>
<Link id="l00355" /><CodeLine lineNumber="355"><span class="doxyHighlightComment">  /// Note: This field is reinitialized multiple times - once for each loop,</span></CodeLine>
<Link id="l00356" /><CodeLine lineNumber="356"><span class="doxyHighlightComment">  /// and then once for the function as a whole.</span></CodeLine>
<Link id="l00357" /><CodeLine lineNumber="357" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#a8e686b9f871a08ccedf4c9af685a2ee0"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#a8e686b9f871a08ccedf4c9af685a2ee0">UnscheduledPredecessors</a> = 0;</span></CodeLine>
<Link id="l00358" /><CodeLine lineNumber="358"><span class="doxyHighlight">&#125;;</span></CodeLine>
<Link id="l00359" /><CodeLine lineNumber="359"></CodeLine>
<Link id="l00360" /><CodeLine lineNumber="360" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement"><span class="doxyHighlightKeyword">class </span><span class="doxyHighlight"><a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#ad7175334e09f55bf7b5fb08d9522449e">MachineBlockPlacement</a> : </span><span class="doxyHighlightKeyword">public</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinefunctionpass/#a29c81d2386f4a727c6d33413807530c8">MachineFunctionPass</a> &#123;</span></CodeLine>
<Link id="l00361" /><CodeLine lineNumber="361"><span class="doxyHighlightComment">  /// A type for a block filter set.</span></CodeLine>
<Link id="l00362" /><CodeLine lineNumber="362"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">using </span><span class="doxyHighlight">BlockFilterSet = <a href="/docs/api/classes/llvm/smallsetvector">SmallSetVector&lt;const MachineBasicBlock &#42;, 16&gt;</a>;</span></CodeLine>
<Link id="l00363" /><CodeLine lineNumber="363"></CodeLine>
<Link id="l00364" /><CodeLine lineNumber="364"><span class="doxyHighlightComment">  /// Pair struct containing basic block and taildup profitability</span></CodeLine>
<Link id="l00365" /><CodeLine lineNumber="365"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">struct </span><span class="doxyHighlight">BlockAndTailDupResult &#123;</span></CodeLine>
<Link id="l00366" /><CodeLine lineNumber="366"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00367" /><CodeLine lineNumber="367"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> ShouldTailDup;</span></CodeLine>
<Link id="l00368" /><CodeLine lineNumber="368"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l00369" /><CodeLine lineNumber="369"></CodeLine>
<Link id="l00370" /><CodeLine lineNumber="370"><span class="doxyHighlightComment">  /// Triple struct containing edge weight and the edge.</span></CodeLine>
<Link id="l00371" /><CodeLine lineNumber="371"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">struct </span><span class="doxyHighlight">WeightedEdge &#123;</span></CodeLine>
<Link id="l00372" /><CodeLine lineNumber="372"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> Weight;</span></CodeLine>
<Link id="l00373" /><CodeLine lineNumber="373"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Src = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00374" /><CodeLine lineNumber="374"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Dest = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00375" /><CodeLine lineNumber="375"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l00376" /><CodeLine lineNumber="376"></CodeLine>
<Link id="l00377" /><CodeLine lineNumber="377"><span class="doxyHighlightComment">  /// work lists of blocks that are ready to be laid out</span></CodeLine>
<Link id="l00378" /><CodeLine lineNumber="378"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineBasicBlock &#42;, 16&gt;</a> BlockWorkList;</span></CodeLine>
<Link id="l00379" /><CodeLine lineNumber="379"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineBasicBlock &#42;, 16&gt;</a> EHPadWorkList;</span></CodeLine>
<Link id="l00380" /><CodeLine lineNumber="380"></CodeLine>
<Link id="l00381" /><CodeLine lineNumber="381"><span class="doxyHighlightComment">  /// Edges that have already been computed as optimal.</span></CodeLine>
<Link id="l00382" /><CodeLine lineNumber="382"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/densemap">DenseMap&lt;const MachineBasicBlock &#42;, BlockAndTailDupResult&gt;</a> ComputedEdges;</span></CodeLine>
<Link id="l00383" /><CodeLine lineNumber="383"></CodeLine>
<Link id="l00384" /><CodeLine lineNumber="384"><span class="doxyHighlightComment">  /// Machine Function</span></CodeLine>
<Link id="l00385" /><CodeLine lineNumber="385"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &#42;F = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00386" /><CodeLine lineNumber="386"></CodeLine>
<Link id="l00387" /><CodeLine lineNumber="387"><span class="doxyHighlightComment">  /// A handle to the branch probability pass.</span></CodeLine>
<Link id="l00388" /><CodeLine lineNumber="388"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebranchprobabilityinfo">MachineBranchProbabilityInfo</a> &#42;MBPI = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00389" /><CodeLine lineNumber="389"></CodeLine>
<Link id="l00390" /><CodeLine lineNumber="390"><span class="doxyHighlightComment">  /// A handle to the function-wide block frequency pass.</span></CodeLine>
<Link id="l00391" /><CodeLine lineNumber="391"><span class="doxyHighlight">  std::unique&#95;ptr&lt;MBFIWrapper&gt; MBFI;</span></CodeLine>
<Link id="l00392" /><CodeLine lineNumber="392"></CodeLine>
<Link id="l00393" /><CodeLine lineNumber="393"><span class="doxyHighlightComment">  /// A handle to the loop info.</span></CodeLine>
<Link id="l00394" /><CodeLine lineNumber="394"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machineloopinfo">MachineLoopInfo</a> &#42;MLI = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00395" /><CodeLine lineNumber="395"></CodeLine>
<Link id="l00396" /><CodeLine lineNumber="396"><span class="doxyHighlightComment">  /// Preferred loop exit.</span></CodeLine>
<Link id="l00397" /><CodeLine lineNumber="397"><span class="doxyHighlightComment">  /// Member variable for convenience. It may be removed by duplication deep</span></CodeLine>
<Link id="l00398" /><CodeLine lineNumber="398"><span class="doxyHighlightComment">  /// in the call stack.</span></CodeLine>
<Link id="l00399" /><CodeLine lineNumber="399"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;PreferredLoopExit = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00400" /><CodeLine lineNumber="400"></CodeLine>
<Link id="l00401" /><CodeLine lineNumber="401"><span class="doxyHighlightComment">  /// A handle to the target&#39;s instruction info.</span></CodeLine>
<Link id="l00402" /><CodeLine lineNumber="402"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/targetinstrinfo">TargetInstrInfo</a> &#42;TII = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00403" /><CodeLine lineNumber="403"></CodeLine>
<Link id="l00404" /><CodeLine lineNumber="404"><span class="doxyHighlightComment">  /// A handle to the target&#39;s lowering info.</span></CodeLine>
<Link id="l00405" /><CodeLine lineNumber="405"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/targetloweringbase">TargetLoweringBase</a> &#42;TLI = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00406" /><CodeLine lineNumber="406"></CodeLine>
<Link id="l00407" /><CodeLine lineNumber="407"><span class="doxyHighlightComment">  /// A handle to the post dominator tree.</span></CodeLine>
<Link id="l00408" /><CodeLine lineNumber="408"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinepostdominatortree">MachinePostDominatorTree</a> &#42;MPDT = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00409" /><CodeLine lineNumber="409"></CodeLine>
<Link id="l00410" /><CodeLine lineNumber="410"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/profilesummaryinfo">ProfileSummaryInfo</a> &#42;PSI = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00411" /><CodeLine lineNumber="411"></CodeLine>
<Link id="l00412" /><CodeLine lineNumber="412"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/targetpassconfig">TargetPassConfig</a> &#42;PassConfig = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00413" /><CodeLine lineNumber="413"></CodeLine>
<Link id="l00414" /><CodeLine lineNumber="414"><span class="doxyHighlightComment">  /// Duplicator used to duplicate tails during placement.</span></CodeLine>
<Link id="l00415" /><CodeLine lineNumber="415"><span class="doxyHighlightComment">  ///</span></CodeLine>
<Link id="l00416" /><CodeLine lineNumber="416"><span class="doxyHighlightComment">  /// Placement decisions can open up new tail duplication opportunities, but</span></CodeLine>
<Link id="l00417" /><CodeLine lineNumber="417"><span class="doxyHighlightComment">  /// since tail duplication affects placement decisions of later blocks, it</span></CodeLine>
<Link id="l00418" /><CodeLine lineNumber="418"><span class="doxyHighlightComment">  /// must be done inline.</span></CodeLine>
<Link id="l00419" /><CodeLine lineNumber="419"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/tailduplicator">TailDuplicator</a> TailDup;</span></CodeLine>
<Link id="l00420" /><CodeLine lineNumber="420"></CodeLine>
<Link id="l00421" /><CodeLine lineNumber="421"><span class="doxyHighlightComment">  /// Partial tail duplication threshold.</span></CodeLine>
<Link id="l00422" /><CodeLine lineNumber="422"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> DupThreshold;</span></CodeLine>
<Link id="l00423" /><CodeLine lineNumber="423"></CodeLine>
<Link id="l00424" /><CodeLine lineNumber="424"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> TailDupSize;</span></CodeLine>
<Link id="l00425" /><CodeLine lineNumber="425"></CodeLine>
<Link id="l00426" /><CodeLine lineNumber="426"><span class="doxyHighlightComment">  /// True:  use block profile count to compute tail duplication cost.</span></CodeLine>
<Link id="l00427" /><CodeLine lineNumber="427"><span class="doxyHighlightComment">  /// False: use block frequency to compute tail duplication cost.</span></CodeLine>
<Link id="l00428" /><CodeLine lineNumber="428"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> UseProfileCount = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00429" /><CodeLine lineNumber="429"></CodeLine>
<Link id="l00430" /><CodeLine lineNumber="430"><span class="doxyHighlightComment">  /// Allocator and owner of BlockChain structures.</span></CodeLine>
<Link id="l00431" /><CodeLine lineNumber="431"><span class="doxyHighlightComment">  ///</span></CodeLine>
<Link id="l00432" /><CodeLine lineNumber="432"><span class="doxyHighlightComment">  /// We build BlockChains lazily while processing the loop structure of</span></CodeLine>
<Link id="l00433" /><CodeLine lineNumber="433"><span class="doxyHighlightComment">  /// a function. To reduce malloc traffic, we allocate them using this</span></CodeLine>
<Link id="l00434" /><CodeLine lineNumber="434"><span class="doxyHighlightComment">  /// slab-like allocator, and destroy them after the pass completes. An</span></CodeLine>
<Link id="l00435" /><CodeLine lineNumber="435"><span class="doxyHighlightComment">  /// important guarantee is that this allocator produces stable pointers to</span></CodeLine>
<Link id="l00436" /><CodeLine lineNumber="436"><span class="doxyHighlightComment">  /// the chains.</span></CodeLine>
<Link id="l00437" /><CodeLine lineNumber="437"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/specificbumpptrallocator">SpecificBumpPtrAllocator&lt;BlockChain&gt;</a> ChainAllocator;</span></CodeLine>
<Link id="l00438" /><CodeLine lineNumber="438"></CodeLine>
<Link id="l00439" /><CodeLine lineNumber="439"><span class="doxyHighlightComment">  /// Function wide BasicBlock to BlockChain mapping.</span></CodeLine>
<Link id="l00440" /><CodeLine lineNumber="440"><span class="doxyHighlightComment">  ///</span></CodeLine>
<Link id="l00441" /><CodeLine lineNumber="441"><span class="doxyHighlightComment">  /// This mapping allows efficiently moving from any given basic block to the</span></CodeLine>
<Link id="l00442" /><CodeLine lineNumber="442"><span class="doxyHighlightComment">  /// BlockChain it participates in, if any. We use it to, among other things,</span></CodeLine>
<Link id="l00443" /><CodeLine lineNumber="443"><span class="doxyHighlightComment">  /// allow implicitly defining edges between chains as the existing edges</span></CodeLine>
<Link id="l00444" /><CodeLine lineNumber="444"><span class="doxyHighlightComment">  /// between basic blocks.</span></CodeLine>
<Link id="l00445" /><CodeLine lineNumber="445"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/densemap">DenseMap&lt;const MachineBasicBlock &#42;, BlockChain &#42;&gt;</a> BlockToChain;</span></CodeLine>
<Link id="l00446" /><CodeLine lineNumber="446"></CodeLine>
<Link id="l00447" /><CodeLine lineNumber="447"><span class="doxyHighlightPreprocessor">#ifndef NDEBUG</span></CodeLine>
<Link id="l00448" /><CodeLine lineNumber="448"><span class="doxyHighlightComment">  /// The set of basic blocks that have terminators that cannot be fully</span></CodeLine>
<Link id="l00449" /><CodeLine lineNumber="449"><span class="doxyHighlightComment">  /// analyzed.  These basic blocks cannot be re-ordered safely by</span></CodeLine>
<Link id="l00450" /><CodeLine lineNumber="450"><span class="doxyHighlightComment">  /// MachineBlockPlacement, and we must preserve physical layout of these</span></CodeLine>
<Link id="l00451" /><CodeLine lineNumber="451"><span class="doxyHighlightComment">  /// blocks and their successors through the pass.</span></CodeLine>
<Link id="l00452" /><CodeLine lineNumber="452"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;MachineBasicBlock &#42;, 4&gt;</a> BlocksWithUnanalyzableExits;</span></CodeLine>
<Link id="l00453" /><CodeLine lineNumber="453"><span class="doxyHighlightPreprocessor">#endif</span></CodeLine>
<Link id="l00454" /><CodeLine lineNumber="454"></CodeLine>
<Link id="l00455" /><CodeLine lineNumber="455"><span class="doxyHighlightComment">  /// Get block profile count or frequency according to UseProfileCount.</span></CodeLine>
<Link id="l00456" /><CodeLine lineNumber="456"><span class="doxyHighlightComment">  /// The return value is used to model tail duplication cost.</span></CodeLine>
<Link id="l00457" /><CodeLine lineNumber="457"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> getBlockCountOrFrequency(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB) &#123;</span></CodeLine>
<Link id="l00458" /><CodeLine lineNumber="458"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (UseProfileCount) &#123;</span></CodeLine>
<Link id="l00459" /><CodeLine lineNumber="459"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a> = MBFI-&gt;getBlockProfileCount(BB);</span></CodeLine>
<Link id="l00460" /><CodeLine lineNumber="460"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a>)</span></CodeLine>
<Link id="l00461" /><CodeLine lineNumber="461"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>(&#42;<a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a>);</span></CodeLine>
<Link id="l00462" /><CodeLine lineNumber="462"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00463" /><CodeLine lineNumber="463"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>(0);</span></CodeLine>
<Link id="l00464" /><CodeLine lineNumber="464"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00465" /><CodeLine lineNumber="465"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> MBFI-&gt;getBlockFreq(BB);</span></CodeLine>
<Link id="l00466" /><CodeLine lineNumber="466"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00467" /><CodeLine lineNumber="467"></CodeLine>
<Link id="l00468" /><CodeLine lineNumber="468"><span class="doxyHighlightComment">  /// Scale the DupThreshold according to basic block size.</span></CodeLine>
<Link id="l00469" /><CodeLine lineNumber="469"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> scaleThreshold(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB);</span></CodeLine>
<Link id="l00470" /><CodeLine lineNumber="470"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> initTailDupThreshold();</span></CodeLine>
<Link id="l00471" /><CodeLine lineNumber="471"></CodeLine>
<Link id="l00472" /><CodeLine lineNumber="472"><span class="doxyHighlightComment">  /// Decrease the UnscheduledPredecessors count for all blocks in chain, and</span></CodeLine>
<Link id="l00473" /><CodeLine lineNumber="473"><span class="doxyHighlightComment">  /// if the count goes to 0, add them to the appropriate work list.</span></CodeLine>
<Link id="l00474" /><CodeLine lineNumber="474"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> markChainSuccessors(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain">BlockChain</a> &amp;Chain,</span></CodeLine>
<Link id="l00475" /><CodeLine lineNumber="475"><span class="doxyHighlight">                           </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;LoopHeaderBB,</span></CodeLine>
<Link id="l00476" /><CodeLine lineNumber="476"><span class="doxyHighlight">                           </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00477" /><CodeLine lineNumber="477"></CodeLine>
<Link id="l00478" /><CodeLine lineNumber="478"><span class="doxyHighlightComment">  /// Decrease the UnscheduledPredecessors count for a single block, and</span></CodeLine>
<Link id="l00479" /><CodeLine lineNumber="479"><span class="doxyHighlightComment">  /// if the count goes to 0, add them to the appropriate work list.</span></CodeLine>
<Link id="l00480" /><CodeLine lineNumber="480"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> markBlockSuccessors(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain">BlockChain</a> &amp;Chain, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB,</span></CodeLine>
<Link id="l00481" /><CodeLine lineNumber="481"><span class="doxyHighlight">                           </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;LoopHeaderBB,</span></CodeLine>
<Link id="l00482" /><CodeLine lineNumber="482"><span class="doxyHighlight">                           </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00483" /><CodeLine lineNumber="483"></CodeLine>
<Link id="l00484" /><CodeLine lineNumber="484"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a></span></CodeLine>
<Link id="l00485" /><CodeLine lineNumber="485"><span class="doxyHighlight">  collectViableSuccessors(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain">BlockChain</a> &amp;Chain,</span></CodeLine>
<Link id="l00486" /><CodeLine lineNumber="486"><span class="doxyHighlight">                          </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter,</span></CodeLine>
<Link id="l00487" /><CodeLine lineNumber="487"><span class="doxyHighlight">                          <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineBasicBlock &#42;, 4&gt;</a> &amp;Successors);</span></CodeLine>
<Link id="l00488" /><CodeLine lineNumber="488"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> isBestSuccessor(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB, <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Pred,</span></CodeLine>
<Link id="l00489" /><CodeLine lineNumber="489"><span class="doxyHighlight">                       BlockFilterSet &#42;BlockFilter);</span></CodeLine>
<Link id="l00490" /><CodeLine lineNumber="490"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> findDuplicateCandidates(<a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;MachineBasicBlock &#42;&gt;</a> &amp;Candidates,</span></CodeLine>
<Link id="l00491" /><CodeLine lineNumber="491"><span class="doxyHighlight">                               <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB,</span></CodeLine>
<Link id="l00492" /><CodeLine lineNumber="492"><span class="doxyHighlight">                               BlockFilterSet &#42;BlockFilter);</span></CodeLine>
<Link id="l00493" /><CodeLine lineNumber="493"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> repeatedlyTailDuplicateBlock(</span></CodeLine>
<Link id="l00494" /><CodeLine lineNumber="494"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB, <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;&amp;LPred,</span></CodeLine>
<Link id="l00495" /><CodeLine lineNumber="495"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;LoopHeaderBB, <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain">BlockChain</a> &amp;Chain,</span></CodeLine>
<Link id="l00496" /><CodeLine lineNumber="496"><span class="doxyHighlight">      BlockFilterSet &#42;BlockFilter,</span></CodeLine>
<Link id="l00497" /><CodeLine lineNumber="497"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/machinefunction/#aaba82c71ffdca966cad10eae0992fff9">MachineFunction::iterator</a> &amp;PrevUnplacedBlockIt,</span></CodeLine>
<Link id="l00498" /><CodeLine lineNumber="498"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/setvector/#a813fd00ac7e5e3261ffe67f9322a5480">BlockFilterSet::iterator</a> &amp;PrevUnplacedBlockInFilterIt);</span></CodeLine>
<Link id="l00499" /><CodeLine lineNumber="499"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span></CodeLine>
<Link id="l00500" /><CodeLine lineNumber="500"><span class="doxyHighlight">  maybeTailDuplicateBlock(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB, <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;LPred,</span></CodeLine>
<Link id="l00501" /><CodeLine lineNumber="501"><span class="doxyHighlight">                          <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain">BlockChain</a> &amp;Chain, BlockFilterSet &#42;BlockFilter,</span></CodeLine>
<Link id="l00502" /><CodeLine lineNumber="502"><span class="doxyHighlight">                          <a href="/docs/api/classes/llvm/machinefunction/#aaba82c71ffdca966cad10eae0992fff9">MachineFunction::iterator</a> &amp;PrevUnplacedBlockIt,</span></CodeLine>
<Link id="l00503" /><CodeLine lineNumber="503"><span class="doxyHighlight">                          <a href="/docs/api/classes/llvm/setvector/#a813fd00ac7e5e3261ffe67f9322a5480">BlockFilterSet::iterator</a> &amp;PrevUnplacedBlockInFilterIt,</span></CodeLine>
<Link id="l00504" /><CodeLine lineNumber="504"><span class="doxyHighlight">                          </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> &amp;DuplicatedToLPred);</span></CodeLine>
<Link id="l00505" /><CodeLine lineNumber="505"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> hasBetterLayoutPredecessor(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB,</span></CodeLine>
<Link id="l00506" /><CodeLine lineNumber="506"><span class="doxyHighlight">                                  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ,</span></CodeLine>
<Link id="l00507" /><CodeLine lineNumber="507"><span class="doxyHighlight">                                  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain">BlockChain</a> &amp;SuccChain,</span></CodeLine>
<Link id="l00508" /><CodeLine lineNumber="508"><span class="doxyHighlight">                                  <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> SuccProb,</span></CodeLine>
<Link id="l00509" /><CodeLine lineNumber="509"><span class="doxyHighlight">                                  <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> RealSuccProb,</span></CodeLine>
<Link id="l00510" /><CodeLine lineNumber="510"><span class="doxyHighlight">                                  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain">BlockChain</a> &amp;Chain,</span></CodeLine>
<Link id="l00511" /><CodeLine lineNumber="511"><span class="doxyHighlight">                                  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter);</span></CodeLine>
<Link id="l00512" /><CodeLine lineNumber="512"><span class="doxyHighlight">  BlockAndTailDupResult selectBestSuccessor(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB,</span></CodeLine>
<Link id="l00513" /><CodeLine lineNumber="513"><span class="doxyHighlight">                                            </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain">BlockChain</a> &amp;Chain,</span></CodeLine>
<Link id="l00514" /><CodeLine lineNumber="514"><span class="doxyHighlight">                                            </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter);</span></CodeLine>
<Link id="l00515" /><CodeLine lineNumber="515"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;</span></CodeLine>
<Link id="l00516" /><CodeLine lineNumber="516"><span class="doxyHighlight">  selectBestCandidateBlock(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain">BlockChain</a> &amp;Chain,</span></CodeLine>
<Link id="l00517" /><CodeLine lineNumber="517"><span class="doxyHighlight">                           <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;MachineBasicBlock &#42;&gt;</a> &amp;WorkList);</span></CodeLine>
<Link id="l00518" /><CodeLine lineNumber="518"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;</span></CodeLine>
<Link id="l00519" /><CodeLine lineNumber="519"><span class="doxyHighlight">  getFirstUnplacedBlock(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain">BlockChain</a> &amp;PlacedChain,</span></CodeLine>
<Link id="l00520" /><CodeLine lineNumber="520"><span class="doxyHighlight">                        <a href="/docs/api/classes/llvm/machinefunction/#aaba82c71ffdca966cad10eae0992fff9">MachineFunction::iterator</a> &amp;PrevUnplacedBlockIt);</span></CodeLine>
<Link id="l00521" /><CodeLine lineNumber="521"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;</span></CodeLine>
<Link id="l00522" /><CodeLine lineNumber="522"><span class="doxyHighlight">  getFirstUnplacedBlock(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain">BlockChain</a> &amp;PlacedChain,</span></CodeLine>
<Link id="l00523" /><CodeLine lineNumber="523"><span class="doxyHighlight">                        <a href="/docs/api/classes/llvm/setvector/#a813fd00ac7e5e3261ffe67f9322a5480">BlockFilterSet::iterator</a> &amp;PrevUnplacedBlockInFilterIt,</span></CodeLine>
<Link id="l00524" /><CodeLine lineNumber="524"><span class="doxyHighlight">                        </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter);</span></CodeLine>
<Link id="l00525" /><CodeLine lineNumber="525"></CodeLine>
<Link id="l00526" /><CodeLine lineNumber="526"><span class="doxyHighlightComment">  /// Add a basic block to the work list if it is appropriate.</span></CodeLine>
<Link id="l00527" /><CodeLine lineNumber="527"><span class="doxyHighlightComment">  ///</span></CodeLine>
<Link id="l00528" /><CodeLine lineNumber="528"><span class="doxyHighlightComment">  /// If the optional parameter BlockFilter is provided, only MBB</span></CodeLine>
<Link id="l00529" /><CodeLine lineNumber="529"><span class="doxyHighlightComment">  /// present in the set will be added to the worklist. If nullptr</span></CodeLine>
<Link id="l00530" /><CodeLine lineNumber="530"><span class="doxyHighlightComment">  /// is provided, no filtering occurs.</span></CodeLine>
<Link id="l00531" /><CodeLine lineNumber="531"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> fillWorkLists(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>,</span></CodeLine>
<Link id="l00532" /><CodeLine lineNumber="532"><span class="doxyHighlight">                     <a href="/docs/api/classes/llvm/smallptrsetimpl">SmallPtrSetImpl&lt;BlockChain &#42;&gt;</a> &amp;UpdatedPreds,</span></CodeLine>
<Link id="l00533" /><CodeLine lineNumber="533"><span class="doxyHighlight">                     </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter);</span></CodeLine>
<Link id="l00534" /><CodeLine lineNumber="534"></CodeLine>
<Link id="l00535" /><CodeLine lineNumber="535"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> buildChain(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB, <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain">BlockChain</a> &amp;Chain,</span></CodeLine>
<Link id="l00536" /><CodeLine lineNumber="536"><span class="doxyHighlight">                  BlockFilterSet &#42;BlockFilter = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00537" /><CodeLine lineNumber="537"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> canMoveBottomBlockToTop(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BottomBlock,</span></CodeLine>
<Link id="l00538" /><CodeLine lineNumber="538"><span class="doxyHighlight">                               </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;OldTop);</span></CodeLine>
<Link id="l00539" /><CodeLine lineNumber="539"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> hasViableTopFallthrough(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Top,</span></CodeLine>
<Link id="l00540" /><CodeLine lineNumber="540"><span class="doxyHighlight">                               </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &amp;LoopBlockSet);</span></CodeLine>
<Link id="l00541" /><CodeLine lineNumber="541"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> TopFallThroughFreq(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Top,</span></CodeLine>
<Link id="l00542" /><CodeLine lineNumber="542"><span class="doxyHighlight">                                    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &amp;LoopBlockSet);</span></CodeLine>
<Link id="l00543" /><CodeLine lineNumber="543"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> FallThroughGains(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;NewTop,</span></CodeLine>
<Link id="l00544" /><CodeLine lineNumber="544"><span class="doxyHighlight">                                  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;OldTop,</span></CodeLine>
<Link id="l00545" /><CodeLine lineNumber="545"><span class="doxyHighlight">                                  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;ExitBB,</span></CodeLine>
<Link id="l00546" /><CodeLine lineNumber="546"><span class="doxyHighlight">                                  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &amp;LoopBlockSet);</span></CodeLine>
<Link id="l00547" /><CodeLine lineNumber="547"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;findBestLoopTopHelper(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;OldTop,</span></CodeLine>
<Link id="l00548" /><CodeLine lineNumber="548"><span class="doxyHighlight">                                           </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machineloop">MachineLoop</a> &amp;L,</span></CodeLine>
<Link id="l00549" /><CodeLine lineNumber="549"><span class="doxyHighlight">                                           </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &amp;LoopBlockSet);</span></CodeLine>
<Link id="l00550" /><CodeLine lineNumber="550"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;findBestLoopTop(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machineloop">MachineLoop</a> &amp;L,</span></CodeLine>
<Link id="l00551" /><CodeLine lineNumber="551"><span class="doxyHighlight">                                     </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &amp;LoopBlockSet);</span></CodeLine>
<Link id="l00552" /><CodeLine lineNumber="552"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;findBestLoopExit(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machineloop">MachineLoop</a> &amp;L,</span></CodeLine>
<Link id="l00553" /><CodeLine lineNumber="553"><span class="doxyHighlight">                                      </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &amp;LoopBlockSet,</span></CodeLine>
<Link id="l00554" /><CodeLine lineNumber="554"><span class="doxyHighlight">                                      <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> &amp;ExitFreq);</span></CodeLine>
<Link id="l00555" /><CodeLine lineNumber="555"><span class="doxyHighlight">  BlockFilterSet collectLoopBlockSet(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machineloop">MachineLoop</a> &amp;L);</span></CodeLine>
<Link id="l00556" /><CodeLine lineNumber="556"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> buildLoopChains(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machineloop">MachineLoop</a> &amp;L);</span></CodeLine>
<Link id="l00557" /><CodeLine lineNumber="557"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> rotateLoop(<a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain">BlockChain</a> &amp;LoopChain, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;ExitingBB,</span></CodeLine>
<Link id="l00558" /><CodeLine lineNumber="558"><span class="doxyHighlight">                  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> ExitFreq, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &amp;LoopBlockSet);</span></CodeLine>
<Link id="l00559" /><CodeLine lineNumber="559"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> rotateLoopWithProfile(<a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain">BlockChain</a> &amp;LoopChain, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machineloop">MachineLoop</a> &amp;L,</span></CodeLine>
<Link id="l00560" /><CodeLine lineNumber="560"><span class="doxyHighlight">                             </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &amp;LoopBlockSet);</span></CodeLine>
<Link id="l00561" /><CodeLine lineNumber="561"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> buildCFGChains();</span></CodeLine>
<Link id="l00562" /><CodeLine lineNumber="562"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> optimizeBranches();</span></CodeLine>
<Link id="l00563" /><CodeLine lineNumber="563"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> alignBlocks();</span></CodeLine>
<Link id="l00564" /><CodeLine lineNumber="564"><span class="doxyHighlightComment">  /// Returns true if a block should be tail-duplicated to increase fallthrough</span></CodeLine>
<Link id="l00565" /><CodeLine lineNumber="565"><span class="doxyHighlightComment">  /// opportunities.</span></CodeLine>
<Link id="l00566" /><CodeLine lineNumber="566"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> shouldTailDuplicate(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB);</span></CodeLine>
<Link id="l00567" /><CodeLine lineNumber="567"><span class="doxyHighlightComment">  /// Check the edge frequencies to see if tail duplication will increase</span></CodeLine>
<Link id="l00568" /><CodeLine lineNumber="568"><span class="doxyHighlightComment">  /// fallthroughs.</span></CodeLine>
<Link id="l00569" /><CodeLine lineNumber="569"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> isProfitableToTailDup(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB,</span></CodeLine>
<Link id="l00570" /><CodeLine lineNumber="570"><span class="doxyHighlight">                             </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ,</span></CodeLine>
<Link id="l00571" /><CodeLine lineNumber="571"><span class="doxyHighlight">                             <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> QProb, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain">BlockChain</a> &amp;Chain,</span></CodeLine>
<Link id="l00572" /><CodeLine lineNumber="572"><span class="doxyHighlight">                             </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter);</span></CodeLine>
<Link id="l00573" /><CodeLine lineNumber="573"></CodeLine>
<Link id="l00574" /><CodeLine lineNumber="574"><span class="doxyHighlightComment">  /// Check for a trellis layout.</span></CodeLine>
<Link id="l00575" /><CodeLine lineNumber="575"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> isTrellis(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB,</span></CodeLine>
<Link id="l00576" /><CodeLine lineNumber="576"><span class="doxyHighlight">                 </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;MachineBasicBlock &#42;&gt;</a> &amp;ViableSuccs,</span></CodeLine>
<Link id="l00577" /><CodeLine lineNumber="577"><span class="doxyHighlight">                 </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain">BlockChain</a> &amp;Chain, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter);</span></CodeLine>
<Link id="l00578" /><CodeLine lineNumber="578"></CodeLine>
<Link id="l00579" /><CodeLine lineNumber="579"><span class="doxyHighlightComment">  /// Get the best successor given a trellis layout.</span></CodeLine>
<Link id="l00580" /><CodeLine lineNumber="580"><span class="doxyHighlight">  BlockAndTailDupResult getBestTrellisSuccessor(</span></CodeLine>
<Link id="l00581" /><CodeLine lineNumber="581"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB,</span></CodeLine>
<Link id="l00582" /><CodeLine lineNumber="582"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;MachineBasicBlock &#42;&gt;</a> &amp;ViableSuccs,</span></CodeLine>
<Link id="l00583" /><CodeLine lineNumber="583"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> AdjustedSumProb, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain">BlockChain</a> &amp;Chain,</span></CodeLine>
<Link id="l00584" /><CodeLine lineNumber="584"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter);</span></CodeLine>
<Link id="l00585" /><CodeLine lineNumber="585"></CodeLine>
<Link id="l00586" /><CodeLine lineNumber="586"><span class="doxyHighlightComment">  /// Get the best pair of non-conflicting edges.</span></CodeLine>
<Link id="l00587" /><CodeLine lineNumber="587"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> std::pair&lt;WeightedEdge, WeightedEdge&gt; getBestNonConflictingEdges(</span></CodeLine>
<Link id="l00588" /><CodeLine lineNumber="588"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB,</span></CodeLine>
<Link id="l00589" /><CodeLine lineNumber="589"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/mutablearrayref">MutableArrayRef</a>&lt;<a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;WeightedEdge, 8&gt;</a>&gt; Edges);</span></CodeLine>
<Link id="l00590" /><CodeLine lineNumber="590"></CodeLine>
<Link id="l00591" /><CodeLine lineNumber="591"><span class="doxyHighlightComment">  /// Returns true if a block can tail duplicate into all unplaced</span></CodeLine>
<Link id="l00592" /><CodeLine lineNumber="592"><span class="doxyHighlightComment">  /// predecessors. Filters based on loop.</span></CodeLine>
<Link id="l00593" /><CodeLine lineNumber="593"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> canTailDuplicateUnplacedPreds(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB,</span></CodeLine>
<Link id="l00594" /><CodeLine lineNumber="594"><span class="doxyHighlight">                                     <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ,</span></CodeLine>
<Link id="l00595" /><CodeLine lineNumber="595"><span class="doxyHighlight">                                     </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain">BlockChain</a> &amp;Chain,</span></CodeLine>
<Link id="l00596" /><CodeLine lineNumber="596"><span class="doxyHighlight">                                     </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter);</span></CodeLine>
<Link id="l00597" /><CodeLine lineNumber="597"></CodeLine>
<Link id="l00598" /><CodeLine lineNumber="598"><span class="doxyHighlightComment">  /// Find chains of triangles to tail-duplicate where a global analysis works,</span></CodeLine>
<Link id="l00599" /><CodeLine lineNumber="599"><span class="doxyHighlightComment">  /// but a local analysis would not find them.</span></CodeLine>
<Link id="l00600" /><CodeLine lineNumber="600"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> precomputeTriangleChains();</span></CodeLine>
<Link id="l00601" /><CodeLine lineNumber="601"></CodeLine>
<Link id="l00602" /><CodeLine lineNumber="602"><span class="doxyHighlightComment">  /// Apply a post-processing step optimizing block placement.</span></CodeLine>
<Link id="l00603" /><CodeLine lineNumber="603"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> applyExtTsp(</span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> OptForSize);</span></CodeLine>
<Link id="l00604" /><CodeLine lineNumber="604"></CodeLine>
<Link id="l00605" /><CodeLine lineNumber="605"><span class="doxyHighlightComment">  /// Modify the existing block placement in the function and adjust all jumps.</span></CodeLine>
<Link id="l00606" /><CodeLine lineNumber="606"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> assignBlockOrder(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> std::vector&lt;const MachineBasicBlock &#42;&gt; &amp;NewOrder);</span></CodeLine>
<Link id="l00607" /><CodeLine lineNumber="607"></CodeLine>
<Link id="l00608" /><CodeLine lineNumber="608"><span class="doxyHighlightComment">  /// Create a single CFG chain from the current block order.</span></CodeLine>
<Link id="l00609" /><CodeLine lineNumber="609"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> createCFGChainExtTsp();</span></CodeLine>
<Link id="l00610" /><CodeLine lineNumber="610"></CodeLine>
<Link id="l00611" /><CodeLine lineNumber="611"><span class="doxyHighlightKeyword">public</span><span class="doxyHighlight">:</span></CodeLine>
<Link id="l00612" /><CodeLine lineNumber="612" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#a4944db6b12999ee0713352c27e8125e4"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">char</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#a4944db6b12999ee0713352c27e8125e4">ID</a>; </span><span class="doxyHighlightComment">// Pass identification, replacement for typeid</span></CodeLine>
<Link id="l00613" /><CodeLine lineNumber="613"></CodeLine>
<Link id="l00614" /><CodeLine lineNumber="614" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#ad7175334e09f55bf7b5fb08d9522449e"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#ad7175334e09f55bf7b5fb08d9522449e">MachineBlockPlacement</a>() : <a href="/docs/api/classes/llvm/machinefunctionpass/#a29c81d2386f4a727c6d33413807530c8">MachineFunctionPass</a>(<a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#a4944db6b12999ee0713352c27e8125e4">ID</a>) &#123;</span></CodeLine>
<Link id="l00615" /><CodeLine lineNumber="615"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#af3e08655b0654029c7cf037651c8d7d6">initializeMachineBlockPlacementPass</a>(&#42;<a href="/docs/api/classes/llvm/passregistry/#a05a729900b76c89e808c6c3094921b2f">PassRegistry::getPassRegistry</a>());</span></CodeLine>
<Link id="l00616" /><CodeLine lineNumber="616"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00617" /><CodeLine lineNumber="617"></CodeLine>
<Link id="l00618" /><CodeLine lineNumber="618"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> runOnMachineFunction(<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) </span><span class="doxyHighlightKeyword">override</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00619" /><CodeLine lineNumber="619"></CodeLine>
<Link id="l00620" /><CodeLine lineNumber="620" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#ad65badde897b7d4f51fc7c545538a388"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#ad65badde897b7d4f51fc7c545538a388">allowTailDupPlacement</a>()</span><span class="doxyHighlightKeyword"> const </span><span class="doxyHighlight">&#123;</span></CodeLine>
<Link id="l00621" /><CodeLine lineNumber="621"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(F);</span></CodeLine>
<Link id="l00622" /><CodeLine lineNumber="622"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="#abf71e6f582691ae8bdf8ed170fb11ae6">TailDupPlacement</a> &amp;&amp; !F-&gt;getTarget().requiresStructuredCFG();</span></CodeLine>
<Link id="l00623" /><CodeLine lineNumber="623"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00624" /><CodeLine lineNumber="624"></CodeLine>
<Link id="l00625" /><CodeLine lineNumber="625" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#a237eea84de9a4035f23734cb04d32389"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#a237eea84de9a4035f23734cb04d32389">getAnalysisUsage</a>(<a href="/docs/api/classes/llvm/analysisusage">AnalysisUsage</a> &amp;AU)</span><span class="doxyHighlightKeyword"> const override </span><span class="doxyHighlight">&#123;</span></CodeLine>
<Link id="l00626" /><CodeLine lineNumber="626"><span class="doxyHighlight">    AU.<a href="/docs/api/classes/llvm/analysisusage/#ae0adcccca08fb686c9ce00f9397b660c">addRequired</a>&lt;<a href="/docs/api/classes/llvm/machinebranchprobabilityinfowrapperpass">MachineBranchProbabilityInfoWrapperPass</a>&gt;();</span></CodeLine>
<Link id="l00627" /><CodeLine lineNumber="627"><span class="doxyHighlight">    AU.<a href="/docs/api/classes/llvm/analysisusage/#ae0adcccca08fb686c9ce00f9397b660c">addRequired</a>&lt;<a href="/docs/api/classes/llvm/machineblockfrequencyinfowrapperpass">MachineBlockFrequencyInfoWrapperPass</a>&gt;();</span></CodeLine>
<Link id="l00628" /><CodeLine lineNumber="628"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#abf71e6f582691ae8bdf8ed170fb11ae6">TailDupPlacement</a>)</span></CodeLine>
<Link id="l00629" /><CodeLine lineNumber="629"><span class="doxyHighlight">      AU.<a href="/docs/api/classes/llvm/analysisusage/#ae0adcccca08fb686c9ce00f9397b660c">addRequired</a>&lt;<a href="/docs/api/classes/llvm/machinepostdominatortreewrapperpass">MachinePostDominatorTreeWrapperPass</a>&gt;();</span></CodeLine>
<Link id="l00630" /><CodeLine lineNumber="630"><span class="doxyHighlight">    AU.<a href="/docs/api/classes/llvm/analysisusage/#ae0adcccca08fb686c9ce00f9397b660c">addRequired</a>&lt;<a href="/docs/api/classes/llvm/machineloopinfowrapperpass">MachineLoopInfoWrapperPass</a>&gt;();</span></CodeLine>
<Link id="l00631" /><CodeLine lineNumber="631"><span class="doxyHighlight">    AU.<a href="/docs/api/classes/llvm/analysisusage/#ae0adcccca08fb686c9ce00f9397b660c">addRequired</a>&lt;<a href="/docs/api/classes/llvm/profilesummaryinfowrapperpass">ProfileSummaryInfoWrapperPass</a>&gt;();</span></CodeLine>
<Link id="l00632" /><CodeLine lineNumber="632"><span class="doxyHighlight">    AU.<a href="/docs/api/classes/llvm/analysisusage/#ae0adcccca08fb686c9ce00f9397b660c">addRequired</a>&lt;<a href="/docs/api/classes/llvm/targetpassconfig">TargetPassConfig</a>&gt;();</span></CodeLine>
<Link id="l00633" /><CodeLine lineNumber="633"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinefunctionpass/#a864fd57b4304ef933b3281d0ef85a88e">MachineFunctionPass::getAnalysisUsage</a>(AU);</span></CodeLine>
<Link id="l00634" /><CodeLine lineNumber="634"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00635" /><CodeLine lineNumber="635"><span class="doxyHighlight">&#125;;</span></CodeLine>
<Link id="l00636" /><CodeLine lineNumber="636"></CodeLine>
<Link id="l00637" /><CodeLine lineNumber="637"><span class="doxyHighlight">&#125; </span><span class="doxyHighlightComment">// end anonymous namespace</span></CodeLine>
<Link id="l00638" /><CodeLine lineNumber="638"></CodeLine>
<Link id="l00639" /><CodeLine lineNumber="639"><span class="doxyHighlightKeywordType">char</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#a4944db6b12999ee0713352c27e8125e4">MachineBlockPlacement::ID</a> = 0;</span></CodeLine>
<Link id="l00640" /><CodeLine lineNumber="640"></CodeLine>
<Link id="l00641" /><CodeLine lineNumber="641" lineLink="/docs/api/namespaces/llvm/#adc14e69cab3ee0a21fdfdd40632b7ee1"><span class="doxyHighlightKeywordType">char</span><span class="doxyHighlight"> &amp;<a href="/docs/api/namespaces/llvm/#adc14e69cab3ee0a21fdfdd40632b7ee1">llvm::MachineBlockPlacementID</a> = <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#a4944db6b12999ee0713352c27e8125e4">MachineBlockPlacement::ID</a>;</span></CodeLine>
<Link id="l00642" /><CodeLine lineNumber="642"></CodeLine>
<Link id="l00643" /><CodeLine lineNumber="643" lineLink="#aa4d0eea634133a91f99ee833a4d073ef"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/passsupport-h/#aaa970fc931c1c63037a8182e028d04b1">INITIALIZE&#95;PASS&#95;BEGIN</a>(<a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#ad7175334e09f55bf7b5fb08d9522449e">MachineBlockPlacement</a>, <a href="/docs/api/files/include/include/llvm/include/llvm/adt/genericcycleimpl-h/#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>,</span></CodeLine>
<Link id="l00644" /><CodeLine lineNumber="644"><span class="doxyHighlight">                      </span><span class="doxyHighlightStringLiteral">&quot;Branch Probability Basic Block Placement&quot;</span><span class="doxyHighlight">, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l00645" /><CodeLine lineNumber="645"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/passsupport-h/#a14724f1ccf528e73bb29bc9230737967">INITIALIZE&#95;PASS&#95;DEPENDENCY</a>(<a href="/docs/api/classes/llvm/machinebranchprobabilityinfowrapperpass">MachineBranchProbabilityInfoWrapperPass</a>)</span></CodeLine>
<Link id="l00646" /><CodeLine lineNumber="646"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/passsupport-h/#a14724f1ccf528e73bb29bc9230737967">INITIALIZE&#95;PASS&#95;DEPENDENCY</a>(<a href="/docs/api/classes/llvm/machineblockfrequencyinfowrapperpass">MachineBlockFrequencyInfoWrapperPass</a>)</span></CodeLine>
<Link id="l00647" /><CodeLine lineNumber="647"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/passsupport-h/#a14724f1ccf528e73bb29bc9230737967">INITIALIZE&#95;PASS&#95;DEPENDENCY</a>(<a href="/docs/api/classes/llvm/machinepostdominatortreewrapperpass">MachinePostDominatorTreeWrapperPass</a>)</span></CodeLine>
<Link id="l00648" /><CodeLine lineNumber="648"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/passsupport-h/#a14724f1ccf528e73bb29bc9230737967">INITIALIZE&#95;PASS&#95;DEPENDENCY</a>(<a href="/docs/api/classes/llvm/machineloopinfowrapperpass">MachineLoopInfoWrapperPass</a>)</span></CodeLine>
<Link id="l00649" /><CodeLine lineNumber="649"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/passsupport-h/#a14724f1ccf528e73bb29bc9230737967">INITIALIZE&#95;PASS&#95;DEPENDENCY</a>(<a href="/docs/api/classes/llvm/profilesummaryinfowrapperpass">ProfileSummaryInfoWrapperPass</a>)</span></CodeLine>
<Link id="l00650" /><CodeLine lineNumber="650" lineLink="#a030569d5a541b6110f2ae1b6a3413a58"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/passsupport-h/#a74ce8276b89067e806f67c45a6d92575">INITIALIZE&#95;PASS&#95;END</a>(<a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#ad7175334e09f55bf7b5fb08d9522449e">MachineBlockPlacement</a>, <a href="/docs/api/files/include/include/llvm/include/llvm/adt/genericcycleimpl-h/#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>,</span></CodeLine>
<Link id="l00651" /><CodeLine lineNumber="651" lineLink="#a80b3a35dc5c2cb6840ae523bc8d1902a"><span class="doxyHighlight">                    </span><span class="doxyHighlightStringLiteral">&quot;Branch Probability Basic Block Placement&quot;</span><span class="doxyHighlight">, <a href="/docs/api/namespaces/false">false</a>, <a href="/docs/api/namespaces/false">false</a>)</span></CodeLine>
<Link id="l00652" /><CodeLine lineNumber="652"></CodeLine>
<Link id="l00653" /><CodeLine lineNumber="653"><span class="doxyHighlightPreprocessor">#ifndef NDEBUG</span></CodeLine>
<Link id="l00654" /><CodeLine lineNumber="654"><span class="doxyHighlightComment">/// Helper to print the name of a MBB.</span></CodeLine>
<Link id="l00655" /><CodeLine lineNumber="655"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00656" /><CodeLine lineNumber="656"><span class="doxyHighlightComment">/// Only used by debug logging.</span></CodeLine>
<Link id="l00657" /><CodeLine lineNumber="657" lineLink="#a8f9ee7f9ffc036496a8663335da175fa"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> std::string <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB) &#123;</span></CodeLine>
<Link id="l00658" /><CodeLine lineNumber="658"><span class="doxyHighlight">  std::string Result;</span></CodeLine>
<Link id="l00659" /><CodeLine lineNumber="659"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/raw-string-ostream">raw&#95;string&#95;ostream</a> OS(Result);</span></CodeLine>
<Link id="l00660" /><CodeLine lineNumber="660"><span class="doxyHighlight">  OS &lt;&lt; <a href="/docs/api/namespaces/llvm/#af7881286e3ea4d7f1c4a63c87c132dac">printMBBReference</a>(&#42;BB);</span></CodeLine>
<Link id="l00661" /><CodeLine lineNumber="661"><span class="doxyHighlight">  OS &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; (&#39;&quot;</span><span class="doxyHighlight"> &lt;&lt; BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#aedf6cb1135961f41f39dc58ca8576123">getName</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;&#39;)&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00662" /><CodeLine lineNumber="662"><span class="doxyHighlight">  OS.<a href="/docs/api/classes/llvm/raw-ostream/#a520bdf57dfe3e73abb53d482893f0a27">flush</a>();</span></CodeLine>
<Link id="l00663" /><CodeLine lineNumber="663"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Result;</span></CodeLine>
<Link id="l00664" /><CodeLine lineNumber="664"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00665" /><CodeLine lineNumber="665"><span class="doxyHighlightPreprocessor">#endif</span></CodeLine>
<Link id="l00666" /><CodeLine lineNumber="666"></CodeLine>
<Link id="l00667" /><CodeLine lineNumber="667"><span class="doxyHighlightComment">/// Mark a chain&#39;s successors as having one fewer preds.</span></CodeLine>
<Link id="l00668" /><CodeLine lineNumber="668"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00669" /><CodeLine lineNumber="669"><span class="doxyHighlightComment">/// When a chain is being merged into the &quot;placed&quot; chain, this routine will</span></CodeLine>
<Link id="l00670" /><CodeLine lineNumber="670"><span class="doxyHighlightComment">/// quickly walk the successors of each block in the chain and mark them as</span></CodeLine>
<Link id="l00671" /><CodeLine lineNumber="671"><span class="doxyHighlightComment">/// having one fewer active predecessor. It also adds any successors of this</span></CodeLine>
<Link id="l00672" /><CodeLine lineNumber="672"><span class="doxyHighlightComment">/// chain which reach the zero-predecessor state to the appropriate worklist.</span></CodeLine>
<Link id="l00673" /><CodeLine lineNumber="673"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> MachineBlockPlacement::markChainSuccessors(</span></CodeLine>
<Link id="l00674" /><CodeLine lineNumber="674"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;Chain, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;LoopHeaderBB,</span></CodeLine>
<Link id="l00675" /><CodeLine lineNumber="675"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter) &#123;</span></CodeLine>
<Link id="l00676" /><CodeLine lineNumber="676"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Walk all the blocks in this chain, marking their successors as having</span></CodeLine>
<Link id="l00677" /><CodeLine lineNumber="677"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// a predecessor placed.</span></CodeLine>
<Link id="l00678" /><CodeLine lineNumber="678"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : Chain) &#123;</span></CodeLine>
<Link id="l00679" /><CodeLine lineNumber="679"><span class="doxyHighlight">    markBlockSuccessors(Chain, <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, LoopHeaderBB, BlockFilter);</span></CodeLine>
<Link id="l00680" /><CodeLine lineNumber="680"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00681" /><CodeLine lineNumber="681"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00682" /><CodeLine lineNumber="682"></CodeLine>
<Link id="l00683" /><CodeLine lineNumber="683"><span class="doxyHighlightComment">/// Mark a single block&#39;s successors as having one fewer preds.</span></CodeLine>
<Link id="l00684" /><CodeLine lineNumber="684"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00685" /><CodeLine lineNumber="685"><span class="doxyHighlightComment">/// Under normal circumstances, this is only called by markChainSuccessors,</span></CodeLine>
<Link id="l00686" /><CodeLine lineNumber="686"><span class="doxyHighlightComment">/// but if a block that was to be placed is completely tail-duplicated away,</span></CodeLine>
<Link id="l00687" /><CodeLine lineNumber="687"><span class="doxyHighlightComment">/// and was duplicated into the chain end, we need to redo markBlockSuccessors</span></CodeLine>
<Link id="l00688" /><CodeLine lineNumber="688"><span class="doxyHighlightComment">/// for just that block.</span></CodeLine>
<Link id="l00689" /><CodeLine lineNumber="689"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> MachineBlockPlacement::markBlockSuccessors(</span></CodeLine>
<Link id="l00690" /><CodeLine lineNumber="690"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;Chain, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>,</span></CodeLine>
<Link id="l00691" /><CodeLine lineNumber="691"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;LoopHeaderBB, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter) &#123;</span></CodeLine>
<Link id="l00692" /><CodeLine lineNumber="692"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Add any successors for which this is the only un-placed in-loop</span></CodeLine>
<Link id="l00693" /><CodeLine lineNumber="693"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// predecessor to the worklist as a viable candidate for CFG-neutral</span></CodeLine>
<Link id="l00694" /><CodeLine lineNumber="694"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// placement. No subsequent placement of this block will violate the CFG</span></CodeLine>
<Link id="l00695" /><CodeLine lineNumber="695"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// shape, so we get to use heuristics to choose a favorable placement.</span></CodeLine>
<Link id="l00696" /><CodeLine lineNumber="696"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ : <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>-&gt;successors()) &#123;</span></CodeLine>
<Link id="l00697" /><CodeLine lineNumber="697"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BlockFilter &amp;&amp; !BlockFilter-&gt;count(Succ))</span></CodeLine>
<Link id="l00698" /><CodeLine lineNumber="698"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00699" /><CodeLine lineNumber="699"><span class="doxyHighlight">    <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;SuccChain = &#42;BlockToChain&#91;Succ&#93;;</span></CodeLine>
<Link id="l00700" /><CodeLine lineNumber="700"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Disregard edges within a fixed chain, or edges to the loop header.</span></CodeLine>
<Link id="l00701" /><CodeLine lineNumber="701"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (&amp;Chain == &amp;SuccChain || Succ == LoopHeaderBB)</span></CodeLine>
<Link id="l00702" /><CodeLine lineNumber="702"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00703" /><CodeLine lineNumber="703"></CodeLine>
<Link id="l00704" /><CodeLine lineNumber="704"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// This is a cross-chain edge that is within the loop, so decrement the</span></CodeLine>
<Link id="l00705" /><CodeLine lineNumber="705"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// loop predecessor count of the destination chain.</span></CodeLine>
<Link id="l00706" /><CodeLine lineNumber="706"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SuccChain.UnscheduledPredecessors == 0 ||</span></CodeLine>
<Link id="l00707" /><CodeLine lineNumber="707"><span class="doxyHighlight">        --SuccChain.UnscheduledPredecessors &gt; 0)</span></CodeLine>
<Link id="l00708" /><CodeLine lineNumber="708"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00709" /><CodeLine lineNumber="709"></CodeLine>
<Link id="l00710" /><CodeLine lineNumber="710"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewBB = &#42;SuccChain.begin();</span></CodeLine>
<Link id="l00711" /><CodeLine lineNumber="711"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NewBB-&gt;isEHPad())</span></CodeLine>
<Link id="l00712" /><CodeLine lineNumber="712"><span class="doxyHighlight">      EHPadWorkList.push&#95;back(NewBB);</span></CodeLine>
<Link id="l00713" /><CodeLine lineNumber="713"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00714" /><CodeLine lineNumber="714"><span class="doxyHighlight">      BlockWorkList.push&#95;back(NewBB);</span></CodeLine>
<Link id="l00715" /><CodeLine lineNumber="715"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00716" /><CodeLine lineNumber="716"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00717" /><CodeLine lineNumber="717"></CodeLine>
<Link id="l00718" /><CodeLine lineNumber="718"><span class="doxyHighlightComment">/// This helper function collects the set of successors of block</span></CodeLine>
<Link id="l00719" /><CodeLine lineNumber="719"><span class="doxyHighlightComment">/// \\p BB that are allowed to be its layout successors, and return</span></CodeLine>
<Link id="l00720" /><CodeLine lineNumber="720"><span class="doxyHighlightComment">/// the total branch probability of edges from \\p BB to those</span></CodeLine>
<Link id="l00721" /><CodeLine lineNumber="721"><span class="doxyHighlightComment">/// blocks.</span></CodeLine>
<Link id="l00722" /><CodeLine lineNumber="722"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> MachineBlockPlacement::collectViableSuccessors(</span></CodeLine>
<Link id="l00723" /><CodeLine lineNumber="723"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;Chain,</span></CodeLine>
<Link id="l00724" /><CodeLine lineNumber="724"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter,</span></CodeLine>
<Link id="l00725" /><CodeLine lineNumber="725"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineBasicBlock &#42;, 4&gt;</a> &amp;Successors) &#123;</span></CodeLine>
<Link id="l00726" /><CodeLine lineNumber="726"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Adjust edge probabilities by excluding edges pointing to blocks that is</span></CodeLine>
<Link id="l00727" /><CodeLine lineNumber="727"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// either not in BlockFilter or is already in the current chain. Consider the</span></CodeLine>
<Link id="l00728" /><CodeLine lineNumber="728"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// following CFG:</span></CodeLine>
<Link id="l00729" /><CodeLine lineNumber="729"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00730" /><CodeLine lineNumber="730"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     ---&gt;A</span></CodeLine>
<Link id="l00731" /><CodeLine lineNumber="731"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     |  / \\</span></CodeLine>
<Link id="l00732" /><CodeLine lineNumber="732"><span class="doxyHighlightComment">  //     | B   C</span></CodeLine>
<Link id="l00733" /><CodeLine lineNumber="733"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     |  \\ / \\</span></CodeLine>
<Link id="l00734" /><CodeLine lineNumber="734"><span class="doxyHighlightComment">  //     ----D   E</span></CodeLine>
<Link id="l00735" /><CodeLine lineNumber="735"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00736" /><CodeLine lineNumber="736"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Assume A-&gt;C is very hot (&gt;90%), and C-&gt;D has a 50% probability, then after</span></CodeLine>
<Link id="l00737" /><CodeLine lineNumber="737"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// A-&gt;C is chosen as a fall-through, D won&#39;t be selected as a successor of C</span></CodeLine>
<Link id="l00738" /><CodeLine lineNumber="738"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// due to CFG constraint (the probability of C-&gt;D is not greater than</span></CodeLine>
<Link id="l00739" /><CodeLine lineNumber="739"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// HotProb to break topo-order). If we exclude E that is not in BlockFilter</span></CodeLine>
<Link id="l00740" /><CodeLine lineNumber="740"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// when calculating the probability of C-&gt;D, D will be selected and we</span></CodeLine>
<Link id="l00741" /><CodeLine lineNumber="741"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// will get A C D B as the layout of this loop.</span></CodeLine>
<Link id="l00742" /><CodeLine lineNumber="742"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> AdjustedSumProb = <a href="/docs/api/classes/llvm/branchprobability/#a56e1b2d1999aadf4c513caee1ce5275b">BranchProbability::getOne</a>();</span></CodeLine>
<Link id="l00743" /><CodeLine lineNumber="743"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ : BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#ad88ff1529541fb4e243cc8ed90b11131">successors</a>()) &#123;</span></CodeLine>
<Link id="l00744" /><CodeLine lineNumber="744"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> SkipSucc = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00745" /><CodeLine lineNumber="745"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Succ-&gt;isEHPad() || (BlockFilter &amp;&amp; !BlockFilter-&gt;count(Succ))) &#123;</span></CodeLine>
<Link id="l00746" /><CodeLine lineNumber="746"><span class="doxyHighlight">      SkipSucc = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00747" /><CodeLine lineNumber="747"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00748" /><CodeLine lineNumber="748"><span class="doxyHighlight">      <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;SuccChain = BlockToChain&#91;Succ&#93;;</span></CodeLine>
<Link id="l00749" /><CodeLine lineNumber="749"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SuccChain == &amp;Chain) &#123;</span></CodeLine>
<Link id="l00750" /><CodeLine lineNumber="750"><span class="doxyHighlight">        SkipSucc = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00751" /><CodeLine lineNumber="751"><span class="doxyHighlight">      &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Succ != &#42;SuccChain-&gt;begin()) &#123;</span></CodeLine>
<Link id="l00752" /><CodeLine lineNumber="752"><span class="doxyHighlight">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;    &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(Succ)</span></CodeLine>
<Link id="l00753" /><CodeLine lineNumber="753"><span class="doxyHighlight">                          &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; -&gt; Mid chain!\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00754" /><CodeLine lineNumber="754"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00755" /><CodeLine lineNumber="755"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00756" /><CodeLine lineNumber="756"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00757" /><CodeLine lineNumber="757"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SkipSucc)</span></CodeLine>
<Link id="l00758" /><CodeLine lineNumber="758"><span class="doxyHighlight">      AdjustedSumProb -= MBPI-&gt;getEdgeProbability(BB, Succ);</span></CodeLine>
<Link id="l00759" /><CodeLine lineNumber="759"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00760" /><CodeLine lineNumber="760"><span class="doxyHighlight">      Successors.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(Succ);</span></CodeLine>
<Link id="l00761" /><CodeLine lineNumber="761"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00762" /><CodeLine lineNumber="762"></CodeLine>
<Link id="l00763" /><CodeLine lineNumber="763"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> AdjustedSumProb;</span></CodeLine>
<Link id="l00764" /><CodeLine lineNumber="764"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00765" /><CodeLine lineNumber="765"></CodeLine>
<Link id="l00766" /><CodeLine lineNumber="766"><span class="doxyHighlightComment">/// The helper function returns the branch probability that is adjusted</span></CodeLine>
<Link id="l00767" /><CodeLine lineNumber="767"><span class="doxyHighlightComment">/// or normalized over the new total \\p AdjustedSumProb.</span></CodeLine>
<Link id="l00768" /><CodeLine lineNumber="768"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a></span></CodeLine>
<Link id="l00769" /><CodeLine lineNumber="769" lineLink="#a0a894de03271c0ccc991e40f4cdd2623"><span class="doxyHighlight"><a href="#a0a894de03271c0ccc991e40f4cdd2623">getAdjustedProbability</a>(<a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> OrigProb,</span></CodeLine>
<Link id="l00770" /><CodeLine lineNumber="770"><span class="doxyHighlight">                       <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> AdjustedSumProb) &#123;</span></CodeLine>
<Link id="l00771" /><CodeLine lineNumber="771"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> SuccProb;</span></CodeLine>
<Link id="l00772" /><CodeLine lineNumber="772"><span class="doxyHighlight">  uint32&#95;t SuccProbN = OrigProb.<a href="/docs/api/classes/llvm/branchprobability/#a7be5759bf75c903d1695fa97eca6f139">getNumerator</a>();</span></CodeLine>
<Link id="l00773" /><CodeLine lineNumber="773"><span class="doxyHighlight">  uint32&#95;t SuccProbD = AdjustedSumProb.<a href="/docs/api/classes/llvm/branchprobability/#a7be5759bf75c903d1695fa97eca6f139">getNumerator</a>();</span></CodeLine>
<Link id="l00774" /><CodeLine lineNumber="774"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SuccProbN &gt;= SuccProbD)</span></CodeLine>
<Link id="l00775" /><CodeLine lineNumber="775"><span class="doxyHighlight">    SuccProb = <a href="/docs/api/classes/llvm/branchprobability/#a56e1b2d1999aadf4c513caee1ce5275b">BranchProbability::getOne</a>();</span></CodeLine>
<Link id="l00776" /><CodeLine lineNumber="776"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00777" /><CodeLine lineNumber="777"><span class="doxyHighlight">    SuccProb = <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a>(SuccProbN, SuccProbD);</span></CodeLine>
<Link id="l00778" /><CodeLine lineNumber="778"></CodeLine>
<Link id="l00779" /><CodeLine lineNumber="779"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> SuccProb;</span></CodeLine>
<Link id="l00780" /><CodeLine lineNumber="780"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00781" /><CodeLine lineNumber="781"></CodeLine>
<Link id="l00782" /><CodeLine lineNumber="782"><span class="doxyHighlightComment">/// Check if \\p BB has exactly the successors in \\p Successors.</span></CodeLine>
<Link id="l00783" /><CodeLine lineNumber="783"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span></CodeLine>
<Link id="l00784" /><CodeLine lineNumber="784" lineLink="#ab20068697df3d13ab12e09852d99b7f7"><span class="doxyHighlight"><a href="#ab20068697df3d13ab12e09852d99b7f7">hasSameSuccessors</a>(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;BB,</span></CodeLine>
<Link id="l00785" /><CodeLine lineNumber="785"><span class="doxyHighlight">                  <a href="/docs/api/classes/llvm/smallptrsetimpl">SmallPtrSetImpl&lt;const MachineBasicBlock &#42;&gt;</a> &amp;Successors) &#123;</span></CodeLine>
<Link id="l00786" /><CodeLine lineNumber="786"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BB.<a href="/docs/api/classes/llvm/machinebasicblock/#a81626de817a0cb021ff8e915cf1942ed">succ&#95;size</a>() != Successors.<a href="/docs/api/classes/llvm/smallptrsetimplbase/#a0e1c3175b0ac22fe3853651c28e1ecb8">size</a>())</span></CodeLine>
<Link id="l00787" /><CodeLine lineNumber="787"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00788" /><CodeLine lineNumber="788"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We don&#39;t want to count self-loops</span></CodeLine>
<Link id="l00789" /><CodeLine lineNumber="789"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Successors.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(&amp;BB))</span></CodeLine>
<Link id="l00790" /><CodeLine lineNumber="790"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00791" /><CodeLine lineNumber="791"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ : BB.<a href="/docs/api/classes/llvm/machinebasicblock/#ad88ff1529541fb4e243cc8ed90b11131">successors</a>())</span></CodeLine>
<Link id="l00792" /><CodeLine lineNumber="792"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Successors.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(Succ))</span></CodeLine>
<Link id="l00793" /><CodeLine lineNumber="793"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00794" /><CodeLine lineNumber="794"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00795" /><CodeLine lineNumber="795"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00796" /><CodeLine lineNumber="796"></CodeLine>
<Link id="l00797" /><CodeLine lineNumber="797"><span class="doxyHighlightComment">/// Check if a block should be tail duplicated to increase fallthrough</span></CodeLine>
<Link id="l00798" /><CodeLine lineNumber="798"><span class="doxyHighlightComment">/// opportunities.</span></CodeLine>
<Link id="l00799" /><CodeLine lineNumber="799"><span class="doxyHighlightComment">/// \\p BB Block to check.</span></CodeLine>
<Link id="l00800" /><CodeLine lineNumber="800"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> MachineBlockPlacement::shouldTailDuplicate(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB) &#123;</span></CodeLine>
<Link id="l00801" /><CodeLine lineNumber="801"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Blocks with single successors don&#39;t create additional fallthrough</span></CodeLine>
<Link id="l00802" /><CodeLine lineNumber="802"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// opportunities. Don&#39;t duplicate them. TODO: When conditional exits are</span></CodeLine>
<Link id="l00803" /><CodeLine lineNumber="803"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// analyzable, allow them to be duplicated.</span></CodeLine>
<Link id="l00804" /><CodeLine lineNumber="804"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> IsSimple = TailDup.isSimpleBB(BB);</span></CodeLine>
<Link id="l00805" /><CodeLine lineNumber="805"></CodeLine>
<Link id="l00806" /><CodeLine lineNumber="806"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a81626de817a0cb021ff8e915cf1942ed">succ&#95;size</a>() == 1)</span></CodeLine>
<Link id="l00807" /><CodeLine lineNumber="807"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00808" /><CodeLine lineNumber="808"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> TailDup.shouldTailDuplicate(IsSimple, &#42;BB);</span></CodeLine>
<Link id="l00809" /><CodeLine lineNumber="809"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00810" /><CodeLine lineNumber="810"></CodeLine>
<Link id="l00811" /><CodeLine lineNumber="811"><span class="doxyHighlightComment">/// Compare 2 BlockFrequency&#39;s with a small penalty for \\p A.</span></CodeLine>
<Link id="l00812" /><CodeLine lineNumber="812"><span class="doxyHighlightComment">/// In order to be conservative, we apply a X% penalty to account for</span></CodeLine>
<Link id="l00813" /><CodeLine lineNumber="813"><span class="doxyHighlightComment">/// increased icache pressure and static heuristics. For small frequencies</span></CodeLine>
<Link id="l00814" /><CodeLine lineNumber="814"><span class="doxyHighlightComment">/// we use only the numerators to improve accuracy. For simplicity, we assume</span></CodeLine>
<Link id="l00815" /><CodeLine lineNumber="815"><span class="doxyHighlightComment">/// the penalty is less than 100%</span></CodeLine>
<Link id="l00816" /><CodeLine lineNumber="816"><span class="doxyHighlightComment">/// TODO(iteratee): Use 64-bit fixed point edge frequencies everywhere.</span></CodeLine>
<Link id="l00817" /><CodeLine lineNumber="817" lineLink="#a73743365177645c3db889f210cd5ad1d"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#a73743365177645c3db889f210cd5ad1d">greaterWithBias</a>(<a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#a2e38c85003a042421cde1647632d0b72">A</a>, <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>,</span></CodeLine>
<Link id="l00818" /><CodeLine lineNumber="818"><span class="doxyHighlight">                            <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> EntryFreq) &#123;</span></CodeLine>
<Link id="l00819" /><CodeLine lineNumber="819"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> ThresholdProb(<a href="#a7344284dac6ba9b8e48d9be67c954bfc">TailDupPlacementPenalty</a>, 100);</span></CodeLine>
<Link id="l00820" /><CodeLine lineNumber="820"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> Gain = <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#a2e38c85003a042421cde1647632d0b72">A</a> - <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>;</span></CodeLine>
<Link id="l00821" /><CodeLine lineNumber="821"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> (Gain / ThresholdProb) &gt;= EntryFreq;</span></CodeLine>
<Link id="l00822" /><CodeLine lineNumber="822"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00823" /><CodeLine lineNumber="823"></CodeLine>
<Link id="l00824" /><CodeLine lineNumber="824"><span class="doxyHighlightComment">/// Check the edge frequencies to see if tail duplication will increase</span></CodeLine>
<Link id="l00825" /><CodeLine lineNumber="825"><span class="doxyHighlightComment">/// fallthroughs. It only makes sense to call this function when</span></CodeLine>
<Link id="l00826" /><CodeLine lineNumber="826"><span class="doxyHighlightComment">/// \\p Succ would not be chosen otherwise. Tail duplication of \\p Succ is</span></CodeLine>
<Link id="l00827" /><CodeLine lineNumber="827"><span class="doxyHighlightComment">/// always locally profitable if we would have picked \\p Succ without</span></CodeLine>
<Link id="l00828" /><CodeLine lineNumber="828"><span class="doxyHighlightComment">/// considering duplication.</span></CodeLine>
<Link id="l00829" /><CodeLine lineNumber="829"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> MachineBlockPlacement::isProfitableToTailDup(</span></CodeLine>
<Link id="l00830" /><CodeLine lineNumber="830"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ,</span></CodeLine>
<Link id="l00831" /><CodeLine lineNumber="831"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> QProb, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;Chain,</span></CodeLine>
<Link id="l00832" /><CodeLine lineNumber="832"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter) &#123;</span></CodeLine>
<Link id="l00833" /><CodeLine lineNumber="833"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We need to do a probability calculation to make sure this is profitable.</span></CodeLine>
<Link id="l00834" /><CodeLine lineNumber="834"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// First: does succ have a successor that post-dominates? This affects the</span></CodeLine>
<Link id="l00835" /><CodeLine lineNumber="835"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// calculation. The 2 relevant cases are:</span></CodeLine>
<Link id="l00836" /><CodeLine lineNumber="836"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    BB         BB</span></CodeLine>
<Link id="l00837" /><CodeLine lineNumber="837"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    | \\Qout    | \\Qout</span></CodeLine>
<Link id="l00838" /><CodeLine lineNumber="838"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   P|  C       |P C</span></CodeLine>
<Link id="l00839" /><CodeLine lineNumber="839"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    =   C&#39;     =   C&#39;</span></CodeLine>
<Link id="l00840" /><CodeLine lineNumber="840"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    |  /Qin    |  /Qin</span></CodeLine>
<Link id="l00841" /><CodeLine lineNumber="841"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    | /        | /</span></CodeLine>
<Link id="l00842" /><CodeLine lineNumber="842"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    Succ       Succ</span></CodeLine>
<Link id="l00843" /><CodeLine lineNumber="843"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    / \\        | \\  V</span></CodeLine>
<Link id="l00844" /><CodeLine lineNumber="844"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  U/   =V      |U \\</span></CodeLine>
<Link id="l00845" /><CodeLine lineNumber="845"><span class="doxyHighlightComment">  //  /     \\      =   D</span></CodeLine>
<Link id="l00846" /><CodeLine lineNumber="846"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  D      E     |  /</span></CodeLine>
<Link id="l00847" /><CodeLine lineNumber="847"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//               | /</span></CodeLine>
<Link id="l00848" /><CodeLine lineNumber="848"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//               |/</span></CodeLine>
<Link id="l00849" /><CodeLine lineNumber="849"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//               PDom</span></CodeLine>
<Link id="l00850" /><CodeLine lineNumber="850"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  &#39;=&#39; : Branch taken for that CFG edge</span></CodeLine>
<Link id="l00851" /><CodeLine lineNumber="851"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In the second case, Placing Succ while duplicating it into C prevents the</span></CodeLine>
<Link id="l00852" /><CodeLine lineNumber="852"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// fallthrough of Succ into either D or PDom, because they now have C as an</span></CodeLine>
<Link id="l00853" /><CodeLine lineNumber="853"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// unplaced predecessor</span></CodeLine>
<Link id="l00854" /><CodeLine lineNumber="854"></CodeLine>
<Link id="l00855" /><CodeLine lineNumber="855"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Start by figuring out which case we fall into</span></CodeLine>
<Link id="l00856" /><CodeLine lineNumber="856"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;PDom = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00857" /><CodeLine lineNumber="857"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineBasicBlock &#42;, 4&gt;</a> SuccSuccs;</span></CodeLine>
<Link id="l00858" /><CodeLine lineNumber="858"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Only scan the relevant successors</span></CodeLine>
<Link id="l00859" /><CodeLine lineNumber="859"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> AdjustedSuccSumProb =</span></CodeLine>
<Link id="l00860" /><CodeLine lineNumber="860"><span class="doxyHighlight">      collectViableSuccessors(Succ, Chain, BlockFilter, SuccSuccs);</span></CodeLine>
<Link id="l00861" /><CodeLine lineNumber="861"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> PProb = MBPI-&gt;getEdgeProbability(BB, Succ);</span></CodeLine>
<Link id="l00862" /><CodeLine lineNumber="862"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/codegen/lib/codegen/asmprinter/asmprinter-cpp/#a9541bbf765f7db0b078a45d6f43c34b4a8cb28931840da67702e5bd9068512905">BBFreq</a> = MBFI-&gt;getBlockFreq(BB);</span></CodeLine>
<Link id="l00863" /><CodeLine lineNumber="863"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> SuccFreq = MBFI-&gt;getBlockFreq(Succ);</span></CodeLine>
<Link id="l00864" /><CodeLine lineNumber="864"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> <a href="/docs/api/files/lib/lib/option/option-cpp/#a04665169063c8ca1f2ea96c27fc7c2b2">P</a> = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/asmprinter/asmprinter-cpp/#a9541bbf765f7db0b078a45d6f43c34b4a8cb28931840da67702e5bd9068512905">BBFreq</a> &#42; PProb;</span></CodeLine>
<Link id="l00865" /><CodeLine lineNumber="865"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> Qout = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/asmprinter/asmprinter-cpp/#a9541bbf765f7db0b078a45d6f43c34b4a8cb28931840da67702e5bd9068512905">BBFreq</a> &#42; QProb;</span></CodeLine>
<Link id="l00866" /><CodeLine lineNumber="866"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> EntryFreq = MBFI-&gt;getEntryFreq();</span></CodeLine>
<Link id="l00867" /><CodeLine lineNumber="867"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If there are no more successors, it is profitable to copy, as it strictly</span></CodeLine>
<Link id="l00868" /><CodeLine lineNumber="868"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// increases fallthrough.</span></CodeLine>
<Link id="l00869" /><CodeLine lineNumber="869"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SuccSuccs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() == 0)</span></CodeLine>
<Link id="l00870" /><CodeLine lineNumber="870"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="#a73743365177645c3db889f210cd5ad1d">greaterWithBias</a>(<a href="/docs/api/files/lib/lib/option/option-cpp/#a04665169063c8ca1f2ea96c27fc7c2b2">P</a>, Qout, EntryFreq);</span></CodeLine>
<Link id="l00871" /><CodeLine lineNumber="871"></CodeLine>
<Link id="l00872" /><CodeLine lineNumber="872"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> BestSuccSucc = <a href="/docs/api/classes/llvm/branchprobability/#afd00958cba7080048a84cccfcef55d71">BranchProbability::getZero</a>();</span></CodeLine>
<Link id="l00873" /><CodeLine lineNumber="873"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Find the PDom or the best Succ if no PDom exists.</span></CodeLine>
<Link id="l00874" /><CodeLine lineNumber="874"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;SuccSucc : SuccSuccs) &#123;</span></CodeLine>
<Link id="l00875" /><CodeLine lineNumber="875"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Prob = MBPI-&gt;getEdgeProbability(Succ, SuccSucc);</span></CodeLine>
<Link id="l00876" /><CodeLine lineNumber="876"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Prob &gt; BestSuccSucc)</span></CodeLine>
<Link id="l00877" /><CodeLine lineNumber="877"><span class="doxyHighlight">      BestSuccSucc = Prob;</span></CodeLine>
<Link id="l00878" /><CodeLine lineNumber="878"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (PDom == </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l00879" /><CodeLine lineNumber="879"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (MPDT-&gt;dominates(SuccSucc, Succ)) &#123;</span></CodeLine>
<Link id="l00880" /><CodeLine lineNumber="880"><span class="doxyHighlight">        PDom = SuccSucc;</span></CodeLine>
<Link id="l00881" /><CodeLine lineNumber="881"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00882" /><CodeLine lineNumber="882"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00883" /><CodeLine lineNumber="883"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00884" /><CodeLine lineNumber="884"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For the comparisons, we need to know Succ&#39;s best incoming edge that isn&#39;t</span></CodeLine>
<Link id="l00885" /><CodeLine lineNumber="885"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// from BB.</span></CodeLine>
<Link id="l00886" /><CodeLine lineNumber="886"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> SuccBestPred = <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>(0);</span></CodeLine>
<Link id="l00887" /><CodeLine lineNumber="887"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;SuccPred : Succ-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#addd80df79ba902914c7d8a52e3896b79">predecessors</a>()) &#123;</span></CodeLine>
<Link id="l00888" /><CodeLine lineNumber="888"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SuccPred == Succ || SuccPred == BB ||</span></CodeLine>
<Link id="l00889" /><CodeLine lineNumber="889"><span class="doxyHighlight">        BlockToChain&#91;SuccPred&#93; == &amp;Chain ||</span></CodeLine>
<Link id="l00890" /><CodeLine lineNumber="890"><span class="doxyHighlight">        (BlockFilter &amp;&amp; !BlockFilter-&gt;count(SuccPred)))</span></CodeLine>
<Link id="l00891" /><CodeLine lineNumber="891"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00892" /><CodeLine lineNumber="892"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Freq =</span></CodeLine>
<Link id="l00893" /><CodeLine lineNumber="893"><span class="doxyHighlight">        MBFI-&gt;getBlockFreq(SuccPred) &#42; MBPI-&gt;getEdgeProbability(SuccPred, Succ);</span></CodeLine>
<Link id="l00894" /><CodeLine lineNumber="894"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Freq &gt; SuccBestPred)</span></CodeLine>
<Link id="l00895" /><CodeLine lineNumber="895"><span class="doxyHighlight">      SuccBestPred = Freq;</span></CodeLine>
<Link id="l00896" /><CodeLine lineNumber="896"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00897" /><CodeLine lineNumber="897"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Qin is Succ&#39;s best unplaced incoming edge that isn&#39;t BB</span></CodeLine>
<Link id="l00898" /><CodeLine lineNumber="898"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> Qin = SuccBestPred;</span></CodeLine>
<Link id="l00899" /><CodeLine lineNumber="899"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If it doesn&#39;t have a post-dominating successor, here is the calculation:</span></CodeLine>
<Link id="l00900" /><CodeLine lineNumber="900"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    BB        BB</span></CodeLine>
<Link id="l00901" /><CodeLine lineNumber="901"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    | \\Qout   |  \\</span></CodeLine>
<Link id="l00902" /><CodeLine lineNumber="902"><span class="doxyHighlightComment">  //   P|  C      |   =</span></CodeLine>
<Link id="l00903" /><CodeLine lineNumber="903"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    =   C&#39;    |    C</span></CodeLine>
<Link id="l00904" /><CodeLine lineNumber="904"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    |  /Qin   |     |</span></CodeLine>
<Link id="l00905" /><CodeLine lineNumber="905"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    | /       |     C&#39; (+Succ)</span></CodeLine>
<Link id="l00906" /><CodeLine lineNumber="906"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    Succ      Succ /|</span></CodeLine>
<Link id="l00907" /><CodeLine lineNumber="907"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    / \\       |  \\/ |</span></CodeLine>
<Link id="l00908" /><CodeLine lineNumber="908"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  U/   =V     |  == |</span></CodeLine>
<Link id="l00909" /><CodeLine lineNumber="909"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  /     \\     | /  \\|</span></CodeLine>
<Link id="l00910" /><CodeLine lineNumber="910"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  D      E    D     E</span></CodeLine>
<Link id="l00911" /><CodeLine lineNumber="911"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  &#39;=&#39; : Branch taken for that CFG edge</span></CodeLine>
<Link id="l00912" /><CodeLine lineNumber="912"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  Cost in the first case is: P + V</span></CodeLine>
<Link id="l00913" /><CodeLine lineNumber="913"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  For this calculation, we always assume P &gt; Qout. If Qout &gt; P</span></CodeLine>
<Link id="l00914" /><CodeLine lineNumber="914"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  The result of this function will be ignored at the caller.</span></CodeLine>
<Link id="l00915" /><CodeLine lineNumber="915"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  Let F = SuccFreq - Qin</span></CodeLine>
<Link id="l00916" /><CodeLine lineNumber="916"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  Cost in the second case is: Qout + min(Qin, F) &#42; U + max(Qin, F) &#42; V</span></CodeLine>
<Link id="l00917" /><CodeLine lineNumber="917"></CodeLine>
<Link id="l00918" /><CodeLine lineNumber="918"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (PDom == </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight"> || !Succ-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#adc8f1be4a77ae671ac139d5f06b44deb">isSuccessor</a>(PDom)) &#123;</span></CodeLine>
<Link id="l00919" /><CodeLine lineNumber="919"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> UProb = BestSuccSucc;</span></CodeLine>
<Link id="l00920" /><CodeLine lineNumber="920"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> VProb = AdjustedSuccSumProb - UProb;</span></CodeLine>
<Link id="l00921" /><CodeLine lineNumber="921"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = SuccFreq - Qin;</span></CodeLine>
<Link id="l00922" /><CodeLine lineNumber="922"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> V = SuccFreq &#42; VProb;</span></CodeLine>
<Link id="l00923" /><CodeLine lineNumber="923"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> QinU = std::min(Qin, <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#42; UProb;</span></CodeLine>
<Link id="l00924" /><CodeLine lineNumber="924"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> BaseCost = <a href="/docs/api/files/lib/lib/option/option-cpp/#a04665169063c8ca1f2ea96c27fc7c2b2">P</a> + V;</span></CodeLine>
<Link id="l00925" /><CodeLine lineNumber="925"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> DupCost = Qout + QinU + std::max(Qin, <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#42; VProb;</span></CodeLine>
<Link id="l00926" /><CodeLine lineNumber="926"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="#a73743365177645c3db889f210cd5ad1d">greaterWithBias</a>(BaseCost, DupCost, EntryFreq);</span></CodeLine>
<Link id="l00927" /><CodeLine lineNumber="927"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00928" /><CodeLine lineNumber="928"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> UProb = MBPI-&gt;getEdgeProbability(Succ, PDom);</span></CodeLine>
<Link id="l00929" /><CodeLine lineNumber="929"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> VProb = AdjustedSuccSumProb - UProb;</span></CodeLine>
<Link id="l00930" /><CodeLine lineNumber="930"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> U = SuccFreq &#42; UProb;</span></CodeLine>
<Link id="l00931" /><CodeLine lineNumber="931"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> V = SuccFreq &#42; VProb;</span></CodeLine>
<Link id="l00932" /><CodeLine lineNumber="932"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = SuccFreq - Qin;</span></CodeLine>
<Link id="l00933" /><CodeLine lineNumber="933"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If there is a post-dominating successor, here is the calculation:</span></CodeLine>
<Link id="l00934" /><CodeLine lineNumber="934"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// BB         BB                 BB          BB</span></CodeLine>
<Link id="l00935" /><CodeLine lineNumber="935"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// | \\Qout    |   \\               | \\Qout     |  \\</span></CodeLine>
<Link id="l00936" /><CodeLine lineNumber="936"><span class="doxyHighlightComment">  // |P C       |    =              |P C        |   =</span></CodeLine>
<Link id="l00937" /><CodeLine lineNumber="937"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// =   C&#39;     |P    C             =   C&#39;      |P   C</span></CodeLine>
<Link id="l00938" /><CodeLine lineNumber="938"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// |  /Qin    |      |            |  /Qin     |     |</span></CodeLine>
<Link id="l00939" /><CodeLine lineNumber="939"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// | /        |      C&#39; (+Succ)   | /         |     C&#39; (+Succ)</span></CodeLine>
<Link id="l00940" /><CodeLine lineNumber="940"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Succ       Succ  /|            Succ        Succ /|</span></CodeLine>
<Link id="l00941" /><CodeLine lineNumber="941"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// | \\  V     |   \\/ |            | \\  V      |  \\/ |</span></CodeLine>
<Link id="l00942" /><CodeLine lineNumber="942"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// |U \\       |U  /\\ =?           |U =        |U /\\ |</span></CodeLine>
<Link id="l00943" /><CodeLine lineNumber="943"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// =   D      = =  =?|            |   D       | =  =|</span></CodeLine>
<Link id="l00944" /><CodeLine lineNumber="944"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// |  /       |/     D            |  /        |/    D</span></CodeLine>
<Link id="l00945" /><CodeLine lineNumber="945"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// | /        |     /             | =         |    /</span></CodeLine>
<Link id="l00946" /><CodeLine lineNumber="946"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// |/         |    /              |/          |   =</span></CodeLine>
<Link id="l00947" /><CodeLine lineNumber="947"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Dom         Dom                Dom         Dom</span></CodeLine>
<Link id="l00948" /><CodeLine lineNumber="948"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  &#39;=&#39; : Branch taken for that CFG edge</span></CodeLine>
<Link id="l00949" /><CodeLine lineNumber="949"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The cost for taken branches in the first case is P + U</span></CodeLine>
<Link id="l00950" /><CodeLine lineNumber="950"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Let F = SuccFreq - Qin</span></CodeLine>
<Link id="l00951" /><CodeLine lineNumber="951"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The cost in the second case (assuming independence), given the layout:</span></CodeLine>
<Link id="l00952" /><CodeLine lineNumber="952"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// BB, Succ, (C+Succ), D, Dom or the layout:</span></CodeLine>
<Link id="l00953" /><CodeLine lineNumber="953"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// BB, Succ, D, Dom, (C+Succ)</span></CodeLine>
<Link id="l00954" /><CodeLine lineNumber="954"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// is Qout + max(F, Qin) &#42; U + min(F, Qin)</span></CodeLine>
<Link id="l00955" /><CodeLine lineNumber="955"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// compare P + U vs Qout + P &#42; U + Qin.</span></CodeLine>
<Link id="l00956" /><CodeLine lineNumber="956"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00957" /><CodeLine lineNumber="957"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The 3rd and 4th cases cover when Dom would be chosen to follow Succ.</span></CodeLine>
<Link id="l00958" /><CodeLine lineNumber="958"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00959" /><CodeLine lineNumber="959"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For the 3rd case, the cost is P + 2 &#42; V</span></CodeLine>
<Link id="l00960" /><CodeLine lineNumber="960"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For the 4th case, the cost is Qout + min(Qin, F) &#42; U + max(Qin, F) &#42; V + V</span></CodeLine>
<Link id="l00961" /><CodeLine lineNumber="961"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We choose 4 over 3 when (P + V) &gt; Qout + min(Qin, F) &#42; U + max(Qin, F) &#42; V</span></CodeLine>
<Link id="l00962" /><CodeLine lineNumber="962"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (UProb &gt; AdjustedSuccSumProb / 2 &amp;&amp;</span></CodeLine>
<Link id="l00963" /><CodeLine lineNumber="963"><span class="doxyHighlight">      !hasBetterLayoutPredecessor(Succ, PDom, &#42;BlockToChain&#91;PDom&#93;, UProb, UProb,</span></CodeLine>
<Link id="l00964" /><CodeLine lineNumber="964"><span class="doxyHighlight">                                  Chain, BlockFilter))</span></CodeLine>
<Link id="l00965" /><CodeLine lineNumber="965"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Cases 3 &amp; 4</span></CodeLine>
<Link id="l00966" /><CodeLine lineNumber="966"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="#a73743365177645c3db889f210cd5ad1d">greaterWithBias</a>(</span></CodeLine>
<Link id="l00967" /><CodeLine lineNumber="967"><span class="doxyHighlight">        (<a href="/docs/api/files/lib/lib/option/option-cpp/#a04665169063c8ca1f2ea96c27fc7c2b2">P</a> + V), (Qout + std::max(Qin, <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#42; VProb + std::min(Qin, <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#42; UProb),</span></CodeLine>
<Link id="l00968" /><CodeLine lineNumber="968"><span class="doxyHighlight">        EntryFreq);</span></CodeLine>
<Link id="l00969" /><CodeLine lineNumber="969"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Cases 1 &amp; 2</span></CodeLine>
<Link id="l00970" /><CodeLine lineNumber="970"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="#a73743365177645c3db889f210cd5ad1d">greaterWithBias</a>((<a href="/docs/api/files/lib/lib/option/option-cpp/#a04665169063c8ca1f2ea96c27fc7c2b2">P</a> + U),</span></CodeLine>
<Link id="l00971" /><CodeLine lineNumber="971"><span class="doxyHighlight">                         (Qout + std::min(Qin, <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#42; AdjustedSuccSumProb +</span></CodeLine>
<Link id="l00972" /><CodeLine lineNumber="972"><span class="doxyHighlight">                          std::max(Qin, <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#42; UProb),</span></CodeLine>
<Link id="l00973" /><CodeLine lineNumber="973"><span class="doxyHighlight">                         EntryFreq);</span></CodeLine>
<Link id="l00974" /><CodeLine lineNumber="974"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00975" /><CodeLine lineNumber="975"></CodeLine>
<Link id="l00976" /><CodeLine lineNumber="976"><span class="doxyHighlightComment">/// Check for a trellis layout. \\p BB is the upper part of a trellis if its</span></CodeLine>
<Link id="l00977" /><CodeLine lineNumber="977"><span class="doxyHighlightComment">/// successors form the lower part of a trellis. A successor set S forms the</span></CodeLine>
<Link id="l00978" /><CodeLine lineNumber="978"><span class="doxyHighlightComment">/// lower part of a trellis if all of the predecessors of S are either in S or</span></CodeLine>
<Link id="l00979" /><CodeLine lineNumber="979"><span class="doxyHighlightComment">/// have all of S as successors. We ignore trellises where BB doesn&#39;t have 2</span></CodeLine>
<Link id="l00980" /><CodeLine lineNumber="980"><span class="doxyHighlightComment">/// successors because for fewer than 2, it&#39;s trivial, and for 3 or greater they</span></CodeLine>
<Link id="l00981" /><CodeLine lineNumber="981"><span class="doxyHighlightComment">/// are very uncommon and complex to compute optimally. Allowing edges within S</span></CodeLine>
<Link id="l00982" /><CodeLine lineNumber="982"><span class="doxyHighlightComment">/// is not strictly a trellis, but the same algorithm works, so we allow it.</span></CodeLine>
<Link id="l00983" /><CodeLine lineNumber="983"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> MachineBlockPlacement::isTrellis(</span></CodeLine>
<Link id="l00984" /><CodeLine lineNumber="984"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB,</span></CodeLine>
<Link id="l00985" /><CodeLine lineNumber="985"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;MachineBasicBlock &#42;&gt;</a> &amp;ViableSuccs,</span></CodeLine>
<Link id="l00986" /><CodeLine lineNumber="986"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;Chain, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter) &#123;</span></CodeLine>
<Link id="l00987" /><CodeLine lineNumber="987"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Technically BB could form a trellis with branching factor higher than 2</span></CodeLine>
<Link id="l00988" /><CodeLine lineNumber="988"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// But that&#39;s extremely uncommon.</span></CodeLine>
<Link id="l00989" /><CodeLine lineNumber="989"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a81626de817a0cb021ff8e915cf1942ed">succ&#95;size</a>() != 2 || ViableSuccs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() != 2)</span></CodeLine>
<Link id="l00990" /><CodeLine lineNumber="990"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00991" /><CodeLine lineNumber="991"></CodeLine>
<Link id="l00992" /><CodeLine lineNumber="992"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;const MachineBasicBlock &#42;, 2&gt;</a> Successors(BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a6321b189ea8fd5058663f8a87d6c23e9">succ&#95;begin</a>(),</span></CodeLine>
<Link id="l00993" /><CodeLine lineNumber="993"><span class="doxyHighlight">                                                       BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a3ddd708642d60c1661992ff8ba1b215d">succ&#95;end</a>());</span></CodeLine>
<Link id="l00994" /><CodeLine lineNumber="994"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// To avoid reviewing the same predecessors twice.</span></CodeLine>
<Link id="l00995" /><CodeLine lineNumber="995"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;const MachineBasicBlock &#42;, 8&gt;</a> SeenPreds;</span></CodeLine>
<Link id="l00996" /><CodeLine lineNumber="996"></CodeLine>
<Link id="l00997" /><CodeLine lineNumber="997"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ : ViableSuccs) &#123;</span></CodeLine>
<Link id="l00998" /><CodeLine lineNumber="998"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> PredCount = 0;</span></CodeLine>
<Link id="l00999" /><CodeLine lineNumber="999"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;SuccPred : Succ-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#addd80df79ba902914c7d8a52e3896b79">predecessors</a>()) &#123;</span></CodeLine>
<Link id="l01000" /><CodeLine lineNumber="1000"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Allow triangle successors, but don&#39;t count them.</span></CodeLine>
<Link id="l01001" /><CodeLine lineNumber="1001"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Successors.count(SuccPred)) &#123;</span></CodeLine>
<Link id="l01002" /><CodeLine lineNumber="1002"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Make sure that it is actually a triangle.</span></CodeLine>
<Link id="l01003" /><CodeLine lineNumber="1003"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;CheckSucc : SuccPred-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#ad88ff1529541fb4e243cc8ed90b11131">successors</a>())</span></CodeLine>
<Link id="l01004" /><CodeLine lineNumber="1004"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Successors.count(CheckSucc))</span></CodeLine>
<Link id="l01005" /><CodeLine lineNumber="1005"><span class="doxyHighlight">            </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01006" /><CodeLine lineNumber="1006"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01007" /><CodeLine lineNumber="1007"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01008" /><CodeLine lineNumber="1008"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;PredChain = BlockToChain&#91;SuccPred&#93;;</span></CodeLine>
<Link id="l01009" /><CodeLine lineNumber="1009"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SuccPred == BB || (BlockFilter &amp;&amp; !BlockFilter-&gt;count(SuccPred)) ||</span></CodeLine>
<Link id="l01010" /><CodeLine lineNumber="1010"><span class="doxyHighlight">          PredChain == &amp;Chain || PredChain == BlockToChain&#91;Succ&#93;)</span></CodeLine>
<Link id="l01011" /><CodeLine lineNumber="1011"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01012" /><CodeLine lineNumber="1012"><span class="doxyHighlight">      ++PredCount;</span></CodeLine>
<Link id="l01013" /><CodeLine lineNumber="1013"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Perform the successor check only once.</span></CodeLine>
<Link id="l01014" /><CodeLine lineNumber="1014"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!SeenPreds.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(SuccPred).second)</span></CodeLine>
<Link id="l01015" /><CodeLine lineNumber="1015"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01016" /><CodeLine lineNumber="1016"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="#ab20068697df3d13ab12e09852d99b7f7">hasSameSuccessors</a>(&#42;SuccPred, Successors))</span></CodeLine>
<Link id="l01017" /><CodeLine lineNumber="1017"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01018" /><CodeLine lineNumber="1018"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01019" /><CodeLine lineNumber="1019"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If one of the successors has only BB as a predecessor, it is not a</span></CodeLine>
<Link id="l01020" /><CodeLine lineNumber="1020"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// trellis.</span></CodeLine>
<Link id="l01021" /><CodeLine lineNumber="1021"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (PredCount &lt; 1)</span></CodeLine>
<Link id="l01022" /><CodeLine lineNumber="1022"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01023" /><CodeLine lineNumber="1023"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01024" /><CodeLine lineNumber="1024"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01025" /><CodeLine lineNumber="1025"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01026" /><CodeLine lineNumber="1026"></CodeLine>
<Link id="l01027" /><CodeLine lineNumber="1027"><span class="doxyHighlightComment">/// Pick the highest total weight pair of edges that can both be laid out.</span></CodeLine>
<Link id="l01028" /><CodeLine lineNumber="1028"><span class="doxyHighlightComment">/// The edges in \\p Edges&#91;0&#93; are assumed to have a different destination than</span></CodeLine>
<Link id="l01029" /><CodeLine lineNumber="1029"><span class="doxyHighlightComment">/// the edges in \\p Edges&#91;1&#93;. Simple counting shows that the best pair is either</span></CodeLine>
<Link id="l01030" /><CodeLine lineNumber="1030"><span class="doxyHighlightComment">/// the individual highest weight edges to the 2 different destinations, or in</span></CodeLine>
<Link id="l01031" /><CodeLine lineNumber="1031"><span class="doxyHighlightComment">/// case of a conflict, one of them should be replaced with a 2nd best edge.</span></CodeLine>
<Link id="l01032" /><CodeLine lineNumber="1032"><span class="doxyHighlight">std::pair&lt;MachineBlockPlacement::WeightedEdge,</span></CodeLine>
<Link id="l01033" /><CodeLine lineNumber="1033"><span class="doxyHighlight">          MachineBlockPlacement::WeightedEdge&gt;</span></CodeLine>
<Link id="l01034" /><CodeLine lineNumber="1034"><span class="doxyHighlight">MachineBlockPlacement::getBestNonConflictingEdges(</span></CodeLine>
<Link id="l01035" /><CodeLine lineNumber="1035"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB,</span></CodeLine>
<Link id="l01036" /><CodeLine lineNumber="1036"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/mutablearrayref">MutableArrayRef</a>&lt;<a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineBlockPlacement::WeightedEdge, 8&gt;</a>&gt;</span></CodeLine>
<Link id="l01037" /><CodeLine lineNumber="1037"><span class="doxyHighlight">        Edges) &#123;</span></CodeLine>
<Link id="l01038" /><CodeLine lineNumber="1038"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Sort the edges, and then for each successor, find the best incoming</span></CodeLine>
<Link id="l01039" /><CodeLine lineNumber="1039"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// predecessor. If the best incoming predecessors aren&#39;t the same,</span></CodeLine>
<Link id="l01040" /><CodeLine lineNumber="1040"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// then that is clearly the best layout. If there is a conflict, one of the</span></CodeLine>
<Link id="l01041" /><CodeLine lineNumber="1041"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// successors will have to fallthrough from the second best predecessor. We</span></CodeLine>
<Link id="l01042" /><CodeLine lineNumber="1042"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// compare which combination is better overall.</span></CodeLine>
<Link id="l01043" /><CodeLine lineNumber="1043"></CodeLine>
<Link id="l01044" /><CodeLine lineNumber="1044"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Sort for highest frequency.</span></CodeLine>
<Link id="l01045" /><CodeLine lineNumber="1045"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/x86/#a86730e94ae6fdf0fe3145b2acc88dea8ac9b4c62f6dc1bc5caf3c768b687cbf7e">Cmp</a> = &#91;&#93;(WeightedEdge <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#a2e38c85003a042421cde1647632d0b72">A</a>, WeightedEdge <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>) &#123; </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#a2e38c85003a042421cde1647632d0b72">A</a>.Weight &gt; <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>.Weight; &#125;;</span></CodeLine>
<Link id="l01046" /><CodeLine lineNumber="1046"></CodeLine>
<Link id="l01047" /><CodeLine lineNumber="1047"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a076f93c387f454f0db13d4bc7d4e7f9c">llvm::stable&#95;sort</a>(Edges&#91;0&#93;, Cmp);</span></CodeLine>
<Link id="l01048" /><CodeLine lineNumber="1048"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a076f93c387f454f0db13d4bc7d4e7f9c">llvm::stable&#95;sort</a>(Edges&#91;1&#93;, Cmp);</span></CodeLine>
<Link id="l01049" /><CodeLine lineNumber="1049"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> BestA = Edges&#91;0&#93;.begin();</span></CodeLine>
<Link id="l01050" /><CodeLine lineNumber="1050"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> BestB = Edges&#91;1&#93;.begin();</span></CodeLine>
<Link id="l01051" /><CodeLine lineNumber="1051"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Arrange for the correct answer to be in BestA and BestB</span></CodeLine>
<Link id="l01052" /><CodeLine lineNumber="1052"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the 2 best edges don&#39;t conflict, the answer is already there.</span></CodeLine>
<Link id="l01053" /><CodeLine lineNumber="1053"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BestA-&gt;Src == BestB-&gt;Src) &#123;</span></CodeLine>
<Link id="l01054" /><CodeLine lineNumber="1054"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Compare the total fallthrough of (Best + Second Best) for both pairs</span></CodeLine>
<Link id="l01055" /><CodeLine lineNumber="1055"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> SecondBestA = std::next(BestA);</span></CodeLine>
<Link id="l01056" /><CodeLine lineNumber="1056"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> SecondBestB = std::next(BestB);</span></CodeLine>
<Link id="l01057" /><CodeLine lineNumber="1057"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> BestAScore = BestA-&gt;Weight + SecondBestB-&gt;Weight;</span></CodeLine>
<Link id="l01058" /><CodeLine lineNumber="1058"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> BestBScore = BestB-&gt;Weight + SecondBestA-&gt;Weight;</span></CodeLine>
<Link id="l01059" /><CodeLine lineNumber="1059"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BestAScore &lt; BestBScore)</span></CodeLine>
<Link id="l01060" /><CodeLine lineNumber="1060"><span class="doxyHighlight">      BestA = SecondBestA;</span></CodeLine>
<Link id="l01061" /><CodeLine lineNumber="1061"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l01062" /><CodeLine lineNumber="1062"><span class="doxyHighlight">      BestB = SecondBestB;</span></CodeLine>
<Link id="l01063" /><CodeLine lineNumber="1063"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01064" /><CodeLine lineNumber="1064"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Arrange for the BB edge to be in BestA if it exists.</span></CodeLine>
<Link id="l01065" /><CodeLine lineNumber="1065"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BestB-&gt;Src == BB)</span></CodeLine>
<Link id="l01066" /><CodeLine lineNumber="1066"><span class="doxyHighlight">    <a href="/docs/api/namespaces/std/#ab8424022895aee3e366fb9a32f2883cb">std::swap</a>(BestA, BestB);</span></CodeLine>
<Link id="l01067" /><CodeLine lineNumber="1067"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> std::make&#95;pair(&#42;BestA, &#42;BestB);</span></CodeLine>
<Link id="l01068" /><CodeLine lineNumber="1068"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01069" /><CodeLine lineNumber="1069"></CodeLine>
<Link id="l01070" /><CodeLine lineNumber="1070"><span class="doxyHighlightComment">/// Get the best successor from \\p BB based on \\p BB being part of a trellis.</span></CodeLine>
<Link id="l01071" /><CodeLine lineNumber="1071"><span class="doxyHighlightComment">/// We only handle trellises with 2 successors, so the algorithm is</span></CodeLine>
<Link id="l01072" /><CodeLine lineNumber="1072"><span class="doxyHighlightComment">/// straightforward: Find the best pair of edges that don&#39;t conflict. We find</span></CodeLine>
<Link id="l01073" /><CodeLine lineNumber="1073"><span class="doxyHighlightComment">/// the best incoming edge for each successor in the trellis. If those conflict,</span></CodeLine>
<Link id="l01074" /><CodeLine lineNumber="1074"><span class="doxyHighlightComment">/// we consider which of them should be replaced with the second best.</span></CodeLine>
<Link id="l01075" /><CodeLine lineNumber="1075"><span class="doxyHighlightComment">/// Upon return the two best edges will be in \\p BestEdges. If one of the edges</span></CodeLine>
<Link id="l01076" /><CodeLine lineNumber="1076"><span class="doxyHighlightComment">/// comes from \\p BB, it will be in \\p BestEdges&#91;0&#93;</span></CodeLine>
<Link id="l01077" /><CodeLine lineNumber="1077"><span class="doxyHighlight">MachineBlockPlacement::BlockAndTailDupResult</span></CodeLine>
<Link id="l01078" /><CodeLine lineNumber="1078"><span class="doxyHighlight">MachineBlockPlacement::getBestTrellisSuccessor(</span></CodeLine>
<Link id="l01079" /><CodeLine lineNumber="1079"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB,</span></CodeLine>
<Link id="l01080" /><CodeLine lineNumber="1080"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;MachineBasicBlock &#42;&gt;</a> &amp;ViableSuccs,</span></CodeLine>
<Link id="l01081" /><CodeLine lineNumber="1081"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> AdjustedSumProb, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;Chain,</span></CodeLine>
<Link id="l01082" /><CodeLine lineNumber="1082"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter) &#123;</span></CodeLine>
<Link id="l01083" /><CodeLine lineNumber="1083"></CodeLine>
<Link id="l01084" /><CodeLine lineNumber="1084"><span class="doxyHighlight">  BlockAndTailDupResult <a href="/docs/api/namespaces/llvm/ms-demangle/#afb795990ffc0cb7321e7d1eacc246324a8eea62084ca7e541d918e823422bd82e">Result</a> = &#123;</span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">&#125;;</span></CodeLine>
<Link id="l01085" /><CodeLine lineNumber="1085"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;const MachineBasicBlock &#42;, 4&gt;</a> Successors(BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a6321b189ea8fd5058663f8a87d6c23e9">succ&#95;begin</a>(),</span></CodeLine>
<Link id="l01086" /><CodeLine lineNumber="1086"><span class="doxyHighlight">                                                       BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a3ddd708642d60c1661992ff8ba1b215d">succ&#95;end</a>());</span></CodeLine>
<Link id="l01087" /><CodeLine lineNumber="1087"></CodeLine>
<Link id="l01088" /><CodeLine lineNumber="1088"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We assume size 2 because it&#39;s common. For general n, we would have to do</span></CodeLine>
<Link id="l01089" /><CodeLine lineNumber="1089"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the Hungarian algorithm, but it&#39;s not worth the complexity because more</span></CodeLine>
<Link id="l01090" /><CodeLine lineNumber="1090"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// than 2 successors is fairly uncommon, and a trellis even more so.</span></CodeLine>
<Link id="l01091" /><CodeLine lineNumber="1091"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Successors.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() != 2 || ViableSuccs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() != 2)</span></CodeLine>
<Link id="l01092" /><CodeLine lineNumber="1092"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/ms-demangle/#afb795990ffc0cb7321e7d1eacc246324a8eea62084ca7e541d918e823422bd82e">Result</a>;</span></CodeLine>
<Link id="l01093" /><CodeLine lineNumber="1093"></CodeLine>
<Link id="l01094" /><CodeLine lineNumber="1094"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Collect the edge frequencies of all edges that form the trellis.</span></CodeLine>
<Link id="l01095" /><CodeLine lineNumber="1095"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;WeightedEdge, 8&gt;</a> Edges&#91;2&#93;;</span></CodeLine>
<Link id="l01096" /><CodeLine lineNumber="1096"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> SuccIndex = 0;</span></CodeLine>
<Link id="l01097" /><CodeLine lineNumber="1097"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Succ : ViableSuccs) &#123;</span></CodeLine>
<Link id="l01098" /><CodeLine lineNumber="1098"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;SuccPred : Succ-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#addd80df79ba902914c7d8a52e3896b79">predecessors</a>()) &#123;</span></CodeLine>
<Link id="l01099" /><CodeLine lineNumber="1099"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Skip any placed predecessors that are not BB</span></CodeLine>
<Link id="l01100" /><CodeLine lineNumber="1100"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SuccPred != BB)</span></CodeLine>
<Link id="l01101" /><CodeLine lineNumber="1101"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> ((BlockFilter &amp;&amp; !BlockFilter-&gt;count(SuccPred)) ||</span></CodeLine>
<Link id="l01102" /><CodeLine lineNumber="1102"><span class="doxyHighlight">            BlockToChain&#91;SuccPred&#93; == &amp;Chain ||</span></CodeLine>
<Link id="l01103" /><CodeLine lineNumber="1103"><span class="doxyHighlight">            BlockToChain&#91;SuccPred&#93; == BlockToChain&#91;Succ&#93;)</span></CodeLine>
<Link id="l01104" /><CodeLine lineNumber="1104"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01105" /><CodeLine lineNumber="1105"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> EdgeFreq = MBFI-&gt;getBlockFreq(SuccPred) &#42;</span></CodeLine>
<Link id="l01106" /><CodeLine lineNumber="1106"><span class="doxyHighlight">                                MBPI-&gt;getEdgeProbability(SuccPred, Succ);</span></CodeLine>
<Link id="l01107" /><CodeLine lineNumber="1107"><span class="doxyHighlight">      Edges&#91;SuccIndex&#93;.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;EdgeFreq, SuccPred, Succ&#125;);</span></CodeLine>
<Link id="l01108" /><CodeLine lineNumber="1108"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01109" /><CodeLine lineNumber="1109"><span class="doxyHighlight">    ++SuccIndex;</span></CodeLine>
<Link id="l01110" /><CodeLine lineNumber="1110"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01111" /><CodeLine lineNumber="1111"></CodeLine>
<Link id="l01112" /><CodeLine lineNumber="1112"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Pick the best combination of 2 edges from all the edges in the trellis.</span></CodeLine>
<Link id="l01113" /><CodeLine lineNumber="1113"><span class="doxyHighlight">  WeightedEdge BestA, BestB;</span></CodeLine>
<Link id="l01114" /><CodeLine lineNumber="1114"><span class="doxyHighlight">  std::tie(BestA, BestB) = getBestNonConflictingEdges(BB, Edges);</span></CodeLine>
<Link id="l01115" /><CodeLine lineNumber="1115"></CodeLine>
<Link id="l01116" /><CodeLine lineNumber="1116"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BestA.Src != BB) &#123;</span></CodeLine>
<Link id="l01117" /><CodeLine lineNumber="1117"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If we have a trellis, and BB doesn&#39;t have the best fallthrough edges,</span></CodeLine>
<Link id="l01118" /><CodeLine lineNumber="1118"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// we shouldn&#39;t choose any successor. We&#39;ve already looked and there&#39;s a</span></CodeLine>
<Link id="l01119" /><CodeLine lineNumber="1119"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// better fallthrough edge for all the successors.</span></CodeLine>
<Link id="l01120" /><CodeLine lineNumber="1120"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Trellis, but not one of the chosen edges.\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01121" /><CodeLine lineNumber="1121"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/ms-demangle/#afb795990ffc0cb7321e7d1eacc246324a8eea62084ca7e541d918e823422bd82e">Result</a>;</span></CodeLine>
<Link id="l01122" /><CodeLine lineNumber="1122"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01123" /><CodeLine lineNumber="1123"></CodeLine>
<Link id="l01124" /><CodeLine lineNumber="1124"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Did we pick the triangle edge? If tail-duplication is profitable, do</span></CodeLine>
<Link id="l01125" /><CodeLine lineNumber="1125"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// that instead. Otherwise merge the triangle edge now while we know it is</span></CodeLine>
<Link id="l01126" /><CodeLine lineNumber="1126"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// optimal.</span></CodeLine>
<Link id="l01127" /><CodeLine lineNumber="1127"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BestA.Dest == BestB.Src) &#123;</span></CodeLine>
<Link id="l01128" /><CodeLine lineNumber="1128"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// The edges are BB-&gt;Succ1-&gt;Succ2, and we&#39;re looking to see if BB-&gt;Succ2</span></CodeLine>
<Link id="l01129" /><CodeLine lineNumber="1129"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// would be better.</span></CodeLine>
<Link id="l01130" /><CodeLine lineNumber="1130"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ1 = BestA.Dest;</span></CodeLine>
<Link id="l01131" /><CodeLine lineNumber="1131"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ2 = BestB.Dest;</span></CodeLine>
<Link id="l01132" /><CodeLine lineNumber="1132"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Check to see if tail-duplication would be profitable.</span></CodeLine>
<Link id="l01133" /><CodeLine lineNumber="1133"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#ad65badde897b7d4f51fc7c545538a388">allowTailDupPlacement</a>() &amp;&amp; shouldTailDuplicate(Succ2) &amp;&amp;</span></CodeLine>
<Link id="l01134" /><CodeLine lineNumber="1134"><span class="doxyHighlight">        canTailDuplicateUnplacedPreds(BB, Succ2, Chain, BlockFilter) &amp;&amp;</span></CodeLine>
<Link id="l01135" /><CodeLine lineNumber="1135"><span class="doxyHighlight">        isProfitableToTailDup(BB, Succ2, MBPI-&gt;getEdgeProbability(BB, Succ1),</span></CodeLine>
<Link id="l01136" /><CodeLine lineNumber="1136"><span class="doxyHighlight">                              Chain, BlockFilter)) &#123;</span></CodeLine>
<Link id="l01137" /><CodeLine lineNumber="1137"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> Succ2Prob = <a href="#a0a894de03271c0ccc991e40f4cdd2623">getAdjustedProbability</a>(</span></CodeLine>
<Link id="l01138" /><CodeLine lineNumber="1138"><span class="doxyHighlight">                     MBPI-&gt;getEdgeProbability(BB, Succ2), AdjustedSumProb);</span></CodeLine>
<Link id="l01139" /><CodeLine lineNumber="1139"><span class="doxyHighlight">                 <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;    Selected: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(Succ2)</span></CodeLine>
<Link id="l01140" /><CodeLine lineNumber="1140"><span class="doxyHighlight">                        &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;, probability: &quot;</span><span class="doxyHighlight"> &lt;&lt; Succ2Prob</span></CodeLine>
<Link id="l01141" /><CodeLine lineNumber="1141"><span class="doxyHighlight">                        &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; (Tail Duplicate)\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01142" /><CodeLine lineNumber="1142"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/ms-demangle/#afb795990ffc0cb7321e7d1eacc246324a8eea62084ca7e541d918e823422bd82e">Result</a>.BB = Succ2;</span></CodeLine>
<Link id="l01143" /><CodeLine lineNumber="1143"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/ms-demangle/#afb795990ffc0cb7321e7d1eacc246324a8eea62084ca7e541d918e823422bd82e">Result</a>.ShouldTailDup = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01144" /><CodeLine lineNumber="1144"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/ms-demangle/#afb795990ffc0cb7321e7d1eacc246324a8eea62084ca7e541d918e823422bd82e">Result</a>;</span></CodeLine>
<Link id="l01145" /><CodeLine lineNumber="1145"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01146" /><CodeLine lineNumber="1146"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01147" /><CodeLine lineNumber="1147"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We have already computed the optimal edge for the other side of the</span></CodeLine>
<Link id="l01148" /><CodeLine lineNumber="1148"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// trellis.</span></CodeLine>
<Link id="l01149" /><CodeLine lineNumber="1149"><span class="doxyHighlight">  ComputedEdges&#91;BestB.Src&#93; = &#123;BestB.Dest, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">&#125;;</span></CodeLine>
<Link id="l01150" /><CodeLine lineNumber="1150"></CodeLine>
<Link id="l01151" /><CodeLine lineNumber="1151"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> TrellisSucc = BestA.Dest;</span></CodeLine>
<Link id="l01152" /><CodeLine lineNumber="1152"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> SuccProb = <a href="#a0a894de03271c0ccc991e40f4cdd2623">getAdjustedProbability</a>(</span></CodeLine>
<Link id="l01153" /><CodeLine lineNumber="1153"><span class="doxyHighlight">                 MBPI-&gt;getEdgeProbability(BB, TrellisSucc), AdjustedSumProb);</span></CodeLine>
<Link id="l01154" /><CodeLine lineNumber="1154"><span class="doxyHighlight">             <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;    Selected: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(TrellisSucc)</span></CodeLine>
<Link id="l01155" /><CodeLine lineNumber="1155"><span class="doxyHighlight">                    &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;, probability: &quot;</span><span class="doxyHighlight"> &lt;&lt; SuccProb &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; (Trellis)\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01156" /><CodeLine lineNumber="1156"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/ms-demangle/#afb795990ffc0cb7321e7d1eacc246324a8eea62084ca7e541d918e823422bd82e">Result</a>.BB = TrellisSucc;</span></CodeLine>
<Link id="l01157" /><CodeLine lineNumber="1157"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/ms-demangle/#afb795990ffc0cb7321e7d1eacc246324a8eea62084ca7e541d918e823422bd82e">Result</a>;</span></CodeLine>
<Link id="l01158" /><CodeLine lineNumber="1158"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01159" /><CodeLine lineNumber="1159"></CodeLine>
<Link id="l01160" /><CodeLine lineNumber="1160"><span class="doxyHighlightComment">/// When the option allowTailDupPlacement() is on, this method checks if the</span></CodeLine>
<Link id="l01161" /><CodeLine lineNumber="1161"><span class="doxyHighlightComment">/// fallthrough candidate block \\p Succ (of block \\p BB) can be tail-duplicated</span></CodeLine>
<Link id="l01162" /><CodeLine lineNumber="1162"><span class="doxyHighlightComment">/// into all of its unplaced, unfiltered predecessors, that are not BB.</span></CodeLine>
<Link id="l01163" /><CodeLine lineNumber="1163"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> MachineBlockPlacement::canTailDuplicateUnplacedPreds(</span></CodeLine>
<Link id="l01164" /><CodeLine lineNumber="1164"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB, <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ,</span></CodeLine>
<Link id="l01165" /><CodeLine lineNumber="1165"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;Chain, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter) &#123;</span></CodeLine>
<Link id="l01166" /><CodeLine lineNumber="1166"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!shouldTailDuplicate(Succ))</span></CodeLine>
<Link id="l01167" /><CodeLine lineNumber="1167"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01168" /><CodeLine lineNumber="1168"></CodeLine>
<Link id="l01169" /><CodeLine lineNumber="1169"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The result of canTailDuplicate.</span></CodeLine>
<Link id="l01170" /><CodeLine lineNumber="1170"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> Duplicate = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01171" /><CodeLine lineNumber="1171"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Number of possible duplication.</span></CodeLine>
<Link id="l01172" /><CodeLine lineNumber="1172"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> NumDup = 0;</span></CodeLine>
<Link id="l01173" /><CodeLine lineNumber="1173"></CodeLine>
<Link id="l01174" /><CodeLine lineNumber="1174"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For CFG checking.</span></CodeLine>
<Link id="l01175" /><CodeLine lineNumber="1175"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;const MachineBasicBlock &#42;, 4&gt;</a> Successors(BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a6321b189ea8fd5058663f8a87d6c23e9">succ&#95;begin</a>(),</span></CodeLine>
<Link id="l01176" /><CodeLine lineNumber="1176"><span class="doxyHighlight">                                                       BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a3ddd708642d60c1661992ff8ba1b215d">succ&#95;end</a>());</span></CodeLine>
<Link id="l01177" /><CodeLine lineNumber="1177"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Pred : Succ-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#addd80df79ba902914c7d8a52e3896b79">predecessors</a>()) &#123;</span></CodeLine>
<Link id="l01178" /><CodeLine lineNumber="1178"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Make sure all unplaced and unfiltered predecessors can be</span></CodeLine>
<Link id="l01179" /><CodeLine lineNumber="1179"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// tail-duplicated into.</span></CodeLine>
<Link id="l01180" /><CodeLine lineNumber="1180"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Skip any blocks that are already placed or not in this loop.</span></CodeLine>
<Link id="l01181" /><CodeLine lineNumber="1181"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Pred == BB || (BlockFilter &amp;&amp; !BlockFilter-&gt;count(Pred)) ||</span></CodeLine>
<Link id="l01182" /><CodeLine lineNumber="1182"><span class="doxyHighlight">        (BlockToChain&#91;Pred&#93; == &amp;Chain &amp;&amp; !Succ-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#aa8d1d8d88835b75b05b14ab774785e8a">succ&#95;empty</a>()))</span></CodeLine>
<Link id="l01183" /><CodeLine lineNumber="1183"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01184" /><CodeLine lineNumber="1184"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!TailDup.canTailDuplicate(Succ, Pred)) &#123;</span></CodeLine>
<Link id="l01185" /><CodeLine lineNumber="1185"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Successors.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() &gt; 1 &amp;&amp; <a href="#ab20068697df3d13ab12e09852d99b7f7">hasSameSuccessors</a>(&#42;Pred, Successors))</span></CodeLine>
<Link id="l01186" /><CodeLine lineNumber="1186"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// This will result in a trellis after tail duplication, so we don&#39;t</span></CodeLine>
<Link id="l01187" /><CodeLine lineNumber="1187"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// need to copy Succ into this predecessor. In the presence</span></CodeLine>
<Link id="l01188" /><CodeLine lineNumber="1188"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// of a trellis tail duplication can continue to be profitable.</span></CodeLine>
<Link id="l01189" /><CodeLine lineNumber="1189"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// For example:</span></CodeLine>
<Link id="l01190" /><CodeLine lineNumber="1190"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// A            A</span></CodeLine>
<Link id="l01191" /><CodeLine lineNumber="1191"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// |\\           |\\</span></CodeLine>
<Link id="l01192" /><CodeLine lineNumber="1192"><span class="doxyHighlightComment">        // | \\          | \\</span></CodeLine>
<Link id="l01193" /><CodeLine lineNumber="1193"><span class="doxyHighlightComment">        // |  C         |  C+BB</span></CodeLine>
<Link id="l01194" /><CodeLine lineNumber="1194"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// | /          |  |</span></CodeLine>
<Link id="l01195" /><CodeLine lineNumber="1195"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// |/           |  |</span></CodeLine>
<Link id="l01196" /><CodeLine lineNumber="1196"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// BB    =&gt;     BB |</span></CodeLine>
<Link id="l01197" /><CodeLine lineNumber="1197"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// |\\           |\\/|</span></CodeLine>
<Link id="l01198" /><CodeLine lineNumber="1198"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// | \\          |/\\|</span></CodeLine>
<Link id="l01199" /><CodeLine lineNumber="1199"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// |  D         |  D</span></CodeLine>
<Link id="l01200" /><CodeLine lineNumber="1200"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// | /          | /</span></CodeLine>
<Link id="l01201" /><CodeLine lineNumber="1201"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// |/           |/</span></CodeLine>
<Link id="l01202" /><CodeLine lineNumber="1202"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Succ         Succ</span></CodeLine>
<Link id="l01203" /><CodeLine lineNumber="1203"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01204" /><CodeLine lineNumber="1204"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// After BB was duplicated into C, the layout looks like the one on the</span></CodeLine>
<Link id="l01205" /><CodeLine lineNumber="1205"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// right. BB and C now have the same successors. When considering</span></CodeLine>
<Link id="l01206" /><CodeLine lineNumber="1206"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// whether Succ can be duplicated into all its unplaced predecessors, we</span></CodeLine>
<Link id="l01207" /><CodeLine lineNumber="1207"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// ignore C.</span></CodeLine>
<Link id="l01208" /><CodeLine lineNumber="1208"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// We can do this because C already has a profitable fallthrough, namely</span></CodeLine>
<Link id="l01209" /><CodeLine lineNumber="1209"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// D. TODO(iteratee): ignore sufficiently cold predecessors for</span></CodeLine>
<Link id="l01210" /><CodeLine lineNumber="1210"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// duplication and for this test.</span></CodeLine>
<Link id="l01211" /><CodeLine lineNumber="1211"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01212" /><CodeLine lineNumber="1212"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// This allows trellises to be laid out in 2 separate chains</span></CodeLine>
<Link id="l01213" /><CodeLine lineNumber="1213"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// (A,B,Succ,...) and later (C,D,...) This is a reasonable heuristic</span></CodeLine>
<Link id="l01214" /><CodeLine lineNumber="1214"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// because it allows the creation of 2 fallthrough paths with links</span></CodeLine>
<Link id="l01215" /><CodeLine lineNumber="1215"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// between them, and we correctly identify the best layout for these</span></CodeLine>
<Link id="l01216" /><CodeLine lineNumber="1216"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// CFGs. We want to extend trellises that the user created in addition</span></CodeLine>
<Link id="l01217" /><CodeLine lineNumber="1217"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// to trellises created by tail-duplication, so we just look for the</span></CodeLine>
<Link id="l01218" /><CodeLine lineNumber="1218"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// CFG.</span></CodeLine>
<Link id="l01219" /><CodeLine lineNumber="1219"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01220" /><CodeLine lineNumber="1220"><span class="doxyHighlight">      Duplicate = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01221" /><CodeLine lineNumber="1221"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01222" /><CodeLine lineNumber="1222"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01223" /><CodeLine lineNumber="1223"><span class="doxyHighlight">    NumDup++;</span></CodeLine>
<Link id="l01224" /><CodeLine lineNumber="1224"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01225" /><CodeLine lineNumber="1225"></CodeLine>
<Link id="l01226" /><CodeLine lineNumber="1226"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// No possible duplication in current filter set.</span></CodeLine>
<Link id="l01227" /><CodeLine lineNumber="1227"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NumDup == 0)</span></CodeLine>
<Link id="l01228" /><CodeLine lineNumber="1228"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01229" /><CodeLine lineNumber="1229"></CodeLine>
<Link id="l01230" /><CodeLine lineNumber="1230"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If profile information is available, findDuplicateCandidates can do more</span></CodeLine>
<Link id="l01231" /><CodeLine lineNumber="1231"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// precise benefit analysis.</span></CodeLine>
<Link id="l01232" /><CodeLine lineNumber="1232"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getFunction().hasProfileData())</span></CodeLine>
<Link id="l01233" /><CodeLine lineNumber="1233"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01234" /><CodeLine lineNumber="1234"></CodeLine>
<Link id="l01235" /><CodeLine lineNumber="1235"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// This is mainly for function exit BB.</span></CodeLine>
<Link id="l01236" /><CodeLine lineNumber="1236"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The integrated tail duplication is really designed for increasing</span></CodeLine>
<Link id="l01237" /><CodeLine lineNumber="1237"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// fallthrough from predecessors from Succ to its successors. We may need</span></CodeLine>
<Link id="l01238" /><CodeLine lineNumber="1238"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// other machanism to handle different cases.</span></CodeLine>
<Link id="l01239" /><CodeLine lineNumber="1239"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Succ-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#aa8d1d8d88835b75b05b14ab774785e8a">succ&#95;empty</a>())</span></CodeLine>
<Link id="l01240" /><CodeLine lineNumber="1240"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01241" /><CodeLine lineNumber="1241"></CodeLine>
<Link id="l01242" /><CodeLine lineNumber="1242"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Plus the already placed predecessor.</span></CodeLine>
<Link id="l01243" /><CodeLine lineNumber="1243"><span class="doxyHighlight">  NumDup++;</span></CodeLine>
<Link id="l01244" /><CodeLine lineNumber="1244"></CodeLine>
<Link id="l01245" /><CodeLine lineNumber="1245"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the duplication candidate has more unplaced predecessors than</span></CodeLine>
<Link id="l01246" /><CodeLine lineNumber="1246"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// successors, the extra duplication can&#39;t bring more fallthrough.</span></CodeLine>
<Link id="l01247" /><CodeLine lineNumber="1247"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01248" /><CodeLine lineNumber="1248"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     Pred1 Pred2 Pred3</span></CodeLine>
<Link id="l01249" /><CodeLine lineNumber="1249"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//         \\   |   /</span></CodeLine>
<Link id="l01250" /><CodeLine lineNumber="1250"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//          \\  |  /</span></CodeLine>
<Link id="l01251" /><CodeLine lineNumber="1251"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//           \\ | /</span></CodeLine>
<Link id="l01252" /><CodeLine lineNumber="1252"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//            Dup</span></CodeLine>
<Link id="l01253" /><CodeLine lineNumber="1253"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//            / \\</span></CodeLine>
<Link id="l01254" /><CodeLine lineNumber="1254"><span class="doxyHighlightComment">  //           /   \\</span></CodeLine>
<Link id="l01255" /><CodeLine lineNumber="1255"><span class="doxyHighlightComment">  //       Succ1  Succ2</span></CodeLine>
<Link id="l01256" /><CodeLine lineNumber="1256"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01257" /><CodeLine lineNumber="1257"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In this example Dup has 2 successors and 3 predecessors, duplication of Dup</span></CodeLine>
<Link id="l01258" /><CodeLine lineNumber="1258"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// can increase the fallthrough from Pred1 to Succ1 and from Pred2 to Succ2,</span></CodeLine>
<Link id="l01259" /><CodeLine lineNumber="1259"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// but the duplication into Pred3 can&#39;t increase fallthrough.</span></CodeLine>
<Link id="l01260" /><CodeLine lineNumber="1260"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01261" /><CodeLine lineNumber="1261"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// A small number of extra duplication may not hurt too much. We need a better</span></CodeLine>
<Link id="l01262" /><CodeLine lineNumber="1262"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// heuristic to handle it.</span></CodeLine>
<Link id="l01263" /><CodeLine lineNumber="1263"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> ((NumDup &gt; Succ-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a81626de817a0cb021ff8e915cf1942ed">succ&#95;size</a>()) || !Duplicate)</span></CodeLine>
<Link id="l01264" /><CodeLine lineNumber="1264"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01265" /><CodeLine lineNumber="1265"></CodeLine>
<Link id="l01266" /><CodeLine lineNumber="1266"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01267" /><CodeLine lineNumber="1267"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01268" /><CodeLine lineNumber="1268"></CodeLine>
<Link id="l01269" /><CodeLine lineNumber="1269"><span class="doxyHighlightComment">/// Find chains of triangles where we believe it would be profitable to</span></CodeLine>
<Link id="l01270" /><CodeLine lineNumber="1270"><span class="doxyHighlightComment">/// tail-duplicate them all, but a local analysis would not find them.</span></CodeLine>
<Link id="l01271" /><CodeLine lineNumber="1271"><span class="doxyHighlightComment">/// There are 3 ways this can be profitable:</span></CodeLine>
<Link id="l01272" /><CodeLine lineNumber="1272"><span class="doxyHighlightComment">/// 1) The post-dominators marked 50% are actually taken 55% (This shrinks with</span></CodeLine>
<Link id="l01273" /><CodeLine lineNumber="1273"><span class="doxyHighlightComment">///    longer chains)</span></CodeLine>
<Link id="l01274" /><CodeLine lineNumber="1274"><span class="doxyHighlightComment">/// 2) The chains are statically correlated. Branch probabilities have a very</span></CodeLine>
<Link id="l01275" /><CodeLine lineNumber="1275"><span class="doxyHighlightComment">///    U-shaped distribution.</span></CodeLine>
<Link id="l01276" /><CodeLine lineNumber="1276"><span class="doxyHighlightComment">///    &#91;http://nrs.harvard.edu/urn-3:HUL.InstRepos:24015805&#93;</span></CodeLine>
<Link id="l01277" /><CodeLine lineNumber="1277"><span class="doxyHighlightComment">///    If the branches in a chain are likely to be from the same side of the</span></CodeLine>
<Link id="l01278" /><CodeLine lineNumber="1278"><span class="doxyHighlightComment">///    distribution as their predecessor, but are independent at runtime, this</span></CodeLine>
<Link id="l01279" /><CodeLine lineNumber="1279"><span class="doxyHighlightComment">///    transformation is profitable. (Because the cost of being wrong is a small</span></CodeLine>
<Link id="l01280" /><CodeLine lineNumber="1280"><span class="doxyHighlightComment">///    fixed cost, unlike the standard triangle layout where the cost of being</span></CodeLine>
<Link id="l01281" /><CodeLine lineNumber="1281"><span class="doxyHighlightComment">///    wrong scales with the # of triangles.)</span></CodeLine>
<Link id="l01282" /><CodeLine lineNumber="1282"><span class="doxyHighlightComment">/// 3) The chains are dynamically correlated. If the probability that a previous</span></CodeLine>
<Link id="l01283" /><CodeLine lineNumber="1283"><span class="doxyHighlightComment">///    branch was taken positively influences whether the next branch will be</span></CodeLine>
<Link id="l01284" /><CodeLine lineNumber="1284"><span class="doxyHighlightComment">///    taken</span></CodeLine>
<Link id="l01285" /><CodeLine lineNumber="1285"><span class="doxyHighlightComment">/// We believe that 2 and 3 are common enough to justify the small margin in 1</span></CodeLine>
<Link id="l01286" /><CodeLine lineNumber="1286"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> MachineBlockPlacement::precomputeTriangleChains() &#123;</span></CodeLine>
<Link id="l01287" /><CodeLine lineNumber="1287"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">struct </span><span class="doxyHighlight">TriangleChain &#123;</span></CodeLine>
<Link id="l01288" /><CodeLine lineNumber="1288"><span class="doxyHighlight">    std::vector&lt;MachineBasicBlock &#42;&gt; Edges;</span></CodeLine>
<Link id="l01289" /><CodeLine lineNumber="1289"></CodeLine>
<Link id="l01290" /><CodeLine lineNumber="1290"><span class="doxyHighlight">    TriangleChain(MachineBasicBlock &#42;src, MachineBasicBlock &#42;dst)</span></CodeLine>
<Link id="l01291" /><CodeLine lineNumber="1291"><span class="doxyHighlight">        : Edges(&#123;src, dst&#125;) &#123;&#125;</span></CodeLine>
<Link id="l01292" /><CodeLine lineNumber="1292"></CodeLine>
<Link id="l01293" /><CodeLine lineNumber="1293"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/sys/path/#acb80894344c78dacf8d5ff8c23be697d">append</a>(MachineBasicBlock &#42;dst) &#123;</span></CodeLine>
<Link id="l01294" /><CodeLine lineNumber="1294"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(getKey()-&gt;isSuccessor(dst) &amp;&amp;</span></CodeLine>
<Link id="l01295" /><CodeLine lineNumber="1295"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;Attempting to append a block that is not a successor.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01296" /><CodeLine lineNumber="1296"><span class="doxyHighlight">      Edges.push&#95;back(dst);</span></CodeLine>
<Link id="l01297" /><CodeLine lineNumber="1297"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01298" /><CodeLine lineNumber="1298"></CodeLine>
<Link id="l01299" /><CodeLine lineNumber="1299"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/#ab1772fd431decccb7926d484ea223db7">count</a>()</span><span class="doxyHighlightKeyword"> const </span><span class="doxyHighlight">&#123; </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Edges.size() - 1; &#125;</span></CodeLine>
<Link id="l01300" /><CodeLine lineNumber="1300"></CodeLine>
<Link id="l01301" /><CodeLine lineNumber="1301"><span class="doxyHighlight">    MachineBasicBlock &#42;getKey()</span><span class="doxyHighlightKeyword"> const </span><span class="doxyHighlight">&#123; </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Edges.back(); &#125;</span></CodeLine>
<Link id="l01302" /><CodeLine lineNumber="1302"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l01303" /><CodeLine lineNumber="1303"></CodeLine>
<Link id="l01304" /><CodeLine lineNumber="1304"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a8ac66559c601e390e9477131019ee0ca">TriangleChainCount</a> == 0)</span></CodeLine>
<Link id="l01305" /><CodeLine lineNumber="1305"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01306" /><CodeLine lineNumber="1306"></CodeLine>
<Link id="l01307" /><CodeLine lineNumber="1307"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Pre-computing triangle chains.\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01308" /><CodeLine lineNumber="1308"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Map from last block to the chain that contains it. This allows us to extend</span></CodeLine>
<Link id="l01309" /><CodeLine lineNumber="1309"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// chains as we find new triangles.</span></CodeLine>
<Link id="l01310" /><CodeLine lineNumber="1310"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/densemap">DenseMap&lt;const MachineBasicBlock &#42;, TriangleChain&gt;</a> TriangleChainMap;</span></CodeLine>
<Link id="l01311" /><CodeLine lineNumber="1311"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;BB : &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l01312" /><CodeLine lineNumber="1312"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If BB doesn&#39;t have 2 successors, it doesn&#39;t start a triangle.</span></CodeLine>
<Link id="l01313" /><CodeLine lineNumber="1313"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BB.<a href="/docs/api/classes/llvm/machinebasicblock/#a81626de817a0cb021ff8e915cf1942ed">succ&#95;size</a>() != 2)</span></CodeLine>
<Link id="l01314" /><CodeLine lineNumber="1314"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01315" /><CodeLine lineNumber="1315"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;PDom = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01316" /><CodeLine lineNumber="1316"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ : BB.<a href="/docs/api/classes/llvm/machinebasicblock/#ad88ff1529541fb4e243cc8ed90b11131">successors</a>()) &#123;</span></CodeLine>
<Link id="l01317" /><CodeLine lineNumber="1317"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!MPDT-&gt;dominates(Succ, &amp;BB))</span></CodeLine>
<Link id="l01318" /><CodeLine lineNumber="1318"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01319" /><CodeLine lineNumber="1319"><span class="doxyHighlight">      PDom = Succ;</span></CodeLine>
<Link id="l01320" /><CodeLine lineNumber="1320"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01321" /><CodeLine lineNumber="1321"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01322" /><CodeLine lineNumber="1322"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If BB doesn&#39;t have a post-dominating successor, it doesn&#39;t form a</span></CodeLine>
<Link id="l01323" /><CodeLine lineNumber="1323"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// triangle.</span></CodeLine>
<Link id="l01324" /><CodeLine lineNumber="1324"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (PDom == </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l01325" /><CodeLine lineNumber="1325"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01326" /><CodeLine lineNumber="1326"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If PDom has a hint that it is low probability, skip this triangle.</span></CodeLine>
<Link id="l01327" /><CodeLine lineNumber="1327"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (MBPI-&gt;getEdgeProbability(&amp;BB, PDom) &lt; <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a>(50, 100))</span></CodeLine>
<Link id="l01328" /><CodeLine lineNumber="1328"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01329" /><CodeLine lineNumber="1329"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If PDom isn&#39;t eligible for duplication, this isn&#39;t the kind of triangle</span></CodeLine>
<Link id="l01330" /><CodeLine lineNumber="1330"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// we&#39;re looking for.</span></CodeLine>
<Link id="l01331" /><CodeLine lineNumber="1331"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!shouldTailDuplicate(PDom))</span></CodeLine>
<Link id="l01332" /><CodeLine lineNumber="1332"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01333" /><CodeLine lineNumber="1333"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> CanTailDuplicate = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01334" /><CodeLine lineNumber="1334"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If PDom can&#39;t tail-duplicate into it&#39;s non-BB predecessors, then this</span></CodeLine>
<Link id="l01335" /><CodeLine lineNumber="1335"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// isn&#39;t the kind of triangle we&#39;re looking for.</span></CodeLine>
<Link id="l01336" /><CodeLine lineNumber="1336"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Pred : PDom-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#addd80df79ba902914c7d8a52e3896b79">predecessors</a>()) &#123;</span></CodeLine>
<Link id="l01337" /><CodeLine lineNumber="1337"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Pred == &amp;BB)</span></CodeLine>
<Link id="l01338" /><CodeLine lineNumber="1338"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01339" /><CodeLine lineNumber="1339"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!TailDup.canTailDuplicate(PDom, Pred)) &#123;</span></CodeLine>
<Link id="l01340" /><CodeLine lineNumber="1340"><span class="doxyHighlight">        CanTailDuplicate = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01341" /><CodeLine lineNumber="1341"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01342" /><CodeLine lineNumber="1342"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01343" /><CodeLine lineNumber="1343"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01344" /><CodeLine lineNumber="1344"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If we can&#39;t tail-duplicate PDom to its predecessors, then skip this</span></CodeLine>
<Link id="l01345" /><CodeLine lineNumber="1345"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// triangle.</span></CodeLine>
<Link id="l01346" /><CodeLine lineNumber="1346"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CanTailDuplicate)</span></CodeLine>
<Link id="l01347" /><CodeLine lineNumber="1347"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01348" /><CodeLine lineNumber="1348"></CodeLine>
<Link id="l01349" /><CodeLine lineNumber="1349"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Now we have an interesting triangle. Insert it if it&#39;s not part of an</span></CodeLine>
<Link id="l01350" /><CodeLine lineNumber="1350"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// existing chain.</span></CodeLine>
<Link id="l01351" /><CodeLine lineNumber="1351"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Note: This cannot be replaced with a call insert() or emplace() because</span></CodeLine>
<Link id="l01352" /><CodeLine lineNumber="1352"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// the find key is BB, but the insert/emplace key is PDom.</span></CodeLine>
<Link id="l01353" /><CodeLine lineNumber="1353"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Found = TriangleChainMap.<a href="/docs/api/classes/llvm/densemapbase/#a0c047f127ed4380a6f383d70bec4eb94">find</a>(&amp;BB);</span></CodeLine>
<Link id="l01354" /><CodeLine lineNumber="1354"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If it is, remove the chain from the map, grow it, and put it back in the</span></CodeLine>
<Link id="l01355" /><CodeLine lineNumber="1355"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// map with the end as the new key.</span></CodeLine>
<Link id="l01356" /><CodeLine lineNumber="1356"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Found != TriangleChainMap.<a href="/docs/api/classes/llvm/densemapbase/#a65520b9c67759099e313d0f4e7b5ff9e">end</a>()) &#123;</span></CodeLine>
<Link id="l01357" /><CodeLine lineNumber="1357"><span class="doxyHighlight">      TriangleChain <a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a> = std::move(Found-&gt;second);</span></CodeLine>
<Link id="l01358" /><CodeLine lineNumber="1358"><span class="doxyHighlight">      TriangleChainMap.<a href="/docs/api/classes/llvm/densemapbase/#a1eb8504bab5f794778d82db6ac829923">erase</a>(Found);</span></CodeLine>
<Link id="l01359" /><CodeLine lineNumber="1359"><span class="doxyHighlight">      <a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>.<a href="/docs/api/classes/llvm/smallvectorimpl/#a7efd1f0c1206d95e4fe01a9b49a57b82">append</a>(PDom);</span></CodeLine>
<Link id="l01360" /><CodeLine lineNumber="1360"><span class="doxyHighlight">      TriangleChainMap.<a href="/docs/api/classes/llvm/densemapbase/#adb33f3ede2f5bfc9b3ee658aaf648492">insert</a>(std::make&#95;pair(<a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>.getKey(), std::move(Chain)));</span></CodeLine>
<Link id="l01361" /><CodeLine lineNumber="1361"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l01362" /><CodeLine lineNumber="1362"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> InsertResult = TriangleChainMap.<a href="/docs/api/classes/llvm/densemapbase/#a1a245b31aced1374f28f45d2b297f402">try&#95;emplace</a>(PDom, &amp;BB, PDom);</span></CodeLine>
<Link id="l01363" /><CodeLine lineNumber="1363"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(InsertResult.second &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Block seen twice.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01364" /><CodeLine lineNumber="1364"><span class="doxyHighlight">      (void)InsertResult;</span></CodeLine>
<Link id="l01365" /><CodeLine lineNumber="1365"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01366" /><CodeLine lineNumber="1366"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01367" /><CodeLine lineNumber="1367"></CodeLine>
<Link id="l01368" /><CodeLine lineNumber="1368"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Iterating over a DenseMap is safe here, because the only thing in the body</span></CodeLine>
<Link id="l01369" /><CodeLine lineNumber="1369"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// of the loop is inserting into another DenseMap (ComputedEdges).</span></CodeLine>
<Link id="l01370" /><CodeLine lineNumber="1370"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// ComputedEdges is never iterated, so this doesn&#39;t lead to non-determinism.</span></CodeLine>
<Link id="l01371" /><CodeLine lineNumber="1371"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;ChainPair : TriangleChainMap) &#123;</span></CodeLine>
<Link id="l01372" /><CodeLine lineNumber="1372"><span class="doxyHighlight">    TriangleChain &amp;<a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a> = ChainPair.second;</span></CodeLine>
<Link id="l01373" /><CodeLine lineNumber="1373"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Benchmarking has shown that due to branch correlation duplicating 2 or</span></CodeLine>
<Link id="l01374" /><CodeLine lineNumber="1374"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// more triangles is profitable, despite the calculations assuming</span></CodeLine>
<Link id="l01375" /><CodeLine lineNumber="1375"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// independence.</span></CodeLine>
<Link id="l01376" /><CodeLine lineNumber="1376"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>.count() &lt; <a href="#a8ac66559c601e390e9477131019ee0ca">TriangleChainCount</a>)</span></CodeLine>
<Link id="l01377" /><CodeLine lineNumber="1377"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01378" /><CodeLine lineNumber="1378"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;dst = <a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>.Edges.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#acd9e771a3296c6b24146955754620557">back</a>();</span></CodeLine>
<Link id="l01379" /><CodeLine lineNumber="1379"><span class="doxyHighlight">    <a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>.Edges.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#ad97688dfe9cd802e2a0691cbe620218a">pop&#95;back</a>();</span></CodeLine>
<Link id="l01380" /><CodeLine lineNumber="1380"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;src : <a href="/docs/api/namespaces/llvm/#a6b0ac1fa4f05de76413c5e0ca6334035">reverse</a>(<a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>.Edges)) &#123;</span></CodeLine>
<Link id="l01381" /><CodeLine lineNumber="1381"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Marking edge: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(src) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;-&gt;&quot;</span></CodeLine>
<Link id="l01382" /><CodeLine lineNumber="1382"><span class="doxyHighlight">                        &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(dst)</span></CodeLine>
<Link id="l01383" /><CodeLine lineNumber="1383"><span class="doxyHighlight">                        &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; as pre-computed based on triangles.\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01384" /><CodeLine lineNumber="1384"></CodeLine>
<Link id="l01385" /><CodeLine lineNumber="1385"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> InsertResult = ComputedEdges.insert(&#123;src, &#123;dst, </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">&#125;&#125;);</span></CodeLine>
<Link id="l01386" /><CodeLine lineNumber="1386"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(InsertResult.second &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Block seen twice.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01387" /><CodeLine lineNumber="1387"><span class="doxyHighlight">      (void)InsertResult;</span></CodeLine>
<Link id="l01388" /><CodeLine lineNumber="1388"></CodeLine>
<Link id="l01389" /><CodeLine lineNumber="1389"><span class="doxyHighlight">      dst = src;</span></CodeLine>
<Link id="l01390" /><CodeLine lineNumber="1390"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01391" /><CodeLine lineNumber="1391"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01392" /><CodeLine lineNumber="1392"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01393" /><CodeLine lineNumber="1393"></CodeLine>
<Link id="l01394" /><CodeLine lineNumber="1394"><span class="doxyHighlightComment">// When profile is not present, return the StaticLikelyProb.</span></CodeLine>
<Link id="l01395" /><CodeLine lineNumber="1395"><span class="doxyHighlightComment">// When profile is available, we need to handle the triangle-shape CFG.</span></CodeLine>
<Link id="l01396" /><CodeLine lineNumber="1396"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a></span></CodeLine>
<Link id="l01397" /><CodeLine lineNumber="1397" lineLink="#a3d135a8abf70dc93455708cc087cc0b0"><span class="doxyHighlight"><a href="#a3d135a8abf70dc93455708cc087cc0b0">getLayoutSuccessorProbThreshold</a>(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB) &#123;</span></CodeLine>
<Link id="l01398" /><CodeLine lineNumber="1398"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#acf6442108e21e7e5379feb8962de65b7">getParent</a>()-&gt;<a href="/docs/api/classes/llvm/machinefunction/#a977ddce262de45c645be23d951066351">getFunction</a>().<a href="/docs/api/classes/llvm/function/#a9084ce2576fad285c1c0dc1e165dd4b6">hasProfileData</a>())</span></CodeLine>
<Link id="l01399" /><CodeLine lineNumber="1399"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a>(<a href="/docs/api/namespaces/llvm/#a75dea20875e2199efbf65662db1234d8">StaticLikelyProb</a>, 100);</span></CodeLine>
<Link id="l01400" /><CodeLine lineNumber="1400"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a81626de817a0cb021ff8e915cf1942ed">succ&#95;size</a>() == 2) &#123;</span></CodeLine>
<Link id="l01401" /><CodeLine lineNumber="1401"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ1 = &#42;BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a6321b189ea8fd5058663f8a87d6c23e9">succ&#95;begin</a>();</span></CodeLine>
<Link id="l01402" /><CodeLine lineNumber="1402"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ2 = &#42;(BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a6321b189ea8fd5058663f8a87d6c23e9">succ&#95;begin</a>() + 1);</span></CodeLine>
<Link id="l01403" /><CodeLine lineNumber="1403"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Succ1-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#adc8f1be4a77ae671ac139d5f06b44deb">isSuccessor</a>(Succ2) || Succ2-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#adc8f1be4a77ae671ac139d5f06b44deb">isSuccessor</a>(Succ1)) &#123;</span></CodeLine>
<Link id="l01404" /><CodeLine lineNumber="1404"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">/&#42; See case 1 below for the cost analysis. For BB-&gt;Succ to</span></CodeLine>
<Link id="l01405" /><CodeLine lineNumber="1405"><span class="doxyHighlightComment">       &#42; be taken with smaller cost, the following needs to hold:</span></CodeLine>
<Link id="l01406" /><CodeLine lineNumber="1406"><span class="doxyHighlightComment">       &#42;   Prob(BB-&gt;Succ) &gt; 2 &#42; Prob(BB-&gt;Pred)</span></CodeLine>
<Link id="l01407" /><CodeLine lineNumber="1407"><span class="doxyHighlightComment">       &#42;   So the threshold T in the calculation below</span></CodeLine>
<Link id="l01408" /><CodeLine lineNumber="1408"><span class="doxyHighlightComment">       &#42;   (1-T) &#42; Prob(BB-&gt;Succ) &gt; T &#42; Prob(BB-&gt;Pred)</span></CodeLine>
<Link id="l01409" /><CodeLine lineNumber="1409"><span class="doxyHighlightComment">       &#42;   So T / (1 - T) = 2, Yielding T = 2/3</span></CodeLine>
<Link id="l01410" /><CodeLine lineNumber="1410"><span class="doxyHighlightComment">       &#42; Also adding user specified branch bias, we have</span></CodeLine>
<Link id="l01411" /><CodeLine lineNumber="1411"><span class="doxyHighlightComment">       &#42;   T = (2/3)&#42;(ProfileLikelyProb/50)</span></CodeLine>
<Link id="l01412" /><CodeLine lineNumber="1412"><span class="doxyHighlightComment">       &#42;     = (2&#42;ProfileLikelyProb)/150)</span></CodeLine>
<Link id="l01413" /><CodeLine lineNumber="1413"><span class="doxyHighlightComment">       &#42;/</span></CodeLine>
<Link id="l01414" /><CodeLine lineNumber="1414"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a>(2 &#42; <a href="/docs/api/namespaces/llvm/#a4de1c8a569d0350e16d8c5e0746d5bbf">ProfileLikelyProb</a>, 150);</span></CodeLine>
<Link id="l01415" /><CodeLine lineNumber="1415"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01416" /><CodeLine lineNumber="1416"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01417" /><CodeLine lineNumber="1417"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a>(<a href="/docs/api/namespaces/llvm/#a4de1c8a569d0350e16d8c5e0746d5bbf">ProfileLikelyProb</a>, 100);</span></CodeLine>
<Link id="l01418" /><CodeLine lineNumber="1418"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01419" /><CodeLine lineNumber="1419"></CodeLine>
<Link id="l01420" /><CodeLine lineNumber="1420"><span class="doxyHighlightComment">/// Checks to see if the layout candidate block \\p Succ has a better layout</span></CodeLine>
<Link id="l01421" /><CodeLine lineNumber="1421"><span class="doxyHighlightComment">/// predecessor than \\c BB. If yes, returns true.</span></CodeLine>
<Link id="l01422" /><CodeLine lineNumber="1422"><span class="doxyHighlightComment">/// \\p SuccProb: The probability adjusted for only remaining blocks.</span></CodeLine>
<Link id="l01423" /><CodeLine lineNumber="1423"><span class="doxyHighlightComment">///   Only used for logging</span></CodeLine>
<Link id="l01424" /><CodeLine lineNumber="1424"><span class="doxyHighlightComment">/// \\p RealSuccProb: The un-adjusted probability.</span></CodeLine>
<Link id="l01425" /><CodeLine lineNumber="1425"><span class="doxyHighlightComment">/// \\p Chain: The chain that BB belongs to and Succ is being considered for.</span></CodeLine>
<Link id="l01426" /><CodeLine lineNumber="1426"><span class="doxyHighlightComment">/// \\p BlockFilter: if non-null, the set of blocks that make up the loop being</span></CodeLine>
<Link id="l01427" /><CodeLine lineNumber="1427"><span class="doxyHighlightComment">///    considered</span></CodeLine>
<Link id="l01428" /><CodeLine lineNumber="1428"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> MachineBlockPlacement::hasBetterLayoutPredecessor(</span></CodeLine>
<Link id="l01429" /><CodeLine lineNumber="1429"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ,</span></CodeLine>
<Link id="l01430" /><CodeLine lineNumber="1430"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;SuccChain, <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> SuccProb,</span></CodeLine>
<Link id="l01431" /><CodeLine lineNumber="1431"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> RealSuccProb, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;Chain,</span></CodeLine>
<Link id="l01432" /><CodeLine lineNumber="1432"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter) &#123;</span></CodeLine>
<Link id="l01433" /><CodeLine lineNumber="1433"></CodeLine>
<Link id="l01434" /><CodeLine lineNumber="1434"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// There isn&#39;t a better layout when there are no unscheduled predecessors.</span></CodeLine>
<Link id="l01435" /><CodeLine lineNumber="1435"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SuccChain.UnscheduledPredecessors == 0)</span></CodeLine>
<Link id="l01436" /><CodeLine lineNumber="1436"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01437" /><CodeLine lineNumber="1437"></CodeLine>
<Link id="l01438" /><CodeLine lineNumber="1438"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// There are two basic scenarios here:</span></CodeLine>
<Link id="l01439" /><CodeLine lineNumber="1439"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// -------------------------------------</span></CodeLine>
<Link id="l01440" /><CodeLine lineNumber="1440"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Case 1: triangular shape CFG (if-then):</span></CodeLine>
<Link id="l01441" /><CodeLine lineNumber="1441"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     BB</span></CodeLine>
<Link id="l01442" /><CodeLine lineNumber="1442"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     | \\</span></CodeLine>
<Link id="l01443" /><CodeLine lineNumber="1443"><span class="doxyHighlightComment">  //     |  \\</span></CodeLine>
<Link id="l01444" /><CodeLine lineNumber="1444"><span class="doxyHighlightComment">  //     |   Pred</span></CodeLine>
<Link id="l01445" /><CodeLine lineNumber="1445"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     |   /</span></CodeLine>
<Link id="l01446" /><CodeLine lineNumber="1446"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     Succ</span></CodeLine>
<Link id="l01447" /><CodeLine lineNumber="1447"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In this case, we are evaluating whether to select edge -&gt; Succ, e.g.</span></CodeLine>
<Link id="l01448" /><CodeLine lineNumber="1448"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// set Succ as the layout successor of BB. Picking Succ as BB&#39;s</span></CodeLine>
<Link id="l01449" /><CodeLine lineNumber="1449"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// successor breaks the CFG constraints (FIXME: define these constraints).</span></CodeLine>
<Link id="l01450" /><CodeLine lineNumber="1450"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// With this layout, Pred BB</span></CodeLine>
<Link id="l01451" /><CodeLine lineNumber="1451"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// is forced to be outlined, so the overall cost will be cost of the</span></CodeLine>
<Link id="l01452" /><CodeLine lineNumber="1452"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// branch taken from BB to Pred, plus the cost of back taken branch</span></CodeLine>
<Link id="l01453" /><CodeLine lineNumber="1453"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// from Pred to Succ, as well as the additional cost associated</span></CodeLine>
<Link id="l01454" /><CodeLine lineNumber="1454"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// with the needed unconditional jump instruction from Pred To Succ.</span></CodeLine>
<Link id="l01455" /><CodeLine lineNumber="1455"></CodeLine>
<Link id="l01456" /><CodeLine lineNumber="1456"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The cost of the topological order layout is the taken branch cost</span></CodeLine>
<Link id="l01457" /><CodeLine lineNumber="1457"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// from BB to Succ, so to make BB-&gt;Succ a viable candidate, the following</span></CodeLine>
<Link id="l01458" /><CodeLine lineNumber="1458"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// must hold:</span></CodeLine>
<Link id="l01459" /><CodeLine lineNumber="1459"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     2 &#42; freq(BB-&gt;Pred) &#42; taken&#95;branch&#95;cost + unconditional&#95;jump&#95;cost</span></CodeLine>
<Link id="l01460" /><CodeLine lineNumber="1460"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//      &lt; freq(BB-&gt;Succ) &#42;  taken&#95;branch&#95;cost.</span></CodeLine>
<Link id="l01461" /><CodeLine lineNumber="1461"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Ignoring unconditional jump cost, we get</span></CodeLine>
<Link id="l01462" /><CodeLine lineNumber="1462"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    freq(BB-&gt;Succ) &gt; 2 &#42; freq(BB-&gt;Pred), i.e.,</span></CodeLine>
<Link id="l01463" /><CodeLine lineNumber="1463"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    prob(BB-&gt;Succ) &gt; 2 &#42; prob(BB-&gt;Pred)</span></CodeLine>
<Link id="l01464" /><CodeLine lineNumber="1464"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01465" /><CodeLine lineNumber="1465"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// When real profile data is available, we can precisely compute the</span></CodeLine>
<Link id="l01466" /><CodeLine lineNumber="1466"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// probability threshold that is needed for edge BB-&gt;Succ to be considered.</span></CodeLine>
<Link id="l01467" /><CodeLine lineNumber="1467"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Without profile data, the heuristic requires the branch bias to be</span></CodeLine>
<Link id="l01468" /><CodeLine lineNumber="1468"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// a lot larger to make sure the signal is very strong (e.g. 80% default).</span></CodeLine>
<Link id="l01469" /><CodeLine lineNumber="1469"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// -----------------------------------------------------------------</span></CodeLine>
<Link id="l01470" /><CodeLine lineNumber="1470"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Case 2: diamond like CFG (if-then-else):</span></CodeLine>
<Link id="l01471" /><CodeLine lineNumber="1471"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     S</span></CodeLine>
<Link id="l01472" /><CodeLine lineNumber="1472"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    / \\</span></CodeLine>
<Link id="l01473" /><CodeLine lineNumber="1473"><span class="doxyHighlightComment">  //   |   \\</span></CodeLine>
<Link id="l01474" /><CodeLine lineNumber="1474"><span class="doxyHighlightComment">  //  BB    Pred</span></CodeLine>
<Link id="l01475" /><CodeLine lineNumber="1475"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   \\    /</span></CodeLine>
<Link id="l01476" /><CodeLine lineNumber="1476"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    Succ</span></CodeLine>
<Link id="l01477" /><CodeLine lineNumber="1477"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    ..</span></CodeLine>
<Link id="l01478" /><CodeLine lineNumber="1478"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01479" /><CodeLine lineNumber="1479"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The current block is BB and edge BB-&gt;Succ is now being evaluated.</span></CodeLine>
<Link id="l01480" /><CodeLine lineNumber="1480"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Note that edge S-&gt;BB was previously already selected because</span></CodeLine>
<Link id="l01481" /><CodeLine lineNumber="1481"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// prob(S-&gt;BB) &gt; prob(S-&gt;Pred).</span></CodeLine>
<Link id="l01482" /><CodeLine lineNumber="1482"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// At this point, 2 blocks can be placed after BB: Pred or Succ. If we</span></CodeLine>
<Link id="l01483" /><CodeLine lineNumber="1483"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// choose Pred, we will have a topological ordering as shown on the left</span></CodeLine>
<Link id="l01484" /><CodeLine lineNumber="1484"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// in the picture below. If we choose Succ, we have the solution as shown</span></CodeLine>
<Link id="l01485" /><CodeLine lineNumber="1485"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// on the right:</span></CodeLine>
<Link id="l01486" /><CodeLine lineNumber="1486"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01487" /><CodeLine lineNumber="1487"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   topo-order:</span></CodeLine>
<Link id="l01488" /><CodeLine lineNumber="1488"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01489" /><CodeLine lineNumber="1489"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//       S-----                             ---S</span></CodeLine>
<Link id="l01490" /><CodeLine lineNumber="1490"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//       |    |                             |  |</span></CodeLine>
<Link id="l01491" /><CodeLine lineNumber="1491"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    ---BB   |                             |  BB</span></CodeLine>
<Link id="l01492" /><CodeLine lineNumber="1492"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    |       |                             |  |</span></CodeLine>
<Link id="l01493" /><CodeLine lineNumber="1493"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    |  Pred--                             |  Succ--</span></CodeLine>
<Link id="l01494" /><CodeLine lineNumber="1494"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    |  |                                  |       |</span></CodeLine>
<Link id="l01495" /><CodeLine lineNumber="1495"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    ---Succ                               ---Pred--</span></CodeLine>
<Link id="l01496" /><CodeLine lineNumber="1496"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01497" /><CodeLine lineNumber="1497"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// cost = freq(S-&gt;Pred) + freq(BB-&gt;Succ)    cost = 2 &#42; freq (S-&gt;Pred)</span></CodeLine>
<Link id="l01498" /><CodeLine lineNumber="1498"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//      = freq(S-&gt;Pred) + freq(S-&gt;BB)</span></CodeLine>
<Link id="l01499" /><CodeLine lineNumber="1499"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01500" /><CodeLine lineNumber="1500"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we have profile data (i.e, branch probabilities can be trusted), the</span></CodeLine>
<Link id="l01501" /><CodeLine lineNumber="1501"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// cost (number of taken branches) with layout S-&gt;BB-&gt;Succ-&gt;Pred is 2 &#42;</span></CodeLine>
<Link id="l01502" /><CodeLine lineNumber="1502"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// freq(S-&gt;Pred) while the cost of topo order is freq(S-&gt;Pred) + freq(S-&gt;BB).</span></CodeLine>
<Link id="l01503" /><CodeLine lineNumber="1503"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We know Prob(S-&gt;BB) &gt; Prob(S-&gt;Pred), so freq(S-&gt;BB) &gt; freq(S-&gt;Pred), which</span></CodeLine>
<Link id="l01504" /><CodeLine lineNumber="1504"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// means the cost of topological order is greater.</span></CodeLine>
<Link id="l01505" /><CodeLine lineNumber="1505"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// When profile data is not available, however, we need to be more</span></CodeLine>
<Link id="l01506" /><CodeLine lineNumber="1506"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// conservative. If the branch prediction is wrong, breaking the topo-order</span></CodeLine>
<Link id="l01507" /><CodeLine lineNumber="1507"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// will actually yield a layout with large cost. For this reason, we need</span></CodeLine>
<Link id="l01508" /><CodeLine lineNumber="1508"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// strong biased branch at block S with Prob(S-&gt;BB) in order to select</span></CodeLine>
<Link id="l01509" /><CodeLine lineNumber="1509"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// BB-&gt;Succ. This is equivalent to looking the CFG backward with backward</span></CodeLine>
<Link id="l01510" /><CodeLine lineNumber="1510"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// edge: Prob(Succ-&gt;BB) needs to &gt;= HotProb in order to be selected (without</span></CodeLine>
<Link id="l01511" /><CodeLine lineNumber="1511"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// profile data).</span></CodeLine>
<Link id="l01512" /><CodeLine lineNumber="1512"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// --------------------------------------------------------------------------</span></CodeLine>
<Link id="l01513" /><CodeLine lineNumber="1513"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Case 3: forked diamond</span></CodeLine>
<Link id="l01514" /><CodeLine lineNumber="1514"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//       S</span></CodeLine>
<Link id="l01515" /><CodeLine lineNumber="1515"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//      / \\</span></CodeLine>
<Link id="l01516" /><CodeLine lineNumber="1516"><span class="doxyHighlightComment">  //     /   \\</span></CodeLine>
<Link id="l01517" /><CodeLine lineNumber="1517"><span class="doxyHighlightComment">  //   BB    Pred</span></CodeLine>
<Link id="l01518" /><CodeLine lineNumber="1518"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   | \\   / |</span></CodeLine>
<Link id="l01519" /><CodeLine lineNumber="1519"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   |  \\ /  |</span></CodeLine>
<Link id="l01520" /><CodeLine lineNumber="1520"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   |   X   |</span></CodeLine>
<Link id="l01521" /><CodeLine lineNumber="1521"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   |  / \\  |</span></CodeLine>
<Link id="l01522" /><CodeLine lineNumber="1522"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   | /   \\ |</span></CodeLine>
<Link id="l01523" /><CodeLine lineNumber="1523"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   S1     S2</span></CodeLine>
<Link id="l01524" /><CodeLine lineNumber="1524"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01525" /><CodeLine lineNumber="1525"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The current block is BB and edge BB-&gt;S1 is now being evaluated.</span></CodeLine>
<Link id="l01526" /><CodeLine lineNumber="1526"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// As above S-&gt;BB was already selected because</span></CodeLine>
<Link id="l01527" /><CodeLine lineNumber="1527"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// prob(S-&gt;BB) &gt; prob(S-&gt;Pred). Assume that prob(BB-&gt;S1) &gt;= prob(BB-&gt;S2).</span></CodeLine>
<Link id="l01528" /><CodeLine lineNumber="1528"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01529" /><CodeLine lineNumber="1529"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// topo-order:</span></CodeLine>
<Link id="l01530" /><CodeLine lineNumber="1530"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01531" /><CodeLine lineNumber="1531"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     S-------|                     ---S</span></CodeLine>
<Link id="l01532" /><CodeLine lineNumber="1532"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     |       |                     |  |</span></CodeLine>
<Link id="l01533" /><CodeLine lineNumber="1533"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  ---BB      |                     |  BB</span></CodeLine>
<Link id="l01534" /><CodeLine lineNumber="1534"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  |          |                     |  |</span></CodeLine>
<Link id="l01535" /><CodeLine lineNumber="1535"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  |  Pred----|                     |  S1----</span></CodeLine>
<Link id="l01536" /><CodeLine lineNumber="1536"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  |  |                             |       |</span></CodeLine>
<Link id="l01537" /><CodeLine lineNumber="1537"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  --(S1 or S2)                     ---Pred--</span></CodeLine>
<Link id="l01538" /><CodeLine lineNumber="1538"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//                                        |</span></CodeLine>
<Link id="l01539" /><CodeLine lineNumber="1539"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//                                       S2</span></CodeLine>
<Link id="l01540" /><CodeLine lineNumber="1540"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01541" /><CodeLine lineNumber="1541"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// topo-cost = freq(S-&gt;Pred) + freq(BB-&gt;S1) + freq(BB-&gt;S2)</span></CodeLine>
<Link id="l01542" /><CodeLine lineNumber="1542"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    + min(freq(Pred-&gt;S1), freq(Pred-&gt;S2))</span></CodeLine>
<Link id="l01543" /><CodeLine lineNumber="1543"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Non-topo-order cost:</span></CodeLine>
<Link id="l01544" /><CodeLine lineNumber="1544"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// non-topo-cost = 2 &#42; freq(S-&gt;Pred) + freq(BB-&gt;S2).</span></CodeLine>
<Link id="l01545" /><CodeLine lineNumber="1545"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// To be conservative, we can assume that min(freq(Pred-&gt;S1), freq(Pred-&gt;S2))</span></CodeLine>
<Link id="l01546" /><CodeLine lineNumber="1546"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// is 0 Then the non topo layout is better when</span></CodeLine>
<Link id="l01547" /><CodeLine lineNumber="1547"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// freq(S-&gt;Pred) &lt; freq(BB-&gt;S1).</span></CodeLine>
<Link id="l01548" /><CodeLine lineNumber="1548"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// This is exactly what is checked below.</span></CodeLine>
<Link id="l01549" /><CodeLine lineNumber="1549"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Note there are other shapes that apply (Pred may not be a single block,</span></CodeLine>
<Link id="l01550" /><CodeLine lineNumber="1550"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// but they all fit this general pattern.)</span></CodeLine>
<Link id="l01551" /><CodeLine lineNumber="1551"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> HotProb = <a href="#a3d135a8abf70dc93455708cc087cc0b0">getLayoutSuccessorProbThreshold</a>(BB);</span></CodeLine>
<Link id="l01552" /><CodeLine lineNumber="1552"></CodeLine>
<Link id="l01553" /><CodeLine lineNumber="1553"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Make sure that a hot successor doesn&#39;t have a globally more</span></CodeLine>
<Link id="l01554" /><CodeLine lineNumber="1554"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// important predecessor.</span></CodeLine>
<Link id="l01555" /><CodeLine lineNumber="1555"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> CandidateEdgeFreq = MBFI-&gt;getBlockFreq(BB) &#42; RealSuccProb;</span></CodeLine>
<Link id="l01556" /><CodeLine lineNumber="1556"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> BadCFGConflict = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01557" /><CodeLine lineNumber="1557"></CodeLine>
<Link id="l01558" /><CodeLine lineNumber="1558"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Pred : Succ-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#addd80df79ba902914c7d8a52e3896b79">predecessors</a>()) &#123;</span></CodeLine>
<Link id="l01559" /><CodeLine lineNumber="1559"><span class="doxyHighlight">    <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;PredChain = BlockToChain&#91;Pred&#93;;</span></CodeLine>
<Link id="l01560" /><CodeLine lineNumber="1560"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Pred == Succ || PredChain == &amp;SuccChain ||</span></CodeLine>
<Link id="l01561" /><CodeLine lineNumber="1561"><span class="doxyHighlight">        (BlockFilter &amp;&amp; !BlockFilter-&gt;count(Pred)) || PredChain == &amp;Chain ||</span></CodeLine>
<Link id="l01562" /><CodeLine lineNumber="1562"><span class="doxyHighlight">        Pred != &#42;std::prev(PredChain-&gt;end()) ||</span></CodeLine>
<Link id="l01563" /><CodeLine lineNumber="1563"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// This check is redundant except for look ahead. This function is</span></CodeLine>
<Link id="l01564" /><CodeLine lineNumber="1564"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// called for lookahead by isProfitableToTailDup when BB hasn&#39;t been</span></CodeLine>
<Link id="l01565" /><CodeLine lineNumber="1565"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// placed yet.</span></CodeLine>
<Link id="l01566" /><CodeLine lineNumber="1566"><span class="doxyHighlight">        (Pred == BB))</span></CodeLine>
<Link id="l01567" /><CodeLine lineNumber="1567"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01568" /><CodeLine lineNumber="1568"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Do backward checking.</span></CodeLine>
<Link id="l01569" /><CodeLine lineNumber="1569"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// For all cases above, we need a backward checking to filter out edges that</span></CodeLine>
<Link id="l01570" /><CodeLine lineNumber="1570"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// are not &#39;strongly&#39; biased.</span></CodeLine>
<Link id="l01571" /><CodeLine lineNumber="1571"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// BB  Pred</span></CodeLine>
<Link id="l01572" /><CodeLine lineNumber="1572"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//  \\ /</span></CodeLine>
<Link id="l01573" /><CodeLine lineNumber="1573"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//  Succ</span></CodeLine>
<Link id="l01574" /><CodeLine lineNumber="1574"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We select edge BB-&gt;Succ if</span></CodeLine>
<Link id="l01575" /><CodeLine lineNumber="1575"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//      freq(BB-&gt;Succ) &gt; freq(Succ) &#42; HotProb</span></CodeLine>
<Link id="l01576" /><CodeLine lineNumber="1576"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//      i.e. freq(BB-&gt;Succ) &gt; freq(BB-&gt;Succ) &#42; HotProb + freq(Pred-&gt;Succ) &#42;</span></CodeLine>
<Link id="l01577" /><CodeLine lineNumber="1577"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//      HotProb</span></CodeLine>
<Link id="l01578" /><CodeLine lineNumber="1578"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//      i.e. freq((BB-&gt;Succ) &#42; (1 - HotProb) &gt; freq(Pred-&gt;Succ) &#42; HotProb</span></CodeLine>
<Link id="l01579" /><CodeLine lineNumber="1579"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Case 1 is covered too, because the first equation reduces to:</span></CodeLine>
<Link id="l01580" /><CodeLine lineNumber="1580"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// prob(BB-&gt;Succ) &gt; HotProb. (freq(Succ) = freq(BB) for a triangle)</span></CodeLine>
<Link id="l01581" /><CodeLine lineNumber="1581"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> PredEdgeFreq =</span></CodeLine>
<Link id="l01582" /><CodeLine lineNumber="1582"><span class="doxyHighlight">        MBFI-&gt;getBlockFreq(Pred) &#42; MBPI-&gt;getEdgeProbability(Pred, Succ);</span></CodeLine>
<Link id="l01583" /><CodeLine lineNumber="1583"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (PredEdgeFreq &#42; HotProb &gt;= CandidateEdgeFreq &#42; HotProb.<a href="/docs/api/classes/llvm/branchprobability/#aaee6034264d5d0782e5d1489360730d9">getCompl</a>()) &#123;</span></CodeLine>
<Link id="l01584" /><CodeLine lineNumber="1584"><span class="doxyHighlight">      BadCFGConflict = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01585" /><CodeLine lineNumber="1585"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01586" /><CodeLine lineNumber="1586"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01587" /><CodeLine lineNumber="1587"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01588" /><CodeLine lineNumber="1588"></CodeLine>
<Link id="l01589" /><CodeLine lineNumber="1589"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BadCFGConflict) &#123;</span></CodeLine>
<Link id="l01590" /><CodeLine lineNumber="1590"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;    Not a candidate: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(Succ) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; -&gt; &quot;</span></CodeLine>
<Link id="l01591" /><CodeLine lineNumber="1591"><span class="doxyHighlight">                      &lt;&lt; SuccProb &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; (prob) (non-cold CFG conflict)\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01592" /><CodeLine lineNumber="1592"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01593" /><CodeLine lineNumber="1593"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01594" /><CodeLine lineNumber="1594"></CodeLine>
<Link id="l01595" /><CodeLine lineNumber="1595"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01596" /><CodeLine lineNumber="1596"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01597" /><CodeLine lineNumber="1597"></CodeLine>
<Link id="l01598" /><CodeLine lineNumber="1598"><span class="doxyHighlightComment">/// Select the best successor for a block.</span></CodeLine>
<Link id="l01599" /><CodeLine lineNumber="1599"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01600" /><CodeLine lineNumber="1600"><span class="doxyHighlightComment">/// This looks across all successors of a particular block and attempts to</span></CodeLine>
<Link id="l01601" /><CodeLine lineNumber="1601"><span class="doxyHighlightComment">/// select the &quot;best&quot; one to be the layout successor. It only considers direct</span></CodeLine>
<Link id="l01602" /><CodeLine lineNumber="1602"><span class="doxyHighlightComment">/// successors which also pass the block filter. It will attempt to avoid</span></CodeLine>
<Link id="l01603" /><CodeLine lineNumber="1603"><span class="doxyHighlightComment">/// breaking CFG structure, but cave and break such structures in the case of</span></CodeLine>
<Link id="l01604" /><CodeLine lineNumber="1604"><span class="doxyHighlightComment">/// very hot successor edges.</span></CodeLine>
<Link id="l01605" /><CodeLine lineNumber="1605"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01606" /><CodeLine lineNumber="1606"><span class="doxyHighlightComment">/// \\returns The best successor block found, or null if none are viable, along</span></CodeLine>
<Link id="l01607" /><CodeLine lineNumber="1607"><span class="doxyHighlightComment">/// with a boolean indicating if tail duplication is necessary.</span></CodeLine>
<Link id="l01608" /><CodeLine lineNumber="1608"><span class="doxyHighlight">MachineBlockPlacement::BlockAndTailDupResult</span></CodeLine>
<Link id="l01609" /><CodeLine lineNumber="1609"><span class="doxyHighlight">MachineBlockPlacement::selectBestSuccessor(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB,</span></CodeLine>
<Link id="l01610" /><CodeLine lineNumber="1610"><span class="doxyHighlight">                                           </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;Chain,</span></CodeLine>
<Link id="l01611" /><CodeLine lineNumber="1611"><span class="doxyHighlight">                                           </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter) &#123;</span></CodeLine>
<Link id="l01612" /><CodeLine lineNumber="1612"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> HotProb(<a href="/docs/api/namespaces/llvm/#a75dea20875e2199efbf65662db1234d8">StaticLikelyProb</a>, 100);</span></CodeLine>
<Link id="l01613" /><CodeLine lineNumber="1613"></CodeLine>
<Link id="l01614" /><CodeLine lineNumber="1614"><span class="doxyHighlight">  BlockAndTailDupResult BestSucc = &#123;</span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">&#125;;</span></CodeLine>
<Link id="l01615" /><CodeLine lineNumber="1615"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> BestProb = <a href="/docs/api/classes/llvm/branchprobability/#afd00958cba7080048a84cccfcef55d71">BranchProbability::getZero</a>();</span></CodeLine>
<Link id="l01616" /><CodeLine lineNumber="1616"></CodeLine>
<Link id="l01617" /><CodeLine lineNumber="1617"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineBasicBlock &#42;, 4&gt;</a> Successors;</span></CodeLine>
<Link id="l01618" /><CodeLine lineNumber="1618"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> AdjustedSumProb =</span></CodeLine>
<Link id="l01619" /><CodeLine lineNumber="1619"><span class="doxyHighlight">      collectViableSuccessors(BB, Chain, BlockFilter, Successors);</span></CodeLine>
<Link id="l01620" /><CodeLine lineNumber="1620"></CodeLine>
<Link id="l01621" /><CodeLine lineNumber="1621"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Selecting best successor for: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(BB)</span></CodeLine>
<Link id="l01622" /><CodeLine lineNumber="1622"><span class="doxyHighlight">                    &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01623" /><CodeLine lineNumber="1623"></CodeLine>
<Link id="l01624" /><CodeLine lineNumber="1624"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// if we already precomputed the best successor for BB, return that if still</span></CodeLine>
<Link id="l01625" /><CodeLine lineNumber="1625"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// applicable.</span></CodeLine>
<Link id="l01626" /><CodeLine lineNumber="1626"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> FoundEdge = ComputedEdges.find(BB);</span></CodeLine>
<Link id="l01627" /><CodeLine lineNumber="1627"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FoundEdge != ComputedEdges.end()) &#123;</span></CodeLine>
<Link id="l01628" /><CodeLine lineNumber="1628"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ = FoundEdge-&gt;second.BB;</span></CodeLine>
<Link id="l01629" /><CodeLine lineNumber="1629"><span class="doxyHighlight">    ComputedEdges.<a href="/docs/api/classes/llvm/basicblock/#a018d5142c1a4469d9296a26a59fe2783">erase</a>(FoundEdge);</span></CodeLine>
<Link id="l01630" /><CodeLine lineNumber="1630"><span class="doxyHighlight">    <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;SuccChain = BlockToChain&#91;Succ&#93;;</span></CodeLine>
<Link id="l01631" /><CodeLine lineNumber="1631"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#adc8f1be4a77ae671ac139d5f06b44deb">isSuccessor</a>(Succ) &amp;&amp; (!BlockFilter || BlockFilter-&gt;count(Succ)) &amp;&amp;</span></CodeLine>
<Link id="l01632" /><CodeLine lineNumber="1632"><span class="doxyHighlight">        SuccChain != &amp;Chain &amp;&amp; Succ == &#42;SuccChain-&gt;begin())</span></CodeLine>
<Link id="l01633" /><CodeLine lineNumber="1633"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> FoundEdge-&gt;second;</span></CodeLine>
<Link id="l01634" /><CodeLine lineNumber="1634"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01635" /><CodeLine lineNumber="1635"></CodeLine>
<Link id="l01636" /><CodeLine lineNumber="1636"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// if BB is part of a trellis, Use the trellis to determine the optimal</span></CodeLine>
<Link id="l01637" /><CodeLine lineNumber="1637"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// fallthrough edges</span></CodeLine>
<Link id="l01638" /><CodeLine lineNumber="1638"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (isTrellis(BB, Successors, Chain, BlockFilter))</span></CodeLine>
<Link id="l01639" /><CodeLine lineNumber="1639"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> getBestTrellisSuccessor(BB, Successors, AdjustedSumProb, Chain,</span></CodeLine>
<Link id="l01640" /><CodeLine lineNumber="1640"><span class="doxyHighlight">                                   BlockFilter);</span></CodeLine>
<Link id="l01641" /><CodeLine lineNumber="1641"></CodeLine>
<Link id="l01642" /><CodeLine lineNumber="1642"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For blocks with CFG violations, we may be able to lay them out anyway with</span></CodeLine>
<Link id="l01643" /><CodeLine lineNumber="1643"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// tail-duplication. We keep this vector so we can perform the probability</span></CodeLine>
<Link id="l01644" /><CodeLine lineNumber="1644"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// calculations the minimum number of times.</span></CodeLine>
<Link id="l01645" /><CodeLine lineNumber="1645"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;std::pair&lt;BranchProbability, MachineBasicBlock &#42;&gt;</a>, 4&gt;</span></CodeLine>
<Link id="l01646" /><CodeLine lineNumber="1646"><span class="doxyHighlight">      DupCandidates;</span></CodeLine>
<Link id="l01647" /><CodeLine lineNumber="1647"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ : Successors) &#123;</span></CodeLine>
<Link id="l01648" /><CodeLine lineNumber="1648"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> RealSuccProb = MBPI-&gt;getEdgeProbability(BB, Succ);</span></CodeLine>
<Link id="l01649" /><CodeLine lineNumber="1649"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> SuccProb =</span></CodeLine>
<Link id="l01650" /><CodeLine lineNumber="1650"><span class="doxyHighlight">        <a href="#a0a894de03271c0ccc991e40f4cdd2623">getAdjustedProbability</a>(RealSuccProb, AdjustedSumProb);</span></CodeLine>
<Link id="l01651" /><CodeLine lineNumber="1651"></CodeLine>
<Link id="l01652" /><CodeLine lineNumber="1652"><span class="doxyHighlight">    <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;SuccChain = &#42;BlockToChain&#91;Succ&#93;;</span></CodeLine>
<Link id="l01653" /><CodeLine lineNumber="1653"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Skip the edge \\c BB-&gt;Succ if block \\c Succ has a better layout</span></CodeLine>
<Link id="l01654" /><CodeLine lineNumber="1654"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// predecessor that yields lower global cost.</span></CodeLine>
<Link id="l01655" /><CodeLine lineNumber="1655"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (hasBetterLayoutPredecessor(BB, Succ, SuccChain, SuccProb, RealSuccProb,</span></CodeLine>
<Link id="l01656" /><CodeLine lineNumber="1656"><span class="doxyHighlight">                                   Chain, BlockFilter)) &#123;</span></CodeLine>
<Link id="l01657" /><CodeLine lineNumber="1657"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If tail duplication would make Succ profitable, place it.</span></CodeLine>
<Link id="l01658" /><CodeLine lineNumber="1658"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#ad65badde897b7d4f51fc7c545538a388">allowTailDupPlacement</a>() &amp;&amp; shouldTailDuplicate(Succ))</span></CodeLine>
<Link id="l01659" /><CodeLine lineNumber="1659"><span class="doxyHighlight">        DupCandidates.<a href="/docs/api/classes/llvm/smallvectorimpl/#a396fcfee6914c76974b73c3d203da6a5">emplace&#95;back</a>(SuccProb, Succ);</span></CodeLine>
<Link id="l01660" /><CodeLine lineNumber="1660"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01661" /><CodeLine lineNumber="1661"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01662" /><CodeLine lineNumber="1662"></CodeLine>
<Link id="l01663" /><CodeLine lineNumber="1663"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(</span></CodeLine>
<Link id="l01664" /><CodeLine lineNumber="1664"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;    Candidate: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(Succ)</span></CodeLine>
<Link id="l01665" /><CodeLine lineNumber="1665"><span class="doxyHighlight">               &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;, probability: &quot;</span><span class="doxyHighlight"> &lt;&lt; SuccProb</span></CodeLine>
<Link id="l01666" /><CodeLine lineNumber="1666"><span class="doxyHighlight">               &lt;&lt; (SuccChain.UnscheduledPredecessors != 0 ? </span><span class="doxyHighlightStringLiteral">&quot; (CFG break)&quot;</span><span class="doxyHighlight"> : </span><span class="doxyHighlightStringLiteral">&quot;&quot;</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l01667" /><CodeLine lineNumber="1667"><span class="doxyHighlight">               &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01668" /><CodeLine lineNumber="1668"></CodeLine>
<Link id="l01669" /><CodeLine lineNumber="1669"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BestSucc.BB &amp;&amp; BestProb &gt;= SuccProb) &#123;</span></CodeLine>
<Link id="l01670" /><CodeLine lineNumber="1670"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;    Not the best candidate, continuing\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01671" /><CodeLine lineNumber="1671"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01672" /><CodeLine lineNumber="1672"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01673" /><CodeLine lineNumber="1673"></CodeLine>
<Link id="l01674" /><CodeLine lineNumber="1674"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;    Setting it as best candidate\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01675" /><CodeLine lineNumber="1675"><span class="doxyHighlight">    BestSucc.BB = Succ;</span></CodeLine>
<Link id="l01676" /><CodeLine lineNumber="1676"><span class="doxyHighlight">    BestProb = SuccProb;</span></CodeLine>
<Link id="l01677" /><CodeLine lineNumber="1677"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01678" /><CodeLine lineNumber="1678"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Handle the tail duplication candidates in order of decreasing probability.</span></CodeLine>
<Link id="l01679" /><CodeLine lineNumber="1679"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Stop at the first one that is profitable. Also stop if they are less</span></CodeLine>
<Link id="l01680" /><CodeLine lineNumber="1680"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// profitable than BestSucc. Position is important because we preserve it and</span></CodeLine>
<Link id="l01681" /><CodeLine lineNumber="1681"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// prefer first best match. Here we aren&#39;t comparing in order, so we capture</span></CodeLine>
<Link id="l01682" /><CodeLine lineNumber="1682"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the position instead.</span></CodeLine>
<Link id="l01683" /><CodeLine lineNumber="1683"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a076f93c387f454f0db13d4bc7d4e7f9c">llvm::stable&#95;sort</a>(DupCandidates,</span></CodeLine>
<Link id="l01684" /><CodeLine lineNumber="1684"><span class="doxyHighlight">                    &#91;&#93;(std::tuple&lt;BranchProbability, MachineBasicBlock &#42;&gt; L,</span></CodeLine>
<Link id="l01685" /><CodeLine lineNumber="1685"><span class="doxyHighlight">                       std::tuple&lt;BranchProbability, MachineBasicBlock &#42;&gt; R) &#123;</span></CodeLine>
<Link id="l01686" /><CodeLine lineNumber="1686"><span class="doxyHighlight">                      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> std::get&lt;0&gt;(L) &gt; std::get&lt;0&gt;(R);</span></CodeLine>
<Link id="l01687" /><CodeLine lineNumber="1687"><span class="doxyHighlight">                    &#125;);</span></CodeLine>
<Link id="l01688" /><CodeLine lineNumber="1688"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;Tup : DupCandidates) &#123;</span></CodeLine>
<Link id="l01689" /><CodeLine lineNumber="1689"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> DupProb;</span></CodeLine>
<Link id="l01690" /><CodeLine lineNumber="1690"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ;</span></CodeLine>
<Link id="l01691" /><CodeLine lineNumber="1691"><span class="doxyHighlight">    std::tie(DupProb, Succ) = Tup;</span></CodeLine>
<Link id="l01692" /><CodeLine lineNumber="1692"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (DupProb &lt; BestProb)</span></CodeLine>
<Link id="l01693" /><CodeLine lineNumber="1693"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01694" /><CodeLine lineNumber="1694"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (canTailDuplicateUnplacedPreds(BB, Succ, Chain, BlockFilter) &amp;&amp;</span></CodeLine>
<Link id="l01695" /><CodeLine lineNumber="1695"><span class="doxyHighlight">        (isProfitableToTailDup(BB, Succ, BestProb, Chain, BlockFilter))) &#123;</span></CodeLine>
<Link id="l01696" /><CodeLine lineNumber="1696"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;    Candidate: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(Succ)</span></CodeLine>
<Link id="l01697" /><CodeLine lineNumber="1697"><span class="doxyHighlight">                        &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;, probability: &quot;</span><span class="doxyHighlight"> &lt;&lt; DupProb</span></CodeLine>
<Link id="l01698" /><CodeLine lineNumber="1698"><span class="doxyHighlight">                        &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; (Tail Duplicate)\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01699" /><CodeLine lineNumber="1699"><span class="doxyHighlight">      BestSucc.BB = Succ;</span></CodeLine>
<Link id="l01700" /><CodeLine lineNumber="1700"><span class="doxyHighlight">      BestSucc.ShouldTailDup = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01701" /><CodeLine lineNumber="1701"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01702" /><CodeLine lineNumber="1702"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01703" /><CodeLine lineNumber="1703"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01704" /><CodeLine lineNumber="1704"></CodeLine>
<Link id="l01705" /><CodeLine lineNumber="1705"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BestSucc.BB)</span></CodeLine>
<Link id="l01706" /><CodeLine lineNumber="1706"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;    Selected: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(BestSucc.BB) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01707" /><CodeLine lineNumber="1707"></CodeLine>
<Link id="l01708" /><CodeLine lineNumber="1708"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> BestSucc;</span></CodeLine>
<Link id="l01709" /><CodeLine lineNumber="1709"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01710" /><CodeLine lineNumber="1710"></CodeLine>
<Link id="l01711" /><CodeLine lineNumber="1711"><span class="doxyHighlightComment">/// Select the best block from a worklist.</span></CodeLine>
<Link id="l01712" /><CodeLine lineNumber="1712"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01713" /><CodeLine lineNumber="1713"><span class="doxyHighlightComment">/// This looks through the provided worklist as a list of candidate basic</span></CodeLine>
<Link id="l01714" /><CodeLine lineNumber="1714"><span class="doxyHighlightComment">/// blocks and select the most profitable one to place. The definition of</span></CodeLine>
<Link id="l01715" /><CodeLine lineNumber="1715"><span class="doxyHighlightComment">/// profitable only really makes sense in the context of a loop. This returns</span></CodeLine>
<Link id="l01716" /><CodeLine lineNumber="1716"><span class="doxyHighlightComment">/// the most frequently visited block in the worklist, which in the case of</span></CodeLine>
<Link id="l01717" /><CodeLine lineNumber="1717"><span class="doxyHighlightComment">/// a loop, is the one most desirable to be physically close to the rest of the</span></CodeLine>
<Link id="l01718" /><CodeLine lineNumber="1718"><span class="doxyHighlightComment">/// loop body in order to improve i-cache behavior.</span></CodeLine>
<Link id="l01719" /><CodeLine lineNumber="1719"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01720" /><CodeLine lineNumber="1720"><span class="doxyHighlightComment">/// \\returns The best block found, or null if none are viable.</span></CodeLine>
<Link id="l01721" /><CodeLine lineNumber="1721"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;MachineBlockPlacement::selectBestCandidateBlock(</span></CodeLine>
<Link id="l01722" /><CodeLine lineNumber="1722"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;Chain, <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;MachineBasicBlock &#42;&gt;</a> &amp;WorkList) &#123;</span></CodeLine>
<Link id="l01723" /><CodeLine lineNumber="1723"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Once we need to walk the worklist looking for a candidate, cleanup the</span></CodeLine>
<Link id="l01724" /><CodeLine lineNumber="1724"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// worklist of already placed entries.</span></CodeLine>
<Link id="l01725" /><CodeLine lineNumber="1725"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// FIXME: If this shows up on profiles, it could be folded (at the cost of</span></CodeLine>
<Link id="l01726" /><CodeLine lineNumber="1726"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// some code complexity) into the loop below.</span></CodeLine>
<Link id="l01727" /><CodeLine lineNumber="1727"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#ac9a7de5a04920954ac964059cfc428ad">llvm::erase&#95;if</a>(WorkList, &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB) &#123;</span></CodeLine>
<Link id="l01728" /><CodeLine lineNumber="1728"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> BlockToChain.lookup(BB) == &amp;<a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>;</span></CodeLine>
<Link id="l01729" /><CodeLine lineNumber="1729"><span class="doxyHighlight">  &#125;);</span></CodeLine>
<Link id="l01730" /><CodeLine lineNumber="1730"></CodeLine>
<Link id="l01731" /><CodeLine lineNumber="1731"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (WorkList.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>())</span></CodeLine>
<Link id="l01732" /><CodeLine lineNumber="1732"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01733" /><CodeLine lineNumber="1733"></CodeLine>
<Link id="l01734" /><CodeLine lineNumber="1734"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> IsEHPad = WorkList&#91;0&#93;-&gt;isEHPad();</span></CodeLine>
<Link id="l01735" /><CodeLine lineNumber="1735"></CodeLine>
<Link id="l01736" /><CodeLine lineNumber="1736"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BestBlock = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01737" /><CodeLine lineNumber="1737"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> BestFreq;</span></CodeLine>
<Link id="l01738" /><CodeLine lineNumber="1738"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : WorkList) &#123;</span></CodeLine>
<Link id="l01739" /><CodeLine lineNumber="1739"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>-&gt;isEHPad() == IsEHPad &amp;&amp;</span></CodeLine>
<Link id="l01740" /><CodeLine lineNumber="1740"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;EHPad mismatch between block and work list.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01741" /><CodeLine lineNumber="1741"></CodeLine>
<Link id="l01742" /><CodeLine lineNumber="1742"><span class="doxyHighlight">    <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;SuccChain = &#42;BlockToChain&#91;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>&#93;;</span></CodeLine>
<Link id="l01743" /><CodeLine lineNumber="1743"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (&amp;SuccChain == &amp;Chain)</span></CodeLine>
<Link id="l01744" /><CodeLine lineNumber="1744"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01745" /><CodeLine lineNumber="1745"></CodeLine>
<Link id="l01746" /><CodeLine lineNumber="1746"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(SuccChain.UnscheduledPredecessors == 0 &amp;&amp;</span></CodeLine>
<Link id="l01747" /><CodeLine lineNumber="1747"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;Found CFG-violating block&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01748" /><CodeLine lineNumber="1748"></CodeLine>
<Link id="l01749" /><CodeLine lineNumber="1749"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> CandidateFreq = MBFI-&gt;getBlockFreq(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</span></CodeLine>
<Link id="l01750" /><CodeLine lineNumber="1750"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;    &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; -&gt; &quot;</span></CodeLine>
<Link id="l01751" /><CodeLine lineNumber="1751"><span class="doxyHighlight">                      &lt;&lt; <a href="/docs/api/namespaces/llvm/#ada715bce8140114cd2fd2f8ab018f7c3">printBlockFreq</a>(MBFI-&gt;getMBFI(), CandidateFreq)</span></CodeLine>
<Link id="l01752" /><CodeLine lineNumber="1752"><span class="doxyHighlight">                      &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; (freq)\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01753" /><CodeLine lineNumber="1753"></CodeLine>
<Link id="l01754" /><CodeLine lineNumber="1754"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// For ehpad, we layout the least probable first as to avoid jumping back</span></CodeLine>
<Link id="l01755" /><CodeLine lineNumber="1755"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// from least probable landingpads to more probable ones.</span></CodeLine>
<Link id="l01756" /><CodeLine lineNumber="1756"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01757" /><CodeLine lineNumber="1757"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// FIXME: Using probability is probably (!) not the best way to achieve</span></CodeLine>
<Link id="l01758" /><CodeLine lineNumber="1758"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// this. We should probably have a more principled approach to layout</span></CodeLine>
<Link id="l01759" /><CodeLine lineNumber="1759"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// cleanup code.</span></CodeLine>
<Link id="l01760" /><CodeLine lineNumber="1760"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01761" /><CodeLine lineNumber="1761"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// The goal is to get:</span></CodeLine>
<Link id="l01762" /><CodeLine lineNumber="1762"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01763" /><CodeLine lineNumber="1763"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//                 +--------------------------+</span></CodeLine>
<Link id="l01764" /><CodeLine lineNumber="1764"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//                 |                          V</span></CodeLine>
<Link id="l01765" /><CodeLine lineNumber="1765"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// InnerLp -&gt; InnerCleanup    OuterLp -&gt; OuterCleanup -&gt; Resume</span></CodeLine>
<Link id="l01766" /><CodeLine lineNumber="1766"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01767" /><CodeLine lineNumber="1767"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Rather than:</span></CodeLine>
<Link id="l01768" /><CodeLine lineNumber="1768"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01769" /><CodeLine lineNumber="1769"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//                 +-------------------------------------+</span></CodeLine>
<Link id="l01770" /><CodeLine lineNumber="1770"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//                 V                                     |</span></CodeLine>
<Link id="l01771" /><CodeLine lineNumber="1771"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// OuterLp -&gt; OuterCleanup -&gt; Resume     InnerLp -&gt; InnerCleanup</span></CodeLine>
<Link id="l01772" /><CodeLine lineNumber="1772"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BestBlock &amp;&amp; (IsEHPad ^ (BestFreq &gt;= CandidateFreq)))</span></CodeLine>
<Link id="l01773" /><CodeLine lineNumber="1773"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01774" /><CodeLine lineNumber="1774"></CodeLine>
<Link id="l01775" /><CodeLine lineNumber="1775"><span class="doxyHighlight">    BestBlock = <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>;</span></CodeLine>
<Link id="l01776" /><CodeLine lineNumber="1776"><span class="doxyHighlight">    BestFreq = CandidateFreq;</span></CodeLine>
<Link id="l01777" /><CodeLine lineNumber="1777"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01778" /><CodeLine lineNumber="1778"></CodeLine>
<Link id="l01779" /><CodeLine lineNumber="1779"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> BestBlock;</span></CodeLine>
<Link id="l01780" /><CodeLine lineNumber="1780"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01781" /><CodeLine lineNumber="1781"></CodeLine>
<Link id="l01782" /><CodeLine lineNumber="1782"><span class="doxyHighlightComment">/// Retrieve the first unplaced basic block in the entire function.</span></CodeLine>
<Link id="l01783" /><CodeLine lineNumber="1783"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01784" /><CodeLine lineNumber="1784"><span class="doxyHighlightComment">/// This routine is called when we are unable to use the CFG to walk through</span></CodeLine>
<Link id="l01785" /><CodeLine lineNumber="1785"><span class="doxyHighlightComment">/// all of the basic blocks and form a chain due to unnatural loops in the CFG.</span></CodeLine>
<Link id="l01786" /><CodeLine lineNumber="1786"><span class="doxyHighlightComment">/// We walk through the function&#39;s blocks in order, starting from the</span></CodeLine>
<Link id="l01787" /><CodeLine lineNumber="1787"><span class="doxyHighlightComment">/// LastUnplacedBlockIt. We update this iterator on each call to avoid</span></CodeLine>
<Link id="l01788" /><CodeLine lineNumber="1788"><span class="doxyHighlightComment">/// re-scanning the entire sequence on repeated calls to this routine.</span></CodeLine>
<Link id="l01789" /><CodeLine lineNumber="1789"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;MachineBlockPlacement::getFirstUnplacedBlock(</span></CodeLine>
<Link id="l01790" /><CodeLine lineNumber="1790"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;PlacedChain,</span></CodeLine>
<Link id="l01791" /><CodeLine lineNumber="1791"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinefunction/#aaba82c71ffdca966cad10eae0992fff9">MachineFunction::iterator</a> &amp;PrevUnplacedBlockIt) &#123;</span></CodeLine>
<Link id="l01792" /><CodeLine lineNumber="1792"></CodeLine>
<Link id="l01793" /><CodeLine lineNumber="1793"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinefunction/#aaba82c71ffdca966cad10eae0992fff9">MachineFunction::iterator</a> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = PrevUnplacedBlockIt, <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#abb2b3a60ccc38a28239e19a1646e0c8a">E</a> = <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;end(); <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> != <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#abb2b3a60ccc38a28239e19a1646e0c8a">E</a>;</span></CodeLine>
<Link id="l01794" /><CodeLine lineNumber="1794"><span class="doxyHighlight">       ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &#123;</span></CodeLine>
<Link id="l01795" /><CodeLine lineNumber="1795"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BlockToChain&#91;&amp;&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; != &amp;PlacedChain) &#123;</span></CodeLine>
<Link id="l01796" /><CodeLine lineNumber="1796"><span class="doxyHighlight">      PrevUnplacedBlockIt = <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l01797" /><CodeLine lineNumber="1797"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Now select the head of the chain to which the unplaced block belongs</span></CodeLine>
<Link id="l01798" /><CodeLine lineNumber="1798"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// as the block to place. This will force the entire chain to be placed,</span></CodeLine>
<Link id="l01799" /><CodeLine lineNumber="1799"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// and satisfies the requirements of merging chains.</span></CodeLine>
<Link id="l01800" /><CodeLine lineNumber="1800"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &#42;BlockToChain&#91;&amp;&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93;-&gt;begin();</span></CodeLine>
<Link id="l01801" /><CodeLine lineNumber="1801"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01802" /><CodeLine lineNumber="1802"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01803" /><CodeLine lineNumber="1803"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01804" /><CodeLine lineNumber="1804"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01805" /><CodeLine lineNumber="1805"></CodeLine>
<Link id="l01806" /><CodeLine lineNumber="1806"><span class="doxyHighlightComment">/// Retrieve the first unplaced basic block among the blocks in BlockFilter.</span></CodeLine>
<Link id="l01807" /><CodeLine lineNumber="1807"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01808" /><CodeLine lineNumber="1808"><span class="doxyHighlightComment">/// This is similar to getFirstUnplacedBlock for the entire function, but since</span></CodeLine>
<Link id="l01809" /><CodeLine lineNumber="1809"><span class="doxyHighlightComment">/// the size of BlockFilter is typically far less than the number of blocks in</span></CodeLine>
<Link id="l01810" /><CodeLine lineNumber="1810"><span class="doxyHighlightComment">/// the entire function, iterating through the BlockFilter is more efficient.</span></CodeLine>
<Link id="l01811" /><CodeLine lineNumber="1811"><span class="doxyHighlightComment">/// When processing the entire funciton, using the version without BlockFilter</span></CodeLine>
<Link id="l01812" /><CodeLine lineNumber="1812"><span class="doxyHighlightComment">/// has a complexity of #(loops in function) &#42; #(blocks in function), while this</span></CodeLine>
<Link id="l01813" /><CodeLine lineNumber="1813"><span class="doxyHighlightComment">/// version has a complexity of sum(#(loops in block) foreach block in function)</span></CodeLine>
<Link id="l01814" /><CodeLine lineNumber="1814"><span class="doxyHighlightComment">/// which is always smaller. For long function mostly sequential in structure,</span></CodeLine>
<Link id="l01815" /><CodeLine lineNumber="1815"><span class="doxyHighlightComment">/// the complexity is amortized to 1 &#42; #(blocks in function).</span></CodeLine>
<Link id="l01816" /><CodeLine lineNumber="1816"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;MachineBlockPlacement::getFirstUnplacedBlock(</span></CodeLine>
<Link id="l01817" /><CodeLine lineNumber="1817"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;PlacedChain,</span></CodeLine>
<Link id="l01818" /><CodeLine lineNumber="1818"><span class="doxyHighlight">    BlockFilterSet::iterator &amp;PrevUnplacedBlockInFilterIt,</span></CodeLine>
<Link id="l01819" /><CodeLine lineNumber="1819"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter) &#123;</span></CodeLine>
<Link id="l01820" /><CodeLine lineNumber="1820"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BlockFilter);</span></CodeLine>
<Link id="l01821" /><CodeLine lineNumber="1821"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (; PrevUnplacedBlockInFilterIt != BlockFilter-&gt;end();</span></CodeLine>
<Link id="l01822" /><CodeLine lineNumber="1822"><span class="doxyHighlight">       ++PrevUnplacedBlockInFilterIt) &#123;</span></CodeLine>
<Link id="l01823" /><CodeLine lineNumber="1823"><span class="doxyHighlight">    <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a> = BlockToChain&#91;&#42;PrevUnplacedBlockInFilterIt&#93;;</span></CodeLine>
<Link id="l01824" /><CodeLine lineNumber="1824"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a> != &amp;PlacedChain) &#123;</span></CodeLine>
<Link id="l01825" /><CodeLine lineNumber="1825"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &#42;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>-&gt;begin();</span></CodeLine>
<Link id="l01826" /><CodeLine lineNumber="1826"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01827" /><CodeLine lineNumber="1827"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01828" /><CodeLine lineNumber="1828"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01829" /><CodeLine lineNumber="1829"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01830" /><CodeLine lineNumber="1830"></CodeLine>
<Link id="l01831" /><CodeLine lineNumber="1831"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> MachineBlockPlacement::fillWorkLists(</span></CodeLine>
<Link id="l01832" /><CodeLine lineNumber="1832"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/classes/llvm/smallptrsetimpl">SmallPtrSetImpl&lt;BlockChain &#42;&gt;</a> &amp;UpdatedPreds,</span></CodeLine>
<Link id="l01833" /><CodeLine lineNumber="1833"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &#42;BlockFilter = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">) &#123;</span></CodeLine>
<Link id="l01834" /><CodeLine lineNumber="1834"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;<a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a> = &#42;BlockToChain&#91;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>&#93;;</span></CodeLine>
<Link id="l01835" /><CodeLine lineNumber="1835"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!UpdatedPreds.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(&amp;Chain).second)</span></CodeLine>
<Link id="l01836" /><CodeLine lineNumber="1836"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01837" /><CodeLine lineNumber="1837"></CodeLine>
<Link id="l01838" /><CodeLine lineNumber="1838"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(</span></CodeLine>
<Link id="l01839" /><CodeLine lineNumber="1839"><span class="doxyHighlight">      <a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>.UnscheduledPredecessors == 0 &amp;&amp;</span></CodeLine>
<Link id="l01840" /><CodeLine lineNumber="1840"><span class="doxyHighlight">      </span><span class="doxyHighlightStringLiteral">&quot;Attempting to place block with unscheduled predecessors in worklist.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01841" /><CodeLine lineNumber="1841"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;ChainBB : Chain) &#123;</span></CodeLine>
<Link id="l01842" /><CodeLine lineNumber="1842"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BlockToChain&#91;ChainBB&#93; == &amp;Chain &amp;&amp;</span></CodeLine>
<Link id="l01843" /><CodeLine lineNumber="1843"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;Block in chain doesn&#39;t match BlockToChain map.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01844" /><CodeLine lineNumber="1844"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Pred : ChainBB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#addd80df79ba902914c7d8a52e3896b79">predecessors</a>()) &#123;</span></CodeLine>
<Link id="l01845" /><CodeLine lineNumber="1845"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BlockFilter &amp;&amp; !BlockFilter-&gt;count(Pred))</span></CodeLine>
<Link id="l01846" /><CodeLine lineNumber="1846"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01847" /><CodeLine lineNumber="1847"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BlockToChain&#91;Pred&#93; == &amp;Chain)</span></CodeLine>
<Link id="l01848" /><CodeLine lineNumber="1848"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01849" /><CodeLine lineNumber="1849"><span class="doxyHighlight">      ++<a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>.UnscheduledPredecessors;</span></CodeLine>
<Link id="l01850" /><CodeLine lineNumber="1850"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01851" /><CodeLine lineNumber="1851"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01852" /><CodeLine lineNumber="1852"></CodeLine>
<Link id="l01853" /><CodeLine lineNumber="1853"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>.UnscheduledPredecessors != 0)</span></CodeLine>
<Link id="l01854" /><CodeLine lineNumber="1854"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01855" /><CodeLine lineNumber="1855"></CodeLine>
<Link id="l01856" /><CodeLine lineNumber="1856"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB = &#42;<a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a8a045d250952c0867382a9840ee18fdf">begin</a>();</span></CodeLine>
<Link id="l01857" /><CodeLine lineNumber="1857"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a1100bfbadd996d464150c6a68fa8dc1d">isEHPad</a>())</span></CodeLine>
<Link id="l01858" /><CodeLine lineNumber="1858"><span class="doxyHighlight">    EHPadWorkList.push&#95;back(BB);</span></CodeLine>
<Link id="l01859" /><CodeLine lineNumber="1859"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l01860" /><CodeLine lineNumber="1860"><span class="doxyHighlight">    BlockWorkList.push&#95;back(BB);</span></CodeLine>
<Link id="l01861" /><CodeLine lineNumber="1861"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01862" /><CodeLine lineNumber="1862"></CodeLine>
<Link id="l01863" /><CodeLine lineNumber="1863"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> MachineBlockPlacement::buildChain(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;HeadBB,</span></CodeLine>
<Link id="l01864" /><CodeLine lineNumber="1864"><span class="doxyHighlight">                                       <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;Chain,</span></CodeLine>
<Link id="l01865" /><CodeLine lineNumber="1865"><span class="doxyHighlight">                                       BlockFilterSet &#42;BlockFilter) &#123;</span></CodeLine>
<Link id="l01866" /><CodeLine lineNumber="1866"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(HeadBB &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;BB must not be null.\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01867" /><CodeLine lineNumber="1867"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BlockToChain&#91;HeadBB&#93; == &amp;Chain &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;BlockToChainMap mis-match.\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01868" /><CodeLine lineNumber="1868"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinefunction/#aaba82c71ffdca966cad10eae0992fff9">MachineFunction::iterator</a> PrevUnplacedBlockIt = <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;begin();</span></CodeLine>
<Link id="l01869" /><CodeLine lineNumber="1869"><span class="doxyHighlight">  BlockFilterSet::iterator PrevUnplacedBlockInFilterIt;</span></CodeLine>
<Link id="l01870" /><CodeLine lineNumber="1870"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BlockFilter)</span></CodeLine>
<Link id="l01871" /><CodeLine lineNumber="1871"><span class="doxyHighlight">    PrevUnplacedBlockInFilterIt = BlockFilter-&gt;begin();</span></CodeLine>
<Link id="l01872" /><CodeLine lineNumber="1872"></CodeLine>
<Link id="l01873" /><CodeLine lineNumber="1873"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;LoopHeaderBB = HeadBB;</span></CodeLine>
<Link id="l01874" /><CodeLine lineNumber="1874"><span class="doxyHighlight">  markChainSuccessors(Chain, LoopHeaderBB, BlockFilter);</span></CodeLine>
<Link id="l01875" /><CodeLine lineNumber="1875"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB = &#42;std::prev(<a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a075e34e98605d0e7c289763a104869ac">end</a>());</span></CodeLine>
<Link id="l01876" /><CodeLine lineNumber="1876"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">while</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">) &#123;</span></CodeLine>
<Link id="l01877" /><CodeLine lineNumber="1877"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BB &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;null block found at end of chain in loop.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01878" /><CodeLine lineNumber="1878"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BlockToChain&#91;BB&#93; == &amp;Chain &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;BlockToChainMap mis-match in loop.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01879" /><CodeLine lineNumber="1879"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(&#42;std::prev(<a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a075e34e98605d0e7c289763a104869ac">end</a>()) == BB &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;BB Not found at end of chain.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01880" /><CodeLine lineNumber="1880"></CodeLine>
<Link id="l01881" /><CodeLine lineNumber="1881"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Look for the best viable successor if there is one to place immediately</span></CodeLine>
<Link id="l01882" /><CodeLine lineNumber="1882"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// after this block.</span></CodeLine>
<Link id="l01883" /><CodeLine lineNumber="1883"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/ms-demangle/#afb795990ffc0cb7321e7d1eacc246324a8eea62084ca7e541d918e823422bd82e">Result</a> = selectBestSuccessor(BB, Chain, BlockFilter);</span></CodeLine>
<Link id="l01884" /><CodeLine lineNumber="1884"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BestSucc = <a href="/docs/api/namespaces/llvm/ms-demangle/#afb795990ffc0cb7321e7d1eacc246324a8eea62084ca7e541d918e823422bd82e">Result</a>.BB;</span></CodeLine>
<Link id="l01885" /><CodeLine lineNumber="1885"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> ShouldTailDup = <a href="/docs/api/namespaces/llvm/ms-demangle/#afb795990ffc0cb7321e7d1eacc246324a8eea62084ca7e541d918e823422bd82e">Result</a>.ShouldTailDup;</span></CodeLine>
<Link id="l01886" /><CodeLine lineNumber="1886"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#ad65badde897b7d4f51fc7c545538a388">allowTailDupPlacement</a>())</span></CodeLine>
<Link id="l01887" /><CodeLine lineNumber="1887"><span class="doxyHighlight">      ShouldTailDup |= (BestSucc &amp;&amp; canTailDuplicateUnplacedPreds(</span></CodeLine>
<Link id="l01888" /><CodeLine lineNumber="1888"><span class="doxyHighlight">                                        BB, BestSucc, Chain, BlockFilter));</span></CodeLine>
<Link id="l01889" /><CodeLine lineNumber="1889"></CodeLine>
<Link id="l01890" /><CodeLine lineNumber="1890"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If an immediate successor isn&#39;t available, look for the best viable</span></CodeLine>
<Link id="l01891" /><CodeLine lineNumber="1891"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// block among those we&#39;ve identified as not violating the loop&#39;s CFG at</span></CodeLine>
<Link id="l01892" /><CodeLine lineNumber="1892"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// this point. This won&#39;t be a fallthrough, but it will increase locality.</span></CodeLine>
<Link id="l01893" /><CodeLine lineNumber="1893"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!BestSucc)</span></CodeLine>
<Link id="l01894" /><CodeLine lineNumber="1894"><span class="doxyHighlight">      BestSucc = selectBestCandidateBlock(Chain, BlockWorkList);</span></CodeLine>
<Link id="l01895" /><CodeLine lineNumber="1895"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!BestSucc)</span></CodeLine>
<Link id="l01896" /><CodeLine lineNumber="1896"><span class="doxyHighlight">      BestSucc = selectBestCandidateBlock(Chain, EHPadWorkList);</span></CodeLine>
<Link id="l01897" /><CodeLine lineNumber="1897"></CodeLine>
<Link id="l01898" /><CodeLine lineNumber="1898"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!BestSucc) &#123;</span></CodeLine>
<Link id="l01899" /><CodeLine lineNumber="1899"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BlockFilter)</span></CodeLine>
<Link id="l01900" /><CodeLine lineNumber="1900"><span class="doxyHighlight">        BestSucc = getFirstUnplacedBlock(Chain, PrevUnplacedBlockInFilterIt,</span></CodeLine>
<Link id="l01901" /><CodeLine lineNumber="1901"><span class="doxyHighlight">                                         BlockFilter);</span></CodeLine>
<Link id="l01902" /><CodeLine lineNumber="1902"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l01903" /><CodeLine lineNumber="1903"><span class="doxyHighlight">        BestSucc = getFirstUnplacedBlock(Chain, PrevUnplacedBlockIt);</span></CodeLine>
<Link id="l01904" /><CodeLine lineNumber="1904"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!BestSucc)</span></CodeLine>
<Link id="l01905" /><CodeLine lineNumber="1905"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01906" /><CodeLine lineNumber="1906"></CodeLine>
<Link id="l01907" /><CodeLine lineNumber="1907"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Unnatural loop CFG detected, forcibly merging the &quot;</span></CodeLine>
<Link id="l01908" /><CodeLine lineNumber="1908"><span class="doxyHighlight">                           </span><span class="doxyHighlightStringLiteral">&quot;layout successor until the CFG reduces\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01909" /><CodeLine lineNumber="1909"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01910" /><CodeLine lineNumber="1910"></CodeLine>
<Link id="l01911" /><CodeLine lineNumber="1911"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Placement may have changed tail duplication opportunities.</span></CodeLine>
<Link id="l01912" /><CodeLine lineNumber="1912"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Check for that now.</span></CodeLine>
<Link id="l01913" /><CodeLine lineNumber="1913"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#ad65badde897b7d4f51fc7c545538a388">allowTailDupPlacement</a>() &amp;&amp; BestSucc &amp;&amp; ShouldTailDup) &#123;</span></CodeLine>
<Link id="l01914" /><CodeLine lineNumber="1914"><span class="doxyHighlight">      repeatedlyTailDuplicateBlock(BestSucc, BB, LoopHeaderBB, Chain,</span></CodeLine>
<Link id="l01915" /><CodeLine lineNumber="1915"><span class="doxyHighlight">                                   BlockFilter, PrevUnplacedBlockIt,</span></CodeLine>
<Link id="l01916" /><CodeLine lineNumber="1916"><span class="doxyHighlight">                                   PrevUnplacedBlockInFilterIt);</span></CodeLine>
<Link id="l01917" /><CodeLine lineNumber="1917"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If the chosen successor was duplicated into BB, don&#39;t bother laying</span></CodeLine>
<Link id="l01918" /><CodeLine lineNumber="1918"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// it out, just go round the loop again with BB as the chain end.</span></CodeLine>
<Link id="l01919" /><CodeLine lineNumber="1919"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#adc8f1be4a77ae671ac139d5f06b44deb">isSuccessor</a>(BestSucc))</span></CodeLine>
<Link id="l01920" /><CodeLine lineNumber="1920"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01921" /><CodeLine lineNumber="1921"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01922" /><CodeLine lineNumber="1922"></CodeLine>
<Link id="l01923" /><CodeLine lineNumber="1923"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Place this block, updating the datastructures to reflect its placement.</span></CodeLine>
<Link id="l01924" /><CodeLine lineNumber="1924"><span class="doxyHighlight">    <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;SuccChain = &#42;BlockToChain&#91;BestSucc&#93;;</span></CodeLine>
<Link id="l01925" /><CodeLine lineNumber="1925"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Zero out UnscheduledPredecessors for the successor we&#39;re about to merge</span></CodeLine>
<Link id="l01926" /><CodeLine lineNumber="1926"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// in case we selected a successor that didn&#39;t fit naturally into the CFG.</span></CodeLine>
<Link id="l01927" /><CodeLine lineNumber="1927"><span class="doxyHighlight">    SuccChain.UnscheduledPredecessors = 0;</span></CodeLine>
<Link id="l01928" /><CodeLine lineNumber="1928"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Merging from &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(BB) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; to &quot;</span></CodeLine>
<Link id="l01929" /><CodeLine lineNumber="1929"><span class="doxyHighlight">                      &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(BestSucc) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01930" /><CodeLine lineNumber="1930"><span class="doxyHighlight">    markChainSuccessors(SuccChain, LoopHeaderBB, BlockFilter);</span></CodeLine>
<Link id="l01931" /><CodeLine lineNumber="1931"><span class="doxyHighlight">    <a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>.merge(BestSucc, &amp;SuccChain);</span></CodeLine>
<Link id="l01932" /><CodeLine lineNumber="1932"><span class="doxyHighlight">    BB = &#42;std::prev(<a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a075e34e98605d0e7c289763a104869ac">end</a>());</span></CodeLine>
<Link id="l01933" /><CodeLine lineNumber="1933"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01934" /><CodeLine lineNumber="1934"></CodeLine>
<Link id="l01935" /><CodeLine lineNumber="1935"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Finished forming chain for header block &quot;</span></CodeLine>
<Link id="l01936" /><CodeLine lineNumber="1936"><span class="doxyHighlight">                    &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(&#42;<a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a8a045d250952c0867382a9840ee18fdf">begin</a>()) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01937" /><CodeLine lineNumber="1937"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01938" /><CodeLine lineNumber="1938"></CodeLine>
<Link id="l01939" /><CodeLine lineNumber="1939"><span class="doxyHighlightComment">// If bottom of block BB has only one successor OldTop, in most cases it is</span></CodeLine>
<Link id="l01940" /><CodeLine lineNumber="1940"><span class="doxyHighlightComment">// profitable to move it before OldTop, except the following case:</span></CodeLine>
<Link id="l01941" /><CodeLine lineNumber="1941"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01942" /><CodeLine lineNumber="1942"><span class="doxyHighlightComment">//     --&gt;OldTop&lt;-</span></CodeLine>
<Link id="l01943" /><CodeLine lineNumber="1943"><span class="doxyHighlightComment">//     |    .    |</span></CodeLine>
<Link id="l01944" /><CodeLine lineNumber="1944"><span class="doxyHighlightComment">//     |    .    |</span></CodeLine>
<Link id="l01945" /><CodeLine lineNumber="1945"><span class="doxyHighlightComment">//     |    .    |</span></CodeLine>
<Link id="l01946" /><CodeLine lineNumber="1946"><span class="doxyHighlightComment">//     ---Pred   |</span></CodeLine>
<Link id="l01947" /><CodeLine lineNumber="1947"><span class="doxyHighlightComment">//          |    |</span></CodeLine>
<Link id="l01948" /><CodeLine lineNumber="1948"><span class="doxyHighlightComment">//         BB-----</span></CodeLine>
<Link id="l01949" /><CodeLine lineNumber="1949"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01950" /><CodeLine lineNumber="1950"><span class="doxyHighlightComment">// If BB is moved before OldTop, Pred needs a taken branch to BB, and it can&#39;t</span></CodeLine>
<Link id="l01951" /><CodeLine lineNumber="1951"><span class="doxyHighlightComment">// layout the other successor below it, so it can&#39;t reduce taken branch.</span></CodeLine>
<Link id="l01952" /><CodeLine lineNumber="1952"><span class="doxyHighlightComment">// In this case we keep its original layout.</span></CodeLine>
<Link id="l01953" /><CodeLine lineNumber="1953"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> MachineBlockPlacement::canMoveBottomBlockToTop(</span></CodeLine>
<Link id="l01954" /><CodeLine lineNumber="1954"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BottomBlock, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;OldTop) &#123;</span></CodeLine>
<Link id="l01955" /><CodeLine lineNumber="1955"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BottomBlock-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a03936a9b37da541420049422204ab206">pred&#95;size</a>() != 1)</span></CodeLine>
<Link id="l01956" /><CodeLine lineNumber="1956"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01957" /><CodeLine lineNumber="1957"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Pred = &#42;BottomBlock-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#ab644fcf07a4c2708333cf66276282357">pred&#95;begin</a>();</span></CodeLine>
<Link id="l01958" /><CodeLine lineNumber="1958"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Pred-&gt;succ&#95;size() != 2)</span></CodeLine>
<Link id="l01959" /><CodeLine lineNumber="1959"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01960" /><CodeLine lineNumber="1960"></CodeLine>
<Link id="l01961" /><CodeLine lineNumber="1961"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;OtherBB = &#42;Pred-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a6321b189ea8fd5058663f8a87d6c23e9">succ&#95;begin</a>();</span></CodeLine>
<Link id="l01962" /><CodeLine lineNumber="1962"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (OtherBB == BottomBlock)</span></CodeLine>
<Link id="l01963" /><CodeLine lineNumber="1963"><span class="doxyHighlight">    OtherBB = &#42;Pred-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#abd32ea34faf1cde285a1b8daccd9c167">succ&#95;rbegin</a>();</span></CodeLine>
<Link id="l01964" /><CodeLine lineNumber="1964"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (OtherBB == OldTop)</span></CodeLine>
<Link id="l01965" /><CodeLine lineNumber="1965"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01966" /><CodeLine lineNumber="1966"></CodeLine>
<Link id="l01967" /><CodeLine lineNumber="1967"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01968" /><CodeLine lineNumber="1968"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01969" /><CodeLine lineNumber="1969"></CodeLine>
<Link id="l01970" /><CodeLine lineNumber="1970"><span class="doxyHighlightComment">// Find out the possible fall through frequence to the top of a loop.</span></CodeLine>
<Link id="l01971" /><CodeLine lineNumber="1971"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a></span></CodeLine>
<Link id="l01972" /><CodeLine lineNumber="1972"><span class="doxyHighlight">MachineBlockPlacement::TopFallThroughFreq(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Top,</span></CodeLine>
<Link id="l01973" /><CodeLine lineNumber="1973"><span class="doxyHighlight">                                          </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &amp;LoopBlockSet) &#123;</span></CodeLine>
<Link id="l01974" /><CodeLine lineNumber="1974"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> MaxFreq = <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>(0);</span></CodeLine>
<Link id="l01975" /><CodeLine lineNumber="1975"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Pred : Top-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#addd80df79ba902914c7d8a52e3896b79">predecessors</a>()) &#123;</span></CodeLine>
<Link id="l01976" /><CodeLine lineNumber="1976"><span class="doxyHighlight">    <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;PredChain = BlockToChain&#91;Pred&#93;;</span></CodeLine>
<Link id="l01977" /><CodeLine lineNumber="1977"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!LoopBlockSet.count(Pred) &amp;&amp;</span></CodeLine>
<Link id="l01978" /><CodeLine lineNumber="1978"><span class="doxyHighlight">        (!PredChain || Pred == &#42;std::prev(PredChain-&gt;end()))) &#123;</span></CodeLine>
<Link id="l01979" /><CodeLine lineNumber="1979"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Found a Pred block can be placed before Top.</span></CodeLine>
<Link id="l01980" /><CodeLine lineNumber="1980"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Check if Top is the best successor of Pred.</span></CodeLine>
<Link id="l01981" /><CodeLine lineNumber="1981"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> TopProb = MBPI-&gt;getEdgeProbability(Pred, Top);</span></CodeLine>
<Link id="l01982" /><CodeLine lineNumber="1982"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> TopOK = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01983" /><CodeLine lineNumber="1983"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ : Pred-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#ad88ff1529541fb4e243cc8ed90b11131">successors</a>()) &#123;</span></CodeLine>
<Link id="l01984" /><CodeLine lineNumber="1984"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> SuccProb = MBPI-&gt;getEdgeProbability(Pred, Succ);</span></CodeLine>
<Link id="l01985" /><CodeLine lineNumber="1985"><span class="doxyHighlight">        <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;SuccChain = BlockToChain&#91;Succ&#93;;</span></CodeLine>
<Link id="l01986" /><CodeLine lineNumber="1986"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Check if Succ can be placed after Pred.</span></CodeLine>
<Link id="l01987" /><CodeLine lineNumber="1987"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Succ should not be in any chain, or it is the head of some chain.</span></CodeLine>
<Link id="l01988" /><CodeLine lineNumber="1988"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!LoopBlockSet.count(Succ) &amp;&amp; (SuccProb &gt; TopProb) &amp;&amp;</span></CodeLine>
<Link id="l01989" /><CodeLine lineNumber="1989"><span class="doxyHighlight">            (!SuccChain || Succ == &#42;SuccChain-&gt;begin())) &#123;</span></CodeLine>
<Link id="l01990" /><CodeLine lineNumber="1990"><span class="doxyHighlight">          TopOK = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01991" /><CodeLine lineNumber="1991"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01992" /><CodeLine lineNumber="1992"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l01993" /><CodeLine lineNumber="1993"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01994" /><CodeLine lineNumber="1994"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (TopOK) &#123;</span></CodeLine>
<Link id="l01995" /><CodeLine lineNumber="1995"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> EdgeFreq =</span></CodeLine>
<Link id="l01996" /><CodeLine lineNumber="1996"><span class="doxyHighlight">            MBFI-&gt;getBlockFreq(Pred) &#42; MBPI-&gt;getEdgeProbability(Pred, Top);</span></CodeLine>
<Link id="l01997" /><CodeLine lineNumber="1997"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (EdgeFreq &gt; MaxFreq)</span></CodeLine>
<Link id="l01998" /><CodeLine lineNumber="1998"><span class="doxyHighlight">          MaxFreq = EdgeFreq;</span></CodeLine>
<Link id="l01999" /><CodeLine lineNumber="1999"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l02000" /><CodeLine lineNumber="2000"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02001" /><CodeLine lineNumber="2001"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02002" /><CodeLine lineNumber="2002"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> MaxFreq;</span></CodeLine>
<Link id="l02003" /><CodeLine lineNumber="2003"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02004" /><CodeLine lineNumber="2004"></CodeLine>
<Link id="l02005" /><CodeLine lineNumber="2005"><span class="doxyHighlightComment">// Compute the fall through gains when move NewTop before OldTop.</span></CodeLine>
<Link id="l02006" /><CodeLine lineNumber="2006"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l02007" /><CodeLine lineNumber="2007"><span class="doxyHighlightComment">// In following diagram, edges marked as &quot;-&quot; are reduced fallthrough, edges</span></CodeLine>
<Link id="l02008" /><CodeLine lineNumber="2008"><span class="doxyHighlightComment">// marked as &quot;+&quot; are increased fallthrough, this function computes</span></CodeLine>
<Link id="l02009" /><CodeLine lineNumber="2009"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l02010" /><CodeLine lineNumber="2010"><span class="doxyHighlightComment">//      SUM(increased fallthrough) - SUM(decreased fallthrough)</span></CodeLine>
<Link id="l02011" /><CodeLine lineNumber="2011"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l02012" /><CodeLine lineNumber="2012"><span class="doxyHighlightComment">//              |</span></CodeLine>
<Link id="l02013" /><CodeLine lineNumber="2013"><span class="doxyHighlightComment">//              | -</span></CodeLine>
<Link id="l02014" /><CodeLine lineNumber="2014"><span class="doxyHighlightComment">//              V</span></CodeLine>
<Link id="l02015" /><CodeLine lineNumber="2015"><span class="doxyHighlightComment">//        ---&gt;OldTop</span></CodeLine>
<Link id="l02016" /><CodeLine lineNumber="2016"><span class="doxyHighlightComment">//        |     .</span></CodeLine>
<Link id="l02017" /><CodeLine lineNumber="2017"><span class="doxyHighlightComment">//        |     .</span></CodeLine>
<Link id="l02018" /><CodeLine lineNumber="2018"><span class="doxyHighlightComment">//       +|     .    +</span></CodeLine>
<Link id="l02019" /><CodeLine lineNumber="2019"><span class="doxyHighlightComment">//        |   Pred ---&gt;</span></CodeLine>
<Link id="l02020" /><CodeLine lineNumber="2020"><span class="doxyHighlightComment">//        |     |-</span></CodeLine>
<Link id="l02021" /><CodeLine lineNumber="2021"><span class="doxyHighlightComment">//        |     V</span></CodeLine>
<Link id="l02022" /><CodeLine lineNumber="2022"><span class="doxyHighlightComment">//        --- NewTop &lt;---</span></CodeLine>
<Link id="l02023" /><CodeLine lineNumber="2023"><span class="doxyHighlightComment">//              |-</span></CodeLine>
<Link id="l02024" /><CodeLine lineNumber="2024"><span class="doxyHighlightComment">//              V</span></CodeLine>
<Link id="l02025" /><CodeLine lineNumber="2025"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l02026" /><CodeLine lineNumber="2026"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> MachineBlockPlacement::FallThroughGains(</span></CodeLine>
<Link id="l02027" /><CodeLine lineNumber="2027"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;NewTop, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;OldTop,</span></CodeLine>
<Link id="l02028" /><CodeLine lineNumber="2028"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;ExitBB, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &amp;LoopBlockSet) &#123;</span></CodeLine>
<Link id="l02029" /><CodeLine lineNumber="2029"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> FallThrough2Top = TopFallThroughFreq(OldTop, LoopBlockSet);</span></CodeLine>
<Link id="l02030" /><CodeLine lineNumber="2030"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> FallThrough2Exit = <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>(0);</span></CodeLine>
<Link id="l02031" /><CodeLine lineNumber="2031"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ExitBB)</span></CodeLine>
<Link id="l02032" /><CodeLine lineNumber="2032"><span class="doxyHighlight">    FallThrough2Exit =</span></CodeLine>
<Link id="l02033" /><CodeLine lineNumber="2033"><span class="doxyHighlight">        MBFI-&gt;getBlockFreq(NewTop) &#42; MBPI-&gt;getEdgeProbability(NewTop, ExitBB);</span></CodeLine>
<Link id="l02034" /><CodeLine lineNumber="2034"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> BackEdgeFreq =</span></CodeLine>
<Link id="l02035" /><CodeLine lineNumber="2035"><span class="doxyHighlight">      MBFI-&gt;getBlockFreq(NewTop) &#42; MBPI-&gt;getEdgeProbability(NewTop, OldTop);</span></CodeLine>
<Link id="l02036" /><CodeLine lineNumber="2036"></CodeLine>
<Link id="l02037" /><CodeLine lineNumber="2037"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Find the best Pred of NewTop.</span></CodeLine>
<Link id="l02038" /><CodeLine lineNumber="2038"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BestPred = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02039" /><CodeLine lineNumber="2039"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> FallThroughFromPred = <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>(0);</span></CodeLine>
<Link id="l02040" /><CodeLine lineNumber="2040"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Pred : NewTop-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#addd80df79ba902914c7d8a52e3896b79">predecessors</a>()) &#123;</span></CodeLine>
<Link id="l02041" /><CodeLine lineNumber="2041"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!LoopBlockSet.count(Pred))</span></CodeLine>
<Link id="l02042" /><CodeLine lineNumber="2042"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02043" /><CodeLine lineNumber="2043"><span class="doxyHighlight">    <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;PredChain = BlockToChain&#91;Pred&#93;;</span></CodeLine>
<Link id="l02044" /><CodeLine lineNumber="2044"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!PredChain || Pred == &#42;std::prev(PredChain-&gt;end())) &#123;</span></CodeLine>
<Link id="l02045" /><CodeLine lineNumber="2045"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> EdgeFreq =</span></CodeLine>
<Link id="l02046" /><CodeLine lineNumber="2046"><span class="doxyHighlight">          MBFI-&gt;getBlockFreq(Pred) &#42; MBPI-&gt;getEdgeProbability(Pred, NewTop);</span></CodeLine>
<Link id="l02047" /><CodeLine lineNumber="2047"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (EdgeFreq &gt; FallThroughFromPred) &#123;</span></CodeLine>
<Link id="l02048" /><CodeLine lineNumber="2048"><span class="doxyHighlight">        FallThroughFromPred = EdgeFreq;</span></CodeLine>
<Link id="l02049" /><CodeLine lineNumber="2049"><span class="doxyHighlight">        BestPred = Pred;</span></CodeLine>
<Link id="l02050" /><CodeLine lineNumber="2050"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l02051" /><CodeLine lineNumber="2051"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02052" /><CodeLine lineNumber="2052"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02053" /><CodeLine lineNumber="2053"></CodeLine>
<Link id="l02054" /><CodeLine lineNumber="2054"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If NewTop is not placed after Pred, another successor can be placed</span></CodeLine>
<Link id="l02055" /><CodeLine lineNumber="2055"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// after Pred.</span></CodeLine>
<Link id="l02056" /><CodeLine lineNumber="2056"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> NewFreq = <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>(0);</span></CodeLine>
<Link id="l02057" /><CodeLine lineNumber="2057"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BestPred) &#123;</span></CodeLine>
<Link id="l02058" /><CodeLine lineNumber="2058"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ : BestPred-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#ad88ff1529541fb4e243cc8ed90b11131">successors</a>()) &#123;</span></CodeLine>
<Link id="l02059" /><CodeLine lineNumber="2059"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> ((Succ == NewTop) || (Succ == BestPred) || !LoopBlockSet.count(Succ))</span></CodeLine>
<Link id="l02060" /><CodeLine lineNumber="2060"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02061" /><CodeLine lineNumber="2061"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ComputedEdges.contains(Succ))</span></CodeLine>
<Link id="l02062" /><CodeLine lineNumber="2062"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02063" /><CodeLine lineNumber="2063"><span class="doxyHighlight">      <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;SuccChain = BlockToChain&#91;Succ&#93;;</span></CodeLine>
<Link id="l02064" /><CodeLine lineNumber="2064"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> ((SuccChain &amp;&amp; (Succ != &#42;SuccChain-&gt;begin())) ||</span></CodeLine>
<Link id="l02065" /><CodeLine lineNumber="2065"><span class="doxyHighlight">          (SuccChain == BlockToChain&#91;BestPred&#93;))</span></CodeLine>
<Link id="l02066" /><CodeLine lineNumber="2066"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02067" /><CodeLine lineNumber="2067"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> EdgeFreq = MBFI-&gt;getBlockFreq(BestPred) &#42;</span></CodeLine>
<Link id="l02068" /><CodeLine lineNumber="2068"><span class="doxyHighlight">                                MBPI-&gt;getEdgeProbability(BestPred, Succ);</span></CodeLine>
<Link id="l02069" /><CodeLine lineNumber="2069"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (EdgeFreq &gt; NewFreq)</span></CodeLine>
<Link id="l02070" /><CodeLine lineNumber="2070"><span class="doxyHighlight">        NewFreq = EdgeFreq;</span></CodeLine>
<Link id="l02071" /><CodeLine lineNumber="2071"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02072" /><CodeLine lineNumber="2072"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> OrigEdgeFreq = MBFI-&gt;getBlockFreq(BestPred) &#42;</span></CodeLine>
<Link id="l02073" /><CodeLine lineNumber="2073"><span class="doxyHighlight">                                  MBPI-&gt;getEdgeProbability(BestPred, NewTop);</span></CodeLine>
<Link id="l02074" /><CodeLine lineNumber="2074"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NewFreq &gt; OrigEdgeFreq) &#123;</span></CodeLine>
<Link id="l02075" /><CodeLine lineNumber="2075"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If NewTop is not the best successor of Pred, then Pred doesn&#39;t</span></CodeLine>
<Link id="l02076" /><CodeLine lineNumber="2076"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// fallthrough to NewTop. So there is no FallThroughFromPred and</span></CodeLine>
<Link id="l02077" /><CodeLine lineNumber="2077"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// NewFreq.</span></CodeLine>
<Link id="l02078" /><CodeLine lineNumber="2078"><span class="doxyHighlight">      NewFreq = <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>(0);</span></CodeLine>
<Link id="l02079" /><CodeLine lineNumber="2079"><span class="doxyHighlight">      FallThroughFromPred = <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>(0);</span></CodeLine>
<Link id="l02080" /><CodeLine lineNumber="2080"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02081" /><CodeLine lineNumber="2081"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02082" /><CodeLine lineNumber="2082"></CodeLine>
<Link id="l02083" /><CodeLine lineNumber="2083"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> <a href="/docs/api/namespaces/llvm/ms-demangle/#afb795990ffc0cb7321e7d1eacc246324a8eea62084ca7e541d918e823422bd82e">Result</a> = <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>(0);</span></CodeLine>
<Link id="l02084" /><CodeLine lineNumber="2084"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> Gains = BackEdgeFreq + NewFreq;</span></CodeLine>
<Link id="l02085" /><CodeLine lineNumber="2085"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> Lost =</span></CodeLine>
<Link id="l02086" /><CodeLine lineNumber="2086"><span class="doxyHighlight">      FallThrough2Top + FallThrough2Exit + FallThroughFromPred;</span></CodeLine>
<Link id="l02087" /><CodeLine lineNumber="2087"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Gains &gt; Lost)</span></CodeLine>
<Link id="l02088" /><CodeLine lineNumber="2088"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/ms-demangle/#afb795990ffc0cb7321e7d1eacc246324a8eea62084ca7e541d918e823422bd82e">Result</a> = Gains - Lost;</span></CodeLine>
<Link id="l02089" /><CodeLine lineNumber="2089"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/ms-demangle/#afb795990ffc0cb7321e7d1eacc246324a8eea62084ca7e541d918e823422bd82e">Result</a>;</span></CodeLine>
<Link id="l02090" /><CodeLine lineNumber="2090"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02091" /><CodeLine lineNumber="2091"></CodeLine>
<Link id="l02092" /><CodeLine lineNumber="2092"><span class="doxyHighlightComment">/// Helper function of findBestLoopTop. Find the best loop top block</span></CodeLine>
<Link id="l02093" /><CodeLine lineNumber="2093"><span class="doxyHighlightComment">/// from predecessors of old top.</span></CodeLine>
<Link id="l02094" /><CodeLine lineNumber="2094"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l02095" /><CodeLine lineNumber="2095"><span class="doxyHighlightComment">/// Look for a block which is strictly better than the old top for laying</span></CodeLine>
<Link id="l02096" /><CodeLine lineNumber="2096"><span class="doxyHighlightComment">/// out before the old top of the loop. This looks for only two patterns:</span></CodeLine>
<Link id="l02097" /><CodeLine lineNumber="2097"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l02098" /><CodeLine lineNumber="2098"><span class="doxyHighlightComment">///     1 a block has only one successor, the old loop top</span></CodeLine>
<Link id="l02099" /><CodeLine lineNumber="2099"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l02100" /><CodeLine lineNumber="2100"><span class="doxyHighlightComment">///        Because such a block will always result in an unconditional jump,</span></CodeLine>
<Link id="l02101" /><CodeLine lineNumber="2101"><span class="doxyHighlightComment">///        rotating it in front of the old top is always profitable.</span></CodeLine>
<Link id="l02102" /><CodeLine lineNumber="2102"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l02103" /><CodeLine lineNumber="2103"><span class="doxyHighlightComment">///     2 a block has two successors, one is old top, another is exit</span></CodeLine>
<Link id="l02104" /><CodeLine lineNumber="2104"><span class="doxyHighlightComment">///        and it has more than one predecessors</span></CodeLine>
<Link id="l02105" /><CodeLine lineNumber="2105"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l02106" /><CodeLine lineNumber="2106"><span class="doxyHighlightComment">///        If it is below one of its predecessors P, only P can fall through to</span></CodeLine>
<Link id="l02107" /><CodeLine lineNumber="2107"><span class="doxyHighlightComment">///        it, all other predecessors need a jump to it, and another conditional</span></CodeLine>
<Link id="l02108" /><CodeLine lineNumber="2108"><span class="doxyHighlightComment">///        jump to loop header. If it is moved before loop header, all its</span></CodeLine>
<Link id="l02109" /><CodeLine lineNumber="2109"><span class="doxyHighlightComment">///        predecessors jump to it, then fall through to loop header. So all its</span></CodeLine>
<Link id="l02110" /><CodeLine lineNumber="2110"><span class="doxyHighlightComment">///        predecessors except P can reduce one taken branch.</span></CodeLine>
<Link id="l02111" /><CodeLine lineNumber="2111"><span class="doxyHighlightComment">///        At the same time, move it before old top increases the taken branch</span></CodeLine>
<Link id="l02112" /><CodeLine lineNumber="2112"><span class="doxyHighlightComment">///        to loop exit block, so the reduced taken branch will be compared with</span></CodeLine>
<Link id="l02113" /><CodeLine lineNumber="2113"><span class="doxyHighlightComment">///        the increased taken branch to the loop exit block.</span></CodeLine>
<Link id="l02114" /><CodeLine lineNumber="2114"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;MachineBlockPlacement::findBestLoopTopHelper(</span></CodeLine>
<Link id="l02115" /><CodeLine lineNumber="2115"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;OldTop, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machineloop">MachineLoop</a> &amp;L,</span></CodeLine>
<Link id="l02116" /><CodeLine lineNumber="2116"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &amp;LoopBlockSet) &#123;</span></CodeLine>
<Link id="l02117" /><CodeLine lineNumber="2117"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Check that the header hasn&#39;t been fused with a preheader block due to</span></CodeLine>
<Link id="l02118" /><CodeLine lineNumber="2118"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// crazy branches. If it has, we need to start with the header at the top to</span></CodeLine>
<Link id="l02119" /><CodeLine lineNumber="2119"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// prevent pulling the preheader into the loop body.</span></CodeLine>
<Link id="l02120" /><CodeLine lineNumber="2120"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;HeaderChain = &#42;BlockToChain&#91;OldTop&#93;;</span></CodeLine>
<Link id="l02121" /><CodeLine lineNumber="2121"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!LoopBlockSet.count(&#42;HeaderChain.begin()))</span></CodeLine>
<Link id="l02122" /><CodeLine lineNumber="2122"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> OldTop;</span></CodeLine>
<Link id="l02123" /><CodeLine lineNumber="2123"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (OldTop != &#42;HeaderChain.begin())</span></CodeLine>
<Link id="l02124" /><CodeLine lineNumber="2124"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> OldTop;</span></CodeLine>
<Link id="l02125" /><CodeLine lineNumber="2125"></CodeLine>
<Link id="l02126" /><CodeLine lineNumber="2126"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Finding best loop top for: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(OldTop)</span></CodeLine>
<Link id="l02127" /><CodeLine lineNumber="2127"><span class="doxyHighlight">                    &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02128" /><CodeLine lineNumber="2128"></CodeLine>
<Link id="l02129" /><CodeLine lineNumber="2129"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> BestGains = <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>(0);</span></CodeLine>
<Link id="l02130" /><CodeLine lineNumber="2130"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BestPred = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02131" /><CodeLine lineNumber="2131"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Pred : OldTop-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#addd80df79ba902914c7d8a52e3896b79">predecessors</a>()) &#123;</span></CodeLine>
<Link id="l02132" /><CodeLine lineNumber="2132"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!LoopBlockSet.count(Pred))</span></CodeLine>
<Link id="l02133" /><CodeLine lineNumber="2133"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02134" /><CodeLine lineNumber="2134"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Pred == <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>.getHeader())</span></CodeLine>
<Link id="l02135" /><CodeLine lineNumber="2135"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02136" /><CodeLine lineNumber="2136"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;   old top pred: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(Pred) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;, has &quot;</span></CodeLine>
<Link id="l02137" /><CodeLine lineNumber="2137"><span class="doxyHighlight">                      &lt;&lt; Pred-&gt;succ&#95;size() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; successors, &quot;</span></CodeLine>
<Link id="l02138" /><CodeLine lineNumber="2138"><span class="doxyHighlight">                      &lt;&lt; <a href="/docs/api/namespaces/llvm/#ada715bce8140114cd2fd2f8ab018f7c3">printBlockFreq</a>(MBFI-&gt;getMBFI(), &#42;Pred) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; freq\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02139" /><CodeLine lineNumber="2139"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Pred-&gt;succ&#95;size() &gt; 2)</span></CodeLine>
<Link id="l02140" /><CodeLine lineNumber="2140"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02141" /><CodeLine lineNumber="2141"></CodeLine>
<Link id="l02142" /><CodeLine lineNumber="2142"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;OtherBB = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02143" /><CodeLine lineNumber="2143"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Pred-&gt;succ&#95;size() == 2) &#123;</span></CodeLine>
<Link id="l02144" /><CodeLine lineNumber="2144"><span class="doxyHighlight">      OtherBB = &#42;Pred-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a6321b189ea8fd5058663f8a87d6c23e9">succ&#95;begin</a>();</span></CodeLine>
<Link id="l02145" /><CodeLine lineNumber="2145"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (OtherBB == OldTop)</span></CodeLine>
<Link id="l02146" /><CodeLine lineNumber="2146"><span class="doxyHighlight">        OtherBB = &#42;Pred-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#abd32ea34faf1cde285a1b8daccd9c167">succ&#95;rbegin</a>();</span></CodeLine>
<Link id="l02147" /><CodeLine lineNumber="2147"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02148" /><CodeLine lineNumber="2148"></CodeLine>
<Link id="l02149" /><CodeLine lineNumber="2149"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!canMoveBottomBlockToTop(Pred, OldTop))</span></CodeLine>
<Link id="l02150" /><CodeLine lineNumber="2150"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02151" /><CodeLine lineNumber="2151"></CodeLine>
<Link id="l02152" /><CodeLine lineNumber="2152"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> Gains =</span></CodeLine>
<Link id="l02153" /><CodeLine lineNumber="2153"><span class="doxyHighlight">        FallThroughGains(Pred, OldTop, OtherBB, LoopBlockSet);</span></CodeLine>
<Link id="l02154" /><CodeLine lineNumber="2154"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> ((Gains &gt; <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>(0)) &amp;&amp;</span></CodeLine>
<Link id="l02155" /><CodeLine lineNumber="2155"><span class="doxyHighlight">        (Gains &gt; BestGains ||</span></CodeLine>
<Link id="l02156" /><CodeLine lineNumber="2156"><span class="doxyHighlight">         ((Gains == BestGains) &amp;&amp; Pred-&gt;isLayoutSuccessor(OldTop)))) &#123;</span></CodeLine>
<Link id="l02157" /><CodeLine lineNumber="2157"><span class="doxyHighlight">      BestPred = Pred;</span></CodeLine>
<Link id="l02158" /><CodeLine lineNumber="2158"><span class="doxyHighlight">      BestGains = Gains;</span></CodeLine>
<Link id="l02159" /><CodeLine lineNumber="2159"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02160" /><CodeLine lineNumber="2160"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02161" /><CodeLine lineNumber="2161"></CodeLine>
<Link id="l02162" /><CodeLine lineNumber="2162"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If no direct predecessor is fine, just use the loop header.</span></CodeLine>
<Link id="l02163" /><CodeLine lineNumber="2163"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!BestPred) &#123;</span></CodeLine>
<Link id="l02164" /><CodeLine lineNumber="2164"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;    final top unchanged\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02165" /><CodeLine lineNumber="2165"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> OldTop;</span></CodeLine>
<Link id="l02166" /><CodeLine lineNumber="2166"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02167" /><CodeLine lineNumber="2167"></CodeLine>
<Link id="l02168" /><CodeLine lineNumber="2168"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Walk backwards through any straight line of predecessors.</span></CodeLine>
<Link id="l02169" /><CodeLine lineNumber="2169"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">while</span><span class="doxyHighlight"> (BestPred-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a03936a9b37da541420049422204ab206">pred&#95;size</a>() == 1 &amp;&amp;</span></CodeLine>
<Link id="l02170" /><CodeLine lineNumber="2170"><span class="doxyHighlight">         (&#42;BestPred-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#ab644fcf07a4c2708333cf66276282357">pred&#95;begin</a>())-&gt;succ&#95;size() == 1 &amp;&amp;</span></CodeLine>
<Link id="l02171" /><CodeLine lineNumber="2171"><span class="doxyHighlight">         &#42;BestPred-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#ab644fcf07a4c2708333cf66276282357">pred&#95;begin</a>() != <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>.getHeader())</span></CodeLine>
<Link id="l02172" /><CodeLine lineNumber="2172"><span class="doxyHighlight">    BestPred = &#42;BestPred-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#ab644fcf07a4c2708333cf66276282357">pred&#95;begin</a>();</span></CodeLine>
<Link id="l02173" /><CodeLine lineNumber="2173"></CodeLine>
<Link id="l02174" /><CodeLine lineNumber="2174"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;    final top: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(BestPred) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02175" /><CodeLine lineNumber="2175"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> BestPred;</span></CodeLine>
<Link id="l02176" /><CodeLine lineNumber="2176"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02177" /><CodeLine lineNumber="2177"></CodeLine>
<Link id="l02178" /><CodeLine lineNumber="2178"><span class="doxyHighlightComment">/// Find the best loop top block for layout.</span></CodeLine>
<Link id="l02179" /><CodeLine lineNumber="2179"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l02180" /><CodeLine lineNumber="2180"><span class="doxyHighlightComment">/// This function iteratively calls findBestLoopTopHelper, until no new better</span></CodeLine>
<Link id="l02181" /><CodeLine lineNumber="2181"><span class="doxyHighlightComment">/// BB can be found.</span></CodeLine>
<Link id="l02182" /><CodeLine lineNumber="2182"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;</span></CodeLine>
<Link id="l02183" /><CodeLine lineNumber="2183"><span class="doxyHighlight">MachineBlockPlacement::findBestLoopTop(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machineloop">MachineLoop</a> &amp;L,</span></CodeLine>
<Link id="l02184" /><CodeLine lineNumber="2184"><span class="doxyHighlight">                                       </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &amp;LoopBlockSet) &#123;</span></CodeLine>
<Link id="l02185" /><CodeLine lineNumber="2185"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Placing the latch block before the header may introduce an extra branch</span></CodeLine>
<Link id="l02186" /><CodeLine lineNumber="2186"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// that skips this block the first time the loop is executed, which we want</span></CodeLine>
<Link id="l02187" /><CodeLine lineNumber="2187"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// to avoid when optimising for size.</span></CodeLine>
<Link id="l02188" /><CodeLine lineNumber="2188"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// FIXME: in theory there is a case that does not introduce a new branch,</span></CodeLine>
<Link id="l02189" /><CodeLine lineNumber="2189"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// i.e. when the layout predecessor does not fallthrough to the loop header.</span></CodeLine>
<Link id="l02190" /><CodeLine lineNumber="2190"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In practice this never happens though: there always seems to be a preheader</span></CodeLine>
<Link id="l02191" /><CodeLine lineNumber="2191"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// that can fallthrough and that is also placed before the header.</span></CodeLine>
<Link id="l02192" /><CodeLine lineNumber="2192"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a3af72f14ea20f2c762c751d2d49e5ea3">llvm::shouldOptimizeForSize</a>(<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>.getHeader(), PSI, MBFI.get()))</span></CodeLine>
<Link id="l02193" /><CodeLine lineNumber="2193"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>.getHeader();</span></CodeLine>
<Link id="l02194" /><CodeLine lineNumber="2194"></CodeLine>
<Link id="l02195" /><CodeLine lineNumber="2195"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;OldTop = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02196" /><CodeLine lineNumber="2196"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;NewTop = <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>.getHeader();</span></CodeLine>
<Link id="l02197" /><CodeLine lineNumber="2197"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">while</span><span class="doxyHighlight"> (NewTop != OldTop) &#123;</span></CodeLine>
<Link id="l02198" /><CodeLine lineNumber="2198"><span class="doxyHighlight">    OldTop = NewTop;</span></CodeLine>
<Link id="l02199" /><CodeLine lineNumber="2199"><span class="doxyHighlight">    NewTop = findBestLoopTopHelper(OldTop, L, LoopBlockSet);</span></CodeLine>
<Link id="l02200" /><CodeLine lineNumber="2200"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NewTop != OldTop)</span></CodeLine>
<Link id="l02201" /><CodeLine lineNumber="2201"><span class="doxyHighlight">      ComputedEdges&#91;NewTop&#93; = &#123;OldTop, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">&#125;;</span></CodeLine>
<Link id="l02202" /><CodeLine lineNumber="2202"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02203" /><CodeLine lineNumber="2203"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> NewTop;</span></CodeLine>
<Link id="l02204" /><CodeLine lineNumber="2204"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02205" /><CodeLine lineNumber="2205"></CodeLine>
<Link id="l02206" /><CodeLine lineNumber="2206"><span class="doxyHighlightComment">/// Find the best loop exiting block for layout.</span></CodeLine>
<Link id="l02207" /><CodeLine lineNumber="2207"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l02208" /><CodeLine lineNumber="2208"><span class="doxyHighlightComment">/// This routine implements the logic to analyze the loop looking for the best</span></CodeLine>
<Link id="l02209" /><CodeLine lineNumber="2209"><span class="doxyHighlightComment">/// block to layout at the top of the loop. Typically this is done to maximize</span></CodeLine>
<Link id="l02210" /><CodeLine lineNumber="2210"><span class="doxyHighlightComment">/// fallthrough opportunities.</span></CodeLine>
<Link id="l02211" /><CodeLine lineNumber="2211"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;</span></CodeLine>
<Link id="l02212" /><CodeLine lineNumber="2212"><span class="doxyHighlight">MachineBlockPlacement::findBestLoopExit(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machineloop">MachineLoop</a> &amp;L,</span></CodeLine>
<Link id="l02213" /><CodeLine lineNumber="2213"><span class="doxyHighlight">                                        </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &amp;LoopBlockSet,</span></CodeLine>
<Link id="l02214" /><CodeLine lineNumber="2214"><span class="doxyHighlight">                                        <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> &amp;ExitFreq) &#123;</span></CodeLine>
<Link id="l02215" /><CodeLine lineNumber="2215"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We don&#39;t want to layout the loop linearly in all cases. If the loop header</span></CodeLine>
<Link id="l02216" /><CodeLine lineNumber="2216"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// is just a normal basic block in the loop, we want to look for what block</span></CodeLine>
<Link id="l02217" /><CodeLine lineNumber="2217"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// within the loop is the best one to layout at the top. However, if the loop</span></CodeLine>
<Link id="l02218" /><CodeLine lineNumber="2218"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// header has be pre-merged into a chain due to predecessors not having</span></CodeLine>
<Link id="l02219" /><CodeLine lineNumber="2219"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// analyzable branches, &#42;and&#42; the predecessor it is merged with is &#42;not&#42; part</span></CodeLine>
<Link id="l02220" /><CodeLine lineNumber="2220"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// of the loop, rotating the header into the middle of the loop will create</span></CodeLine>
<Link id="l02221" /><CodeLine lineNumber="2221"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// a non-contiguous range of blocks which is Very Bad. So start with the</span></CodeLine>
<Link id="l02222" /><CodeLine lineNumber="2222"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// header and only rotate if safe.</span></CodeLine>
<Link id="l02223" /><CodeLine lineNumber="2223"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;HeaderChain = &#42;BlockToChain&#91;<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>.getHeader()&#93;;</span></CodeLine>
<Link id="l02224" /><CodeLine lineNumber="2224"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!LoopBlockSet.count(&#42;HeaderChain.begin()))</span></CodeLine>
<Link id="l02225" /><CodeLine lineNumber="2225"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02226" /><CodeLine lineNumber="2226"></CodeLine>
<Link id="l02227" /><CodeLine lineNumber="2227"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> BestExitEdgeFreq;</span></CodeLine>
<Link id="l02228" /><CodeLine lineNumber="2228"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> BestExitLoopDepth = 0;</span></CodeLine>
<Link id="l02229" /><CodeLine lineNumber="2229"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;ExitingBB = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02230" /><CodeLine lineNumber="2230"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If there are exits to outer loops, loop rotation can severely limit</span></CodeLine>
<Link id="l02231" /><CodeLine lineNumber="2231"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// fallthrough opportunities unless it selects such an exit. Keep a set of</span></CodeLine>
<Link id="l02232" /><CodeLine lineNumber="2232"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// blocks where rotating to exit with that block will reach an outer loop.</span></CodeLine>
<Link id="l02233" /><CodeLine lineNumber="2233"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;MachineBasicBlock &#42;, 4&gt;</a> BlocksExitingToOuterLoop;</span></CodeLine>
<Link id="l02234" /><CodeLine lineNumber="2234"></CodeLine>
<Link id="l02235" /><CodeLine lineNumber="2235"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Finding best loop exit for: &quot;</span></CodeLine>
<Link id="l02236" /><CodeLine lineNumber="2236"><span class="doxyHighlight">                    &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>.getHeader()) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02237" /><CodeLine lineNumber="2237"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>.getBlocks()) &#123;</span></CodeLine>
<Link id="l02238" /><CodeLine lineNumber="2238"><span class="doxyHighlight">    <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;<a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a> = &#42;BlockToChain&#91;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>&#93;;</span></CodeLine>
<Link id="l02239" /><CodeLine lineNumber="2239"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Ensure that this block is at the end of a chain; otherwise it could be</span></CodeLine>
<Link id="l02240" /><CodeLine lineNumber="2240"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// mid-way through an inner loop or a successor of an unanalyzable branch.</span></CodeLine>
<Link id="l02241" /><CodeLine lineNumber="2241"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> != &#42;std::prev(<a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a075e34e98605d0e7c289763a104869ac">end</a>()))</span></CodeLine>
<Link id="l02242" /><CodeLine lineNumber="2242"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02243" /><CodeLine lineNumber="2243"></CodeLine>
<Link id="l02244" /><CodeLine lineNumber="2244"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Now walk the successors. We need to establish whether this has a viable</span></CodeLine>
<Link id="l02245" /><CodeLine lineNumber="2245"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// exiting successor and whether it has a viable non-exiting successor.</span></CodeLine>
<Link id="l02246" /><CodeLine lineNumber="2246"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We store the old exiting state and restore it if a viable looping</span></CodeLine>
<Link id="l02247" /><CodeLine lineNumber="2247"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// successor isn&#39;t found.</span></CodeLine>
<Link id="l02248" /><CodeLine lineNumber="2248"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;OldExitingBB = ExitingBB;</span></CodeLine>
<Link id="l02249" /><CodeLine lineNumber="2249"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> OldBestExitEdgeFreq = BestExitEdgeFreq;</span></CodeLine>
<Link id="l02250" /><CodeLine lineNumber="2250"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> HasLoopingSucc = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02251" /><CodeLine lineNumber="2251"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ : <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>-&gt;successors()) &#123;</span></CodeLine>
<Link id="l02252" /><CodeLine lineNumber="2252"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Succ-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a1100bfbadd996d464150c6a68fa8dc1d">isEHPad</a>())</span></CodeLine>
<Link id="l02253" /><CodeLine lineNumber="2253"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02254" /><CodeLine lineNumber="2254"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Succ == <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>)</span></CodeLine>
<Link id="l02255" /><CodeLine lineNumber="2255"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02256" /><CodeLine lineNumber="2256"><span class="doxyHighlight">      <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;SuccChain = &#42;BlockToChain&#91;Succ&#93;;</span></CodeLine>
<Link id="l02257" /><CodeLine lineNumber="2257"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Don&#39;t split chains, either this chain or the successor&#39;s chain.</span></CodeLine>
<Link id="l02258" /><CodeLine lineNumber="2258"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (&amp;Chain == &amp;SuccChain) &#123;</span></CodeLine>
<Link id="l02259" /><CodeLine lineNumber="2259"><span class="doxyHighlight">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;    exiting: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; -&gt; &quot;</span></CodeLine>
<Link id="l02260" /><CodeLine lineNumber="2260"><span class="doxyHighlight">                          &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(Succ) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; (chain conflict)\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02261" /><CodeLine lineNumber="2261"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02262" /><CodeLine lineNumber="2262"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l02263" /><CodeLine lineNumber="2263"></CodeLine>
<Link id="l02264" /><CodeLine lineNumber="2264"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> SuccProb = MBPI-&gt;getEdgeProbability(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, Succ);</span></CodeLine>
<Link id="l02265" /><CodeLine lineNumber="2265"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LoopBlockSet.count(Succ)) &#123;</span></CodeLine>
<Link id="l02266" /><CodeLine lineNumber="2266"><span class="doxyHighlight">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;    looping: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; -&gt; &quot;</span></CodeLine>
<Link id="l02267" /><CodeLine lineNumber="2267"><span class="doxyHighlight">                          &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(Succ) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; (&quot;</span><span class="doxyHighlight"> &lt;&lt; SuccProb &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;)\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02268" /><CodeLine lineNumber="2268"><span class="doxyHighlight">        HasLoopingSucc = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02269" /><CodeLine lineNumber="2269"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02270" /><CodeLine lineNumber="2270"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l02271" /><CodeLine lineNumber="2271"></CodeLine>
<Link id="l02272" /><CodeLine lineNumber="2272"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> SuccLoopDepth = 0;</span></CodeLine>
<Link id="l02273" /><CodeLine lineNumber="2273"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machineloop">MachineLoop</a> &#42;ExitLoop = MLI-&gt;getLoopFor(Succ)) &#123;</span></CodeLine>
<Link id="l02274" /><CodeLine lineNumber="2274"><span class="doxyHighlight">        SuccLoopDepth = ExitLoop-&gt;getLoopDepth();</span></CodeLine>
<Link id="l02275" /><CodeLine lineNumber="2275"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ExitLoop-&gt;contains(&amp;L))</span></CodeLine>
<Link id="l02276" /><CodeLine lineNumber="2276"><span class="doxyHighlight">          BlocksExitingToOuterLoop.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</span></CodeLine>
<Link id="l02277" /><CodeLine lineNumber="2277"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l02278" /><CodeLine lineNumber="2278"></CodeLine>
<Link id="l02279" /><CodeLine lineNumber="2279"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> ExitEdgeFreq = MBFI-&gt;getBlockFreq(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>) &#42; SuccProb;</span></CodeLine>
<Link id="l02280" /><CodeLine lineNumber="2280"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(</span></CodeLine>
<Link id="l02281" /><CodeLine lineNumber="2281"><span class="doxyHighlight">          <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;    exiting: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; -&gt; &quot;</span></CodeLine>
<Link id="l02282" /><CodeLine lineNumber="2282"><span class="doxyHighlight">                 &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(Succ) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; &#91;L:&quot;</span><span class="doxyHighlight"> &lt;&lt; SuccLoopDepth &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;&#93; (&quot;</span></CodeLine>
<Link id="l02283" /><CodeLine lineNumber="2283"><span class="doxyHighlight">                 &lt;&lt; <a href="/docs/api/namespaces/llvm/#ada715bce8140114cd2fd2f8ab018f7c3">printBlockFreq</a>(MBFI-&gt;getMBFI(), ExitEdgeFreq) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;)\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02284" /><CodeLine lineNumber="2284"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Note that we bias this toward an existing layout successor to retain</span></CodeLine>
<Link id="l02285" /><CodeLine lineNumber="2285"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// incoming order in the absence of better information. The exit must have</span></CodeLine>
<Link id="l02286" /><CodeLine lineNumber="2286"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// a frequency higher than the current exit before we consider breaking</span></CodeLine>
<Link id="l02287" /><CodeLine lineNumber="2287"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// the layout.</span></CodeLine>
<Link id="l02288" /><CodeLine lineNumber="2288"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> Bias(100 - <a href="#a41cd121b4df30e5c0dc17f0c479e843a">ExitBlockBias</a>, 100);</span></CodeLine>
<Link id="l02289" /><CodeLine lineNumber="2289"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!ExitingBB || SuccLoopDepth &gt; BestExitLoopDepth ||</span></CodeLine>
<Link id="l02290" /><CodeLine lineNumber="2290"><span class="doxyHighlight">          ExitEdgeFreq &gt; BestExitEdgeFreq ||</span></CodeLine>
<Link id="l02291" /><CodeLine lineNumber="2291"><span class="doxyHighlight">          (<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>-&gt;isLayoutSuccessor(Succ) &amp;&amp;</span></CodeLine>
<Link id="l02292" /><CodeLine lineNumber="2292"><span class="doxyHighlight">           !(ExitEdgeFreq &lt; BestExitEdgeFreq &#42; Bias))) &#123;</span></CodeLine>
<Link id="l02293" /><CodeLine lineNumber="2293"><span class="doxyHighlight">        BestExitEdgeFreq = ExitEdgeFreq;</span></CodeLine>
<Link id="l02294" /><CodeLine lineNumber="2294"><span class="doxyHighlight">        ExitingBB = <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>;</span></CodeLine>
<Link id="l02295" /><CodeLine lineNumber="2295"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l02296" /><CodeLine lineNumber="2296"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02297" /><CodeLine lineNumber="2297"></CodeLine>
<Link id="l02298" /><CodeLine lineNumber="2298"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!HasLoopingSucc) &#123;</span></CodeLine>
<Link id="l02299" /><CodeLine lineNumber="2299"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Restore the old exiting state, no viable looping successor was found.</span></CodeLine>
<Link id="l02300" /><CodeLine lineNumber="2300"><span class="doxyHighlight">      ExitingBB = OldExitingBB;</span></CodeLine>
<Link id="l02301" /><CodeLine lineNumber="2301"><span class="doxyHighlight">      BestExitEdgeFreq = OldBestExitEdgeFreq;</span></CodeLine>
<Link id="l02302" /><CodeLine lineNumber="2302"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02303" /><CodeLine lineNumber="2303"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02304" /><CodeLine lineNumber="2304"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Without a candidate exiting block or with only a single block in the</span></CodeLine>
<Link id="l02305" /><CodeLine lineNumber="2305"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// loop, just use the loop header to layout the loop.</span></CodeLine>
<Link id="l02306" /><CodeLine lineNumber="2306"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!ExitingBB) &#123;</span></CodeLine>
<Link id="l02307" /><CodeLine lineNumber="2307"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(</span></CodeLine>
<Link id="l02308" /><CodeLine lineNumber="2308"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;    No other candidate exit blocks, using loop header\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02309" /><CodeLine lineNumber="2309"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02310" /><CodeLine lineNumber="2310"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02311" /><CodeLine lineNumber="2311"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>.getNumBlocks() == 1) &#123;</span></CodeLine>
<Link id="l02312" /><CodeLine lineNumber="2312"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;    Loop has 1 block, using loop header as exit\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02313" /><CodeLine lineNumber="2313"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02314" /><CodeLine lineNumber="2314"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02315" /><CodeLine lineNumber="2315"></CodeLine>
<Link id="l02316" /><CodeLine lineNumber="2316"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Also, if we have exit blocks which lead to outer loops but didn&#39;t select</span></CodeLine>
<Link id="l02317" /><CodeLine lineNumber="2317"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// one of them as the exiting block we are rotating toward, disable loop</span></CodeLine>
<Link id="l02318" /><CodeLine lineNumber="2318"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// rotation altogether.</span></CodeLine>
<Link id="l02319" /><CodeLine lineNumber="2319"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!BlocksExitingToOuterLoop.<a href="/docs/api/classes/llvm/smallptrsetimplbase/#af8a50544090e81ac83601aff8f4b0142">empty</a>() &amp;&amp;</span></CodeLine>
<Link id="l02320" /><CodeLine lineNumber="2320"><span class="doxyHighlight">      !BlocksExitingToOuterLoop.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(ExitingBB))</span></CodeLine>
<Link id="l02321" /><CodeLine lineNumber="2321"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02322" /><CodeLine lineNumber="2322"></CodeLine>
<Link id="l02323" /><CodeLine lineNumber="2323"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Best exiting block: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(ExitingBB)</span></CodeLine>
<Link id="l02324" /><CodeLine lineNumber="2324"><span class="doxyHighlight">                    &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02325" /><CodeLine lineNumber="2325"><span class="doxyHighlight">  ExitFreq = BestExitEdgeFreq;</span></CodeLine>
<Link id="l02326" /><CodeLine lineNumber="2326"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> ExitingBB;</span></CodeLine>
<Link id="l02327" /><CodeLine lineNumber="2327"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02328" /><CodeLine lineNumber="2328"></CodeLine>
<Link id="l02329" /><CodeLine lineNumber="2329"><span class="doxyHighlightComment">/// Check if there is a fallthrough to loop header Top.</span></CodeLine>
<Link id="l02330" /><CodeLine lineNumber="2330"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l02331" /><CodeLine lineNumber="2331"><span class="doxyHighlightComment">///   1 Look for a Pred that can be layout before Top.</span></CodeLine>
<Link id="l02332" /><CodeLine lineNumber="2332"><span class="doxyHighlightComment">///   2 Check if Top is the most possible successor of Pred.</span></CodeLine>
<Link id="l02333" /><CodeLine lineNumber="2333"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> MachineBlockPlacement::hasViableTopFallthrough(</span></CodeLine>
<Link id="l02334" /><CodeLine lineNumber="2334"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Top, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &amp;LoopBlockSet) &#123;</span></CodeLine>
<Link id="l02335" /><CodeLine lineNumber="2335"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Pred : Top-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#addd80df79ba902914c7d8a52e3896b79">predecessors</a>()) &#123;</span></CodeLine>
<Link id="l02336" /><CodeLine lineNumber="2336"><span class="doxyHighlight">    <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;PredChain = BlockToChain&#91;Pred&#93;;</span></CodeLine>
<Link id="l02337" /><CodeLine lineNumber="2337"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!LoopBlockSet.count(Pred) &amp;&amp;</span></CodeLine>
<Link id="l02338" /><CodeLine lineNumber="2338"><span class="doxyHighlight">        (!PredChain || Pred == &#42;std::prev(PredChain-&gt;end()))) &#123;</span></CodeLine>
<Link id="l02339" /><CodeLine lineNumber="2339"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Found a Pred block can be placed before Top.</span></CodeLine>
<Link id="l02340" /><CodeLine lineNumber="2340"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Check if Top is the best successor of Pred.</span></CodeLine>
<Link id="l02341" /><CodeLine lineNumber="2341"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> TopProb = MBPI-&gt;getEdgeProbability(Pred, Top);</span></CodeLine>
<Link id="l02342" /><CodeLine lineNumber="2342"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> TopOK = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02343" /><CodeLine lineNumber="2343"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ : Pred-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#ad88ff1529541fb4e243cc8ed90b11131">successors</a>()) &#123;</span></CodeLine>
<Link id="l02344" /><CodeLine lineNumber="2344"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> SuccProb = MBPI-&gt;getEdgeProbability(Pred, Succ);</span></CodeLine>
<Link id="l02345" /><CodeLine lineNumber="2345"><span class="doxyHighlight">        <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;SuccChain = BlockToChain&#91;Succ&#93;;</span></CodeLine>
<Link id="l02346" /><CodeLine lineNumber="2346"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Check if Succ can be placed after Pred.</span></CodeLine>
<Link id="l02347" /><CodeLine lineNumber="2347"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Succ should not be in any chain, or it is the head of some chain.</span></CodeLine>
<Link id="l02348" /><CodeLine lineNumber="2348"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> ((!SuccChain || Succ == &#42;SuccChain-&gt;begin()) &amp;&amp; SuccProb &gt; TopProb) &#123;</span></CodeLine>
<Link id="l02349" /><CodeLine lineNumber="2349"><span class="doxyHighlight">          TopOK = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02350" /><CodeLine lineNumber="2350"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02351" /><CodeLine lineNumber="2351"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l02352" /><CodeLine lineNumber="2352"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l02353" /><CodeLine lineNumber="2353"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (TopOK)</span></CodeLine>
<Link id="l02354" /><CodeLine lineNumber="2354"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02355" /><CodeLine lineNumber="2355"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02356" /><CodeLine lineNumber="2356"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02357" /><CodeLine lineNumber="2357"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02358" /><CodeLine lineNumber="2358"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02359" /><CodeLine lineNumber="2359"></CodeLine>
<Link id="l02360" /><CodeLine lineNumber="2360"><span class="doxyHighlightComment">/// Attempt to rotate an exiting block to the bottom of the loop.</span></CodeLine>
<Link id="l02361" /><CodeLine lineNumber="2361"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l02362" /><CodeLine lineNumber="2362"><span class="doxyHighlightComment">/// Once we have built a chain, try to rotate it to line up the hot exit block</span></CodeLine>
<Link id="l02363" /><CodeLine lineNumber="2363"><span class="doxyHighlightComment">/// with fallthrough out of the loop if doing so doesn&#39;t introduce unnecessary</span></CodeLine>
<Link id="l02364" /><CodeLine lineNumber="2364"><span class="doxyHighlightComment">/// branches. For example, if the loop has fallthrough into its header and out</span></CodeLine>
<Link id="l02365" /><CodeLine lineNumber="2365"><span class="doxyHighlightComment">/// of its bottom already, don&#39;t rotate it.</span></CodeLine>
<Link id="l02366" /><CodeLine lineNumber="2366"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> MachineBlockPlacement::rotateLoop(<a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;LoopChain,</span></CodeLine>
<Link id="l02367" /><CodeLine lineNumber="2367"><span class="doxyHighlight">                                       </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;ExitingBB,</span></CodeLine>
<Link id="l02368" /><CodeLine lineNumber="2368"><span class="doxyHighlight">                                       <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> ExitFreq,</span></CodeLine>
<Link id="l02369" /><CodeLine lineNumber="2369"><span class="doxyHighlight">                                       </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &amp;LoopBlockSet) &#123;</span></CodeLine>
<Link id="l02370" /><CodeLine lineNumber="2370"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!ExitingBB)</span></CodeLine>
<Link id="l02371" /><CodeLine lineNumber="2371"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02372" /><CodeLine lineNumber="2372"></CodeLine>
<Link id="l02373" /><CodeLine lineNumber="2373"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Top = &#42;LoopChain.<a href="/docs/api/classes/llvm/machinebasicblock/#ab2d91e7bec944efcbc39d8e30644f111">begin</a>();</span></CodeLine>
<Link id="l02374" /><CodeLine lineNumber="2374"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Bottom = &#42;std::prev(LoopChain.end());</span></CodeLine>
<Link id="l02375" /><CodeLine lineNumber="2375"></CodeLine>
<Link id="l02376" /><CodeLine lineNumber="2376"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If ExitingBB is already the last one in a chain then nothing to do.</span></CodeLine>
<Link id="l02377" /><CodeLine lineNumber="2377"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Bottom == ExitingBB)</span></CodeLine>
<Link id="l02378" /><CodeLine lineNumber="2378"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02379" /><CodeLine lineNumber="2379"></CodeLine>
<Link id="l02380" /><CodeLine lineNumber="2380"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The entry block should always be the first BB in a function.</span></CodeLine>
<Link id="l02381" /><CodeLine lineNumber="2381"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Top-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a9103c1c7b60d793b0efd41c741286508">isEntryBlock</a>())</span></CodeLine>
<Link id="l02382" /><CodeLine lineNumber="2382"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02383" /><CodeLine lineNumber="2383"></CodeLine>
<Link id="l02384" /><CodeLine lineNumber="2384"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> ViableTopFallthrough = hasViableTopFallthrough(Top, LoopBlockSet);</span></CodeLine>
<Link id="l02385" /><CodeLine lineNumber="2385"></CodeLine>
<Link id="l02386" /><CodeLine lineNumber="2386"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the header has viable fallthrough, check whether the current loop</span></CodeLine>
<Link id="l02387" /><CodeLine lineNumber="2387"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// bottom is a viable exiting block. If so, bail out as rotating will</span></CodeLine>
<Link id="l02388" /><CodeLine lineNumber="2388"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// introduce an unnecessary branch.</span></CodeLine>
<Link id="l02389" /><CodeLine lineNumber="2389"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ViableTopFallthrough) &#123;</span></CodeLine>
<Link id="l02390" /><CodeLine lineNumber="2390"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ : Bottom-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#ad88ff1529541fb4e243cc8ed90b11131">successors</a>()) &#123;</span></CodeLine>
<Link id="l02391" /><CodeLine lineNumber="2391"><span class="doxyHighlight">      <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;SuccChain = BlockToChain&#91;Succ&#93;;</span></CodeLine>
<Link id="l02392" /><CodeLine lineNumber="2392"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!LoopBlockSet.count(Succ) &amp;&amp;</span></CodeLine>
<Link id="l02393" /><CodeLine lineNumber="2393"><span class="doxyHighlight">          (!SuccChain || Succ == &#42;SuccChain-&gt;begin()))</span></CodeLine>
<Link id="l02394" /><CodeLine lineNumber="2394"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02395" /><CodeLine lineNumber="2395"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02396" /><CodeLine lineNumber="2396"></CodeLine>
<Link id="l02397" /><CodeLine lineNumber="2397"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Rotate will destroy the top fallthrough, we need to ensure the new exit</span></CodeLine>
<Link id="l02398" /><CodeLine lineNumber="2398"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// frequency is larger than top fallthrough.</span></CodeLine>
<Link id="l02399" /><CodeLine lineNumber="2399"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> FallThrough2Top = TopFallThroughFreq(Top, LoopBlockSet);</span></CodeLine>
<Link id="l02400" /><CodeLine lineNumber="2400"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FallThrough2Top &gt;= ExitFreq)</span></CodeLine>
<Link id="l02401" /><CodeLine lineNumber="2401"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02402" /><CodeLine lineNumber="2402"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02403" /><CodeLine lineNumber="2403"></CodeLine>
<Link id="l02404" /><CodeLine lineNumber="2404"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#aac2485344159ae07cfd3aa75113f50f5">BlockChain::iterator</a> ExitIt = <a href="/docs/api/namespaces/llvm/#a086e9fbdb06276db7753101a08a63adf">llvm::find</a>(LoopChain, ExitingBB);</span></CodeLine>
<Link id="l02405" /><CodeLine lineNumber="2405"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ExitIt == LoopChain.end())</span></CodeLine>
<Link id="l02406" /><CodeLine lineNumber="2406"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02407" /><CodeLine lineNumber="2407"></CodeLine>
<Link id="l02408" /><CodeLine lineNumber="2408"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Rotating a loop exit to the bottom when there is a fallthrough to top</span></CodeLine>
<Link id="l02409" /><CodeLine lineNumber="2409"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// trades the entry fallthrough for an exit fallthrough.</span></CodeLine>
<Link id="l02410" /><CodeLine lineNumber="2410"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If there is no bottom-&gt;top edge, but the chosen exit block does have</span></CodeLine>
<Link id="l02411" /><CodeLine lineNumber="2411"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// a fallthrough, we break that fallthrough for nothing in return.</span></CodeLine>
<Link id="l02412" /><CodeLine lineNumber="2412"></CodeLine>
<Link id="l02413" /><CodeLine lineNumber="2413"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Let&#39;s consider an example. We have a built chain of basic blocks</span></CodeLine>
<Link id="l02414" /><CodeLine lineNumber="2414"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// B1, B2, ..., Bn, where Bk is a ExitingBB - chosen exit block.</span></CodeLine>
<Link id="l02415" /><CodeLine lineNumber="2415"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// By doing a rotation we get</span></CodeLine>
<Link id="l02416" /><CodeLine lineNumber="2416"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Bk+1, ..., Bn, B1, ..., Bk</span></CodeLine>
<Link id="l02417" /><CodeLine lineNumber="2417"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Break of fallthrough to B1 is compensated by a fallthrough from Bk.</span></CodeLine>
<Link id="l02418" /><CodeLine lineNumber="2418"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we had a fallthrough Bk -&gt; Bk+1 it is broken now.</span></CodeLine>
<Link id="l02419" /><CodeLine lineNumber="2419"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// It might be compensated by fallthrough Bn -&gt; B1.</span></CodeLine>
<Link id="l02420" /><CodeLine lineNumber="2420"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// So we have a condition to avoid creation of extra branch by loop rotation.</span></CodeLine>
<Link id="l02421" /><CodeLine lineNumber="2421"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// All below must be true to avoid loop rotation:</span></CodeLine>
<Link id="l02422" /><CodeLine lineNumber="2422"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   If there is a fallthrough to top (B1)</span></CodeLine>
<Link id="l02423" /><CodeLine lineNumber="2423"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   There was fallthrough from chosen exit block (Bk) to next one (Bk+1)</span></CodeLine>
<Link id="l02424" /><CodeLine lineNumber="2424"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   There is no fallthrough from bottom (Bn) to top (B1).</span></CodeLine>
<Link id="l02425" /><CodeLine lineNumber="2425"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Please note that there is no exit fallthrough from Bn because we checked it</span></CodeLine>
<Link id="l02426" /><CodeLine lineNumber="2426"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// above.</span></CodeLine>
<Link id="l02427" /><CodeLine lineNumber="2427"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ViableTopFallthrough) &#123;</span></CodeLine>
<Link id="l02428" /><CodeLine lineNumber="2428"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(std::next(ExitIt) != LoopChain.end() &amp;&amp;</span></CodeLine>
<Link id="l02429" /><CodeLine lineNumber="2429"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;Exit should not be last BB&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02430" /><CodeLine lineNumber="2430"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;NextBlockInChain = &#42;std::next(ExitIt);</span></CodeLine>
<Link id="l02431" /><CodeLine lineNumber="2431"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ExitingBB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#adc8f1be4a77ae671ac139d5f06b44deb">isSuccessor</a>(NextBlockInChain))</span></CodeLine>
<Link id="l02432" /><CodeLine lineNumber="2432"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Bottom-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#adc8f1be4a77ae671ac139d5f06b44deb">isSuccessor</a>(Top))</span></CodeLine>
<Link id="l02433" /><CodeLine lineNumber="2433"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02434" /><CodeLine lineNumber="2434"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02435" /><CodeLine lineNumber="2435"></CodeLine>
<Link id="l02436" /><CodeLine lineNumber="2436"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Rotating loop to put exit &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(ExitingBB)</span></CodeLine>
<Link id="l02437" /><CodeLine lineNumber="2437"><span class="doxyHighlight">                    &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; at bottom\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02438" /><CodeLine lineNumber="2438"><span class="doxyHighlight">  std::rotate(LoopChain.begin(), std::next(ExitIt), LoopChain.end());</span></CodeLine>
<Link id="l02439" /><CodeLine lineNumber="2439"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02440" /><CodeLine lineNumber="2440"></CodeLine>
<Link id="l02441" /><CodeLine lineNumber="2441"><span class="doxyHighlightComment">/// Attempt to rotate a loop based on profile data to reduce branch cost.</span></CodeLine>
<Link id="l02442" /><CodeLine lineNumber="2442"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l02443" /><CodeLine lineNumber="2443"><span class="doxyHighlightComment">/// With profile data, we can determine the cost in terms of missed fall through</span></CodeLine>
<Link id="l02444" /><CodeLine lineNumber="2444"><span class="doxyHighlightComment">/// opportunities when rotating a loop chain and select the best rotation.</span></CodeLine>
<Link id="l02445" /><CodeLine lineNumber="2445"><span class="doxyHighlightComment">/// Basically, there are three kinds of cost to consider for each rotation:</span></CodeLine>
<Link id="l02446" /><CodeLine lineNumber="2446"><span class="doxyHighlightComment">///    1 The possibly missed fall through edge (if it exists) from BB out of</span></CodeLine>
<Link id="l02447" /><CodeLine lineNumber="2447"><span class="doxyHighlightComment">///    the loop to the loop header.</span></CodeLine>
<Link id="l02448" /><CodeLine lineNumber="2448"><span class="doxyHighlightComment">///    2 The possibly missed fall through edges (if they exist) from the loop</span></CodeLine>
<Link id="l02449" /><CodeLine lineNumber="2449"><span class="doxyHighlightComment">///    exits to BB out of the loop.</span></CodeLine>
<Link id="l02450" /><CodeLine lineNumber="2450"><span class="doxyHighlightComment">///    3 The missed fall through edge (if it exists) from the last BB to the</span></CodeLine>
<Link id="l02451" /><CodeLine lineNumber="2451"><span class="doxyHighlightComment">///    first BB in the loop chain.</span></CodeLine>
<Link id="l02452" /><CodeLine lineNumber="2452"><span class="doxyHighlightComment">///  Therefore, the cost for a given rotation is the sum of costs listed above.</span></CodeLine>
<Link id="l02453" /><CodeLine lineNumber="2453"><span class="doxyHighlightComment">///  We select the best rotation with the smallest cost.</span></CodeLine>
<Link id="l02454" /><CodeLine lineNumber="2454"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> MachineBlockPlacement::rotateLoopWithProfile(</span></CodeLine>
<Link id="l02455" /><CodeLine lineNumber="2455"><span class="doxyHighlight">    <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;LoopChain, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machineloop">MachineLoop</a> &amp;L,</span></CodeLine>
<Link id="l02456" /><CodeLine lineNumber="2456"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockFilterSet &amp;LoopBlockSet) &#123;</span></CodeLine>
<Link id="l02457" /><CodeLine lineNumber="2457"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> RotationPos = LoopChain.end();</span></CodeLine>
<Link id="l02458" /><CodeLine lineNumber="2458"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;ChainHeaderBB = &#42;LoopChain.<a href="/docs/api/classes/llvm/machinebasicblock/#ab2d91e7bec944efcbc39d8e30644f111">begin</a>();</span></CodeLine>
<Link id="l02459" /><CodeLine lineNumber="2459"></CodeLine>
<Link id="l02460" /><CodeLine lineNumber="2460"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The entry block should always be the first BB in a function.</span></CodeLine>
<Link id="l02461" /><CodeLine lineNumber="2461"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ChainHeaderBB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a9103c1c7b60d793b0efd41c741286508">isEntryBlock</a>())</span></CodeLine>
<Link id="l02462" /><CodeLine lineNumber="2462"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02463" /><CodeLine lineNumber="2463"></CodeLine>
<Link id="l02464" /><CodeLine lineNumber="2464"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> SmallestRotationCost = <a href="/docs/api/classes/llvm/blockfrequency/#a5bd2a8de4fde83093df0cc2415db2312">BlockFrequency::max</a>();</span></CodeLine>
<Link id="l02465" /><CodeLine lineNumber="2465"></CodeLine>
<Link id="l02466" /><CodeLine lineNumber="2466"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// A utility lambda that scales up a block frequency by dividing it by a</span></CodeLine>
<Link id="l02467" /><CodeLine lineNumber="2467"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// branch probability which is the reciprocal of the scale.</span></CodeLine>
<Link id="l02468" /><CodeLine lineNumber="2468"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> ScaleBlockFrequency = &#91;&#93;(<a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> Freq,</span></CodeLine>
<Link id="l02469" /><CodeLine lineNumber="2469"><span class="doxyHighlight">                                </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> Scale) -&gt; <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> &#123;</span></CodeLine>
<Link id="l02470" /><CodeLine lineNumber="2470"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Scale == 0)</span></CodeLine>
<Link id="l02471" /><CodeLine lineNumber="2471"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>(0);</span></CodeLine>
<Link id="l02472" /><CodeLine lineNumber="2472"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Use operator / between BlockFrequency and BranchProbability to implement</span></CodeLine>
<Link id="l02473" /><CodeLine lineNumber="2473"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// saturating multiplication.</span></CodeLine>
<Link id="l02474" /><CodeLine lineNumber="2474"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Freq / <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a>(1, Scale);</span></CodeLine>
<Link id="l02475" /><CodeLine lineNumber="2475"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l02476" /><CodeLine lineNumber="2476"></CodeLine>
<Link id="l02477" /><CodeLine lineNumber="2477"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Compute the cost of the missed fall-through edge to the loop header if the</span></CodeLine>
<Link id="l02478" /><CodeLine lineNumber="2478"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// chain head is not the loop header. As we only consider natural loops with</span></CodeLine>
<Link id="l02479" /><CodeLine lineNumber="2479"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// single header, this computation can be done only once.</span></CodeLine>
<Link id="l02480" /><CodeLine lineNumber="2480"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> HeaderFallThroughCost(0);</span></CodeLine>
<Link id="l02481" /><CodeLine lineNumber="2481"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Pred : ChainHeaderBB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#addd80df79ba902914c7d8a52e3896b79">predecessors</a>()) &#123;</span></CodeLine>
<Link id="l02482" /><CodeLine lineNumber="2482"><span class="doxyHighlight">    <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;PredChain = BlockToChain&#91;Pred&#93;;</span></CodeLine>
<Link id="l02483" /><CodeLine lineNumber="2483"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!LoopBlockSet.count(Pred) &amp;&amp;</span></CodeLine>
<Link id="l02484" /><CodeLine lineNumber="2484"><span class="doxyHighlight">        (!PredChain || Pred == &#42;std::prev(PredChain-&gt;end()))) &#123;</span></CodeLine>
<Link id="l02485" /><CodeLine lineNumber="2485"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> EdgeFreq = MBFI-&gt;getBlockFreq(Pred) &#42;</span></CodeLine>
<Link id="l02486" /><CodeLine lineNumber="2486"><span class="doxyHighlight">                      MBPI-&gt;getEdgeProbability(Pred, ChainHeaderBB);</span></CodeLine>
<Link id="l02487" /><CodeLine lineNumber="2487"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> FallThruCost = ScaleBlockFrequency(EdgeFreq, <a href="#a75fe07dfba15c73225c8ca4cd720049d">MisfetchCost</a>);</span></CodeLine>
<Link id="l02488" /><CodeLine lineNumber="2488"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If the predecessor has only an unconditional jump to the header, we</span></CodeLine>
<Link id="l02489" /><CodeLine lineNumber="2489"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// need to consider the cost of this jump.</span></CodeLine>
<Link id="l02490" /><CodeLine lineNumber="2490"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Pred-&gt;succ&#95;size() == 1)</span></CodeLine>
<Link id="l02491" /><CodeLine lineNumber="2491"><span class="doxyHighlight">        FallThruCost += ScaleBlockFrequency(EdgeFreq, <a href="#a72b387cbb4c16dbf0558135dd26ddfd0">JumpInstCost</a>);</span></CodeLine>
<Link id="l02492" /><CodeLine lineNumber="2492"><span class="doxyHighlight">      HeaderFallThroughCost = std::max(HeaderFallThroughCost, FallThruCost);</span></CodeLine>
<Link id="l02493" /><CodeLine lineNumber="2493"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02494" /><CodeLine lineNumber="2494"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02495" /><CodeLine lineNumber="2495"></CodeLine>
<Link id="l02496" /><CodeLine lineNumber="2496"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Here we collect all exit blocks in the loop, and for each exit we find out</span></CodeLine>
<Link id="l02497" /><CodeLine lineNumber="2497"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// its hottest exit edge. For each loop rotation, we define the loop exit cost</span></CodeLine>
<Link id="l02498" /><CodeLine lineNumber="2498"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// as the sum of frequencies of exit edges we collect here, excluding the exit</span></CodeLine>
<Link id="l02499" /><CodeLine lineNumber="2499"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// edge from the tail of the loop chain.</span></CodeLine>
<Link id="l02500" /><CodeLine lineNumber="2500"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;std::pair&lt;MachineBasicBlock &#42;, BlockFrequency&gt;</a>, 4&gt; ExitsWithFreq;</span></CodeLine>
<Link id="l02501" /><CodeLine lineNumber="2501"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;BB : LoopChain) &#123;</span></CodeLine>
<Link id="l02502" /><CodeLine lineNumber="2502"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> LargestExitEdgeProb = <a href="/docs/api/classes/llvm/branchprobability/#afd00958cba7080048a84cccfcef55d71">BranchProbability::getZero</a>();</span></CodeLine>
<Link id="l02503" /><CodeLine lineNumber="2503"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Succ : BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#ad88ff1529541fb4e243cc8ed90b11131">successors</a>()) &#123;</span></CodeLine>
<Link id="l02504" /><CodeLine lineNumber="2504"><span class="doxyHighlight">      <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;SuccChain = BlockToChain&#91;Succ&#93;;</span></CodeLine>
<Link id="l02505" /><CodeLine lineNumber="2505"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!LoopBlockSet.count(Succ) &amp;&amp;</span></CodeLine>
<Link id="l02506" /><CodeLine lineNumber="2506"><span class="doxyHighlight">          (!SuccChain || Succ == &#42;SuccChain-&gt;begin())) &#123;</span></CodeLine>
<Link id="l02507" /><CodeLine lineNumber="2507"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> SuccProb = MBPI-&gt;getEdgeProbability(BB, Succ);</span></CodeLine>
<Link id="l02508" /><CodeLine lineNumber="2508"><span class="doxyHighlight">        LargestExitEdgeProb = std::max(LargestExitEdgeProb, SuccProb);</span></CodeLine>
<Link id="l02509" /><CodeLine lineNumber="2509"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l02510" /><CodeLine lineNumber="2510"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02511" /><CodeLine lineNumber="2511"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LargestExitEdgeProb &gt; <a href="/docs/api/classes/llvm/branchprobability/#afd00958cba7080048a84cccfcef55d71">BranchProbability::getZero</a>()) &#123;</span></CodeLine>
<Link id="l02512" /><CodeLine lineNumber="2512"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> ExitFreq = MBFI-&gt;getBlockFreq(BB) &#42; LargestExitEdgeProb;</span></CodeLine>
<Link id="l02513" /><CodeLine lineNumber="2513"><span class="doxyHighlight">      ExitsWithFreq.<a href="/docs/api/classes/llvm/smallvectorimpl/#a396fcfee6914c76974b73c3d203da6a5">emplace&#95;back</a>(BB, ExitFreq);</span></CodeLine>
<Link id="l02514" /><CodeLine lineNumber="2514"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02515" /><CodeLine lineNumber="2515"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02516" /><CodeLine lineNumber="2516"></CodeLine>
<Link id="l02517" /><CodeLine lineNumber="2517"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In this loop we iterate every block in the loop chain and calculate the</span></CodeLine>
<Link id="l02518" /><CodeLine lineNumber="2518"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// cost assuming the block is the head of the loop chain. When the loop ends,</span></CodeLine>
<Link id="l02519" /><CodeLine lineNumber="2519"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// we should have found the best candidate as the loop chain&#39;s head.</span></CodeLine>
<Link id="l02520" /><CodeLine lineNumber="2520"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Iter = LoopChain.begin(), TailIter = std::prev(LoopChain.end()),</span></CodeLine>
<Link id="l02521" /><CodeLine lineNumber="2521"><span class="doxyHighlight">            EndIter = LoopChain.end();</span></CodeLine>
<Link id="l02522" /><CodeLine lineNumber="2522"><span class="doxyHighlight">       Iter != EndIter; Iter++, TailIter++) &#123;</span></CodeLine>
<Link id="l02523" /><CodeLine lineNumber="2523"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// TailIter is used to track the tail of the loop chain if the block we are</span></CodeLine>
<Link id="l02524" /><CodeLine lineNumber="2524"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// checking (pointed by Iter) is the head of the chain.</span></CodeLine>
<Link id="l02525" /><CodeLine lineNumber="2525"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (TailIter == LoopChain.end())</span></CodeLine>
<Link id="l02526" /><CodeLine lineNumber="2526"><span class="doxyHighlight">      TailIter = LoopChain.begin();</span></CodeLine>
<Link id="l02527" /><CodeLine lineNumber="2527"></CodeLine>
<Link id="l02528" /><CodeLine lineNumber="2528"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> TailBB = &#42;TailIter;</span></CodeLine>
<Link id="l02529" /><CodeLine lineNumber="2529"></CodeLine>
<Link id="l02530" /><CodeLine lineNumber="2530"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Calculate the cost by putting this BB to the top.</span></CodeLine>
<Link id="l02531" /><CodeLine lineNumber="2531"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> <a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a> = <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>(0);</span></CodeLine>
<Link id="l02532" /><CodeLine lineNumber="2532"></CodeLine>
<Link id="l02533" /><CodeLine lineNumber="2533"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If the current BB is the loop header, we need to take into account the</span></CodeLine>
<Link id="l02534" /><CodeLine lineNumber="2534"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// cost of the missed fall through edge from outside of the loop to the</span></CodeLine>
<Link id="l02535" /><CodeLine lineNumber="2535"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// header.</span></CodeLine>
<Link id="l02536" /><CodeLine lineNumber="2536"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Iter != LoopChain.begin())</span></CodeLine>
<Link id="l02537" /><CodeLine lineNumber="2537"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a> += HeaderFallThroughCost;</span></CodeLine>
<Link id="l02538" /><CodeLine lineNumber="2538"></CodeLine>
<Link id="l02539" /><CodeLine lineNumber="2539"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Collect the loop exit cost by summing up frequencies of all exit edges</span></CodeLine>
<Link id="l02540" /><CodeLine lineNumber="2540"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// except the one from the chain tail.</span></CodeLine>
<Link id="l02541" /><CodeLine lineNumber="2541"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;ExitWithFreq : ExitsWithFreq)</span></CodeLine>
<Link id="l02542" /><CodeLine lineNumber="2542"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (TailBB != ExitWithFreq.first)</span></CodeLine>
<Link id="l02543" /><CodeLine lineNumber="2543"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a> += ExitWithFreq.second;</span></CodeLine>
<Link id="l02544" /><CodeLine lineNumber="2544"></CodeLine>
<Link id="l02545" /><CodeLine lineNumber="2545"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// The cost of breaking the once fall-through edge from the tail to the top</span></CodeLine>
<Link id="l02546" /><CodeLine lineNumber="2546"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// of the loop chain. Here we need to consider three cases:</span></CodeLine>
<Link id="l02547" /><CodeLine lineNumber="2547"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// 1 If the tail node has only one successor, then we will get an</span></CodeLine>
<Link id="l02548" /><CodeLine lineNumber="2548"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//    additional jmp instruction. So the cost here is (MisfetchCost +</span></CodeLine>
<Link id="l02549" /><CodeLine lineNumber="2549"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//    JumpInstCost) &#42; tail node frequency.</span></CodeLine>
<Link id="l02550" /><CodeLine lineNumber="2550"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// 2 If the tail node has two successors, then we may still get an</span></CodeLine>
<Link id="l02551" /><CodeLine lineNumber="2551"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//    additional jmp instruction if the layout successor after the loop</span></CodeLine>
<Link id="l02552" /><CodeLine lineNumber="2552"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//    chain is not its CFG successor. Note that the more frequently executed</span></CodeLine>
<Link id="l02553" /><CodeLine lineNumber="2553"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//    jmp instruction will be put ahead of the other one. Assume the</span></CodeLine>
<Link id="l02554" /><CodeLine lineNumber="2554"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//    frequency of those two branches are x and y, where x is the frequency</span></CodeLine>
<Link id="l02555" /><CodeLine lineNumber="2555"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//    of the edge to the chain head, then the cost will be</span></CodeLine>
<Link id="l02556" /><CodeLine lineNumber="2556"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//    (x &#42; MisfetechCost + min(x, y) &#42; JumpInstCost) &#42; tail node frequency.</span></CodeLine>
<Link id="l02557" /><CodeLine lineNumber="2557"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// 3 If the tail node has more than two successors (this rarely happens),</span></CodeLine>
<Link id="l02558" /><CodeLine lineNumber="2558"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//    we won&#39;t consider any additional cost.</span></CodeLine>
<Link id="l02559" /><CodeLine lineNumber="2559"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (TailBB-&gt;isSuccessor(&#42;Iter)) &#123;</span></CodeLine>
<Link id="l02560" /><CodeLine lineNumber="2560"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> TailBBFreq = MBFI-&gt;getBlockFreq(TailBB);</span></CodeLine>
<Link id="l02561" /><CodeLine lineNumber="2561"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (TailBB-&gt;succ&#95;size() == 1)</span></CodeLine>
<Link id="l02562" /><CodeLine lineNumber="2562"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a> += ScaleBlockFrequency(TailBBFreq, <a href="#a75fe07dfba15c73225c8ca4cd720049d">MisfetchCost</a> + <a href="#a72b387cbb4c16dbf0558135dd26ddfd0">JumpInstCost</a>);</span></CodeLine>
<Link id="l02563" /><CodeLine lineNumber="2563"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (TailBB-&gt;succ&#95;size() == 2) &#123;</span></CodeLine>
<Link id="l02564" /><CodeLine lineNumber="2564"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> TailToHeadProb = MBPI-&gt;getEdgeProbability(TailBB, &#42;Iter);</span></CodeLine>
<Link id="l02565" /><CodeLine lineNumber="2565"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> TailToHeadFreq = TailBBFreq &#42; TailToHeadProb;</span></CodeLine>
<Link id="l02566" /><CodeLine lineNumber="2566"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> ColderEdgeFreq = TailToHeadProb &gt; <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a>(1, 2)</span></CodeLine>
<Link id="l02567" /><CodeLine lineNumber="2567"><span class="doxyHighlight">                                  ? TailBBFreq &#42; TailToHeadProb.<a href="/docs/api/classes/llvm/branchprobability/#aaee6034264d5d0782e5d1489360730d9">getCompl</a>()</span></CodeLine>
<Link id="l02568" /><CodeLine lineNumber="2568"><span class="doxyHighlight">                                  : TailToHeadFreq;</span></CodeLine>
<Link id="l02569" /><CodeLine lineNumber="2569"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a> += ScaleBlockFrequency(TailToHeadFreq, <a href="#a75fe07dfba15c73225c8ca4cd720049d">MisfetchCost</a>) +</span></CodeLine>
<Link id="l02570" /><CodeLine lineNumber="2570"><span class="doxyHighlight">                ScaleBlockFrequency(ColderEdgeFreq, <a href="#a72b387cbb4c16dbf0558135dd26ddfd0">JumpInstCost</a>);</span></CodeLine>
<Link id="l02571" /><CodeLine lineNumber="2571"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l02572" /><CodeLine lineNumber="2572"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02573" /><CodeLine lineNumber="2573"></CodeLine>
<Link id="l02574" /><CodeLine lineNumber="2574"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;The cost of loop rotation by making &quot;</span></CodeLine>
<Link id="l02575" /><CodeLine lineNumber="2575"><span class="doxyHighlight">                      &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(&#42;Iter) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; to the top: &quot;</span></CodeLine>
<Link id="l02576" /><CodeLine lineNumber="2576"><span class="doxyHighlight">                      &lt;&lt; <a href="/docs/api/namespaces/llvm/#ada715bce8140114cd2fd2f8ab018f7c3">printBlockFreq</a>(MBFI-&gt;getMBFI(), <a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a>) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02577" /><CodeLine lineNumber="2577"></CodeLine>
<Link id="l02578" /><CodeLine lineNumber="2578"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a> &lt; SmallestRotationCost) &#123;</span></CodeLine>
<Link id="l02579" /><CodeLine lineNumber="2579"><span class="doxyHighlight">      SmallestRotationCost = <a href="/docs/api/namespaces/llvm/#a19921a3ceb99548f498d3df118eda9ed">Cost</a>;</span></CodeLine>
<Link id="l02580" /><CodeLine lineNumber="2580"><span class="doxyHighlight">      RotationPos = <a href="/docs/api/namespaces/anonymous-cskyconstantislandpass-cpp-/#a0bd7d621ba8de56e4052df49da823802">Iter</a>;</span></CodeLine>
<Link id="l02581" /><CodeLine lineNumber="2581"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02582" /><CodeLine lineNumber="2582"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02583" /><CodeLine lineNumber="2583"></CodeLine>
<Link id="l02584" /><CodeLine lineNumber="2584"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (RotationPos != LoopChain.end()) &#123;</span></CodeLine>
<Link id="l02585" /><CodeLine lineNumber="2585"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Rotate loop by making &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(&#42;RotationPos)</span></CodeLine>
<Link id="l02586" /><CodeLine lineNumber="2586"><span class="doxyHighlight">                      &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; to the top\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02587" /><CodeLine lineNumber="2587"><span class="doxyHighlight">    std::rotate(LoopChain.begin(), RotationPos, LoopChain.end());</span></CodeLine>
<Link id="l02588" /><CodeLine lineNumber="2588"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02589" /><CodeLine lineNumber="2589"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02590" /><CodeLine lineNumber="2590"></CodeLine>
<Link id="l02591" /><CodeLine lineNumber="2591"><span class="doxyHighlightComment">/// Collect blocks in the given loop that are to be placed.</span></CodeLine>
<Link id="l02592" /><CodeLine lineNumber="2592"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l02593" /><CodeLine lineNumber="2593"><span class="doxyHighlightComment">/// When profile data is available, exclude cold blocks from the returned set;</span></CodeLine>
<Link id="l02594" /><CodeLine lineNumber="2594"><span class="doxyHighlightComment">/// otherwise, collect all blocks in the loop.</span></CodeLine>
<Link id="l02595" /><CodeLine lineNumber="2595"><span class="doxyHighlight">MachineBlockPlacement::BlockFilterSet</span></CodeLine>
<Link id="l02596" /><CodeLine lineNumber="2596"><span class="doxyHighlight">MachineBlockPlacement::collectLoopBlockSet(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machineloop">MachineLoop</a> &amp;L) &#123;</span></CodeLine>
<Link id="l02597" /><CodeLine lineNumber="2597"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Collect the blocks in a set ordered by block number, as this gives the same</span></CodeLine>
<Link id="l02598" /><CodeLine lineNumber="2598"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// order as they appear in the function.</span></CodeLine>
<Link id="l02599" /><CodeLine lineNumber="2599"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">struct </span><span class="doxyHighlight">MBBCompare &#123;</span></CodeLine>
<Link id="l02600" /><CodeLine lineNumber="2600"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> operator()(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> MachineBasicBlock &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>,</span></CodeLine>
<Link id="l02601" /><CodeLine lineNumber="2601"><span class="doxyHighlight">                    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> MachineBasicBlock &#42;<a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>)</span><span class="doxyHighlightKeyword"> const </span><span class="doxyHighlight">&#123;</span></CodeLine>
<Link id="l02602" /><CodeLine lineNumber="2602"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#ab60f28d7a141ac46ccc200176a1bca8b">X</a>-&gt;getNumber() &lt; <a href="/docs/api/files/lib/lib/tablegen/tablegenbackendskeleton-cpp/#a262774d3e5186511427e5b2414a85f7f">Y</a>-&gt;getNumber();</span></CodeLine>
<Link id="l02603" /><CodeLine lineNumber="2603"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02604" /><CodeLine lineNumber="2604"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l02605" /><CodeLine lineNumber="2605"><span class="doxyHighlight">  std::set&lt;const MachineBasicBlock &#42;, MBBCompare&gt; LoopBlockSet;</span></CodeLine>
<Link id="l02606" /><CodeLine lineNumber="2606"></CodeLine>
<Link id="l02607" /><CodeLine lineNumber="2607"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Filter cold blocks off from LoopBlockSet when profile data is available.</span></CodeLine>
<Link id="l02608" /><CodeLine lineNumber="2608"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Collect the sum of frequencies of incoming edges to the loop header from</span></CodeLine>
<Link id="l02609" /><CodeLine lineNumber="2609"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// outside. If we treat the loop as a super block, this is the frequency of</span></CodeLine>
<Link id="l02610" /><CodeLine lineNumber="2610"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the loop. Then for each block in the loop, we calculate the ratio between</span></CodeLine>
<Link id="l02611" /><CodeLine lineNumber="2611"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// its frequency and the frequency of the loop block. When it is too small,</span></CodeLine>
<Link id="l02612" /><CodeLine lineNumber="2612"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// don&#39;t add it to the loop chain. If there are outer loops, then this block</span></CodeLine>
<Link id="l02613" /><CodeLine lineNumber="2613"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// will be merged into the first outer loop chain for which this block is not</span></CodeLine>
<Link id="l02614" /><CodeLine lineNumber="2614"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// cold anymore. This needs precise profile data and we only do this when</span></CodeLine>
<Link id="l02615" /><CodeLine lineNumber="2615"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// profile data is available.</span></CodeLine>
<Link id="l02616" /><CodeLine lineNumber="2616"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getFunction().hasProfileData() || <a href="#a3ede40cd3f6f158cb8cbbc9de3844d98">ForceLoopColdBlock</a>) &#123;</span></CodeLine>
<Link id="l02617" /><CodeLine lineNumber="2617"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> LoopFreq(0);</span></CodeLine>
<Link id="l02618" /><CodeLine lineNumber="2618"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;LoopPred : <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>.getHeader()-&gt;predecessors())</span></CodeLine>
<Link id="l02619" /><CodeLine lineNumber="2619"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>.contains(LoopPred))</span></CodeLine>
<Link id="l02620" /><CodeLine lineNumber="2620"><span class="doxyHighlight">        LoopFreq += MBFI-&gt;getBlockFreq(LoopPred) &#42;</span></CodeLine>
<Link id="l02621" /><CodeLine lineNumber="2621"><span class="doxyHighlight">                    MBPI-&gt;getEdgeProbability(LoopPred, <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>.getHeader());</span></CodeLine>
<Link id="l02622" /><CodeLine lineNumber="2622"></CodeLine>
<Link id="l02623" /><CodeLine lineNumber="2623"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;LoopBB : <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>.getBlocks()) &#123;</span></CodeLine>
<Link id="l02624" /><CodeLine lineNumber="2624"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LoopBlockSet.count(LoopBB))</span></CodeLine>
<Link id="l02625" /><CodeLine lineNumber="2625"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02626" /><CodeLine lineNumber="2626"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Freq = MBFI-&gt;getBlockFreq(LoopBB).<a href="/docs/api/classes/llvm/blockfrequency/#a8e9ed6b20c2503f66f1fd0725297aedc">getFrequency</a>();</span></CodeLine>
<Link id="l02627" /><CodeLine lineNumber="2627"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Freq == 0 || LoopFreq.getFrequency() / Freq &gt; <a href="#acba0c508ce2e626b58485ceb28068cf1">LoopToColdBlockRatio</a>)</span></CodeLine>
<Link id="l02628" /><CodeLine lineNumber="2628"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02629" /><CodeLine lineNumber="2629"><span class="doxyHighlight">      <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;<a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a> = BlockToChain&#91;LoopBB&#93;;</span></CodeLine>
<Link id="l02630" /><CodeLine lineNumber="2630"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;ChainBB : &#42;Chain)</span></CodeLine>
<Link id="l02631" /><CodeLine lineNumber="2631"><span class="doxyHighlight">        LoopBlockSet.insert(ChainBB);</span></CodeLine>
<Link id="l02632" /><CodeLine lineNumber="2632"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02633" /><CodeLine lineNumber="2633"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l02634" /><CodeLine lineNumber="2634"><span class="doxyHighlight">    LoopBlockSet.insert(<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>.block&#95;begin(), <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>.block&#95;end());</span></CodeLine>
<Link id="l02635" /><CodeLine lineNumber="2635"></CodeLine>
<Link id="l02636" /><CodeLine lineNumber="2636"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Copy the blocks into a BlockFilterSet, as iterating it is faster than</span></CodeLine>
<Link id="l02637" /><CodeLine lineNumber="2637"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// std::set. We will only remove blocks and never insert them, which will</span></CodeLine>
<Link id="l02638" /><CodeLine lineNumber="2638"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// preserve the ordering.</span></CodeLine>
<Link id="l02639" /><CodeLine lineNumber="2639"><span class="doxyHighlight">  BlockFilterSet <a href="/docs/api/namespaces/llvm/mipsisd/#a422daf9aa810935178671306b651d69ba366e1eac31eeb1a1892d62ccfc0c8cf8">Ret</a>(LoopBlockSet.begin(), LoopBlockSet.end());</span></CodeLine>
<Link id="l02640" /><CodeLine lineNumber="2640"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/mipsisd/#a422daf9aa810935178671306b651d69ba366e1eac31eeb1a1892d62ccfc0c8cf8">Ret</a>;</span></CodeLine>
<Link id="l02641" /><CodeLine lineNumber="2641"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02642" /><CodeLine lineNumber="2642"></CodeLine>
<Link id="l02643" /><CodeLine lineNumber="2643"><span class="doxyHighlightComment">/// Forms basic block chains from the natural loop structures.</span></CodeLine>
<Link id="l02644" /><CodeLine lineNumber="2644"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l02645" /><CodeLine lineNumber="2645"><span class="doxyHighlightComment">/// These chains are designed to preserve the existing &#42;structure&#42; of the code</span></CodeLine>
<Link id="l02646" /><CodeLine lineNumber="2646"><span class="doxyHighlightComment">/// as much as possible. We can then stitch the chains together in a way which</span></CodeLine>
<Link id="l02647" /><CodeLine lineNumber="2647"><span class="doxyHighlightComment">/// both preserves the topological structure and minimizes taken conditional</span></CodeLine>
<Link id="l02648" /><CodeLine lineNumber="2648"><span class="doxyHighlightComment">/// branches.</span></CodeLine>
<Link id="l02649" /><CodeLine lineNumber="2649"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> MachineBlockPlacement::buildLoopChains(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machineloop">MachineLoop</a> &amp;L) &#123;</span></CodeLine>
<Link id="l02650" /><CodeLine lineNumber="2650"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// First recurse through any nested loops, building chains for those inner</span></CodeLine>
<Link id="l02651" /><CodeLine lineNumber="2651"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// loops.</span></CodeLine>
<Link id="l02652" /><CodeLine lineNumber="2652"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machineloop">MachineLoop</a> &#42;InnerLoop : L)</span></CodeLine>
<Link id="l02653" /><CodeLine lineNumber="2653"><span class="doxyHighlight">    buildLoopChains(&#42;InnerLoop);</span></CodeLine>
<Link id="l02654" /><CodeLine lineNumber="2654"></CodeLine>
<Link id="l02655" /><CodeLine lineNumber="2655"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BlockWorkList.empty() &amp;&amp;</span></CodeLine>
<Link id="l02656" /><CodeLine lineNumber="2656"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;BlockWorkList not empty when starting to build loop chains.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02657" /><CodeLine lineNumber="2657"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(EHPadWorkList.empty() &amp;&amp;</span></CodeLine>
<Link id="l02658" /><CodeLine lineNumber="2658"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;EHPadWorkList not empty when starting to build loop chains.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02659" /><CodeLine lineNumber="2659"><span class="doxyHighlight">  BlockFilterSet LoopBlockSet = collectLoopBlockSet(L);</span></CodeLine>
<Link id="l02660" /><CodeLine lineNumber="2660"></CodeLine>
<Link id="l02661" /><CodeLine lineNumber="2661"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Check if we have profile data for this function. If yes, we will rotate</span></CodeLine>
<Link id="l02662" /><CodeLine lineNumber="2662"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// this loop by modeling costs more precisely which requires the profile data</span></CodeLine>
<Link id="l02663" /><CodeLine lineNumber="2663"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// for better layout.</span></CodeLine>
<Link id="l02664" /><CodeLine lineNumber="2664"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> RotateLoopWithProfile =</span></CodeLine>
<Link id="l02665" /><CodeLine lineNumber="2665"><span class="doxyHighlight">      <a href="#ae71e7939345cee7ef0596b40d1ad068b">ForcePreciseRotationCost</a> ||</span></CodeLine>
<Link id="l02666" /><CodeLine lineNumber="2666"><span class="doxyHighlight">      (<a href="#a0d30337c58d278817264718434f122ca">PreciseRotationCost</a> &amp;&amp; <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getFunction().<a href="/docs/api/files/lib/lib/transforms/lib/transforms/ipo/partialinlining-cpp/#a8884a3765a9cdbc730400587d4a3192c">hasProfileData</a>());</span></CodeLine>
<Link id="l02667" /><CodeLine lineNumber="2667"></CodeLine>
<Link id="l02668" /><CodeLine lineNumber="2668"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// First check to see if there is an obviously preferable top block for the</span></CodeLine>
<Link id="l02669" /><CodeLine lineNumber="2669"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// loop. This will default to the header, but may end up as one of the</span></CodeLine>
<Link id="l02670" /><CodeLine lineNumber="2670"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// predecessors to the header if there is one which will result in strictly</span></CodeLine>
<Link id="l02671" /><CodeLine lineNumber="2671"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// fewer branches in the loop body.</span></CodeLine>
<Link id="l02672" /><CodeLine lineNumber="2672"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;LoopTop = findBestLoopTop(L, LoopBlockSet);</span></CodeLine>
<Link id="l02673" /><CodeLine lineNumber="2673"></CodeLine>
<Link id="l02674" /><CodeLine lineNumber="2674"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we selected just the header for the loop top, look for a potentially</span></CodeLine>
<Link id="l02675" /><CodeLine lineNumber="2675"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// profitable exit block in the event that rotating the loop can eliminate</span></CodeLine>
<Link id="l02676" /><CodeLine lineNumber="2676"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// branches by placing an exit edge at the bottom.</span></CodeLine>
<Link id="l02677" /><CodeLine lineNumber="2677"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l02678" /><CodeLine lineNumber="2678"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Loops are processed innermost to uttermost, make sure we clear</span></CodeLine>
<Link id="l02679" /><CodeLine lineNumber="2679"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// PreferredLoopExit before processing a new loop.</span></CodeLine>
<Link id="l02680" /><CodeLine lineNumber="2680"><span class="doxyHighlight">  PreferredLoopExit = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02681" /><CodeLine lineNumber="2681"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> ExitFreq;</span></CodeLine>
<Link id="l02682" /><CodeLine lineNumber="2682"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!RotateLoopWithProfile &amp;&amp; LoopTop == <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>.getHeader())</span></CodeLine>
<Link id="l02683" /><CodeLine lineNumber="2683"><span class="doxyHighlight">    PreferredLoopExit = findBestLoopExit(L, LoopBlockSet, ExitFreq);</span></CodeLine>
<Link id="l02684" /><CodeLine lineNumber="2684"></CodeLine>
<Link id="l02685" /><CodeLine lineNumber="2685"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;LoopChain = &#42;BlockToChain&#91;LoopTop&#93;;</span></CodeLine>
<Link id="l02686" /><CodeLine lineNumber="2686"></CodeLine>
<Link id="l02687" /><CodeLine lineNumber="2687"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// FIXME: This is a really lame way of walking the chains in the loop: we</span></CodeLine>
<Link id="l02688" /><CodeLine lineNumber="2688"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// walk the blocks, and use a set to prevent visiting a particular chain</span></CodeLine>
<Link id="l02689" /><CodeLine lineNumber="2689"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// twice.</span></CodeLine>
<Link id="l02690" /><CodeLine lineNumber="2690"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;BlockChain &#42;, 4&gt;</a> UpdatedPreds;</span></CodeLine>
<Link id="l02691" /><CodeLine lineNumber="2691"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(LoopChain.UnscheduledPredecessors == 0 &amp;&amp;</span></CodeLine>
<Link id="l02692" /><CodeLine lineNumber="2692"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;LoopChain should not have unscheduled predecessors.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02693" /><CodeLine lineNumber="2693"><span class="doxyHighlight">  UpdatedPreds.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(&amp;LoopChain);</span></CodeLine>
<Link id="l02694" /><CodeLine lineNumber="2694"></CodeLine>
<Link id="l02695" /><CodeLine lineNumber="2695"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;LoopBB : LoopBlockSet)</span></CodeLine>
<Link id="l02696" /><CodeLine lineNumber="2696"><span class="doxyHighlight">    fillWorkLists(LoopBB, UpdatedPreds, &amp;LoopBlockSet);</span></CodeLine>
<Link id="l02697" /><CodeLine lineNumber="2697"></CodeLine>
<Link id="l02698" /><CodeLine lineNumber="2698"><span class="doxyHighlight">  buildChain(LoopTop, LoopChain, &amp;LoopBlockSet);</span></CodeLine>
<Link id="l02699" /><CodeLine lineNumber="2699"></CodeLine>
<Link id="l02700" /><CodeLine lineNumber="2700"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (RotateLoopWithProfile)</span></CodeLine>
<Link id="l02701" /><CodeLine lineNumber="2701"><span class="doxyHighlight">    rotateLoopWithProfile(LoopChain, L, LoopBlockSet);</span></CodeLine>
<Link id="l02702" /><CodeLine lineNumber="2702"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l02703" /><CodeLine lineNumber="2703"><span class="doxyHighlight">    rotateLoop(LoopChain, PreferredLoopExit, ExitFreq, LoopBlockSet);</span></CodeLine>
<Link id="l02704" /><CodeLine lineNumber="2704"></CodeLine>
<Link id="l02705" /><CodeLine lineNumber="2705"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(&#123;</span></CodeLine>
<Link id="l02706" /><CodeLine lineNumber="2706"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Crash at the end so we get all of the debugging output first.</span></CodeLine>
<Link id="l02707" /><CodeLine lineNumber="2707"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> BadLoop = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02708" /><CodeLine lineNumber="2708"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LoopChain.UnscheduledPredecessors) &#123;</span></CodeLine>
<Link id="l02709" /><CodeLine lineNumber="2709"><span class="doxyHighlight">      BadLoop = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02710" /><CodeLine lineNumber="2710"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Loop chain contains a block without its preds placed!\\n&quot;</span></CodeLine>
<Link id="l02711" /><CodeLine lineNumber="2711"><span class="doxyHighlight">             &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Loop header:  &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(&#42;<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>.block&#95;begin()) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span></CodeLine>
<Link id="l02712" /><CodeLine lineNumber="2712"><span class="doxyHighlight">             &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Chain header: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(&#42;LoopChain.begin()) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02713" /><CodeLine lineNumber="2713"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02714" /><CodeLine lineNumber="2714"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;ChainBB : LoopChain) &#123;</span></CodeLine>
<Link id="l02715" /><CodeLine lineNumber="2715"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;          ... &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(ChainBB) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02716" /><CodeLine lineNumber="2716"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!LoopBlockSet.remove(ChainBB)) &#123;</span></CodeLine>
<Link id="l02717" /><CodeLine lineNumber="2717"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// We don&#39;t mark the loop as bad here because there are real situations</span></CodeLine>
<Link id="l02718" /><CodeLine lineNumber="2718"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// where this can occur. For example, with an unanalyzable fallthrough</span></CodeLine>
<Link id="l02719" /><CodeLine lineNumber="2719"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// from a loop block to a non-loop block or vice versa.</span></CodeLine>
<Link id="l02720" /><CodeLine lineNumber="2720"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Loop chain contains a block not contained by the loop!\\n&quot;</span></CodeLine>
<Link id="l02721" /><CodeLine lineNumber="2721"><span class="doxyHighlight">               &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Loop header:  &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(&#42;<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>.block&#95;begin()) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span></CodeLine>
<Link id="l02722" /><CodeLine lineNumber="2722"><span class="doxyHighlight">               &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Chain header: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(&#42;LoopChain.begin()) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span></CodeLine>
<Link id="l02723" /><CodeLine lineNumber="2723"><span class="doxyHighlight">               &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Bad block:    &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(ChainBB) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02724" /><CodeLine lineNumber="2724"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l02725" /><CodeLine lineNumber="2725"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02726" /><CodeLine lineNumber="2726"></CodeLine>
<Link id="l02727" /><CodeLine lineNumber="2727"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!LoopBlockSet.empty()) &#123;</span></CodeLine>
<Link id="l02728" /><CodeLine lineNumber="2728"><span class="doxyHighlight">      BadLoop = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02729" /><CodeLine lineNumber="2729"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;LoopBB : LoopBlockSet)</span></CodeLine>
<Link id="l02730" /><CodeLine lineNumber="2730"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Loop contains blocks never placed into a chain!\\n&quot;</span></CodeLine>
<Link id="l02731" /><CodeLine lineNumber="2731"><span class="doxyHighlight">               &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Loop header:  &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(&#42;<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>.block&#95;begin()) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span></CodeLine>
<Link id="l02732" /><CodeLine lineNumber="2732"><span class="doxyHighlight">               &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Chain header: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(&#42;LoopChain.begin()) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span></CodeLine>
<Link id="l02733" /><CodeLine lineNumber="2733"><span class="doxyHighlight">               &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Bad block:    &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(LoopBB) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02734" /><CodeLine lineNumber="2734"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02735" /><CodeLine lineNumber="2735"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!BadLoop &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Detected problems with the placement of this loop.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02736" /><CodeLine lineNumber="2736"><span class="doxyHighlight">  &#125;);</span></CodeLine>
<Link id="l02737" /><CodeLine lineNumber="2737"></CodeLine>
<Link id="l02738" /><CodeLine lineNumber="2738"><span class="doxyHighlight">  BlockWorkList.clear();</span></CodeLine>
<Link id="l02739" /><CodeLine lineNumber="2739"><span class="doxyHighlight">  EHPadWorkList.clear();</span></CodeLine>
<Link id="l02740" /><CodeLine lineNumber="2740"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02741" /><CodeLine lineNumber="2741"></CodeLine>
<Link id="l02742" /><CodeLine lineNumber="2742"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> MachineBlockPlacement::buildCFGChains() &#123;</span></CodeLine>
<Link id="l02743" /><CodeLine lineNumber="2743"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Ensure that every BB in the function has an associated chain to simplify</span></CodeLine>
<Link id="l02744" /><CodeLine lineNumber="2744"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the assumptions of the remaining algorithm.</span></CodeLine>
<Link id="l02745" /><CodeLine lineNumber="2745"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineOperand, 4&gt;</a> <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>; </span><span class="doxyHighlightComment">// For analyzeBranch.</span></CodeLine>
<Link id="l02746" /><CodeLine lineNumber="2746"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinefunction/#aaba82c71ffdca966cad10eae0992fff9">MachineFunction::iterator</a> FI = <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;begin(), FE = <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;end(); FI != FE;</span></CodeLine>
<Link id="l02747" /><CodeLine lineNumber="2747"><span class="doxyHighlight">       ++FI) &#123;</span></CodeLine>
<Link id="l02748" /><CodeLine lineNumber="2748"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB = &amp;&#42;FI;</span></CodeLine>
<Link id="l02749" /><CodeLine lineNumber="2749"><span class="doxyHighlight">    <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;<a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a> =</span></CodeLine>
<Link id="l02750" /><CodeLine lineNumber="2750"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> (ChainAllocator.Allocate()) <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a>(BlockToChain, BB);</span></CodeLine>
<Link id="l02751" /><CodeLine lineNumber="2751"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Also, merge any blocks which we cannot reason about and must preserve</span></CodeLine>
<Link id="l02752" /><CodeLine lineNumber="2752"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// the exact fallthrough behavior for.</span></CodeLine>
<Link id="l02753" /><CodeLine lineNumber="2753"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">while</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">) &#123;</span></CodeLine>
<Link id="l02754" /><CodeLine lineNumber="2754"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>.clear();</span></CodeLine>
<Link id="l02755" /><CodeLine lineNumber="2755"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a> = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">, &#42;FBB = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">; </span><span class="doxyHighlightComment">// For analyzeBranch.</span></CodeLine>
<Link id="l02756" /><CodeLine lineNumber="2756"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;analyzeBranch(&#42;BB, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a>, FBB, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>) || !FI-&gt;canFallThrough())</span></CodeLine>
<Link id="l02757" /><CodeLine lineNumber="2757"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02758" /><CodeLine lineNumber="2758"></CodeLine>
<Link id="l02759" /><CodeLine lineNumber="2759"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/machinefunction/#aaba82c71ffdca966cad10eae0992fff9">MachineFunction::iterator</a> NextFI = std::next(FI);</span></CodeLine>
<Link id="l02760" /><CodeLine lineNumber="2760"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;NextBB = &amp;&#42;NextFI;</span></CodeLine>
<Link id="l02761" /><CodeLine lineNumber="2761"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Ensure that the layout successor is a viable block, as we know that</span></CodeLine>
<Link id="l02762" /><CodeLine lineNumber="2762"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// fallthrough is a possibility.</span></CodeLine>
<Link id="l02763" /><CodeLine lineNumber="2763"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(NextFI != FE &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Can&#39;t fallthrough past the last block.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02764" /><CodeLine lineNumber="2764"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Pre-merging due to unanalyzable fallthrough: &quot;</span></CodeLine>
<Link id="l02765" /><CodeLine lineNumber="2765"><span class="doxyHighlight">                        &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(BB) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; -&gt; &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(NextBB)</span></CodeLine>
<Link id="l02766" /><CodeLine lineNumber="2766"><span class="doxyHighlight">                        &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02767" /><CodeLine lineNumber="2767"><span class="doxyHighlight">      <a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>-&gt;merge(NextBB, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02768" /><CodeLine lineNumber="2768"><span class="doxyHighlightPreprocessor">#ifndef NDEBUG</span></CodeLine>
<Link id="l02769" /><CodeLine lineNumber="2769"><span class="doxyHighlight">      BlocksWithUnanalyzableExits.<a href="/docs/api/classes/llvm/smallvectorimpl/#a94d23373106467003722f7d6c17b1528">insert</a>(&amp;&#42;BB);</span></CodeLine>
<Link id="l02770" /><CodeLine lineNumber="2770"><span class="doxyHighlightPreprocessor">#endif</span></CodeLine>
<Link id="l02771" /><CodeLine lineNumber="2771"><span class="doxyHighlight">      FI = NextFI;</span></CodeLine>
<Link id="l02772" /><CodeLine lineNumber="2772"><span class="doxyHighlight">      BB = NextBB;</span></CodeLine>
<Link id="l02773" /><CodeLine lineNumber="2773"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02774" /><CodeLine lineNumber="2774"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02775" /><CodeLine lineNumber="2775"></CodeLine>
<Link id="l02776" /><CodeLine lineNumber="2776"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Build any loop-based chains.</span></CodeLine>
<Link id="l02777" /><CodeLine lineNumber="2777"><span class="doxyHighlight">  PreferredLoopExit = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02778" /><CodeLine lineNumber="2778"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machineloop">MachineLoop</a> &#42;L : &#42;MLI)</span></CodeLine>
<Link id="l02779" /><CodeLine lineNumber="2779"><span class="doxyHighlight">    buildLoopChains(&#42;L);</span></CodeLine>
<Link id="l02780" /><CodeLine lineNumber="2780"></CodeLine>
<Link id="l02781" /><CodeLine lineNumber="2781"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BlockWorkList.empty() &amp;&amp;</span></CodeLine>
<Link id="l02782" /><CodeLine lineNumber="2782"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;BlockWorkList should be empty before building final chain.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02783" /><CodeLine lineNumber="2783"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(EHPadWorkList.empty() &amp;&amp;</span></CodeLine>
<Link id="l02784" /><CodeLine lineNumber="2784"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;EHPadWorkList should be empty before building final chain.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02785" /><CodeLine lineNumber="2785"></CodeLine>
<Link id="l02786" /><CodeLine lineNumber="2786"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;BlockChain &#42;, 4&gt;</a> UpdatedPreds;</span></CodeLine>
<Link id="l02787" /><CodeLine lineNumber="2787"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>)</span></CodeLine>
<Link id="l02788" /><CodeLine lineNumber="2788"><span class="doxyHighlight">    fillWorkLists(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, UpdatedPreds);</span></CodeLine>
<Link id="l02789" /><CodeLine lineNumber="2789"></CodeLine>
<Link id="l02790" /><CodeLine lineNumber="2790"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;FunctionChain = &#42;BlockToChain&#91;&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;front()&#93;;</span></CodeLine>
<Link id="l02791" /><CodeLine lineNumber="2791"><span class="doxyHighlight">  buildChain(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;front(), FunctionChain);</span></CodeLine>
<Link id="l02792" /><CodeLine lineNumber="2792"></CodeLine>
<Link id="l02793" /><CodeLine lineNumber="2793"><span class="doxyHighlightPreprocessor">#ifndef NDEBUG</span></CodeLine>
<Link id="l02794" /><CodeLine lineNumber="2794"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">using </span><span class="doxyHighlight">FunctionBlockSetType = <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;MachineBasicBlock &#42;, 16&gt;</a>;</span></CodeLine>
<Link id="l02795" /><CodeLine lineNumber="2795"><span class="doxyHighlightPreprocessor">#endif</span></CodeLine>
<Link id="l02796" /><CodeLine lineNumber="2796"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(&#123;</span></CodeLine>
<Link id="l02797" /><CodeLine lineNumber="2797"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Crash at the end so we get all of the debugging output first.</span></CodeLine>
<Link id="l02798" /><CodeLine lineNumber="2798"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> BadFunc = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02799" /><CodeLine lineNumber="2799"><span class="doxyHighlight">    FunctionBlockSetType FunctionBlockSet;</span></CodeLine>
<Link id="l02800" /><CodeLine lineNumber="2800"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>)</span></CodeLine>
<Link id="l02801" /><CodeLine lineNumber="2801"><span class="doxyHighlight">      FunctionBlockSet.insert(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</span></CodeLine>
<Link id="l02802" /><CodeLine lineNumber="2802"></CodeLine>
<Link id="l02803" /><CodeLine lineNumber="2803"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;ChainBB : FunctionChain)</span></CodeLine>
<Link id="l02804" /><CodeLine lineNumber="2804"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!FunctionBlockSet.erase(ChainBB)) &#123;</span></CodeLine>
<Link id="l02805" /><CodeLine lineNumber="2805"><span class="doxyHighlight">        BadFunc = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02806" /><CodeLine lineNumber="2806"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Function chain contains a block not in the function!\\n&quot;</span></CodeLine>
<Link id="l02807" /><CodeLine lineNumber="2807"><span class="doxyHighlight">               &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Bad block:    &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(ChainBB) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02808" /><CodeLine lineNumber="2808"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l02809" /><CodeLine lineNumber="2809"></CodeLine>
<Link id="l02810" /><CodeLine lineNumber="2810"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!FunctionBlockSet.empty()) &#123;</span></CodeLine>
<Link id="l02811" /><CodeLine lineNumber="2811"><span class="doxyHighlight">      BadFunc = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02812" /><CodeLine lineNumber="2812"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;RemainingBB : FunctionBlockSet)</span></CodeLine>
<Link id="l02813" /><CodeLine lineNumber="2813"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Function contains blocks never placed into a chain!\\n&quot;</span></CodeLine>
<Link id="l02814" /><CodeLine lineNumber="2814"><span class="doxyHighlight">               &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Bad block:    &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(RemainingBB) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02815" /><CodeLine lineNumber="2815"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02816" /><CodeLine lineNumber="2816"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!BadFunc &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Detected problems with the block placement.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02817" /><CodeLine lineNumber="2817"><span class="doxyHighlight">  &#125;);</span></CodeLine>
<Link id="l02818" /><CodeLine lineNumber="2818"></CodeLine>
<Link id="l02819" /><CodeLine lineNumber="2819"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Remember original layout ordering, so we can update terminators after</span></CodeLine>
<Link id="l02820" /><CodeLine lineNumber="2820"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// reordering to point to the original layout successor.</span></CodeLine>
<Link id="l02821" /><CodeLine lineNumber="2821"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineBasicBlock &#42;, 4&gt;</a> OriginalLayoutSuccessors(</span></CodeLine>
<Link id="l02822" /><CodeLine lineNumber="2822"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getNumBlockIDs());</span></CodeLine>
<Link id="l02823" /><CodeLine lineNumber="2823"><span class="doxyHighlight">  &#123;</span></CodeLine>
<Link id="l02824" /><CodeLine lineNumber="2824"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;LastMBB = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02825" /><CodeLine lineNumber="2825"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l02826" /><CodeLine lineNumber="2826"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LastMBB != </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l02827" /><CodeLine lineNumber="2827"><span class="doxyHighlight">        OriginalLayoutSuccessors&#91;LastMBB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a3aa22d521bd6a7e6b9f35545dc7b0f1e">getNumber</a>()&#93; = &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>;</span></CodeLine>
<Link id="l02828" /><CodeLine lineNumber="2828"><span class="doxyHighlight">      LastMBB = &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>;</span></CodeLine>
<Link id="l02829" /><CodeLine lineNumber="2829"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02830" /><CodeLine lineNumber="2830"><span class="doxyHighlight">    OriginalLayoutSuccessors&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;back().getNumber()&#93; = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02831" /><CodeLine lineNumber="2831"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02832" /><CodeLine lineNumber="2832"></CodeLine>
<Link id="l02833" /><CodeLine lineNumber="2833"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Splice the blocks into place.</span></CodeLine>
<Link id="l02834" /><CodeLine lineNumber="2834"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinefunction/#aaba82c71ffdca966cad10eae0992fff9">MachineFunction::iterator</a> InsertPos = <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;begin();</span></CodeLine>
<Link id="l02835" /><CodeLine lineNumber="2835"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;&#91;MBP&#93; Function: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getName() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02836" /><CodeLine lineNumber="2836"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;ChainBB : FunctionChain) &#123;</span></CodeLine>
<Link id="l02837" /><CodeLine lineNumber="2837"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; (ChainBB == &#42;FunctionChain.begin() ? </span><span class="doxyHighlightStringLiteral">&quot;Placing chain &quot;</span></CodeLine>
<Link id="l02838" /><CodeLine lineNumber="2838"><span class="doxyHighlight">                                                            : </span><span class="doxyHighlightStringLiteral">&quot;          ... &quot;</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l02839" /><CodeLine lineNumber="2839"><span class="doxyHighlight">                      &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(ChainBB) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02840" /><CodeLine lineNumber="2840"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (InsertPos != <a href="/docs/api/classes/llvm/machinefunction/#aaba82c71ffdca966cad10eae0992fff9">MachineFunction::iterator</a>(ChainBB))</span></CodeLine>
<Link id="l02841" /><CodeLine lineNumber="2841"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;splice(InsertPos, ChainBB);</span></CodeLine>
<Link id="l02842" /><CodeLine lineNumber="2842"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l02843" /><CodeLine lineNumber="2843"><span class="doxyHighlight">      ++InsertPos;</span></CodeLine>
<Link id="l02844" /><CodeLine lineNumber="2844"></CodeLine>
<Link id="l02845" /><CodeLine lineNumber="2845"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Update the terminator of the previous block.</span></CodeLine>
<Link id="l02846" /><CodeLine lineNumber="2846"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ChainBB == &#42;FunctionChain.begin())</span></CodeLine>
<Link id="l02847" /><CodeLine lineNumber="2847"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02848" /><CodeLine lineNumber="2848"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;PrevBB = &amp;&#42;std::prev(<a href="/docs/api/classes/llvm/machinefunction/#aaba82c71ffdca966cad10eae0992fff9">MachineFunction::iterator</a>(ChainBB));</span></CodeLine>
<Link id="l02849" /><CodeLine lineNumber="2849"></CodeLine>
<Link id="l02850" /><CodeLine lineNumber="2850"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// FIXME: It would be awesome of updateTerminator would just return rather</span></CodeLine>
<Link id="l02851" /><CodeLine lineNumber="2851"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// than assert when the branch cannot be analyzed in order to remove this</span></CodeLine>
<Link id="l02852" /><CodeLine lineNumber="2852"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// boiler plate.</span></CodeLine>
<Link id="l02853" /><CodeLine lineNumber="2853"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>.clear();</span></CodeLine>
<Link id="l02854" /><CodeLine lineNumber="2854"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a> = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">, &#42;FBB = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">; </span><span class="doxyHighlightComment">// For analyzeBranch.</span></CodeLine>
<Link id="l02855" /><CodeLine lineNumber="2855"></CodeLine>
<Link id="l02856" /><CodeLine lineNumber="2856"><span class="doxyHighlightPreprocessor">#ifndef NDEBUG</span></CodeLine>
<Link id="l02857" /><CodeLine lineNumber="2857"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!BlocksWithUnanalyzableExits.count(PrevBB)) &#123;</span></CodeLine>
<Link id="l02858" /><CodeLine lineNumber="2858"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Given the exact block placement we chose, we may actually not &#95;need&#95; to</span></CodeLine>
<Link id="l02859" /><CodeLine lineNumber="2859"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// be able to edit PrevBB&#39;s terminator sequence, but not being &#95;able&#95; to</span></CodeLine>
<Link id="l02860" /><CodeLine lineNumber="2860"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// do that at this point is a bug.</span></CodeLine>
<Link id="l02861" /><CodeLine lineNumber="2861"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((!<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;analyzeBranch(&#42;PrevBB, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a>, FBB, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>) ||</span></CodeLine>
<Link id="l02862" /><CodeLine lineNumber="2862"><span class="doxyHighlight">              !PrevBB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a5ffb77c69d69a5beff906caaecfd7be4">canFallThrough</a>()) &amp;&amp;</span></CodeLine>
<Link id="l02863" /><CodeLine lineNumber="2863"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;Unexpected block with un-analyzable fallthrough!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02864" /><CodeLine lineNumber="2864"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>.clear();</span></CodeLine>
<Link id="l02865" /><CodeLine lineNumber="2865"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a> = FBB = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02866" /><CodeLine lineNumber="2866"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02867" /><CodeLine lineNumber="2867"><span class="doxyHighlightPreprocessor">#endif</span></CodeLine>
<Link id="l02868" /><CodeLine lineNumber="2868"></CodeLine>
<Link id="l02869" /><CodeLine lineNumber="2869"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// The &quot;PrevBB&quot; is not yet updated to reflect current code layout, so,</span></CodeLine>
<Link id="l02870" /><CodeLine lineNumber="2870"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//   o. it may fall-through to a block without explicit &quot;goto&quot; instruction</span></CodeLine>
<Link id="l02871" /><CodeLine lineNumber="2871"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//      before layout, and no longer fall-through it after layout; or</span></CodeLine>
<Link id="l02872" /><CodeLine lineNumber="2872"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//   o. just opposite.</span></CodeLine>
<Link id="l02873" /><CodeLine lineNumber="2873"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l02874" /><CodeLine lineNumber="2874"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// analyzeBranch() may return erroneous value for FBB when these two</span></CodeLine>
<Link id="l02875" /><CodeLine lineNumber="2875"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// situations take place. For the first scenario FBB is mistakenly set NULL;</span></CodeLine>
<Link id="l02876" /><CodeLine lineNumber="2876"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// for the 2nd scenario, the FBB, which is expected to be NULL, is</span></CodeLine>
<Link id="l02877" /><CodeLine lineNumber="2877"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// mistakenly pointing to &quot;&#42;BI&quot;.</span></CodeLine>
<Link id="l02878" /><CodeLine lineNumber="2878"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Thus, if the future change needs to use FBB before the layout is set, it</span></CodeLine>
<Link id="l02879" /><CodeLine lineNumber="2879"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// has to correct FBB first by using the code similar to the following:</span></CodeLine>
<Link id="l02880" /><CodeLine lineNumber="2880"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l02881" /><CodeLine lineNumber="2881"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// if (!Cond.empty() &amp;&amp; (!FBB || FBB == ChainBB)) &#123;</span></CodeLine>
<Link id="l02882" /><CodeLine lineNumber="2882"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//   PrevBB-&gt;updateTerminator();</span></CodeLine>
<Link id="l02883" /><CodeLine lineNumber="2883"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//   Cond.clear();</span></CodeLine>
<Link id="l02884" /><CodeLine lineNumber="2884"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//   TBB = FBB = nullptr;</span></CodeLine>
<Link id="l02885" /><CodeLine lineNumber="2885"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//   if (TII-&gt;analyzeBranch(&#42;PrevBB, TBB, FBB, Cond)) &#123;</span></CodeLine>
<Link id="l02886" /><CodeLine lineNumber="2886"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//     // FIXME: This should never take place.</span></CodeLine>
<Link id="l02887" /><CodeLine lineNumber="2887"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//     TBB = FBB = nullptr;</span></CodeLine>
<Link id="l02888" /><CodeLine lineNumber="2888"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//   &#125;</span></CodeLine>
<Link id="l02889" /><CodeLine lineNumber="2889"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// &#125;</span></CodeLine>
<Link id="l02890" /><CodeLine lineNumber="2890"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;analyzeBranch(&#42;PrevBB, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a>, FBB, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>)) &#123;</span></CodeLine>
<Link id="l02891" /><CodeLine lineNumber="2891"><span class="doxyHighlight">      PrevBB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a5803a49facae20ca4b002dcba6f1d03e">updateTerminator</a>(OriginalLayoutSuccessors&#91;PrevBB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a3aa22d521bd6a7e6b9f35545dc7b0f1e">getNumber</a>()&#93;);</span></CodeLine>
<Link id="l02892" /><CodeLine lineNumber="2892"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02893" /><CodeLine lineNumber="2893"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02894" /><CodeLine lineNumber="2894"></CodeLine>
<Link id="l02895" /><CodeLine lineNumber="2895"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Fixup the last block.</span></CodeLine>
<Link id="l02896" /><CodeLine lineNumber="2896"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>.clear();</span></CodeLine>
<Link id="l02897" /><CodeLine lineNumber="2897"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a> = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">, &#42;FBB = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">; </span><span class="doxyHighlightComment">// For analyzeBranch.</span></CodeLine>
<Link id="l02898" /><CodeLine lineNumber="2898"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;analyzeBranch(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;back(), <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a>, FBB, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>)) &#123;</span></CodeLine>
<Link id="l02899" /><CodeLine lineNumber="2899"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;PrevBB = &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;back();</span></CodeLine>
<Link id="l02900" /><CodeLine lineNumber="2900"><span class="doxyHighlight">    PrevBB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a5803a49facae20ca4b002dcba6f1d03e">updateTerminator</a>(OriginalLayoutSuccessors&#91;PrevBB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a3aa22d521bd6a7e6b9f35545dc7b0f1e">getNumber</a>()&#93;);</span></CodeLine>
<Link id="l02901" /><CodeLine lineNumber="2901"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02902" /><CodeLine lineNumber="2902"></CodeLine>
<Link id="l02903" /><CodeLine lineNumber="2903"><span class="doxyHighlight">  BlockWorkList.clear();</span></CodeLine>
<Link id="l02904" /><CodeLine lineNumber="2904"><span class="doxyHighlight">  EHPadWorkList.clear();</span></CodeLine>
<Link id="l02905" /><CodeLine lineNumber="2905"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02906" /><CodeLine lineNumber="2906"></CodeLine>
<Link id="l02907" /><CodeLine lineNumber="2907"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> MachineBlockPlacement::optimizeBranches() &#123;</span></CodeLine>
<Link id="l02908" /><CodeLine lineNumber="2908"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;FunctionChain = &#42;BlockToChain&#91;&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;front()&#93;;</span></CodeLine>
<Link id="l02909" /><CodeLine lineNumber="2909"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineOperand, 4&gt;</a> <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>;</span></CodeLine>
<Link id="l02910" /><CodeLine lineNumber="2910"></CodeLine>
<Link id="l02911" /><CodeLine lineNumber="2911"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Now that all the basic blocks in the chain have the proper layout,</span></CodeLine>
<Link id="l02912" /><CodeLine lineNumber="2912"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// make a final call to analyzeBranch with AllowModify set.</span></CodeLine>
<Link id="l02913" /><CodeLine lineNumber="2913"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Indeed, the target may be able to optimize the branches in a way we</span></CodeLine>
<Link id="l02914" /><CodeLine lineNumber="2914"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// cannot because all branches may not be analyzable.</span></CodeLine>
<Link id="l02915" /><CodeLine lineNumber="2915"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// E.g., the target may be able to remove an unconditional branch to</span></CodeLine>
<Link id="l02916" /><CodeLine lineNumber="2916"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// a fallthrough when it occurs after predicated terminators.</span></CodeLine>
<Link id="l02917" /><CodeLine lineNumber="2917"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;ChainBB : FunctionChain) &#123;</span></CodeLine>
<Link id="l02918" /><CodeLine lineNumber="2918"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>.clear();</span></CodeLine>
<Link id="l02919" /><CodeLine lineNumber="2919"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a> = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">, &#42;FBB = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02920" /><CodeLine lineNumber="2920"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;analyzeBranch(&#42;ChainBB, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a>, FBB, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, </span><span class="doxyHighlightComment">/&#42;AllowModify&#42;/</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">))</span></CodeLine>
<Link id="l02921" /><CodeLine lineNumber="2921"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02922" /><CodeLine lineNumber="2922"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a> || !FBB || <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>.empty())</span></CodeLine>
<Link id="l02923" /><CodeLine lineNumber="2923"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02924" /><CodeLine lineNumber="2924"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If we are optimizing for size we do not consider the runtime performance.</span></CodeLine>
<Link id="l02925" /><CodeLine lineNumber="2925"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Instead, we retain the original branch condition so we have more uniform</span></CodeLine>
<Link id="l02926" /><CodeLine lineNumber="2926"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// instructions which will benefit ICF.</span></CodeLine>
<Link id="l02927" /><CodeLine lineNumber="2927"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a3af72f14ea20f2c762c751d2d49e5ea3">llvm::shouldOptimizeForSize</a>(ChainBB, PSI, MBFI.get()))</span></CodeLine>
<Link id="l02928" /><CodeLine lineNumber="2928"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02929" /><CodeLine lineNumber="2929"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If ChainBB has a two-way branch, try to re-order the branches</span></CodeLine>
<Link id="l02930" /><CodeLine lineNumber="2930"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// such that we branch to the successor with higher probability first.</span></CodeLine>
<Link id="l02931" /><CodeLine lineNumber="2931"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (MBPI-&gt;getEdgeProbability(ChainBB, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a>) &gt;=</span></CodeLine>
<Link id="l02932" /><CodeLine lineNumber="2932"><span class="doxyHighlight">        MBPI-&gt;getEdgeProbability(ChainBB, FBB))</span></CodeLine>
<Link id="l02933" /><CodeLine lineNumber="2933"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02934" /><CodeLine lineNumber="2934"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;reverseBranchCondition(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>))</span></CodeLine>
<Link id="l02935" /><CodeLine lineNumber="2935"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02936" /><CodeLine lineNumber="2936"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Reverse order of the two branches: &quot;</span></CodeLine>
<Link id="l02937" /><CodeLine lineNumber="2937"><span class="doxyHighlight">                      &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(ChainBB) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02938" /><CodeLine lineNumber="2938"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a>) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; &lt; &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(FBB)</span></CodeLine>
<Link id="l02939" /><CodeLine lineNumber="2939"><span class="doxyHighlight">                      &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02940" /><CodeLine lineNumber="2940"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Dl = ChainBB-&gt;findBranchDebugLoc();</span></CodeLine>
<Link id="l02941" /><CodeLine lineNumber="2941"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;removeBranch(&#42;ChainBB);</span></CodeLine>
<Link id="l02942" /><CodeLine lineNumber="2942"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;insertBranch(&#42;ChainBB, FBB, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a>, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, Dl);</span></CodeLine>
<Link id="l02943" /><CodeLine lineNumber="2943"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02944" /><CodeLine lineNumber="2944"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02945" /><CodeLine lineNumber="2945"></CodeLine>
<Link id="l02946" /><CodeLine lineNumber="2946"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> MachineBlockPlacement::alignBlocks() &#123;</span></CodeLine>
<Link id="l02947" /><CodeLine lineNumber="2947"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Walk through the backedges of the function now that we have fully laid out</span></CodeLine>
<Link id="l02948" /><CodeLine lineNumber="2948"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the basic blocks and align the destination of each backedge. We don&#39;t rely</span></CodeLine>
<Link id="l02949" /><CodeLine lineNumber="2949"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// exclusively on the loop info here so that we can align backedges in</span></CodeLine>
<Link id="l02950" /><CodeLine lineNumber="2950"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// unnatural CFGs and backedges that were introduced purely because of the</span></CodeLine>
<Link id="l02951" /><CodeLine lineNumber="2951"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// loop rotations done during this layout pass.</span></CodeLine>
<Link id="l02952" /><CodeLine lineNumber="2952"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="#a1f1e40c7ec4c37b42f76da67c75e638d">AlignAllBlock</a> &amp;&amp; !<a href="#a4dbf76303569b68b0d3719627c88e9fe">AlignAllNonFallThruBlocks</a>) &#123;</span></CodeLine>
<Link id="l02953" /><CodeLine lineNumber="2953"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getFunction().hasMinSize() ||</span></CodeLine>
<Link id="l02954" /><CodeLine lineNumber="2954"><span class="doxyHighlight">        (<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getFunction().hasOptSize() &amp;&amp; !TLI-&gt;alignLoopsWithOptSize()))</span></CodeLine>
<Link id="l02955" /><CodeLine lineNumber="2955"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02956" /><CodeLine lineNumber="2956"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02957" /><CodeLine lineNumber="2957"></CodeLine>
<Link id="l02958" /><CodeLine lineNumber="2958"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;FunctionChain = &#42;BlockToChain&#91;&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;front()&#93;;</span></CodeLine>
<Link id="l02959" /><CodeLine lineNumber="2959"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Empty chain.</span></CodeLine>
<Link id="l02960" /><CodeLine lineNumber="2960"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FunctionChain.begin() == FunctionChain.end())</span></CodeLine>
<Link id="l02961" /><CodeLine lineNumber="2961"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02962" /><CodeLine lineNumber="2962"></CodeLine>
<Link id="l02963" /><CodeLine lineNumber="2963"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> ColdProb(1, 5); </span><span class="doxyHighlightComment">// 20%</span></CodeLine>
<Link id="l02964" /><CodeLine lineNumber="2964"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> EntryFreq = MBFI-&gt;getBlockFreq(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;front());</span></CodeLine>
<Link id="l02965" /><CodeLine lineNumber="2965"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> WeightedEntryFreq = EntryFreq &#42; ColdProb;</span></CodeLine>
<Link id="l02966" /><CodeLine lineNumber="2966"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;ChainBB : FunctionChain) &#123;</span></CodeLine>
<Link id="l02967" /><CodeLine lineNumber="2967"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ChainBB == &#42;FunctionChain.begin())</span></CodeLine>
<Link id="l02968" /><CodeLine lineNumber="2968"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02969" /><CodeLine lineNumber="2969"></CodeLine>
<Link id="l02970" /><CodeLine lineNumber="2970"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Don&#39;t align non-looping basic blocks. These are unlikely to execute</span></CodeLine>
<Link id="l02971" /><CodeLine lineNumber="2971"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// enough times to matter in practice. Note that we&#39;ll still handle</span></CodeLine>
<Link id="l02972" /><CodeLine lineNumber="2972"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// unnatural CFGs inside of a natural outer loop (the common case) and</span></CodeLine>
<Link id="l02973" /><CodeLine lineNumber="2973"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// rotated loops.</span></CodeLine>
<Link id="l02974" /><CodeLine lineNumber="2974"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machineloop">MachineLoop</a> &#42;<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a> = MLI-&gt;getLoopFor(ChainBB);</span></CodeLine>
<Link id="l02975" /><CodeLine lineNumber="2975"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!L)</span></CodeLine>
<Link id="l02976" /><CodeLine lineNumber="2976"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02977" /><CodeLine lineNumber="2977"></CodeLine>
<Link id="l02978" /><CodeLine lineNumber="2978"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/structs/llvm/align">Align</a> TLIAlign = TLI-&gt;getPrefLoopAlignment(L);</span></CodeLine>
<Link id="l02979" /><CodeLine lineNumber="2979"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> MDAlign = 1;</span></CodeLine>
<Link id="l02980" /><CodeLine lineNumber="2980"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42;LoopID = <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;getLoopID();</span></CodeLine>
<Link id="l02981" /><CodeLine lineNumber="2981"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LoopID) &#123;</span></CodeLine>
<Link id="l02982" /><CodeLine lineNumber="2982"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/mdoperand">MDOperand</a> &amp;MDO : <a href="/docs/api/namespaces/llvm/#a02981de53fb6ffd384d39addc4d25f37">llvm::drop&#95;begin</a>(LoopID-&gt;<a href="/docs/api/classes/llvm/mdnode/#a571612461ea4af620bc4c441d61579a3">operands</a>())) &#123;</span></CodeLine>
<Link id="l02983" /><CodeLine lineNumber="2983"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42;MD = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;MDNode&gt;</a>(MDO);</span></CodeLine>
<Link id="l02984" /><CodeLine lineNumber="2984"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (MD == </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l02985" /><CodeLine lineNumber="2985"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02986" /><CodeLine lineNumber="2986"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/mdstring">MDString</a> &#42;S = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;MDString&gt;</a>(MD-&gt;<a href="/docs/api/classes/llvm/mdnode/#a42409838a49255a3770da1469872f20b">getOperand</a>(0));</span></CodeLine>
<Link id="l02987" /><CodeLine lineNumber="2987"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (S == </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l02988" /><CodeLine lineNumber="2988"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02989" /><CodeLine lineNumber="2989"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (S-&gt;<a href="/docs/api/classes/llvm/mdstring/#ae44259d9edd71181ea8b89d18f27a967">getString</a>() == </span><span class="doxyHighlightStringLiteral">&quot;llvm.loop.align&quot;</span><span class="doxyHighlight">) &#123;</span></CodeLine>
<Link id="l02990" /><CodeLine lineNumber="2990"><span class="doxyHighlight">          <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(MD-&gt;<a href="/docs/api/classes/llvm/mdnode/#aa4068e37ec583962685e3567dc102ae5">getNumOperands</a>() == 2 &amp;&amp;</span></CodeLine>
<Link id="l02991" /><CodeLine lineNumber="2991"><span class="doxyHighlight">                 </span><span class="doxyHighlightStringLiteral">&quot;per-loop align metadata should have two operands.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02992" /><CodeLine lineNumber="2992"><span class="doxyHighlight">          MDAlign =</span></CodeLine>
<Link id="l02993" /><CodeLine lineNumber="2993"><span class="doxyHighlight">              <a href="/docs/api/namespaces/llvm/mdconst/#ad938857d6c6603847adf3a8cbe403d17">mdconst::extract&lt;ConstantInt&gt;</a>(MD-&gt;<a href="/docs/api/classes/llvm/mdnode/#a42409838a49255a3770da1469872f20b">getOperand</a>(1))-&gt;getZExtValue();</span></CodeLine>
<Link id="l02994" /><CodeLine lineNumber="2994"><span class="doxyHighlight">          <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(MDAlign &gt;= 1 &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;per-loop align value must be positive.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02995" /><CodeLine lineNumber="2995"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l02996" /><CodeLine lineNumber="2996"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l02997" /><CodeLine lineNumber="2997"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02998" /><CodeLine lineNumber="2998"></CodeLine>
<Link id="l02999" /><CodeLine lineNumber="2999"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Use max of the TLIAlign and MDAlign</span></CodeLine>
<Link id="l03000" /><CodeLine lineNumber="3000"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/structs/llvm/align">Align</a> LoopAlign = std::max(TLIAlign, <a href="/docs/api/structs/llvm/align">Align</a>(MDAlign));</span></CodeLine>
<Link id="l03001" /><CodeLine lineNumber="3001"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LoopAlign == 1)</span></CodeLine>
<Link id="l03002" /><CodeLine lineNumber="3002"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">; </span><span class="doxyHighlightComment">// Don&#39;t care about loop alignment.</span></CodeLine>
<Link id="l03003" /><CodeLine lineNumber="3003"></CodeLine>
<Link id="l03004" /><CodeLine lineNumber="3004"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If the block is cold relative to the function entry don&#39;t waste space</span></CodeLine>
<Link id="l03005" /><CodeLine lineNumber="3005"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// aligning it.</span></CodeLine>
<Link id="l03006" /><CodeLine lineNumber="3006"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> Freq = MBFI-&gt;getBlockFreq(ChainBB);</span></CodeLine>
<Link id="l03007" /><CodeLine lineNumber="3007"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Freq &lt; WeightedEntryFreq)</span></CodeLine>
<Link id="l03008" /><CodeLine lineNumber="3008"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03009" /><CodeLine lineNumber="3009"></CodeLine>
<Link id="l03010" /><CodeLine lineNumber="3010"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If the block is cold relative to its loop header, don&#39;t align it</span></CodeLine>
<Link id="l03011" /><CodeLine lineNumber="3011"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// regardless of what edges into the block exist.</span></CodeLine>
<Link id="l03012" /><CodeLine lineNumber="3012"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;LoopHeader = <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;getHeader();</span></CodeLine>
<Link id="l03013" /><CodeLine lineNumber="3013"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> LoopHeaderFreq = MBFI-&gt;getBlockFreq(LoopHeader);</span></CodeLine>
<Link id="l03014" /><CodeLine lineNumber="3014"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Freq &lt; (LoopHeaderFreq &#42; ColdProb))</span></CodeLine>
<Link id="l03015" /><CodeLine lineNumber="3015"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03016" /><CodeLine lineNumber="3016"></CodeLine>
<Link id="l03017" /><CodeLine lineNumber="3017"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If the global profiles indicates so, don&#39;t align it.</span></CodeLine>
<Link id="l03018" /><CodeLine lineNumber="3018"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a3af72f14ea20f2c762c751d2d49e5ea3">llvm::shouldOptimizeForSize</a>(ChainBB, PSI, MBFI.get()) &amp;&amp;</span></CodeLine>
<Link id="l03019" /><CodeLine lineNumber="3019"><span class="doxyHighlight">        !TLI-&gt;alignLoopsWithOptSize())</span></CodeLine>
<Link id="l03020" /><CodeLine lineNumber="3020"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03021" /><CodeLine lineNumber="3021"></CodeLine>
<Link id="l03022" /><CodeLine lineNumber="3022"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Check for the existence of a non-layout predecessor which would benefit</span></CodeLine>
<Link id="l03023" /><CodeLine lineNumber="3023"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// from aligning this block.</span></CodeLine>
<Link id="l03024" /><CodeLine lineNumber="3024"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;LayoutPred =</span></CodeLine>
<Link id="l03025" /><CodeLine lineNumber="3025"><span class="doxyHighlight">        &amp;&#42;std::prev(<a href="/docs/api/classes/llvm/machinefunction/#aaba82c71ffdca966cad10eae0992fff9">MachineFunction::iterator</a>(ChainBB));</span></CodeLine>
<Link id="l03026" /><CodeLine lineNumber="3026"></CodeLine>
<Link id="l03027" /><CodeLine lineNumber="3027"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> DetermineMaxAlignmentPadding = &#91;&amp;&#93;() &#123;</span></CodeLine>
<Link id="l03028" /><CodeLine lineNumber="3028"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Set the maximum bytes allowed to be emitted for alignment.</span></CodeLine>
<Link id="l03029" /><CodeLine lineNumber="3029"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> MaxBytes;</span></CodeLine>
<Link id="l03030" /><CodeLine lineNumber="3030"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a7713277c884a7bf39711c1c0d6cf9c26">MaxBytesForAlignmentOverride</a>.getNumOccurrences() &gt; 0)</span></CodeLine>
<Link id="l03031" /><CodeLine lineNumber="3031"><span class="doxyHighlight">        MaxBytes = <a href="#a7713277c884a7bf39711c1c0d6cf9c26">MaxBytesForAlignmentOverride</a>;</span></CodeLine>
<Link id="l03032" /><CodeLine lineNumber="3032"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l03033" /><CodeLine lineNumber="3033"><span class="doxyHighlight">        MaxBytes = TLI-&gt;getMaxPermittedBytesForAlignment(ChainBB);</span></CodeLine>
<Link id="l03034" /><CodeLine lineNumber="3034"><span class="doxyHighlight">      ChainBB-&gt;setMaxBytesForAlignment(MaxBytes);</span></CodeLine>
<Link id="l03035" /><CodeLine lineNumber="3035"><span class="doxyHighlight">    &#125;;</span></CodeLine>
<Link id="l03036" /><CodeLine lineNumber="3036"></CodeLine>
<Link id="l03037" /><CodeLine lineNumber="3037"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Force alignment if all the predecessors are jumps. We already checked</span></CodeLine>
<Link id="l03038" /><CodeLine lineNumber="3038"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// that the block isn&#39;t cold above.</span></CodeLine>
<Link id="l03039" /><CodeLine lineNumber="3039"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!LayoutPred-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#adc8f1be4a77ae671ac139d5f06b44deb">isSuccessor</a>(ChainBB)) &#123;</span></CodeLine>
<Link id="l03040" /><CodeLine lineNumber="3040"><span class="doxyHighlight">      ChainBB-&gt;setAlignment(LoopAlign);</span></CodeLine>
<Link id="l03041" /><CodeLine lineNumber="3041"><span class="doxyHighlight">      DetermineMaxAlignmentPadding();</span></CodeLine>
<Link id="l03042" /><CodeLine lineNumber="3042"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03043" /><CodeLine lineNumber="3043"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03044" /><CodeLine lineNumber="3044"></CodeLine>
<Link id="l03045" /><CodeLine lineNumber="3045"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Align this block if the layout predecessor&#39;s edge into this block is</span></CodeLine>
<Link id="l03046" /><CodeLine lineNumber="3046"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// cold relative to the block. When this is true, other predecessors make up</span></CodeLine>
<Link id="l03047" /><CodeLine lineNumber="3047"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// all of the hot entries into the block and thus alignment is likely to be</span></CodeLine>
<Link id="l03048" /><CodeLine lineNumber="3048"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// important.</span></CodeLine>
<Link id="l03049" /><CodeLine lineNumber="3049"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> LayoutProb =</span></CodeLine>
<Link id="l03050" /><CodeLine lineNumber="3050"><span class="doxyHighlight">        MBPI-&gt;getEdgeProbability(LayoutPred, ChainBB);</span></CodeLine>
<Link id="l03051" /><CodeLine lineNumber="3051"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> LayoutEdgeFreq = MBFI-&gt;getBlockFreq(LayoutPred) &#42; LayoutProb;</span></CodeLine>
<Link id="l03052" /><CodeLine lineNumber="3052"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LayoutEdgeFreq &lt;= (Freq &#42; ColdProb)) &#123;</span></CodeLine>
<Link id="l03053" /><CodeLine lineNumber="3053"><span class="doxyHighlight">      ChainBB-&gt;setAlignment(LoopAlign);</span></CodeLine>
<Link id="l03054" /><CodeLine lineNumber="3054"><span class="doxyHighlight">      DetermineMaxAlignmentPadding();</span></CodeLine>
<Link id="l03055" /><CodeLine lineNumber="3055"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03056" /><CodeLine lineNumber="3056"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03057" /><CodeLine lineNumber="3057"></CodeLine>
<Link id="l03058" /><CodeLine lineNumber="3058"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> HasMaxBytesOverride =</span></CodeLine>
<Link id="l03059" /><CodeLine lineNumber="3059"><span class="doxyHighlight">      <a href="#a7713277c884a7bf39711c1c0d6cf9c26">MaxBytesForAlignmentOverride</a>.getNumOccurrences() &gt; 0;</span></CodeLine>
<Link id="l03060" /><CodeLine lineNumber="3060"></CodeLine>
<Link id="l03061" /><CodeLine lineNumber="3061"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a1f1e40c7ec4c37b42f76da67c75e638d">AlignAllBlock</a>)</span></CodeLine>
<Link id="l03062" /><CodeLine lineNumber="3062"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Align all of the blocks in the function to a specific alignment.</span></CodeLine>
<Link id="l03063" /><CodeLine lineNumber="3063"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l03064" /><CodeLine lineNumber="3064"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (HasMaxBytesOverride)</span></CodeLine>
<Link id="l03065" /><CodeLine lineNumber="3065"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.setAlignment(<a href="/docs/api/structs/llvm/align">Align</a>(1ULL &lt;&lt; <a href="#a1f1e40c7ec4c37b42f76da67c75e638d">AlignAllBlock</a>),</span></CodeLine>
<Link id="l03066" /><CodeLine lineNumber="3066"><span class="doxyHighlight">                         <a href="#a7713277c884a7bf39711c1c0d6cf9c26">MaxBytesForAlignmentOverride</a>);</span></CodeLine>
<Link id="l03067" /><CodeLine lineNumber="3067"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l03068" /><CodeLine lineNumber="3068"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.setAlignment(<a href="/docs/api/structs/llvm/align">Align</a>(1ULL &lt;&lt; <a href="#a1f1e40c7ec4c37b42f76da67c75e638d">AlignAllBlock</a>));</span></CodeLine>
<Link id="l03069" /><CodeLine lineNumber="3069"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03070" /><CodeLine lineNumber="3070"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a4dbf76303569b68b0d3719627c88e9fe">AlignAllNonFallThruBlocks</a>) &#123;</span></CodeLine>
<Link id="l03071" /><CodeLine lineNumber="3071"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Align all of the blocks that have no fall-through predecessors to a</span></CodeLine>
<Link id="l03072" /><CodeLine lineNumber="3072"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// specific alignment.</span></CodeLine>
<Link id="l03073" /><CodeLine lineNumber="3073"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> MBI = std::next(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;begin()), MBE = <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;end(); MBI != MBE; ++MBI) &#123;</span></CodeLine>
<Link id="l03074" /><CodeLine lineNumber="3074"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> LayoutPred = std::prev(MBI);</span></CodeLine>
<Link id="l03075" /><CodeLine lineNumber="3075"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!LayoutPred-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#adc8f1be4a77ae671ac139d5f06b44deb">isSuccessor</a>(&amp;&#42;MBI)) &#123;</span></CodeLine>
<Link id="l03076" /><CodeLine lineNumber="3076"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (HasMaxBytesOverride)</span></CodeLine>
<Link id="l03077" /><CodeLine lineNumber="3077"><span class="doxyHighlight">          MBI-&gt;setAlignment(<a href="/docs/api/structs/llvm/align">Align</a>(1ULL &lt;&lt; <a href="#a4dbf76303569b68b0d3719627c88e9fe">AlignAllNonFallThruBlocks</a>),</span></CodeLine>
<Link id="l03078" /><CodeLine lineNumber="3078"><span class="doxyHighlight">                            <a href="#a7713277c884a7bf39711c1c0d6cf9c26">MaxBytesForAlignmentOverride</a>);</span></CodeLine>
<Link id="l03079" /><CodeLine lineNumber="3079"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l03080" /><CodeLine lineNumber="3080"><span class="doxyHighlight">          MBI-&gt;setAlignment(<a href="/docs/api/structs/llvm/align">Align</a>(1ULL &lt;&lt; <a href="#a4dbf76303569b68b0d3719627c88e9fe">AlignAllNonFallThruBlocks</a>));</span></CodeLine>
<Link id="l03081" /><CodeLine lineNumber="3081"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l03082" /><CodeLine lineNumber="3082"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03083" /><CodeLine lineNumber="3083"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03084" /><CodeLine lineNumber="3084"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l03085" /><CodeLine lineNumber="3085"></CodeLine>
<Link id="l03086" /><CodeLine lineNumber="3086"><span class="doxyHighlightComment">/// Tail duplicate \\p BB into (some) predecessors if profitable, repeating if</span></CodeLine>
<Link id="l03087" /><CodeLine lineNumber="3087"><span class="doxyHighlightComment">/// it was duplicated into its chain predecessor and removed.</span></CodeLine>
<Link id="l03088" /><CodeLine lineNumber="3088"><span class="doxyHighlightComment">/// \\p BB    - Basic block that may be duplicated.</span></CodeLine>
<Link id="l03089" /><CodeLine lineNumber="3089"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l03090" /><CodeLine lineNumber="3090"><span class="doxyHighlightComment">/// \\p LPred - Chosen layout predecessor of \\p BB.</span></CodeLine>
<Link id="l03091" /><CodeLine lineNumber="3091"><span class="doxyHighlightComment">///            Updated to be the chain end if LPred is removed.</span></CodeLine>
<Link id="l03092" /><CodeLine lineNumber="3092"><span class="doxyHighlightComment">/// \\p Chain - Chain to which \\p LPred belongs, and \\p BB will belong.</span></CodeLine>
<Link id="l03093" /><CodeLine lineNumber="3093"><span class="doxyHighlightComment">/// \\p BlockFilter - Set of blocks that belong to the loop being laid out.</span></CodeLine>
<Link id="l03094" /><CodeLine lineNumber="3094"><span class="doxyHighlightComment">///                  Used to identify which blocks to update predecessor</span></CodeLine>
<Link id="l03095" /><CodeLine lineNumber="3095"><span class="doxyHighlightComment">///                  counts.</span></CodeLine>
<Link id="l03096" /><CodeLine lineNumber="3096"><span class="doxyHighlightComment">/// \\p PrevUnplacedBlockIt - Iterator pointing to the last block that was</span></CodeLine>
<Link id="l03097" /><CodeLine lineNumber="3097"><span class="doxyHighlightComment">///                          chosen in the given order due to unnatural CFG</span></CodeLine>
<Link id="l03098" /><CodeLine lineNumber="3098"><span class="doxyHighlightComment">///                          only needed if \\p BB is removed and</span></CodeLine>
<Link id="l03099" /><CodeLine lineNumber="3099"><span class="doxyHighlightComment">///                          \\p PrevUnplacedBlockIt pointed to \\p BB.</span></CodeLine>
<Link id="l03100" /><CodeLine lineNumber="3100"><span class="doxyHighlightComment">/// @return true if \\p BB was removed.</span></CodeLine>
<Link id="l03101" /><CodeLine lineNumber="3101"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> MachineBlockPlacement::repeatedlyTailDuplicateBlock(</span></CodeLine>
<Link id="l03102" /><CodeLine lineNumber="3102"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB, <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;&amp;LPred,</span></CodeLine>
<Link id="l03103" /><CodeLine lineNumber="3103"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;LoopHeaderBB, <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;Chain,</span></CodeLine>
<Link id="l03104" /><CodeLine lineNumber="3104"><span class="doxyHighlight">    BlockFilterSet &#42;BlockFilter, <a href="/docs/api/classes/llvm/machinefunction/#aaba82c71ffdca966cad10eae0992fff9">MachineFunction::iterator</a> &amp;PrevUnplacedBlockIt,</span></CodeLine>
<Link id="l03105" /><CodeLine lineNumber="3105"><span class="doxyHighlight">    BlockFilterSet::iterator &amp;PrevUnplacedBlockInFilterIt) &#123;</span></CodeLine>
<Link id="l03106" /><CodeLine lineNumber="3106"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> Removed, DuplicatedToLPred;</span></CodeLine>
<Link id="l03107" /><CodeLine lineNumber="3107"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> DuplicatedToOriginalLPred;</span></CodeLine>
<Link id="l03108" /><CodeLine lineNumber="3108"><span class="doxyHighlight">  Removed = maybeTailDuplicateBlock(</span></CodeLine>
<Link id="l03109" /><CodeLine lineNumber="3109"><span class="doxyHighlight">      BB, LPred, Chain, BlockFilter, PrevUnplacedBlockIt,</span></CodeLine>
<Link id="l03110" /><CodeLine lineNumber="3110"><span class="doxyHighlight">      PrevUnplacedBlockInFilterIt, DuplicatedToLPred);</span></CodeLine>
<Link id="l03111" /><CodeLine lineNumber="3111"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Removed)</span></CodeLine>
<Link id="l03112" /><CodeLine lineNumber="3112"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03113" /><CodeLine lineNumber="3113"><span class="doxyHighlight">  DuplicatedToOriginalLPred = DuplicatedToLPred;</span></CodeLine>
<Link id="l03114" /><CodeLine lineNumber="3114"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Iteratively try to duplicate again. It can happen that a block that is</span></CodeLine>
<Link id="l03115" /><CodeLine lineNumber="3115"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// duplicated into is still small enough to be duplicated again.</span></CodeLine>
<Link id="l03116" /><CodeLine lineNumber="3116"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// No need to call markBlockSuccessors in this case, as the blocks being</span></CodeLine>
<Link id="l03117" /><CodeLine lineNumber="3117"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// duplicated from here on are already scheduled.</span></CodeLine>
<Link id="l03118" /><CodeLine lineNumber="3118"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">while</span><span class="doxyHighlight"> (DuplicatedToLPred &amp;&amp; Removed) &#123;</span></CodeLine>
<Link id="l03119" /><CodeLine lineNumber="3119"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;DupBB, &#42;DupPred;</span></CodeLine>
<Link id="l03120" /><CodeLine lineNumber="3120"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// The removal callback causes Chain.end() to be updated when a block is</span></CodeLine>
<Link id="l03121" /><CodeLine lineNumber="3121"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// removed. On the first pass through the loop, the chain end should be the</span></CodeLine>
<Link id="l03122" /><CodeLine lineNumber="3122"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// same as it was on function entry. On subsequent passes, because we are</span></CodeLine>
<Link id="l03123" /><CodeLine lineNumber="3123"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// duplicating the block at the end of the chain, if it is removed the</span></CodeLine>
<Link id="l03124" /><CodeLine lineNumber="3124"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// chain will have shrunk by one block.</span></CodeLine>
<Link id="l03125" /><CodeLine lineNumber="3125"><span class="doxyHighlight">    <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#aac2485344159ae07cfd3aa75113f50f5">BlockChain::iterator</a> ChainEnd = <a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a075e34e98605d0e7c289763a104869ac">end</a>();</span></CodeLine>
<Link id="l03126" /><CodeLine lineNumber="3126"><span class="doxyHighlight">    DupBB = &#42;(--ChainEnd);</span></CodeLine>
<Link id="l03127" /><CodeLine lineNumber="3127"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Now try to duplicate again.</span></CodeLine>
<Link id="l03128" /><CodeLine lineNumber="3128"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ChainEnd == <a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a8a045d250952c0867382a9840ee18fdf">begin</a>())</span></CodeLine>
<Link id="l03129" /><CodeLine lineNumber="3129"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03130" /><CodeLine lineNumber="3130"><span class="doxyHighlight">    DupPred = &#42;std::prev(ChainEnd);</span></CodeLine>
<Link id="l03131" /><CodeLine lineNumber="3131"><span class="doxyHighlight">    Removed = maybeTailDuplicateBlock(</span></CodeLine>
<Link id="l03132" /><CodeLine lineNumber="3132"><span class="doxyHighlight">        DupBB, DupPred, Chain, BlockFilter, PrevUnplacedBlockIt,</span></CodeLine>
<Link id="l03133" /><CodeLine lineNumber="3133"><span class="doxyHighlight">        PrevUnplacedBlockInFilterIt, DuplicatedToLPred);</span></CodeLine>
<Link id="l03134" /><CodeLine lineNumber="3134"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03135" /><CodeLine lineNumber="3135"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If BB was duplicated into LPred, it is now scheduled. But because it was</span></CodeLine>
<Link id="l03136" /><CodeLine lineNumber="3136"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// removed, markChainSuccessors won&#39;t be called for its chain. Instead we</span></CodeLine>
<Link id="l03137" /><CodeLine lineNumber="3137"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// call markBlockSuccessors for LPred to achieve the same effect. This must go</span></CodeLine>
<Link id="l03138" /><CodeLine lineNumber="3138"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// at the end because repeating the tail duplication can increase the number</span></CodeLine>
<Link id="l03139" /><CodeLine lineNumber="3139"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// of unscheduled predecessors.</span></CodeLine>
<Link id="l03140" /><CodeLine lineNumber="3140"><span class="doxyHighlight">  LPred = &#42;std::prev(<a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a075e34e98605d0e7c289763a104869ac">end</a>());</span></CodeLine>
<Link id="l03141" /><CodeLine lineNumber="3141"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (DuplicatedToOriginalLPred)</span></CodeLine>
<Link id="l03142" /><CodeLine lineNumber="3142"><span class="doxyHighlight">    markBlockSuccessors(Chain, LPred, LoopHeaderBB, BlockFilter);</span></CodeLine>
<Link id="l03143" /><CodeLine lineNumber="3143"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03144" /><CodeLine lineNumber="3144"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l03145" /><CodeLine lineNumber="3145"></CodeLine>
<Link id="l03146" /><CodeLine lineNumber="3146"><span class="doxyHighlightComment">/// Tail duplicate \\p BB into (some) predecessors if profitable.</span></CodeLine>
<Link id="l03147" /><CodeLine lineNumber="3147"><span class="doxyHighlightComment">/// \\p BB    - Basic block that may be duplicated</span></CodeLine>
<Link id="l03148" /><CodeLine lineNumber="3148"><span class="doxyHighlightComment">/// \\p LPred - Chosen layout predecessor of \\p BB</span></CodeLine>
<Link id="l03149" /><CodeLine lineNumber="3149"><span class="doxyHighlightComment">/// \\p Chain - Chain to which \\p LPred belongs, and \\p BB will belong.</span></CodeLine>
<Link id="l03150" /><CodeLine lineNumber="3150"><span class="doxyHighlightComment">/// \\p BlockFilter - Set of blocks that belong to the loop being laid out.</span></CodeLine>
<Link id="l03151" /><CodeLine lineNumber="3151"><span class="doxyHighlightComment">///                  Used to identify which blocks to update predecessor</span></CodeLine>
<Link id="l03152" /><CodeLine lineNumber="3152"><span class="doxyHighlightComment">///                  counts.</span></CodeLine>
<Link id="l03153" /><CodeLine lineNumber="3153"><span class="doxyHighlightComment">/// \\p PrevUnplacedBlockIt - Iterator pointing to the last block that was</span></CodeLine>
<Link id="l03154" /><CodeLine lineNumber="3154"><span class="doxyHighlightComment">///                          chosen in the given order due to unnatural CFG</span></CodeLine>
<Link id="l03155" /><CodeLine lineNumber="3155"><span class="doxyHighlightComment">///                          only needed if \\p BB is removed and</span></CodeLine>
<Link id="l03156" /><CodeLine lineNumber="3156"><span class="doxyHighlightComment">///                          \\p PrevUnplacedBlockIt pointed to \\p BB.</span></CodeLine>
<Link id="l03157" /><CodeLine lineNumber="3157"><span class="doxyHighlightComment">/// \\p DuplicatedToLPred - True if the block was duplicated into LPred.</span></CodeLine>
<Link id="l03158" /><CodeLine lineNumber="3158"><span class="doxyHighlightComment">/// \\return  - True if the block was duplicated into all preds and removed.</span></CodeLine>
<Link id="l03159" /><CodeLine lineNumber="3159"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> MachineBlockPlacement::maybeTailDuplicateBlock(</span></CodeLine>
<Link id="l03160" /><CodeLine lineNumber="3160"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB, <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;LPred, <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &amp;Chain,</span></CodeLine>
<Link id="l03161" /><CodeLine lineNumber="3161"><span class="doxyHighlight">    BlockFilterSet &#42;BlockFilter, <a href="/docs/api/classes/llvm/machinefunction/#aaba82c71ffdca966cad10eae0992fff9">MachineFunction::iterator</a> &amp;PrevUnplacedBlockIt,</span></CodeLine>
<Link id="l03162" /><CodeLine lineNumber="3162"><span class="doxyHighlight">    BlockFilterSet::iterator &amp;PrevUnplacedBlockInFilterIt,</span></CodeLine>
<Link id="l03163" /><CodeLine lineNumber="3163"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> &amp;DuplicatedToLPred) &#123;</span></CodeLine>
<Link id="l03164" /><CodeLine lineNumber="3164"><span class="doxyHighlight">  DuplicatedToLPred = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03165" /><CodeLine lineNumber="3165"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!shouldTailDuplicate(BB))</span></CodeLine>
<Link id="l03166" /><CodeLine lineNumber="3166"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03167" /><CodeLine lineNumber="3167"></CodeLine>
<Link id="l03168" /><CodeLine lineNumber="3168"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Redoing tail duplication for Succ#&quot;</span><span class="doxyHighlight"> &lt;&lt; BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a3aa22d521bd6a7e6b9f35545dc7b0f1e">getNumber</a>()</span></CodeLine>
<Link id="l03169" /><CodeLine lineNumber="3169"><span class="doxyHighlight">                    &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l03170" /><CodeLine lineNumber="3170"></CodeLine>
<Link id="l03171" /><CodeLine lineNumber="3171"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// This has to be a callback because none of it can be done after</span></CodeLine>
<Link id="l03172" /><CodeLine lineNumber="3172"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// BB is deleted.</span></CodeLine>
<Link id="l03173" /><CodeLine lineNumber="3173"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> Removed = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03174" /><CodeLine lineNumber="3174"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> RemovalCallback = &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;RemBB) &#123;</span></CodeLine>
<Link id="l03175" /><CodeLine lineNumber="3175"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Signal to outer function</span></CodeLine>
<Link id="l03176" /><CodeLine lineNumber="3176"><span class="doxyHighlight">    Removed = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03177" /><CodeLine lineNumber="3177"></CodeLine>
<Link id="l03178" /><CodeLine lineNumber="3178"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Conservative default.</span></CodeLine>
<Link id="l03179" /><CodeLine lineNumber="3179"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> InWorkList = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03180" /><CodeLine lineNumber="3180"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Remove from the Chain and Chain Map</span></CodeLine>
<Link id="l03181" /><CodeLine lineNumber="3181"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> It = BlockToChain.find(RemBB); It != BlockToChain.end()) &#123;</span></CodeLine>
<Link id="l03182" /><CodeLine lineNumber="3182"><span class="doxyHighlight">      <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;<a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a> = It-&gt;second;</span></CodeLine>
<Link id="l03183" /><CodeLine lineNumber="3183"><span class="doxyHighlight">      InWorkList = <a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>-&gt;UnscheduledPredecessors == 0;</span></CodeLine>
<Link id="l03184" /><CodeLine lineNumber="3184"><span class="doxyHighlight">      <a href="/docs/api/namespaces/anonymous-loadstorevectorizer-cpp-/#afd1adfcbfce320e6265935ce4d6299a3">Chain</a>-&gt;remove(RemBB);</span></CodeLine>
<Link id="l03185" /><CodeLine lineNumber="3185"><span class="doxyHighlight">      BlockToChain.<a href="/docs/api/classes/llvm/smallvectorimpl/#a563ffc2ff61c499b3be2e00100cb72fa">erase</a>(It);</span></CodeLine>
<Link id="l03186" /><CodeLine lineNumber="3186"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03187" /><CodeLine lineNumber="3187"></CodeLine>
<Link id="l03188" /><CodeLine lineNumber="3188"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Handle the unplaced block iterator</span></CodeLine>
<Link id="l03189" /><CodeLine lineNumber="3189"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (&amp;(&#42;PrevUnplacedBlockIt) == RemBB) &#123;</span></CodeLine>
<Link id="l03190" /><CodeLine lineNumber="3190"><span class="doxyHighlight">      PrevUnplacedBlockIt++;</span></CodeLine>
<Link id="l03191" /><CodeLine lineNumber="3191"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03192" /><CodeLine lineNumber="3192"></CodeLine>
<Link id="l03193" /><CodeLine lineNumber="3193"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Handle the Work Lists</span></CodeLine>
<Link id="l03194" /><CodeLine lineNumber="3194"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (InWorkList) &#123;</span></CodeLine>
<Link id="l03195" /><CodeLine lineNumber="3195"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;MachineBasicBlock &#42;&gt;</a> &amp;RemoveList = BlockWorkList;</span></CodeLine>
<Link id="l03196" /><CodeLine lineNumber="3196"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (RemBB-&gt;isEHPad())</span></CodeLine>
<Link id="l03197" /><CodeLine lineNumber="3197"><span class="doxyHighlight">        RemoveList = EHPadWorkList;</span></CodeLine>
<Link id="l03198" /><CodeLine lineNumber="3198"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#a60a348350395aef11d68f58111bcf499">llvm::erase</a>(RemoveList, RemBB);</span></CodeLine>
<Link id="l03199" /><CodeLine lineNumber="3199"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03200" /><CodeLine lineNumber="3200"></CodeLine>
<Link id="l03201" /><CodeLine lineNumber="3201"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Handle the filter set</span></CodeLine>
<Link id="l03202" /><CodeLine lineNumber="3202"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BlockFilter) &#123;</span></CodeLine>
<Link id="l03203" /><CodeLine lineNumber="3203"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> It = <a href="/docs/api/namespaces/llvm/#a086e9fbdb06276db7753101a08a63adf">llvm::find</a>(&#42;BlockFilter, RemBB);</span></CodeLine>
<Link id="l03204" /><CodeLine lineNumber="3204"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Erase RemBB from BlockFilter, and keep PrevUnplacedBlockInFilterIt</span></CodeLine>
<Link id="l03205" /><CodeLine lineNumber="3205"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// pointing to the same element as before.</span></CodeLine>
<Link id="l03206" /><CodeLine lineNumber="3206"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (It != BlockFilter-&gt;end()) &#123;</span></CodeLine>
<Link id="l03207" /><CodeLine lineNumber="3207"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (It &lt; PrevUnplacedBlockInFilterIt) &#123;</span></CodeLine>
<Link id="l03208" /><CodeLine lineNumber="3208"><span class="doxyHighlight">          </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;PrevBB = &#42;PrevUnplacedBlockInFilterIt;</span></CodeLine>
<Link id="l03209" /><CodeLine lineNumber="3209"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// BlockFilter is a SmallVector so all elements after RemBB are</span></CodeLine>
<Link id="l03210" /><CodeLine lineNumber="3210"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// shifted to the front by 1 after its deletion.</span></CodeLine>
<Link id="l03211" /><CodeLine lineNumber="3211"><span class="doxyHighlight">          </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Distance = PrevUnplacedBlockInFilterIt - It - 1;</span></CodeLine>
<Link id="l03212" /><CodeLine lineNumber="3212"><span class="doxyHighlight">          PrevUnplacedBlockInFilterIt = BlockFilter-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#ad26bff839257f220557ce812b2159c72">erase</a>(It) + Distance;</span></CodeLine>
<Link id="l03213" /><CodeLine lineNumber="3213"><span class="doxyHighlight">          <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(&#42;PrevUnplacedBlockInFilterIt == PrevBB);</span></CodeLine>
<Link id="l03214" /><CodeLine lineNumber="3214"><span class="doxyHighlight">          (void)PrevBB;</span></CodeLine>
<Link id="l03215" /><CodeLine lineNumber="3215"><span class="doxyHighlight">        &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (It == PrevUnplacedBlockInFilterIt)</span></CodeLine>
<Link id="l03216" /><CodeLine lineNumber="3216"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// The block pointed by PrevUnplacedBlockInFilterIt is erased, we</span></CodeLine>
<Link id="l03217" /><CodeLine lineNumber="3217"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// have to set it to the next element.</span></CodeLine>
<Link id="l03218" /><CodeLine lineNumber="3218"><span class="doxyHighlight">          PrevUnplacedBlockInFilterIt = BlockFilter-&gt;erase(It);</span></CodeLine>
<Link id="l03219" /><CodeLine lineNumber="3219"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l03220" /><CodeLine lineNumber="3220"><span class="doxyHighlight">          BlockFilter-&gt;erase(It);</span></CodeLine>
<Link id="l03221" /><CodeLine lineNumber="3221"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l03222" /><CodeLine lineNumber="3222"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03223" /><CodeLine lineNumber="3223"></CodeLine>
<Link id="l03224" /><CodeLine lineNumber="3224"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Remove the block from loop info.</span></CodeLine>
<Link id="l03225" /><CodeLine lineNumber="3225"><span class="doxyHighlight">    MLI-&gt;removeBlock(RemBB);</span></CodeLine>
<Link id="l03226" /><CodeLine lineNumber="3226"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (RemBB == PreferredLoopExit)</span></CodeLine>
<Link id="l03227" /><CodeLine lineNumber="3227"><span class="doxyHighlight">      PreferredLoopExit = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03228" /><CodeLine lineNumber="3228"></CodeLine>
<Link id="l03229" /><CodeLine lineNumber="3229"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;TailDuplicator deleted block: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a8f9ee7f9ffc036496a8663335da175fa">getBlockName</a>(RemBB)</span></CodeLine>
<Link id="l03230" /><CodeLine lineNumber="3230"><span class="doxyHighlight">                      &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l03231" /><CodeLine lineNumber="3231"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l03232" /><CodeLine lineNumber="3232"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> RemovalCallbackRef =</span></CodeLine>
<Link id="l03233" /><CodeLine lineNumber="3233"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/function-ref">function&#95;ref&lt;void(MachineBasicBlock &#42;)&gt;</a>(RemovalCallback);</span></CodeLine>
<Link id="l03234" /><CodeLine lineNumber="3234"></CodeLine>
<Link id="l03235" /><CodeLine lineNumber="3235"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineBasicBlock &#42;, 8&gt;</a> DuplicatedPreds;</span></CodeLine>
<Link id="l03236" /><CodeLine lineNumber="3236"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> IsSimple = TailDup.isSimpleBB(BB);</span></CodeLine>
<Link id="l03237" /><CodeLine lineNumber="3237"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineBasicBlock &#42;, 8&gt;</a> CandidatePreds;</span></CodeLine>
<Link id="l03238" /><CodeLine lineNumber="3238"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;MachineBasicBlock &#42;&gt;</a> &#42;CandidatePtr = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03239" /><CodeLine lineNumber="3239"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getFunction().hasProfileData()) &#123;</span></CodeLine>
<Link id="l03240" /><CodeLine lineNumber="3240"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We can do partial duplication with precise profile information.</span></CodeLine>
<Link id="l03241" /><CodeLine lineNumber="3241"><span class="doxyHighlight">    findDuplicateCandidates(CandidatePreds, BB, BlockFilter);</span></CodeLine>
<Link id="l03242" /><CodeLine lineNumber="3242"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CandidatePreds.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() == 0)</span></CodeLine>
<Link id="l03243" /><CodeLine lineNumber="3243"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03244" /><CodeLine lineNumber="3244"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CandidatePreds.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() &lt; BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#a03936a9b37da541420049422204ab206">pred&#95;size</a>())</span></CodeLine>
<Link id="l03245" /><CodeLine lineNumber="3245"><span class="doxyHighlight">      CandidatePtr = &amp;CandidatePreds;</span></CodeLine>
<Link id="l03246" /><CodeLine lineNumber="3246"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03247" /><CodeLine lineNumber="3247"><span class="doxyHighlight">  TailDup.tailDuplicateAndUpdate(IsSimple, BB, LPred, &amp;DuplicatedPreds,</span></CodeLine>
<Link id="l03248" /><CodeLine lineNumber="3248"><span class="doxyHighlight">                                 &amp;RemovalCallbackRef, CandidatePtr);</span></CodeLine>
<Link id="l03249" /><CodeLine lineNumber="3249"></CodeLine>
<Link id="l03250" /><CodeLine lineNumber="3250"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Update UnscheduledPredecessors to reflect tail-duplication.</span></CodeLine>
<Link id="l03251" /><CodeLine lineNumber="3251"><span class="doxyHighlight">  DuplicatedToLPred = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03252" /><CodeLine lineNumber="3252"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Pred : DuplicatedPreds) &#123;</span></CodeLine>
<Link id="l03253" /><CodeLine lineNumber="3253"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We&#39;re only looking for unscheduled predecessors that match the filter.</span></CodeLine>
<Link id="l03254" /><CodeLine lineNumber="3254"><span class="doxyHighlight">    <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;PredChain = BlockToChain&#91;Pred&#93;;</span></CodeLine>
<Link id="l03255" /><CodeLine lineNumber="3255"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Pred == LPred)</span></CodeLine>
<Link id="l03256" /><CodeLine lineNumber="3256"><span class="doxyHighlight">      DuplicatedToLPred = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03257" /><CodeLine lineNumber="3257"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Pred == LPred || (BlockFilter &amp;&amp; !BlockFilter-&gt;count(Pred)) ||</span></CodeLine>
<Link id="l03258" /><CodeLine lineNumber="3258"><span class="doxyHighlight">        PredChain == &amp;Chain)</span></CodeLine>
<Link id="l03259" /><CodeLine lineNumber="3259"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03260" /><CodeLine lineNumber="3260"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;NewSucc : Pred-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#ad88ff1529541fb4e243cc8ed90b11131">successors</a>()) &#123;</span></CodeLine>
<Link id="l03261" /><CodeLine lineNumber="3261"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BlockFilter &amp;&amp; !BlockFilter-&gt;count(NewSucc))</span></CodeLine>
<Link id="l03262" /><CodeLine lineNumber="3262"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03263" /><CodeLine lineNumber="3263"><span class="doxyHighlight">      <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;NewChain = BlockToChain&#91;NewSucc&#93;;</span></CodeLine>
<Link id="l03264" /><CodeLine lineNumber="3264"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NewChain != &amp;Chain &amp;&amp; NewChain != PredChain)</span></CodeLine>
<Link id="l03265" /><CodeLine lineNumber="3265"><span class="doxyHighlight">        NewChain-&gt;UnscheduledPredecessors++;</span></CodeLine>
<Link id="l03266" /><CodeLine lineNumber="3266"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03267" /><CodeLine lineNumber="3267"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03268" /><CodeLine lineNumber="3268"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Removed;</span></CodeLine>
<Link id="l03269" /><CodeLine lineNumber="3269"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l03270" /><CodeLine lineNumber="3270"></CodeLine>
<Link id="l03271" /><CodeLine lineNumber="3271"><span class="doxyHighlightComment">// Count the number of actual machine instructions.</span></CodeLine>
<Link id="l03272" /><CodeLine lineNumber="3272" lineLink="#ac20133598c564acc81e5abadc5a1d637"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> uint64&#95;t <a href="#ac20133598c564acc81e5abadc5a1d637">countMBBInstruction</a>(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>) &#123;</span></CodeLine>
<Link id="l03273" /><CodeLine lineNumber="3273"><span class="doxyHighlight">  uint64&#95;t <a href="/docs/api/files/lib/lib/codegen/dfapacketizer-cpp/#acc16edf21eddec420cd4b27adb3111c6">InstrCount</a> = 0;</span></CodeLine>
<Link id="l03274" /><CodeLine lineNumber="3274"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> : &#42;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>) &#123;</span></CodeLine>
<Link id="l03275" /><CodeLine lineNumber="3275"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isPHI() &amp;&amp; !<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isMetaInstruction())</span></CodeLine>
<Link id="l03276" /><CodeLine lineNumber="3276"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/codegen/dfapacketizer-cpp/#acc16edf21eddec420cd4b27adb3111c6">InstrCount</a> += 1;</span></CodeLine>
<Link id="l03277" /><CodeLine lineNumber="3277"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03278" /><CodeLine lineNumber="3278"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/codegen/dfapacketizer-cpp/#acc16edf21eddec420cd4b27adb3111c6">InstrCount</a>;</span></CodeLine>
<Link id="l03279" /><CodeLine lineNumber="3279"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l03280" /><CodeLine lineNumber="3280"></CodeLine>
<Link id="l03281" /><CodeLine lineNumber="3281"><span class="doxyHighlightComment">// The size cost of duplication is the instruction size of the duplicated block.</span></CodeLine>
<Link id="l03282" /><CodeLine lineNumber="3282"><span class="doxyHighlightComment">// So we should scale the threshold accordingly. But the instruction size is not</span></CodeLine>
<Link id="l03283" /><CodeLine lineNumber="3283"><span class="doxyHighlightComment">// available on all targets, so we use the number of instructions instead.</span></CodeLine>
<Link id="l03284" /><CodeLine lineNumber="3284"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> MachineBlockPlacement::scaleThreshold(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB) &#123;</span></CodeLine>
<Link id="l03285" /><CodeLine lineNumber="3285"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>(DupThreshold.getFrequency() &#42; <a href="#ac20133598c564acc81e5abadc5a1d637">countMBBInstruction</a>(BB));</span></CodeLine>
<Link id="l03286" /><CodeLine lineNumber="3286"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l03287" /><CodeLine lineNumber="3287"></CodeLine>
<Link id="l03288" /><CodeLine lineNumber="3288"><span class="doxyHighlightComment">// Returns true if BB is Pred&#39;s best successor.</span></CodeLine>
<Link id="l03289" /><CodeLine lineNumber="3289"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> MachineBlockPlacement::isBestSuccessor(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB,</span></CodeLine>
<Link id="l03290" /><CodeLine lineNumber="3290"><span class="doxyHighlight">                                            <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Pred,</span></CodeLine>
<Link id="l03291" /><CodeLine lineNumber="3291"><span class="doxyHighlight">                                            BlockFilterSet &#42;BlockFilter) &#123;</span></CodeLine>
<Link id="l03292" /><CodeLine lineNumber="3292"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BB == Pred)</span></CodeLine>
<Link id="l03293" /><CodeLine lineNumber="3293"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03294" /><CodeLine lineNumber="3294"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BlockFilter &amp;&amp; !BlockFilter-&gt;count(Pred))</span></CodeLine>
<Link id="l03295" /><CodeLine lineNumber="3295"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03296" /><CodeLine lineNumber="3296"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;PredChain = BlockToChain&#91;Pred&#93;;</span></CodeLine>
<Link id="l03297" /><CodeLine lineNumber="3297"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (PredChain &amp;&amp; (Pred != &#42;std::prev(PredChain-&gt;end())))</span></CodeLine>
<Link id="l03298" /><CodeLine lineNumber="3298"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03299" /><CodeLine lineNumber="3299"></CodeLine>
<Link id="l03300" /><CodeLine lineNumber="3300"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Find the successor with largest probability excluding BB.</span></CodeLine>
<Link id="l03301" /><CodeLine lineNumber="3301"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> BestProb = <a href="/docs/api/classes/llvm/branchprobability/#afd00958cba7080048a84cccfcef55d71">BranchProbability::getZero</a>();</span></CodeLine>
<Link id="l03302" /><CodeLine lineNumber="3302"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ : Pred-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#ad88ff1529541fb4e243cc8ed90b11131">successors</a>())</span></CodeLine>
<Link id="l03303" /><CodeLine lineNumber="3303"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Succ != BB) &#123;</span></CodeLine>
<Link id="l03304" /><CodeLine lineNumber="3304"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BlockFilter &amp;&amp; !BlockFilter-&gt;count(Succ))</span></CodeLine>
<Link id="l03305" /><CodeLine lineNumber="3305"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03306" /><CodeLine lineNumber="3306"><span class="doxyHighlight">      <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;SuccChain = BlockToChain&#91;Succ&#93;;</span></CodeLine>
<Link id="l03307" /><CodeLine lineNumber="3307"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SuccChain &amp;&amp; (Succ != &#42;SuccChain-&gt;begin()))</span></CodeLine>
<Link id="l03308" /><CodeLine lineNumber="3308"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03309" /><CodeLine lineNumber="3309"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> SuccProb = MBPI-&gt;getEdgeProbability(Pred, Succ);</span></CodeLine>
<Link id="l03310" /><CodeLine lineNumber="3310"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SuccProb &gt; BestProb)</span></CodeLine>
<Link id="l03311" /><CodeLine lineNumber="3311"><span class="doxyHighlight">        BestProb = SuccProb;</span></CodeLine>
<Link id="l03312" /><CodeLine lineNumber="3312"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03313" /><CodeLine lineNumber="3313"></CodeLine>
<Link id="l03314" /><CodeLine lineNumber="3314"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> BBProb = MBPI-&gt;getEdgeProbability(Pred, BB);</span></CodeLine>
<Link id="l03315" /><CodeLine lineNumber="3315"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BBProb &lt;= BestProb)</span></CodeLine>
<Link id="l03316" /><CodeLine lineNumber="3316"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03317" /><CodeLine lineNumber="3317"></CodeLine>
<Link id="l03318" /><CodeLine lineNumber="3318"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Compute the number of reduced taken branches if Pred falls through to BB</span></CodeLine>
<Link id="l03319" /><CodeLine lineNumber="3319"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// instead of another successor. Then compare it with threshold.</span></CodeLine>
<Link id="l03320" /><CodeLine lineNumber="3320"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> PredFreq = getBlockCountOrFrequency(Pred);</span></CodeLine>
<Link id="l03321" /><CodeLine lineNumber="3321"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> Gain = PredFreq &#42; (BBProb - BestProb);</span></CodeLine>
<Link id="l03322" /><CodeLine lineNumber="3322"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Gain &gt; scaleThreshold(BB);</span></CodeLine>
<Link id="l03323" /><CodeLine lineNumber="3323"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l03324" /><CodeLine lineNumber="3324"></CodeLine>
<Link id="l03325" /><CodeLine lineNumber="3325"><span class="doxyHighlightComment">// Find out the predecessors of BB and BB can be beneficially duplicated into</span></CodeLine>
<Link id="l03326" /><CodeLine lineNumber="3326"><span class="doxyHighlightComment">// them.</span></CodeLine>
<Link id="l03327" /><CodeLine lineNumber="3327"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> MachineBlockPlacement::findDuplicateCandidates(</span></CodeLine>
<Link id="l03328" /><CodeLine lineNumber="3328"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;MachineBasicBlock &#42;&gt;</a> &amp;Candidates, <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;BB,</span></CodeLine>
<Link id="l03329" /><CodeLine lineNumber="3329"><span class="doxyHighlight">    BlockFilterSet &#42;BlockFilter) &#123;</span></CodeLine>
<Link id="l03330" /><CodeLine lineNumber="3330"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Fallthrough = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03331" /><CodeLine lineNumber="3331"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> DefaultBranchProb = <a href="/docs/api/classes/llvm/branchprobability/#afd00958cba7080048a84cccfcef55d71">BranchProbability::getZero</a>();</span></CodeLine>
<Link id="l03332" /><CodeLine lineNumber="3332"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> BBDupThreshold(scaleThreshold(BB));</span></CodeLine>
<Link id="l03333" /><CodeLine lineNumber="3333"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineBasicBlock &#42;, 8&gt;</a> Preds(BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#addd80df79ba902914c7d8a52e3896b79">predecessors</a>());</span></CodeLine>
<Link id="l03334" /><CodeLine lineNumber="3334"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineBasicBlock &#42;, 8&gt;</a> Succs(BB-&gt;<a href="/docs/api/classes/llvm/machinebasicblock/#ad88ff1529541fb4e243cc8ed90b11131">successors</a>());</span></CodeLine>
<Link id="l03335" /><CodeLine lineNumber="3335"></CodeLine>
<Link id="l03336" /><CodeLine lineNumber="3336"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Sort for highest frequency.</span></CodeLine>
<Link id="l03337" /><CodeLine lineNumber="3337"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> CmpSucc = &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#a2e38c85003a042421cde1647632d0b72">A</a>, <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>) &#123;</span></CodeLine>
<Link id="l03338" /><CodeLine lineNumber="3338"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> MBPI-&gt;getEdgeProbability(BB, <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#a2e38c85003a042421cde1647632d0b72">A</a>) &gt; MBPI-&gt;getEdgeProbability(BB, <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>);</span></CodeLine>
<Link id="l03339" /><CodeLine lineNumber="3339"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l03340" /><CodeLine lineNumber="3340"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> CmpPred = &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#a2e38c85003a042421cde1647632d0b72">A</a>, <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>) &#123;</span></CodeLine>
<Link id="l03341" /><CodeLine lineNumber="3341"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> MBFI-&gt;getBlockFreq(<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#a2e38c85003a042421cde1647632d0b72">A</a>) &gt; MBFI-&gt;getBlockFreq(<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>);</span></CodeLine>
<Link id="l03342" /><CodeLine lineNumber="3342"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l03343" /><CodeLine lineNumber="3343"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a076f93c387f454f0db13d4bc7d4e7f9c">llvm::stable&#95;sort</a>(Succs, CmpSucc);</span></CodeLine>
<Link id="l03344" /><CodeLine lineNumber="3344"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a076f93c387f454f0db13d4bc7d4e7f9c">llvm::stable&#95;sort</a>(Preds, CmpPred);</span></CodeLine>
<Link id="l03345" /><CodeLine lineNumber="3345"></CodeLine>
<Link id="l03346" /><CodeLine lineNumber="3346"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> SuccIt = Succs.begin();</span></CodeLine>
<Link id="l03347" /><CodeLine lineNumber="3347"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SuccIt != Succs.end()) &#123;</span></CodeLine>
<Link id="l03348" /><CodeLine lineNumber="3348"><span class="doxyHighlight">    DefaultBranchProb = MBPI-&gt;getEdgeProbability(BB, &#42;SuccIt).<a href="/docs/api/classes/llvm/branchprobability/#aaee6034264d5d0782e5d1489360730d9">getCompl</a>();</span></CodeLine>
<Link id="l03349" /><CodeLine lineNumber="3349"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03350" /><CodeLine lineNumber="3350"></CodeLine>
<Link id="l03351" /><CodeLine lineNumber="3351"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For each predecessors of BB, compute the benefit of duplicating BB,</span></CodeLine>
<Link id="l03352" /><CodeLine lineNumber="3352"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// if it is larger than the threshold, add it into Candidates.</span></CodeLine>
<Link id="l03353" /><CodeLine lineNumber="3353"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l03354" /><CodeLine lineNumber="3354"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we have following control flow.</span></CodeLine>
<Link id="l03355" /><CodeLine lineNumber="3355"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l03356" /><CodeLine lineNumber="3356"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     PB1 PB2 PB3 PB4</span></CodeLine>
<Link id="l03357" /><CodeLine lineNumber="3357"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//      \\   |  /    /\\</span></CodeLine>
<Link id="l03358" /><CodeLine lineNumber="3358"><span class="doxyHighlightComment">  //       \\  | /    /  \\</span></CodeLine>
<Link id="l03359" /><CodeLine lineNumber="3359"><span class="doxyHighlightComment">  //        \\ |/    /    \\</span></CodeLine>
<Link id="l03360" /><CodeLine lineNumber="3360"><span class="doxyHighlightComment">  //         BB----/     OB</span></CodeLine>
<Link id="l03361" /><CodeLine lineNumber="3361"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//         /\\</span></CodeLine>
<Link id="l03362" /><CodeLine lineNumber="3362"><span class="doxyHighlightComment">  //        /  \\</span></CodeLine>
<Link id="l03363" /><CodeLine lineNumber="3363"><span class="doxyHighlightComment">  //      SB1 SB2</span></CodeLine>
<Link id="l03364" /><CodeLine lineNumber="3364"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l03365" /><CodeLine lineNumber="3365"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// And it can be partially duplicated as</span></CodeLine>
<Link id="l03366" /><CodeLine lineNumber="3366"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l03367" /><CodeLine lineNumber="3367"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   PB2+BB</span></CodeLine>
<Link id="l03368" /><CodeLine lineNumber="3368"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//      |  PB1 PB3 PB4</span></CodeLine>
<Link id="l03369" /><CodeLine lineNumber="3369"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//      |   |  /    /\\</span></CodeLine>
<Link id="l03370" /><CodeLine lineNumber="3370"><span class="doxyHighlightComment">  //      |   | /    /  \\</span></CodeLine>
<Link id="l03371" /><CodeLine lineNumber="3371"><span class="doxyHighlightComment">  //      |   |/    /    \\</span></CodeLine>
<Link id="l03372" /><CodeLine lineNumber="3372"><span class="doxyHighlightComment">  //      |  BB----/     OB</span></CodeLine>
<Link id="l03373" /><CodeLine lineNumber="3373"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//      |\\ /|</span></CodeLine>
<Link id="l03374" /><CodeLine lineNumber="3374"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//      | X |</span></CodeLine>
<Link id="l03375" /><CodeLine lineNumber="3375"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//      |/ \\|</span></CodeLine>
<Link id="l03376" /><CodeLine lineNumber="3376"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     SB2 SB1</span></CodeLine>
<Link id="l03377" /><CodeLine lineNumber="3377"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l03378" /><CodeLine lineNumber="3378"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The benefit of duplicating into a predecessor is defined as</span></CodeLine>
<Link id="l03379" /><CodeLine lineNumber="3379"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//         Orig&#95;taken&#95;branch - Duplicated&#95;taken&#95;branch</span></CodeLine>
<Link id="l03380" /><CodeLine lineNumber="3380"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l03381" /><CodeLine lineNumber="3381"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The Orig&#95;taken&#95;branch is computed with the assumption that predecessor</span></CodeLine>
<Link id="l03382" /><CodeLine lineNumber="3382"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// jumps to BB and the most possible successor is laid out after BB.</span></CodeLine>
<Link id="l03383" /><CodeLine lineNumber="3383"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l03384" /><CodeLine lineNumber="3384"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The Duplicated&#95;taken&#95;branch is computed with the assumption that BB is</span></CodeLine>
<Link id="l03385" /><CodeLine lineNumber="3385"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// duplicated into PB, and one successor is layout after it (SB1 for PB1 and</span></CodeLine>
<Link id="l03386" /><CodeLine lineNumber="3386"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// SB2 for PB2 in our case). If there is no available successor, the combined</span></CodeLine>
<Link id="l03387" /><CodeLine lineNumber="3387"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// block jumps to all BB&#39;s successor, like PB3 in this example.</span></CodeLine>
<Link id="l03388" /><CodeLine lineNumber="3388"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l03389" /><CodeLine lineNumber="3389"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If a predecessor has multiple successors, so BB can&#39;t be duplicated into</span></CodeLine>
<Link id="l03390" /><CodeLine lineNumber="3390"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// it. But it can beneficially fall through to BB, and duplicate BB into other</span></CodeLine>
<Link id="l03391" /><CodeLine lineNumber="3391"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// predecessors.</span></CodeLine>
<Link id="l03392" /><CodeLine lineNumber="3392"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Pred : Preds) &#123;</span></CodeLine>
<Link id="l03393" /><CodeLine lineNumber="3393"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> PredFreq = getBlockCountOrFrequency(Pred);</span></CodeLine>
<Link id="l03394" /><CodeLine lineNumber="3394"></CodeLine>
<Link id="l03395" /><CodeLine lineNumber="3395"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!TailDup.canTailDuplicate(BB, Pred)) &#123;</span></CodeLine>
<Link id="l03396" /><CodeLine lineNumber="3396"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// BB can&#39;t be duplicated into Pred, but it is possible to be layout</span></CodeLine>
<Link id="l03397" /><CodeLine lineNumber="3397"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// below Pred.</span></CodeLine>
<Link id="l03398" /><CodeLine lineNumber="3398"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Fallthrough &amp;&amp; isBestSuccessor(BB, Pred, BlockFilter)) &#123;</span></CodeLine>
<Link id="l03399" /><CodeLine lineNumber="3399"><span class="doxyHighlight">        Fallthrough = Pred;</span></CodeLine>
<Link id="l03400" /><CodeLine lineNumber="3400"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SuccIt != Succs.end())</span></CodeLine>
<Link id="l03401" /><CodeLine lineNumber="3401"><span class="doxyHighlight">          SuccIt++;</span></CodeLine>
<Link id="l03402" /><CodeLine lineNumber="3402"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l03403" /><CodeLine lineNumber="3403"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03404" /><CodeLine lineNumber="3404"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03405" /><CodeLine lineNumber="3405"></CodeLine>
<Link id="l03406" /><CodeLine lineNumber="3406"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> OrigCost = PredFreq + PredFreq &#42; DefaultBranchProb;</span></CodeLine>
<Link id="l03407" /><CodeLine lineNumber="3407"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> DupCost;</span></CodeLine>
<Link id="l03408" /><CodeLine lineNumber="3408"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SuccIt == Succs.end()) &#123;</span></CodeLine>
<Link id="l03409" /><CodeLine lineNumber="3409"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Jump to all successors;</span></CodeLine>
<Link id="l03410" /><CodeLine lineNumber="3410"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Succs.size() &gt; 0)</span></CodeLine>
<Link id="l03411" /><CodeLine lineNumber="3411"><span class="doxyHighlight">        DupCost += PredFreq;</span></CodeLine>
<Link id="l03412" /><CodeLine lineNumber="3412"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l03413" /><CodeLine lineNumber="3413"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Fallthrough to &#42;SuccIt, jump to all other successors;</span></CodeLine>
<Link id="l03414" /><CodeLine lineNumber="3414"><span class="doxyHighlight">      DupCost += PredFreq;</span></CodeLine>
<Link id="l03415" /><CodeLine lineNumber="3415"><span class="doxyHighlight">      DupCost -= PredFreq &#42; MBPI-&gt;getEdgeProbability(BB, &#42;SuccIt);</span></CodeLine>
<Link id="l03416" /><CodeLine lineNumber="3416"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03417" /><CodeLine lineNumber="3417"></CodeLine>
<Link id="l03418" /><CodeLine lineNumber="3418"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(OrigCost &gt;= DupCost);</span></CodeLine>
<Link id="l03419" /><CodeLine lineNumber="3419"><span class="doxyHighlight">    OrigCost -= DupCost;</span></CodeLine>
<Link id="l03420" /><CodeLine lineNumber="3420"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (OrigCost &gt; BBDupThreshold) &#123;</span></CodeLine>
<Link id="l03421" /><CodeLine lineNumber="3421"><span class="doxyHighlight">      Candidates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(Pred);</span></CodeLine>
<Link id="l03422" /><CodeLine lineNumber="3422"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SuccIt != Succs.end())</span></CodeLine>
<Link id="l03423" /><CodeLine lineNumber="3423"><span class="doxyHighlight">        SuccIt++;</span></CodeLine>
<Link id="l03424" /><CodeLine lineNumber="3424"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03425" /><CodeLine lineNumber="3425"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03426" /><CodeLine lineNumber="3426"></CodeLine>
<Link id="l03427" /><CodeLine lineNumber="3427"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// No predecessors can optimally fallthrough to BB.</span></CodeLine>
<Link id="l03428" /><CodeLine lineNumber="3428"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// So we can change one duplication into fallthrough.</span></CodeLine>
<Link id="l03429" /><CodeLine lineNumber="3429"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Fallthrough) &#123;</span></CodeLine>
<Link id="l03430" /><CodeLine lineNumber="3430"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> ((Candidates.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() &lt; Preds.size()) &amp;&amp; (Candidates.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() &gt; 0)) &#123;</span></CodeLine>
<Link id="l03431" /><CodeLine lineNumber="3431"><span class="doxyHighlight">      Candidates&#91;0&#93; = Candidates.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#acd9e771a3296c6b24146955754620557">back</a>();</span></CodeLine>
<Link id="l03432" /><CodeLine lineNumber="3432"><span class="doxyHighlight">      Candidates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#ad97688dfe9cd802e2a0691cbe620218a">pop&#95;back</a>();</span></CodeLine>
<Link id="l03433" /><CodeLine lineNumber="3433"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03434" /><CodeLine lineNumber="3434"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03435" /><CodeLine lineNumber="3435"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l03436" /><CodeLine lineNumber="3436"></CodeLine>
<Link id="l03437" /><CodeLine lineNumber="3437"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> MachineBlockPlacement::initTailDupThreshold() &#123;</span></CodeLine>
<Link id="l03438" /><CodeLine lineNumber="3438"><span class="doxyHighlight">  DupThreshold = <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>(0);</span></CodeLine>
<Link id="l03439" /><CodeLine lineNumber="3439"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getFunction().hasProfileData()) &#123;</span></CodeLine>
<Link id="l03440" /><CodeLine lineNumber="3440"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We prefer to use prifile count.</span></CodeLine>
<Link id="l03441" /><CodeLine lineNumber="3441"><span class="doxyHighlight">    uint64&#95;t HotThreshold = PSI-&gt;getOrCompHotCountThreshold();</span></CodeLine>
<Link id="l03442" /><CodeLine lineNumber="3442"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (HotThreshold != <a href="/docs/api/files/include/include/llvm-c/datatypes-h/#a30654b4b67d97c42ca3f9b6052dda916">UINT64&#95;MAX</a>) &#123;</span></CodeLine>
<Link id="l03443" /><CodeLine lineNumber="3443"><span class="doxyHighlight">      UseProfileCount = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03444" /><CodeLine lineNumber="3444"><span class="doxyHighlight">      DupThreshold =</span></CodeLine>
<Link id="l03445" /><CodeLine lineNumber="3445"><span class="doxyHighlight">          <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>(HotThreshold &#42; <a href="#a84dfb254ed1062bc06a43d2365974bd2">TailDupProfilePercentThreshold</a> / 100);</span></CodeLine>
<Link id="l03446" /><CodeLine lineNumber="3446"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l03447" /><CodeLine lineNumber="3447"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Profile count is not available, we can use block frequency instead.</span></CodeLine>
<Link id="l03448" /><CodeLine lineNumber="3448"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> MaxFreq = <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>(0);</span></CodeLine>
<Link id="l03449" /><CodeLine lineNumber="3449"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l03450" /><CodeLine lineNumber="3450"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> Freq = MBFI-&gt;getBlockFreq(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</span></CodeLine>
<Link id="l03451" /><CodeLine lineNumber="3451"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Freq &gt; MaxFreq)</span></CodeLine>
<Link id="l03452" /><CodeLine lineNumber="3452"><span class="doxyHighlight">          MaxFreq = Freq;</span></CodeLine>
<Link id="l03453" /><CodeLine lineNumber="3453"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l03454" /><CodeLine lineNumber="3454"></CodeLine>
<Link id="l03455" /><CodeLine lineNumber="3455"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/branchprobability">BranchProbability</a> ThresholdProb(<a href="#a7344284dac6ba9b8e48d9be67c954bfc">TailDupPlacementPenalty</a>, 100);</span></CodeLine>
<Link id="l03456" /><CodeLine lineNumber="3456"><span class="doxyHighlight">      DupThreshold = <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a>(MaxFreq &#42; ThresholdProb);</span></CodeLine>
<Link id="l03457" /><CodeLine lineNumber="3457"><span class="doxyHighlight">      UseProfileCount = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03458" /><CodeLine lineNumber="3458"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03459" /><CodeLine lineNumber="3459"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03460" /><CodeLine lineNumber="3460"></CodeLine>
<Link id="l03461" /><CodeLine lineNumber="3461"><span class="doxyHighlight">  TailDupSize = <a href="#a707021480bba6c165b873f9e238859c5">TailDupPlacementThreshold</a>;</span></CodeLine>
<Link id="l03462" /><CodeLine lineNumber="3462"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If only the aggressive threshold is explicitly set, use it.</span></CodeLine>
<Link id="l03463" /><CodeLine lineNumber="3463"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#adc8acb8291add6a055468711f701e78d">TailDupPlacementAggressiveThreshold</a>.getNumOccurrences() != 0 &amp;&amp;</span></CodeLine>
<Link id="l03464" /><CodeLine lineNumber="3464"><span class="doxyHighlight">      <a href="#a707021480bba6c165b873f9e238859c5">TailDupPlacementThreshold</a>.getNumOccurrences() == 0)</span></CodeLine>
<Link id="l03465" /><CodeLine lineNumber="3465"><span class="doxyHighlight">    TailDupSize = <a href="#adc8acb8291add6a055468711f701e78d">TailDupPlacementAggressiveThreshold</a>;</span></CodeLine>
<Link id="l03466" /><CodeLine lineNumber="3466"></CodeLine>
<Link id="l03467" /><CodeLine lineNumber="3467"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For aggressive optimization, we can adjust some thresholds to be less</span></CodeLine>
<Link id="l03468" /><CodeLine lineNumber="3468"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// conservative.</span></CodeLine>
<Link id="l03469" /><CodeLine lineNumber="3469"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (PassConfig-&gt;getOptLevel() &gt;= <a href="/docs/api/namespaces/llvm/#a8ec1bf8d7b792ca9fac56f8514db18d2a389a96d0d9b3feb46b8c9d941566a4ae">CodeGenOptLevel::Aggressive</a>) &#123;</span></CodeLine>
<Link id="l03470" /><CodeLine lineNumber="3470"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// At O3 we should be more willing to copy blocks for tail duplication. This</span></CodeLine>
<Link id="l03471" /><CodeLine lineNumber="3471"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// increases size pressure, so we only do it at O3</span></CodeLine>
<Link id="l03472" /><CodeLine lineNumber="3472"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Do this unless only the regular threshold is explicitly set.</span></CodeLine>
<Link id="l03473" /><CodeLine lineNumber="3473"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a707021480bba6c165b873f9e238859c5">TailDupPlacementThreshold</a>.getNumOccurrences() == 0 ||</span></CodeLine>
<Link id="l03474" /><CodeLine lineNumber="3474"><span class="doxyHighlight">        <a href="#adc8acb8291add6a055468711f701e78d">TailDupPlacementAggressiveThreshold</a>.getNumOccurrences() != 0)</span></CodeLine>
<Link id="l03475" /><CodeLine lineNumber="3475"><span class="doxyHighlight">      TailDupSize = <a href="#adc8acb8291add6a055468711f701e78d">TailDupPlacementAggressiveThreshold</a>;</span></CodeLine>
<Link id="l03476" /><CodeLine lineNumber="3476"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03477" /><CodeLine lineNumber="3477"></CodeLine>
<Link id="l03478" /><CodeLine lineNumber="3478"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If there&#39;s no threshold provided through options, query the target</span></CodeLine>
<Link id="l03479" /><CodeLine lineNumber="3479"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// information for a threshold instead.</span></CodeLine>
<Link id="l03480" /><CodeLine lineNumber="3480"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a707021480bba6c165b873f9e238859c5">TailDupPlacementThreshold</a>.getNumOccurrences() == 0 &amp;&amp;</span></CodeLine>
<Link id="l03481" /><CodeLine lineNumber="3481"><span class="doxyHighlight">      (PassConfig-&gt;getOptLevel() &lt; <a href="/docs/api/namespaces/llvm/#a8ec1bf8d7b792ca9fac56f8514db18d2a389a96d0d9b3feb46b8c9d941566a4ae">CodeGenOptLevel::Aggressive</a> ||</span></CodeLine>
<Link id="l03482" /><CodeLine lineNumber="3482"><span class="doxyHighlight">       <a href="#adc8acb8291add6a055468711f701e78d">TailDupPlacementAggressiveThreshold</a>.getNumOccurrences() == 0))</span></CodeLine>
<Link id="l03483" /><CodeLine lineNumber="3483"><span class="doxyHighlight">    TailDupSize = <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;getTailDuplicateSize(PassConfig-&gt;getOptLevel());</span></CodeLine>
<Link id="l03484" /><CodeLine lineNumber="3484"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l03485" /><CodeLine lineNumber="3485"></CodeLine>
<Link id="l03486" /><CodeLine lineNumber="3486" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#a1f0291b83febf5c94491d76bf5236799"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#a1f0291b83febf5c94491d76bf5236799">MachineBlockPlacement::runOnMachineFunction</a>(<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF) &#123;</span></CodeLine>
<Link id="l03487" /><CodeLine lineNumber="3487"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/functionpass/#af9f5f511d75e16f09a5520cb9444cfa8">skipFunction</a>(MF.<a href="/docs/api/classes/llvm/machinefunction/#a977ddce262de45c645be23d951066351">getFunction</a>()))</span></CodeLine>
<Link id="l03488" /><CodeLine lineNumber="3488"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03489" /><CodeLine lineNumber="3489"></CodeLine>
<Link id="l03490" /><CodeLine lineNumber="3490"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Check for single-block functions and skip them.</span></CodeLine>
<Link id="l03491" /><CodeLine lineNumber="3491"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (std::next(MF.<a href="/docs/api/classes/llvm/machinefunction/#ab0789854909cf47f640a85fa2bac29c7">begin</a>()) == MF.<a href="/docs/api/classes/llvm/machinefunction/#a9d017af749f76484cb9aec9ff6e4330c">end</a>())</span></CodeLine>
<Link id="l03492" /><CodeLine lineNumber="3492"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03493" /><CodeLine lineNumber="3493"></CodeLine>
<Link id="l03494" /><CodeLine lineNumber="3494"><span class="doxyHighlight">  F = &amp;MF;</span></CodeLine>
<Link id="l03495" /><CodeLine lineNumber="3495"><span class="doxyHighlight">  MBPI = &amp;<a href="/docs/api/classes/llvm/pass/#a4863e5e463fb79955269fbf7fbf52b80">getAnalysis&lt;MachineBranchProbabilityInfoWrapperPass&gt;</a>().getMBPI();</span></CodeLine>
<Link id="l03496" /><CodeLine lineNumber="3496"><span class="doxyHighlight">  MBFI = std::make&#95;unique&lt;MBFIWrapper&gt;(</span></CodeLine>
<Link id="l03497" /><CodeLine lineNumber="3497"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/pass/#a4863e5e463fb79955269fbf7fbf52b80">getAnalysis&lt;MachineBlockFrequencyInfoWrapperPass&gt;</a>().getMBFI());</span></CodeLine>
<Link id="l03498" /><CodeLine lineNumber="3498"><span class="doxyHighlight">  MLI = &amp;<a href="/docs/api/classes/llvm/pass/#a4863e5e463fb79955269fbf7fbf52b80">getAnalysis&lt;MachineLoopInfoWrapperPass&gt;</a>().getLI();</span></CodeLine>
<Link id="l03499" /><CodeLine lineNumber="3499"><span class="doxyHighlight">  TII = MF.<a href="/docs/api/classes/llvm/machinefunction/#a3825368aca2bc1550d173660df4da6a6">getSubtarget</a>().<a href="/docs/api/classes/llvm/targetsubtargetinfo/#acd858ed72f11db9444617740c3622608">getInstrInfo</a>();</span></CodeLine>
<Link id="l03500" /><CodeLine lineNumber="3500"><span class="doxyHighlight">  TLI = MF.<a href="/docs/api/classes/llvm/machinefunction/#a3825368aca2bc1550d173660df4da6a6">getSubtarget</a>().<a href="/docs/api/classes/llvm/targetsubtargetinfo/#ade3f0d8b35d67c43df9425bb730a9a7c">getTargetLowering</a>();</span></CodeLine>
<Link id="l03501" /><CodeLine lineNumber="3501"><span class="doxyHighlight">  MPDT = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03502" /><CodeLine lineNumber="3502"><span class="doxyHighlight">  PSI = &amp;<a href="/docs/api/classes/llvm/pass/#a4863e5e463fb79955269fbf7fbf52b80">getAnalysis&lt;ProfileSummaryInfoWrapperPass&gt;</a>().getPSI();</span></CodeLine>
<Link id="l03503" /><CodeLine lineNumber="3503"><span class="doxyHighlight">  PassConfig = &amp;<a href="/docs/api/classes/llvm/pass/#a4863e5e463fb79955269fbf7fbf52b80">getAnalysis&lt;TargetPassConfig&gt;</a>();</span></CodeLine>
<Link id="l03504" /><CodeLine lineNumber="3504"></CodeLine>
<Link id="l03505" /><CodeLine lineNumber="3505"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Initialize PreferredLoopExit to nullptr here since it may never be set if</span></CodeLine>
<Link id="l03506" /><CodeLine lineNumber="3506"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// there are no MachineLoops.</span></CodeLine>
<Link id="l03507" /><CodeLine lineNumber="3507"><span class="doxyHighlight">  PreferredLoopExit = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03508" /><CodeLine lineNumber="3508"></CodeLine>
<Link id="l03509" /><CodeLine lineNumber="3509"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BlockToChain.empty() &amp;&amp;</span></CodeLine>
<Link id="l03510" /><CodeLine lineNumber="3510"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;BlockToChain map should be empty before starting placement.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l03511" /><CodeLine lineNumber="3511"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(ComputedEdges.empty() &amp;&amp;</span></CodeLine>
<Link id="l03512" /><CodeLine lineNumber="3512"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;Computed Edge map should be empty before starting placement.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l03513" /><CodeLine lineNumber="3513"></CodeLine>
<Link id="l03514" /><CodeLine lineNumber="3514"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Initialize tail duplication thresholds.</span></CodeLine>
<Link id="l03515" /><CodeLine lineNumber="3515"><span class="doxyHighlight">  initTailDupThreshold();</span></CodeLine>
<Link id="l03516" /><CodeLine lineNumber="3516"></CodeLine>
<Link id="l03517" /><CodeLine lineNumber="3517"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> OptForSize =</span></CodeLine>
<Link id="l03518" /><CodeLine lineNumber="3518"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#a3af72f14ea20f2c762c751d2d49e5ea3">llvm::shouldOptimizeForSize</a>(&amp;MF, PSI, &amp;MBFI-&gt;getMBFI());</span></CodeLine>
<Link id="l03519" /><CodeLine lineNumber="3519"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Determine whether to use ext-tsp for perf/size optimization. The method</span></CodeLine>
<Link id="l03520" /><CodeLine lineNumber="3520"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// is beneficial only for instances with at least 3 basic blocks and it can be</span></CodeLine>
<Link id="l03521" /><CodeLine lineNumber="3521"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// disabled for huge functions (exceeding a certain size).</span></CodeLine>
<Link id="l03522" /><CodeLine lineNumber="3522"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> UseExtTspForPerf = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03523" /><CodeLine lineNumber="3523"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> UseExtTspForSize = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03524" /><CodeLine lineNumber="3524"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (3 &lt;= MF.<a href="/docs/api/classes/llvm/machinefunction/#a7d2ce2106f9f7cf8f45c7c3c116ef43d">size</a>() &amp;&amp; MF.<a href="/docs/api/classes/llvm/machinefunction/#a7d2ce2106f9f7cf8f45c7c3c116ef43d">size</a>() &lt;= <a href="#a1160412b923427430e8bf4c819d79a93">ExtTspBlockPlacementMaxBlocks</a>) &#123;</span></CodeLine>
<Link id="l03525" /><CodeLine lineNumber="3525"><span class="doxyHighlight">    UseExtTspForPerf =</span></CodeLine>
<Link id="l03526" /><CodeLine lineNumber="3526"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#ae4599fe5d1385154f1bfbc41a10495c5">EnableExtTspBlockPlacement</a> &amp;&amp;</span></CodeLine>
<Link id="l03527" /><CodeLine lineNumber="3527"><span class="doxyHighlight">        (<a href="/docs/api/namespaces/llvm/#a2dee051dfc0746e4fbf6e26175ece121">ApplyExtTspWithoutProfile</a> || MF.<a href="/docs/api/classes/llvm/machinefunction/#a977ddce262de45c645be23d951066351">getFunction</a>().<a href="/docs/api/files/lib/lib/transforms/lib/transforms/ipo/partialinlining-cpp/#a8884a3765a9cdbc730400587d4a3192c">hasProfileData</a>());</span></CodeLine>
<Link id="l03528" /><CodeLine lineNumber="3528"><span class="doxyHighlight">    UseExtTspForSize = OptForSize &amp;&amp; <a href="#a956f6faccd85fe2a75302e0ac3ecc606">ApplyExtTspForSize</a>;</span></CodeLine>
<Link id="l03529" /><CodeLine lineNumber="3529"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03530" /><CodeLine lineNumber="3530"></CodeLine>
<Link id="l03531" /><CodeLine lineNumber="3531"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Apply tail duplication.</span></CodeLine>
<Link id="l03532" /><CodeLine lineNumber="3532"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacement/#ad65badde897b7d4f51fc7c545538a388">allowTailDupPlacement</a>()) &#123;</span></CodeLine>
<Link id="l03533" /><CodeLine lineNumber="3533"><span class="doxyHighlight">    MPDT = &amp;<a href="/docs/api/classes/llvm/pass/#a4863e5e463fb79955269fbf7fbf52b80">getAnalysis&lt;MachinePostDominatorTreeWrapperPass&gt;</a>().getPostDomTree();</span></CodeLine>
<Link id="l03534" /><CodeLine lineNumber="3534"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (OptForSize)</span></CodeLine>
<Link id="l03535" /><CodeLine lineNumber="3535"><span class="doxyHighlight">      TailDupSize = 1;</span></CodeLine>
<Link id="l03536" /><CodeLine lineNumber="3536"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> PreRegAlloc = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03537" /><CodeLine lineNumber="3537"><span class="doxyHighlight">    TailDup.initMF(MF, PreRegAlloc, MBPI, MBFI.get(), PSI,</span></CodeLine>
<Link id="l03538" /><CodeLine lineNumber="3538"><span class="doxyHighlight">                   </span><span class="doxyHighlightComment">/&#42; LayoutMode &#42;/</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">, TailDupSize);</span></CodeLine>
<Link id="l03539" /><CodeLine lineNumber="3539"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!UseExtTspForSize)</span></CodeLine>
<Link id="l03540" /><CodeLine lineNumber="3540"><span class="doxyHighlight">      precomputeTriangleChains();</span></CodeLine>
<Link id="l03541" /><CodeLine lineNumber="3541"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03542" /><CodeLine lineNumber="3542"></CodeLine>
<Link id="l03543" /><CodeLine lineNumber="3543"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Run the main block placement.</span></CodeLine>
<Link id="l03544" /><CodeLine lineNumber="3544"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!UseExtTspForSize)</span></CodeLine>
<Link id="l03545" /><CodeLine lineNumber="3545"><span class="doxyHighlight">    buildCFGChains();</span></CodeLine>
<Link id="l03546" /><CodeLine lineNumber="3546"></CodeLine>
<Link id="l03547" /><CodeLine lineNumber="3547"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Changing the layout can create new tail merging opportunities.</span></CodeLine>
<Link id="l03548" /><CodeLine lineNumber="3548"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TailMerge can create jump into if branches that make CFG irreducible for</span></CodeLine>
<Link id="l03549" /><CodeLine lineNumber="3549"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// HW that requires structured CFG.</span></CodeLine>
<Link id="l03550" /><CodeLine lineNumber="3550"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> EnableTailMerge = !MF.<a href="/docs/api/classes/llvm/machinefunction/#af777ff93c9e07a6ff5ffe3226deb3e76">getTarget</a>().<a href="/docs/api/classes/llvm/targetmachine/#aa276e49983e93afa359ec83ad71ccadc">requiresStructuredCFG</a>() &amp;&amp;</span></CodeLine>
<Link id="l03551" /><CodeLine lineNumber="3551"><span class="doxyHighlight">                               PassConfig-&gt;getEnableTailMerge() &amp;&amp;</span></CodeLine>
<Link id="l03552" /><CodeLine lineNumber="3552"><span class="doxyHighlight">                               <a href="#a84ae0b35deb4cbcffc27c3d52a781fca">BranchFoldPlacement</a> &amp;&amp; MF.<a href="/docs/api/classes/llvm/machinefunction/#a7d2ce2106f9f7cf8f45c7c3c116ef43d">size</a>() &gt; 3;</span></CodeLine>
<Link id="l03553" /><CodeLine lineNumber="3553"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// No tail merging opportunities if the block number is less than four.</span></CodeLine>
<Link id="l03554" /><CodeLine lineNumber="3554"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (EnableTailMerge) &#123;</span></CodeLine>
<Link id="l03555" /><CodeLine lineNumber="3555"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/codegen/branchfolding-cpp/#a73423bf857429f170a6355ae20e1d798">TailMergeSize</a> = TailDupSize + 1;</span></CodeLine>
<Link id="l03556" /><CodeLine lineNumber="3556"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/branchfolder">BranchFolder</a> BF(</span><span class="doxyHighlightComment">/&#42;DefaultEnableTailMerge=&#42;/</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">, </span><span class="doxyHighlightComment">/&#42;CommonHoist=&#42;/</span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l03557" /><CodeLine lineNumber="3557"><span class="doxyHighlight">                    &#42;MBFI, &#42;MBPI, PSI, <a href="/docs/api/files/lib/lib/codegen/branchfolding-cpp/#a73423bf857429f170a6355ae20e1d798">TailMergeSize</a>);</span></CodeLine>
<Link id="l03558" /><CodeLine lineNumber="3558"></CodeLine>
<Link id="l03559" /><CodeLine lineNumber="3559"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BF.<a href="/docs/api/classes/llvm/branchfolder/#aa0d50fee4d0d41ccf591e29de109786f">OptimizeFunction</a>(MF, TII, MF.<a href="/docs/api/classes/llvm/machinefunction/#a3825368aca2bc1550d173660df4da6a6">getSubtarget</a>().<a href="/docs/api/classes/llvm/targetsubtargetinfo/#a43c530c830206ecf5ad3359364634c75">getRegisterInfo</a>(), MLI,</span></CodeLine>
<Link id="l03560" /><CodeLine lineNumber="3560"><span class="doxyHighlight">                            </span><span class="doxyHighlightComment">/&#42;AfterPlacement=&#42;/</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">)) &#123;</span></CodeLine>
<Link id="l03561" /><CodeLine lineNumber="3561"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Must redo the post-dominator tree if blocks were changed.</span></CodeLine>
<Link id="l03562" /><CodeLine lineNumber="3562"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (MPDT)</span></CodeLine>
<Link id="l03563" /><CodeLine lineNumber="3563"><span class="doxyHighlight">        MPDT-&gt;recalculate(MF);</span></CodeLine>
<Link id="l03564" /><CodeLine lineNumber="3564"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!UseExtTspForSize) &#123;</span></CodeLine>
<Link id="l03565" /><CodeLine lineNumber="3565"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Redo the layout if tail merging creates/removes/moves blocks.</span></CodeLine>
<Link id="l03566" /><CodeLine lineNumber="3566"><span class="doxyHighlight">        BlockToChain.clear();</span></CodeLine>
<Link id="l03567" /><CodeLine lineNumber="3567"><span class="doxyHighlight">        ComputedEdges.clear();</span></CodeLine>
<Link id="l03568" /><CodeLine lineNumber="3568"><span class="doxyHighlight">        ChainAllocator.DestroyAll();</span></CodeLine>
<Link id="l03569" /><CodeLine lineNumber="3569"><span class="doxyHighlight">        buildCFGChains();</span></CodeLine>
<Link id="l03570" /><CodeLine lineNumber="3570"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l03571" /><CodeLine lineNumber="3571"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03572" /><CodeLine lineNumber="3572"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03573" /><CodeLine lineNumber="3573"></CodeLine>
<Link id="l03574" /><CodeLine lineNumber="3574"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Apply a post-processing optimizing block placement:</span></CodeLine>
<Link id="l03575" /><CodeLine lineNumber="3575"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// - find a new placement and modify the layout of the blocks in the function;</span></CodeLine>
<Link id="l03576" /><CodeLine lineNumber="3576"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// - re-create CFG chains so that we can optimizeBranches and alignBlocks.</span></CodeLine>
<Link id="l03577" /><CodeLine lineNumber="3577"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (UseExtTspForPerf || UseExtTspForSize) &#123;</span></CodeLine>
<Link id="l03578" /><CodeLine lineNumber="3578"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(</span></CodeLine>
<Link id="l03579" /><CodeLine lineNumber="3579"><span class="doxyHighlight">        !(UseExtTspForPerf &amp;&amp; UseExtTspForSize) &amp;&amp;</span></CodeLine>
<Link id="l03580" /><CodeLine lineNumber="3580"><span class="doxyHighlight">        </span><span class="doxyHighlightStringLiteral">&quot;UseExtTspForPerf and UseExtTspForSize can not be set simultaneously&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l03581" /><CodeLine lineNumber="3581"><span class="doxyHighlight">    applyExtTsp(</span><span class="doxyHighlightComment">/&#42;OptForSize=&#42;/</span><span class="doxyHighlight">UseExtTspForSize);</span></CodeLine>
<Link id="l03582" /><CodeLine lineNumber="3582"><span class="doxyHighlight">    createCFGChainExtTsp();</span></CodeLine>
<Link id="l03583" /><CodeLine lineNumber="3583"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03584" /><CodeLine lineNumber="3584"></CodeLine>
<Link id="l03585" /><CodeLine lineNumber="3585"><span class="doxyHighlight">  optimizeBranches();</span></CodeLine>
<Link id="l03586" /><CodeLine lineNumber="3586"><span class="doxyHighlight">  alignBlocks();</span></CodeLine>
<Link id="l03587" /><CodeLine lineNumber="3587"></CodeLine>
<Link id="l03588" /><CodeLine lineNumber="3588"><span class="doxyHighlight">  BlockToChain.clear();</span></CodeLine>
<Link id="l03589" /><CodeLine lineNumber="3589"><span class="doxyHighlight">  ComputedEdges.clear();</span></CodeLine>
<Link id="l03590" /><CodeLine lineNumber="3590"><span class="doxyHighlight">  ChainAllocator.DestroyAll();</span></CodeLine>
<Link id="l03591" /><CodeLine lineNumber="3591"></CodeLine>
<Link id="l03592" /><CodeLine lineNumber="3592"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// View the function.</span></CodeLine>
<Link id="l03593" /><CodeLine lineNumber="3593"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a7cc8a419725f3a9ce1d23c2db21ea143">ViewBlockLayoutWithBFI</a> != <a href="/docs/api/namespaces/llvm/#af0bf055834b973decc2477a8061624ffa49315903a2559d882f356ae28a455556">GVDT&#95;None</a> &amp;&amp;</span></CodeLine>
<Link id="l03594" /><CodeLine lineNumber="3594"><span class="doxyHighlight">      (<a href="/docs/api/namespaces/llvm/#a6391a34afa5b4ed1a5e556a8cc4d971b">ViewBlockFreqFuncName</a>.empty() ||</span></CodeLine>
<Link id="l03595" /><CodeLine lineNumber="3595"><span class="doxyHighlight">       F-&gt;getFunction().getName() == <a href="/docs/api/namespaces/llvm/#a6391a34afa5b4ed1a5e556a8cc4d971b">ViewBlockFreqFuncName</a>)) &#123;</span></CodeLine>
<Link id="l03596" /><CodeLine lineNumber="3596"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#ad1fed248fc2af534bd094b35c9f0c64b">RenumberBlocksBeforeView</a>)</span></CodeLine>
<Link id="l03597" /><CodeLine lineNumber="3597"><span class="doxyHighlight">      MF.<a href="/docs/api/classes/llvm/machinefunction/#ac85349aab432e6b7d8b2e8926048a6de">RenumberBlocks</a>();</span></CodeLine>
<Link id="l03598" /><CodeLine lineNumber="3598"><span class="doxyHighlight">    MBFI-&gt;view(</span><span class="doxyHighlightStringLiteral">&quot;MBP.&quot;</span><span class="doxyHighlight"> + MF.<a href="/docs/api/classes/llvm/machinefunction/#a3d142c9e7c066059e15232c56dec9e2e">getName</a>(), </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l03599" /><CodeLine lineNumber="3599"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03600" /><CodeLine lineNumber="3600"></CodeLine>
<Link id="l03601" /><CodeLine lineNumber="3601"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We always return true as we have no way to track whether the final order</span></CodeLine>
<Link id="l03602" /><CodeLine lineNumber="3602"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// differs from the original order.</span></CodeLine>
<Link id="l03603" /><CodeLine lineNumber="3603"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03604" /><CodeLine lineNumber="3604"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l03605" /><CodeLine lineNumber="3605"></CodeLine>
<Link id="l03606" /><CodeLine lineNumber="3606"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> MachineBlockPlacement::applyExtTsp(</span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> OptForSize) &#123;</span></CodeLine>
<Link id="l03607" /><CodeLine lineNumber="3607"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Prepare data; blocks are indexed by their index in the current ordering.</span></CodeLine>
<Link id="l03608" /><CodeLine lineNumber="3608"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/densemap">DenseMap&lt;const MachineBasicBlock &#42;, uint64&#95;t&gt;</a> BlockIndex;</span></CodeLine>
<Link id="l03609" /><CodeLine lineNumber="3609"><span class="doxyHighlight">  BlockIndex.<a href="/docs/api/classes/llvm/densemapbase/#ae292a4b96e7f74eb95a4176ddba7b821">reserve</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;size());</span></CodeLine>
<Link id="l03610" /><CodeLine lineNumber="3610"><span class="doxyHighlight">  std::vector&lt;const MachineBasicBlock &#42;&gt; CurrentBlockOrder;</span></CodeLine>
<Link id="l03611" /><CodeLine lineNumber="3611"><span class="doxyHighlight">  CurrentBlockOrder.reserve(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;size());</span></CodeLine>
<Link id="l03612" /><CodeLine lineNumber="3612"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">size&#95;t</span><span class="doxyHighlight"> NumBlocks = 0;</span></CodeLine>
<Link id="l03613" /><CodeLine lineNumber="3613"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l03614" /><CodeLine lineNumber="3614"><span class="doxyHighlight">    BlockIndex&#91;&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>&#93; = NumBlocks++;</span></CodeLine>
<Link id="l03615" /><CodeLine lineNumber="3615"><span class="doxyHighlight">    CurrentBlockOrder.push&#95;back(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</span></CodeLine>
<Link id="l03616" /><CodeLine lineNumber="3616"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03617" /><CodeLine lineNumber="3617"></CodeLine>
<Link id="l03618" /><CodeLine lineNumber="3618"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;uint64&#95;t, 0&gt;</a> BlockCounts(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;size());</span></CodeLine>
<Link id="l03619" /><CodeLine lineNumber="3619"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;uint64&#95;t, 0&gt;</a> BlockSizes(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;size());</span></CodeLine>
<Link id="l03620" /><CodeLine lineNumber="3620"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;codelayout::EdgeCount, 0&gt;</a> JumpCounts;</span></CodeLine>
<Link id="l03621" /><CodeLine lineNumber="3621"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineOperand, 4&gt;</a> <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>; </span><span class="doxyHighlightComment">// For analyzeBranch.</span></CodeLine>
<Link id="l03622" /><CodeLine lineNumber="3622"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;const MachineBasicBlock &#42;, 4&gt;</a> Succs;</span></CodeLine>
<Link id="l03623" /><CodeLine lineNumber="3623"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l03624" /><CodeLine lineNumber="3624"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Getting the block frequency.</span></CodeLine>
<Link id="l03625" /><CodeLine lineNumber="3625"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> BlockFreq = MBFI-&gt;getBlockFreq(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</span></CodeLine>
<Link id="l03626" /><CodeLine lineNumber="3626"><span class="doxyHighlight">    BlockCounts&#91;BlockIndex&#91;&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>&#93;&#93; = OptForSize ? 1 : BlockFreq.<a href="/docs/api/classes/llvm/blockfrequency/#a8e9ed6b20c2503f66f1fd0725297aedc">getFrequency</a>();</span></CodeLine>
<Link id="l03627" /><CodeLine lineNumber="3627"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Getting the block size:</span></CodeLine>
<Link id="l03628" /><CodeLine lineNumber="3628"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// - approximate the size of an instruction by 4 bytes, and</span></CodeLine>
<Link id="l03629" /><CodeLine lineNumber="3629"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// - ignore debug instructions.</span></CodeLine>
<Link id="l03630" /><CodeLine lineNumber="3630"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Note: getting the exact size of each block is target-dependent and can be</span></CodeLine>
<Link id="l03631" /><CodeLine lineNumber="3631"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// done by extending the interface of MCCodeEmitter. Experimentally we do</span></CodeLine>
<Link id="l03632" /><CodeLine lineNumber="3632"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// not see a perf improvement with the exact block sizes.</span></CodeLine>
<Link id="l03633" /><CodeLine lineNumber="3633"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> NonDbgInsts =</span></CodeLine>
<Link id="l03634" /><CodeLine lineNumber="3634"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a90f68a1fc5d44bb06164dc2188b8e486">instructionsWithoutDebug</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.instr&#95;begin(), <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.instr&#95;end());</span></CodeLine>
<Link id="l03635" /><CodeLine lineNumber="3635"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">size&#95;t</span><span class="doxyHighlight"> NumInsts = std::distance(NonDbgInsts.begin(), NonDbgInsts.end());</span></CodeLine>
<Link id="l03636" /><CodeLine lineNumber="3636"><span class="doxyHighlight">    BlockSizes&#91;BlockIndex&#91;&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>&#93;&#93; = 4 &#42; NumInsts;</span></CodeLine>
<Link id="l03637" /><CodeLine lineNumber="3637"></CodeLine>
<Link id="l03638" /><CodeLine lineNumber="3638"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Getting jump frequencies.</span></CodeLine>
<Link id="l03639" /><CodeLine lineNumber="3639"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (OptForSize) &#123;</span></CodeLine>
<Link id="l03640" /><CodeLine lineNumber="3640"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>.clear();</span></CodeLine>
<Link id="l03641" /><CodeLine lineNumber="3641"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a> = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">, &#42;FBB = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">; </span><span class="doxyHighlightComment">// For analyzeBranch.</span></CodeLine>
<Link id="l03642" /><CodeLine lineNumber="3642"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;analyzeBranch(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a>, FBB, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>))</span></CodeLine>
<Link id="l03643" /><CodeLine lineNumber="3643"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03644" /><CodeLine lineNumber="3644"></CodeLine>
<Link id="l03645" /><CodeLine lineNumber="3645"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;FTB = <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.getFallThrough();</span></CodeLine>
<Link id="l03646" /><CodeLine lineNumber="3646"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Succs is a collection of distinct destinations of the block reachable</span></CodeLine>
<Link id="l03647" /><CodeLine lineNumber="3647"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// from MBB via a jump instruction; initialize the list using the three</span></CodeLine>
<Link id="l03648" /><CodeLine lineNumber="3648"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// (non-necessarily distinct) blocks, FTB, TBB, and FBB.</span></CodeLine>
<Link id="l03649" /><CodeLine lineNumber="3649"><span class="doxyHighlight">      Succs.<a href="/docs/api/classes/llvm/smallvectorimpl/#aac0ea55010b7b1a301e65a0baea057aa">clear</a>();</span></CodeLine>
<Link id="l03650" /><CodeLine lineNumber="3650"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a> &amp;&amp; <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a> != FTB)</span></CodeLine>
<Link id="l03651" /><CodeLine lineNumber="3651"><span class="doxyHighlight">        Succs.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a>);</span></CodeLine>
<Link id="l03652" /><CodeLine lineNumber="3652"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FBB &amp;&amp; FBB != FTB)</span></CodeLine>
<Link id="l03653" /><CodeLine lineNumber="3653"><span class="doxyHighlight">        Succs.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(FBB);</span></CodeLine>
<Link id="l03654" /><CodeLine lineNumber="3654"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FTB)</span></CodeLine>
<Link id="l03655" /><CodeLine lineNumber="3655"><span class="doxyHighlight">        Succs.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(FTB);</span></CodeLine>
<Link id="l03656" /><CodeLine lineNumber="3656"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Absolute magnitude of non-zero counts does not matter for the</span></CodeLine>
<Link id="l03657" /><CodeLine lineNumber="3657"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// optimization; prioritize slightly jumps with a single successor, since</span></CodeLine>
<Link id="l03658" /><CodeLine lineNumber="3658"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// the corresponding jump instruction will be removed from the binary.</span></CodeLine>
<Link id="l03659" /><CodeLine lineNumber="3659"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> uint64&#95;t Freq = Succs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() == 1 ? 110 : 100;</span></CodeLine>
<Link id="l03660" /><CodeLine lineNumber="3660"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ : Succs)</span></CodeLine>
<Link id="l03661" /><CodeLine lineNumber="3661"><span class="doxyHighlight">        JumpCounts.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;BlockIndex&#91;&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>&#93;, BlockIndex&#91;Succ&#93;, Freq&#125;);</span></CodeLine>
<Link id="l03662" /><CodeLine lineNumber="3662"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l03663" /><CodeLine lineNumber="3663"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ : <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.successors()) &#123;</span></CodeLine>
<Link id="l03664" /><CodeLine lineNumber="3664"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> EP = MBPI-&gt;getEdgeProbability(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, Succ);</span></CodeLine>
<Link id="l03665" /><CodeLine lineNumber="3665"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> JumpFreq = BlockFreq &#42; EP;</span></CodeLine>
<Link id="l03666" /><CodeLine lineNumber="3666"><span class="doxyHighlight">        JumpCounts.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(</span></CodeLine>
<Link id="l03667" /><CodeLine lineNumber="3667"><span class="doxyHighlight">            &#123;BlockIndex&#91;&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>&#93;, BlockIndex&#91;Succ&#93;, JumpFreq.<a href="/docs/api/classes/llvm/blockfrequency/#a8e9ed6b20c2503f66f1fd0725297aedc">getFrequency</a>()&#125;);</span></CodeLine>
<Link id="l03668" /><CodeLine lineNumber="3668"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l03669" /><CodeLine lineNumber="3669"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03670" /><CodeLine lineNumber="3670"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03671" /><CodeLine lineNumber="3671"></CodeLine>
<Link id="l03672" /><CodeLine lineNumber="3672"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Applying ext-tsp layout for |V| = &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;size()</span></CodeLine>
<Link id="l03673" /><CodeLine lineNumber="3673"><span class="doxyHighlight">                    &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; with profile = &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getFunction().hasProfileData()</span></CodeLine>
<Link id="l03674" /><CodeLine lineNumber="3674"><span class="doxyHighlight">                    &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; (&quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getName() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;)&quot;</span><span class="doxyHighlight"> &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l03675" /><CodeLine lineNumber="3675"></CodeLine>
<Link id="l03676" /><CodeLine lineNumber="3676"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">double</span><span class="doxyHighlight"> OrgScore = <a href="/docs/api/namespaces/llvm/codelayout/#a70c3cab5f18ff0a00d4ad43ec3287021">calcExtTspScore</a>(BlockSizes, JumpCounts);</span></CodeLine>
<Link id="l03677" /><CodeLine lineNumber="3677"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; <a href="/docs/api/namespaces/llvm/#a939bc2108d47080767f0c06ba56caec7">format</a>(</span><span class="doxyHighlightStringLiteral">&quot;  original  layout score: %0.2f\\n&quot;</span><span class="doxyHighlight">, OrgScore));</span></CodeLine>
<Link id="l03678" /><CodeLine lineNumber="3678"></CodeLine>
<Link id="l03679" /><CodeLine lineNumber="3679"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Run the layout algorithm.</span></CodeLine>
<Link id="l03680" /><CodeLine lineNumber="3680"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> NewOrder = <a href="/docs/api/namespaces/llvm/codelayout/#ab265fb35ca9607f01d99dae7a386ef77">computeExtTspLayout</a>(BlockSizes, BlockCounts, JumpCounts);</span></CodeLine>
<Link id="l03681" /><CodeLine lineNumber="3681"><span class="doxyHighlight">  std::vector&lt;const MachineBasicBlock &#42;&gt; NewBlockOrder;</span></CodeLine>
<Link id="l03682" /><CodeLine lineNumber="3682"><span class="doxyHighlight">  NewBlockOrder.reserve(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;size());</span></CodeLine>
<Link id="l03683" /><CodeLine lineNumber="3683"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (uint64&#95;t <a href="/docs/api/classes/node">Node</a> : NewOrder) &#123;</span></CodeLine>
<Link id="l03684" /><CodeLine lineNumber="3684"><span class="doxyHighlight">    NewBlockOrder.push&#95;back(CurrentBlockOrder&#91;<a href="/docs/api/classes/node">Node</a>&#93;);</span></CodeLine>
<Link id="l03685" /><CodeLine lineNumber="3685"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03686" /><CodeLine lineNumber="3686"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">double</span><span class="doxyHighlight"> OptScore = <a href="/docs/api/namespaces/llvm/codelayout/#a70c3cab5f18ff0a00d4ad43ec3287021">calcExtTspScore</a>(NewOrder, BlockSizes, JumpCounts);</span></CodeLine>
<Link id="l03687" /><CodeLine lineNumber="3687"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; <a href="/docs/api/namespaces/llvm/#a939bc2108d47080767f0c06ba56caec7">format</a>(</span><span class="doxyHighlightStringLiteral">&quot;  optimized layout score: %0.2f\\n&quot;</span><span class="doxyHighlight">, OptScore));</span></CodeLine>
<Link id="l03688" /><CodeLine lineNumber="3688"></CodeLine>
<Link id="l03689" /><CodeLine lineNumber="3689"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the optimization is unsuccessful, fall back to the original block order.</span></CodeLine>
<Link id="l03690" /><CodeLine lineNumber="3690"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (OptForSize &amp;&amp; OrgScore &gt; OptScore)</span></CodeLine>
<Link id="l03691" /><CodeLine lineNumber="3691"><span class="doxyHighlight">    assignBlockOrder(CurrentBlockOrder);</span></CodeLine>
<Link id="l03692" /><CodeLine lineNumber="3692"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l03693" /><CodeLine lineNumber="3693"><span class="doxyHighlight">    assignBlockOrder(NewBlockOrder);</span></CodeLine>
<Link id="l03694" /><CodeLine lineNumber="3694"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l03695" /><CodeLine lineNumber="3695"></CodeLine>
<Link id="l03696" /><CodeLine lineNumber="3696"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> MachineBlockPlacement::assignBlockOrder(</span></CodeLine>
<Link id="l03697" /><CodeLine lineNumber="3697"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> std::vector&lt;const MachineBasicBlock &#42;&gt; &amp;NewBlockOrder) &#123;</span></CodeLine>
<Link id="l03698" /><CodeLine lineNumber="3698"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;size() == NewBlockOrder.size() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Incorrect size of block order&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l03699" /><CodeLine lineNumber="3699"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;RenumberBlocks();</span></CodeLine>
<Link id="l03700" /><CodeLine lineNumber="3700"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// At this point, we possibly removed blocks from the function, so we can&#39;t</span></CodeLine>
<Link id="l03701" /><CodeLine lineNumber="3701"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// renumber the domtree. At this point, we don&#39;t need it anymore, though.</span></CodeLine>
<Link id="l03702" /><CodeLine lineNumber="3702"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: move this to the point where the dominator tree is actually</span></CodeLine>
<Link id="l03703" /><CodeLine lineNumber="3703"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// invalidated (i.e., where blocks are removed without updating the domtree).</span></CodeLine>
<Link id="l03704" /><CodeLine lineNumber="3704"><span class="doxyHighlight">  MPDT = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03705" /><CodeLine lineNumber="3705"></CodeLine>
<Link id="l03706" /><CodeLine lineNumber="3706"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> HasChanges = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03707" /><CodeLine lineNumber="3707"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">size&#95;t</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = 0; <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> &lt; NewBlockOrder.size(); <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>++) &#123;</span></CodeLine>
<Link id="l03708" /><CodeLine lineNumber="3708"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NewBlockOrder&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; != <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getBlockNumbered(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) &#123;</span></CodeLine>
<Link id="l03709" /><CodeLine lineNumber="3709"><span class="doxyHighlight">      HasChanges = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03710" /><CodeLine lineNumber="3710"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03711" /><CodeLine lineNumber="3711"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03712" /><CodeLine lineNumber="3712"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03713" /><CodeLine lineNumber="3713"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Stop early if the new block order is identical to the existing one.</span></CodeLine>
<Link id="l03714" /><CodeLine lineNumber="3714"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!HasChanges)</span></CodeLine>
<Link id="l03715" /><CodeLine lineNumber="3715"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03716" /><CodeLine lineNumber="3716"></CodeLine>
<Link id="l03717" /><CodeLine lineNumber="3717"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineBasicBlock &#42;, 4&gt;</a> PrevFallThroughs(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getNumBlockIDs());</span></CodeLine>
<Link id="l03718" /><CodeLine lineNumber="3718"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l03719" /><CodeLine lineNumber="3719"><span class="doxyHighlight">    PrevFallThroughs&#91;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.getNumber()&#93; = <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.getFallThrough();</span></CodeLine>
<Link id="l03720" /><CodeLine lineNumber="3720"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03721" /><CodeLine lineNumber="3721"></CodeLine>
<Link id="l03722" /><CodeLine lineNumber="3722"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Sort basic blocks in the function according to the computed order.</span></CodeLine>
<Link id="l03723" /><CodeLine lineNumber="3723"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/densemap">DenseMap&lt;const MachineBasicBlock &#42;, size&#95;t&gt;</a> NewIndex;</span></CodeLine>
<Link id="l03724" /><CodeLine lineNumber="3724"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : NewBlockOrder) &#123;</span></CodeLine>
<Link id="l03725" /><CodeLine lineNumber="3725"><span class="doxyHighlight">    NewIndex&#91;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>&#93; = NewIndex.<a href="/docs/api/classes/llvm/densemapbase/#a3d95cc2d359b8d9ed5bd9504b44930b5">size</a>();</span></CodeLine>
<Link id="l03726" /><CodeLine lineNumber="3726"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03727" /><CodeLine lineNumber="3727"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;sort(&#91;&amp;&#93;(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;L, <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;R) &#123;</span></CodeLine>
<Link id="l03728" /><CodeLine lineNumber="3728"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> NewIndex&#91;&amp;<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>&#93; &lt; NewIndex&#91;&amp;<a href="/docs/api/namespaces/llvm/riscvfencefield/#a147be9e9780c1e33363ea572d4c7b25fa1835091d83e0e052cd1a32c99b2be731">R</a>&#93;;</span></CodeLine>
<Link id="l03729" /><CodeLine lineNumber="3729"><span class="doxyHighlight">  &#125;);</span></CodeLine>
<Link id="l03730" /><CodeLine lineNumber="3730"></CodeLine>
<Link id="l03731" /><CodeLine lineNumber="3731"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Update basic block branches by inserting explicit fallthrough branches</span></CodeLine>
<Link id="l03732" /><CodeLine lineNumber="3732"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// when required and re-optimize branches when possible.</span></CodeLine>
<Link id="l03733" /><CodeLine lineNumber="3733"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/targetinstrinfo">TargetInstrInfo</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a> = <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getSubtarget().getInstrInfo();</span></CodeLine>
<Link id="l03734" /><CodeLine lineNumber="3734"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineOperand, 4&gt;</a> <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>;</span></CodeLine>
<Link id="l03735" /><CodeLine lineNumber="3735"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l03736" /><CodeLine lineNumber="3736"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinefunction/#aaba82c71ffdca966cad10eae0992fff9">MachineFunction::iterator</a> NextMBB = std::next(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.getIterator());</span></CodeLine>
<Link id="l03737" /><CodeLine lineNumber="3737"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinefunction/#aaba82c71ffdca966cad10eae0992fff9">MachineFunction::iterator</a> EndIt = <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.getParent()-&gt;end();</span></CodeLine>
<Link id="l03738" /><CodeLine lineNumber="3738"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;FTMBB = PrevFallThroughs&#91;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.getNumber()&#93;;</span></CodeLine>
<Link id="l03739" /><CodeLine lineNumber="3739"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If this block had a fallthrough before we need an explicit unconditional</span></CodeLine>
<Link id="l03740" /><CodeLine lineNumber="3740"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// branch to that block if the fallthrough block is not adjacent to the</span></CodeLine>
<Link id="l03741" /><CodeLine lineNumber="3741"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// block in the new order.</span></CodeLine>
<Link id="l03742" /><CodeLine lineNumber="3742"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FTMBB &amp;&amp; (NextMBB == EndIt || &amp;&#42;NextMBB != FTMBB)) &#123;</span></CodeLine>
<Link id="l03743" /><CodeLine lineNumber="3743"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;insertUnconditionalBranch(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, FTMBB, <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.findBranchDebugLoc());</span></CodeLine>
<Link id="l03744" /><CodeLine lineNumber="3744"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03745" /><CodeLine lineNumber="3745"></CodeLine>
<Link id="l03746" /><CodeLine lineNumber="3746"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// It might be possible to optimize branches by flipping the condition.</span></CodeLine>
<Link id="l03747" /><CodeLine lineNumber="3747"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>.clear();</span></CodeLine>
<Link id="l03748" /><CodeLine lineNumber="3748"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a> = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">, &#42;FBB = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03749" /><CodeLine lineNumber="3749"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;analyzeBranch(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a1441f79530bc7f3a89118bb8067eac69">TBB</a>, FBB, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>))</span></CodeLine>
<Link id="l03750" /><CodeLine lineNumber="3750"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03751" /><CodeLine lineNumber="3751"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.updateTerminator(FTMBB);</span></CodeLine>
<Link id="l03752" /><CodeLine lineNumber="3752"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03753" /><CodeLine lineNumber="3753"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l03754" /><CodeLine lineNumber="3754"></CodeLine>
<Link id="l03755" /><CodeLine lineNumber="3755"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> MachineBlockPlacement::createCFGChainExtTsp() &#123;</span></CodeLine>
<Link id="l03756" /><CodeLine lineNumber="3756"><span class="doxyHighlight">  BlockToChain.clear();</span></CodeLine>
<Link id="l03757" /><CodeLine lineNumber="3757"><span class="doxyHighlight">  ComputedEdges.clear();</span></CodeLine>
<Link id="l03758" /><CodeLine lineNumber="3758"><span class="doxyHighlight">  ChainAllocator.DestroyAll();</span></CodeLine>
<Link id="l03759" /><CodeLine lineNumber="3759"></CodeLine>
<Link id="l03760" /><CodeLine lineNumber="3760"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;HeadBB = &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;front();</span></CodeLine>
<Link id="l03761" /><CodeLine lineNumber="3761"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a> &#42;FunctionChain =</span></CodeLine>
<Link id="l03762" /><CodeLine lineNumber="3762"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> (ChainAllocator.Allocate()) <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/blockchain/#ab486c9a0a0c5124ad4709ca49b910ec9">BlockChain</a>(BlockToChain, HeadBB);</span></CodeLine>
<Link id="l03763" /><CodeLine lineNumber="3763"></CodeLine>
<Link id="l03764" /><CodeLine lineNumber="3764"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l03765" /><CodeLine lineNumber="3765"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (HeadBB == &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>)</span></CodeLine>
<Link id="l03766" /><CodeLine lineNumber="3766"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">; </span><span class="doxyHighlightComment">// Ignore head of the chain</span></CodeLine>
<Link id="l03767" /><CodeLine lineNumber="3767"><span class="doxyHighlight">    FunctionChain-&gt;merge(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l03768" /><CodeLine lineNumber="3768"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03769" /><CodeLine lineNumber="3769"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l03770" /><CodeLine lineNumber="3770"></CodeLine>
<Link id="l03771" /><CodeLine lineNumber="3771"><span class="doxyHighlightKeyword">namespace </span><span class="doxyHighlight">&#123;</span></CodeLine>
<Link id="l03772" /><CodeLine lineNumber="3772"></CodeLine>
<Link id="l03773" /><CodeLine lineNumber="3773"><span class="doxyHighlightComment">/// A pass to compute block placement statistics.</span></CodeLine>
<Link id="l03774" /><CodeLine lineNumber="3774"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l03775" /><CodeLine lineNumber="3775"><span class="doxyHighlightComment">/// A separate pass to compute interesting statistics for evaluating block</span></CodeLine>
<Link id="l03776" /><CodeLine lineNumber="3776"><span class="doxyHighlightComment">/// placement. This is separate from the actual placement pass so that they can</span></CodeLine>
<Link id="l03777" /><CodeLine lineNumber="3777"><span class="doxyHighlightComment">/// be computed in the absence of any placement transformations or when using</span></CodeLine>
<Link id="l03778" /><CodeLine lineNumber="3778"><span class="doxyHighlightComment">/// alternative placement strategies.</span></CodeLine>
<Link id="l03779" /><CodeLine lineNumber="3779" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacementstats"><span class="doxyHighlightKeyword">class </span><span class="doxyHighlight"><a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacementstats/#ab048335b4f8ed04dfd6d34baa1881a9c">MachineBlockPlacementStats</a> : </span><span class="doxyHighlightKeyword">public</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinefunctionpass/#a29c81d2386f4a727c6d33413807530c8">MachineFunctionPass</a> &#123;</span></CodeLine>
<Link id="l03780" /><CodeLine lineNumber="3780"><span class="doxyHighlightComment">  /// A handle to the branch probability pass.</span></CodeLine>
<Link id="l03781" /><CodeLine lineNumber="3781"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebranchprobabilityinfo">MachineBranchProbabilityInfo</a> &#42;MBPI;</span></CodeLine>
<Link id="l03782" /><CodeLine lineNumber="3782"></CodeLine>
<Link id="l03783" /><CodeLine lineNumber="3783"><span class="doxyHighlightComment">  /// A handle to the function-wide block frequency pass.</span></CodeLine>
<Link id="l03784" /><CodeLine lineNumber="3784"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machineblockfrequencyinfo">MachineBlockFrequencyInfo</a> &#42;MBFI;</span></CodeLine>
<Link id="l03785" /><CodeLine lineNumber="3785"></CodeLine>
<Link id="l03786" /><CodeLine lineNumber="3786"><span class="doxyHighlightKeyword">public</span><span class="doxyHighlight">:</span></CodeLine>
<Link id="l03787" /><CodeLine lineNumber="3787" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacementstats/#abe0ba94dc7c9cf225a968cb9f3fc5043"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">char</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacementstats/#abe0ba94dc7c9cf225a968cb9f3fc5043">ID</a>; </span><span class="doxyHighlightComment">// Pass identification, replacement for typeid</span></CodeLine>
<Link id="l03788" /><CodeLine lineNumber="3788"></CodeLine>
<Link id="l03789" /><CodeLine lineNumber="3789" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacementstats/#ab048335b4f8ed04dfd6d34baa1881a9c"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacementstats/#ab048335b4f8ed04dfd6d34baa1881a9c">MachineBlockPlacementStats</a>() : <a href="/docs/api/classes/llvm/machinefunctionpass/#a29c81d2386f4a727c6d33413807530c8">MachineFunctionPass</a>(<a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacementstats/#abe0ba94dc7c9cf225a968cb9f3fc5043">ID</a>) &#123;</span></CodeLine>
<Link id="l03790" /><CodeLine lineNumber="3790"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a44d0c54f06e770c47e8d36af9f09b4af">initializeMachineBlockPlacementStatsPass</a>(&#42;<a href="/docs/api/classes/llvm/passregistry/#a05a729900b76c89e808c6c3094921b2f">PassRegistry::getPassRegistry</a>());</span></CodeLine>
<Link id="l03791" /><CodeLine lineNumber="3791"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03792" /><CodeLine lineNumber="3792"></CodeLine>
<Link id="l03793" /><CodeLine lineNumber="3793"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> runOnMachineFunction(<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) </span><span class="doxyHighlightKeyword">override</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03794" /><CodeLine lineNumber="3794"></CodeLine>
<Link id="l03795" /><CodeLine lineNumber="3795" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacementstats/#af6fdd4aa0d9c5af936fea8be657b7c7a"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacementstats/#af6fdd4aa0d9c5af936fea8be657b7c7a">getAnalysisUsage</a>(<a href="/docs/api/classes/llvm/analysisusage">AnalysisUsage</a> &amp;AU)</span><span class="doxyHighlightKeyword"> const override </span><span class="doxyHighlight">&#123;</span></CodeLine>
<Link id="l03796" /><CodeLine lineNumber="3796"><span class="doxyHighlight">    AU.<a href="/docs/api/classes/llvm/analysisusage/#ae0adcccca08fb686c9ce00f9397b660c">addRequired</a>&lt;<a href="/docs/api/classes/llvm/machinebranchprobabilityinfowrapperpass">MachineBranchProbabilityInfoWrapperPass</a>&gt;();</span></CodeLine>
<Link id="l03797" /><CodeLine lineNumber="3797"><span class="doxyHighlight">    AU.<a href="/docs/api/classes/llvm/analysisusage/#ae0adcccca08fb686c9ce00f9397b660c">addRequired</a>&lt;<a href="/docs/api/classes/llvm/machineblockfrequencyinfowrapperpass">MachineBlockFrequencyInfoWrapperPass</a>&gt;();</span></CodeLine>
<Link id="l03798" /><CodeLine lineNumber="3798"><span class="doxyHighlight">    AU.<a href="/docs/api/classes/llvm/analysisusage/#af22b06a6a4f9df80454071685a0d6a02">setPreservesAll</a>();</span></CodeLine>
<Link id="l03799" /><CodeLine lineNumber="3799"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinefunctionpass/#a864fd57b4304ef933b3281d0ef85a88e">MachineFunctionPass::getAnalysisUsage</a>(AU);</span></CodeLine>
<Link id="l03800" /><CodeLine lineNumber="3800"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03801" /><CodeLine lineNumber="3801"><span class="doxyHighlight">&#125;;</span></CodeLine>
<Link id="l03802" /><CodeLine lineNumber="3802"></CodeLine>
<Link id="l03803" /><CodeLine lineNumber="3803"><span class="doxyHighlight">&#125; </span><span class="doxyHighlightComment">// end anonymous namespace</span></CodeLine>
<Link id="l03804" /><CodeLine lineNumber="3804"></CodeLine>
<Link id="l03805" /><CodeLine lineNumber="3805"><span class="doxyHighlightKeywordType">char</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacementstats/#abe0ba94dc7c9cf225a968cb9f3fc5043">MachineBlockPlacementStats::ID</a> = 0;</span></CodeLine>
<Link id="l03806" /><CodeLine lineNumber="3806"></CodeLine>
<Link id="l03807" /><CodeLine lineNumber="3807" lineLink="/docs/api/namespaces/llvm/#aed6261eb88354cb0f52273e9fdcce729"><span class="doxyHighlightKeywordType">char</span><span class="doxyHighlight"> &amp;<a href="/docs/api/namespaces/llvm/#aed6261eb88354cb0f52273e9fdcce729">llvm::MachineBlockPlacementStatsID</a> = <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacementstats/#abe0ba94dc7c9cf225a968cb9f3fc5043">MachineBlockPlacementStats::ID</a>;</span></CodeLine>
<Link id="l03808" /><CodeLine lineNumber="3808"></CodeLine>
<Link id="l03809" /><CodeLine lineNumber="3809" lineLink="#ace73c7d6fee046409626ebb1799d0454"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/passsupport-h/#aaa970fc931c1c63037a8182e028d04b1">INITIALIZE&#95;PASS&#95;BEGIN</a>(<a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacementstats/#ab048335b4f8ed04dfd6d34baa1881a9c">MachineBlockPlacementStats</a>, </span><span class="doxyHighlightStringLiteral">&quot;block-placement-stats&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l03810" /><CodeLine lineNumber="3810"><span class="doxyHighlight">                      </span><span class="doxyHighlightStringLiteral">&quot;Basic Block Placement Stats&quot;</span><span class="doxyHighlight">, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l03811" /><CodeLine lineNumber="3811"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/passsupport-h/#a14724f1ccf528e73bb29bc9230737967">INITIALIZE&#95;PASS&#95;DEPENDENCY</a>(<a href="/docs/api/classes/llvm/machinebranchprobabilityinfowrapperpass">MachineBranchProbabilityInfoWrapperPass</a>)</span></CodeLine>
<Link id="l03812" /><CodeLine lineNumber="3812"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/passsupport-h/#a14724f1ccf528e73bb29bc9230737967">INITIALIZE&#95;PASS&#95;DEPENDENCY</a>(<a href="/docs/api/classes/llvm/machineblockfrequencyinfowrapperpass">MachineBlockFrequencyInfoWrapperPass</a>)</span></CodeLine>
<Link id="l03813" /><CodeLine lineNumber="3813" lineLink="#a971b2fc3751cade0a6b2f76c92774317"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/passsupport-h/#a74ce8276b89067e806f67c45a6d92575">INITIALIZE&#95;PASS&#95;END</a>(<a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacementstats/#ab048335b4f8ed04dfd6d34baa1881a9c">MachineBlockPlacementStats</a>, </span><span class="doxyHighlightStringLiteral">&quot;block-placement-stats&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l03814" /><CodeLine lineNumber="3814" lineLink="#a086f939e29b718dc5a01e4bcfe6af2a1"><span class="doxyHighlight">                    </span><span class="doxyHighlightStringLiteral">&quot;Basic Block Placement Stats&quot;</span><span class="doxyHighlight">, <a href="/docs/api/namespaces/false">false</a>, <a href="/docs/api/namespaces/false">false</a>)</span></CodeLine>
<Link id="l03815" /><CodeLine lineNumber="3815"></CodeLine>
<Link id="l03816" /><CodeLine lineNumber="3816" lineLink="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacementstats/#a8305613a915321631b70e8f26e2d55d6"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacementstats/#ab048335b4f8ed04dfd6d34baa1881a9c">MachineBlockPlacementStats</a>::<a href="/docs/api/classes/anonymous-namespace-machineblockplacement-cpp-/machineblockplacementstats/#a8305613a915321631b70e8f26e2d55d6">runOnMachineFunction</a>(<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l03817" /><CodeLine lineNumber="3817"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Check for single-block functions and skip them.</span></CodeLine>
<Link id="l03818" /><CodeLine lineNumber="3818"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (std::next(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.begin()) == <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.end())</span></CodeLine>
<Link id="l03819" /><CodeLine lineNumber="3819"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03820" /><CodeLine lineNumber="3820"></CodeLine>
<Link id="l03821" /><CodeLine lineNumber="3821"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/passes/passbuilderbindings-cpp/#acdfbcf188e2d4a80837e89de2ccdffab">if</a> (!<a href="/docs/api/namespaces/llvm/#a7d104c3a6510178d34b2d3f0ae67b4d5">isFunctionInPrintList</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getName()))</span></CodeLine>
<Link id="l03822" /><CodeLine lineNumber="3822"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03823" /><CodeLine lineNumber="3823"></CodeLine>
<Link id="l03824" /><CodeLine lineNumber="3824"><span class="doxyHighlight">  MBPI = &amp;<a href="/docs/api/classes/llvm/pass/#a4863e5e463fb79955269fbf7fbf52b80">getAnalysis&lt;MachineBranchProbabilityInfoWrapperPass&gt;</a>().getMBPI();</span></CodeLine>
<Link id="l03825" /><CodeLine lineNumber="3825"><span class="doxyHighlight">  MBFI = &amp;<a href="/docs/api/classes/llvm/pass/#a4863e5e463fb79955269fbf7fbf52b80">getAnalysis&lt;MachineBlockFrequencyInfoWrapperPass&gt;</a>().getMBFI();</span></CodeLine>
<Link id="l03826" /><CodeLine lineNumber="3826"></CodeLine>
<Link id="l03827" /><CodeLine lineNumber="3827"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a4cfc8b177e8521a4b496ae2edff6244f">for</a> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l03828" /><CodeLine lineNumber="3828"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> BlockFreq = MBFI-&gt;getBlockFreq(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</span></CodeLine>
<Link id="l03829" /><CodeLine lineNumber="3829"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a6412c3ea6550f1aeab7571b6d38a2bf3">Statistic</a> &amp;NumBranches =</span></CodeLine>
<Link id="l03830" /><CodeLine lineNumber="3830"><span class="doxyHighlight">        (<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.succ&#95;size() &gt; 1) ? NumCondBranches : NumUncondBranches;</span></CodeLine>
<Link id="l03831" /><CodeLine lineNumber="3831"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a6412c3ea6550f1aeab7571b6d38a2bf3">Statistic</a> &amp;BranchTakenFreq =</span></CodeLine>
<Link id="l03832" /><CodeLine lineNumber="3832"><span class="doxyHighlight">        (<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.succ&#95;size() &gt; 1) ? CondBranchTakenFreq : UncondBranchTakenFreq;</span></CodeLine>
<Link id="l03833" /><CodeLine lineNumber="3833"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ : <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.successors()) &#123;</span></CodeLine>
<Link id="l03834" /><CodeLine lineNumber="3834"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Skip if this successor is a fallthrough.</span></CodeLine>
<Link id="l03835" /><CodeLine lineNumber="3835"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.isLayoutSuccessor(Succ))</span></CodeLine>
<Link id="l03836" /><CodeLine lineNumber="3836"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03837" /><CodeLine lineNumber="3837"></CodeLine>
<Link id="l03838" /><CodeLine lineNumber="3838"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/blockfrequency">BlockFrequency</a> EdgeFreq =</span></CodeLine>
<Link id="l03839" /><CodeLine lineNumber="3839"><span class="doxyHighlight">          BlockFreq &#42; MBPI-&gt;getEdgeProbability(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, Succ);</span></CodeLine>
<Link id="l03840" /><CodeLine lineNumber="3840"><span class="doxyHighlight">      ++NumBranches;</span></CodeLine>
<Link id="l03841" /><CodeLine lineNumber="3841"><span class="doxyHighlight">      BranchTakenFreq += EdgeFreq.<a href="/docs/api/classes/llvm/blockfrequency/#a8e9ed6b20c2503f66f1fd0725297aedc">getFrequency</a>();</span></CodeLine>
<Link id="l03842" /><CodeLine lineNumber="3842"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l03843" /><CodeLine lineNumber="3843"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l03844" /><CodeLine lineNumber="3844"></CodeLine>
<Link id="l03845" /><CodeLine lineNumber="3845"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l03846" /><CodeLine lineNumber="3846"><span class="doxyHighlight">&#125;</span></CodeLine>

</ProgramListing>


</DoxygenPage>
