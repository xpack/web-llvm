---

# DO NOT EDIT!
# Automatically generated via docusaurus-plugin-doxygen by Doxygen.

slug: /api/files/lib/lib/target/lib/target/webassembly/webassemblyloweremscriptenehsjlj-cpp
custom_edit_url: null
keywords:
  - doxygen
  - reference
  - file

---

import Link from '@docusaurus/Link'

import CodeLine from '@xpack/docusaurus-plugin-doxygen/components/CodeLine'
import DoxygenPage from '@xpack/docusaurus-plugin-doxygen/components/DoxygenPage'
import IncludesList from '@xpack/docusaurus-plugin-doxygen/components/IncludesList'
import IncludesListItem from '@xpack/docusaurus-plugin-doxygen/components/IncludesListItem'
import MemberDefinition from '@xpack/docusaurus-plugin-doxygen/components/MemberDefinition'
import MembersIndex from '@xpack/docusaurus-plugin-doxygen/components/MembersIndex'
import MembersIndexItem from '@xpack/docusaurus-plugin-doxygen/components/MembersIndexItem'
import ProgramListing from '@xpack/docusaurus-plugin-doxygen/components/ProgramListing'
import SectionDefinition from '@xpack/docusaurus-plugin-doxygen/components/SectionDefinition'

import pluginConfig from '@site/docusaurus-plugin-doxygen-config.json'

# The `WebAssemblyLowerEmscriptenEHSjLj.cpp` File Reference

<DoxygenPage pluginConfig={pluginConfig}>

This file lowers exception-related instructions and setjmp/longjmp function calls to use Emscripten&#39;s library functions. <a href="#details">More...</a>

## Included Headers

<IncludesList>
<IncludesListItem
  filePath="MCTargetDesc/WebAssemblyMCTargetDesc.h"
  permalink="/docs/api/files/lib/lib/target/lib/target/webassembly/lib/target/webassembly/mctargetdesc/webassemblymctargetdesc-h"
  isLocal="true" />
<IncludesListItem
  filePath="WebAssembly.h"
  permalink="/docs/api/files/lib/lib/target/lib/target/webassembly/webassembly-h"
  isLocal="true" />
<IncludesListItem
  filePath="WebAssemblyTargetMachine.h"
  permalink="/docs/api/files/lib/lib/target/lib/target/webassembly/webassemblytargetmachine-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/StringExtras.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/stringextras-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/TargetPassConfig.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/targetpassconfig-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/WasmEHFuncInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/wasmehfuncinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/DebugInfoMetadata.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/debuginfometadata-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Dominators.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/dominators-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/IRBuilder.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/irbuilder-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/IntrinsicsWebAssembly.h"
  permalink=""
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Module.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/module-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/CommandLine.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/BasicBlockUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/basicblockutils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/Local.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/local-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/SSAUpdater.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/ssaupdater-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/SSAUpdaterBulk.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/ssaupdaterbulk-h"
  isLocal="true" />
<IncludesListItem
  filePath="set"
  permalink=""
  isLocal="false" />
</IncludesList>

## Namespaces Index

<MembersIndex>

<MembersIndexItem
  type="namespace"
  name={<><a href="/docs/api/namespaces/anonymous-webassemblyloweremscriptenehsjlj-cpp-">anonymous&#123;WebAssemblyLowerEmscriptenEHSjLj.cpp&#125;</a></>}>
</MembersIndexItem>

</MembersIndex>

## Classes Index

<MembersIndex>

<MembersIndexItem
  type="class"
  name={<><a href="/docs/api/classes/anonymous-namespace-webassemblyloweremscriptenehsjlj-cpp-/webassemblyloweremscriptenehsjlj">WebAssemblyLowerEmscriptenEHSjLj</a></>}>
</MembersIndexItem>

</MembersIndex>

## Functions Index

<MembersIndex>

<MembersIndexItem
  type="bool"
  name={<><a href="#a2dacd2cc5f8d003dbbf793474f06df14">canLongjmp</a> (const Value &#42;Callee)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a8f4bf9ef05ac2193b41802f2e8466f66">canThrow</a> (const Value &#42;V)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#ac083d4bf8d3f3e1e700c33981f97248c">containsLongjmpableCalls</a> (const Function &#42;F)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/type">Type</a> &#42;</>}
  name={<><a href="#a7db0da8464b0af856d82ee7c77519483">getAddrIntType</a> (Module &#42;M)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/type">Type</a> &#42;</>}
  name={<><a href="#a59656c1055ce3a231bba72ea31edfb14">getAddrPtrType</a> (Module &#42;M)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/value">Value</a> &#42;</>}
  name={<><a href="#ad2de6223491e08f9906cfd58b9db22c2">getAddrSizeInt</a> (Module &#42;M, uint64&#95;t C)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;</>}
  name={<><a href="#aa3b0ffc4e031802ced683f381cac97af">getCleanupRetUnwindDest</a> (const CleanupPadInst &#42;CPI)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/function">Function</a> &#42;</>}
  name={<><a href="#ad3ef075dd9dce61e81b354102b4fe107">getEmscriptenFunction</a> (FunctionType &#42;Ty, const Twine &amp;Name, Module &#42;M)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/globalvariable">GlobalVariable</a> &#42;</>}
  name={<><a href="#ad625ba253f12b49a01ced02c4190e22b">getGlobalVariable</a> (Module &amp;M, Type &#42;Ty, WebAssemblyTargetMachine &amp;TM, const char &#42;Name)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/debugloc">DebugLoc</a></>}
  name={<><a href="#aaf95913e52851622a35765cc28adf643">getOrCreateDebugLoc</a> (const Instruction &#42;InsertBefore, DISubprogram &#42;SP)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/files/include/include/llvm/include/llvm/demangle/itaniumdemangle-h/#ae2b0d0345572d6718e219aa76d1d54edab45cffe084dd3d20d928bee85e7b0f21">std::string</a></>}
  name={<><a href="#a6c8fb36f87b49a215040e2943af69e99">getSignature</a> (FunctionType &#42;FTy)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#a24b94fa950f4e47096365189c893d30e">INITIALIZE&#95;PASS</a> (WebAssemblyLowerEmscriptenEHSjLj, DEBUG&#95;TYPE, &quot;WebAssembly Lower Emscripten Exceptions / Setjmp / Longjmp&quot;, false, false) ModulePass &#42;llvm</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#ae471a184f6df0ce3df8700257824906d">isEmAsmCall</a> (const Value &#42;Callee)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a1e5a795e237da6e01636980c98b645ab">nullifySetjmp</a> (Function &#42;F)</>}>
</MembersIndexItem>

</MembersIndex>

## Variables Index

<MembersIndex>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/list">cl::list</a>&lt; <a href="/docs/api/files/include/include/llvm/include/llvm/demangle/itaniumdemangle-h/#ae2b0d0345572d6718e219aa76d1d54edab45cffe084dd3d20d928bee85e7b0f21">std::string</a> &gt;</>}
  name={<><a href="#a41b437d912a1d2b4bf65ef8da79f8298">EHAllowlist</a></>}>
</MembersIndexItem>

</MembersIndex>

## Defines Index

<MembersIndex>

<MembersIndexItem
  type="#define"
  name={<><a href="#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>&nbsp;&nbsp;&nbsp;&quot;wasm-lower-em-ehsjlj&quot;</>}>
</MembersIndexItem>

</MembersIndex>

## Description {#details}

This file lowers exception-related instructions and setjmp/longjmp function calls to use Emscripten&#39;s library functions.

The pass uses JavaScript&#39;s try and catch mechanism in case of Emscripten EH/SjLj and Wasm EH intrinsics in case of Emscripten SjLJ.


<ul>
<li>Emscripten exception handling This pass lowers invokes and landingpads into library functions in JS glue code. Invokes are lowered into function wrappers called invoke wrappers that exist in JS side, which wraps the original function call with JS try-catch. If an exception occurred, cxa&#95;throw() function in JS side sets some variables (see below) so we can check whether an exception occurred from wasm code and handle it appropriately.</li>
<li>Emscripten setjmp-longjmp handling This pass lowers setjmp to a reasonably-performant approach for emscripten. The idea is that each block with a setjmp is broken up into two parts: the part containing setjmp and the part right after the setjmp. The latter part is either reached from the setjmp, or later from a longjmp. To handle the longjmp, all calls that might longjmp are also called using invoke wrappers and thus JS / try-catch. JS longjmp() function also sets some variables so we can check / whether a longjmp occurred from wasm code. Each block with a function call that might longjmp is also split up after the longjmp call. After the longjmp call, we check whether a longjmp occurred, and if it did, which setjmp it corresponds to, and jump to the right post-setjmp block. We assume setjmp-longjmp handling always run after EH handling, which means we don&#39;t expect any exception-related instructions when SjLj runs. FIXME Currently this scheme does not support indirect call of setjmp, because of the limitation of the scheme itself. fastcomp does not support it either.</li>
</ul>


In detail, this pass does following things:

1) Assumes the existence of global variables: <b>THREW</b>, <b>threwValue &#95;&#95;THREW</b> and <b>threwValue are defined in compiler-rt in Emscripten. These variables are used for both exceptions and setjmp/longjmps. &#95;&#95;THREW</b> indicates whether an exception or a longjmp occurred or not. 0 means nothing occurred, 1 means an exception occurred, and other numbers mean a longjmp occurred. In the case of longjmp, <b>THREW</b> variable indicates the corresponding setjmp buffer the longjmp corresponds to. &#95;&#95;threwValue is 0 for exceptions, and the argument to longjmp in case of longjmp.


<ul>
<li>Emscripten exception handling</li>
</ul>


2) We assume the existence of setThrew and setTempRet0/getTempRet0 functions at link time. setThrew exists in Emscripten&#39;s compiler-rt:

void setThrew(uintptr&#95;t threw, int value) &#123; if (<b>THREW</b> == 0) &#123; <b>THREW</b> = threw; &#95;&#95;threwValue = value; &#125; &#125;

<SectionDefinition>

## Functions

### canLongjmp() {#a2dacd2cc5f8d003dbbf793474f06df14}

<MemberDefinition
  prototype={<>static bool canLongjmp (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/value">Value</a> &#42; Callee)</>}
  labels = {["static"]}>

Definition at line <a href="#l00594">594</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/webassembly/webassemblyloweremscriptenehsjlj-cpp">WebAssemblyLowerEmscriptenEHSjLj.cpp</a>.
</MemberDefinition>

### canThrow() {#a8f4bf9ef05ac2193b41802f2e8466f66}

<MemberDefinition
  prototype={<>static bool canThrow (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/value">Value</a> &#42; V)</>}
  labels = {["static"]}>

Definition at line <a href="#l00389">389</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/webassembly/webassemblyloweremscriptenehsjlj-cpp">WebAssemblyLowerEmscriptenEHSjLj.cpp</a>.
</MemberDefinition>

### containsLongjmpableCalls() {#ac083d4bf8d3f3e1e700c33981f97248c}

<MemberDefinition
  prototype={<>static bool containsLongjmpableCalls (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/function">Function</a> &#42; F)</>}
  labels = {["static"]}>

Definition at line <a href="#l00848">848</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/webassembly/webassemblyloweremscriptenehsjlj-cpp">WebAssemblyLowerEmscriptenEHSjLj.cpp</a>.
</MemberDefinition>

### getAddrIntType() {#a7db0da8464b0af856d82ee7c77519483}

<MemberDefinition
  prototype={<>static Type &#42; getAddrIntType (<a href="/docs/api/classes/llvm/module">Module</a> &#42; M)</>}
  labels = {["static"]}>

Definition at line <a href="#l00463">463</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/webassembly/webassemblyloweremscriptenehsjlj-cpp">WebAssemblyLowerEmscriptenEHSjLj.cpp</a>.
</MemberDefinition>

### getAddrPtrType() {#a59656c1055ce3a231bba72ea31edfb14}

<MemberDefinition
  prototype={<>static Type &#42; getAddrPtrType (<a href="/docs/api/classes/llvm/module">Module</a> &#42; M)</>}
  labels = {["static"]}>

Definition at line <a href="#l00471">471</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/webassembly/webassemblyloweremscriptenehsjlj-cpp">WebAssemblyLowerEmscriptenEHSjLj.cpp</a>.
</MemberDefinition>

### getAddrSizeInt() {#ad2de6223491e08f9906cfd58b9db22c2}

<MemberDefinition
  prototype={<>static Value &#42; getAddrSizeInt (<a href="/docs/api/classes/llvm/module">Module</a> &#42; M, uint64&#95;t C)</>}
  labels = {["static"]}>

Definition at line <a href="#l00478">478</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/webassembly/webassemblyloweremscriptenehsjlj-cpp">WebAssemblyLowerEmscriptenEHSjLj.cpp</a>.
</MemberDefinition>

### getCleanupRetUnwindDest() {#aa3b0ffc4e031802ced683f381cac97af}

<MemberDefinition
  prototype={<>static BasicBlock &#42; getCleanupRetUnwindDest (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/cleanuppadinst">CleanupPadInst</a> &#42; CPI)</>}
  labels = {["static"]}>

Definition at line <a href="#l01543">1543</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/webassembly/webassemblyloweremscriptenehsjlj-cpp">WebAssemblyLowerEmscriptenEHSjLj.cpp</a>.
</MemberDefinition>

### getEmscriptenFunction() {#ad3ef075dd9dce61e81b354102b4fe107}

<MemberDefinition
  prototype={<>static Function &#42; getEmscriptenFunction (<a href="/docs/api/classes/functiontype">FunctionType</a> &#42; Ty, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/twine">Twine</a> &amp; Name, <a href="/docs/api/classes/llvm/module">Module</a> &#42; M)</>}
  labels = {["static"]}>

Definition at line <a href="#l00443">443</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/webassembly/webassemblyloweremscriptenehsjlj-cpp">WebAssemblyLowerEmscriptenEHSjLj.cpp</a>.
</MemberDefinition>

### getGlobalVariable() {#ad625ba253f12b49a01ced02c4190e22b}

<MemberDefinition
  prototype={<>static GlobalVariable &#42; getGlobalVariable (<a href="/docs/api/classes/llvm/module">Module</a> &amp; M, <a href="/docs/api/classes/llvm/type">Type</a> &#42; Ty, <a href="/docs/api/classes/llvm/webassemblytargetmachine">WebAssemblyTargetMachine</a> &amp; TM, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> char &#42; Name)</>}
  labels = {["static"]}>

Definition at line <a href="#l00407">407</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/webassembly/webassemblyloweremscriptenehsjlj-cpp">WebAssemblyLowerEmscriptenEHSjLj.cpp</a>.
</MemberDefinition>

### getOrCreateDebugLoc() {#aaf95913e52851622a35765cc28adf643}

<MemberDefinition
  prototype={<>static DebugLoc getOrCreateDebugLoc (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42; InsertBefore, <a href="/docs/api/classes/llvm/disubprogram">DISubprogram</a> &#42; SP)</>}
  labels = {["static"]}>

Definition at line <a href="#l01248">1248</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/webassembly/webassemblyloweremscriptenehsjlj-cpp">WebAssemblyLowerEmscriptenEHSjLj.cpp</a>.
</MemberDefinition>

### getSignature() {#a6c8fb36f87b49a215040e2943af69e99}

<MemberDefinition
  prototype={<>static std::string getSignature (<a href="/docs/api/classes/functiontype">FunctionType</a> &#42; FTy)</>}
  labels = {["static"]}>

Definition at line <a href="#l00427">427</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/webassembly/webassemblyloweremscriptenehsjlj-cpp">WebAssemblyLowerEmscriptenEHSjLj.cpp</a>.
</MemberDefinition>

### INITIALIZE&#95;PASS() {#a24b94fa950f4e47096365189c893d30e}

<MemberDefinition
  prototype={<>INITIALIZE&#95;PASS (WebAssemblyLowerEmscriptenEHSjLj, <a href="/docs/api/files/include/include/llvm/include/llvm/adt/genericcycleimpl-h/#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>, &quot;WebAssembly Lower Emscripten Exceptions / Setjmp / Longjmp&quot;, false, false)</>}>

Definition at line <a href="#l00381">381</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/webassembly/webassemblyloweremscriptenehsjlj-cpp">WebAssemblyLowerEmscriptenEHSjLj.cpp</a>.
</MemberDefinition>

### isEmAsmCall() {#ae471a184f6df0ce3df8700257824906d}

<MemberDefinition
  prototype={<>static bool isEmAsmCall (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/value">Value</a> &#42; Callee)</>}
  labels = {["static"]}>

Definition at line <a href="#l00675">675</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/webassembly/webassemblyloweremscriptenehsjlj-cpp">WebAssemblyLowerEmscriptenEHSjLj.cpp</a>.
</MemberDefinition>

### nullifySetjmp() {#a1e5a795e237da6e01636980c98b645ab}

<MemberDefinition
  prototype={<>static void nullifySetjmp (<a href="/docs/api/classes/llvm/function">Function</a> &#42; F)</>}
  labels = {["static"]}>

Definition at line <a href="#l00861">861</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/webassembly/webassemblyloweremscriptenehsjlj-cpp">WebAssemblyLowerEmscriptenEHSjLj.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Variables

### EHAllowlist {#a41b437d912a1d2b4bf65ef8da79f8298}

<MemberDefinition
  prototype={<>cl::list&lt; std::string &gt; EHAllowlist(&quot;emscripten-cxx-exceptions-allowed&quot;, cl::desc(&quot;The list of function names in which Emscripten-style &quot; &quot;exception handling is enabled (see emscripten &quot; &quot;EMSCRIPTEN&#95;CATCHING&#95;ALLOWED options)&quot;), cl::CommaSeparated)</>}
  labels = {["static"]}>

Definition at line <a href="#l00287">287</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/webassembly/webassemblyloweremscriptenehsjlj-cpp">WebAssemblyLowerEmscriptenEHSjLj.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Defines

### DEBUG&#95;TYPE {#ad78e062f62e0d6e453941fb4ca843e4d}

<MemberDefinition
  prototype={<>#define DEBUG&#95;TYPE&nbsp;&nbsp;&nbsp;&quot;wasm-lower-em-ehsjlj&quot;</>}>

Definition at line <a href="#l00284">284</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/webassembly/webassemblyloweremscriptenehsjlj-cpp">WebAssemblyLowerEmscriptenEHSjLj.cpp</a>.
</MemberDefinition>

</SectionDefinition>

## File Listing

The file content with the documentation metadata removed is:

<ProgramListing>

<Link id="l00001" /><CodeLine lineNumber="1"><span class="doxyHighlightComment">//=== WebAssemblyLowerEmscriptenEHSjLj.cpp - Lower exceptions for Emscripten =//</span></CodeLine>
<Link id="l00002" /><CodeLine lineNumber="2"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00003" /><CodeLine lineNumber="3"><span class="doxyHighlightComment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</span></CodeLine>
<Link id="l00004" /><CodeLine lineNumber="4"><span class="doxyHighlightComment">// See https://llvm.org/LICENSE.txt for license information.</span></CodeLine>
<Link id="l00005" /><CodeLine lineNumber="5"><span class="doxyHighlightComment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</span></CodeLine>
<Link id="l00006" /><CodeLine lineNumber="6"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00007" /><CodeLine lineNumber="7"><span class="doxyHighlightComment">//===----------------------------------------------------------------------===//</span></CodeLine>
<Link id="l00008" /><CodeLine lineNumber="8"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00009" /><CodeLine lineNumber="9"><span class="doxyHighlightComment">/// \\file</span></CodeLine>
<Link id="l00010" /><CodeLine lineNumber="10"><span class="doxyHighlightComment">/// This file lowers exception-related instructions and setjmp/longjmp function</span></CodeLine>
<Link id="l00011" /><CodeLine lineNumber="11"><span class="doxyHighlightComment">/// calls to use Emscripten&#39;s library functions. The pass uses JavaScript&#39;s try</span></CodeLine>
<Link id="l00012" /><CodeLine lineNumber="12"><span class="doxyHighlightComment">/// and catch mechanism in case of Emscripten EH/SjLj and Wasm EH intrinsics in</span></CodeLine>
<Link id="l00013" /><CodeLine lineNumber="13"><span class="doxyHighlightComment">/// case of Emscripten SjLJ.</span></CodeLine>
<Link id="l00014" /><CodeLine lineNumber="14"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00015" /><CodeLine lineNumber="15"><span class="doxyHighlightComment">/// &#42; Emscripten exception handling</span></CodeLine>
<Link id="l00016" /><CodeLine lineNumber="16"><span class="doxyHighlightComment">/// This pass lowers invokes and landingpads into library functions in JS glue</span></CodeLine>
<Link id="l00017" /><CodeLine lineNumber="17"><span class="doxyHighlightComment">/// code. Invokes are lowered into function wrappers called invoke wrappers that</span></CodeLine>
<Link id="l00018" /><CodeLine lineNumber="18"><span class="doxyHighlightComment">/// exist in JS side, which wraps the original function call with JS try-catch.</span></CodeLine>
<Link id="l00019" /><CodeLine lineNumber="19"><span class="doxyHighlightComment">/// If an exception occurred, cxa&#95;throw() function in JS side sets some</span></CodeLine>
<Link id="l00020" /><CodeLine lineNumber="20"><span class="doxyHighlightComment">/// variables (see below) so we can check whether an exception occurred from</span></CodeLine>
<Link id="l00021" /><CodeLine lineNumber="21"><span class="doxyHighlightComment">/// wasm code and handle it appropriately.</span></CodeLine>
<Link id="l00022" /><CodeLine lineNumber="22"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00023" /><CodeLine lineNumber="23"><span class="doxyHighlightComment">/// &#42; Emscripten setjmp-longjmp handling</span></CodeLine>
<Link id="l00024" /><CodeLine lineNumber="24"><span class="doxyHighlightComment">/// This pass lowers setjmp to a reasonably-performant approach for emscripten.</span></CodeLine>
<Link id="l00025" /><CodeLine lineNumber="25"><span class="doxyHighlightComment">/// The idea is that each block with a setjmp is broken up into two parts: the</span></CodeLine>
<Link id="l00026" /><CodeLine lineNumber="26"><span class="doxyHighlightComment">/// part containing setjmp and the part right after the setjmp. The latter part</span></CodeLine>
<Link id="l00027" /><CodeLine lineNumber="27"><span class="doxyHighlightComment">/// is either reached from the setjmp, or later from a longjmp. To handle the</span></CodeLine>
<Link id="l00028" /><CodeLine lineNumber="28"><span class="doxyHighlightComment">/// longjmp, all calls that might longjmp are also called using invoke wrappers</span></CodeLine>
<Link id="l00029" /><CodeLine lineNumber="29"><span class="doxyHighlightComment">/// and thus JS / try-catch. JS longjmp() function also sets some variables so</span></CodeLine>
<Link id="l00030" /><CodeLine lineNumber="30"><span class="doxyHighlightComment">/// we can check / whether a longjmp occurred from wasm code. Each block with a</span></CodeLine>
<Link id="l00031" /><CodeLine lineNumber="31"><span class="doxyHighlightComment">/// function call that might longjmp is also split up after the longjmp call.</span></CodeLine>
<Link id="l00032" /><CodeLine lineNumber="32"><span class="doxyHighlightComment">/// After the longjmp call, we check whether a longjmp occurred, and if it did,</span></CodeLine>
<Link id="l00033" /><CodeLine lineNumber="33"><span class="doxyHighlightComment">/// which setjmp it corresponds to, and jump to the right post-setjmp block.</span></CodeLine>
<Link id="l00034" /><CodeLine lineNumber="34"><span class="doxyHighlightComment">/// We assume setjmp-longjmp handling always run after EH handling, which means</span></CodeLine>
<Link id="l00035" /><CodeLine lineNumber="35"><span class="doxyHighlightComment">/// we don&#39;t expect any exception-related instructions when SjLj runs.</span></CodeLine>
<Link id="l00036" /><CodeLine lineNumber="36"><span class="doxyHighlightComment">/// FIXME Currently this scheme does not support indirect call of setjmp,</span></CodeLine>
<Link id="l00037" /><CodeLine lineNumber="37"><span class="doxyHighlightComment">/// because of the limitation of the scheme itself. fastcomp does not support it</span></CodeLine>
<Link id="l00038" /><CodeLine lineNumber="38"><span class="doxyHighlightComment">/// either.</span></CodeLine>
<Link id="l00039" /><CodeLine lineNumber="39"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00040" /><CodeLine lineNumber="40"><span class="doxyHighlightComment">/// In detail, this pass does following things:</span></CodeLine>
<Link id="l00041" /><CodeLine lineNumber="41"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00042" /><CodeLine lineNumber="42"><span class="doxyHighlightComment">/// 1) Assumes the existence of global variables: &#95;&#95;THREW&#95;&#95;, &#95;&#95;threwValue</span></CodeLine>
<Link id="l00043" /><CodeLine lineNumber="43"><span class="doxyHighlightComment">///    &#95;&#95;THREW&#95;&#95; and &#95;&#95;threwValue are defined in compiler-rt in Emscripten.</span></CodeLine>
<Link id="l00044" /><CodeLine lineNumber="44"><span class="doxyHighlightComment">///    These variables are used for both exceptions and setjmp/longjmps.</span></CodeLine>
<Link id="l00045" /><CodeLine lineNumber="45"><span class="doxyHighlightComment">///    &#95;&#95;THREW&#95;&#95; indicates whether an exception or a longjmp occurred or not. 0</span></CodeLine>
<Link id="l00046" /><CodeLine lineNumber="46"><span class="doxyHighlightComment">///    means nothing occurred, 1 means an exception occurred, and other numbers</span></CodeLine>
<Link id="l00047" /><CodeLine lineNumber="47"><span class="doxyHighlightComment">///    mean a longjmp occurred. In the case of longjmp, &#95;&#95;THREW&#95;&#95; variable</span></CodeLine>
<Link id="l00048" /><CodeLine lineNumber="48"><span class="doxyHighlightComment">///    indicates the corresponding setjmp buffer the longjmp corresponds to.</span></CodeLine>
<Link id="l00049" /><CodeLine lineNumber="49"><span class="doxyHighlightComment">///    &#95;&#95;threwValue is 0 for exceptions, and the argument to longjmp in case of</span></CodeLine>
<Link id="l00050" /><CodeLine lineNumber="50"><span class="doxyHighlightComment">///    longjmp.</span></CodeLine>
<Link id="l00051" /><CodeLine lineNumber="51"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00052" /><CodeLine lineNumber="52"><span class="doxyHighlightComment">/// &#42; Emscripten exception handling</span></CodeLine>
<Link id="l00053" /><CodeLine lineNumber="53"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00054" /><CodeLine lineNumber="54"><span class="doxyHighlightComment">/// 2) We assume the existence of setThrew and setTempRet0/getTempRet0 functions</span></CodeLine>
<Link id="l00055" /><CodeLine lineNumber="55"><span class="doxyHighlightComment">///    at link time. setThrew exists in Emscripten&#39;s compiler-rt:</span></CodeLine>
<Link id="l00056" /><CodeLine lineNumber="56"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00057" /><CodeLine lineNumber="57"><span class="doxyHighlightComment">///    void setThrew(uintptr&#95;t threw, int value) &#123;</span></CodeLine>
<Link id="l00058" /><CodeLine lineNumber="58"><span class="doxyHighlightComment">///      if (&#95;&#95;THREW&#95;&#95; == 0) &#123;</span></CodeLine>
<Link id="l00059" /><CodeLine lineNumber="59"><span class="doxyHighlightComment">///        &#95;&#95;THREW&#95;&#95; = threw;</span></CodeLine>
<Link id="l00060" /><CodeLine lineNumber="60"><span class="doxyHighlightComment">///        &#95;&#95;threwValue = value;</span></CodeLine>
<Link id="l00061" /><CodeLine lineNumber="61"><span class="doxyHighlightComment">///      &#125;</span></CodeLine>
<Link id="l00062" /><CodeLine lineNumber="62"><span class="doxyHighlightComment">///    &#125;</span></CodeLine>
<Link id="l00063" /><CodeLine lineNumber="63"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00064" /><CodeLine lineNumber="64"><span class="doxyHighlightComment">///    setTempRet0 is called from &#95;&#95;cxa&#95;find&#95;matching&#95;catch() in JS glue code.</span></CodeLine>
<Link id="l00065" /><CodeLine lineNumber="65"><span class="doxyHighlightComment">///    In exception handling, getTempRet0 indicates the type of an exception</span></CodeLine>
<Link id="l00066" /><CodeLine lineNumber="66"><span class="doxyHighlightComment">///    caught, and in setjmp/longjmp, it means the second argument to longjmp</span></CodeLine>
<Link id="l00067" /><CodeLine lineNumber="67"><span class="doxyHighlightComment">///    function.</span></CodeLine>
<Link id="l00068" /><CodeLine lineNumber="68"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00069" /><CodeLine lineNumber="69"><span class="doxyHighlightComment">/// 3) Lower</span></CodeLine>
<Link id="l00070" /><CodeLine lineNumber="70"><span class="doxyHighlightComment">///      invoke @func(arg1, arg2) to label %invoke.cont unwind label %lpad</span></CodeLine>
<Link id="l00071" /><CodeLine lineNumber="71"><span class="doxyHighlightComment">///    into</span></CodeLine>
<Link id="l00072" /><CodeLine lineNumber="72"><span class="doxyHighlightComment">///      &#95;&#95;THREW&#95;&#95; = 0;</span></CodeLine>
<Link id="l00073" /><CodeLine lineNumber="73"><span class="doxyHighlightComment">///      call @&#95;&#95;invoke&#95;SIG(func, arg1, arg2)</span></CodeLine>
<Link id="l00074" /><CodeLine lineNumber="74"><span class="doxyHighlightComment">///      %&#95;&#95;THREW&#95;&#95;.val = &#95;&#95;THREW&#95;&#95;;</span></CodeLine>
<Link id="l00075" /><CodeLine lineNumber="75"><span class="doxyHighlightComment">///      &#95;&#95;THREW&#95;&#95; = 0;</span></CodeLine>
<Link id="l00076" /><CodeLine lineNumber="76"><span class="doxyHighlightComment">///      if (%&#95;&#95;THREW&#95;&#95;.val == 1)</span></CodeLine>
<Link id="l00077" /><CodeLine lineNumber="77"><span class="doxyHighlightComment">///        goto %lpad</span></CodeLine>
<Link id="l00078" /><CodeLine lineNumber="78"><span class="doxyHighlightComment">///      else</span></CodeLine>
<Link id="l00079" /><CodeLine lineNumber="79"><span class="doxyHighlightComment">///         goto %invoke.cont</span></CodeLine>
<Link id="l00080" /><CodeLine lineNumber="80"><span class="doxyHighlightComment">///    SIG is a mangled string generated based on the LLVM IR-level function</span></CodeLine>
<Link id="l00081" /><CodeLine lineNumber="81"><span class="doxyHighlightComment">///    signature. After LLVM IR types are lowered to the target wasm types,</span></CodeLine>
<Link id="l00082" /><CodeLine lineNumber="82"><span class="doxyHighlightComment">///    the names for these wrappers will change based on wasm types as well,</span></CodeLine>
<Link id="l00083" /><CodeLine lineNumber="83"><span class="doxyHighlightComment">///    as in invoke&#95;vi (function takes an int and returns void). The bodies of</span></CodeLine>
<Link id="l00084" /><CodeLine lineNumber="84"><span class="doxyHighlightComment">///    these wrappers will be generated in JS glue code, and inside those</span></CodeLine>
<Link id="l00085" /><CodeLine lineNumber="85"><span class="doxyHighlightComment">///    wrappers we use JS try-catch to generate actual exception effects. It</span></CodeLine>
<Link id="l00086" /><CodeLine lineNumber="86"><span class="doxyHighlightComment">///    also calls the original callee function. An example wrapper in JS code</span></CodeLine>
<Link id="l00087" /><CodeLine lineNumber="87"><span class="doxyHighlightComment">///    would look like this:</span></CodeLine>
<Link id="l00088" /><CodeLine lineNumber="88"><span class="doxyHighlightComment">///      function invoke&#95;vi(index,a1) &#123;</span></CodeLine>
<Link id="l00089" /><CodeLine lineNumber="89"><span class="doxyHighlightComment">///        try &#123;</span></CodeLine>
<Link id="l00090" /><CodeLine lineNumber="90"><span class="doxyHighlightComment">///          Module&#91;&quot;dynCall&#95;vi&quot;&#93;(index,a1); // This calls original callee</span></CodeLine>
<Link id="l00091" /><CodeLine lineNumber="91"><span class="doxyHighlightComment">///        &#125; catch(e) &#123;</span></CodeLine>
<Link id="l00092" /><CodeLine lineNumber="92"><span class="doxyHighlightComment">///          if (typeof e !== &#39;number&#39; &amp;&amp; e !== &#39;longjmp&#39;) throw e;</span></CodeLine>
<Link id="l00093" /><CodeLine lineNumber="93"><span class="doxyHighlightComment">///          &#95;setThrew(1, 0); // setThrew is called here</span></CodeLine>
<Link id="l00094" /><CodeLine lineNumber="94"><span class="doxyHighlightComment">///        &#125;</span></CodeLine>
<Link id="l00095" /><CodeLine lineNumber="95"><span class="doxyHighlightComment">///      &#125;</span></CodeLine>
<Link id="l00096" /><CodeLine lineNumber="96"><span class="doxyHighlightComment">///    If an exception is thrown, &#95;&#95;THREW&#95;&#95; will be set to true in a wrapper,</span></CodeLine>
<Link id="l00097" /><CodeLine lineNumber="97"><span class="doxyHighlightComment">///    so we can jump to the right BB based on this value.</span></CodeLine>
<Link id="l00098" /><CodeLine lineNumber="98"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00099" /><CodeLine lineNumber="99"><span class="doxyHighlightComment">/// 4) Lower</span></CodeLine>
<Link id="l00100" /><CodeLine lineNumber="100"><span class="doxyHighlightComment">///      %val = landingpad catch c1 catch c2 catch c3 ...</span></CodeLine>
<Link id="l00101" /><CodeLine lineNumber="101"><span class="doxyHighlightComment">///      ... use %val ...</span></CodeLine>
<Link id="l00102" /><CodeLine lineNumber="102"><span class="doxyHighlightComment">///    into</span></CodeLine>
<Link id="l00103" /><CodeLine lineNumber="103"><span class="doxyHighlightComment">///      %fmc = call @&#95;&#95;cxa&#95;find&#95;matching&#95;catch&#95;N(c1, c2, c3, ...)</span></CodeLine>
<Link id="l00104" /><CodeLine lineNumber="104"><span class="doxyHighlightComment">///      %val = &#123;%fmc, getTempRet0()&#125;</span></CodeLine>
<Link id="l00105" /><CodeLine lineNumber="105"><span class="doxyHighlightComment">///      ... use %val ...</span></CodeLine>
<Link id="l00106" /><CodeLine lineNumber="106"><span class="doxyHighlightComment">///    Here N is a number calculated based on the number of clauses.</span></CodeLine>
<Link id="l00107" /><CodeLine lineNumber="107"><span class="doxyHighlightComment">///    setTempRet0 is called from &#95;&#95;cxa&#95;find&#95;matching&#95;catch() in JS glue code.</span></CodeLine>
<Link id="l00108" /><CodeLine lineNumber="108"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00109" /><CodeLine lineNumber="109"><span class="doxyHighlightComment">/// 5) Lower</span></CodeLine>
<Link id="l00110" /><CodeLine lineNumber="110"><span class="doxyHighlightComment">///      resume &#123;%a, %b&#125;</span></CodeLine>
<Link id="l00111" /><CodeLine lineNumber="111"><span class="doxyHighlightComment">///    into</span></CodeLine>
<Link id="l00112" /><CodeLine lineNumber="112"><span class="doxyHighlightComment">///      call @&#95;&#95;resumeException(%a)</span></CodeLine>
<Link id="l00113" /><CodeLine lineNumber="113"><span class="doxyHighlightComment">///    where &#95;&#95;resumeException() is a function in JS glue code.</span></CodeLine>
<Link id="l00114" /><CodeLine lineNumber="114"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00115" /><CodeLine lineNumber="115"><span class="doxyHighlightComment">/// 6) Lower</span></CodeLine>
<Link id="l00116" /><CodeLine lineNumber="116"><span class="doxyHighlightComment">///      call @llvm.eh.typeid.for(type) (intrinsic)</span></CodeLine>
<Link id="l00117" /><CodeLine lineNumber="117"><span class="doxyHighlightComment">///    into</span></CodeLine>
<Link id="l00118" /><CodeLine lineNumber="118"><span class="doxyHighlightComment">///      call @llvm&#95;eh&#95;typeid&#95;for(type)</span></CodeLine>
<Link id="l00119" /><CodeLine lineNumber="119"><span class="doxyHighlightComment">///    llvm&#95;eh&#95;typeid&#95;for function will be generated in JS glue code.</span></CodeLine>
<Link id="l00120" /><CodeLine lineNumber="120"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00121" /><CodeLine lineNumber="121"><span class="doxyHighlightComment">/// &#42; Emscripten setjmp / longjmp handling</span></CodeLine>
<Link id="l00122" /><CodeLine lineNumber="122"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00123" /><CodeLine lineNumber="123"><span class="doxyHighlightComment">/// If there are calls to longjmp()</span></CodeLine>
<Link id="l00124" /><CodeLine lineNumber="124"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00125" /><CodeLine lineNumber="125"><span class="doxyHighlightComment">/// 1) Lower</span></CodeLine>
<Link id="l00126" /><CodeLine lineNumber="126"><span class="doxyHighlightComment">///      longjmp(env, val)</span></CodeLine>
<Link id="l00127" /><CodeLine lineNumber="127"><span class="doxyHighlightComment">///    into</span></CodeLine>
<Link id="l00128" /><CodeLine lineNumber="128"><span class="doxyHighlightComment">///      emscripten&#95;longjmp(env, val)</span></CodeLine>
<Link id="l00129" /><CodeLine lineNumber="129"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00130" /><CodeLine lineNumber="130"><span class="doxyHighlightComment">/// If there are calls to setjmp()</span></CodeLine>
<Link id="l00131" /><CodeLine lineNumber="131"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00132" /><CodeLine lineNumber="132"><span class="doxyHighlightComment">/// 2) In the function entry that calls setjmp, initialize</span></CodeLine>
<Link id="l00133" /><CodeLine lineNumber="133"><span class="doxyHighlightComment">///    functionInvocationId as follows:</span></CodeLine>
<Link id="l00134" /><CodeLine lineNumber="134"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00135" /><CodeLine lineNumber="135"><span class="doxyHighlightComment">///    functionInvocationId = alloca(4)</span></CodeLine>
<Link id="l00136" /><CodeLine lineNumber="136"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00137" /><CodeLine lineNumber="137"><span class="doxyHighlightComment">///    Note: the alloca size is not important as this pointer is</span></CodeLine>
<Link id="l00138" /><CodeLine lineNumber="138"><span class="doxyHighlightComment">///    merely used for pointer comparisions.</span></CodeLine>
<Link id="l00139" /><CodeLine lineNumber="139"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00140" /><CodeLine lineNumber="140"><span class="doxyHighlightComment">/// 3) Lower</span></CodeLine>
<Link id="l00141" /><CodeLine lineNumber="141"><span class="doxyHighlightComment">///      setjmp(env)</span></CodeLine>
<Link id="l00142" /><CodeLine lineNumber="142"><span class="doxyHighlightComment">///    into</span></CodeLine>
<Link id="l00143" /><CodeLine lineNumber="143"><span class="doxyHighlightComment">///      &#95;&#95;wasm&#95;setjmp(env, label, functionInvocationId)</span></CodeLine>
<Link id="l00144" /><CodeLine lineNumber="144"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00145" /><CodeLine lineNumber="145"><span class="doxyHighlightComment">///    &#95;&#95;wasm&#95;setjmp records the necessary info (the label and</span></CodeLine>
<Link id="l00146" /><CodeLine lineNumber="146"><span class="doxyHighlightComment">///    functionInvocationId) to the &quot;env&quot;.</span></CodeLine>
<Link id="l00147" /><CodeLine lineNumber="147"><span class="doxyHighlightComment">///    A BB with setjmp is split into two after setjmp call in order to</span></CodeLine>
<Link id="l00148" /><CodeLine lineNumber="148"><span class="doxyHighlightComment">///    make the post-setjmp BB the possible destination of longjmp BB.</span></CodeLine>
<Link id="l00149" /><CodeLine lineNumber="149"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00150" /><CodeLine lineNumber="150"><span class="doxyHighlightComment">/// 4) Lower every call that might longjmp into</span></CodeLine>
<Link id="l00151" /><CodeLine lineNumber="151"><span class="doxyHighlightComment">///      &#95;&#95;THREW&#95;&#95; = 0;</span></CodeLine>
<Link id="l00152" /><CodeLine lineNumber="152"><span class="doxyHighlightComment">///      call @&#95;&#95;invoke&#95;SIG(func, arg1, arg2)</span></CodeLine>
<Link id="l00153" /><CodeLine lineNumber="153"><span class="doxyHighlightComment">///      %&#95;&#95;THREW&#95;&#95;.val = &#95;&#95;THREW&#95;&#95;;</span></CodeLine>
<Link id="l00154" /><CodeLine lineNumber="154"><span class="doxyHighlightComment">///      &#95;&#95;THREW&#95;&#95; = 0;</span></CodeLine>
<Link id="l00155" /><CodeLine lineNumber="155"><span class="doxyHighlightComment">///      %&#95;&#95;threwValue.val = &#95;&#95;threwValue;</span></CodeLine>
<Link id="l00156" /><CodeLine lineNumber="156"><span class="doxyHighlightComment">///      if (%&#95;&#95;THREW&#95;&#95;.val != 0 &amp; %&#95;&#95;threwValue.val != 0) &#123;</span></CodeLine>
<Link id="l00157" /><CodeLine lineNumber="157"><span class="doxyHighlightComment">///        %label = &#95;&#95;wasm&#95;setjmp&#95;test(%&#95;&#95;THREW&#95;&#95;.val, functionInvocationId);</span></CodeLine>
<Link id="l00158" /><CodeLine lineNumber="158"><span class="doxyHighlightComment">///        if (%label == 0)</span></CodeLine>
<Link id="l00159" /><CodeLine lineNumber="159"><span class="doxyHighlightComment">///          emscripten&#95;longjmp(%&#95;&#95;THREW&#95;&#95;.val, %&#95;&#95;threwValue.val);</span></CodeLine>
<Link id="l00160" /><CodeLine lineNumber="160"><span class="doxyHighlightComment">///        setTempRet0(%&#95;&#95;threwValue.val);</span></CodeLine>
<Link id="l00161" /><CodeLine lineNumber="161"><span class="doxyHighlightComment">///      &#125; else &#123;</span></CodeLine>
<Link id="l00162" /><CodeLine lineNumber="162"><span class="doxyHighlightComment">///        %label = -1;</span></CodeLine>
<Link id="l00163" /><CodeLine lineNumber="163"><span class="doxyHighlightComment">///      &#125;</span></CodeLine>
<Link id="l00164" /><CodeLine lineNumber="164"><span class="doxyHighlightComment">///      longjmp&#95;result = getTempRet0();</span></CodeLine>
<Link id="l00165" /><CodeLine lineNumber="165"><span class="doxyHighlightComment">///      switch %label &#123;</span></CodeLine>
<Link id="l00166" /><CodeLine lineNumber="166"><span class="doxyHighlightComment">///        label 1: goto post-setjmp BB 1</span></CodeLine>
<Link id="l00167" /><CodeLine lineNumber="167"><span class="doxyHighlightComment">///        label 2: goto post-setjmp BB 2</span></CodeLine>
<Link id="l00168" /><CodeLine lineNumber="168"><span class="doxyHighlightComment">///        ...</span></CodeLine>
<Link id="l00169" /><CodeLine lineNumber="169"><span class="doxyHighlightComment">///        default: goto splitted next BB</span></CodeLine>
<Link id="l00170" /><CodeLine lineNumber="170"><span class="doxyHighlightComment">///      &#125;</span></CodeLine>
<Link id="l00171" /><CodeLine lineNumber="171"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00172" /><CodeLine lineNumber="172"><span class="doxyHighlightComment">///    &#95;&#95;wasm&#95;setjmp&#95;test examines the jmp buf to see if it was for a matching</span></CodeLine>
<Link id="l00173" /><CodeLine lineNumber="173"><span class="doxyHighlightComment">///    setjmp call. After calling an invoke wrapper, if a longjmp occurred,</span></CodeLine>
<Link id="l00174" /><CodeLine lineNumber="174"><span class="doxyHighlightComment">///    &#95;&#95;THREW&#95;&#95; will be the address of matching jmp&#95;buf buffer and</span></CodeLine>
<Link id="l00175" /><CodeLine lineNumber="175"><span class="doxyHighlightComment">///    &#95;&#95;threwValue be the second argument to longjmp.</span></CodeLine>
<Link id="l00176" /><CodeLine lineNumber="176"><span class="doxyHighlightComment">///    &#95;&#95;wasm&#95;setjmp&#95;test returns a setjmp label, a unique ID to each setjmp</span></CodeLine>
<Link id="l00177" /><CodeLine lineNumber="177"><span class="doxyHighlightComment">///    callsite. Label 0 means this longjmp buffer does not correspond to one</span></CodeLine>
<Link id="l00178" /><CodeLine lineNumber="178"><span class="doxyHighlightComment">///    of the setjmp callsites in this function, so in this case we just chain</span></CodeLine>
<Link id="l00179" /><CodeLine lineNumber="179"><span class="doxyHighlightComment">///    the longjmp to the caller. Label -1 means no longjmp occurred.</span></CodeLine>
<Link id="l00180" /><CodeLine lineNumber="180"><span class="doxyHighlightComment">///    Otherwise we jump to the right post-setjmp BB based on the label.</span></CodeLine>
<Link id="l00181" /><CodeLine lineNumber="181"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00182" /><CodeLine lineNumber="182"><span class="doxyHighlightComment">/// &#42; Wasm setjmp / longjmp handling</span></CodeLine>
<Link id="l00183" /><CodeLine lineNumber="183"><span class="doxyHighlightComment">/// This mode still uses some Emscripten library functions but not JavaScript&#39;s</span></CodeLine>
<Link id="l00184" /><CodeLine lineNumber="184"><span class="doxyHighlightComment">/// try-catch mechanism. It instead uses Wasm exception handling intrinsics,</span></CodeLine>
<Link id="l00185" /><CodeLine lineNumber="185"><span class="doxyHighlightComment">/// which will be lowered to exception handling instructions.</span></CodeLine>
<Link id="l00186" /><CodeLine lineNumber="186"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00187" /><CodeLine lineNumber="187"><span class="doxyHighlightComment">/// If there are calls to longjmp()</span></CodeLine>
<Link id="l00188" /><CodeLine lineNumber="188"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00189" /><CodeLine lineNumber="189"><span class="doxyHighlightComment">/// 1) Lower</span></CodeLine>
<Link id="l00190" /><CodeLine lineNumber="190"><span class="doxyHighlightComment">///      longjmp(env, val)</span></CodeLine>
<Link id="l00191" /><CodeLine lineNumber="191"><span class="doxyHighlightComment">///    into</span></CodeLine>
<Link id="l00192" /><CodeLine lineNumber="192"><span class="doxyHighlightComment">///      &#95;&#95;wasm&#95;longjmp(env, val)</span></CodeLine>
<Link id="l00193" /><CodeLine lineNumber="193"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00194" /><CodeLine lineNumber="194"><span class="doxyHighlightComment">/// If there are calls to setjmp()</span></CodeLine>
<Link id="l00195" /><CodeLine lineNumber="195"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00196" /><CodeLine lineNumber="196"><span class="doxyHighlightComment">/// 2) and 3): The same as 2) and 3) in Emscripten SjLj.</span></CodeLine>
<Link id="l00197" /><CodeLine lineNumber="197"><span class="doxyHighlightComment">/// (functionInvocationId initialization + setjmp callsite transformation)</span></CodeLine>
<Link id="l00198" /><CodeLine lineNumber="198"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00199" /><CodeLine lineNumber="199"><span class="doxyHighlightComment">/// 4) Create a catchpad with a wasm.catch() intrinsic, which returns the value</span></CodeLine>
<Link id="l00200" /><CodeLine lineNumber="200"><span class="doxyHighlightComment">/// thrown by &#95;&#95;wasm&#95;longjmp function. In the runtime library, we have an</span></CodeLine>
<Link id="l00201" /><CodeLine lineNumber="201"><span class="doxyHighlightComment">/// equivalent of the following struct:</span></CodeLine>
<Link id="l00202" /><CodeLine lineNumber="202"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00203" /><CodeLine lineNumber="203"><span class="doxyHighlightComment">/// struct &#95;&#95;WasmLongjmpArgs &#123;</span></CodeLine>
<Link id="l00204" /><CodeLine lineNumber="204"><span class="doxyHighlightComment">///   void &#42;env;</span></CodeLine>
<Link id="l00205" /><CodeLine lineNumber="205"><span class="doxyHighlightComment">///   int val;</span></CodeLine>
<Link id="l00206" /><CodeLine lineNumber="206"><span class="doxyHighlightComment">/// &#125;;</span></CodeLine>
<Link id="l00207" /><CodeLine lineNumber="207"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00208" /><CodeLine lineNumber="208"><span class="doxyHighlightComment">/// The thrown value here is a pointer to the struct. We use this struct to</span></CodeLine>
<Link id="l00209" /><CodeLine lineNumber="209"><span class="doxyHighlightComment">/// transfer two values by throwing a single value. Wasm throw and catch</span></CodeLine>
<Link id="l00210" /><CodeLine lineNumber="210"><span class="doxyHighlightComment">/// instructions are capable of throwing and catching multiple values, but</span></CodeLine>
<Link id="l00211" /><CodeLine lineNumber="211"><span class="doxyHighlightComment">/// it also requires multivalue support that is currently not very reliable.</span></CodeLine>
<Link id="l00212" /><CodeLine lineNumber="212"><span class="doxyHighlightComment">/// TODO Switch to throwing and catching two values without using the struct</span></CodeLine>
<Link id="l00213" /><CodeLine lineNumber="213"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00214" /><CodeLine lineNumber="214"><span class="doxyHighlightComment">/// All longjmpable function calls will be converted to an invoke that will</span></CodeLine>
<Link id="l00215" /><CodeLine lineNumber="215"><span class="doxyHighlightComment">/// unwind to this catchpad in case a longjmp occurs. Within the catchpad, we</span></CodeLine>
<Link id="l00216" /><CodeLine lineNumber="216"><span class="doxyHighlightComment">/// test the thrown values using &#95;&#95;wasm&#95;setjmp&#95;test function as we do for</span></CodeLine>
<Link id="l00217" /><CodeLine lineNumber="217"><span class="doxyHighlightComment">/// Emscripten SjLj. The main difference is, in Emscripten SjLj, we need to</span></CodeLine>
<Link id="l00218" /><CodeLine lineNumber="218"><span class="doxyHighlightComment">/// transform every longjmpable callsite into a sequence of code including</span></CodeLine>
<Link id="l00219" /><CodeLine lineNumber="219"><span class="doxyHighlightComment">/// &#95;&#95;wasm&#95;setjmp&#95;test() call; in Wasm SjLj we do the testing in only one</span></CodeLine>
<Link id="l00220" /><CodeLine lineNumber="220"><span class="doxyHighlightComment">/// place, in this catchpad.</span></CodeLine>
<Link id="l00221" /><CodeLine lineNumber="221"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00222" /><CodeLine lineNumber="222"><span class="doxyHighlightComment">/// After testing calling &#95;&#95;wasm&#95;setjmp&#95;test(), if the longjmp does not</span></CodeLine>
<Link id="l00223" /><CodeLine lineNumber="223"><span class="doxyHighlightComment">/// correspond to one of the setjmps within the current function, it rethrows</span></CodeLine>
<Link id="l00224" /><CodeLine lineNumber="224"><span class="doxyHighlightComment">/// the longjmp by calling &#95;&#95;wasm&#95;longjmp(). If it corresponds to one of</span></CodeLine>
<Link id="l00225" /><CodeLine lineNumber="225"><span class="doxyHighlightComment">/// setjmps in the function, we jump to the beginning of the function, which</span></CodeLine>
<Link id="l00226" /><CodeLine lineNumber="226"><span class="doxyHighlightComment">/// contains a switch to each post-setjmp BB. Again, in Emscripten SjLj, this</span></CodeLine>
<Link id="l00227" /><CodeLine lineNumber="227"><span class="doxyHighlightComment">/// switch is added for every longjmpable callsite; in Wasm SjLj we do this</span></CodeLine>
<Link id="l00228" /><CodeLine lineNumber="228"><span class="doxyHighlightComment">/// only once at the top of the function. (after functionInvocationId</span></CodeLine>
<Link id="l00229" /><CodeLine lineNumber="229"><span class="doxyHighlightComment">/// initialization)</span></CodeLine>
<Link id="l00230" /><CodeLine lineNumber="230"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00231" /><CodeLine lineNumber="231"><span class="doxyHighlightComment">/// The below is the pseudocode for what we have described</span></CodeLine>
<Link id="l00232" /><CodeLine lineNumber="232"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00233" /><CodeLine lineNumber="233"><span class="doxyHighlightComment">/// entry:</span></CodeLine>
<Link id="l00234" /><CodeLine lineNumber="234"><span class="doxyHighlightComment">///   Initialize functionInvocationId</span></CodeLine>
<Link id="l00235" /><CodeLine lineNumber="235"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00236" /><CodeLine lineNumber="236"><span class="doxyHighlightComment">/// setjmp.dispatch:</span></CodeLine>
<Link id="l00237" /><CodeLine lineNumber="237"><span class="doxyHighlightComment">///    switch %label &#123;</span></CodeLine>
<Link id="l00238" /><CodeLine lineNumber="238"><span class="doxyHighlightComment">///      label 1: goto post-setjmp BB 1</span></CodeLine>
<Link id="l00239" /><CodeLine lineNumber="239"><span class="doxyHighlightComment">///      label 2: goto post-setjmp BB 2</span></CodeLine>
<Link id="l00240" /><CodeLine lineNumber="240"><span class="doxyHighlightComment">///      ...</span></CodeLine>
<Link id="l00241" /><CodeLine lineNumber="241"><span class="doxyHighlightComment">///      default: goto splitted next BB</span></CodeLine>
<Link id="l00242" /><CodeLine lineNumber="242"><span class="doxyHighlightComment">///    &#125;</span></CodeLine>
<Link id="l00243" /><CodeLine lineNumber="243"><span class="doxyHighlightComment">/// ...</span></CodeLine>
<Link id="l00244" /><CodeLine lineNumber="244"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00245" /><CodeLine lineNumber="245"><span class="doxyHighlightComment">/// bb:</span></CodeLine>
<Link id="l00246" /><CodeLine lineNumber="246"><span class="doxyHighlightComment">///   invoke void @foo() ;; foo is a longjmpable function</span></CodeLine>
<Link id="l00247" /><CodeLine lineNumber="247"><span class="doxyHighlightComment">///     to label %next unwind label %catch.dispatch.longjmp</span></CodeLine>
<Link id="l00248" /><CodeLine lineNumber="248"><span class="doxyHighlightComment">/// ...</span></CodeLine>
<Link id="l00249" /><CodeLine lineNumber="249"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00250" /><CodeLine lineNumber="250"><span class="doxyHighlightComment">/// catch.dispatch.longjmp:</span></CodeLine>
<Link id="l00251" /><CodeLine lineNumber="251"><span class="doxyHighlightComment">///   %0 = catchswitch within none &#91;label %catch.longjmp&#93; unwind to caller</span></CodeLine>
<Link id="l00252" /><CodeLine lineNumber="252"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00253" /><CodeLine lineNumber="253"><span class="doxyHighlightComment">/// catch.longjmp:</span></CodeLine>
<Link id="l00254" /><CodeLine lineNumber="254"><span class="doxyHighlightComment">///   %longjmp.args = wasm.catch() ;; struct &#95;&#95;WasmLongjmpArgs</span></CodeLine>
<Link id="l00255" /><CodeLine lineNumber="255"><span class="doxyHighlightComment">///   %env = load &#39;env&#39; field from &#95;&#95;WasmLongjmpArgs</span></CodeLine>
<Link id="l00256" /><CodeLine lineNumber="256"><span class="doxyHighlightComment">///   %val = load &#39;val&#39; field from &#95;&#95;WasmLongjmpArgs</span></CodeLine>
<Link id="l00257" /><CodeLine lineNumber="257"><span class="doxyHighlightComment">///   %label = &#95;&#95;wasm&#95;setjmp&#95;test(%env, functionInvocationId);</span></CodeLine>
<Link id="l00258" /><CodeLine lineNumber="258"><span class="doxyHighlightComment">///   if (%label == 0)</span></CodeLine>
<Link id="l00259" /><CodeLine lineNumber="259"><span class="doxyHighlightComment">///     &#95;&#95;wasm&#95;longjmp(%env, %val)</span></CodeLine>
<Link id="l00260" /><CodeLine lineNumber="260"><span class="doxyHighlightComment">///   catchret to %setjmp.dispatch</span></CodeLine>
<Link id="l00261" /><CodeLine lineNumber="261"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00262" /><CodeLine lineNumber="262"><span class="doxyHighlightComment">///===----------------------------------------------------------------------===//</span></CodeLine>
<Link id="l00263" /><CodeLine lineNumber="263"></CodeLine>
<Link id="l00264" /><CodeLine lineNumber="264"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/lib/lib/target/lib/target/webassembly/lib/target/webassembly/mctargetdesc/webassemblymctargetdesc-h">MCTargetDesc/WebAssemblyMCTargetDesc.h</a>&quot;</span></CodeLine>
<Link id="l00265" /><CodeLine lineNumber="265"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/lib/lib/target/lib/target/webassembly/webassembly-h">WebAssembly.h</a>&quot;</span></CodeLine>
<Link id="l00266" /><CodeLine lineNumber="266"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/lib/lib/target/lib/target/webassembly/webassemblytargetmachine-h">WebAssemblyTargetMachine.h</a>&quot;</span></CodeLine>
<Link id="l00267" /><CodeLine lineNumber="267"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/stringextras-h">llvm/ADT/StringExtras.h</a>&quot;</span></CodeLine>
<Link id="l00268" /><CodeLine lineNumber="268"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/targetpassconfig-h">llvm/CodeGen/TargetPassConfig.h</a>&quot;</span></CodeLine>
<Link id="l00269" /><CodeLine lineNumber="269"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/wasmehfuncinfo-h">llvm/CodeGen/WasmEHFuncInfo.h</a>&quot;</span></CodeLine>
<Link id="l00270" /><CodeLine lineNumber="270"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/debuginfometadata-h">llvm/IR/DebugInfoMetadata.h</a>&quot;</span></CodeLine>
<Link id="l00271" /><CodeLine lineNumber="271"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/dominators-h">llvm/IR/Dominators.h</a>&quot;</span></CodeLine>
<Link id="l00272" /><CodeLine lineNumber="272"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/irbuilder-h">llvm/IR/IRBuilder.h</a>&quot;</span></CodeLine>
<Link id="l00273" /><CodeLine lineNumber="273"><span class="doxyHighlightPreprocessor">#include &quot;llvm/IR/IntrinsicsWebAssembly.h&quot;</span></CodeLine>
<Link id="l00274" /><CodeLine lineNumber="274"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/module-h">llvm/IR/Module.h</a>&quot;</span></CodeLine>
<Link id="l00275" /><CodeLine lineNumber="275"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h">llvm/Support/CommandLine.h</a>&quot;</span></CodeLine>
<Link id="l00276" /><CodeLine lineNumber="276"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/basicblockutils-h">llvm/Transforms/Utils/BasicBlockUtils.h</a>&quot;</span></CodeLine>
<Link id="l00277" /><CodeLine lineNumber="277"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/local-h">llvm/Transforms/Utils/Local.h</a>&quot;</span></CodeLine>
<Link id="l00278" /><CodeLine lineNumber="278"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/ssaupdater-h">llvm/Transforms/Utils/SSAUpdater.h</a>&quot;</span></CodeLine>
<Link id="l00279" /><CodeLine lineNumber="279"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/ssaupdaterbulk-h">llvm/Transforms/Utils/SSAUpdaterBulk.h</a>&quot;</span></CodeLine>
<Link id="l00280" /><CodeLine lineNumber="280"><span class="doxyHighlightPreprocessor">#include &lt;set&gt;</span></CodeLine>
<Link id="l00281" /><CodeLine lineNumber="281"></CodeLine>
<Link id="l00282" /><CodeLine lineNumber="282"><span class="doxyHighlightKeyword">using namespace </span><span class="doxyHighlight"><a href="/docs/api/namespaces/llvm">llvm</a>;</span></CodeLine>
<Link id="l00283" /><CodeLine lineNumber="283"></CodeLine>
<Link id="l00284" /><CodeLine lineNumber="284" lineLink="#ad78e062f62e0d6e453941fb4ca843e4d"><span class="doxyHighlightPreprocessor">#define DEBUG&#95;TYPE &quot;wasm-lower-em-ehsjlj&quot;</span></CodeLine>
<Link id="l00285" /><CodeLine lineNumber="285"></CodeLine>
<Link id="l00286" /><CodeLine lineNumber="286"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/list">cl::list&lt;std::string&gt;</a></span></CodeLine>
<Link id="l00287" /><CodeLine lineNumber="287" lineLink="#a41b437d912a1d2b4bf65ef8da79f8298"><span class="doxyHighlight">    <a href="#a41b437d912a1d2b4bf65ef8da79f8298">EHAllowlist</a>(</span><span class="doxyHighlightStringLiteral">&quot;emscripten-cxx-exceptions-allowed&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00288" /><CodeLine lineNumber="288"><span class="doxyHighlight">                <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;The list of function names in which Emscripten-style &quot;</span></CodeLine>
<Link id="l00289" /><CodeLine lineNumber="289"><span class="doxyHighlight">                         </span><span class="doxyHighlightStringLiteral">&quot;exception handling is enabled (see emscripten &quot;</span></CodeLine>
<Link id="l00290" /><CodeLine lineNumber="290"><span class="doxyHighlight">                         </span><span class="doxyHighlightStringLiteral">&quot;EMSCRIPTEN&#95;CATCHING&#95;ALLOWED options)&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00291" /><CodeLine lineNumber="291"><span class="doxyHighlight">                <a href="/docs/api/namespaces/llvm/cl/#ac96f30ba8b117dbd380b88ab8a03732baa2d228ea7bc126361de56c03e7edc3a8">cl::CommaSeparated</a>);</span></CodeLine>
<Link id="l00292" /><CodeLine lineNumber="292"></CodeLine>
<Link id="l00293" /><CodeLine lineNumber="293" lineLink="/docs/api/namespaces/anonymous-webassemblyloweremscriptenehsjlj-cpp-"><span class="doxyHighlightKeyword">namespace </span><span class="doxyHighlight">&#123;</span></CodeLine>
<Link id="l00294" /><CodeLine lineNumber="294" lineLink="/docs/api/classes/anonymous-namespace-webassemblyloweremscriptenehsjlj-cpp-/webassemblyloweremscriptenehsjlj"><span class="doxyHighlightKeyword">class </span><span class="doxyHighlight"><a href="/docs/api/classes/anonymous-namespace-webassemblyloweremscriptenehsjlj-cpp-/webassemblyloweremscriptenehsjlj/#a91ebaff00e920636b96b48430ee7bb1d">WebAssemblyLowerEmscriptenEHSjLj</a> final : </span><span class="doxyHighlightKeyword">public</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/modulepass/#a723659a08d210f4f566887bda3f9f976">ModulePass</a> &#123;</span></CodeLine>
<Link id="l00295" /><CodeLine lineNumber="295"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> EnableEmEH;     </span><span class="doxyHighlightComment">// Enable Emscripten exception handling</span></CodeLine>
<Link id="l00296" /><CodeLine lineNumber="296"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> EnableEmSjLj;   </span><span class="doxyHighlightComment">// Enable Emscripten setjmp/longjmp handling</span></CodeLine>
<Link id="l00297" /><CodeLine lineNumber="297"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> EnableWasmSjLj; </span><span class="doxyHighlightComment">// Enable Wasm setjmp/longjmp handling</span></CodeLine>
<Link id="l00298" /><CodeLine lineNumber="298"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> DoSjLj;         </span><span class="doxyHighlightComment">// Whether we actually perform setjmp/longjmp handling</span></CodeLine>
<Link id="l00299" /><CodeLine lineNumber="299"></CodeLine>
<Link id="l00300" /><CodeLine lineNumber="300"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/globalvariable">GlobalVariable</a> &#42;ThrewGV = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;      </span><span class="doxyHighlightComment">// &#95;&#95;THREW&#95;&#95; (Emscripten)</span></CodeLine>
<Link id="l00301" /><CodeLine lineNumber="301"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/globalvariable">GlobalVariable</a> &#42;ThrewValueGV = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">; </span><span class="doxyHighlightComment">// &#95;&#95;threwValue (Emscripten)</span></CodeLine>
<Link id="l00302" /><CodeLine lineNumber="302"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;GetTempRet0F = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;       </span><span class="doxyHighlightComment">// getTempRet0() (Emscripten)</span></CodeLine>
<Link id="l00303" /><CodeLine lineNumber="303"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;SetTempRet0F = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;       </span><span class="doxyHighlightComment">// setTempRet0() (Emscripten)</span></CodeLine>
<Link id="l00304" /><CodeLine lineNumber="304"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;ResumeF = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;            </span><span class="doxyHighlightComment">// &#95;&#95;resumeException() (Emscripten)</span></CodeLine>
<Link id="l00305" /><CodeLine lineNumber="305"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;EHTypeIDF = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;          </span><span class="doxyHighlightComment">// llvm.eh.typeid.for() (intrinsic)</span></CodeLine>
<Link id="l00306" /><CodeLine lineNumber="306"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;EmLongjmpF = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;         </span><span class="doxyHighlightComment">// emscripten&#95;longjmp() (Emscripten)</span></CodeLine>
<Link id="l00307" /><CodeLine lineNumber="307"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;WasmSetjmpF = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;        </span><span class="doxyHighlightComment">// &#95;&#95;wasm&#95;setjmp() (Emscripten)</span></CodeLine>
<Link id="l00308" /><CodeLine lineNumber="308"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;WasmSetjmpTestF = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;    </span><span class="doxyHighlightComment">// &#95;&#95;wasm&#95;setjmp&#95;test() (Emscripten)</span></CodeLine>
<Link id="l00309" /><CodeLine lineNumber="309"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;WasmLongjmpF = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;       </span><span class="doxyHighlightComment">// &#95;&#95;wasm&#95;longjmp() (Emscripten)</span></CodeLine>
<Link id="l00310" /><CodeLine lineNumber="310"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;CatchF = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;             </span><span class="doxyHighlightComment">// wasm.catch() (intrinsic)</span></CodeLine>
<Link id="l00311" /><CodeLine lineNumber="311"></CodeLine>
<Link id="l00312" /><CodeLine lineNumber="312"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// type of &#39;struct &#95;&#95;WasmLongjmpArgs&#39; defined in emscripten</span></CodeLine>
<Link id="l00313" /><CodeLine lineNumber="313"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/type">Type</a> &#42;LongjmpArgsTy = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00314" /><CodeLine lineNumber="314"></CodeLine>
<Link id="l00315" /><CodeLine lineNumber="315"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// &#95;&#95;cxa&#95;find&#95;matching&#95;catch&#95;N functions.</span></CodeLine>
<Link id="l00316" /><CodeLine lineNumber="316"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Indexed by the number of clauses in an original landingpad instruction.</span></CodeLine>
<Link id="l00317" /><CodeLine lineNumber="317"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/densemap">DenseMap&lt;int, Function &#42;&gt;</a> FindMatchingCatches;</span></CodeLine>
<Link id="l00318" /><CodeLine lineNumber="318"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Map of &lt;function signature string, invoke&#95; wrappers&gt;</span></CodeLine>
<Link id="l00319" /><CodeLine lineNumber="319"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/stringmap">StringMap&lt;Function &#42;&gt;</a> InvokeWrappers;</span></CodeLine>
<Link id="l00320" /><CodeLine lineNumber="320"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Set of allowed function names for exception handling</span></CodeLine>
<Link id="l00321" /><CodeLine lineNumber="321"><span class="doxyHighlight">  std::set&lt;std::string, std::less&lt;&gt;&gt; EHAllowlistSet;</span></CodeLine>
<Link id="l00322" /><CodeLine lineNumber="322"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Functions that contains calls to setjmp</span></CodeLine>
<Link id="l00323" /><CodeLine lineNumber="323"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;Function &#42;, 8&gt;</a> SetjmpUsers;</span></CodeLine>
<Link id="l00324" /><CodeLine lineNumber="324"></CodeLine>
<Link id="l00325" /><CodeLine lineNumber="325"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/stringref">StringRef</a> getPassName()</span><span class="doxyHighlightKeyword"> const override </span><span class="doxyHighlight">&#123;</span></CodeLine>
<Link id="l00326" /><CodeLine lineNumber="326"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightStringLiteral">&quot;WebAssembly Lower Emscripten Exceptions&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00327" /><CodeLine lineNumber="327"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00328" /><CodeLine lineNumber="328"></CodeLine>
<Link id="l00329" /><CodeLine lineNumber="329"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">using </span><span class="doxyHighlight">InstVector = <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;Instruction &#42;&gt;</a>;</span></CodeLine>
<Link id="l00330" /><CodeLine lineNumber="330"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> runEHOnFunction(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l00331" /><CodeLine lineNumber="331"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> runSjLjOnFunction(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l00332" /><CodeLine lineNumber="332"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> handleLongjmpableCallsForEmscriptenSjLj(</span></CodeLine>
<Link id="l00333" /><CodeLine lineNumber="333"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;FunctionInvocationId,</span></CodeLine>
<Link id="l00334" /><CodeLine lineNumber="334"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;PHINode &#42;&gt;</a> &amp;SetjmpRetPHIs);</span></CodeLine>
<Link id="l00335" /><CodeLine lineNumber="335"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span></CodeLine>
<Link id="l00336" /><CodeLine lineNumber="336"><span class="doxyHighlight">  handleLongjmpableCallsForWasmSjLj(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>,</span></CodeLine>
<Link id="l00337" /><CodeLine lineNumber="337"><span class="doxyHighlight">                                    <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;FunctionInvocationId,</span></CodeLine>
<Link id="l00338" /><CodeLine lineNumber="338"><span class="doxyHighlight">                                    <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;PHINode &#42;&gt;</a> &amp;SetjmpRetPHIs);</span></CodeLine>
<Link id="l00339" /><CodeLine lineNumber="339"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;getFindMatchingCatch(<a href="/docs/api/classes/llvm/module">Module</a> &amp;M, </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumClauses);</span></CodeLine>
<Link id="l00340" /><CodeLine lineNumber="340"></CodeLine>
<Link id="l00341" /><CodeLine lineNumber="341"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;wrapInvoke(<a href="/docs/api/classes/llvm/callbase">CallBase</a> &#42;CI);</span></CodeLine>
<Link id="l00342" /><CodeLine lineNumber="342"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> wrapTestSetjmp(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB, <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>, <a href="/docs/api/classes/llvm/value">Value</a> &#42;Threw,</span></CodeLine>
<Link id="l00343" /><CodeLine lineNumber="343"><span class="doxyHighlight">                      <a href="/docs/api/classes/llvm/value">Value</a> &#42;FunctionInvocationId, <a href="/docs/api/classes/llvm/value">Value</a> &#42;&amp;Label,</span></CodeLine>
<Link id="l00344" /><CodeLine lineNumber="344"><span class="doxyHighlight">                      <a href="/docs/api/classes/llvm/value">Value</a> &#42;&amp;LongjmpResult, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;&amp;CallEmLongjmpBB,</span></CodeLine>
<Link id="l00345" /><CodeLine lineNumber="345"><span class="doxyHighlight">                      <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;&amp;CallEmLongjmpBBThrewPHI,</span></CodeLine>
<Link id="l00346" /><CodeLine lineNumber="346"><span class="doxyHighlight">                      <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;&amp;CallEmLongjmpBBThrewValuePHI,</span></CodeLine>
<Link id="l00347" /><CodeLine lineNumber="347"><span class="doxyHighlight">                      <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;&amp;EndBB);</span></CodeLine>
<Link id="l00348" /><CodeLine lineNumber="348"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;getInvokeWrapper(<a href="/docs/api/classes/llvm/callbase">CallBase</a> &#42;CI);</span></CodeLine>
<Link id="l00349" /><CodeLine lineNumber="349"></CodeLine>
<Link id="l00350" /><CodeLine lineNumber="350"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> areAllExceptionsAllowed()</span><span class="doxyHighlightKeyword"> const </span><span class="doxyHighlight">&#123; </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> EHAllowlistSet.empty(); &#125;</span></CodeLine>
<Link id="l00351" /><CodeLine lineNumber="351"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> supportsException(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/function">Function</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>)</span><span class="doxyHighlightKeyword"> const </span><span class="doxyHighlight">&#123;</span></CodeLine>
<Link id="l00352" /><CodeLine lineNumber="352"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> EnableEmEH &amp;&amp;</span></CodeLine>
<Link id="l00353" /><CodeLine lineNumber="353"><span class="doxyHighlight">           (areAllExceptionsAllowed() || EHAllowlistSet.count(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getName()));</span></CodeLine>
<Link id="l00354" /><CodeLine lineNumber="354"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00355" /><CodeLine lineNumber="355"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> replaceLongjmpWith(<a href="/docs/api/classes/llvm/function">Function</a> &#42;LongjmpF, <a href="/docs/api/classes/llvm/function">Function</a> &#42;NewF);</span></CodeLine>
<Link id="l00356" /><CodeLine lineNumber="356"></CodeLine>
<Link id="l00357" /><CodeLine lineNumber="357"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> rebuildSSA(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l00358" /><CodeLine lineNumber="358"></CodeLine>
<Link id="l00359" /><CodeLine lineNumber="359"><span class="doxyHighlightKeyword">public</span><span class="doxyHighlight">:</span></CodeLine>
<Link id="l00360" /><CodeLine lineNumber="360" lineLink="/docs/api/classes/anonymous-namespace-webassemblyloweremscriptenehsjlj-cpp-/webassemblyloweremscriptenehsjlj/#a0b705235c4beb01bd6d1a26aaf938f80"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">char</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-webassemblyloweremscriptenehsjlj-cpp-/webassemblyloweremscriptenehsjlj/#a0b705235c4beb01bd6d1a26aaf938f80">ID</a>;</span></CodeLine>
<Link id="l00361" /><CodeLine lineNumber="361"></CodeLine>
<Link id="l00362" /><CodeLine lineNumber="362" lineLink="/docs/api/classes/anonymous-namespace-webassemblyloweremscriptenehsjlj-cpp-/webassemblyloweremscriptenehsjlj/#a91ebaff00e920636b96b48430ee7bb1d"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-webassemblyloweremscriptenehsjlj-cpp-/webassemblyloweremscriptenehsjlj/#a91ebaff00e920636b96b48430ee7bb1d">WebAssemblyLowerEmscriptenEHSjLj</a>()</span></CodeLine>
<Link id="l00363" /><CodeLine lineNumber="363"><span class="doxyHighlight">      : <a href="/docs/api/classes/llvm/modulepass/#a723659a08d210f4f566887bda3f9f976">ModulePass</a>(<a href="/docs/api/classes/anonymous-namespace-webassemblyloweremscriptenehsjlj-cpp-/webassemblyloweremscriptenehsjlj/#a0b705235c4beb01bd6d1a26aaf938f80">ID</a>), EnableEmEH(<a href="/docs/api/namespaces/llvm/webassembly">WebAssembly</a>::WasmEnableEmEH),</span></CodeLine>
<Link id="l00364" /><CodeLine lineNumber="364"><span class="doxyHighlight">        EnableEmSjLj(<a href="/docs/api/namespaces/llvm/webassembly">WebAssembly</a>::WasmEnableEmSjLj),</span></CodeLine>
<Link id="l00365" /><CodeLine lineNumber="365"><span class="doxyHighlight">        EnableWasmSjLj(<a href="/docs/api/namespaces/llvm/webassembly">WebAssembly</a>::WasmEnableSjLj) &#123;</span></CodeLine>
<Link id="l00366" /><CodeLine lineNumber="366"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!(EnableEmSjLj &amp;&amp; EnableWasmSjLj) &amp;&amp;</span></CodeLine>
<Link id="l00367" /><CodeLine lineNumber="367"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;Two SjLj modes cannot be turned on at the same time&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00368" /><CodeLine lineNumber="368"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!(EnableEmEH &amp;&amp; EnableWasmSjLj) &amp;&amp;</span></CodeLine>
<Link id="l00369" /><CodeLine lineNumber="369"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;Wasm SjLj should be only used with Wasm EH&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00370" /><CodeLine lineNumber="370"><span class="doxyHighlight">    EHAllowlistSet.insert(<a href="#a41b437d912a1d2b4bf65ef8da79f8298">EHAllowlist</a>.begin(), <a href="#a41b437d912a1d2b4bf65ef8da79f8298">EHAllowlist</a>.end());</span></CodeLine>
<Link id="l00371" /><CodeLine lineNumber="371"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00372" /><CodeLine lineNumber="372"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> runOnModule(<a href="/docs/api/classes/llvm/module">Module</a> &amp;M) </span><span class="doxyHighlightKeyword">override</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00373" /><CodeLine lineNumber="373"></CodeLine>
<Link id="l00374" /><CodeLine lineNumber="374" lineLink="/docs/api/classes/anonymous-namespace-webassemblyloweremscriptenehsjlj-cpp-/webassemblyloweremscriptenehsjlj/#a37781da040b260dd412d4940409a73ac"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-webassemblyloweremscriptenehsjlj-cpp-/webassemblyloweremscriptenehsjlj/#a37781da040b260dd412d4940409a73ac">getAnalysisUsage</a>(<a href="/docs/api/classes/llvm/analysisusage">AnalysisUsage</a> &amp;AU)</span><span class="doxyHighlightKeyword"> const override </span><span class="doxyHighlight">&#123;</span></CodeLine>
<Link id="l00375" /><CodeLine lineNumber="375"><span class="doxyHighlight">    AU.<a href="/docs/api/classes/llvm/analysisusage/#ae0adcccca08fb686c9ce00f9397b660c">addRequired</a>&lt;<a href="/docs/api/classes/llvm/dominatortreewrapperpass">DominatorTreeWrapperPass</a>&gt;();</span></CodeLine>
<Link id="l00376" /><CodeLine lineNumber="376"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00377" /><CodeLine lineNumber="377"><span class="doxyHighlight">&#125;;</span></CodeLine>
<Link id="l00378" /><CodeLine lineNumber="378"><span class="doxyHighlight">&#125; </span><span class="doxyHighlightComment">// End anonymous namespace</span></CodeLine>
<Link id="l00379" /><CodeLine lineNumber="379"></CodeLine>
<Link id="l00380" /><CodeLine lineNumber="380"><span class="doxyHighlightKeywordType">char</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-webassemblyloweremscriptenehsjlj-cpp-/webassemblyloweremscriptenehsjlj/#a0b705235c4beb01bd6d1a26aaf938f80">WebAssemblyLowerEmscriptenEHSjLj::ID</a> = 0;</span></CodeLine>
<Link id="l00381" /><CodeLine lineNumber="381" lineLink="#a24b94fa950f4e47096365189c893d30e"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/passsupport-h/#af807c9595d50b45c0008924c4679c85c">INITIALIZE&#95;PASS</a>(<a href="/docs/api/classes/anonymous-namespace-webassemblyloweremscriptenehsjlj-cpp-/webassemblyloweremscriptenehsjlj/#a91ebaff00e920636b96b48430ee7bb1d">WebAssemblyLowerEmscriptenEHSjLj</a>, <a href="/docs/api/files/include/include/llvm/include/llvm/adt/genericcycleimpl-h/#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>,</span></CodeLine>
<Link id="l00382" /><CodeLine lineNumber="382"><span class="doxyHighlight">                </span><span class="doxyHighlightStringLiteral">&quot;WebAssembly Lower Emscripten Exceptions / Setjmp / Longjmp&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00383" /><CodeLine lineNumber="383"><span class="doxyHighlight">                </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l00384" /><CodeLine lineNumber="384"></CodeLine>
<Link id="l00385" /><CodeLine lineNumber="385"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/modulepass">ModulePass</a> &#42;<a href="/docs/api/namespaces/llvm">llvm</a>::<a href="/docs/api/namespaces/llvm/#a9df37103568a509baca10e4fc7357a5e">createWebAssemblyLowerEmscriptenEHSjLj</a>() &#123;</span></CodeLine>
<Link id="l00386" /><CodeLine lineNumber="386"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-webassemblyloweremscriptenehsjlj-cpp-/webassemblyloweremscriptenehsjlj/#a91ebaff00e920636b96b48430ee7bb1d">WebAssemblyLowerEmscriptenEHSjLj</a>();</span></CodeLine>
<Link id="l00387" /><CodeLine lineNumber="387"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00388" /><CodeLine lineNumber="388"></CodeLine>
<Link id="l00389" /><CodeLine lineNumber="389" lineLink="#a8f4bf9ef05ac2193b41802f2e8466f66"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#a8f4bf9ef05ac2193b41802f2e8466f66">canThrow</a>(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/value">Value</a> &#42;V) &#123;</span></CodeLine>
<Link id="l00390" /><CodeLine lineNumber="390"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;const Function&gt;</a>(V)) &#123;</span></CodeLine>
<Link id="l00391" /><CodeLine lineNumber="391"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Intrinsics cannot throw</span></CodeLine>
<Link id="l00392" /><CodeLine lineNumber="392"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;isIntrinsic())</span></CodeLine>
<Link id="l00393" /><CodeLine lineNumber="393"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00394" /><CodeLine lineNumber="394"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/stringref">StringRef</a> Name = <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getName();</span></CodeLine>
<Link id="l00395" /><CodeLine lineNumber="395"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// leave setjmp and longjmp (mostly) alone, we process them properly later</span></CodeLine>
<Link id="l00396" /><CodeLine lineNumber="396"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Name == </span><span class="doxyHighlightStringLiteral">&quot;setjmp&quot;</span><span class="doxyHighlight"> || Name == </span><span class="doxyHighlightStringLiteral">&quot;longjmp&quot;</span><span class="doxyHighlight"> || Name == </span><span class="doxyHighlightStringLiteral">&quot;emscripten&#95;longjmp&quot;</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l00397" /><CodeLine lineNumber="397"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00398" /><CodeLine lineNumber="398"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> !<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;doesNotThrow();</span></CodeLine>
<Link id="l00399" /><CodeLine lineNumber="399"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00400" /><CodeLine lineNumber="400"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// not a function, so an indirect call - can throw, we can&#39;t tell</span></CodeLine>
<Link id="l00401" /><CodeLine lineNumber="401"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00402" /><CodeLine lineNumber="402"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00403" /><CodeLine lineNumber="403"></CodeLine>
<Link id="l00404" /><CodeLine lineNumber="404"><span class="doxyHighlightComment">// Get a thread-local global variable with the given name. If it doesn&#39;t exist</span></CodeLine>
<Link id="l00405" /><CodeLine lineNumber="405"><span class="doxyHighlightComment">// declare it, which will generate an import and assume that it will exist at</span></CodeLine>
<Link id="l00406" /><CodeLine lineNumber="406"><span class="doxyHighlightComment">// link time.</span></CodeLine>
<Link id="l00407" /><CodeLine lineNumber="407" lineLink="#ad625ba253f12b49a01ced02c4190e22b"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/globalvariable">GlobalVariable</a> &#42;<a href="#ad625ba253f12b49a01ced02c4190e22b">getGlobalVariable</a>(<a href="/docs/api/classes/llvm/module">Module</a> &amp;M, <a href="/docs/api/classes/llvm/type">Type</a> &#42;Ty,</span></CodeLine>
<Link id="l00408" /><CodeLine lineNumber="408"><span class="doxyHighlight">                                         <a href="/docs/api/classes/llvm/webassemblytargetmachine">WebAssemblyTargetMachine</a> &amp;TM,</span></CodeLine>
<Link id="l00409" /><CodeLine lineNumber="409"><span class="doxyHighlight">                                         </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">char</span><span class="doxyHighlight"> &#42;Name) &#123;</span></CodeLine>
<Link id="l00410" /><CodeLine lineNumber="410"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;GV = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;GlobalVariable&gt;</a>(M.getOrInsertGlobal(Name, Ty));</span></CodeLine>
<Link id="l00411" /><CodeLine lineNumber="411"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!GV)</span></CodeLine>
<Link id="l00412" /><CodeLine lineNumber="412"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(<a href="/docs/api/classes/llvm/twine">Twine</a>(</span><span class="doxyHighlightStringLiteral">&quot;unable to create global: &quot;</span><span class="doxyHighlight">) + Name);</span></CodeLine>
<Link id="l00413" /><CodeLine lineNumber="413"></CodeLine>
<Link id="l00414" /><CodeLine lineNumber="414"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Variables created by this function are thread local. If the target does not</span></CodeLine>
<Link id="l00415" /><CodeLine lineNumber="415"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// support TLS, we depend on CoalesceFeaturesAndStripAtomics to downgrade it</span></CodeLine>
<Link id="l00416" /><CodeLine lineNumber="416"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// to non-thread-local ones, in which case we don&#39;t allow this object to be</span></CodeLine>
<Link id="l00417" /><CodeLine lineNumber="417"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// linked with other objects using shared memory.</span></CodeLine>
<Link id="l00418" /><CodeLine lineNumber="418"><span class="doxyHighlight">  GV-&gt;setThreadLocalMode(<a href="/docs/api/classes/llvm/globalvalue/#a05c6b3b9372b56d130e005db4837da62a55e32c080bb5217324a597d4fb441660">GlobalValue::GeneralDynamicTLSModel</a>);</span></CodeLine>
<Link id="l00419" /><CodeLine lineNumber="419"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> GV;</span></CodeLine>
<Link id="l00420" /><CodeLine lineNumber="420"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00421" /><CodeLine lineNumber="421"></CodeLine>
<Link id="l00422" /><CodeLine lineNumber="422"><span class="doxyHighlightComment">// Simple function name mangler.</span></CodeLine>
<Link id="l00423" /><CodeLine lineNumber="423"><span class="doxyHighlightComment">// This function simply takes LLVM&#39;s string representation of parameter types</span></CodeLine>
<Link id="l00424" /><CodeLine lineNumber="424"><span class="doxyHighlightComment">// and concatenate them with &#39;&#95;&#39;. There are non-alphanumeric characters but llc</span></CodeLine>
<Link id="l00425" /><CodeLine lineNumber="425"><span class="doxyHighlightComment">// is ok with it, and we need to postprocess these names after the lowering</span></CodeLine>
<Link id="l00426" /><CodeLine lineNumber="426"><span class="doxyHighlightComment">// phase anyway.</span></CodeLine>
<Link id="l00427" /><CodeLine lineNumber="427" lineLink="#a6c8fb36f87b49a215040e2943af69e99"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> std::string <a href="#a6c8fb36f87b49a215040e2943af69e99">getSignature</a>(<a href="/docs/api/classes/functiontype">FunctionType</a> &#42;FTy) &#123;</span></CodeLine>
<Link id="l00428" /><CodeLine lineNumber="428"><span class="doxyHighlight">  std::string Sig;</span></CodeLine>
<Link id="l00429" /><CodeLine lineNumber="429"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/raw-string-ostream">raw&#95;string&#95;ostream</a> OS(Sig);</span></CodeLine>
<Link id="l00430" /><CodeLine lineNumber="430"><span class="doxyHighlight">  OS &lt;&lt; &#42;FTy-&gt;getReturnType();</span></CodeLine>
<Link id="l00431" /><CodeLine lineNumber="431"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/type">Type</a> &#42;ParamTy : FTy-&gt;params())</span></CodeLine>
<Link id="l00432" /><CodeLine lineNumber="432"><span class="doxyHighlight">    OS &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;&#95;&quot;</span><span class="doxyHighlight"> &lt;&lt; &#42;ParamTy;</span></CodeLine>
<Link id="l00433" /><CodeLine lineNumber="433"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FTy-&gt;isVarArg())</span></CodeLine>
<Link id="l00434" /><CodeLine lineNumber="434"><span class="doxyHighlight">    OS &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;&#95;...&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00435" /><CodeLine lineNumber="435"><span class="doxyHighlight">  Sig = OS.<a href="/docs/api/classes/llvm/raw-string-ostream/#a6732e8d3ff8100a662ce73634840b990">str</a>();</span></CodeLine>
<Link id="l00436" /><CodeLine lineNumber="436"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#ac9a7de5a04920954ac964059cfc428ad">erase&#95;if</a>(Sig, <a href="/docs/api/namespaces/llvm/#acea2ac67f3ff35107bcf1693416da8e7">isSpace</a>);</span></CodeLine>
<Link id="l00437" /><CodeLine lineNumber="437"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// When s2wasm parses .s file, a comma means the end of an argument. So a</span></CodeLine>
<Link id="l00438" /><CodeLine lineNumber="438"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// mangled function name can contain any character but a comma.</span></CodeLine>
<Link id="l00439" /><CodeLine lineNumber="439"><span class="doxyHighlight">  std::replace(Sig.begin(), Sig.end(), </span><span class="doxyHighlightCharLiteral">&#39;,&#39;</span><span class="doxyHighlight">, </span><span class="doxyHighlightCharLiteral">&#39;.&#39;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00440" /><CodeLine lineNumber="440"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Sig;</span></CodeLine>
<Link id="l00441" /><CodeLine lineNumber="441"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00442" /><CodeLine lineNumber="442"></CodeLine>
<Link id="l00443" /><CodeLine lineNumber="443" lineLink="#ad3ef075dd9dce61e81b354102b4fe107"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/function">Function</a> &#42;<a href="#ad3ef075dd9dce61e81b354102b4fe107">getEmscriptenFunction</a>(<a href="/docs/api/classes/functiontype">FunctionType</a> &#42;Ty, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/twine">Twine</a> &amp;Name,</span></CodeLine>
<Link id="l00444" /><CodeLine lineNumber="444"><span class="doxyHighlight">                                       <a href="/docs/api/classes/llvm/module">Module</a> &#42;M) &#123;</span></CodeLine>
<Link id="l00445" /><CodeLine lineNumber="445"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a>&#42; <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = <a href="/docs/api/classes/llvm/function/#a05d7aedbbdc0fd24e8bc27edfe9c603f">Function::Create</a>(Ty, <a href="/docs/api/classes/llvm/globalvalue/#aedfa75f0c85c4aa85b257f066fbea57ca6c93794d7b99cd433e96c53eadb15a6e">GlobalValue::ExternalLinkage</a>, Name, M);</span></CodeLine>
<Link id="l00446" /><CodeLine lineNumber="446"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Tell the linker that this function is expected to be imported from the</span></CodeLine>
<Link id="l00447" /><CodeLine lineNumber="447"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// &#39;env&#39; module.</span></CodeLine>
<Link id="l00448" /><CodeLine lineNumber="448"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;hasFnAttribute(</span><span class="doxyHighlightStringLiteral">&quot;wasm-import-module&quot;</span><span class="doxyHighlight">)) &#123;</span></CodeLine>
<Link id="l00449" /><CodeLine lineNumber="449"><span class="doxyHighlight">    llvm::AttrBuilder <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>(M-&gt;getContext());</span></CodeLine>
<Link id="l00450" /><CodeLine lineNumber="450"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>.addAttribute(</span><span class="doxyHighlightStringLiteral">&quot;wasm-import-module&quot;</span><span class="doxyHighlight">, </span><span class="doxyHighlightStringLiteral">&quot;env&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00451" /><CodeLine lineNumber="451"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;addFnAttrs(<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>);</span></CodeLine>
<Link id="l00452" /><CodeLine lineNumber="452"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00453" /><CodeLine lineNumber="453"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;hasFnAttribute(</span><span class="doxyHighlightStringLiteral">&quot;wasm-import-name&quot;</span><span class="doxyHighlight">)) &#123;</span></CodeLine>
<Link id="l00454" /><CodeLine lineNumber="454"><span class="doxyHighlight">    llvm::AttrBuilder <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>(M-&gt;getContext());</span></CodeLine>
<Link id="l00455" /><CodeLine lineNumber="455"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>.addAttribute(</span><span class="doxyHighlightStringLiteral">&quot;wasm-import-name&quot;</span><span class="doxyHighlight">, <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getName());</span></CodeLine>
<Link id="l00456" /><CodeLine lineNumber="456"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;addFnAttrs(<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>);</span></CodeLine>
<Link id="l00457" /><CodeLine lineNumber="457"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00458" /><CodeLine lineNumber="458"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>;</span></CodeLine>
<Link id="l00459" /><CodeLine lineNumber="459"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00460" /><CodeLine lineNumber="460"></CodeLine>
<Link id="l00461" /><CodeLine lineNumber="461"><span class="doxyHighlightComment">// Returns an integer type for the target architecture&#39;s address space.</span></CodeLine>
<Link id="l00462" /><CodeLine lineNumber="462"><span class="doxyHighlightComment">// i32 for wasm32 and i64 for wasm64.</span></CodeLine>
<Link id="l00463" /><CodeLine lineNumber="463" lineLink="#a7db0da8464b0af856d82ee7c77519483"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/type">Type</a> &#42;<a href="#a7db0da8464b0af856d82ee7c77519483">getAddrIntType</a>(<a href="/docs/api/classes/llvm/module">Module</a> &#42;M) &#123;</span></CodeLine>
<Link id="l00464" /><CodeLine lineNumber="464"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> IRB(M-&gt;getContext());</span></CodeLine>
<Link id="l00465" /><CodeLine lineNumber="465"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#a31e2db8d1b315202d2c19e711b5365fd">getIntNTy</a>(M-&gt;getDataLayout().getPointerSizeInBits());</span></CodeLine>
<Link id="l00466" /><CodeLine lineNumber="466"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00467" /><CodeLine lineNumber="467"></CodeLine>
<Link id="l00468" /><CodeLine lineNumber="468"><span class="doxyHighlightComment">// Returns an integer pointer type for the target architecture&#39;s address space.</span></CodeLine>
<Link id="l00469" /><CodeLine lineNumber="469"><span class="doxyHighlightComment">// i32&#42; for wasm32 and i64&#42; for wasm64. With opaque pointers this is just a ptr</span></CodeLine>
<Link id="l00470" /><CodeLine lineNumber="470"><span class="doxyHighlightComment">// in address space zero.</span></CodeLine>
<Link id="l00471" /><CodeLine lineNumber="471" lineLink="#a59656c1055ce3a231bba72ea31edfb14"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/type">Type</a> &#42;<a href="#a59656c1055ce3a231bba72ea31edfb14">getAddrPtrType</a>(<a href="/docs/api/classes/llvm/module">Module</a> &#42;M) &#123;</span></CodeLine>
<Link id="l00472" /><CodeLine lineNumber="472"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/pointertype/#af8a1dbdbfd89aa4899b3c0d39495d0dd">PointerType::getUnqual</a>(M-&gt;getContext());</span></CodeLine>
<Link id="l00473" /><CodeLine lineNumber="473"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00474" /><CodeLine lineNumber="474"></CodeLine>
<Link id="l00475" /><CodeLine lineNumber="475"><span class="doxyHighlightComment">// Returns an integer whose type is the integer type for the target&#39;s address</span></CodeLine>
<Link id="l00476" /><CodeLine lineNumber="476"><span class="doxyHighlightComment">// space. Returns (i32 C) for wasm32 and (i64 C) for wasm64, when C is the</span></CodeLine>
<Link id="l00477" /><CodeLine lineNumber="477"><span class="doxyHighlightComment">// integer.</span></CodeLine>
<Link id="l00478" /><CodeLine lineNumber="478" lineLink="#ad2de6223491e08f9906cfd58b9db22c2"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="#ad2de6223491e08f9906cfd58b9db22c2">getAddrSizeInt</a>(<a href="/docs/api/classes/llvm/module">Module</a> &#42;M, uint64&#95;t <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>) &#123;</span></CodeLine>
<Link id="l00479" /><CodeLine lineNumber="479"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> IRB(M-&gt;getContext());</span></CodeLine>
<Link id="l00480" /><CodeLine lineNumber="480"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#a95df4f20c933779306b9a936b88b99a5">getIntN</a>(M-&gt;getDataLayout().getPointerSizeInBits(), <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>);</span></CodeLine>
<Link id="l00481" /><CodeLine lineNumber="481"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00482" /><CodeLine lineNumber="482"></CodeLine>
<Link id="l00483" /><CodeLine lineNumber="483"><span class="doxyHighlightComment">// Returns &#95;&#95;cxa&#95;find&#95;matching&#95;catch&#95;N function, where N = NumClauses + 2</span></CodeLine>
<Link id="l00484" /><CodeLine lineNumber="484"><span class="doxyHighlightComment">// This is because a landingpad instruction contains two more arguments, a</span></CodeLine>
<Link id="l00485" /><CodeLine lineNumber="485"><span class="doxyHighlightComment">// personality function and a cleanup bit, and &#95;&#95;cxa&#95;find&#95;matching&#95;catch&#95;N</span></CodeLine>
<Link id="l00486" /><CodeLine lineNumber="486"><span class="doxyHighlightComment">// functions are named after the number of arguments in the original landingpad</span></CodeLine>
<Link id="l00487" /><CodeLine lineNumber="487"><span class="doxyHighlightComment">// instruction.</span></CodeLine>
<Link id="l00488" /><CodeLine lineNumber="488"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/function">Function</a> &#42;</span></CodeLine>
<Link id="l00489" /><CodeLine lineNumber="489"><span class="doxyHighlight">WebAssemblyLowerEmscriptenEHSjLj::getFindMatchingCatch(<a href="/docs/api/classes/llvm/module">Module</a> &amp;M,</span></CodeLine>
<Link id="l00490" /><CodeLine lineNumber="490"><span class="doxyHighlight">                                                       </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumClauses) &#123;</span></CodeLine>
<Link id="l00491" /><CodeLine lineNumber="491"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FindMatchingCatches.count(NumClauses))</span></CodeLine>
<Link id="l00492" /><CodeLine lineNumber="492"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> FindMatchingCatches&#91;NumClauses&#93;;</span></CodeLine>
<Link id="l00493" /><CodeLine lineNumber="493"><span class="doxyHighlight">  <a href="/docs/api/classes/pointertype">PointerType</a> &#42;Int8PtrTy = <a href="/docs/api/classes/llvm/pointertype/#af8a1dbdbfd89aa4899b3c0d39495d0dd">PointerType::getUnqual</a>(M.getContext());</span></CodeLine>
<Link id="l00494" /><CodeLine lineNumber="494"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Type &#42;, 16&gt;</a> <a href="/docs/api/namespaces/llvm/amdgpu/hsamd/kernel/key/#a1958a762261549463a280bac3274d6d5">Args</a>(NumClauses, Int8PtrTy);</span></CodeLine>
<Link id="l00495" /><CodeLine lineNumber="495"><span class="doxyHighlight">  <a href="/docs/api/classes/functiontype">FunctionType</a> &#42;FTy = <a href="/docs/api/classes/llvm/functiontype/#af8be7844c269f201ebcee1e15048c378">FunctionType::get</a>(Int8PtrTy, Args, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00496" /><CodeLine lineNumber="496"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = <a href="#ad3ef075dd9dce61e81b354102b4fe107">getEmscriptenFunction</a>(</span></CodeLine>
<Link id="l00497" /><CodeLine lineNumber="497"><span class="doxyHighlight">      FTy, </span><span class="doxyHighlightStringLiteral">&quot;&#95;&#95;cxa&#95;find&#95;matching&#95;catch&#95;&quot;</span><span class="doxyHighlight"> + <a href="/docs/api/classes/llvm/twine">Twine</a>(NumClauses + 2), &amp;M);</span></CodeLine>
<Link id="l00498" /><CodeLine lineNumber="498"><span class="doxyHighlight">  FindMatchingCatches&#91;NumClauses&#93; = <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>;</span></CodeLine>
<Link id="l00499" /><CodeLine lineNumber="499"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>;</span></CodeLine>
<Link id="l00500" /><CodeLine lineNumber="500"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00501" /><CodeLine lineNumber="501"></CodeLine>
<Link id="l00502" /><CodeLine lineNumber="502"><span class="doxyHighlightComment">// Generate invoke wrapper seqence with preamble and postamble</span></CodeLine>
<Link id="l00503" /><CodeLine lineNumber="503"><span class="doxyHighlightComment">// Preamble:</span></CodeLine>
<Link id="l00504" /><CodeLine lineNumber="504"><span class="doxyHighlightComment">// &#95;&#95;THREW&#95;&#95; = 0;</span></CodeLine>
<Link id="l00505" /><CodeLine lineNumber="505"><span class="doxyHighlightComment">// Postamble:</span></CodeLine>
<Link id="l00506" /><CodeLine lineNumber="506"><span class="doxyHighlightComment">// %&#95;&#95;THREW&#95;&#95;.val = &#95;&#95;THREW&#95;&#95;; &#95;&#95;THREW&#95;&#95; = 0;</span></CodeLine>
<Link id="l00507" /><CodeLine lineNumber="507"><span class="doxyHighlightComment">// Returns %&#95;&#95;THREW&#95;&#95;.val, which indicates whether an exception is thrown (or</span></CodeLine>
<Link id="l00508" /><CodeLine lineNumber="508"><span class="doxyHighlightComment">// whether longjmp occurred), for future use.</span></CodeLine>
<Link id="l00509" /><CodeLine lineNumber="509"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/value">Value</a> &#42;WebAssemblyLowerEmscriptenEHSjLj::wrapInvoke(<a href="/docs/api/classes/llvm/callbase">CallBase</a> &#42;CI) &#123;</span></CodeLine>
<Link id="l00510" /><CodeLine lineNumber="510"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/module">Module</a> &#42;M = CI-&gt;<a href="/docs/api/classes/llvm/instruction/#a4ba3a5be6c0e9b9e8a525de055836733">getModule</a>();</span></CodeLine>
<Link id="l00511" /><CodeLine lineNumber="511"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/llvmcontext">LLVMContext</a> &amp;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a> = M-&gt;getContext();</span></CodeLine>
<Link id="l00512" /><CodeLine lineNumber="512"></CodeLine>
<Link id="l00513" /><CodeLine lineNumber="513"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> IRB(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>);</span></CodeLine>
<Link id="l00514" /><CodeLine lineNumber="514"><span class="doxyHighlight">  IRB.SetInsertPoint(CI);</span></CodeLine>
<Link id="l00515" /><CodeLine lineNumber="515"></CodeLine>
<Link id="l00516" /><CodeLine lineNumber="516"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Pre-invoke</span></CodeLine>
<Link id="l00517" /><CodeLine lineNumber="517"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// &#95;&#95;THREW&#95;&#95; = 0;</span></CodeLine>
<Link id="l00518" /><CodeLine lineNumber="518"><span class="doxyHighlight">  IRB.CreateStore(<a href="#ad2de6223491e08f9906cfd58b9db22c2">getAddrSizeInt</a>(M, 0), ThrewGV);</span></CodeLine>
<Link id="l00519" /><CodeLine lineNumber="519"></CodeLine>
<Link id="l00520" /><CodeLine lineNumber="520"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Invoke function wrapper in JavaScript</span></CodeLine>
<Link id="l00521" /><CodeLine lineNumber="521"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Value &#42;, 16&gt;</a> <a href="/docs/api/namespaces/llvm/amdgpu/hsamd/kernel/key/#a1958a762261549463a280bac3274d6d5">Args</a>;</span></CodeLine>
<Link id="l00522" /><CodeLine lineNumber="522"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Put the pointer to the callee as first argument, so it can be called</span></CodeLine>
<Link id="l00523" /><CodeLine lineNumber="523"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// within the invoke wrapper later</span></CodeLine>
<Link id="l00524" /><CodeLine lineNumber="524"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/amdgpu/hsamd/kernel/key/#a1958a762261549463a280bac3274d6d5">Args</a>.push&#95;back(CI-&gt;<a href="/docs/api/classes/llvm/callbase/#a8d13199cbf4d080d3b5dcf330dad5d2c">getCalledOperand</a>());</span></CodeLine>
<Link id="l00525" /><CodeLine lineNumber="525"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/amdgpu/hsamd/kernel/key/#a1958a762261549463a280bac3274d6d5">Args</a>.append(CI-&gt;<a href="/docs/api/classes/llvm/callbase/#a4fb513d744ca72275932b2c7003f16f6">arg&#95;begin</a>(), CI-&gt;<a href="/docs/api/classes/llvm/callbase/#ac0f11b96f81b2769dd23d028e3189075">arg&#95;end</a>());</span></CodeLine>
<Link id="l00526" /><CodeLine lineNumber="526"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42;NewCall = IRB.CreateCall(getInvokeWrapper(CI), Args);</span></CodeLine>
<Link id="l00527" /><CodeLine lineNumber="527"><span class="doxyHighlight">  NewCall-&gt;<a href="/docs/api/classes/llvm/value/#ae855357b6c5e6e7ed1869272708a3a84">takeName</a>(CI);</span></CodeLine>
<Link id="l00528" /><CodeLine lineNumber="528"><span class="doxyHighlight">  NewCall-&gt;<a href="/docs/api/classes/llvm/callbase/#a0851b4de29686e9c3918449b054cfada">setCallingConv</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4ca7f1f535012fdeda3c9f35f2079b919a7">CallingConv::WASM&#95;EmscriptenInvoke</a>);</span></CodeLine>
<Link id="l00529" /><CodeLine lineNumber="529"><span class="doxyHighlight">  NewCall-&gt;<a href="/docs/api/classes/llvm/instruction/#ae8f5bf5cc06f696b52c709677df00fbf">setDebugLoc</a>(CI-&gt;<a href="/docs/api/classes/llvm/instruction/#a4b8faae4ff9e7434a1d226d03d15dcd2">getDebugLoc</a>());</span></CodeLine>
<Link id="l00530" /><CodeLine lineNumber="530"></CodeLine>
<Link id="l00531" /><CodeLine lineNumber="531"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Because we added the pointer to the callee as first argument, all</span></CodeLine>
<Link id="l00532" /><CodeLine lineNumber="532"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// argument attribute indices have to be incremented by one.</span></CodeLine>
<Link id="l00533" /><CodeLine lineNumber="533"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;AttributeSet, 8&gt;</a> ArgAttributes;</span></CodeLine>
<Link id="l00534" /><CodeLine lineNumber="534"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> AttributeList &amp;InvokeAL = CI-&gt;<a href="/docs/api/classes/llvm/callbase/#ae0c55761fce39dd71617690b04385193">getAttributes</a>();</span></CodeLine>
<Link id="l00535" /><CodeLine lineNumber="535"></CodeLine>
<Link id="l00536" /><CodeLine lineNumber="536"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// No attributes for the callee pointer.</span></CodeLine>
<Link id="l00537" /><CodeLine lineNumber="537"><span class="doxyHighlight">  ArgAttributes.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(<a href="/docs/api/classes/llvm/attributeset">AttributeSet</a>());</span></CodeLine>
<Link id="l00538" /><CodeLine lineNumber="538"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Copy the argument attributes from the original</span></CodeLine>
<Link id="l00539" /><CodeLine lineNumber="539"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = 0, <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#abb2b3a60ccc38a28239e19a1646e0c8a">E</a> = CI-&gt;<a href="/docs/api/classes/llvm/callbase/#adde2ea00dd2613ee41bfe91908e4e68e">arg&#95;size</a>(); <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> &lt; <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#abb2b3a60ccc38a28239e19a1646e0c8a">E</a>; ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)</span></CodeLine>
<Link id="l00540" /><CodeLine lineNumber="540"><span class="doxyHighlight">    ArgAttributes.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(InvokeAL.getParamAttrs(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>));</span></CodeLine>
<Link id="l00541" /><CodeLine lineNumber="541"></CodeLine>
<Link id="l00542" /><CodeLine lineNumber="542"><span class="doxyHighlight">  AttrBuilder FnAttrs(CI-&gt;<a href="/docs/api/classes/llvm/value/#ab3fc0225d8aaf8434026c3573f961f2c">getContext</a>(), InvokeAL.getFnAttrs());</span></CodeLine>
<Link id="l00543" /><CodeLine lineNumber="543"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Args = FnAttrs.getAllocSizeArgs()) &#123;</span></CodeLine>
<Link id="l00544" /><CodeLine lineNumber="544"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// The allocsize attribute (if any) referes to parameters by index and needs</span></CodeLine>
<Link id="l00545" /><CodeLine lineNumber="545"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// to be adjusted.</span></CodeLine>
<Link id="l00546" /><CodeLine lineNumber="546"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#91;SizeArg, NEltArg&#93; = &#42;<a href="/docs/api/namespaces/llvm/amdgpu/hsamd/kernel/key/#a1958a762261549463a280bac3274d6d5">Args</a>;</span></CodeLine>
<Link id="l00547" /><CodeLine lineNumber="547"><span class="doxyHighlight">    SizeArg += 1;</span></CodeLine>
<Link id="l00548" /><CodeLine lineNumber="548"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NEltArg)</span></CodeLine>
<Link id="l00549" /><CodeLine lineNumber="549"><span class="doxyHighlight">      NEltArg = &#42;NEltArg + 1;</span></CodeLine>
<Link id="l00550" /><CodeLine lineNumber="550"><span class="doxyHighlight">    FnAttrs.addAllocSizeAttr(SizeArg, NEltArg);</span></CodeLine>
<Link id="l00551" /><CodeLine lineNumber="551"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00552" /><CodeLine lineNumber="552"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In case the callee has &#39;noreturn&#39; attribute, We need to remove it, because</span></CodeLine>
<Link id="l00553" /><CodeLine lineNumber="553"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// we expect invoke wrappers to return.</span></CodeLine>
<Link id="l00554" /><CodeLine lineNumber="554"><span class="doxyHighlight">  FnAttrs.removeAttribute(Attribute::NoReturn);</span></CodeLine>
<Link id="l00555" /><CodeLine lineNumber="555"></CodeLine>
<Link id="l00556" /><CodeLine lineNumber="556"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Reconstruct the AttributesList based on the vector we constructed.</span></CodeLine>
<Link id="l00557" /><CodeLine lineNumber="557"><span class="doxyHighlight">  AttributeList NewCallAL = AttributeList::get(</span></CodeLine>
<Link id="l00558" /><CodeLine lineNumber="558"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, <a href="/docs/api/classes/llvm/attributeset/#ae8ed437b15a7ca943716e5284a9cb9a6">AttributeSet::get</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, FnAttrs), InvokeAL.getRetAttrs(), ArgAttributes);</span></CodeLine>
<Link id="l00559" /><CodeLine lineNumber="559"><span class="doxyHighlight">  NewCall-&gt;<a href="/docs/api/classes/llvm/callbase/#a9da3b29e8e71b9be4645874e1721207a">setAttributes</a>(NewCallAL);</span></CodeLine>
<Link id="l00560" /><CodeLine lineNumber="560"></CodeLine>
<Link id="l00561" /><CodeLine lineNumber="561"><span class="doxyHighlight">  CI-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(NewCall);</span></CodeLine>
<Link id="l00562" /><CodeLine lineNumber="562"></CodeLine>
<Link id="l00563" /><CodeLine lineNumber="563"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Post-invoke</span></CodeLine>
<Link id="l00564" /><CodeLine lineNumber="564"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// %&#95;&#95;THREW&#95;&#95;.val = &#95;&#95;THREW&#95;&#95;; &#95;&#95;THREW&#95;&#95; = 0;</span></CodeLine>
<Link id="l00565" /><CodeLine lineNumber="565"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;Threw =</span></CodeLine>
<Link id="l00566" /><CodeLine lineNumber="566"><span class="doxyHighlight">      IRB.CreateLoad(<a href="#a7db0da8464b0af856d82ee7c77519483">getAddrIntType</a>(M), ThrewGV, ThrewGV-&gt;getName() + </span><span class="doxyHighlightStringLiteral">&quot;.val&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00567" /><CodeLine lineNumber="567"><span class="doxyHighlight">  IRB.CreateStore(<a href="#ad2de6223491e08f9906cfd58b9db22c2">getAddrSizeInt</a>(M, 0), ThrewGV);</span></CodeLine>
<Link id="l00568" /><CodeLine lineNumber="568"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Threw;</span></CodeLine>
<Link id="l00569" /><CodeLine lineNumber="569"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00570" /><CodeLine lineNumber="570"></CodeLine>
<Link id="l00571" /><CodeLine lineNumber="571"><span class="doxyHighlightComment">// Get matching invoke wrapper based on callee signature</span></CodeLine>
<Link id="l00572" /><CodeLine lineNumber="572"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/function">Function</a> &#42;WebAssemblyLowerEmscriptenEHSjLj::getInvokeWrapper(<a href="/docs/api/classes/llvm/callbase">CallBase</a> &#42;CI) &#123;</span></CodeLine>
<Link id="l00573" /><CodeLine lineNumber="573"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/module">Module</a> &#42;M = CI-&gt;<a href="/docs/api/classes/llvm/instruction/#a4ba3a5be6c0e9b9e8a525de055836733">getModule</a>();</span></CodeLine>
<Link id="l00574" /><CodeLine lineNumber="574"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Type &#42;, 16&gt;</a> ArgTys;</span></CodeLine>
<Link id="l00575" /><CodeLine lineNumber="575"><span class="doxyHighlight">  <a href="/docs/api/classes/functiontype">FunctionType</a> &#42;CalleeFTy = CI-&gt;<a href="/docs/api/classes/llvm/callbase/#ac3c35bd078a268a207f607d0f57dadba">getFunctionType</a>();</span></CodeLine>
<Link id="l00576" /><CodeLine lineNumber="576"></CodeLine>
<Link id="l00577" /><CodeLine lineNumber="577"><span class="doxyHighlight">  std::string Sig = <a href="#a6c8fb36f87b49a215040e2943af69e99">getSignature</a>(CalleeFTy);</span></CodeLine>
<Link id="l00578" /><CodeLine lineNumber="578"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> It = InvokeWrappers.find(Sig);</span></CodeLine>
<Link id="l00579" /><CodeLine lineNumber="579"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (It != InvokeWrappers.end())</span></CodeLine>
<Link id="l00580" /><CodeLine lineNumber="580"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> It-&gt;second;</span></CodeLine>
<Link id="l00581" /><CodeLine lineNumber="581"></CodeLine>
<Link id="l00582" /><CodeLine lineNumber="582"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Put the pointer to the callee as first argument</span></CodeLine>
<Link id="l00583" /><CodeLine lineNumber="583"><span class="doxyHighlight">  ArgTys.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(<a href="/docs/api/classes/llvm/pointertype/#af8a1dbdbfd89aa4899b3c0d39495d0dd">PointerType::getUnqual</a>(CI-&gt;<a href="/docs/api/classes/llvm/value/#ab3fc0225d8aaf8434026c3573f961f2c">getContext</a>()));</span></CodeLine>
<Link id="l00584" /><CodeLine lineNumber="584"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Add argument types</span></CodeLine>
<Link id="l00585" /><CodeLine lineNumber="585"><span class="doxyHighlight">  ArgTys.<a href="/docs/api/classes/llvm/smallvectorimpl/#a7efd1f0c1206d95e4fe01a9b49a57b82">append</a>(CalleeFTy-&gt;param&#95;begin(), CalleeFTy-&gt;param&#95;end());</span></CodeLine>
<Link id="l00586" /><CodeLine lineNumber="586"></CodeLine>
<Link id="l00587" /><CodeLine lineNumber="587"><span class="doxyHighlight">  <a href="/docs/api/classes/functiontype">FunctionType</a> &#42;FTy = <a href="/docs/api/classes/llvm/functiontype/#af8be7844c269f201ebcee1e15048c378">FunctionType::get</a>(CalleeFTy-&gt;getReturnType(), ArgTys,</span></CodeLine>
<Link id="l00588" /><CodeLine lineNumber="588"><span class="doxyHighlight">                                        CalleeFTy-&gt;isVarArg());</span></CodeLine>
<Link id="l00589" /><CodeLine lineNumber="589"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = <a href="#ad3ef075dd9dce61e81b354102b4fe107">getEmscriptenFunction</a>(FTy, </span><span class="doxyHighlightStringLiteral">&quot;&#95;&#95;invoke&#95;&quot;</span><span class="doxyHighlight"> + Sig, M);</span></CodeLine>
<Link id="l00590" /><CodeLine lineNumber="590"><span class="doxyHighlight">  InvokeWrappers&#91;Sig&#93; = <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>;</span></CodeLine>
<Link id="l00591" /><CodeLine lineNumber="591"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>;</span></CodeLine>
<Link id="l00592" /><CodeLine lineNumber="592"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00593" /><CodeLine lineNumber="593"></CodeLine>
<Link id="l00594" /><CodeLine lineNumber="594" lineLink="#a2dacd2cc5f8d003dbbf793474f06df14"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#a2dacd2cc5f8d003dbbf793474f06df14">canLongjmp</a>(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/value">Value</a> &#42;Callee) &#123;</span></CodeLine>
<Link id="l00595" /><CodeLine lineNumber="595"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CalleeF = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Function&gt;</a>(Callee))</span></CodeLine>
<Link id="l00596" /><CodeLine lineNumber="596"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CalleeF-&gt;isIntrinsic())</span></CodeLine>
<Link id="l00597" /><CodeLine lineNumber="597"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00598" /><CodeLine lineNumber="598"></CodeLine>
<Link id="l00599" /><CodeLine lineNumber="599"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Attempting to transform inline assembly will result in something like:</span></CodeLine>
<Link id="l00600" /><CodeLine lineNumber="600"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     call void @&#95;&#95;invoke&#95;void(void ()&#42; asm ...)</span></CodeLine>
<Link id="l00601" /><CodeLine lineNumber="601"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// which is invalid because inline assembly blocks do not have addresses</span></CodeLine>
<Link id="l00602" /><CodeLine lineNumber="602"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// and can&#39;t be passed by pointer. The result is a crash with illegal IR.</span></CodeLine>
<Link id="l00603" /><CodeLine lineNumber="603"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;InlineAsm&gt;</a>(Callee))</span></CodeLine>
<Link id="l00604" /><CodeLine lineNumber="604"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00605" /><CodeLine lineNumber="605"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/stringref">StringRef</a> CalleeName = Callee-&gt;getName();</span></CodeLine>
<Link id="l00606" /><CodeLine lineNumber="606"></CodeLine>
<Link id="l00607" /><CodeLine lineNumber="607"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO Include more functions or consider checking with mangled prefixes</span></CodeLine>
<Link id="l00608" /><CodeLine lineNumber="608"></CodeLine>
<Link id="l00609" /><CodeLine lineNumber="609"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The reason we include malloc/free here is to exclude the malloc/free</span></CodeLine>
<Link id="l00610" /><CodeLine lineNumber="610"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// calls generated in setjmp prep / cleanup routines.</span></CodeLine>
<Link id="l00611" /><CodeLine lineNumber="611"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CalleeName == </span><span class="doxyHighlightStringLiteral">&quot;setjmp&quot;</span><span class="doxyHighlight"> || CalleeName == </span><span class="doxyHighlightStringLiteral">&quot;malloc&quot;</span><span class="doxyHighlight"> || CalleeName == </span><span class="doxyHighlightStringLiteral">&quot;free&quot;</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l00612" /><CodeLine lineNumber="612"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00613" /><CodeLine lineNumber="613"></CodeLine>
<Link id="l00614" /><CodeLine lineNumber="614"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// There are functions in Emscripten&#39;s JS glue code or compiler-rt</span></CodeLine>
<Link id="l00615" /><CodeLine lineNumber="615"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CalleeName == </span><span class="doxyHighlightStringLiteral">&quot;&#95;&#95;resumeException&quot;</span><span class="doxyHighlight"> || CalleeName == </span><span class="doxyHighlightStringLiteral">&quot;llvm&#95;eh&#95;typeid&#95;for&quot;</span><span class="doxyHighlight"> ||</span></CodeLine>
<Link id="l00616" /><CodeLine lineNumber="616"><span class="doxyHighlight">      CalleeName == </span><span class="doxyHighlightStringLiteral">&quot;&#95;&#95;wasm&#95;setjmp&quot;</span><span class="doxyHighlight"> || CalleeName == </span><span class="doxyHighlightStringLiteral">&quot;&#95;&#95;wasm&#95;setjmp&#95;test&quot;</span><span class="doxyHighlight"> ||</span></CodeLine>
<Link id="l00617" /><CodeLine lineNumber="617"><span class="doxyHighlight">      CalleeName == </span><span class="doxyHighlightStringLiteral">&quot;getTempRet0&quot;</span><span class="doxyHighlight"> || CalleeName == </span><span class="doxyHighlightStringLiteral">&quot;setTempRet0&quot;</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l00618" /><CodeLine lineNumber="618"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00619" /><CodeLine lineNumber="619"></CodeLine>
<Link id="l00620" /><CodeLine lineNumber="620"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// &#95;&#95;cxa&#95;find&#95;matching&#95;catch&#95;N functions cannot longjmp</span></CodeLine>
<Link id="l00621" /><CodeLine lineNumber="621"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Callee-&gt;getName().starts&#95;with(</span><span class="doxyHighlightStringLiteral">&quot;&#95;&#95;cxa&#95;find&#95;matching&#95;catch&#95;&quot;</span><span class="doxyHighlight">))</span></CodeLine>
<Link id="l00622" /><CodeLine lineNumber="622"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00623" /><CodeLine lineNumber="623"></CodeLine>
<Link id="l00624" /><CodeLine lineNumber="624"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Exception-catching related functions</span></CodeLine>
<Link id="l00625" /><CodeLine lineNumber="625"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00626" /><CodeLine lineNumber="626"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We intentionally treat &#95;&#95;cxa&#95;end&#95;catch longjmpable in Wasm SjLj even though</span></CodeLine>
<Link id="l00627" /><CodeLine lineNumber="627"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// it surely cannot longjmp, in order to maintain the unwind relationship from</span></CodeLine>
<Link id="l00628" /><CodeLine lineNumber="628"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// all existing catchpads (and calls within them) to catch.dispatch.longjmp.</span></CodeLine>
<Link id="l00629" /><CodeLine lineNumber="629"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00630" /><CodeLine lineNumber="630"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In Wasm EH + Wasm SjLj, we</span></CodeLine>
<Link id="l00631" /><CodeLine lineNumber="631"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// 1 Make all catchswitch and cleanuppad that unwind to caller unwind to</span></CodeLine>
<Link id="l00632" /><CodeLine lineNumber="632"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    catch.dispatch.longjmp instead</span></CodeLine>
<Link id="l00633" /><CodeLine lineNumber="633"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// 2 Convert all longjmpable calls to invokes that unwind to</span></CodeLine>
<Link id="l00634" /><CodeLine lineNumber="634"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//    catch.dispatch.longjmp</span></CodeLine>
<Link id="l00635" /><CodeLine lineNumber="635"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// But catchswitch BBs are removed in isel, so if an EH catchswitch (generated</span></CodeLine>
<Link id="l00636" /><CodeLine lineNumber="636"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// from an exception)&#39;s catchpad does not contain any calls that are converted</span></CodeLine>
<Link id="l00637" /><CodeLine lineNumber="637"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// into invokes unwinding to catch.dispatch.longjmp, this unwind relationship</span></CodeLine>
<Link id="l00638" /><CodeLine lineNumber="638"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// (EH catchswitch BB -&gt; catch.dispatch.longjmp BB) is lost and</span></CodeLine>
<Link id="l00639" /><CodeLine lineNumber="639"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// catch.dispatch.longjmp BB can be placed before the EH catchswitch BB in</span></CodeLine>
<Link id="l00640" /><CodeLine lineNumber="640"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// CFGSort.</span></CodeLine>
<Link id="l00641" /><CodeLine lineNumber="641"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// int ret = setjmp(buf);</span></CodeLine>
<Link id="l00642" /><CodeLine lineNumber="642"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// try &#123;</span></CodeLine>
<Link id="l00643" /><CodeLine lineNumber="643"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   foo(); // longjmps</span></CodeLine>
<Link id="l00644" /><CodeLine lineNumber="644"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// &#125; catch (...) &#123;</span></CodeLine>
<Link id="l00645" /><CodeLine lineNumber="645"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// &#125;</span></CodeLine>
<Link id="l00646" /><CodeLine lineNumber="646"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Then in this code, if &#39;foo&#39; longjmps, it first unwinds to &#39;catch (...)&#39;</span></CodeLine>
<Link id="l00647" /><CodeLine lineNumber="647"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// catchswitch, and is not caught by that catchswitch because it is a longjmp,</span></CodeLine>
<Link id="l00648" /><CodeLine lineNumber="648"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// then it should next unwind to catch.dispatch.longjmp BB. But if this &#39;catch</span></CodeLine>
<Link id="l00649" /><CodeLine lineNumber="649"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// (...)&#39; catchswitch -&gt; catch.dispatch.longjmp unwind relationship is lost,</span></CodeLine>
<Link id="l00650" /><CodeLine lineNumber="650"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// it will not unwind to catch.dispatch.longjmp, producing an incorrect</span></CodeLine>
<Link id="l00651" /><CodeLine lineNumber="651"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// result.</span></CodeLine>
<Link id="l00652" /><CodeLine lineNumber="652"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00653" /><CodeLine lineNumber="653"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Every catchpad generated by Wasm C++ contains &#95;&#95;cxa&#95;end&#95;catch, so we</span></CodeLine>
<Link id="l00654" /><CodeLine lineNumber="654"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// intentionally treat it as longjmpable to work around this problem. This is</span></CodeLine>
<Link id="l00655" /><CodeLine lineNumber="655"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// a hacky fix but an easy one.</span></CodeLine>
<Link id="l00656" /><CodeLine lineNumber="656"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00657" /><CodeLine lineNumber="657"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The comment block in findWasmUnwindDestinations() in</span></CodeLine>
<Link id="l00658" /><CodeLine lineNumber="658"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// SelectionDAGBuilder.cpp is addressing a similar problem.</span></CodeLine>
<Link id="l00659" /><CodeLine lineNumber="659"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CalleeName == </span><span class="doxyHighlightStringLiteral">&quot;&#95;&#95;cxa&#95;end&#95;catch&quot;</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l00660" /><CodeLine lineNumber="660"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/webassembly/#a877b8fcf196f226d4f2289ebdb1f276b">WebAssembly::WasmEnableSjLj</a>;</span></CodeLine>
<Link id="l00661" /><CodeLine lineNumber="661"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CalleeName == </span><span class="doxyHighlightStringLiteral">&quot;&#95;&#95;cxa&#95;begin&#95;catch&quot;</span><span class="doxyHighlight"> ||</span></CodeLine>
<Link id="l00662" /><CodeLine lineNumber="662"><span class="doxyHighlight">      CalleeName == </span><span class="doxyHighlightStringLiteral">&quot;&#95;&#95;cxa&#95;allocate&#95;exception&quot;</span><span class="doxyHighlight"> || CalleeName == </span><span class="doxyHighlightStringLiteral">&quot;&#95;&#95;cxa&#95;throw&quot;</span><span class="doxyHighlight"> ||</span></CodeLine>
<Link id="l00663" /><CodeLine lineNumber="663"><span class="doxyHighlight">      CalleeName == </span><span class="doxyHighlightStringLiteral">&quot;&#95;&#95;clang&#95;call&#95;terminate&quot;</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l00664" /><CodeLine lineNumber="664"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00665" /><CodeLine lineNumber="665"></CodeLine>
<Link id="l00666" /><CodeLine lineNumber="666"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// std::terminate, which is generated when another exception occurs while</span></CodeLine>
<Link id="l00667" /><CodeLine lineNumber="667"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// handling an exception, cannot longjmp.</span></CodeLine>
<Link id="l00668" /><CodeLine lineNumber="668"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CalleeName == </span><span class="doxyHighlightStringLiteral">&quot;&#95;ZSt9terminatev&quot;</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l00669" /><CodeLine lineNumber="669"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00670" /><CodeLine lineNumber="670"></CodeLine>
<Link id="l00671" /><CodeLine lineNumber="671"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Otherwise we don&#39;t know</span></CodeLine>
<Link id="l00672" /><CodeLine lineNumber="672"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00673" /><CodeLine lineNumber="673"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00674" /><CodeLine lineNumber="674"></CodeLine>
<Link id="l00675" /><CodeLine lineNumber="675" lineLink="#ae471a184f6df0ce3df8700257824906d"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#ae471a184f6df0ce3df8700257824906d">isEmAsmCall</a>(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/value">Value</a> &#42;Callee) &#123;</span></CodeLine>
<Link id="l00676" /><CodeLine lineNumber="676"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/stringref">StringRef</a> CalleeName = Callee-&gt;getName();</span></CodeLine>
<Link id="l00677" /><CodeLine lineNumber="677"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// This is an exhaustive list from Emscripten&#39;s &lt;emscripten/em&#95;asm.h&gt;.</span></CodeLine>
<Link id="l00678" /><CodeLine lineNumber="678"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> CalleeName == </span><span class="doxyHighlightStringLiteral">&quot;emscripten&#95;asm&#95;const&#95;int&quot;</span><span class="doxyHighlight"> ||</span></CodeLine>
<Link id="l00679" /><CodeLine lineNumber="679"><span class="doxyHighlight">         CalleeName == </span><span class="doxyHighlightStringLiteral">&quot;emscripten&#95;asm&#95;const&#95;double&quot;</span><span class="doxyHighlight"> ||</span></CodeLine>
<Link id="l00680" /><CodeLine lineNumber="680"><span class="doxyHighlight">         CalleeName == </span><span class="doxyHighlightStringLiteral">&quot;emscripten&#95;asm&#95;const&#95;int&#95;sync&#95;on&#95;main&#95;thread&quot;</span><span class="doxyHighlight"> ||</span></CodeLine>
<Link id="l00681" /><CodeLine lineNumber="681"><span class="doxyHighlight">         CalleeName == </span><span class="doxyHighlightStringLiteral">&quot;emscripten&#95;asm&#95;const&#95;double&#95;sync&#95;on&#95;main&#95;thread&quot;</span><span class="doxyHighlight"> ||</span></CodeLine>
<Link id="l00682" /><CodeLine lineNumber="682"><span class="doxyHighlight">         CalleeName == </span><span class="doxyHighlightStringLiteral">&quot;emscripten&#95;asm&#95;const&#95;async&#95;on&#95;main&#95;thread&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00683" /><CodeLine lineNumber="683"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00684" /><CodeLine lineNumber="684"></CodeLine>
<Link id="l00685" /><CodeLine lineNumber="685"><span class="doxyHighlightComment">// Generate &#95;&#95;wasm&#95;setjmp&#95;test function call seqence with preamble and</span></CodeLine>
<Link id="l00686" /><CodeLine lineNumber="686"><span class="doxyHighlightComment">// postamble. The code this generates is equivalent to the following</span></CodeLine>
<Link id="l00687" /><CodeLine lineNumber="687"><span class="doxyHighlightComment">// JavaScript code:</span></CodeLine>
<Link id="l00688" /><CodeLine lineNumber="688"><span class="doxyHighlightComment">// %&#95;&#95;threwValue.val = &#95;&#95;threwValue;</span></CodeLine>
<Link id="l00689" /><CodeLine lineNumber="689"><span class="doxyHighlightComment">// if (%&#95;&#95;THREW&#95;&#95;.val != 0 &amp; %&#95;&#95;threwValue.val != 0) &#123;</span></CodeLine>
<Link id="l00690" /><CodeLine lineNumber="690"><span class="doxyHighlightComment">//   %label = &#95;&#95;wasm&#95;setjmp&#95;test(%&#95;&#95;THREW&#95;&#95;.val, functionInvocationId);</span></CodeLine>
<Link id="l00691" /><CodeLine lineNumber="691"><span class="doxyHighlightComment">//   if (%label == 0)</span></CodeLine>
<Link id="l00692" /><CodeLine lineNumber="692"><span class="doxyHighlightComment">//     emscripten&#95;longjmp(%&#95;&#95;THREW&#95;&#95;.val, %&#95;&#95;threwValue.val);</span></CodeLine>
<Link id="l00693" /><CodeLine lineNumber="693"><span class="doxyHighlightComment">//   setTempRet0(%&#95;&#95;threwValue.val);</span></CodeLine>
<Link id="l00694" /><CodeLine lineNumber="694"><span class="doxyHighlightComment">// &#125; else &#123;</span></CodeLine>
<Link id="l00695" /><CodeLine lineNumber="695"><span class="doxyHighlightComment">//   %label = -1;</span></CodeLine>
<Link id="l00696" /><CodeLine lineNumber="696"><span class="doxyHighlightComment">// &#125;</span></CodeLine>
<Link id="l00697" /><CodeLine lineNumber="697"><span class="doxyHighlightComment">// %longjmp&#95;result = getTempRet0();</span></CodeLine>
<Link id="l00698" /><CodeLine lineNumber="698"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00699" /><CodeLine lineNumber="699"><span class="doxyHighlightComment">// As output parameters. returns %label, %longjmp&#95;result, and the BB the last</span></CodeLine>
<Link id="l00700" /><CodeLine lineNumber="700"><span class="doxyHighlightComment">// instruction (%longjmp&#95;result = ...) is in.</span></CodeLine>
<Link id="l00701" /><CodeLine lineNumber="701"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> WebAssemblyLowerEmscriptenEHSjLj::wrapTestSetjmp(</span></CodeLine>
<Link id="l00702" /><CodeLine lineNumber="702"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB, <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>, <a href="/docs/api/classes/llvm/value">Value</a> &#42;Threw, <a href="/docs/api/classes/llvm/value">Value</a> &#42;FunctionInvocationId,</span></CodeLine>
<Link id="l00703" /><CodeLine lineNumber="703"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;&amp;Label, <a href="/docs/api/classes/llvm/value">Value</a> &#42;&amp;LongjmpResult, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;&amp;CallEmLongjmpBB,</span></CodeLine>
<Link id="l00704" /><CodeLine lineNumber="704"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;&amp;CallEmLongjmpBBThrewPHI, <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;&amp;CallEmLongjmpBBThrewValuePHI,</span></CodeLine>
<Link id="l00705" /><CodeLine lineNumber="705"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;&amp;EndBB) &#123;</span></CodeLine>
<Link id="l00706" /><CodeLine lineNumber="706"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = BB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a1b4bf7c97cdc8159fd73d48063f0b250">getParent</a>();</span></CodeLine>
<Link id="l00707" /><CodeLine lineNumber="707"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/module">Module</a> &#42;M = <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getParent();</span></CodeLine>
<Link id="l00708" /><CodeLine lineNumber="708"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/llvmcontext">LLVMContext</a> &amp;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a> = M-&gt;getContext();</span></CodeLine>
<Link id="l00709" /><CodeLine lineNumber="709"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> IRB(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>);</span></CodeLine>
<Link id="l00710" /><CodeLine lineNumber="710"><span class="doxyHighlight">  IRB.SetCurrentDebugLocation(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>);</span></CodeLine>
<Link id="l00711" /><CodeLine lineNumber="711"></CodeLine>
<Link id="l00712" /><CodeLine lineNumber="712"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// if (%&#95;&#95;THREW&#95;&#95;.val != 0 &amp; %&#95;&#95;threwValue.val != 0)</span></CodeLine>
<Link id="l00713" /><CodeLine lineNumber="713"><span class="doxyHighlight">  IRB.SetInsertPoint(BB);</span></CodeLine>
<Link id="l00714" /><CodeLine lineNumber="714"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ThenBB1 = <a href="/docs/api/classes/llvm/basicblock/#a4a5b798214be930cf8e133c032ba0129">BasicBlock::Create</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, </span><span class="doxyHighlightStringLiteral">&quot;if.then1&quot;</span><span class="doxyHighlight">, <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l00715" /><CodeLine lineNumber="715"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ElseBB1 = <a href="/docs/api/classes/llvm/basicblock/#a4a5b798214be930cf8e133c032ba0129">BasicBlock::Create</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, </span><span class="doxyHighlightStringLiteral">&quot;if.else1&quot;</span><span class="doxyHighlight">, <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l00716" /><CodeLine lineNumber="716"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;EndBB1 = <a href="/docs/api/classes/llvm/basicblock/#a4a5b798214be930cf8e133c032ba0129">BasicBlock::Create</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, </span><span class="doxyHighlightStringLiteral">&quot;if.end&quot;</span><span class="doxyHighlight">, <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l00717" /><CodeLine lineNumber="717"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;ThrewCmp = IRB.CreateICmpNE(Threw, <a href="#ad2de6223491e08f9906cfd58b9db22c2">getAddrSizeInt</a>(M, 0));</span></CodeLine>
<Link id="l00718" /><CodeLine lineNumber="718"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;ThrewValue = IRB.CreateLoad(IRB.getInt32Ty(), ThrewValueGV,</span></CodeLine>
<Link id="l00719" /><CodeLine lineNumber="719"><span class="doxyHighlight">                                     ThrewValueGV-&gt;getName() + </span><span class="doxyHighlightStringLiteral">&quot;.val&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00720" /><CodeLine lineNumber="720"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;ThrewValueCmp = IRB.CreateICmpNE(ThrewValue, IRB.getInt32(0));</span></CodeLine>
<Link id="l00721" /><CodeLine lineNumber="721"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;Cmp1 = IRB.CreateAnd(ThrewCmp, ThrewValueCmp, </span><span class="doxyHighlightStringLiteral">&quot;cmp1&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00722" /><CodeLine lineNumber="722"><span class="doxyHighlight">  IRB.CreateCondBr(Cmp1, ThenBB1, ElseBB1);</span></CodeLine>
<Link id="l00723" /><CodeLine lineNumber="723"></CodeLine>
<Link id="l00724" /><CodeLine lineNumber="724"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Generate call.em.longjmp BB once and share it within the function</span></CodeLine>
<Link id="l00725" /><CodeLine lineNumber="725"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CallEmLongjmpBB) &#123;</span></CodeLine>
<Link id="l00726" /><CodeLine lineNumber="726"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// emscripten&#95;longjmp(%&#95;&#95;THREW&#95;&#95;.val, %&#95;&#95;threwValue.val);</span></CodeLine>
<Link id="l00727" /><CodeLine lineNumber="727"><span class="doxyHighlight">    CallEmLongjmpBB = <a href="/docs/api/classes/llvm/basicblock/#a4a5b798214be930cf8e133c032ba0129">BasicBlock::Create</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, </span><span class="doxyHighlightStringLiteral">&quot;call.em.longjmp&quot;</span><span class="doxyHighlight">, <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l00728" /><CodeLine lineNumber="728"><span class="doxyHighlight">    IRB.SetInsertPoint(CallEmLongjmpBB);</span></CodeLine>
<Link id="l00729" /><CodeLine lineNumber="729"><span class="doxyHighlight">    CallEmLongjmpBBThrewPHI = IRB.CreatePHI(<a href="#a7db0da8464b0af856d82ee7c77519483">getAddrIntType</a>(M), 4, </span><span class="doxyHighlightStringLiteral">&quot;threw.phi&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00730" /><CodeLine lineNumber="730"><span class="doxyHighlight">    CallEmLongjmpBBThrewValuePHI =</span></CodeLine>
<Link id="l00731" /><CodeLine lineNumber="731"><span class="doxyHighlight">        IRB.CreatePHI(IRB.getInt32Ty(), 4, </span><span class="doxyHighlightStringLiteral">&quot;threwvalue.phi&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00732" /><CodeLine lineNumber="732"><span class="doxyHighlight">    CallEmLongjmpBBThrewPHI-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(Threw, ThenBB1);</span></CodeLine>
<Link id="l00733" /><CodeLine lineNumber="733"><span class="doxyHighlight">    CallEmLongjmpBBThrewValuePHI-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(ThrewValue, ThenBB1);</span></CodeLine>
<Link id="l00734" /><CodeLine lineNumber="734"><span class="doxyHighlight">    IRB.CreateCall(EmLongjmpF,</span></CodeLine>
<Link id="l00735" /><CodeLine lineNumber="735"><span class="doxyHighlight">                   &#123;CallEmLongjmpBBThrewPHI, CallEmLongjmpBBThrewValuePHI&#125;);</span></CodeLine>
<Link id="l00736" /><CodeLine lineNumber="736"><span class="doxyHighlight">    IRB.CreateUnreachable();</span></CodeLine>
<Link id="l00737" /><CodeLine lineNumber="737"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00738" /><CodeLine lineNumber="738"><span class="doxyHighlight">    CallEmLongjmpBBThrewPHI-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(Threw, ThenBB1);</span></CodeLine>
<Link id="l00739" /><CodeLine lineNumber="739"><span class="doxyHighlight">    CallEmLongjmpBBThrewValuePHI-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(ThrewValue, ThenBB1);</span></CodeLine>
<Link id="l00740" /><CodeLine lineNumber="740"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00741" /><CodeLine lineNumber="741"></CodeLine>
<Link id="l00742" /><CodeLine lineNumber="742"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// %label = &#95;&#95;wasm&#95;setjmp&#95;test(%&#95;&#95;THREW&#95;&#95;.val, functionInvocationId);</span></CodeLine>
<Link id="l00743" /><CodeLine lineNumber="743"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// if (%label == 0)</span></CodeLine>
<Link id="l00744" /><CodeLine lineNumber="744"><span class="doxyHighlight">  IRB.SetInsertPoint(ThenBB1);</span></CodeLine>
<Link id="l00745" /><CodeLine lineNumber="745"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;EndBB2 = <a href="/docs/api/classes/llvm/basicblock/#a4a5b798214be930cf8e133c032ba0129">BasicBlock::Create</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, </span><span class="doxyHighlightStringLiteral">&quot;if.end2&quot;</span><span class="doxyHighlight">, <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l00746" /><CodeLine lineNumber="746"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;ThrewPtr =</span></CodeLine>
<Link id="l00747" /><CodeLine lineNumber="747"><span class="doxyHighlight">      IRB.CreateIntToPtr(Threw, <a href="#a59656c1055ce3a231bba72ea31edfb14">getAddrPtrType</a>(M), Threw-&gt;<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>() + </span><span class="doxyHighlightStringLiteral">&quot;.p&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00748" /><CodeLine lineNumber="748"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;ThenLabel = IRB.CreateCall(WasmSetjmpTestF,</span></CodeLine>
<Link id="l00749" /><CodeLine lineNumber="749"><span class="doxyHighlight">                                    &#123;ThrewPtr, FunctionInvocationId&#125;, </span><span class="doxyHighlightStringLiteral">&quot;label&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00750" /><CodeLine lineNumber="750"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;Cmp2 = IRB.CreateICmpEQ(ThenLabel, IRB.getInt32(0));</span></CodeLine>
<Link id="l00751" /><CodeLine lineNumber="751"><span class="doxyHighlight">  IRB.CreateCondBr(Cmp2, CallEmLongjmpBB, EndBB2);</span></CodeLine>
<Link id="l00752" /><CodeLine lineNumber="752"></CodeLine>
<Link id="l00753" /><CodeLine lineNumber="753"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// setTempRet0(%&#95;&#95;threwValue.val);</span></CodeLine>
<Link id="l00754" /><CodeLine lineNumber="754"><span class="doxyHighlight">  IRB.SetInsertPoint(EndBB2);</span></CodeLine>
<Link id="l00755" /><CodeLine lineNumber="755"><span class="doxyHighlight">  IRB.CreateCall(SetTempRet0F, ThrewValue);</span></CodeLine>
<Link id="l00756" /><CodeLine lineNumber="756"><span class="doxyHighlight">  IRB.CreateBr(EndBB1);</span></CodeLine>
<Link id="l00757" /><CodeLine lineNumber="757"></CodeLine>
<Link id="l00758" /><CodeLine lineNumber="758"><span class="doxyHighlight">  IRB.SetInsertPoint(ElseBB1);</span></CodeLine>
<Link id="l00759" /><CodeLine lineNumber="759"><span class="doxyHighlight">  IRB.CreateBr(EndBB1);</span></CodeLine>
<Link id="l00760" /><CodeLine lineNumber="760"></CodeLine>
<Link id="l00761" /><CodeLine lineNumber="761"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// longjmp&#95;result = getTempRet0();</span></CodeLine>
<Link id="l00762" /><CodeLine lineNumber="762"><span class="doxyHighlight">  IRB.SetInsertPoint(EndBB1);</span></CodeLine>
<Link id="l00763" /><CodeLine lineNumber="763"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;LabelPHI = IRB.CreatePHI(IRB.getInt32Ty(), 2, </span><span class="doxyHighlightStringLiteral">&quot;label&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00764" /><CodeLine lineNumber="764"><span class="doxyHighlight">  LabelPHI-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(ThenLabel, EndBB2);</span></CodeLine>
<Link id="l00765" /><CodeLine lineNumber="765"></CodeLine>
<Link id="l00766" /><CodeLine lineNumber="766"><span class="doxyHighlight">  LabelPHI-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(IRB.getInt32(-1), ElseBB1);</span></CodeLine>
<Link id="l00767" /><CodeLine lineNumber="767"></CodeLine>
<Link id="l00768" /><CodeLine lineNumber="768"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Output parameter assignment</span></CodeLine>
<Link id="l00769" /><CodeLine lineNumber="769"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/pdb/#a33e853ec74d48b1340d1d4bae772d30bab021df6aac4654c454f46c77646e745f">Label</a> = LabelPHI;</span></CodeLine>
<Link id="l00770" /><CodeLine lineNumber="770"><span class="doxyHighlight">  EndBB = EndBB1;</span></CodeLine>
<Link id="l00771" /><CodeLine lineNumber="771"><span class="doxyHighlight">  LongjmpResult = IRB.CreateCall(GetTempRet0F, &#123;&#125;, </span><span class="doxyHighlightStringLiteral">&quot;longjmp&#95;result&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00772" /><CodeLine lineNumber="772"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00773" /><CodeLine lineNumber="773"></CodeLine>
<Link id="l00774" /><CodeLine lineNumber="774"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> WebAssemblyLowerEmscriptenEHSjLj::rebuildSSA(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l00775" /><CodeLine lineNumber="775"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT = getAnalysis&lt;DominatorTreeWrapperPass&gt;(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>).getDomTree();</span></CodeLine>
<Link id="l00776" /><CodeLine lineNumber="776"><span class="doxyHighlight">  DT.<a href="/docs/api/classes/llvm/dominatortreebase/#aa0641ae965656ff9988d67a35140e4d9">recalculate</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>); </span><span class="doxyHighlightComment">// CFG has been changed</span></CodeLine>
<Link id="l00777" /><CodeLine lineNumber="777"></CodeLine>
<Link id="l00778" /><CodeLine lineNumber="778"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/ssaupdaterbulk">SSAUpdaterBulk</a> <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>;</span></CodeLine>
<Link id="l00779" /><CodeLine lineNumber="779"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;BB : <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l00780" /><CodeLine lineNumber="780"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : BB) &#123;</span></CodeLine>
<Link id="l00781" /><CodeLine lineNumber="781"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getType()-&gt;isVoidTy())</span></CodeLine>
<Link id="l00782" /><CodeLine lineNumber="782"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00783" /><CodeLine lineNumber="783"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/#a07ea053ea2cdbee8e68ebd607c26dc8a">VarID</a> = <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>.AddVariable(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getName(), <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getType());</span></CodeLine>
<Link id="l00784" /><CodeLine lineNumber="784"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If a value is defined by an invoke instruction, it is only available in</span></CodeLine>
<Link id="l00785" /><CodeLine lineNumber="785"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// its normal destination and not in its unwind destination.</span></CodeLine>
<Link id="l00786" /><CodeLine lineNumber="786"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;InvokeInst&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</span></CodeLine>
<Link id="l00787" /><CodeLine lineNumber="787"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>.AddAvailableValue(<a href="/docs/api/namespaces/llvm/#a07ea053ea2cdbee8e68ebd607c26dc8a">VarID</a>, <a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a>-&gt;getNormalDest(), <a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a>);</span></CodeLine>
<Link id="l00788" /><CodeLine lineNumber="788"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00789" /><CodeLine lineNumber="789"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>.AddAvailableValue(<a href="/docs/api/namespaces/llvm/#a07ea053ea2cdbee8e68ebd607c26dc8a">VarID</a>, &amp;BB, &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</span></CodeLine>
<Link id="l00790" /><CodeLine lineNumber="790"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;U : <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.uses()) &#123;</span></CodeLine>
<Link id="l00791" /><CodeLine lineNumber="791"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/classes/llvm/user">User</a> = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Instruction&gt;</a>(U.getUser());</span></CodeLine>
<Link id="l00792" /><CodeLine lineNumber="792"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;UserPN = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;PHINode&gt;</a>(<a href="/docs/api/classes/llvm/user">User</a>))</span></CodeLine>
<Link id="l00793" /><CodeLine lineNumber="793"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (UserPN-&gt;getIncomingBlock(U) == &amp;BB)</span></CodeLine>
<Link id="l00794" /><CodeLine lineNumber="794"><span class="doxyHighlight">            </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00795" /><CodeLine lineNumber="795"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (DT.<a href="/docs/api/classes/llvm/dominatortree/#a5c69311e8d44898dac36a155c3d8691d">dominates</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <a href="/docs/api/classes/llvm/user">User</a>))</span></CodeLine>
<Link id="l00796" /><CodeLine lineNumber="796"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00797" /><CodeLine lineNumber="797"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>.AddUse(<a href="/docs/api/namespaces/llvm/#a07ea053ea2cdbee8e68ebd607c26dc8a">VarID</a>, &amp;U);</span></CodeLine>
<Link id="l00798" /><CodeLine lineNumber="798"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00799" /><CodeLine lineNumber="799"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00800" /><CodeLine lineNumber="800"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00801" /><CodeLine lineNumber="801"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>.RewriteAllUses(&amp;DT);</span></CodeLine>
<Link id="l00802" /><CodeLine lineNumber="802"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00803" /><CodeLine lineNumber="803"></CodeLine>
<Link id="l00804" /><CodeLine lineNumber="804"><span class="doxyHighlightComment">// Replace uses of longjmp with a new longjmp function in Emscripten library.</span></CodeLine>
<Link id="l00805" /><CodeLine lineNumber="805"><span class="doxyHighlightComment">// In Emscripten SjLj, the new function is</span></CodeLine>
<Link id="l00806" /><CodeLine lineNumber="806"><span class="doxyHighlightComment">//   void emscripten&#95;longjmp(uintptr&#95;t, i32)</span></CodeLine>
<Link id="l00807" /><CodeLine lineNumber="807"><span class="doxyHighlightComment">// In Wasm SjLj, the new function is</span></CodeLine>
<Link id="l00808" /><CodeLine lineNumber="808"><span class="doxyHighlightComment">//   void &#95;&#95;wasm&#95;longjmp(i8&#42;, i32)</span></CodeLine>
<Link id="l00809" /><CodeLine lineNumber="809"><span class="doxyHighlightComment">// Because the original libc longjmp function takes (jmp&#95;buf&#42;, i32), we need a</span></CodeLine>
<Link id="l00810" /><CodeLine lineNumber="810"><span class="doxyHighlightComment">// ptrtoint/bitcast instruction here to make the type match. jmp&#95;buf&#42; will</span></CodeLine>
<Link id="l00811" /><CodeLine lineNumber="811"><span class="doxyHighlightComment">// eventually be lowered to i32/i64 in the wasm backend.</span></CodeLine>
<Link id="l00812" /><CodeLine lineNumber="812"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> WebAssemblyLowerEmscriptenEHSjLj::replaceLongjmpWith(<a href="/docs/api/classes/llvm/function">Function</a> &#42;LongjmpF,</span></CodeLine>
<Link id="l00813" /><CodeLine lineNumber="813"><span class="doxyHighlight">                                                          <a href="/docs/api/classes/llvm/function">Function</a> &#42;NewF) &#123;</span></CodeLine>
<Link id="l00814" /><CodeLine lineNumber="814"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(NewF == EmLongjmpF || NewF == WasmLongjmpF);</span></CodeLine>
<Link id="l00815" /><CodeLine lineNumber="815"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/module">Module</a> &#42;M = LongjmpF-&gt;<a href="/docs/api/classes/llvm/globalvalue/#a739b30c811f1eece61b05320ddf44e5b">getParent</a>();</span></CodeLine>
<Link id="l00816" /><CodeLine lineNumber="816"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;CallInst &#42;, 8&gt;</a> ToErase;</span></CodeLine>
<Link id="l00817" /><CodeLine lineNumber="817"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/llvmcontext">LLVMContext</a> &amp;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a> = LongjmpF-&gt;<a href="/docs/api/classes/llvm/globalvalue/#a739b30c811f1eece61b05320ddf44e5b">getParent</a>()-&gt;<a href="/docs/api/classes/llvm/module/#a0beddb53641a541e2238617c5fac4be7">getContext</a>();</span></CodeLine>
<Link id="l00818" /><CodeLine lineNumber="818"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> IRB(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>);</span></CodeLine>
<Link id="l00819" /><CodeLine lineNumber="819"></CodeLine>
<Link id="l00820" /><CodeLine lineNumber="820"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For calls to longjmp, replace it with emscripten&#95;longjmp/&#95;&#95;wasm&#95;longjmp and</span></CodeLine>
<Link id="l00821" /><CodeLine lineNumber="821"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// cast its first argument (jmp&#95;buf&#42;) appropriately</span></CodeLine>
<Link id="l00822" /><CodeLine lineNumber="822"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/user">User</a> &#42;U : LongjmpF-&gt;<a href="/docs/api/classes/llvm/value/#a411cf3e3932f209ce3374cb31adc1da6">users</a>()) &#123;</span></CodeLine>
<Link id="l00823" /><CodeLine lineNumber="823"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CallInst&gt;</a>(U);</span></CodeLine>
<Link id="l00824" /><CodeLine lineNumber="824"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CI &amp;&amp; CI-&gt;<a href="/docs/api/classes/llvm/callbase/#a2b1ae7cf1bafdd43d1fee4c6ad0a2913">getCalledFunction</a>() == LongjmpF) &#123;</span></CodeLine>
<Link id="l00825" /><CodeLine lineNumber="825"><span class="doxyHighlight">      IRB.SetInsertPoint(CI);</span></CodeLine>
<Link id="l00826" /><CodeLine lineNumber="826"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;Env = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00827" /><CodeLine lineNumber="827"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NewF == EmLongjmpF)</span></CodeLine>
<Link id="l00828" /><CodeLine lineNumber="828"><span class="doxyHighlight">        Env =</span></CodeLine>
<Link id="l00829" /><CodeLine lineNumber="829"><span class="doxyHighlight">            IRB.CreatePtrToInt(CI-&gt;<a href="/docs/api/classes/llvm/callbase/#aabd76e6a8a23a5af1ce4d3c310d88bcd">getArgOperand</a>(0), <a href="#a7db0da8464b0af856d82ee7c77519483">getAddrIntType</a>(M), </span><span class="doxyHighlightStringLiteral">&quot;env&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00830" /><CodeLine lineNumber="830"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightComment">// WasmLongjmpF</span></CodeLine>
<Link id="l00831" /><CodeLine lineNumber="831"><span class="doxyHighlight">        Env = IRB.CreateBitCast(CI-&gt;<a href="/docs/api/classes/llvm/callbase/#aabd76e6a8a23a5af1ce4d3c310d88bcd">getArgOperand</a>(0), IRB.getPtrTy(), </span><span class="doxyHighlightStringLiteral">&quot;env&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00832" /><CodeLine lineNumber="832"><span class="doxyHighlight">      IRB.CreateCall(NewF, &#123;Env, CI-&gt;<a href="/docs/api/classes/llvm/callbase/#aabd76e6a8a23a5af1ce4d3c310d88bcd">getArgOperand</a>(1)&#125;);</span></CodeLine>
<Link id="l00833" /><CodeLine lineNumber="833"><span class="doxyHighlight">      ToErase.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(CI);</span></CodeLine>
<Link id="l00834" /><CodeLine lineNumber="834"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00835" /><CodeLine lineNumber="835"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00836" /><CodeLine lineNumber="836"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : ToErase)</span></CodeLine>
<Link id="l00837" /><CodeLine lineNumber="837"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;eraseFromParent();</span></CodeLine>
<Link id="l00838" /><CodeLine lineNumber="838"></CodeLine>
<Link id="l00839" /><CodeLine lineNumber="839"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we have any remaining uses of longjmp&#39;s function pointer, replace it</span></CodeLine>
<Link id="l00840" /><CodeLine lineNumber="840"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// with (void(&#42;)(jmp&#95;buf&#42;, int))emscripten&#95;longjmp / &#95;&#95;wasm&#95;longjmp.</span></CodeLine>
<Link id="l00841" /><CodeLine lineNumber="841"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!LongjmpF-&gt;<a href="/docs/api/classes/llvm/value/#abf855b7cd63a0cd7f73759e396f280c9">uses</a>().empty()) &#123;</span></CodeLine>
<Link id="l00842" /><CodeLine lineNumber="842"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;NewLongjmp =</span></CodeLine>
<Link id="l00843" /><CodeLine lineNumber="843"><span class="doxyHighlight">        IRB.CreateBitCast(NewF, LongjmpF-&gt;<a href="/docs/api/classes/llvm/globalvalue/#a913a5d4b2cddde762446bd494e81a3f2">getType</a>(), </span><span class="doxyHighlightStringLiteral">&quot;longjmp.cast&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00844" /><CodeLine lineNumber="844"><span class="doxyHighlight">    LongjmpF-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(NewLongjmp);</span></CodeLine>
<Link id="l00845" /><CodeLine lineNumber="845"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00846" /><CodeLine lineNumber="846"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00847" /><CodeLine lineNumber="847"></CodeLine>
<Link id="l00848" /><CodeLine lineNumber="848" lineLink="#ac083d4bf8d3f3e1e700c33981f97248c"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#ac083d4bf8d3f3e1e700c33981f97248c">containsLongjmpableCalls</a>(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/function">Function</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l00849" /><CodeLine lineNumber="849"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;BB : &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>)</span></CodeLine>
<Link id="l00850" /><CodeLine lineNumber="850"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : BB)</span></CodeLine>
<Link id="l00851" /><CodeLine lineNumber="851"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CB = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CallBase&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</span></CodeLine>
<Link id="l00852" /><CodeLine lineNumber="852"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a2dacd2cc5f8d003dbbf793474f06df14">canLongjmp</a>(CB-&gt;getCalledOperand()))</span></CodeLine>
<Link id="l00853" /><CodeLine lineNumber="853"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00854" /><CodeLine lineNumber="854"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00855" /><CodeLine lineNumber="855"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00856" /><CodeLine lineNumber="856"></CodeLine>
<Link id="l00857" /><CodeLine lineNumber="857"><span class="doxyHighlightComment">// When a function contains a setjmp call but not other calls that can longjmp,</span></CodeLine>
<Link id="l00858" /><CodeLine lineNumber="858"><span class="doxyHighlightComment">// we don&#39;t do setjmp transformation for that setjmp. But we need to convert the</span></CodeLine>
<Link id="l00859" /><CodeLine lineNumber="859"><span class="doxyHighlightComment">// setjmp calls into &quot;i32 0&quot; so they don&#39;t cause link time errors. setjmp always</span></CodeLine>
<Link id="l00860" /><CodeLine lineNumber="860"><span class="doxyHighlightComment">// returns 0 when called directly.</span></CodeLine>
<Link id="l00861" /><CodeLine lineNumber="861" lineLink="#a1e5a795e237da6e01636980c98b645ab"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#a1e5a795e237da6e01636980c98b645ab">nullifySetjmp</a>(<a href="/docs/api/classes/llvm/function">Function</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l00862" /><CodeLine lineNumber="862"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/module">Module</a> &amp;M = &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getParent();</span></CodeLine>
<Link id="l00863" /><CodeLine lineNumber="863"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> IRB(M.getContext());</span></CodeLine>
<Link id="l00864" /><CodeLine lineNumber="864"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;SetjmpF = M.<a href="/docs/api/classes/llvm/function/#a8743c58384e11cb6228f6f871304ad35">getFunction</a>(</span><span class="doxyHighlightStringLiteral">&quot;setjmp&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00865" /><CodeLine lineNumber="865"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Instruction &#42;, 1&gt;</a> ToErase;</span></CodeLine>
<Link id="l00866" /><CodeLine lineNumber="866"></CodeLine>
<Link id="l00867" /><CodeLine lineNumber="867"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/user">User</a> &#42;U : <a href="/docs/api/namespaces/llvm/#a3d2cdc4a0db233678e7141c9d6ea3419">make&#95;early&#95;inc&#95;range</a>(SetjmpF-&gt;<a href="/docs/api/classes/llvm/value/#a411cf3e3932f209ce3374cb31adc1da6">users</a>())) &#123;</span></CodeLine>
<Link id="l00868" /><CodeLine lineNumber="868"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CB = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CallBase&gt;</a>(U);</span></CodeLine>
<Link id="l00869" /><CodeLine lineNumber="869"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB = CB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a1b4bf7c97cdc8159fd73d48063f0b250">getParent</a>();</span></CodeLine>
<Link id="l00870" /><CodeLine lineNumber="870"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a1b4bf7c97cdc8159fd73d48063f0b250">getParent</a>() != <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) </span><span class="doxyHighlightComment">// in other function</span></CodeLine>
<Link id="l00871" /><CodeLine lineNumber="871"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00872" /><CodeLine lineNumber="872"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42;CI = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00873" /><CodeLine lineNumber="873"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// setjmp cannot throw. So if it is an invoke, lower it to a call</span></CodeLine>
<Link id="l00874" /><CodeLine lineNumber="874"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;InvokeInst&gt;</a>(CB))</span></CodeLine>
<Link id="l00875" /><CodeLine lineNumber="875"><span class="doxyHighlight">      CI = <a href="/docs/api/namespaces/llvm/#a2b3fdb09b0789963c439d41fe91e44a1">llvm::changeToCall</a>(<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a>);</span></CodeLine>
<Link id="l00876" /><CodeLine lineNumber="876"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00877" /><CodeLine lineNumber="877"><span class="doxyHighlight">      CI = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CallInst&gt;</a>(CB);</span></CodeLine>
<Link id="l00878" /><CodeLine lineNumber="878"><span class="doxyHighlight">    ToErase.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(CI);</span></CodeLine>
<Link id="l00879" /><CodeLine lineNumber="879"><span class="doxyHighlight">    CI-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#a8246a9e9405ffe2a9d8d020a949c8e96">getInt32</a>(0));</span></CodeLine>
<Link id="l00880" /><CodeLine lineNumber="880"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00881" /><CodeLine lineNumber="881"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : ToErase)</span></CodeLine>
<Link id="l00882" /><CodeLine lineNumber="882"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;eraseFromParent();</span></CodeLine>
<Link id="l00883" /><CodeLine lineNumber="883"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00884" /><CodeLine lineNumber="884"></CodeLine>
<Link id="l00885" /><CodeLine lineNumber="885" lineLink="/docs/api/classes/anonymous-namespace-webassemblyloweremscriptenehsjlj-cpp-/webassemblyloweremscriptenehsjlj/#a4e54683754f6664c17d470ae3a097486"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-webassemblyloweremscriptenehsjlj-cpp-/webassemblyloweremscriptenehsjlj/#a4e54683754f6664c17d470ae3a097486">WebAssemblyLowerEmscriptenEHSjLj::runOnModule</a>(<a href="/docs/api/classes/llvm/module">Module</a> &amp;M) &#123;</span></CodeLine>
<Link id="l00886" /><CodeLine lineNumber="886"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42; Lower Emscripten EH &amp; SjLj &#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00887" /><CodeLine lineNumber="887"></CodeLine>
<Link id="l00888" /><CodeLine lineNumber="888"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/llvmcontext">LLVMContext</a> &amp;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a> = M.getContext();</span></CodeLine>
<Link id="l00889" /><CodeLine lineNumber="889"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> IRB(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>);</span></CodeLine>
<Link id="l00890" /><CodeLine lineNumber="890"></CodeLine>
<Link id="l00891" /><CodeLine lineNumber="891"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;SetjmpF = M.<a href="/docs/api/classes/llvm/function/#a8743c58384e11cb6228f6f871304ad35">getFunction</a>(</span><span class="doxyHighlightStringLiteral">&quot;setjmp&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00892" /><CodeLine lineNumber="892"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;LongjmpF = M.<a href="/docs/api/classes/llvm/function/#a8743c58384e11cb6228f6f871304ad35">getFunction</a>(</span><span class="doxyHighlightStringLiteral">&quot;longjmp&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00893" /><CodeLine lineNumber="893"></CodeLine>
<Link id="l00894" /><CodeLine lineNumber="894"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In some platforms &#95;setjmp and &#95;longjmp are used instead. Change these to</span></CodeLine>
<Link id="l00895" /><CodeLine lineNumber="895"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// use setjmp/longjmp instead, because we later detect these functions by</span></CodeLine>
<Link id="l00896" /><CodeLine lineNumber="896"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// their names.</span></CodeLine>
<Link id="l00897" /><CodeLine lineNumber="897"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;SetjmpF2 = M.<a href="/docs/api/classes/llvm/function/#a8743c58384e11cb6228f6f871304ad35">getFunction</a>(</span><span class="doxyHighlightStringLiteral">&quot;&#95;setjmp&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00898" /><CodeLine lineNumber="898"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;LongjmpF2 = M.<a href="/docs/api/classes/llvm/function/#a8743c58384e11cb6228f6f871304ad35">getFunction</a>(</span><span class="doxyHighlightStringLiteral">&quot;&#95;longjmp&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00899" /><CodeLine lineNumber="899"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SetjmpF2) &#123;</span></CodeLine>
<Link id="l00900" /><CodeLine lineNumber="900"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SetjmpF) &#123;</span></CodeLine>
<Link id="l00901" /><CodeLine lineNumber="901"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SetjmpF-&gt;<a href="/docs/api/classes/llvm/function/#a21075305f0e463b24aafc2fb99514ace">getFunctionType</a>() != SetjmpF2-&gt;<a href="/docs/api/classes/llvm/function/#a21075305f0e463b24aafc2fb99514ace">getFunctionType</a>())</span></CodeLine>
<Link id="l00902" /><CodeLine lineNumber="902"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(</span><span class="doxyHighlightStringLiteral">&quot;setjmp and &#95;setjmp have different function types&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00903" /><CodeLine lineNumber="903"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00904" /><CodeLine lineNumber="904"><span class="doxyHighlight">      SetjmpF = <a href="/docs/api/classes/llvm/function/#a05d7aedbbdc0fd24e8bc27edfe9c603f">Function::Create</a>(SetjmpF2-&gt;<a href="/docs/api/classes/llvm/function/#a21075305f0e463b24aafc2fb99514ace">getFunctionType</a>(),</span></CodeLine>
<Link id="l00905" /><CodeLine lineNumber="905"><span class="doxyHighlight">                                 <a href="/docs/api/classes/llvm/globalvalue/#aedfa75f0c85c4aa85b257f066fbea57ca6c93794d7b99cd433e96c53eadb15a6e">GlobalValue::ExternalLinkage</a>, </span><span class="doxyHighlightStringLiteral">&quot;setjmp&quot;</span><span class="doxyHighlight">, M);</span></CodeLine>
<Link id="l00906" /><CodeLine lineNumber="906"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00907" /><CodeLine lineNumber="907"><span class="doxyHighlight">    SetjmpF2-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(SetjmpF);</span></CodeLine>
<Link id="l00908" /><CodeLine lineNumber="908"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00909" /><CodeLine lineNumber="909"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LongjmpF2) &#123;</span></CodeLine>
<Link id="l00910" /><CodeLine lineNumber="910"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LongjmpF) &#123;</span></CodeLine>
<Link id="l00911" /><CodeLine lineNumber="911"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LongjmpF-&gt;<a href="/docs/api/classes/llvm/function/#a21075305f0e463b24aafc2fb99514ace">getFunctionType</a>() != LongjmpF2-&gt;<a href="/docs/api/classes/llvm/function/#a21075305f0e463b24aafc2fb99514ace">getFunctionType</a>())</span></CodeLine>
<Link id="l00912" /><CodeLine lineNumber="912"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(</span></CodeLine>
<Link id="l00913" /><CodeLine lineNumber="913"><span class="doxyHighlight">            </span><span class="doxyHighlightStringLiteral">&quot;longjmp and &#95;longjmp have different function types&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00914" /><CodeLine lineNumber="914"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00915" /><CodeLine lineNumber="915"><span class="doxyHighlight">      LongjmpF = <a href="/docs/api/classes/llvm/function/#a05d7aedbbdc0fd24e8bc27edfe9c603f">Function::Create</a>(LongjmpF2-&gt;<a href="/docs/api/classes/llvm/function/#a21075305f0e463b24aafc2fb99514ace">getFunctionType</a>(),</span></CodeLine>
<Link id="l00916" /><CodeLine lineNumber="916"><span class="doxyHighlight">                                  <a href="/docs/api/classes/llvm/globalvalue/#aedfa75f0c85c4aa85b257f066fbea57ca6c93794d7b99cd433e96c53eadb15a6e">GlobalValue::ExternalLinkage</a>, </span><span class="doxyHighlightStringLiteral">&quot;setjmp&quot;</span><span class="doxyHighlight">, M);</span></CodeLine>
<Link id="l00917" /><CodeLine lineNumber="917"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00918" /><CodeLine lineNumber="918"><span class="doxyHighlight">    LongjmpF2-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(LongjmpF);</span></CodeLine>
<Link id="l00919" /><CodeLine lineNumber="919"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00920" /><CodeLine lineNumber="920"></CodeLine>
<Link id="l00921" /><CodeLine lineNumber="921"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;TPC = <a href="/docs/api/classes/llvm/pass/#af94c014e968489e96c7d4353a84ad7f5">getAnalysisIfAvailable&lt;TargetPassConfig&gt;</a>();</span></CodeLine>
<Link id="l00922" /><CodeLine lineNumber="922"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(TPC &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Expected a TargetPassConfig&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00923" /><CodeLine lineNumber="923"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;TM = TPC-&gt;getTM&lt;<a href="/docs/api/classes/llvm/webassemblytargetmachine">WebAssemblyTargetMachine</a>&gt;();</span></CodeLine>
<Link id="l00924" /><CodeLine lineNumber="924"></CodeLine>
<Link id="l00925" /><CodeLine lineNumber="925"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Declare (or get) global variables &#95;&#95;THREW&#95;&#95;, &#95;&#95;threwValue, and</span></CodeLine>
<Link id="l00926" /><CodeLine lineNumber="926"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// getTempRet0/setTempRet0 function which are used in common for both</span></CodeLine>
<Link id="l00927" /><CodeLine lineNumber="927"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// exception handling and setjmp/longjmp handling</span></CodeLine>
<Link id="l00928" /><CodeLine lineNumber="928"><span class="doxyHighlight">  ThrewGV = <a href="#ad625ba253f12b49a01ced02c4190e22b">getGlobalVariable</a>(M, <a href="#a7db0da8464b0af856d82ee7c77519483">getAddrIntType</a>(&amp;M), TM, </span><span class="doxyHighlightStringLiteral">&quot;&#95;&#95;THREW&#95;&#95;&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00929" /><CodeLine lineNumber="929"><span class="doxyHighlight">  ThrewValueGV = <a href="#ad625ba253f12b49a01ced02c4190e22b">getGlobalVariable</a>(M, IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#a5852dc0d180581d34902e8abcbf7e930">getInt32Ty</a>(), TM, </span><span class="doxyHighlightStringLiteral">&quot;&#95;&#95;threwValue&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00930" /><CodeLine lineNumber="930"><span class="doxyHighlight">  GetTempRet0F = <a href="#ad3ef075dd9dce61e81b354102b4fe107">getEmscriptenFunction</a>(</span></CodeLine>
<Link id="l00931" /><CodeLine lineNumber="931"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/functiontype/#af8be7844c269f201ebcee1e15048c378">FunctionType::get</a>(IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#a5852dc0d180581d34902e8abcbf7e930">getInt32Ty</a>(), </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">), </span><span class="doxyHighlightStringLiteral">&quot;getTempRet0&quot;</span><span class="doxyHighlight">, &amp;M);</span></CodeLine>
<Link id="l00932" /><CodeLine lineNumber="932"><span class="doxyHighlight">  SetTempRet0F = <a href="#ad3ef075dd9dce61e81b354102b4fe107">getEmscriptenFunction</a>(</span></CodeLine>
<Link id="l00933" /><CodeLine lineNumber="933"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/functiontype/#af8be7844c269f201ebcee1e15048c378">FunctionType::get</a>(IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#ad0243f1634f75e231041023ffaa8501a">getVoidTy</a>(), IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#a5852dc0d180581d34902e8abcbf7e930">getInt32Ty</a>(), </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00934" /><CodeLine lineNumber="934"><span class="doxyHighlight">      </span><span class="doxyHighlightStringLiteral">&quot;setTempRet0&quot;</span><span class="doxyHighlight">, &amp;M);</span></CodeLine>
<Link id="l00935" /><CodeLine lineNumber="935"><span class="doxyHighlight">  GetTempRet0F-&gt;setDoesNotThrow();</span></CodeLine>
<Link id="l00936" /><CodeLine lineNumber="936"><span class="doxyHighlight">  SetTempRet0F-&gt;setDoesNotThrow();</span></CodeLine>
<Link id="l00937" /><CodeLine lineNumber="937"></CodeLine>
<Link id="l00938" /><CodeLine lineNumber="938"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a> = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00939" /><CodeLine lineNumber="939"></CodeLine>
<Link id="l00940" /><CodeLine lineNumber="940"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Function registration for exception handling</span></CodeLine>
<Link id="l00941" /><CodeLine lineNumber="941"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (EnableEmEH) &#123;</span></CodeLine>
<Link id="l00942" /><CodeLine lineNumber="942"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Register &#95;&#95;resumeException function</span></CodeLine>
<Link id="l00943" /><CodeLine lineNumber="943"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/functiontype">FunctionType</a> &#42;ResumeFTy =</span></CodeLine>
<Link id="l00944" /><CodeLine lineNumber="944"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/functiontype/#af8be7844c269f201ebcee1e15048c378">FunctionType::get</a>(IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#ad0243f1634f75e231041023ffaa8501a">getVoidTy</a>(), IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#ab73bb6948312ca0f98055c6a74c37045">getPtrTy</a>(), </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00945" /><CodeLine lineNumber="945"><span class="doxyHighlight">    ResumeF = <a href="#ad3ef075dd9dce61e81b354102b4fe107">getEmscriptenFunction</a>(ResumeFTy, </span><span class="doxyHighlightStringLiteral">&quot;&#95;&#95;resumeException&quot;</span><span class="doxyHighlight">, &amp;M);</span></CodeLine>
<Link id="l00946" /><CodeLine lineNumber="946"><span class="doxyHighlight">    ResumeF-&gt;addFnAttr(Attribute::NoReturn);</span></CodeLine>
<Link id="l00947" /><CodeLine lineNumber="947"></CodeLine>
<Link id="l00948" /><CodeLine lineNumber="948"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Register llvm&#95;eh&#95;typeid&#95;for function</span></CodeLine>
<Link id="l00949" /><CodeLine lineNumber="949"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/functiontype">FunctionType</a> &#42;EHTypeIDTy =</span></CodeLine>
<Link id="l00950" /><CodeLine lineNumber="950"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/functiontype/#af8be7844c269f201ebcee1e15048c378">FunctionType::get</a>(IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#a5852dc0d180581d34902e8abcbf7e930">getInt32Ty</a>(), IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#ab73bb6948312ca0f98055c6a74c37045">getPtrTy</a>(), </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00951" /><CodeLine lineNumber="951"><span class="doxyHighlight">    EHTypeIDF = <a href="#ad3ef075dd9dce61e81b354102b4fe107">getEmscriptenFunction</a>(EHTypeIDTy, </span><span class="doxyHighlightStringLiteral">&quot;llvm&#95;eh&#95;typeid&#95;for&quot;</span><span class="doxyHighlight">, &amp;M);</span></CodeLine>
<Link id="l00952" /><CodeLine lineNumber="952"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00953" /><CodeLine lineNumber="953"></CodeLine>
<Link id="l00954" /><CodeLine lineNumber="954"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Functions that contains calls to setjmp but don&#39;t have other longjmpable</span></CodeLine>
<Link id="l00955" /><CodeLine lineNumber="955"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// calls within them.</span></CodeLine>
<Link id="l00956" /><CodeLine lineNumber="956"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;Function &#42;, 4&gt;</a> SetjmpUsersToNullify;</span></CodeLine>
<Link id="l00957" /><CodeLine lineNumber="957"></CodeLine>
<Link id="l00958" /><CodeLine lineNumber="958"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> ((EnableEmSjLj || EnableWasmSjLj) &amp;&amp; SetjmpF) &#123;</span></CodeLine>
<Link id="l00959" /><CodeLine lineNumber="959"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Precompute setjmp users</span></CodeLine>
<Link id="l00960" /><CodeLine lineNumber="960"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/user">User</a> &#42;U : SetjmpF-&gt;<a href="/docs/api/classes/llvm/value/#a411cf3e3932f209ce3374cb31adc1da6">users</a>()) &#123;</span></CodeLine>
<Link id="l00961" /><CodeLine lineNumber="961"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CB = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CallBase&gt;</a>(U)) &#123;</span></CodeLine>
<Link id="l00962" /><CodeLine lineNumber="962"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;UserF = CB-&gt;getFunction();</span></CodeLine>
<Link id="l00963" /><CodeLine lineNumber="963"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// If a function that calls setjmp does not contain any other calls that</span></CodeLine>
<Link id="l00964" /><CodeLine lineNumber="964"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// can longjmp, we don&#39;t need to do any transformation on that function,</span></CodeLine>
<Link id="l00965" /><CodeLine lineNumber="965"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// so can ignore it</span></CodeLine>
<Link id="l00966" /><CodeLine lineNumber="966"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#ac083d4bf8d3f3e1e700c33981f97248c">containsLongjmpableCalls</a>(UserF))</span></CodeLine>
<Link id="l00967" /><CodeLine lineNumber="967"><span class="doxyHighlight">          SetjmpUsers.insert(UserF);</span></CodeLine>
<Link id="l00968" /><CodeLine lineNumber="968"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00969" /><CodeLine lineNumber="969"><span class="doxyHighlight">          SetjmpUsersToNullify.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(UserF);</span></CodeLine>
<Link id="l00970" /><CodeLine lineNumber="970"><span class="doxyHighlight">      &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00971" /><CodeLine lineNumber="971"><span class="doxyHighlight">        std::string S;</span></CodeLine>
<Link id="l00972" /><CodeLine lineNumber="972"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/raw-string-ostream">raw&#95;string&#95;ostream</a> SS(S);</span></CodeLine>
<Link id="l00973" /><CodeLine lineNumber="973"><span class="doxyHighlight">        SS &lt;&lt; &#42;U;</span></CodeLine>
<Link id="l00974" /><CodeLine lineNumber="974"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(<a href="/docs/api/classes/llvm/twine">Twine</a>(</span><span class="doxyHighlightStringLiteral">&quot;Indirect use of setjmp is not supported: &quot;</span><span class="doxyHighlight">) +</span></CodeLine>
<Link id="l00975" /><CodeLine lineNumber="975"><span class="doxyHighlight">                           SS.str());</span></CodeLine>
<Link id="l00976" /><CodeLine lineNumber="976"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00977" /><CodeLine lineNumber="977"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00978" /><CodeLine lineNumber="978"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00979" /><CodeLine lineNumber="979"></CodeLine>
<Link id="l00980" /><CodeLine lineNumber="980"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> SetjmpUsed = SetjmpF &amp;&amp; !SetjmpUsers.<a href="/docs/api/classes/llvm/function/#a1d8eb3054fd49a89ff41bc22a48f87e7">empty</a>();</span></CodeLine>
<Link id="l00981" /><CodeLine lineNumber="981"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> LongjmpUsed = LongjmpF &amp;&amp; !LongjmpF-&gt;<a href="/docs/api/classes/llvm/value/#a9d7de807ebdfe1819df3ff6cb0f16158">use&#95;empty</a>();</span></CodeLine>
<Link id="l00982" /><CodeLine lineNumber="982"><span class="doxyHighlight">  DoSjLj = (EnableEmSjLj | EnableWasmSjLj) &amp;&amp; (SetjmpUsed || LongjmpUsed);</span></CodeLine>
<Link id="l00983" /><CodeLine lineNumber="983"></CodeLine>
<Link id="l00984" /><CodeLine lineNumber="984"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Function registration and data pre-gathering for setjmp/longjmp handling</span></CodeLine>
<Link id="l00985" /><CodeLine lineNumber="985"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (DoSjLj) &#123;</span></CodeLine>
<Link id="l00986" /><CodeLine lineNumber="986"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(EnableEmSjLj || EnableWasmSjLj);</span></CodeLine>
<Link id="l00987" /><CodeLine lineNumber="987"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (EnableEmSjLj) &#123;</span></CodeLine>
<Link id="l00988" /><CodeLine lineNumber="988"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Register emscripten&#95;longjmp function</span></CodeLine>
<Link id="l00989" /><CodeLine lineNumber="989"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/functiontype">FunctionType</a> &#42;FTy = <a href="/docs/api/classes/llvm/functiontype/#af8be7844c269f201ebcee1e15048c378">FunctionType::get</a>(</span></CodeLine>
<Link id="l00990" /><CodeLine lineNumber="990"><span class="doxyHighlight">          IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#ad0243f1634f75e231041023ffaa8501a">getVoidTy</a>(), &#123;getAddrIntType(&amp;M), IRB.getInt32Ty()&#125;, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00991" /><CodeLine lineNumber="991"><span class="doxyHighlight">      EmLongjmpF = <a href="#ad3ef075dd9dce61e81b354102b4fe107">getEmscriptenFunction</a>(FTy, </span><span class="doxyHighlightStringLiteral">&quot;emscripten&#95;longjmp&quot;</span><span class="doxyHighlight">, &amp;M);</span></CodeLine>
<Link id="l00992" /><CodeLine lineNumber="992"><span class="doxyHighlight">      EmLongjmpF-&gt;addFnAttr(Attribute::NoReturn);</span></CodeLine>
<Link id="l00993" /><CodeLine lineNumber="993"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123; </span><span class="doxyHighlightComment">// EnableWasmSjLj</span></CodeLine>
<Link id="l00994" /><CodeLine lineNumber="994"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/type">Type</a> &#42;Int8PtrTy = IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#ab73bb6948312ca0f98055c6a74c37045">getPtrTy</a>();</span></CodeLine>
<Link id="l00995" /><CodeLine lineNumber="995"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Register &#95;&#95;wasm&#95;longjmp function, which calls &#95;&#95;builtin&#95;wasm&#95;longjmp.</span></CodeLine>
<Link id="l00996" /><CodeLine lineNumber="996"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/functiontype">FunctionType</a> &#42;FTy = <a href="/docs/api/classes/llvm/functiontype/#af8be7844c269f201ebcee1e15048c378">FunctionType::get</a>(</span></CodeLine>
<Link id="l00997" /><CodeLine lineNumber="997"><span class="doxyHighlight">          IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#ad0243f1634f75e231041023ffaa8501a">getVoidTy</a>(), &#123;Int8PtrTy, IRB.getInt32Ty()&#125;, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00998" /><CodeLine lineNumber="998"><span class="doxyHighlight">      WasmLongjmpF = <a href="#ad3ef075dd9dce61e81b354102b4fe107">getEmscriptenFunction</a>(FTy, </span><span class="doxyHighlightStringLiteral">&quot;&#95;&#95;wasm&#95;longjmp&quot;</span><span class="doxyHighlight">, &amp;M);</span></CodeLine>
<Link id="l00999" /><CodeLine lineNumber="999"><span class="doxyHighlight">      WasmLongjmpF-&gt;addFnAttr(Attribute::NoReturn);</span></CodeLine>
<Link id="l01000" /><CodeLine lineNumber="1000"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01001" /><CodeLine lineNumber="1001"></CodeLine>
<Link id="l01002" /><CodeLine lineNumber="1002"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SetjmpF) &#123;</span></CodeLine>
<Link id="l01003" /><CodeLine lineNumber="1003"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/type">Type</a> &#42;Int8PtrTy = IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#ab73bb6948312ca0f98055c6a74c37045">getPtrTy</a>();</span></CodeLine>
<Link id="l01004" /><CodeLine lineNumber="1004"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/type">Type</a> &#42;Int32PtrTy = IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#ab73bb6948312ca0f98055c6a74c37045">getPtrTy</a>();</span></CodeLine>
<Link id="l01005" /><CodeLine lineNumber="1005"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/type">Type</a> &#42;<a href="/docs/api/namespaces/llvm/#a23f9ec4bb2576ca8738f3edc9c4f5cdf">Int32Ty</a> = IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#a5852dc0d180581d34902e8abcbf7e930">getInt32Ty</a>();</span></CodeLine>
<Link id="l01006" /><CodeLine lineNumber="1006"></CodeLine>
<Link id="l01007" /><CodeLine lineNumber="1007"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Register &#95;&#95;wasm&#95;setjmp function</span></CodeLine>
<Link id="l01008" /><CodeLine lineNumber="1008"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/functiontype">FunctionType</a> &#42;SetjmpFTy = SetjmpF-&gt;<a href="/docs/api/classes/llvm/function/#a21075305f0e463b24aafc2fb99514ace">getFunctionType</a>();</span></CodeLine>
<Link id="l01009" /><CodeLine lineNumber="1009"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/functiontype">FunctionType</a> &#42;FTy = <a href="/docs/api/classes/llvm/functiontype/#af8be7844c269f201ebcee1e15048c378">FunctionType::get</a>(</span></CodeLine>
<Link id="l01010" /><CodeLine lineNumber="1010"><span class="doxyHighlight">          IRB.<a href="/docs/api/classes/llvm/irbuilderbase/#ad0243f1634f75e231041023ffaa8501a">getVoidTy</a>(), &#123;SetjmpFTy-&gt;getParamType(0), Int32Ty, Int32PtrTy&#125;,</span></CodeLine>
<Link id="l01011" /><CodeLine lineNumber="1011"><span class="doxyHighlight">          </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01012" /><CodeLine lineNumber="1012"><span class="doxyHighlight">      WasmSetjmpF = <a href="#ad3ef075dd9dce61e81b354102b4fe107">getEmscriptenFunction</a>(FTy, </span><span class="doxyHighlightStringLiteral">&quot;&#95;&#95;wasm&#95;setjmp&quot;</span><span class="doxyHighlight">, &amp;M);</span></CodeLine>
<Link id="l01013" /><CodeLine lineNumber="1013"></CodeLine>
<Link id="l01014" /><CodeLine lineNumber="1014"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Register &#95;&#95;wasm&#95;setjmp&#95;test function</span></CodeLine>
<Link id="l01015" /><CodeLine lineNumber="1015"><span class="doxyHighlight">      FTy = <a href="/docs/api/classes/llvm/functiontype/#af8be7844c269f201ebcee1e15048c378">FunctionType::get</a>(<a href="/docs/api/namespaces/llvm/#a23f9ec4bb2576ca8738f3edc9c4f5cdf">Int32Ty</a>, &#123;Int32PtrTy, Int32PtrTy&#125;, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01016" /><CodeLine lineNumber="1016"><span class="doxyHighlight">      WasmSetjmpTestF = <a href="#ad3ef075dd9dce61e81b354102b4fe107">getEmscriptenFunction</a>(FTy, </span><span class="doxyHighlightStringLiteral">&quot;&#95;&#95;wasm&#95;setjmp&#95;test&quot;</span><span class="doxyHighlight">, &amp;M);</span></CodeLine>
<Link id="l01017" /><CodeLine lineNumber="1017"></CodeLine>
<Link id="l01018" /><CodeLine lineNumber="1018"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// wasm.catch() will be lowered down to wasm &#39;catch&#39; instruction in</span></CodeLine>
<Link id="l01019" /><CodeLine lineNumber="1019"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// instruction selection.</span></CodeLine>
<Link id="l01020" /><CodeLine lineNumber="1020"><span class="doxyHighlight">      CatchF = <a href="/docs/api/namespaces/llvm/intrinsic/#a0cff8be0190d8e20b7cf13646f34afa2">Intrinsic::getOrInsertDeclaration</a>(&amp;M, Intrinsic::wasm&#95;catch);</span></CodeLine>
<Link id="l01021" /><CodeLine lineNumber="1021"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Type for struct &#95;&#95;WasmLongjmpArgs</span></CodeLine>
<Link id="l01022" /><CodeLine lineNumber="1022"><span class="doxyHighlight">      LongjmpArgsTy = <a href="/docs/api/classes/llvm/structtype/#a18fc4545474c6ebb6f7c547f64f4fb31">StructType::get</a>(Int8PtrTy, </span><span class="doxyHighlightComment">// env</span></CodeLine>
<Link id="l01023" /><CodeLine lineNumber="1023"><span class="doxyHighlight">                                      <a href="/docs/api/namespaces/llvm/#a23f9ec4bb2576ca8738f3edc9c4f5cdf">Int32Ty</a>    </span><span class="doxyHighlightComment">// val</span></CodeLine>
<Link id="l01024" /><CodeLine lineNumber="1024"><span class="doxyHighlight">      );</span></CodeLine>
<Link id="l01025" /><CodeLine lineNumber="1025"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01026" /><CodeLine lineNumber="1026"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01027" /><CodeLine lineNumber="1027"></CodeLine>
<Link id="l01028" /><CodeLine lineNumber="1028"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Exception handling transformation</span></CodeLine>
<Link id="l01029" /><CodeLine lineNumber="1029"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (EnableEmEH) &#123;</span></CodeLine>
<Link id="l01030" /><CodeLine lineNumber="1030"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> : M) &#123;</span></CodeLine>
<Link id="l01031" /><CodeLine lineNumber="1031"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.isDeclaration())</span></CodeLine>
<Link id="l01032" /><CodeLine lineNumber="1032"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01033" /><CodeLine lineNumber="1033"><span class="doxyHighlight">      <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a> |= runEHOnFunction(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l01034" /><CodeLine lineNumber="1034"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01035" /><CodeLine lineNumber="1035"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01036" /><CodeLine lineNumber="1036"></CodeLine>
<Link id="l01037" /><CodeLine lineNumber="1037"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Setjmp/longjmp handling transformation</span></CodeLine>
<Link id="l01038" /><CodeLine lineNumber="1038"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (DoSjLj) &#123;</span></CodeLine>
<Link id="l01039" /><CodeLine lineNumber="1039"><span class="doxyHighlight">    <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a> = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">; </span><span class="doxyHighlightComment">// We have setjmp or longjmp somewhere</span></CodeLine>
<Link id="l01040" /><CodeLine lineNumber="1040"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LongjmpF)</span></CodeLine>
<Link id="l01041" /><CodeLine lineNumber="1041"><span class="doxyHighlight">      replaceLongjmpWith(LongjmpF, EnableEmSjLj ? EmLongjmpF : WasmLongjmpF);</span></CodeLine>
<Link id="l01042" /><CodeLine lineNumber="1042"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Only traverse functions that uses setjmp in order not to insert</span></CodeLine>
<Link id="l01043" /><CodeLine lineNumber="1043"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// unnecessary prep / cleanup code in every function</span></CodeLine>
<Link id="l01044" /><CodeLine lineNumber="1044"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SetjmpF)</span></CodeLine>
<Link id="l01045" /><CodeLine lineNumber="1045"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/function">Function</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> : SetjmpUsers)</span></CodeLine>
<Link id="l01046" /><CodeLine lineNumber="1046"><span class="doxyHighlight">        runSjLjOnFunction(&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l01047" /><CodeLine lineNumber="1047"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01048" /><CodeLine lineNumber="1048"></CodeLine>
<Link id="l01049" /><CodeLine lineNumber="1049"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Replace unnecessary setjmp calls with 0</span></CodeLine>
<Link id="l01050" /><CodeLine lineNumber="1050"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> ((EnableEmSjLj || EnableWasmSjLj) &amp;&amp; !SetjmpUsersToNullify.<a href="/docs/api/classes/llvm/smallptrsetimplbase/#af8a50544090e81ac83601aff8f4b0142">empty</a>()) &#123;</span></CodeLine>
<Link id="l01051" /><CodeLine lineNumber="1051"><span class="doxyHighlight">    <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a> = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01052" /><CodeLine lineNumber="1052"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(SetjmpF);</span></CodeLine>
<Link id="l01053" /><CodeLine lineNumber="1053"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/function">Function</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> : SetjmpUsersToNullify)</span></CodeLine>
<Link id="l01054" /><CodeLine lineNumber="1054"><span class="doxyHighlight">      <a href="#a1e5a795e237da6e01636980c98b645ab">nullifySetjmp</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l01055" /><CodeLine lineNumber="1055"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01056" /><CodeLine lineNumber="1056"></CodeLine>
<Link id="l01057" /><CodeLine lineNumber="1057"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Delete unused global variables and functions</span></CodeLine>
<Link id="l01058" /><CodeLine lineNumber="1058"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;V : &#123;ThrewGV, ThrewValueGV&#125;)</span></CodeLine>
<Link id="l01059" /><CodeLine lineNumber="1059"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (V &amp;&amp; V-&gt;use&#95;empty())</span></CodeLine>
<Link id="l01060" /><CodeLine lineNumber="1060"><span class="doxyHighlight">      V-&gt;eraseFromParent();</span></CodeLine>
<Link id="l01061" /><CodeLine lineNumber="1061"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;V : &#123;GetTempRet0F, SetTempRet0F, ResumeF, EHTypeIDF, EmLongjmpF,</span></CodeLine>
<Link id="l01062" /><CodeLine lineNumber="1062"><span class="doxyHighlight">                  WasmSetjmpF, WasmSetjmpTestF, WasmLongjmpF, CatchF&#125;)</span></CodeLine>
<Link id="l01063" /><CodeLine lineNumber="1063"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (V &amp;&amp; V-&gt;use&#95;empty())</span></CodeLine>
<Link id="l01064" /><CodeLine lineNumber="1064"><span class="doxyHighlight">      V-&gt;eraseFromParent();</span></CodeLine>
<Link id="l01065" /><CodeLine lineNumber="1065"></CodeLine>
<Link id="l01066" /><CodeLine lineNumber="1066"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a>;</span></CodeLine>
<Link id="l01067" /><CodeLine lineNumber="1067"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01068" /><CodeLine lineNumber="1068"></CodeLine>
<Link id="l01069" /><CodeLine lineNumber="1069"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> WebAssemblyLowerEmscriptenEHSjLj::runEHOnFunction(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l01070" /><CodeLine lineNumber="1070"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/module">Module</a> &amp;M = &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getParent();</span></CodeLine>
<Link id="l01071" /><CodeLine lineNumber="1071"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/llvmcontext">LLVMContext</a> &amp;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a> = <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getContext();</span></CodeLine>
<Link id="l01072" /><CodeLine lineNumber="1072"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> IRB(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>);</span></CodeLine>
<Link id="l01073" /><CodeLine lineNumber="1073"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a> = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01074" /><CodeLine lineNumber="1074"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Instruction &#42;, 64&gt;</a> ToErase;</span></CodeLine>
<Link id="l01075" /><CodeLine lineNumber="1075"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;LandingPadInst &#42;, 32&gt;</a> LandingPads;</span></CodeLine>
<Link id="l01076" /><CodeLine lineNumber="1076"></CodeLine>
<Link id="l01077" /><CodeLine lineNumber="1077"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// rethrow.longjmp BB that will be shared within the function.</span></CodeLine>
<Link id="l01078" /><CodeLine lineNumber="1078"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;RethrowLongjmpBB = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01079" /><CodeLine lineNumber="1079"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// PHI node for the loaded value of &#95;&#95;THREW&#95;&#95; global variable in</span></CodeLine>
<Link id="l01080" /><CodeLine lineNumber="1080"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// rethrow.longjmp BB</span></CodeLine>
<Link id="l01081" /><CodeLine lineNumber="1081"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;RethrowLongjmpBBThrewPHI = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01082" /><CodeLine lineNumber="1082"></CodeLine>
<Link id="l01083" /><CodeLine lineNumber="1083"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;BB : <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l01084" /><CodeLine lineNumber="1084"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;InvokeInst&gt;</a>(BB.getTerminator());</span></CodeLine>
<Link id="l01085" /><CodeLine lineNumber="1085"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a>)</span></CodeLine>
<Link id="l01086" /><CodeLine lineNumber="1086"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01087" /><CodeLine lineNumber="1087"><span class="doxyHighlight">    <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a> = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01088" /><CodeLine lineNumber="1088"><span class="doxyHighlight">    LandingPads.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a>-&gt;getLandingPadInst());</span></CodeLine>
<Link id="l01089" /><CodeLine lineNumber="1089"><span class="doxyHighlight">    IRB.SetInsertPoint(<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a>);</span></CodeLine>
<Link id="l01090" /><CodeLine lineNumber="1090"></CodeLine>
<Link id="l01091" /><CodeLine lineNumber="1091"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/value">Value</a> &#42;Callee = <a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a>-&gt;getCalledOperand();</span></CodeLine>
<Link id="l01092" /><CodeLine lineNumber="1092"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> NeedInvoke = supportsException(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &amp;&amp; <a href="#a8f4bf9ef05ac2193b41802f2e8466f66">canThrow</a>(Callee);</span></CodeLine>
<Link id="l01093" /><CodeLine lineNumber="1093"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NeedInvoke) &#123;</span></CodeLine>
<Link id="l01094" /><CodeLine lineNumber="1094"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Wrap invoke with invoke wrapper and generate preamble/postamble</span></CodeLine>
<Link id="l01095" /><CodeLine lineNumber="1095"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;Threw = wrapInvoke(<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a>);</span></CodeLine>
<Link id="l01096" /><CodeLine lineNumber="1096"><span class="doxyHighlight">      ToErase.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a>);</span></CodeLine>
<Link id="l01097" /><CodeLine lineNumber="1097"></CodeLine>
<Link id="l01098" /><CodeLine lineNumber="1098"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If setjmp/longjmp handling is enabled, the thrown value can be not an</span></CodeLine>
<Link id="l01099" /><CodeLine lineNumber="1099"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// exception but a longjmp. If the current function contains calls to</span></CodeLine>
<Link id="l01100" /><CodeLine lineNumber="1100"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// setjmp, it will be appropriately handled in runSjLjOnFunction. But even</span></CodeLine>
<Link id="l01101" /><CodeLine lineNumber="1101"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// if the function does not contain setjmp calls, we shouldn&#39;t silently</span></CodeLine>
<Link id="l01102" /><CodeLine lineNumber="1102"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// ignore longjmps; we should rethrow them so they can be correctly</span></CodeLine>
<Link id="l01103" /><CodeLine lineNumber="1103"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// handled in somewhere up the call chain where setjmp is. &#95;&#95;THREW&#95;&#95;&#39;s</span></CodeLine>
<Link id="l01104" /><CodeLine lineNumber="1104"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// value is 0 when nothing happened, 1 when an exception is thrown, and</span></CodeLine>
<Link id="l01105" /><CodeLine lineNumber="1105"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// other values when longjmp is thrown.</span></CodeLine>
<Link id="l01106" /><CodeLine lineNumber="1106"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01107" /><CodeLine lineNumber="1107"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// if (%&#95;&#95;THREW&#95;&#95;.val == 0 || %&#95;&#95;THREW&#95;&#95;.val == 1)</span></CodeLine>
<Link id="l01108" /><CodeLine lineNumber="1108"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//   goto %tail</span></CodeLine>
<Link id="l01109" /><CodeLine lineNumber="1109"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// else</span></CodeLine>
<Link id="l01110" /><CodeLine lineNumber="1110"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//   goto %longjmp.rethrow</span></CodeLine>
<Link id="l01111" /><CodeLine lineNumber="1111"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01112" /><CodeLine lineNumber="1112"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// rethrow.longjmp: ;; This is longjmp. Rethrow it</span></CodeLine>
<Link id="l01113" /><CodeLine lineNumber="1113"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//   %&#95;&#95;threwValue.val = &#95;&#95;threwValue</span></CodeLine>
<Link id="l01114" /><CodeLine lineNumber="1114"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//   emscripten&#95;longjmp(%&#95;&#95;THREW&#95;&#95;.val, %&#95;&#95;threwValue.val);</span></CodeLine>
<Link id="l01115" /><CodeLine lineNumber="1115"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01116" /><CodeLine lineNumber="1116"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// tail: ;; Nothing happened or an exception is thrown</span></CodeLine>
<Link id="l01117" /><CodeLine lineNumber="1117"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//   ... Continue exception handling ...</span></CodeLine>
<Link id="l01118" /><CodeLine lineNumber="1118"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (DoSjLj &amp;&amp; EnableEmSjLj &amp;&amp; !SetjmpUsers.count(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &amp;&amp;</span></CodeLine>
<Link id="l01119" /><CodeLine lineNumber="1119"><span class="doxyHighlight">          <a href="#a2dacd2cc5f8d003dbbf793474f06df14">canLongjmp</a>(Callee)) &#123;</span></CodeLine>
<Link id="l01120" /><CodeLine lineNumber="1120"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Create longjmp.rethrow BB once and share it within the function</span></CodeLine>
<Link id="l01121" /><CodeLine lineNumber="1121"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!RethrowLongjmpBB) &#123;</span></CodeLine>
<Link id="l01122" /><CodeLine lineNumber="1122"><span class="doxyHighlight">          RethrowLongjmpBB = <a href="/docs/api/classes/llvm/basicblock/#a4a5b798214be930cf8e133c032ba0129">BasicBlock::Create</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, </span><span class="doxyHighlightStringLiteral">&quot;rethrow.longjmp&quot;</span><span class="doxyHighlight">, &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l01123" /><CodeLine lineNumber="1123"><span class="doxyHighlight">          IRB.SetInsertPoint(RethrowLongjmpBB);</span></CodeLine>
<Link id="l01124" /><CodeLine lineNumber="1124"><span class="doxyHighlight">          RethrowLongjmpBBThrewPHI =</span></CodeLine>
<Link id="l01125" /><CodeLine lineNumber="1125"><span class="doxyHighlight">              IRB.CreatePHI(<a href="#a7db0da8464b0af856d82ee7c77519483">getAddrIntType</a>(&amp;M), 4, </span><span class="doxyHighlightStringLiteral">&quot;threw.phi&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01126" /><CodeLine lineNumber="1126"><span class="doxyHighlight">          RethrowLongjmpBBThrewPHI-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(Threw, &amp;BB);</span></CodeLine>
<Link id="l01127" /><CodeLine lineNumber="1127"><span class="doxyHighlight">          <a href="/docs/api/classes/llvm/value">Value</a> &#42;ThrewValue = IRB.CreateLoad(IRB.getInt32Ty(), ThrewValueGV,</span></CodeLine>
<Link id="l01128" /><CodeLine lineNumber="1128"><span class="doxyHighlight">                                             ThrewValueGV-&gt;getName() + </span><span class="doxyHighlightStringLiteral">&quot;.val&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01129" /><CodeLine lineNumber="1129"><span class="doxyHighlight">          IRB.CreateCall(EmLongjmpF, &#123;RethrowLongjmpBBThrewPHI, ThrewValue&#125;);</span></CodeLine>
<Link id="l01130" /><CodeLine lineNumber="1130"><span class="doxyHighlight">          IRB.CreateUnreachable();</span></CodeLine>
<Link id="l01131" /><CodeLine lineNumber="1131"><span class="doxyHighlight">        &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l01132" /><CodeLine lineNumber="1132"><span class="doxyHighlight">          RethrowLongjmpBBThrewPHI-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(Threw, &amp;BB);</span></CodeLine>
<Link id="l01133" /><CodeLine lineNumber="1133"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l01134" /><CodeLine lineNumber="1134"></CodeLine>
<Link id="l01135" /><CodeLine lineNumber="1135"><span class="doxyHighlight">        IRB.SetInsertPoint(<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a>); </span><span class="doxyHighlightComment">// Restore the insert point back</span></CodeLine>
<Link id="l01136" /><CodeLine lineNumber="1136"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cad6e9c0ff694f0fca0222e79e772b647e">Tail</a> = <a href="/docs/api/classes/llvm/basicblock/#a4a5b798214be930cf8e133c032ba0129">BasicBlock::Create</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, </span><span class="doxyHighlightStringLiteral">&quot;tail&quot;</span><span class="doxyHighlight">, &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l01137" /><CodeLine lineNumber="1137"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/value">Value</a> &#42;CmpEqOne =</span></CodeLine>
<Link id="l01138" /><CodeLine lineNumber="1138"><span class="doxyHighlight">            IRB.CreateICmpEQ(Threw, <a href="#ad2de6223491e08f9906cfd58b9db22c2">getAddrSizeInt</a>(&amp;M, 1), </span><span class="doxyHighlightStringLiteral">&quot;cmp.eq.one&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01139" /><CodeLine lineNumber="1139"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/value">Value</a> &#42;CmpEqZero =</span></CodeLine>
<Link id="l01140" /><CodeLine lineNumber="1140"><span class="doxyHighlight">            IRB.CreateICmpEQ(Threw, <a href="#ad2de6223491e08f9906cfd58b9db22c2">getAddrSizeInt</a>(&amp;M, 0), </span><span class="doxyHighlightStringLiteral">&quot;cmp.eq.zero&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01141" /><CodeLine lineNumber="1141"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/namespaces/llvm/#aac36edd0f1ce976f0025c98e88d3830ea3a2d5fe857d8f9541136a124c2edec6c">Or</a> = IRB.CreateOr(CmpEqZero, CmpEqOne, </span><span class="doxyHighlightStringLiteral">&quot;or&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01142" /><CodeLine lineNumber="1142"><span class="doxyHighlight">        IRB.CreateCondBr(<a href="/docs/api/namespaces/llvm/#aac36edd0f1ce976f0025c98e88d3830ea3a2d5fe857d8f9541136a124c2edec6c">Or</a>, <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cad6e9c0ff694f0fca0222e79e772b647e">Tail</a>, RethrowLongjmpBB);</span></CodeLine>
<Link id="l01143" /><CodeLine lineNumber="1143"><span class="doxyHighlight">        IRB.SetInsertPoint(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cad6e9c0ff694f0fca0222e79e772b647e">Tail</a>);</span></CodeLine>
<Link id="l01144" /><CodeLine lineNumber="1144"><span class="doxyHighlight">        BB.replaceSuccessorsPhiUsesWith(&amp;BB, <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cad6e9c0ff694f0fca0222e79e772b647e">Tail</a>);</span></CodeLine>
<Link id="l01145" /><CodeLine lineNumber="1145"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01146" /><CodeLine lineNumber="1146"></CodeLine>
<Link id="l01147" /><CodeLine lineNumber="1147"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Insert a branch based on &#95;&#95;THREW&#95;&#95; variable</span></CodeLine>
<Link id="l01148" /><CodeLine lineNumber="1148"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/namespaces/llvm/x86/#a86730e94ae6fdf0fe3145b2acc88dea8ac9b4c62f6dc1bc5caf3c768b687cbf7e">Cmp</a> = IRB.CreateICmpEQ(Threw, <a href="#ad2de6223491e08f9906cfd58b9db22c2">getAddrSizeInt</a>(&amp;M, 1), </span><span class="doxyHighlightStringLiteral">&quot;cmp&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01149" /><CodeLine lineNumber="1149"><span class="doxyHighlight">      IRB.CreateCondBr(Cmp, <a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a>-&gt;getUnwindDest(), <a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a>-&gt;getNormalDest());</span></CodeLine>
<Link id="l01150" /><CodeLine lineNumber="1150"></CodeLine>
<Link id="l01151" /><CodeLine lineNumber="1151"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l01152" /><CodeLine lineNumber="1152"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// This can&#39;t throw, and we don&#39;t need this invoke, just replace it with a</span></CodeLine>
<Link id="l01153" /><CodeLine lineNumber="1153"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// call+branch</span></CodeLine>
<Link id="l01154" /><CodeLine lineNumber="1154"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#a2b3fdb09b0789963c439d41fe91e44a1">changeToCall</a>(<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a>);</span></CodeLine>
<Link id="l01155" /><CodeLine lineNumber="1155"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01156" /><CodeLine lineNumber="1156"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01157" /><CodeLine lineNumber="1157"></CodeLine>
<Link id="l01158" /><CodeLine lineNumber="1158"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Process resume instructions</span></CodeLine>
<Link id="l01159" /><CodeLine lineNumber="1159"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;BB : <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l01160" /><CodeLine lineNumber="1160"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Scan the body of the basic block for resumes</span></CodeLine>
<Link id="l01161" /><CodeLine lineNumber="1161"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : BB) &#123;</span></CodeLine>
<Link id="l01162" /><CodeLine lineNumber="1162"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;RI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ResumeInst&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</span></CodeLine>
<Link id="l01163" /><CodeLine lineNumber="1163"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!RI)</span></CodeLine>
<Link id="l01164" /><CodeLine lineNumber="1164"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01165" /><CodeLine lineNumber="1165"><span class="doxyHighlight">      <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a> = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01166" /><CodeLine lineNumber="1166"></CodeLine>
<Link id="l01167" /><CodeLine lineNumber="1167"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Split the input into legal values</span></CodeLine>
<Link id="l01168" /><CodeLine lineNumber="1168"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/classes/input">Input</a> = RI-&gt;getValue();</span></CodeLine>
<Link id="l01169" /><CodeLine lineNumber="1169"><span class="doxyHighlight">      IRB.SetInsertPoint(RI);</span></CodeLine>
<Link id="l01170" /><CodeLine lineNumber="1170"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/namespaces/llvm/#a05609d049bfe3c5c2f64711566131a86a28d0edd045e05cf5af64e35ae0c4c6ef">Low</a> = IRB.CreateExtractValue(<a href="/docs/api/classes/input">Input</a>, 0, </span><span class="doxyHighlightStringLiteral">&quot;low&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01171" /><CodeLine lineNumber="1171"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Create a call to &#95;&#95;resumeException function</span></CodeLine>
<Link id="l01172" /><CodeLine lineNumber="1172"><span class="doxyHighlight">      IRB.CreateCall(ResumeF, &#123;<a href="/docs/api/namespaces/llvm/#a05609d049bfe3c5c2f64711566131a86a28d0edd045e05cf5af64e35ae0c4c6ef">Low</a>&#125;);</span></CodeLine>
<Link id="l01173" /><CodeLine lineNumber="1173"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Add a terminator to the block</span></CodeLine>
<Link id="l01174" /><CodeLine lineNumber="1174"><span class="doxyHighlight">      IRB.CreateUnreachable();</span></CodeLine>
<Link id="l01175" /><CodeLine lineNumber="1175"><span class="doxyHighlight">      ToErase.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(RI);</span></CodeLine>
<Link id="l01176" /><CodeLine lineNumber="1176"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01177" /><CodeLine lineNumber="1177"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01178" /><CodeLine lineNumber="1178"></CodeLine>
<Link id="l01179" /><CodeLine lineNumber="1179"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Process llvm.eh.typeid.for intrinsics</span></CodeLine>
<Link id="l01180" /><CodeLine lineNumber="1180"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;BB : <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l01181" /><CodeLine lineNumber="1181"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : BB) &#123;</span></CodeLine>
<Link id="l01182" /><CodeLine lineNumber="1182"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CallInst&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</span></CodeLine>
<Link id="l01183" /><CodeLine lineNumber="1183"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CI)</span></CodeLine>
<Link id="l01184" /><CodeLine lineNumber="1184"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01185" /><CodeLine lineNumber="1185"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/function">Function</a> &#42;<a href="/docs/api/namespaces/llvm/pdb/#a33e853ec74d48b1340d1d4bae772d30bac8ff9e15a93f800c74c05e7b37364816">Callee</a> = CI-&gt;<a href="/docs/api/classes/llvm/callbase/#a2b1ae7cf1bafdd43d1fee4c6ad0a2913">getCalledFunction</a>();</span></CodeLine>
<Link id="l01186" /><CodeLine lineNumber="1186"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Callee)</span></CodeLine>
<Link id="l01187" /><CodeLine lineNumber="1187"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01188" /><CodeLine lineNumber="1188"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/pdb/#a33e853ec74d48b1340d1d4bae772d30bac8ff9e15a93f800c74c05e7b37364816">Callee</a>-&gt;getIntrinsicID() != Intrinsic::eh&#95;typeid&#95;for)</span></CodeLine>
<Link id="l01189" /><CodeLine lineNumber="1189"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01190" /><CodeLine lineNumber="1190"><span class="doxyHighlight">      <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a> = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01191" /><CodeLine lineNumber="1191"></CodeLine>
<Link id="l01192" /><CodeLine lineNumber="1192"><span class="doxyHighlight">      IRB.SetInsertPoint(CI);</span></CodeLine>
<Link id="l01193" /><CodeLine lineNumber="1193"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42;NewCI =</span></CodeLine>
<Link id="l01194" /><CodeLine lineNumber="1194"><span class="doxyHighlight">          IRB.CreateCall(EHTypeIDF, CI-&gt;<a href="/docs/api/classes/llvm/callbase/#aabd76e6a8a23a5af1ce4d3c310d88bcd">getArgOperand</a>(0), </span><span class="doxyHighlightStringLiteral">&quot;typeid&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01195" /><CodeLine lineNumber="1195"><span class="doxyHighlight">      CI-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(NewCI);</span></CodeLine>
<Link id="l01196" /><CodeLine lineNumber="1196"><span class="doxyHighlight">      ToErase.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(CI);</span></CodeLine>
<Link id="l01197" /><CodeLine lineNumber="1197"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01198" /><CodeLine lineNumber="1198"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01199" /><CodeLine lineNumber="1199"></CodeLine>
<Link id="l01200" /><CodeLine lineNumber="1200"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Look for orphan landingpads, can occur in blocks with no predecessors</span></CodeLine>
<Link id="l01201" /><CodeLine lineNumber="1201"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;BB : <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l01202" /><CodeLine lineNumber="1202"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = BB.getFirstNonPHIIt();</span></CodeLine>
<Link id="l01203" /><CodeLine lineNumber="1203"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;LPI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;LandingPadInst&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</span></CodeLine>
<Link id="l01204" /><CodeLine lineNumber="1204"><span class="doxyHighlight">      LandingPads.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(LPI);</span></CodeLine>
<Link id="l01205" /><CodeLine lineNumber="1205"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01206" /><CodeLine lineNumber="1206"><span class="doxyHighlight">  <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a> |= !LandingPads.<a href="/docs/api/classes/llvm/smallptrsetimplbase/#af8a50544090e81ac83601aff8f4b0142">empty</a>();</span></CodeLine>
<Link id="l01207" /><CodeLine lineNumber="1207"></CodeLine>
<Link id="l01208" /><CodeLine lineNumber="1208"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Handle all the landingpad for this function together, as multiple invokes</span></CodeLine>
<Link id="l01209" /><CodeLine lineNumber="1209"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// may share a single lp</span></CodeLine>
<Link id="l01210" /><CodeLine lineNumber="1210"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/landingpadinst">LandingPadInst</a> &#42;LPI : LandingPads) &#123;</span></CodeLine>
<Link id="l01211" /><CodeLine lineNumber="1211"><span class="doxyHighlight">    IRB.SetInsertPoint(LPI);</span></CodeLine>
<Link id="l01212" /><CodeLine lineNumber="1212"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Value &#42;, 16&gt;</a> FMCArgs;</span></CodeLine>
<Link id="l01213" /><CodeLine lineNumber="1213"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = 0, <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#abb2b3a60ccc38a28239e19a1646e0c8a">E</a> = LPI-&gt;getNumClauses(); <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> &lt; <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#abb2b3a60ccc38a28239e19a1646e0c8a">E</a>; ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &#123;</span></CodeLine>
<Link id="l01214" /><CodeLine lineNumber="1214"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/constant">Constant</a> &#42;<a href="/docs/api/classes/llvm/clause">Clause</a> = LPI-&gt;getClause(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</span></CodeLine>
<Link id="l01215" /><CodeLine lineNumber="1215"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// TODO Handle filters (= exception specifications).</span></CodeLine>
<Link id="l01216" /><CodeLine lineNumber="1216"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// https://github.com/llvm/llvm-project/issues/49740</span></CodeLine>
<Link id="l01217" /><CodeLine lineNumber="1217"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LPI-&gt;isCatch(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</span></CodeLine>
<Link id="l01218" /><CodeLine lineNumber="1218"><span class="doxyHighlight">        FMCArgs.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(<a href="/docs/api/classes/llvm/clause">Clause</a>);</span></CodeLine>
<Link id="l01219" /><CodeLine lineNumber="1219"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01220" /><CodeLine lineNumber="1220"></CodeLine>
<Link id="l01221" /><CodeLine lineNumber="1221"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Create a call to &#95;&#95;cxa&#95;find&#95;matching&#95;catch&#95;N function</span></CodeLine>
<Link id="l01222" /><CodeLine lineNumber="1222"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/function">Function</a> &#42;FMCF = getFindMatchingCatch(M, FMCArgs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>());</span></CodeLine>
<Link id="l01223" /><CodeLine lineNumber="1223"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42;FMCI = IRB.CreateCall(FMCF, FMCArgs, </span><span class="doxyHighlightStringLiteral">&quot;fmc&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01224" /><CodeLine lineNumber="1224"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64asmprinter-cpp/#a434449d5a0f4b334aca9163b13b6286ba02b848adda8d7d33a2b25d87dbef1d75">Poison</a> = <a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(LPI-&gt;getType());</span></CodeLine>
<Link id="l01225" /><CodeLine lineNumber="1225"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;Pair0 = IRB.CreateInsertValue(<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64asmprinter-cpp/#a434449d5a0f4b334aca9163b13b6286ba02b848adda8d7d33a2b25d87dbef1d75">Poison</a>, FMCI, 0, </span><span class="doxyHighlightStringLiteral">&quot;pair0&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01226" /><CodeLine lineNumber="1226"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;TempRet0 = IRB.CreateCall(GetTempRet0F, &#123;&#125;, </span><span class="doxyHighlightStringLiteral">&quot;tempret0&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01227" /><CodeLine lineNumber="1227"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;Pair1 = IRB.CreateInsertValue(Pair0, TempRet0, 1, </span><span class="doxyHighlightStringLiteral">&quot;pair1&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01228" /><CodeLine lineNumber="1228"></CodeLine>
<Link id="l01229" /><CodeLine lineNumber="1229"><span class="doxyHighlight">    LPI-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(Pair1);</span></CodeLine>
<Link id="l01230" /><CodeLine lineNumber="1230"><span class="doxyHighlight">    ToErase.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(LPI);</span></CodeLine>
<Link id="l01231" /><CodeLine lineNumber="1231"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01232" /><CodeLine lineNumber="1232"></CodeLine>
<Link id="l01233" /><CodeLine lineNumber="1233"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Erase everything we no longer need in this function</span></CodeLine>
<Link id="l01234" /><CodeLine lineNumber="1234"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : ToErase)</span></CodeLine>
<Link id="l01235" /><CodeLine lineNumber="1235"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;eraseFromParent();</span></CodeLine>
<Link id="l01236" /><CodeLine lineNumber="1236"></CodeLine>
<Link id="l01237" /><CodeLine lineNumber="1237"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a>;</span></CodeLine>
<Link id="l01238" /><CodeLine lineNumber="1238"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01239" /><CodeLine lineNumber="1239"></CodeLine>
<Link id="l01240" /><CodeLine lineNumber="1240"><span class="doxyHighlightComment">// This tries to get debug info from the instruction before which a new</span></CodeLine>
<Link id="l01241" /><CodeLine lineNumber="1241"><span class="doxyHighlightComment">// instruction will be inserted, and if there&#39;s no debug info in that</span></CodeLine>
<Link id="l01242" /><CodeLine lineNumber="1242"><span class="doxyHighlightComment">// instruction, tries to get the info instead from the previous instruction (if</span></CodeLine>
<Link id="l01243" /><CodeLine lineNumber="1243"><span class="doxyHighlightComment">// any). If none of these has debug info and a DISubprogram is provided, it</span></CodeLine>
<Link id="l01244" /><CodeLine lineNumber="1244"><span class="doxyHighlightComment">// creates a dummy debug info with the first line of the function, because IR</span></CodeLine>
<Link id="l01245" /><CodeLine lineNumber="1245"><span class="doxyHighlightComment">// verifier requires all inlinable callsites should have debug info when both a</span></CodeLine>
<Link id="l01246" /><CodeLine lineNumber="1246"><span class="doxyHighlightComment">// caller and callee have DISubprogram. If none of these conditions are met,</span></CodeLine>
<Link id="l01247" /><CodeLine lineNumber="1247"><span class="doxyHighlightComment">// returns empty info.</span></CodeLine>
<Link id="l01248" /><CodeLine lineNumber="1248" lineLink="#aaf95913e52851622a35765cc28adf643"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> <a href="#aaf95913e52851622a35765cc28adf643">getOrCreateDebugLoc</a>(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;InsertBefore,</span></CodeLine>
<Link id="l01249" /><CodeLine lineNumber="1249"><span class="doxyHighlight">                                    <a href="/docs/api/classes/llvm/disubprogram">DISubprogram</a> &#42;SP) &#123;</span></CodeLine>
<Link id="l01250" /><CodeLine lineNumber="1250"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(InsertBefore);</span></CodeLine>
<Link id="l01251" /><CodeLine lineNumber="1251"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (InsertBefore-&gt;<a href="/docs/api/classes/llvm/instruction/#a4b8faae4ff9e7434a1d226d03d15dcd2">getDebugLoc</a>())</span></CodeLine>
<Link id="l01252" /><CodeLine lineNumber="1252"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> InsertBefore-&gt;<a href="/docs/api/classes/llvm/instruction/#a4b8faae4ff9e7434a1d226d03d15dcd2">getDebugLoc</a>();</span></CodeLine>
<Link id="l01253" /><CodeLine lineNumber="1253"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Prev = InsertBefore-&gt;<a href="/docs/api/classes/llvm/ilist-node-with-parent/#a1dfdcf6998ec28bfd2f8d2cdebc984a9">getPrevNode</a>();</span></CodeLine>
<Link id="l01254" /><CodeLine lineNumber="1254"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Prev &amp;&amp; Prev-&gt;<a href="/docs/api/classes/llvm/instruction/#a4b8faae4ff9e7434a1d226d03d15dcd2">getDebugLoc</a>())</span></CodeLine>
<Link id="l01255" /><CodeLine lineNumber="1255"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Prev-&gt;<a href="/docs/api/classes/llvm/instruction/#a4b8faae4ff9e7434a1d226d03d15dcd2">getDebugLoc</a>();</span></CodeLine>
<Link id="l01256" /><CodeLine lineNumber="1256"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SP)</span></CodeLine>
<Link id="l01257" /><CodeLine lineNumber="1257"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/mdnode/#a7d10a7b9b7f40b04d27ed97c38ea1950">DILocation::get</a>(SP-&gt;getContext(), SP-&gt;getLine(), 1, SP);</span></CodeLine>
<Link id="l01258" /><CodeLine lineNumber="1258"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a>();</span></CodeLine>
<Link id="l01259" /><CodeLine lineNumber="1259"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01260" /><CodeLine lineNumber="1260"></CodeLine>
<Link id="l01261" /><CodeLine lineNumber="1261"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> WebAssemblyLowerEmscriptenEHSjLj::runSjLjOnFunction(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l01262" /><CodeLine lineNumber="1262"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(EnableEmSjLj || EnableWasmSjLj);</span></CodeLine>
<Link id="l01263" /><CodeLine lineNumber="1263"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/module">Module</a> &amp;M = &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getParent();</span></CodeLine>
<Link id="l01264" /><CodeLine lineNumber="1264"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/llvmcontext">LLVMContext</a> &amp;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a> = <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getContext();</span></CodeLine>
<Link id="l01265" /><CodeLine lineNumber="1265"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> IRB(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>);</span></CodeLine>
<Link id="l01266" /><CodeLine lineNumber="1266"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Instruction &#42;, 64&gt;</a> ToErase;</span></CodeLine>
<Link id="l01267" /><CodeLine lineNumber="1267"></CodeLine>
<Link id="l01268" /><CodeLine lineNumber="1268"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Setjmp preparation</span></CodeLine>
<Link id="l01269" /><CodeLine lineNumber="1269"></CodeLine>
<Link id="l01270" /><CodeLine lineNumber="1270"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;<a href="/docs/api/namespaces/llvm/coff/#ae7629a0652411dc2be61aea4fee2b39caadd024eaaab0666500593f30456bbc43">Entry</a> = &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getEntryBlock();</span></CodeLine>
<Link id="l01271" /><CodeLine lineNumber="1271"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> FirstDL = <a href="#aaf95913e52851622a35765cc28adf643">getOrCreateDebugLoc</a>(&amp;&#42;<a href="/docs/api/namespaces/llvm/coff/#ae7629a0652411dc2be61aea4fee2b39caadd024eaaab0666500593f30456bbc43">Entry</a>-&gt;begin(), <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getSubprogram());</span></CodeLine>
<Link id="l01272" /><CodeLine lineNumber="1272"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#ac6c9ffe7979754415f4ca0d677174bc2">SplitBlock</a>(Entry, &amp;&#42;<a href="/docs/api/namespaces/llvm/coff/#ae7629a0652411dc2be61aea4fee2b39caadd024eaaab0666500593f30456bbc43">Entry</a>-&gt;getFirstInsertionPt());</span></CodeLine>
<Link id="l01273" /><CodeLine lineNumber="1273"></CodeLine>
<Link id="l01274" /><CodeLine lineNumber="1274"><span class="doxyHighlight">  IRB.SetInsertPoint(<a href="/docs/api/namespaces/llvm/coff/#ae7629a0652411dc2be61aea4fee2b39caadd024eaaab0666500593f30456bbc43">Entry</a>-&gt;getTerminator()-&gt;getIterator());</span></CodeLine>
<Link id="l01275" /><CodeLine lineNumber="1275"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// This alloca&#39;ed pointer is used by the runtime to identify function</span></CodeLine>
<Link id="l01276" /><CodeLine lineNumber="1276"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// invocations. It&#39;s just for pointer comparisons. It will never be</span></CodeLine>
<Link id="l01277" /><CodeLine lineNumber="1277"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// dereferenced.</span></CodeLine>
<Link id="l01278" /><CodeLine lineNumber="1278"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;FunctionInvocationId =</span></CodeLine>
<Link id="l01279" /><CodeLine lineNumber="1279"><span class="doxyHighlight">      IRB.CreateAlloca(IRB.getInt32Ty(), </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">, </span><span class="doxyHighlightStringLiteral">&quot;functionInvocationId&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01280" /><CodeLine lineNumber="1280"><span class="doxyHighlight">  FunctionInvocationId-&gt;<a href="/docs/api/classes/llvm/instruction/#ae8f5bf5cc06f696b52c709677df00fbf">setDebugLoc</a>(FirstDL);</span></CodeLine>
<Link id="l01281" /><CodeLine lineNumber="1281"></CodeLine>
<Link id="l01282" /><CodeLine lineNumber="1282"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Setjmp transformation</span></CodeLine>
<Link id="l01283" /><CodeLine lineNumber="1283"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;PHINode &#42;, 4&gt;</a> SetjmpRetPHIs;</span></CodeLine>
<Link id="l01284" /><CodeLine lineNumber="1284"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;SetjmpF = M.<a href="/docs/api/classes/llvm/function/#a8743c58384e11cb6228f6f871304ad35">getFunction</a>(</span><span class="doxyHighlightStringLiteral">&quot;setjmp&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01285" /><CodeLine lineNumber="1285"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;U : <a href="/docs/api/namespaces/llvm/#a3d2cdc4a0db233678e7141c9d6ea3419">make&#95;early&#95;inc&#95;range</a>(SetjmpF-&gt;<a href="/docs/api/classes/llvm/value/#a411cf3e3932f209ce3374cb31adc1da6">users</a>())) &#123;</span></CodeLine>
<Link id="l01286" /><CodeLine lineNumber="1286"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CB = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CallBase&gt;</a>(U);</span></CodeLine>
<Link id="l01287" /><CodeLine lineNumber="1287"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB = CB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a1b4bf7c97cdc8159fd73d48063f0b250">getParent</a>();</span></CodeLine>
<Link id="l01288" /><CodeLine lineNumber="1288"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a1b4bf7c97cdc8159fd73d48063f0b250">getParent</a>() != &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) </span><span class="doxyHighlightComment">// in other function</span></CodeLine>
<Link id="l01289" /><CodeLine lineNumber="1289"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01290" /><CodeLine lineNumber="1290"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CB-&gt;getOperandBundle(<a href="/docs/api/classes/llvm/llvmcontext/#a44d727ac5fccf852bfb2bae3e06adc9ca8997c6b0930e2c05209e95e7172c6cf3">LLVMContext::OB&#95;funclet</a>)) &#123;</span></CodeLine>
<Link id="l01291" /><CodeLine lineNumber="1291"><span class="doxyHighlight">      std::string S;</span></CodeLine>
<Link id="l01292" /><CodeLine lineNumber="1292"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/raw-string-ostream">raw&#95;string&#95;ostream</a> <a href="/docs/api/namespaces/llvm/x86as/#a58acad10b11edf7fe9b4465d6e02e9bda1337cc82304bed6c1a811f1a7f308aca">SS</a>(S);</span></CodeLine>
<Link id="l01293" /><CodeLine lineNumber="1293"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/x86as/#a58acad10b11edf7fe9b4465d6e02e9bda1337cc82304bed6c1a811f1a7f308aca">SS</a> &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;In function &quot;</span><span class="doxyHighlight"> + <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getName() +</span></CodeLine>
<Link id="l01294" /><CodeLine lineNumber="1294"><span class="doxyHighlight">                </span><span class="doxyHighlightStringLiteral">&quot;: setjmp within a catch clause is not supported in Wasm EH:\\n&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01295" /><CodeLine lineNumber="1295"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/x86as/#a58acad10b11edf7fe9b4465d6e02e9bda1337cc82304bed6c1a811f1a7f308aca">SS</a> &lt;&lt; &#42;CB;</span></CodeLine>
<Link id="l01296" /><CodeLine lineNumber="1296"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(<a href="/docs/api/classes/llvm/stringref">StringRef</a>(<a href="/docs/api/namespaces/llvm/x86as/#a58acad10b11edf7fe9b4465d6e02e9bda1337cc82304bed6c1a811f1a7f308aca">SS</a>.str()));</span></CodeLine>
<Link id="l01297" /><CodeLine lineNumber="1297"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01298" /><CodeLine lineNumber="1298"></CodeLine>
<Link id="l01299" /><CodeLine lineNumber="1299"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42;CI = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01300" /><CodeLine lineNumber="1300"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// setjmp cannot throw. So if it is an invoke, lower it to a call</span></CodeLine>
<Link id="l01301" /><CodeLine lineNumber="1301"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;InvokeInst&gt;</a>(CB))</span></CodeLine>
<Link id="l01302" /><CodeLine lineNumber="1302"><span class="doxyHighlight">      CI = <a href="/docs/api/namespaces/llvm/#a2b3fdb09b0789963c439d41fe91e44a1">llvm::changeToCall</a>(<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a>);</span></CodeLine>
<Link id="l01303" /><CodeLine lineNumber="1303"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l01304" /><CodeLine lineNumber="1304"><span class="doxyHighlight">      CI = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CallInst&gt;</a>(CB);</span></CodeLine>
<Link id="l01305" /><CodeLine lineNumber="1305"></CodeLine>
<Link id="l01306" /><CodeLine lineNumber="1306"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// The tail is everything right after the call, and will be reached once</span></CodeLine>
<Link id="l01307" /><CodeLine lineNumber="1307"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// when setjmp is called, and later when longjmp returns to the setjmp</span></CodeLine>
<Link id="l01308" /><CodeLine lineNumber="1308"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cad6e9c0ff694f0fca0222e79e772b647e">Tail</a> = <a href="/docs/api/namespaces/llvm/#ac6c9ffe7979754415f4ca0d677174bc2">SplitBlock</a>(BB, CI-&gt;<a href="/docs/api/classes/llvm/ilist-node-with-parent/#a62ee7ece4986606d41363bc1f70d5ab2">getNextNode</a>());</span></CodeLine>
<Link id="l01309" /><CodeLine lineNumber="1309"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Add a phi to the tail, which will be the output of setjmp, which</span></CodeLine>
<Link id="l01310" /><CodeLine lineNumber="1310"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// indicates if this is the first call or a longjmp back. The phi directly</span></CodeLine>
<Link id="l01311" /><CodeLine lineNumber="1311"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// uses the right value based on where we arrive from</span></CodeLine>
<Link id="l01312" /><CodeLine lineNumber="1312"><span class="doxyHighlight">    IRB.SetInsertPoint(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cad6e9c0ff694f0fca0222e79e772b647e">Tail</a>, <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cad6e9c0ff694f0fca0222e79e772b647e">Tail</a>-&gt;getFirstNonPHIIt());</span></CodeLine>
<Link id="l01313" /><CodeLine lineNumber="1313"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;SetjmpRet = IRB.CreatePHI(IRB.getInt32Ty(), 2, </span><span class="doxyHighlightStringLiteral">&quot;setjmp.ret&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01314" /><CodeLine lineNumber="1314"></CodeLine>
<Link id="l01315" /><CodeLine lineNumber="1315"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// setjmp initial call returns 0</span></CodeLine>
<Link id="l01316" /><CodeLine lineNumber="1316"><span class="doxyHighlight">    SetjmpRet-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(IRB.getInt32(0), BB);</span></CodeLine>
<Link id="l01317" /><CodeLine lineNumber="1317"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// The proper output is now this, not the setjmp call itself</span></CodeLine>
<Link id="l01318" /><CodeLine lineNumber="1318"><span class="doxyHighlight">    CI-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(SetjmpRet);</span></CodeLine>
<Link id="l01319" /><CodeLine lineNumber="1319"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// longjmp returns to the setjmp will add themselves to this phi</span></CodeLine>
<Link id="l01320" /><CodeLine lineNumber="1320"><span class="doxyHighlight">    SetjmpRetPHIs.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(SetjmpRet);</span></CodeLine>
<Link id="l01321" /><CodeLine lineNumber="1321"></CodeLine>
<Link id="l01322" /><CodeLine lineNumber="1322"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Fix call target</span></CodeLine>
<Link id="l01323" /><CodeLine lineNumber="1323"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Our index in the function is our place in the array + 1 to avoid index</span></CodeLine>
<Link id="l01324" /><CodeLine lineNumber="1324"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// 0, because index 0 means the longjmp is not ours to handle.</span></CodeLine>
<Link id="l01325" /><CodeLine lineNumber="1325"><span class="doxyHighlight">    IRB.SetInsertPoint(CI);</span></CodeLine>
<Link id="l01326" /><CodeLine lineNumber="1326"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/namespaces/llvm/amdgpu/hsamd/kernel/key/#a1958a762261549463a280bac3274d6d5">Args</a>&#91;&#93; = &#123;CI-&gt;<a href="/docs/api/classes/llvm/callbase/#aabd76e6a8a23a5af1ce4d3c310d88bcd">getArgOperand</a>(0), IRB.getInt32(SetjmpRetPHIs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>()),</span></CodeLine>
<Link id="l01327" /><CodeLine lineNumber="1327"><span class="doxyHighlight">                     FunctionInvocationId&#125;;</span></CodeLine>
<Link id="l01328" /><CodeLine lineNumber="1328"><span class="doxyHighlight">    IRB.CreateCall(WasmSetjmpF, Args);</span></CodeLine>
<Link id="l01329" /><CodeLine lineNumber="1329"><span class="doxyHighlight">    ToErase.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(CI);</span></CodeLine>
<Link id="l01330" /><CodeLine lineNumber="1330"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01331" /><CodeLine lineNumber="1331"></CodeLine>
<Link id="l01332" /><CodeLine lineNumber="1332"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Handle longjmpable calls.</span></CodeLine>
<Link id="l01333" /><CodeLine lineNumber="1333"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (EnableEmSjLj)</span></CodeLine>
<Link id="l01334" /><CodeLine lineNumber="1334"><span class="doxyHighlight">    handleLongjmpableCallsForEmscriptenSjLj(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, FunctionInvocationId,</span></CodeLine>
<Link id="l01335" /><CodeLine lineNumber="1335"><span class="doxyHighlight">                                            SetjmpRetPHIs);</span></CodeLine>
<Link id="l01336" /><CodeLine lineNumber="1336"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightComment">// EnableWasmSjLj</span></CodeLine>
<Link id="l01337" /><CodeLine lineNumber="1337"><span class="doxyHighlight">    handleLongjmpableCallsForWasmSjLj(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, FunctionInvocationId, SetjmpRetPHIs);</span></CodeLine>
<Link id="l01338" /><CodeLine lineNumber="1338"></CodeLine>
<Link id="l01339" /><CodeLine lineNumber="1339"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Erase everything we no longer need in this function</span></CodeLine>
<Link id="l01340" /><CodeLine lineNumber="1340"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : ToErase)</span></CodeLine>
<Link id="l01341" /><CodeLine lineNumber="1341"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;eraseFromParent();</span></CodeLine>
<Link id="l01342" /><CodeLine lineNumber="1342"></CodeLine>
<Link id="l01343" /><CodeLine lineNumber="1343"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Finally, our modifications to the cfg can break dominance of SSA variables.</span></CodeLine>
<Link id="l01344" /><CodeLine lineNumber="1344"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For example, in this code,</span></CodeLine>
<Link id="l01345" /><CodeLine lineNumber="1345"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// if (x()) &#123; .. setjmp() .. &#125;</span></CodeLine>
<Link id="l01346" /><CodeLine lineNumber="1346"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// if (y()) &#123; .. longjmp() .. &#125;</span></CodeLine>
<Link id="l01347" /><CodeLine lineNumber="1347"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We must split the longjmp block, and it can jump into the block splitted</span></CodeLine>
<Link id="l01348" /><CodeLine lineNumber="1348"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// from setjmp one. But that means that when we split the setjmp block, it&#39;s</span></CodeLine>
<Link id="l01349" /><CodeLine lineNumber="1349"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// first part no longer dominates its second part - there is a theoretically</span></CodeLine>
<Link id="l01350" /><CodeLine lineNumber="1350"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// possible control flow path where x() is false, then y() is true and we</span></CodeLine>
<Link id="l01351" /><CodeLine lineNumber="1351"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// reach the second part of the setjmp block, without ever reaching the first</span></CodeLine>
<Link id="l01352" /><CodeLine lineNumber="1352"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// part. So, we rebuild SSA form here.</span></CodeLine>
<Link id="l01353" /><CodeLine lineNumber="1353"><span class="doxyHighlight">  rebuildSSA(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l01354" /><CodeLine lineNumber="1354"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01355" /><CodeLine lineNumber="1355"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01356" /><CodeLine lineNumber="1356"></CodeLine>
<Link id="l01357" /><CodeLine lineNumber="1357"><span class="doxyHighlightComment">// Update each call that can longjmp so it can return to the corresponding</span></CodeLine>
<Link id="l01358" /><CodeLine lineNumber="1358"><span class="doxyHighlightComment">// setjmp. Refer to 4) of &quot;Emscripten setjmp/longjmp handling&quot; section in the</span></CodeLine>
<Link id="l01359" /><CodeLine lineNumber="1359"><span class="doxyHighlightComment">// comments at top of the file for details.</span></CodeLine>
<Link id="l01360" /><CodeLine lineNumber="1360"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> WebAssemblyLowerEmscriptenEHSjLj::handleLongjmpableCallsForEmscriptenSjLj(</span></CodeLine>
<Link id="l01361" /><CodeLine lineNumber="1361"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;FunctionInvocationId,</span></CodeLine>
<Link id="l01362" /><CodeLine lineNumber="1362"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;PHINode &#42;&gt;</a> &amp;SetjmpRetPHIs) &#123;</span></CodeLine>
<Link id="l01363" /><CodeLine lineNumber="1363"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/module">Module</a> &amp;M = &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getParent();</span></CodeLine>
<Link id="l01364" /><CodeLine lineNumber="1364"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/llvmcontext">LLVMContext</a> &amp;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a> = <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getContext();</span></CodeLine>
<Link id="l01365" /><CodeLine lineNumber="1365"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> IRB(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>);</span></CodeLine>
<Link id="l01366" /><CodeLine lineNumber="1366"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Instruction &#42;, 64&gt;</a> ToErase;</span></CodeLine>
<Link id="l01367" /><CodeLine lineNumber="1367"></CodeLine>
<Link id="l01368" /><CodeLine lineNumber="1368"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// call.em.longjmp BB that will be shared within the function.</span></CodeLine>
<Link id="l01369" /><CodeLine lineNumber="1369"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;CallEmLongjmpBB = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01370" /><CodeLine lineNumber="1370"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// PHI node for the loaded value of &#95;&#95;THREW&#95;&#95; global variable in</span></CodeLine>
<Link id="l01371" /><CodeLine lineNumber="1371"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// call.em.longjmp BB</span></CodeLine>
<Link id="l01372" /><CodeLine lineNumber="1372"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;CallEmLongjmpBBThrewPHI = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01373" /><CodeLine lineNumber="1373"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// PHI node for the loaded value of &#95;&#95;threwValue global variable in</span></CodeLine>
<Link id="l01374" /><CodeLine lineNumber="1374"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// call.em.longjmp BB</span></CodeLine>
<Link id="l01375" /><CodeLine lineNumber="1375"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;CallEmLongjmpBBThrewValuePHI = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01376" /><CodeLine lineNumber="1376"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// rethrow.exn BB that will be shared within the function.</span></CodeLine>
<Link id="l01377" /><CodeLine lineNumber="1377"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;RethrowExnBB = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01378" /><CodeLine lineNumber="1378"></CodeLine>
<Link id="l01379" /><CodeLine lineNumber="1379"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Because we are creating new BBs while processing and don&#39;t want to make</span></CodeLine>
<Link id="l01380" /><CodeLine lineNumber="1380"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// all these newly created BBs candidates again for longjmp processing, we</span></CodeLine>
<Link id="l01381" /><CodeLine lineNumber="1381"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// first make the vector of candidate BBs.</span></CodeLine>
<Link id="l01382" /><CodeLine lineNumber="1382"><span class="doxyHighlight">  std::vector&lt;BasicBlock &#42;&gt; BBs;</span></CodeLine>
<Link id="l01383" /><CodeLine lineNumber="1383"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;BB : <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>)</span></CodeLine>
<Link id="l01384" /><CodeLine lineNumber="1384"><span class="doxyHighlight">    BBs.push&#95;back(&amp;BB);</span></CodeLine>
<Link id="l01385" /><CodeLine lineNumber="1385"></CodeLine>
<Link id="l01386" /><CodeLine lineNumber="1386"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// BBs.size() will change within the loop, so we query it every time</span></CodeLine>
<Link id="l01387" /><CodeLine lineNumber="1387"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = 0; <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> &lt; BBs.size(); <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>++) &#123;</span></CodeLine>
<Link id="l01388" /><CodeLine lineNumber="1388"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB = BBs&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93;;</span></CodeLine>
<Link id="l01389" /><CodeLine lineNumber="1389"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : &#42;BB) &#123;</span></CodeLine>
<Link id="l01390" /><CodeLine lineNumber="1390"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;InvokeInst&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) &#123;</span></CodeLine>
<Link id="l01391" /><CodeLine lineNumber="1391"><span class="doxyHighlight">        std::string S;</span></CodeLine>
<Link id="l01392" /><CodeLine lineNumber="1392"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/raw-string-ostream">raw&#95;string&#95;ostream</a> <a href="/docs/api/namespaces/llvm/x86as/#a58acad10b11edf7fe9b4465d6e02e9bda1337cc82304bed6c1a811f1a7f308aca">SS</a>(S);</span></CodeLine>
<Link id="l01393" /><CodeLine lineNumber="1393"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/x86as/#a58acad10b11edf7fe9b4465d6e02e9bda1337cc82304bed6c1a811f1a7f308aca">SS</a> &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;In function &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getName()</span></CodeLine>
<Link id="l01394" /><CodeLine lineNumber="1394"><span class="doxyHighlight">           &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;: When using Wasm EH with Emscripten SjLj, there is a &quot;</span></CodeLine>
<Link id="l01395" /><CodeLine lineNumber="1395"><span class="doxyHighlight">              </span><span class="doxyHighlightStringLiteral">&quot;restriction that &#96;setjmp&#96; function call and exception cannot be &quot;</span></CodeLine>
<Link id="l01396" /><CodeLine lineNumber="1396"><span class="doxyHighlight">              </span><span class="doxyHighlightStringLiteral">&quot;used within the same function:\\n&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01397" /><CodeLine lineNumber="1397"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/x86as/#a58acad10b11edf7fe9b4465d6e02e9bda1337cc82304bed6c1a811f1a7f308aca">SS</a> &lt;&lt; <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</span></CodeLine>
<Link id="l01398" /><CodeLine lineNumber="1398"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(<a href="/docs/api/classes/llvm/stringref">StringRef</a>(<a href="/docs/api/namespaces/llvm/x86as/#a58acad10b11edf7fe9b4465d6e02e9bda1337cc82304bed6c1a811f1a7f308aca">SS</a>.str()));</span></CodeLine>
<Link id="l01399" /><CodeLine lineNumber="1399"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01400" /><CodeLine lineNumber="1400"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CallInst&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</span></CodeLine>
<Link id="l01401" /><CodeLine lineNumber="1401"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CI)</span></CodeLine>
<Link id="l01402" /><CodeLine lineNumber="1402"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01403" /><CodeLine lineNumber="1403"></CodeLine>
<Link id="l01404" /><CodeLine lineNumber="1404"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/namespaces/llvm/pdb/#a33e853ec74d48b1340d1d4bae772d30bac8ff9e15a93f800c74c05e7b37364816">Callee</a> = CI-&gt;<a href="/docs/api/classes/llvm/callbase/#a8d13199cbf4d080d3b5dcf330dad5d2c">getCalledOperand</a>();</span></CodeLine>
<Link id="l01405" /><CodeLine lineNumber="1405"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="#a2dacd2cc5f8d003dbbf793474f06df14">canLongjmp</a>(Callee))</span></CodeLine>
<Link id="l01406" /><CodeLine lineNumber="1406"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01407" /><CodeLine lineNumber="1407"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#ae471a184f6df0ce3df8700257824906d">isEmAsmCall</a>(Callee))</span></CodeLine>
<Link id="l01408" /><CodeLine lineNumber="1408"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(</span><span class="doxyHighlightStringLiteral">&quot;Cannot use EM&#95;ASM&#42; alongside setjmp/longjmp in &quot;</span><span class="doxyHighlight"> +</span></CodeLine>
<Link id="l01409" /><CodeLine lineNumber="1409"><span class="doxyHighlight">                               <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getName() +</span></CodeLine>
<Link id="l01410" /><CodeLine lineNumber="1410"><span class="doxyHighlight">                               </span><span class="doxyHighlightStringLiteral">&quot;. Please consider using EM&#95;JS, or move the &quot;</span></CodeLine>
<Link id="l01411" /><CodeLine lineNumber="1411"><span class="doxyHighlight">                               </span><span class="doxyHighlightStringLiteral">&quot;EM&#95;ASM into another function.&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l01412" /><CodeLine lineNumber="1412"><span class="doxyHighlight">                           </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01413" /><CodeLine lineNumber="1413"></CodeLine>
<Link id="l01414" /><CodeLine lineNumber="1414"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;Threw = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01415" /><CodeLine lineNumber="1415"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cad6e9c0ff694f0fca0222e79e772b647e">Tail</a>;</span></CodeLine>
<Link id="l01416" /><CodeLine lineNumber="1416"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/pdb/#a33e853ec74d48b1340d1d4bae772d30bac8ff9e15a93f800c74c05e7b37364816">Callee</a>-&gt;getName().starts&#95;with(</span><span class="doxyHighlightStringLiteral">&quot;&#95;&#95;invoke&#95;&quot;</span><span class="doxyHighlight">)) &#123;</span></CodeLine>
<Link id="l01417" /><CodeLine lineNumber="1417"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// If invoke wrapper has already been generated for this call in</span></CodeLine>
<Link id="l01418" /><CodeLine lineNumber="1418"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// previous EH phase, search for the load instruction</span></CodeLine>
<Link id="l01419" /><CodeLine lineNumber="1419"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// %&#95;&#95;THREW&#95;&#95;.val = &#95;&#95;THREW&#95;&#95;;</span></CodeLine>
<Link id="l01420" /><CodeLine lineNumber="1420"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// in postamble after the invoke wrapper call</span></CodeLine>
<Link id="l01421" /><CodeLine lineNumber="1421"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/loadinst">LoadInst</a> &#42;ThrewLI = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01422" /><CodeLine lineNumber="1422"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/storeinst">StoreInst</a> &#42;ThrewResetSI = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01423" /><CodeLine lineNumber="1423"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = std::next(<a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a>(CI)), IE = BB-&gt;end();</span></CodeLine>
<Link id="l01424" /><CodeLine lineNumber="1424"><span class="doxyHighlight">             <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> != IE; ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &#123;</span></CodeLine>
<Link id="l01425" /><CodeLine lineNumber="1425"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;LI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;LoadInst&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</span></CodeLine>
<Link id="l01426" /><CodeLine lineNumber="1426"><span class="doxyHighlight">            </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;GV = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;GlobalVariable&gt;</a>(LI-&gt;getPointerOperand()))</span></CodeLine>
<Link id="l01427" /><CodeLine lineNumber="1427"><span class="doxyHighlight">              </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (GV == ThrewGV) &#123;</span></CodeLine>
<Link id="l01428" /><CodeLine lineNumber="1428"><span class="doxyHighlight">                Threw = ThrewLI = LI;</span></CodeLine>
<Link id="l01429" /><CodeLine lineNumber="1429"><span class="doxyHighlight">                </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01430" /><CodeLine lineNumber="1430"><span class="doxyHighlight">              &#125;</span></CodeLine>
<Link id="l01431" /><CodeLine lineNumber="1431"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l01432" /><CodeLine lineNumber="1432"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Search for the store instruction after the load above</span></CodeLine>
<Link id="l01433" /><CodeLine lineNumber="1433"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// &#95;&#95;THREW&#95;&#95; = 0;</span></CodeLine>
<Link id="l01434" /><CodeLine lineNumber="1434"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = std::next(<a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a>(ThrewLI)), IE = BB-&gt;end();</span></CodeLine>
<Link id="l01435" /><CodeLine lineNumber="1435"><span class="doxyHighlight">             <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> != IE; ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &#123;</span></CodeLine>
<Link id="l01436" /><CodeLine lineNumber="1436"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/namespaces/llvm/si">SI</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;StoreInst&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) &#123;</span></CodeLine>
<Link id="l01437" /><CodeLine lineNumber="1437"><span class="doxyHighlight">            </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;GV = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;GlobalVariable&gt;</a>(<a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getPointerOperand())) &#123;</span></CodeLine>
<Link id="l01438" /><CodeLine lineNumber="1438"><span class="doxyHighlight">              </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (GV == ThrewGV &amp;&amp;</span></CodeLine>
<Link id="l01439" /><CodeLine lineNumber="1439"><span class="doxyHighlight">                  <a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getValueOperand() == <a href="#ad2de6223491e08f9906cfd58b9db22c2">getAddrSizeInt</a>(&amp;M, 0)) &#123;</span></CodeLine>
<Link id="l01440" /><CodeLine lineNumber="1440"><span class="doxyHighlight">                ThrewResetSI = <a href="/docs/api/namespaces/llvm/si">SI</a>;</span></CodeLine>
<Link id="l01441" /><CodeLine lineNumber="1441"><span class="doxyHighlight">                </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01442" /><CodeLine lineNumber="1442"><span class="doxyHighlight">              &#125;</span></CodeLine>
<Link id="l01443" /><CodeLine lineNumber="1443"><span class="doxyHighlight">            &#125;</span></CodeLine>
<Link id="l01444" /><CodeLine lineNumber="1444"><span class="doxyHighlight">          &#125;</span></CodeLine>
<Link id="l01445" /><CodeLine lineNumber="1445"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l01446" /><CodeLine lineNumber="1446"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Threw &amp;&amp; ThrewLI &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Cannot find &#95;&#95;THREW&#95;&#95; load after invoke&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01447" /><CodeLine lineNumber="1447"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(ThrewResetSI &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Cannot find &#95;&#95;THREW&#95;&#95; store after invoke&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01448" /><CodeLine lineNumber="1448"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cad6e9c0ff694f0fca0222e79e772b647e">Tail</a> = <a href="/docs/api/namespaces/llvm/#ac6c9ffe7979754415f4ca0d677174bc2">SplitBlock</a>(BB, ThrewResetSI-&gt;<a href="/docs/api/classes/llvm/ilist-node-with-parent/#a62ee7ece4986606d41363bc1f70d5ab2">getNextNode</a>());</span></CodeLine>
<Link id="l01449" /><CodeLine lineNumber="1449"></CodeLine>
<Link id="l01450" /><CodeLine lineNumber="1450"><span class="doxyHighlight">      &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l01451" /><CodeLine lineNumber="1451"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Wrap call with invoke wrapper and generate preamble/postamble</span></CodeLine>
<Link id="l01452" /><CodeLine lineNumber="1452"><span class="doxyHighlight">        Threw = wrapInvoke(CI);</span></CodeLine>
<Link id="l01453" /><CodeLine lineNumber="1453"><span class="doxyHighlight">        ToErase.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(CI);</span></CodeLine>
<Link id="l01454" /><CodeLine lineNumber="1454"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cad6e9c0ff694f0fca0222e79e772b647e">Tail</a> = <a href="/docs/api/namespaces/llvm/#ac6c9ffe7979754415f4ca0d677174bc2">SplitBlock</a>(BB, CI-&gt;<a href="/docs/api/classes/llvm/ilist-node-with-parent/#a62ee7ece4986606d41363bc1f70d5ab2">getNextNode</a>());</span></CodeLine>
<Link id="l01455" /><CodeLine lineNumber="1455"></CodeLine>
<Link id="l01456" /><CodeLine lineNumber="1456"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// If exception handling is enabled, the thrown value can be not a</span></CodeLine>
<Link id="l01457" /><CodeLine lineNumber="1457"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// longjmp but an exception, in which case we shouldn&#39;t silently ignore</span></CodeLine>
<Link id="l01458" /><CodeLine lineNumber="1458"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// exceptions; we should rethrow them.</span></CodeLine>
<Link id="l01459" /><CodeLine lineNumber="1459"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// &#95;&#95;THREW&#95;&#95;&#39;s value is 0 when nothing happened, 1 when an exception is</span></CodeLine>
<Link id="l01460" /><CodeLine lineNumber="1460"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// thrown, other values when longjmp is thrown.</span></CodeLine>
<Link id="l01461" /><CodeLine lineNumber="1461"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01462" /><CodeLine lineNumber="1462"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// if (%&#95;&#95;THREW&#95;&#95;.val == 1)</span></CodeLine>
<Link id="l01463" /><CodeLine lineNumber="1463"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">//   goto %eh.rethrow</span></CodeLine>
<Link id="l01464" /><CodeLine lineNumber="1464"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// else</span></CodeLine>
<Link id="l01465" /><CodeLine lineNumber="1465"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">//   goto %normal</span></CodeLine>
<Link id="l01466" /><CodeLine lineNumber="1466"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01467" /><CodeLine lineNumber="1467"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// eh.rethrow: ;; Rethrow exception</span></CodeLine>
<Link id="l01468" /><CodeLine lineNumber="1468"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">//   %exn = call @&#95;&#95;cxa&#95;find&#95;matching&#95;catch&#95;2() ;; Retrieve thrown ptr</span></CodeLine>
<Link id="l01469" /><CodeLine lineNumber="1469"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">//   &#95;&#95;resumeException(%exn)</span></CodeLine>
<Link id="l01470" /><CodeLine lineNumber="1470"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01471" /><CodeLine lineNumber="1471"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// normal:</span></CodeLine>
<Link id="l01472" /><CodeLine lineNumber="1472"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">//   &lt;-- Insertion point. Will insert sjlj handling code from here</span></CodeLine>
<Link id="l01473" /><CodeLine lineNumber="1473"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">//   goto %tail</span></CodeLine>
<Link id="l01474" /><CodeLine lineNumber="1474"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01475" /><CodeLine lineNumber="1475"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// tail:</span></CodeLine>
<Link id="l01476" /><CodeLine lineNumber="1476"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">//   ...</span></CodeLine>
<Link id="l01477" /><CodeLine lineNumber="1477"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (supportsException(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &amp;&amp; <a href="#a8f4bf9ef05ac2193b41802f2e8466f66">canThrow</a>(Callee)) &#123;</span></CodeLine>
<Link id="l01478" /><CodeLine lineNumber="1478"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// We will add a new conditional branch. So remove the branch created</span></CodeLine>
<Link id="l01479" /><CodeLine lineNumber="1479"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// when we split the BB</span></CodeLine>
<Link id="l01480" /><CodeLine lineNumber="1480"><span class="doxyHighlight">          ToErase.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(BB-&gt;getTerminator());</span></CodeLine>
<Link id="l01481" /><CodeLine lineNumber="1481"></CodeLine>
<Link id="l01482" /><CodeLine lineNumber="1482"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// Generate rethrow.exn BB once and share it within the function</span></CodeLine>
<Link id="l01483" /><CodeLine lineNumber="1483"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!RethrowExnBB) &#123;</span></CodeLine>
<Link id="l01484" /><CodeLine lineNumber="1484"><span class="doxyHighlight">            RethrowExnBB = <a href="/docs/api/classes/llvm/basicblock/#a4a5b798214be930cf8e133c032ba0129">BasicBlock::Create</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, </span><span class="doxyHighlightStringLiteral">&quot;rethrow.exn&quot;</span><span class="doxyHighlight">, &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l01485" /><CodeLine lineNumber="1485"><span class="doxyHighlight">            IRB.SetInsertPoint(RethrowExnBB);</span></CodeLine>
<Link id="l01486" /><CodeLine lineNumber="1486"><span class="doxyHighlight">            <a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42;Exn =</span></CodeLine>
<Link id="l01487" /><CodeLine lineNumber="1487"><span class="doxyHighlight">                IRB.CreateCall(getFindMatchingCatch(M, 0), &#123;&#125;, </span><span class="doxyHighlightStringLiteral">&quot;exn&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01488" /><CodeLine lineNumber="1488"><span class="doxyHighlight">            IRB.CreateCall(ResumeF, &#123;Exn&#125;);</span></CodeLine>
<Link id="l01489" /><CodeLine lineNumber="1489"><span class="doxyHighlight">            IRB.CreateUnreachable();</span></CodeLine>
<Link id="l01490" /><CodeLine lineNumber="1490"><span class="doxyHighlight">          &#125;</span></CodeLine>
<Link id="l01491" /><CodeLine lineNumber="1491"></CodeLine>
<Link id="l01492" /><CodeLine lineNumber="1492"><span class="doxyHighlight">          IRB.SetInsertPoint(CI);</span></CodeLine>
<Link id="l01493" /><CodeLine lineNumber="1493"><span class="doxyHighlight">          <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NormalBB = <a href="/docs/api/classes/llvm/basicblock/#a4a5b798214be930cf8e133c032ba0129">BasicBlock::Create</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, </span><span class="doxyHighlightStringLiteral">&quot;normal&quot;</span><span class="doxyHighlight">, &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l01494" /><CodeLine lineNumber="1494"><span class="doxyHighlight">          <a href="/docs/api/classes/llvm/value">Value</a> &#42;CmpEqOne =</span></CodeLine>
<Link id="l01495" /><CodeLine lineNumber="1495"><span class="doxyHighlight">              IRB.CreateICmpEQ(Threw, <a href="#ad2de6223491e08f9906cfd58b9db22c2">getAddrSizeInt</a>(&amp;M, 1), </span><span class="doxyHighlightStringLiteral">&quot;cmp.eq.one&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01496" /><CodeLine lineNumber="1496"><span class="doxyHighlight">          IRB.CreateCondBr(CmpEqOne, RethrowExnBB, NormalBB);</span></CodeLine>
<Link id="l01497" /><CodeLine lineNumber="1497"></CodeLine>
<Link id="l01498" /><CodeLine lineNumber="1498"><span class="doxyHighlight">          IRB.SetInsertPoint(NormalBB);</span></CodeLine>
<Link id="l01499" /><CodeLine lineNumber="1499"><span class="doxyHighlight">          IRB.CreateBr(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cad6e9c0ff694f0fca0222e79e772b647e">Tail</a>);</span></CodeLine>
<Link id="l01500" /><CodeLine lineNumber="1500"><span class="doxyHighlight">          BB = NormalBB; </span><span class="doxyHighlightComment">// New insertion point to insert &#95;&#95;wasm&#95;setjmp&#95;test()</span></CodeLine>
<Link id="l01501" /><CodeLine lineNumber="1501"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l01502" /><CodeLine lineNumber="1502"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01503" /><CodeLine lineNumber="1503"></CodeLine>
<Link id="l01504" /><CodeLine lineNumber="1504"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// We need to replace the terminator in Tail - SplitBlock makes BB go</span></CodeLine>
<Link id="l01505" /><CodeLine lineNumber="1505"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// straight to Tail, we need to check if a longjmp occurred, and go to the</span></CodeLine>
<Link id="l01506" /><CodeLine lineNumber="1506"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// right setjmp-tail if so</span></CodeLine>
<Link id="l01507" /><CodeLine lineNumber="1507"><span class="doxyHighlight">      ToErase.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(BB-&gt;getTerminator());</span></CodeLine>
<Link id="l01508" /><CodeLine lineNumber="1508"></CodeLine>
<Link id="l01509" /><CodeLine lineNumber="1509"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Generate a function call to &#95;&#95;wasm&#95;setjmp&#95;test function and</span></CodeLine>
<Link id="l01510" /><CodeLine lineNumber="1510"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// preamble/postamble code to figure out (1) whether longjmp</span></CodeLine>
<Link id="l01511" /><CodeLine lineNumber="1511"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// occurred (2) if longjmp occurred, which setjmp it corresponds to</span></CodeLine>
<Link id="l01512" /><CodeLine lineNumber="1512"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/namespaces/llvm/pdb/#a33e853ec74d48b1340d1d4bae772d30bab021df6aac4654c454f46c77646e745f">Label</a> = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01513" /><CodeLine lineNumber="1513"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;LongjmpResult = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01514" /><CodeLine lineNumber="1514"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;EndBB = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01515" /><CodeLine lineNumber="1515"><span class="doxyHighlight">      wrapTestSetjmp(BB, CI-&gt;<a href="/docs/api/classes/llvm/instruction/#a4b8faae4ff9e7434a1d226d03d15dcd2">getDebugLoc</a>(), Threw, FunctionInvocationId, Label,</span></CodeLine>
<Link id="l01516" /><CodeLine lineNumber="1516"><span class="doxyHighlight">                     LongjmpResult, CallEmLongjmpBB, CallEmLongjmpBBThrewPHI,</span></CodeLine>
<Link id="l01517" /><CodeLine lineNumber="1517"><span class="doxyHighlight">                     CallEmLongjmpBBThrewValuePHI, EndBB);</span></CodeLine>
<Link id="l01518" /><CodeLine lineNumber="1518"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Label &amp;&amp; LongjmpResult &amp;&amp; EndBB);</span></CodeLine>
<Link id="l01519" /><CodeLine lineNumber="1519"></CodeLine>
<Link id="l01520" /><CodeLine lineNumber="1520"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Create switch instruction</span></CodeLine>
<Link id="l01521" /><CodeLine lineNumber="1521"><span class="doxyHighlight">      IRB.SetInsertPoint(EndBB);</span></CodeLine>
<Link id="l01522" /><CodeLine lineNumber="1522"><span class="doxyHighlight">      IRB.SetCurrentDebugLocation(EndBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a2d071e661a02790177ba05f62c7c27d1">back</a>().<a href="/docs/api/classes/llvm/instruction/#a4b8faae4ff9e7434a1d226d03d15dcd2">getDebugLoc</a>());</span></CodeLine>
<Link id="l01523" /><CodeLine lineNumber="1523"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/switchinst">SwitchInst</a> &#42;<a href="/docs/api/namespaces/llvm/si">SI</a> = IRB.CreateSwitch(Label, <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cad6e9c0ff694f0fca0222e79e772b647e">Tail</a>, SetjmpRetPHIs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>());</span></CodeLine>
<Link id="l01524" /><CodeLine lineNumber="1524"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// -1 means no longjmp happened, continue normally (will hit the default</span></CodeLine>
<Link id="l01525" /><CodeLine lineNumber="1525"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// switch case). 0 means a longjmp that is not ours to handle, needs a</span></CodeLine>
<Link id="l01526" /><CodeLine lineNumber="1526"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// rethrow. Otherwise the index is the same as the index in P+1 (to avoid</span></CodeLine>
<Link id="l01527" /><CodeLine lineNumber="1527"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// 0).</span></CodeLine>
<Link id="l01528" /><CodeLine lineNumber="1528"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = 0; <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> &lt; SetjmpRetPHIs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>(); <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>++) &#123;</span></CodeLine>
<Link id="l01529" /><CodeLine lineNumber="1529"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;addCase(IRB.getInt32(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> + 1), SetjmpRetPHIs&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93;-&gt;getParent());</span></CodeLine>
<Link id="l01530" /><CodeLine lineNumber="1530"><span class="doxyHighlight">        SetjmpRetPHIs&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93;-&gt;addIncoming(LongjmpResult, EndBB);</span></CodeLine>
<Link id="l01531" /><CodeLine lineNumber="1531"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01532" /><CodeLine lineNumber="1532"></CodeLine>
<Link id="l01533" /><CodeLine lineNumber="1533"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// We are splitting the block here, and must continue to find other calls</span></CodeLine>
<Link id="l01534" /><CodeLine lineNumber="1534"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// in the block - which is now split. so continue to traverse in the Tail</span></CodeLine>
<Link id="l01535" /><CodeLine lineNumber="1535"><span class="doxyHighlight">      BBs.push&#95;back(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cad6e9c0ff694f0fca0222e79e772b647e">Tail</a>);</span></CodeLine>
<Link id="l01536" /><CodeLine lineNumber="1536"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01537" /><CodeLine lineNumber="1537"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01538" /><CodeLine lineNumber="1538"></CodeLine>
<Link id="l01539" /><CodeLine lineNumber="1539"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : ToErase)</span></CodeLine>
<Link id="l01540" /><CodeLine lineNumber="1540"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;eraseFromParent();</span></CodeLine>
<Link id="l01541" /><CodeLine lineNumber="1541"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01542" /><CodeLine lineNumber="1542"></CodeLine>
<Link id="l01543" /><CodeLine lineNumber="1543" lineLink="#aa3b0ffc4e031802ced683f381cac97af"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;<a href="#aa3b0ffc4e031802ced683f381cac97af">getCleanupRetUnwindDest</a>(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cleanuppadinst">CleanupPadInst</a> &#42;CPI) &#123;</span></CodeLine>
<Link id="l01544" /><CodeLine lineNumber="1544"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/user">User</a> &#42;U : CPI-&gt;<a href="/docs/api/classes/llvm/value/#a411cf3e3932f209ce3374cb31adc1da6">users</a>())</span></CodeLine>
<Link id="l01545" /><CodeLine lineNumber="1545"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CRI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CleanupReturnInst&gt;</a>(U))</span></CodeLine>
<Link id="l01546" /><CodeLine lineNumber="1546"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> CRI-&gt;getUnwindDest();</span></CodeLine>
<Link id="l01547" /><CodeLine lineNumber="1547"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01548" /><CodeLine lineNumber="1548"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01549" /><CodeLine lineNumber="1549"></CodeLine>
<Link id="l01550" /><CodeLine lineNumber="1550"><span class="doxyHighlightComment">// Create a catchpad in which we catch a longjmp&#39;s env and val arguments, test</span></CodeLine>
<Link id="l01551" /><CodeLine lineNumber="1551"><span class="doxyHighlightComment">// if the longjmp corresponds to one of setjmps in the current function, and if</span></CodeLine>
<Link id="l01552" /><CodeLine lineNumber="1552"><span class="doxyHighlightComment">// so, jump to the setjmp dispatch BB from which we go to one of post-setjmp</span></CodeLine>
<Link id="l01553" /><CodeLine lineNumber="1553"><span class="doxyHighlightComment">// BBs. Refer to 4) of &quot;Wasm setjmp/longjmp handling&quot; section in the comments at</span></CodeLine>
<Link id="l01554" /><CodeLine lineNumber="1554"><span class="doxyHighlightComment">// top of the file for details.</span></CodeLine>
<Link id="l01555" /><CodeLine lineNumber="1555"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> WebAssemblyLowerEmscriptenEHSjLj::handleLongjmpableCallsForWasmSjLj(</span></CodeLine>
<Link id="l01556" /><CodeLine lineNumber="1556"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;FunctionInvocationId,</span></CodeLine>
<Link id="l01557" /><CodeLine lineNumber="1557"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;PHINode &#42;&gt;</a> &amp;SetjmpRetPHIs) &#123;</span></CodeLine>
<Link id="l01558" /><CodeLine lineNumber="1558"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/module">Module</a> &amp;M = &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getParent();</span></CodeLine>
<Link id="l01559" /><CodeLine lineNumber="1559"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/llvmcontext">LLVMContext</a> &amp;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a> = <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getContext();</span></CodeLine>
<Link id="l01560" /><CodeLine lineNumber="1560"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> IRB(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>);</span></CodeLine>
<Link id="l01561" /><CodeLine lineNumber="1561"></CodeLine>
<Link id="l01562" /><CodeLine lineNumber="1562"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// A function with catchswitch/catchpad instruction should have a personality</span></CodeLine>
<Link id="l01563" /><CodeLine lineNumber="1563"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// function attached to it. Search for the wasm personality function, and if</span></CodeLine>
<Link id="l01564" /><CodeLine lineNumber="1564"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// it exists, use it, and if it doesn&#39;t, create a dummy personality function.</span></CodeLine>
<Link id="l01565" /><CodeLine lineNumber="1565"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// (SjLj is not going to call it anyway.)</span></CodeLine>
<Link id="l01566" /><CodeLine lineNumber="1566"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.hasPersonalityFn()) &#123;</span></CodeLine>
<Link id="l01567" /><CodeLine lineNumber="1567"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/stringref">StringRef</a> PersName = <a href="/docs/api/namespaces/llvm/#a11830db2d4bbb3726de01e2a70a98327">getEHPersonalityName</a>(<a href="/docs/api/namespaces/llvm/#a5d56157a385f8cd7d3e54ed87da1ba6aa7939c43653700c52daa7a68a575c3ec5">EHPersonality::Wasm&#95;CXX</a>);</span></CodeLine>
<Link id="l01568" /><CodeLine lineNumber="1568"><span class="doxyHighlight">    <a href="/docs/api/classes/functiontype">FunctionType</a> &#42;PersType =</span></CodeLine>
<Link id="l01569" /><CodeLine lineNumber="1569"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/functiontype/#af8be7844c269f201ebcee1e15048c378">FunctionType::get</a>(IRB.getInt32Ty(), </span><span class="doxyHighlightComment">/&#42; isVarArg &#42;/</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01570" /><CodeLine lineNumber="1570"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;PersF = M.getOrInsertFunction(PersName, PersType).getCallee();</span></CodeLine>
<Link id="l01571" /><CodeLine lineNumber="1571"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.setPersonalityFn(</span></CodeLine>
<Link id="l01572" /><CodeLine lineNumber="1572"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Constant&gt;</a>(IRB.CreateBitCast(PersF, IRB.getPtrTy())));</span></CodeLine>
<Link id="l01573" /><CodeLine lineNumber="1573"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01574" /><CodeLine lineNumber="1574"></CodeLine>
<Link id="l01575" /><CodeLine lineNumber="1575"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Use the entry BB&#39;s debugloc as a fallback</span></CodeLine>
<Link id="l01576" /><CodeLine lineNumber="1576"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;<a href="/docs/api/namespaces/llvm/coff/#ae7629a0652411dc2be61aea4fee2b39caadd024eaaab0666500593f30456bbc43">Entry</a> = &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getEntryBlock();</span></CodeLine>
<Link id="l01577" /><CodeLine lineNumber="1577"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> FirstDL = <a href="#aaf95913e52851622a35765cc28adf643">getOrCreateDebugLoc</a>(&amp;&#42;<a href="/docs/api/namespaces/llvm/coff/#ae7629a0652411dc2be61aea4fee2b39caadd024eaaab0666500593f30456bbc43">Entry</a>-&gt;begin(), <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getSubprogram());</span></CodeLine>
<Link id="l01578" /><CodeLine lineNumber="1578"><span class="doxyHighlight">  IRB.SetCurrentDebugLocation(FirstDL);</span></CodeLine>
<Link id="l01579" /><CodeLine lineNumber="1579"></CodeLine>
<Link id="l01580" /><CodeLine lineNumber="1580"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Add setjmp.dispatch BB right after the entry block. Because we have</span></CodeLine>
<Link id="l01581" /><CodeLine lineNumber="1581"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// initialized functionInvocationId in the entry block and split the</span></CodeLine>
<Link id="l01582" /><CodeLine lineNumber="1582"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// rest into another BB, here &#39;OrigEntry&#39; is the function&#39;s original entry</span></CodeLine>
<Link id="l01583" /><CodeLine lineNumber="1583"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// block before the transformation.</span></CodeLine>
<Link id="l01584" /><CodeLine lineNumber="1584"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01585" /><CodeLine lineNumber="1585"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// entry:</span></CodeLine>
<Link id="l01586" /><CodeLine lineNumber="1586"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   functionInvocationId initialization</span></CodeLine>
<Link id="l01587" /><CodeLine lineNumber="1587"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// setjmp.dispatch:</span></CodeLine>
<Link id="l01588" /><CodeLine lineNumber="1588"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   switch will be inserted here later</span></CodeLine>
<Link id="l01589" /><CodeLine lineNumber="1589"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// entry.split: (OrigEntry)</span></CodeLine>
<Link id="l01590" /><CodeLine lineNumber="1590"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   the original function starts here</span></CodeLine>
<Link id="l01591" /><CodeLine lineNumber="1591"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;OrigEntry = <a href="/docs/api/namespaces/llvm/coff/#ae7629a0652411dc2be61aea4fee2b39caadd024eaaab0666500593f30456bbc43">Entry</a>-&gt;getNextNode();</span></CodeLine>
<Link id="l01592" /><CodeLine lineNumber="1592"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;SetjmpDispatchBB =</span></CodeLine>
<Link id="l01593" /><CodeLine lineNumber="1593"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/basicblock/#a4a5b798214be930cf8e133c032ba0129">BasicBlock::Create</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, </span><span class="doxyHighlightStringLiteral">&quot;setjmp.dispatch&quot;</span><span class="doxyHighlight">, &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, OrigEntry);</span></CodeLine>
<Link id="l01594" /><CodeLine lineNumber="1594"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BranchInst&gt;</a>(<a href="/docs/api/namespaces/llvm/coff/#ae7629a0652411dc2be61aea4fee2b39caadd024eaaab0666500593f30456bbc43">Entry</a>-&gt;getTerminator())-&gt;setSuccessor(0, SetjmpDispatchBB);</span></CodeLine>
<Link id="l01595" /><CodeLine lineNumber="1595"></CodeLine>
<Link id="l01596" /><CodeLine lineNumber="1596"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create catch.dispatch.longjmp BB and a catchswitch instruction</span></CodeLine>
<Link id="l01597" /><CodeLine lineNumber="1597"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;CatchDispatchLongjmpBB =</span></CodeLine>
<Link id="l01598" /><CodeLine lineNumber="1598"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/basicblock/#a4a5b798214be930cf8e133c032ba0129">BasicBlock::Create</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, </span><span class="doxyHighlightStringLiteral">&quot;catch.dispatch.longjmp&quot;</span><span class="doxyHighlight">, &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l01599" /><CodeLine lineNumber="1599"><span class="doxyHighlight">  IRB.SetInsertPoint(CatchDispatchLongjmpBB);</span></CodeLine>
<Link id="l01600" /><CodeLine lineNumber="1600"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/catchswitchinst">CatchSwitchInst</a> &#42;CatchSwitchLongjmp =</span></CodeLine>
<Link id="l01601" /><CodeLine lineNumber="1601"><span class="doxyHighlight">      IRB.CreateCatchSwitch(<a href="/docs/api/classes/llvm/constanttokennone/#a8e29fb8e39fb67b3bb746dbba47fcb29">ConstantTokenNone::get</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>), </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">, 1);</span></CodeLine>
<Link id="l01602" /><CodeLine lineNumber="1602"></CodeLine>
<Link id="l01603" /><CodeLine lineNumber="1603"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create catch.longjmp BB and a catchpad instruction</span></CodeLine>
<Link id="l01604" /><CodeLine lineNumber="1604"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;CatchLongjmpBB = <a href="/docs/api/classes/llvm/basicblock/#a4a5b798214be930cf8e133c032ba0129">BasicBlock::Create</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, </span><span class="doxyHighlightStringLiteral">&quot;catch.longjmp&quot;</span><span class="doxyHighlight">, &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l01605" /><CodeLine lineNumber="1605"><span class="doxyHighlight">  CatchSwitchLongjmp-&gt;<a href="/docs/api/classes/llvm/catchswitchinst/#a4b1438bbee79540a0cca9a2c018b71ec">addHandler</a>(CatchLongjmpBB);</span></CodeLine>
<Link id="l01606" /><CodeLine lineNumber="1606"><span class="doxyHighlight">  IRB.SetInsertPoint(CatchLongjmpBB);</span></CodeLine>
<Link id="l01607" /><CodeLine lineNumber="1607"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/catchpadinst">CatchPadInst</a> &#42;CatchPad = IRB.CreateCatchPad(CatchSwitchLongjmp, &#123;&#125;);</span></CodeLine>
<Link id="l01608" /><CodeLine lineNumber="1608"></CodeLine>
<Link id="l01609" /><CodeLine lineNumber="1609"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Wasm throw and catch instructions can throw and catch multiple values, but</span></CodeLine>
<Link id="l01610" /><CodeLine lineNumber="1610"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// that requires multivalue support in the toolchain, which is currently not</span></CodeLine>
<Link id="l01611" /><CodeLine lineNumber="1611"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// very reliable. We instead throw and catch a pointer to a struct value of</span></CodeLine>
<Link id="l01612" /><CodeLine lineNumber="1612"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// type &#39;struct &#95;&#95;WasmLongjmpArgs&#39;, which is defined in Emscripten.</span></CodeLine>
<Link id="l01613" /><CodeLine lineNumber="1613"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;LongjmpArgs =</span></CodeLine>
<Link id="l01614" /><CodeLine lineNumber="1614"><span class="doxyHighlight">      IRB.CreateCall(CatchF, &#123;IRB.getInt32(<a href="/docs/api/namespaces/llvm/webassembly/#a2ce2d5b62438d2fa7d7cb37d232f52a1a9401129ec84978eddfb390a99db7adf9">WebAssembly::C&#95;LONGJMP</a>)&#125;, </span><span class="doxyHighlightStringLiteral">&quot;thrown&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01615" /><CodeLine lineNumber="1615"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;EnvField =</span></CodeLine>
<Link id="l01616" /><CodeLine lineNumber="1616"><span class="doxyHighlight">      IRB.CreateConstGEP2&#95;32(LongjmpArgsTy, LongjmpArgs, 0, 0, </span><span class="doxyHighlightStringLiteral">&quot;env&#95;gep&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01617" /><CodeLine lineNumber="1617"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;ValField =</span></CodeLine>
<Link id="l01618" /><CodeLine lineNumber="1618"><span class="doxyHighlight">      IRB.CreateConstGEP2&#95;32(LongjmpArgsTy, LongjmpArgs, 0, 1, </span><span class="doxyHighlightStringLiteral">&quot;val&#95;gep&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01619" /><CodeLine lineNumber="1619"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// void &#42;env = &#95;&#95;wasm&#95;longjmp&#95;args.env;</span></CodeLine>
<Link id="l01620" /><CodeLine lineNumber="1620"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Env = IRB.CreateLoad(IRB.getPtrTy(), EnvField, </span><span class="doxyHighlightStringLiteral">&quot;env&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01621" /><CodeLine lineNumber="1621"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// int val = &#95;&#95;wasm&#95;longjmp&#95;args.val;</span></CodeLine>
<Link id="l01622" /><CodeLine lineNumber="1622"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Val = IRB.CreateLoad(IRB.getInt32Ty(), ValField, </span><span class="doxyHighlightStringLiteral">&quot;val&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01623" /><CodeLine lineNumber="1623"></CodeLine>
<Link id="l01624" /><CodeLine lineNumber="1624"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// %label = &#95;&#95;wasm&#95;setjmp&#95;test(%env, functionInvocatinoId);</span></CodeLine>
<Link id="l01625" /><CodeLine lineNumber="1625"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// if (%label == 0)</span></CodeLine>
<Link id="l01626" /><CodeLine lineNumber="1626"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   &#95;&#95;wasm&#95;longjmp(%env, %val)</span></CodeLine>
<Link id="l01627" /><CodeLine lineNumber="1627"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// catchret to %setjmp.dispatch</span></CodeLine>
<Link id="l01628" /><CodeLine lineNumber="1628"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ThenBB = <a href="/docs/api/classes/llvm/basicblock/#a4a5b798214be930cf8e133c032ba0129">BasicBlock::Create</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, </span><span class="doxyHighlightStringLiteral">&quot;if.then&quot;</span><span class="doxyHighlight">, &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l01629" /><CodeLine lineNumber="1629"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;EndBB = <a href="/docs/api/classes/llvm/basicblock/#a4a5b798214be930cf8e133c032ba0129">BasicBlock::Create</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, </span><span class="doxyHighlightStringLiteral">&quot;if.end&quot;</span><span class="doxyHighlight">, &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l01630" /><CodeLine lineNumber="1630"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;EnvP = IRB.CreateBitCast(Env, <a href="#a59656c1055ce3a231bba72ea31edfb14">getAddrPtrType</a>(&amp;M), </span><span class="doxyHighlightStringLiteral">&quot;env.p&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01631" /><CodeLine lineNumber="1631"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/namespaces/llvm/pdb/#a33e853ec74d48b1340d1d4bae772d30bab021df6aac4654c454f46c77646e745f">Label</a> = IRB.CreateCall(WasmSetjmpTestF, &#123;EnvP, FunctionInvocationId&#125;,</span></CodeLine>
<Link id="l01632" /><CodeLine lineNumber="1632"><span class="doxyHighlight">                                <a href="/docs/api/namespaces/llvm/#aa97c65466bdd34abda6772dd32eb5d19">OperandBundleDef</a>(</span><span class="doxyHighlightStringLiteral">&quot;funclet&quot;</span><span class="doxyHighlight">, CatchPad), </span><span class="doxyHighlightStringLiteral">&quot;label&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01633" /><CodeLine lineNumber="1633"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/namespaces/llvm/x86/#a86730e94ae6fdf0fe3145b2acc88dea8ac9b4c62f6dc1bc5caf3c768b687cbf7e">Cmp</a> = IRB.CreateICmpEQ(Label, IRB.getInt32(0));</span></CodeLine>
<Link id="l01634" /><CodeLine lineNumber="1634"><span class="doxyHighlight">  IRB.CreateCondBr(Cmp, ThenBB, EndBB);</span></CodeLine>
<Link id="l01635" /><CodeLine lineNumber="1635"></CodeLine>
<Link id="l01636" /><CodeLine lineNumber="1636"><span class="doxyHighlight">  IRB.SetInsertPoint(ThenBB);</span></CodeLine>
<Link id="l01637" /><CodeLine lineNumber="1637"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42;WasmLongjmpCI = IRB.CreateCall(</span></CodeLine>
<Link id="l01638" /><CodeLine lineNumber="1638"><span class="doxyHighlight">      WasmLongjmpF, &#123;Env, Val&#125;, <a href="/docs/api/namespaces/llvm/#aa97c65466bdd34abda6772dd32eb5d19">OperandBundleDef</a>(</span><span class="doxyHighlightStringLiteral">&quot;funclet&quot;</span><span class="doxyHighlight">, CatchPad));</span></CodeLine>
<Link id="l01639" /><CodeLine lineNumber="1639"><span class="doxyHighlight">  IRB.CreateUnreachable();</span></CodeLine>
<Link id="l01640" /><CodeLine lineNumber="1640"></CodeLine>
<Link id="l01641" /><CodeLine lineNumber="1641"><span class="doxyHighlight">  IRB.SetInsertPoint(EndBB);</span></CodeLine>
<Link id="l01642" /><CodeLine lineNumber="1642"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Jump to setjmp.dispatch block</span></CodeLine>
<Link id="l01643" /><CodeLine lineNumber="1643"><span class="doxyHighlight">  IRB.CreateCatchRet(CatchPad, SetjmpDispatchBB);</span></CodeLine>
<Link id="l01644" /><CodeLine lineNumber="1644"></CodeLine>
<Link id="l01645" /><CodeLine lineNumber="1645"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Go back to setjmp.dispatch BB</span></CodeLine>
<Link id="l01646" /><CodeLine lineNumber="1646"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// setjmp.dispatch:</span></CodeLine>
<Link id="l01647" /><CodeLine lineNumber="1647"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   switch %label &#123;</span></CodeLine>
<Link id="l01648" /><CodeLine lineNumber="1648"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     label 1: goto post-setjmp BB 1</span></CodeLine>
<Link id="l01649" /><CodeLine lineNumber="1649"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     label 2: goto post-setjmp BB 2</span></CodeLine>
<Link id="l01650" /><CodeLine lineNumber="1650"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     ...</span></CodeLine>
<Link id="l01651" /><CodeLine lineNumber="1651"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//     default: goto splitted next BB</span></CodeLine>
<Link id="l01652" /><CodeLine lineNumber="1652"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   &#125;</span></CodeLine>
<Link id="l01653" /><CodeLine lineNumber="1653"><span class="doxyHighlight">  IRB.SetInsertPoint(SetjmpDispatchBB);</span></CodeLine>
<Link id="l01654" /><CodeLine lineNumber="1654"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;LabelPHI = IRB.CreatePHI(IRB.getInt32Ty(), 2, </span><span class="doxyHighlightStringLiteral">&quot;label.phi&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01655" /><CodeLine lineNumber="1655"><span class="doxyHighlight">  LabelPHI-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(Label, EndBB);</span></CodeLine>
<Link id="l01656" /><CodeLine lineNumber="1656"><span class="doxyHighlight">  LabelPHI-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(IRB.getInt32(-1), Entry);</span></CodeLine>
<Link id="l01657" /><CodeLine lineNumber="1657"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/switchinst">SwitchInst</a> &#42;<a href="/docs/api/namespaces/llvm/si">SI</a> = IRB.CreateSwitch(LabelPHI, OrigEntry, SetjmpRetPHIs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>());</span></CodeLine>
<Link id="l01658" /><CodeLine lineNumber="1658"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// -1 means no longjmp happened, continue normally (will hit the default</span></CodeLine>
<Link id="l01659" /><CodeLine lineNumber="1659"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// switch case). 0 means a longjmp that is not ours to handle, needs a</span></CodeLine>
<Link id="l01660" /><CodeLine lineNumber="1660"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// rethrow. Otherwise the index is the same as the index in P+1 (to avoid</span></CodeLine>
<Link id="l01661" /><CodeLine lineNumber="1661"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// 0).</span></CodeLine>
<Link id="l01662" /><CodeLine lineNumber="1662"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = 0; <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> &lt; SetjmpRetPHIs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>(); <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>++) &#123;</span></CodeLine>
<Link id="l01663" /><CodeLine lineNumber="1663"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;addCase(IRB.getInt32(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> + 1), SetjmpRetPHIs&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93;-&gt;getParent());</span></CodeLine>
<Link id="l01664" /><CodeLine lineNumber="1664"><span class="doxyHighlight">    SetjmpRetPHIs&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93;-&gt;addIncoming(Val, SetjmpDispatchBB);</span></CodeLine>
<Link id="l01665" /><CodeLine lineNumber="1665"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01666" /><CodeLine lineNumber="1666"></CodeLine>
<Link id="l01667" /><CodeLine lineNumber="1667"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Convert all longjmpable call instructions to invokes that unwind to the</span></CodeLine>
<Link id="l01668" /><CodeLine lineNumber="1668"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// newly created catch.dispatch.longjmp BB.</span></CodeLine>
<Link id="l01669" /><CodeLine lineNumber="1669"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;CallInst &#42;, 64&gt;</a> LongjmpableCalls;</span></CodeLine>
<Link id="l01670" /><CodeLine lineNumber="1670"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;BB = &amp;&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.begin(); BB; BB = BB-&gt;getNextNode()) &#123;</span></CodeLine>
<Link id="l01671" /><CodeLine lineNumber="1671"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : &#42;BB) &#123;</span></CodeLine>
<Link id="l01672" /><CodeLine lineNumber="1672"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CallInst&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</span></CodeLine>
<Link id="l01673" /><CodeLine lineNumber="1673"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CI)</span></CodeLine>
<Link id="l01674" /><CodeLine lineNumber="1674"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01675" /><CodeLine lineNumber="1675"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/namespaces/llvm/pdb/#a33e853ec74d48b1340d1d4bae772d30bac8ff9e15a93f800c74c05e7b37364816">Callee</a> = CI-&gt;<a href="/docs/api/classes/llvm/callbase/#a8d13199cbf4d080d3b5dcf330dad5d2c">getCalledOperand</a>();</span></CodeLine>
<Link id="l01676" /><CodeLine lineNumber="1676"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="#a2dacd2cc5f8d003dbbf793474f06df14">canLongjmp</a>(Callee))</span></CodeLine>
<Link id="l01677" /><CodeLine lineNumber="1677"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01678" /><CodeLine lineNumber="1678"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#ae471a184f6df0ce3df8700257824906d">isEmAsmCall</a>(Callee))</span></CodeLine>
<Link id="l01679" /><CodeLine lineNumber="1679"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(</span><span class="doxyHighlightStringLiteral">&quot;Cannot use EM&#95;ASM&#42; alongside setjmp/longjmp in &quot;</span><span class="doxyHighlight"> +</span></CodeLine>
<Link id="l01680" /><CodeLine lineNumber="1680"><span class="doxyHighlight">                               <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getName() +</span></CodeLine>
<Link id="l01681" /><CodeLine lineNumber="1681"><span class="doxyHighlight">                               </span><span class="doxyHighlightStringLiteral">&quot;. Please consider using EM&#95;JS, or move the &quot;</span></CodeLine>
<Link id="l01682" /><CodeLine lineNumber="1682"><span class="doxyHighlight">                               </span><span class="doxyHighlightStringLiteral">&quot;EM&#95;ASM into another function.&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l01683" /><CodeLine lineNumber="1683"><span class="doxyHighlight">                           </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01684" /><CodeLine lineNumber="1684"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// This is &#95;&#95;wasm&#95;longjmp() call we inserted in this function, which</span></CodeLine>
<Link id="l01685" /><CodeLine lineNumber="1685"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// rethrows the longjmp when the longjmp does not correspond to one of</span></CodeLine>
<Link id="l01686" /><CodeLine lineNumber="1686"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// setjmps in this function. We should not convert this call to an invoke.</span></CodeLine>
<Link id="l01687" /><CodeLine lineNumber="1687"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CI == WasmLongjmpCI)</span></CodeLine>
<Link id="l01688" /><CodeLine lineNumber="1688"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01689" /><CodeLine lineNumber="1689"><span class="doxyHighlight">      LongjmpableCalls.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(CI);</span></CodeLine>
<Link id="l01690" /><CodeLine lineNumber="1690"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01691" /><CodeLine lineNumber="1691"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01692" /><CodeLine lineNumber="1692"></CodeLine>
<Link id="l01693" /><CodeLine lineNumber="1693"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;BasicBlock &#42;, SmallSetVector&lt;BasicBlock &#42;, 4&gt;</a>, 4&gt;</span></CodeLine>
<Link id="l01694" /><CodeLine lineNumber="1694"><span class="doxyHighlight">      UnwindDestToNewPreds;</span></CodeLine>
<Link id="l01695" /><CodeLine lineNumber="1695"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CI : LongjmpableCalls) &#123;</span></CodeLine>
<Link id="l01696" /><CodeLine lineNumber="1696"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Even if the callee function has attribute &#39;nounwind&#39;, which is true for</span></CodeLine>
<Link id="l01697" /><CodeLine lineNumber="1697"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// all C functions, it can longjmp, which means it can throw a Wasm</span></CodeLine>
<Link id="l01698" /><CodeLine lineNumber="1698"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// exception now.</span></CodeLine>
<Link id="l01699" /><CodeLine lineNumber="1699"><span class="doxyHighlight">    CI-&gt;<a href="/docs/api/classes/llvm/callbase/#acd7acfca49e931306ba40f1eb6939f67">removeFnAttr</a>(Attribute::NoUnwind);</span></CodeLine>
<Link id="l01700" /><CodeLine lineNumber="1700"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/function">Function</a> &#42;CalleeF = CI-&gt;<a href="/docs/api/classes/llvm/callbase/#a2b1ae7cf1bafdd43d1fee4c6ad0a2913">getCalledFunction</a>())</span></CodeLine>
<Link id="l01701" /><CodeLine lineNumber="1701"><span class="doxyHighlight">      CalleeF-&gt;removeFnAttr(Attribute::NoUnwind);</span></CodeLine>
<Link id="l01702" /><CodeLine lineNumber="1702"></CodeLine>
<Link id="l01703" /><CodeLine lineNumber="1703"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Change it to an invoke and make it unwind to the catch.dispatch.longjmp</span></CodeLine>
<Link id="l01704" /><CodeLine lineNumber="1704"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// BB. If the call is enclosed in another catchpad/cleanuppad scope, unwind</span></CodeLine>
<Link id="l01705" /><CodeLine lineNumber="1705"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// to its parent pad&#39;s unwind destination instead to preserve the scope</span></CodeLine>
<Link id="l01706" /><CodeLine lineNumber="1706"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// structure. It will eventually unwind to the catch.dispatch.longjmp.</span></CodeLine>
<Link id="l01707" /><CodeLine lineNumber="1707"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;OperandBundleDef, 1&gt;</a> Bundles;</span></CodeLine>
<Link id="l01708" /><CodeLine lineNumber="1708"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;UnwindDest = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01709" /><CodeLine lineNumber="1709"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Bundle = CI-&gt;<a href="/docs/api/classes/llvm/callbase/#a23ab5f34fb7b9476d45da0102ecbfae6">getOperandBundle</a>(<a href="/docs/api/classes/llvm/llvmcontext/#a44d727ac5fccf852bfb2bae3e06adc9ca8997c6b0930e2c05209e95e7172c6cf3">LLVMContext::OB&#95;funclet</a>)) &#123;</span></CodeLine>
<Link id="l01710" /><CodeLine lineNumber="1710"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;FromPad = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Instruction&gt;</a>(Bundle-&gt;Inputs&#91;0&#93;);</span></CodeLine>
<Link id="l01711" /><CodeLine lineNumber="1711"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">while</span><span class="doxyHighlight"> (!UnwindDest) &#123;</span></CodeLine>
<Link id="l01712" /><CodeLine lineNumber="1712"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CPI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CatchPadInst&gt;</a>(FromPad)) &#123;</span></CodeLine>
<Link id="l01713" /><CodeLine lineNumber="1713"><span class="doxyHighlight">          UnwindDest = CPI-&gt;getCatchSwitch()-&gt;getUnwindDest();</span></CodeLine>
<Link id="l01714" /><CodeLine lineNumber="1714"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01715" /><CodeLine lineNumber="1715"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l01716" /><CodeLine lineNumber="1716"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CPI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CleanupPadInst&gt;</a>(FromPad)) &#123;</span></CodeLine>
<Link id="l01717" /><CodeLine lineNumber="1717"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// getCleanupRetUnwindDest() can return nullptr when</span></CodeLine>
<Link id="l01718" /><CodeLine lineNumber="1718"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// 1 This cleanuppad&#39;s matching cleanupret uwninds to caller</span></CodeLine>
<Link id="l01719" /><CodeLine lineNumber="1719"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// 2 There is no matching cleanupret because it ends with</span></CodeLine>
<Link id="l01720" /><CodeLine lineNumber="1720"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">//    unreachable.</span></CodeLine>
<Link id="l01721" /><CodeLine lineNumber="1721"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// In case of 2, we need to traverse the parent pad chain.</span></CodeLine>
<Link id="l01722" /><CodeLine lineNumber="1722"><span class="doxyHighlight">          UnwindDest = <a href="#aa3b0ffc4e031802ced683f381cac97af">getCleanupRetUnwindDest</a>(CPI);</span></CodeLine>
<Link id="l01723" /><CodeLine lineNumber="1723"><span class="doxyHighlight">          <a href="/docs/api/classes/llvm/value">Value</a> &#42;ParentPad = CPI-&gt;getParentPad();</span></CodeLine>
<Link id="l01724" /><CodeLine lineNumber="1724"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;ConstantTokenNone&gt;</a>(ParentPad))</span></CodeLine>
<Link id="l01725" /><CodeLine lineNumber="1725"><span class="doxyHighlight">            </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01726" /><CodeLine lineNumber="1726"><span class="doxyHighlight">          FromPad = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Instruction&gt;</a>(ParentPad);</span></CodeLine>
<Link id="l01727" /><CodeLine lineNumber="1727"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l01728" /><CodeLine lineNumber="1728"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01729" /><CodeLine lineNumber="1729"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01730" /><CodeLine lineNumber="1730"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!UnwindDest)</span></CodeLine>
<Link id="l01731" /><CodeLine lineNumber="1731"><span class="doxyHighlight">      UnwindDest = CatchDispatchLongjmpBB;</span></CodeLine>
<Link id="l01732" /><CodeLine lineNumber="1732"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Because we are changing a longjmpable call to an invoke, its unwind</span></CodeLine>
<Link id="l01733" /><CodeLine lineNumber="1733"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// destination can be an existing EH pad that already have phis, and the BB</span></CodeLine>
<Link id="l01734" /><CodeLine lineNumber="1734"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// with the newly created invoke will become a new predecessor of that EH</span></CodeLine>
<Link id="l01735" /><CodeLine lineNumber="1735"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// pad. In this case we need to add the new predecessor to those phis.</span></CodeLine>
<Link id="l01736" /><CodeLine lineNumber="1736"><span class="doxyHighlight">    UnwindDestToNewPreds&#91;UnwindDest&#93;.<a href="/docs/api/classes/llvm/densemapbase/#adb33f3ede2f5bfc9b3ee658aaf648492">insert</a>(CI-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>());</span></CodeLine>
<Link id="l01737" /><CodeLine lineNumber="1737"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a1481db7804704b4beb48e8c2ad4c94b2">changeToInvokeAndSplitBasicBlock</a>(CI, UnwindDest);</span></CodeLine>
<Link id="l01738" /><CodeLine lineNumber="1738"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01739" /><CodeLine lineNumber="1739"></CodeLine>
<Link id="l01740" /><CodeLine lineNumber="1740"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Instruction &#42;, 16&gt;</a> ToErase;</span></CodeLine>
<Link id="l01741" /><CodeLine lineNumber="1741"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;BB : <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l01742" /><CodeLine lineNumber="1742"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CSI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CatchSwitchInst&gt;</a>(BB.getFirstNonPHIIt())) &#123;</span></CodeLine>
<Link id="l01743" /><CodeLine lineNumber="1743"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CSI != CatchSwitchLongjmp &amp;&amp; CSI-&gt;unwindsToCaller()) &#123;</span></CodeLine>
<Link id="l01744" /><CodeLine lineNumber="1744"><span class="doxyHighlight">        IRB.SetInsertPoint(CSI);</span></CodeLine>
<Link id="l01745" /><CodeLine lineNumber="1745"><span class="doxyHighlight">        ToErase.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(CSI);</span></CodeLine>
<Link id="l01746" /><CodeLine lineNumber="1746"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewCSI = IRB.CreateCatchSwitch(CSI-&gt;getParentPad(),</span></CodeLine>
<Link id="l01747" /><CodeLine lineNumber="1747"><span class="doxyHighlight">                                             CatchDispatchLongjmpBB, 1);</span></CodeLine>
<Link id="l01748" /><CodeLine lineNumber="1748"><span class="doxyHighlight">        NewCSI-&gt;addHandler(&#42;CSI-&gt;handler&#95;begin());</span></CodeLine>
<Link id="l01749" /><CodeLine lineNumber="1749"><span class="doxyHighlight">        NewCSI-&gt;takeName(CSI);</span></CodeLine>
<Link id="l01750" /><CodeLine lineNumber="1750"><span class="doxyHighlight">        CSI-&gt;replaceAllUsesWith(NewCSI);</span></CodeLine>
<Link id="l01751" /><CodeLine lineNumber="1751"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01752" /><CodeLine lineNumber="1752"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01753" /><CodeLine lineNumber="1753"></CodeLine>
<Link id="l01754" /><CodeLine lineNumber="1754"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CRI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CleanupReturnInst&gt;</a>(BB.getTerminator())) &#123;</span></CodeLine>
<Link id="l01755" /><CodeLine lineNumber="1755"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CRI-&gt;unwindsToCaller()) &#123;</span></CodeLine>
<Link id="l01756" /><CodeLine lineNumber="1756"><span class="doxyHighlight">        IRB.SetInsertPoint(CRI);</span></CodeLine>
<Link id="l01757" /><CodeLine lineNumber="1757"><span class="doxyHighlight">        ToErase.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(CRI);</span></CodeLine>
<Link id="l01758" /><CodeLine lineNumber="1758"><span class="doxyHighlight">        IRB.CreateCleanupRet(CRI-&gt;getCleanupPad(), CatchDispatchLongjmpBB);</span></CodeLine>
<Link id="l01759" /><CodeLine lineNumber="1759"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01760" /><CodeLine lineNumber="1760"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01761" /><CodeLine lineNumber="1761"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01762" /><CodeLine lineNumber="1762"></CodeLine>
<Link id="l01763" /><CodeLine lineNumber="1763"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : ToErase)</span></CodeLine>
<Link id="l01764" /><CodeLine lineNumber="1764"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;eraseFromParent();</span></CodeLine>
<Link id="l01765" /><CodeLine lineNumber="1765"></CodeLine>
<Link id="l01766" /><CodeLine lineNumber="1766"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Add entries for new predecessors to phis in unwind destinations. We use</span></CodeLine>
<Link id="l01767" /><CodeLine lineNumber="1767"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// &#39;undef&#39; as a placeholder value. We should make sure the phis have a valid</span></CodeLine>
<Link id="l01768" /><CodeLine lineNumber="1768"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// set of predecessors before running SSAUpdater, because SSAUpdater</span></CodeLine>
<Link id="l01769" /><CodeLine lineNumber="1769"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// internally can use existing phis to gather predecessor info rather than</span></CodeLine>
<Link id="l01770" /><CodeLine lineNumber="1770"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// scanning the actual CFG (See FindPredecessorBlocks in SSAUpdater.cpp for</span></CodeLine>
<Link id="l01771" /><CodeLine lineNumber="1771"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// details).</span></CodeLine>
<Link id="l01772" /><CodeLine lineNumber="1772"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;&#91;UnwindDest, NewPreds&#93; : UnwindDestToNewPreds) &#123;</span></CodeLine>
<Link id="l01773" /><CodeLine lineNumber="1773"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/phinode">PHINode</a> &amp;PN : UnwindDest-&gt;<a href="/docs/api/classes/llvm/basicblock/#a13da92d2694197fbcb5b95fd94e7570d">phis</a>()) &#123;</span></CodeLine>
<Link id="l01774" /><CodeLine lineNumber="1774"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewPred : NewPreds) &#123;</span></CodeLine>
<Link id="l01775" /><CodeLine lineNumber="1775"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(PN.getBasicBlockIndex(NewPred) == -1);</span></CodeLine>
<Link id="l01776" /><CodeLine lineNumber="1776"><span class="doxyHighlight">        PN.addIncoming(<a href="/docs/api/classes/llvm/undefvalue/#a4ae5ff22b700a42bcc5d889233721335">UndefValue::get</a>(PN.getType()), NewPred);</span></CodeLine>
<Link id="l01777" /><CodeLine lineNumber="1777"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01778" /><CodeLine lineNumber="1778"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01779" /><CodeLine lineNumber="1779"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01780" /><CodeLine lineNumber="1780"></CodeLine>
<Link id="l01781" /><CodeLine lineNumber="1781"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For unwind destinations for newly added invokes to longjmpable functions,</span></CodeLine>
<Link id="l01782" /><CodeLine lineNumber="1782"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// calculate incoming values for the newly added predecessors using</span></CodeLine>
<Link id="l01783" /><CodeLine lineNumber="1783"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// SSAUpdater. We add existing values in the phis to SSAUpdater as available</span></CodeLine>
<Link id="l01784" /><CodeLine lineNumber="1784"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// values and let it calculate what the value should be at the end of new</span></CodeLine>
<Link id="l01785" /><CodeLine lineNumber="1785"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// incoming blocks.</span></CodeLine>
<Link id="l01786" /><CodeLine lineNumber="1786"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;&#91;UnwindDest, NewPreds&#93; : UnwindDestToNewPreds) &#123;</span></CodeLine>
<Link id="l01787" /><CodeLine lineNumber="1787"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/phinode">PHINode</a> &amp;PN : UnwindDest-&gt;<a href="/docs/api/classes/llvm/basicblock/#a13da92d2694197fbcb5b95fd94e7570d">phis</a>()) &#123;</span></CodeLine>
<Link id="l01788" /><CodeLine lineNumber="1788"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/ssaupdater">SSAUpdater</a> <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>;</span></CodeLine>
<Link id="l01789" /><CodeLine lineNumber="1789"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>.Initialize(PN.getType(), PN.getName());</span></CodeLine>
<Link id="l01790" /><CodeLine lineNumber="1790"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> Idx = 0, <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#abb2b3a60ccc38a28239e19a1646e0c8a">E</a> = PN.getNumIncomingValues(); Idx != <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#abb2b3a60ccc38a28239e19a1646e0c8a">E</a>; ++Idx) &#123;</span></CodeLine>
<Link id="l01791" /><CodeLine lineNumber="1791"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NewPreds.contains(PN.getIncomingBlock(Idx)))</span></CodeLine>
<Link id="l01792" /><CodeLine lineNumber="1792"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01793" /><CodeLine lineNumber="1793"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/value">Value</a> &#42;V = PN.getIncomingValue(Idx);</span></CodeLine>
<Link id="l01794" /><CodeLine lineNumber="1794"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;InvokeInst&gt;</a>(V))</span></CodeLine>
<Link id="l01795" /><CodeLine lineNumber="1795"><span class="doxyHighlight">          <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>.AddAvailableValue(<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a>-&gt;getNormalDest(), <a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a>);</span></CodeLine>
<Link id="l01796" /><CodeLine lineNumber="1796"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(V))</span></CodeLine>
<Link id="l01797" /><CodeLine lineNumber="1797"><span class="doxyHighlight">          <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>.AddAvailableValue(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getParent(), <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</span></CodeLine>
<Link id="l01798" /><CodeLine lineNumber="1798"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l01799" /><CodeLine lineNumber="1799"><span class="doxyHighlight">          <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>.AddAvailableValue(PN.getIncomingBlock(Idx), V);</span></CodeLine>
<Link id="l01800" /><CodeLine lineNumber="1800"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01801" /><CodeLine lineNumber="1801"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewPred : NewPreds)</span></CodeLine>
<Link id="l01802" /><CodeLine lineNumber="1802"><span class="doxyHighlight">        PN.setIncomingValueForBlock(NewPred, <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>.GetValueAtEndOfBlock(NewPred));</span></CodeLine>
<Link id="l01803" /><CodeLine lineNumber="1803"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(PN.isComplete());</span></CodeLine>
<Link id="l01804" /><CodeLine lineNumber="1804"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01805" /><CodeLine lineNumber="1805"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01806" /><CodeLine lineNumber="1806"><span class="doxyHighlight">&#125;</span></CodeLine>

</ProgramListing>


</DoxygenPage>
