---

# DO NOT EDIT!
# Automatically generated via docusaurus-plugin-doxygen by Doxygen.

slug: /api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp
custom_edit_url: null
keywords:
  - doxygen
  - reference
  - file

---

import Link from '@docusaurus/Link'

import CodeLine from '@xpack/docusaurus-plugin-doxygen/components/CodeLine'
import DoxygenPage from '@xpack/docusaurus-plugin-doxygen/components/DoxygenPage'
import Highlight from '@xpack/docusaurus-plugin-doxygen/components/Highlight'
import IncludesList from '@xpack/docusaurus-plugin-doxygen/components/IncludesList'
import IncludesListItem from '@xpack/docusaurus-plugin-doxygen/components/IncludesListItem'
import MemberDefinition from '@xpack/docusaurus-plugin-doxygen/components/MemberDefinition'
import MembersIndex from '@xpack/docusaurus-plugin-doxygen/components/MembersIndex'
import MembersIndexItem from '@xpack/docusaurus-plugin-doxygen/components/MembersIndexItem'
import ProgramListing from '@xpack/docusaurus-plugin-doxygen/components/ProgramListing'
import SectionDefinition from '@xpack/docusaurus-plugin-doxygen/components/SectionDefinition'

import pluginConfig from '@site/docusaurus-plugin-doxygen-config.json'

# The `X86SpeculativeLoadHardening.cpp` File Reference

<DoxygenPage pluginConfig={pluginConfig}>

Provide a pass which mitigates speculative execution attacks which operate by speculating incorrectly past some predicate (a type check, bounds check, or other condition) to reach a load with invalid inputs and leak the data accessed by that load using a side channel out of the speculative domain. <a href="#details">More...</a>

## Included Headers

<IncludesList>
<IncludesListItem
  filePath="X86.h"
  permalink="/docs/api/files/lib/lib/target/lib/target/x86/x86-h"
  isLocal="true" />
<IncludesListItem
  filePath="X86InstrInfo.h"
  permalink="/docs/api/files/lib/lib/target/lib/target/x86/x86instrinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="X86Subtarget.h"
  permalink="/docs/api/files/lib/lib/target/lib/target/x86/x86subtarget-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/ArrayRef.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/arrayref-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/DenseMap.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/densemap-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/STLExtras.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/stlextras-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SmallPtrSet.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/smallptrset-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SmallSet.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/smallset-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SmallVector.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/smallvector-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SparseBitVector.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/sparsebitvector-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/Statistic.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineBasicBlock.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machinebasicblock-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineConstantPool.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machineconstantpool-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineFunction.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machinefunction-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineFunctionPass.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machinefunctionpass-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineInstr.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machineinstr-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineInstrBuilder.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machineinstrbuilder-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineModuleInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machinemoduleinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineOperand.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machineoperand-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineRegisterInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machineregisterinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineSSAUpdater.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machinessaupdater-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/TargetInstrInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/targetinstrinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/TargetRegisterInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/targetregisterinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/TargetSchedule.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/targetschedule-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/TargetSubtargetInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/targetsubtargetinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/DebugLoc.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/debugloc-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/MC/MCSchedule.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/mc/mcschedule-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Pass.h"
  permalink="/docs/api/files/include/include/llvm/pass-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/CommandLine.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/Debug.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/debug-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/raw_ostream.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/raw-ostream-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Target/TargetMachine.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/target/targetmachine-h"
  isLocal="true" />
<IncludesListItem
  filePath="cassert"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="iterator"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="optional"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="utility"
  permalink=""
  isLocal="false" />
</IncludesList>

## Namespaces Index

<MembersIndex>

<MembersIndexItem
  type="namespace"
  name={<><a href="/docs/api/namespaces/anonymous-x86speculativeloadhardening-cpp-">anonymous&#123;X86SpeculativeLoadHardening.cpp&#125;</a></>}>
</MembersIndexItem>

</MembersIndex>

## Classes Index

<MembersIndex>

<MembersIndexItem
  type="class"
  name={<><a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass">X86SpeculativeLoadHardeningPass</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type="struct"
  name={<><a href="/docs/api/structs/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/blockcondinfo">BlockCondInfo</a></>}>
The information about a block&#39;s conditional terminators needed to trace our predicate state through the exiting edges. <a href="/docs/api/structs/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/blockcondinfo/#details">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="struct"
  name={<><a href="/docs/api/structs/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/predstate">PredState</a></>}>
Manages the predicate state traced through the program. <a href="/docs/api/structs/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/predstate/#details">More...</a>
</MembersIndexItem>

</MembersIndex>

## Functions Index

<MembersIndex>

<MembersIndexItem
  type="void"
  name={<><a href="#a22244f1af2bc880ef42bfd77068ce13a">canonicalizePHIOperands</a> (MachineFunction &amp;MF)</>}>
Removing duplicate PHI operands to leave the PHI in a canonical and predictable form. <a href="#a22244f1af2bc880ef42bfd77068ce13a">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/targetregisterclass">TargetRegisterClass</a> &#42;</>}
  name={<><a href="#aa521cd293ac8410168730efe322dce5c">getRegClassForUnfoldedLoad</a> (MachineFunction &amp;MF, const X86InstrInfo &amp;TII, unsigned Opcode)</>}>
Compute the register class for the unfolded load. <a href="#aa521cd293ac8410168730efe322dce5c">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#abe47da1ba1b5239bb67b26d5ebbca491">hasVulnerableLoad</a> (MachineFunction &amp;MF)</>}>
Helper to scan a function for loads vulnerable to misspeculation that we want to harden. <a href="#abe47da1ba1b5239bb67b26d5ebbca491">More...</a>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#a9936c7db2226d0d94430b4e6a6648cc0">INITIALIZE&#95;PASS&#95;BEGIN</a> (X86SpeculativeLoadHardeningPass, PASS&#95;KEY, &quot;X86 speculative load hardener&quot;, false, false) INITIALIZE&#95;PASS&#95;END(X86SpeculativeLoadHardeningPass</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#ac0e27a6dfaf334669f95954dee3d5920">isEFLAGSDefLive</a> (const MachineInstr &amp;MI)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a93f8e5dacbcd949d688c3af5f491468d">isEFLAGSLive</a> (MachineBasicBlock &amp;MBB, MachineBasicBlock::iterator I, const TargetRegisterInfo &amp;TRI)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;</>}
  name={<><a href="#a18b17899654dd5adb69b62c89ba95783">splitEdge</a> (MachineBasicBlock &amp;MBB, MachineBasicBlock &amp;Succ, int SuccCount, MachineInstr &#42;Br, MachineInstr &#42;&amp;UncondBr, const X86InstrInfo &amp;TII)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#abbb5cb917c4afe9c66209bc642eb6a5f">STATISTIC</a> (NumCondBranchesTraced, &quot;Number of conditional branches traced&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#aeabc45e5daa9b054a69cfa1215f69b5e">STATISTIC</a> (NumBranchesUntraced, &quot;Number of branches unable to trace&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#a3f8b54dd7dbd4bdef5689d93e4e0d754">STATISTIC</a> (NumAddrRegsHardened, &quot;Number of address mode used registers hardaned&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#a291e16ec2436c1d92e36feb7f96b35ea">STATISTIC</a> (NumPostLoadRegsHardened, &quot;Number of post-load register values hardened&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#aed900ec52c62e93ce048bf67819df513">STATISTIC</a> (NumCallsOrJumpsHardened, &quot;Number of calls or jumps requiring extra hardening&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#a34189f0471defa93aceb2d490f4fc5f6">STATISTIC</a> (NumInstsInserted, &quot;Number of instructions inserted&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#ac89256de3537a18323a18efeb9a852d6">STATISTIC</a> (NumLFENCEsInserted, &quot;Number of lfence instructions inserted&quot;)</>}>
</MembersIndexItem>

</MembersIndex>

## Variables Index

<MembersIndex>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a7385b8089f422279adefa5007ef35dc6">EnablePostLoadHardening</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a964a795e07ed117f8049f44b16739763">EnableSpeculativeLoadHardening</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<>X86 speculative <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpumarklastscratchload-cpp/#a8a3fe89940744b94ffe5dacd6704c2be">load</a></>}
  name={<><a href="#a0d80253a045701908e9a2599a6d88b05">false</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a5ee11464d0d2e030d95afb0db83b801d">FenceCallAndRet</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a921b17e18b1d37ab8ca2b7375df1addf">HardenEdgesWithLFENCE</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<>X86 speculative <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpumarklastscratchload-cpp/#a8a3fe89940744b94ffe5dacd6704c2be">load</a></>}
  name={<><a href="#ac0ec809a83ff46671add6d5a7d19ff37">hardener</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#ade91f65a65e423e2002fb9b25b7b2a5c">HardenIndirectCallsAndJumps</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a3e42304d79c25684c4d464fd35fb868f">HardenInterprocedurally</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a2109babba3ed33aad17d1f97e9aef11b">HardenLoads</a></>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#aff35f54c90a52d054a6423bcf2683f1e">PASS&#95;KEY</a></>}>
</MembersIndexItem>

</MembersIndex>

## Defines Index

<MembersIndex>

<MembersIndexItem
  type="#define"
  name={<><a href="#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>&nbsp;&nbsp;&nbsp;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type="#define"
  name={<><a href="#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a>&nbsp;&nbsp;&nbsp;&quot;x86-slh&quot;</>}>
</MembersIndexItem>

</MembersIndex>

## Description {#details}

Provide a pass which mitigates speculative execution attacks which operate by speculating incorrectly past some predicate (a type check, bounds check, or other condition) to reach a load with invalid inputs and leak the data accessed by that load using a side channel out of the speculative domain.

For details on the attacks, see the first variant in both the Project Zero writeup and the Spectre paper: <a href="https://googleprojectzero.blogspot.com/2018/01/reading-privileged-memory-with-side.html">https://googleprojectzero.blogspot.com/2018/01/reading-privileged-memory-with-side.html</a> <a href="https://spectreattack.com/spectre.pdf">https://spectreattack.com/spectre.pdf</a>

<SectionDefinition>

## Functions

### canonicalizePHIOperands() {#a22244f1af2bc880ef42bfd77068ce13a}

<MemberDefinition
  prototype={<>static void canonicalizePHIOperands (<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp; MF)</>}
  labels = {["static"]}>
Removing duplicate PHI operands to leave the PHI in a canonical and predictable form.

FIXME: It&#39;s really frustrating that we have to do this, but SSA-form in MIR isn&#39;t what you might expect. We may have multiple entries in PHI nodes for a single predecessor. This makes CFG-updating extremely complex, so here we simplify all PHI nodes to a model even simpler than the IR&#39;s model: exactly one entry per predecessor, regardless of how many edges there are.

Definition at line <a href="#l00326">326</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### getRegClassForUnfoldedLoad() {#aa521cd293ac8410168730efe322dce5c}

<MemberDefinition
  prototype={<>static const TargetRegisterClass &#42; getRegClassForUnfoldedLoad (<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp; MF, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/x86instrinfo">X86InstrInfo</a> &amp; TII, unsigned Opcode)</>}
  labels = {["static"]}>
Compute the register class for the unfolded load.

FIXME: This should probably live in <a href="/docs/api/classes/llvm/x86instrinfo">X86InstrInfo</a>, potentially by adding a way to unfold into a newly created vreg rather than requiring a register input.

Definition at line <a href="#l00839">839</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### hasVulnerableLoad() {#abe47da1ba1b5239bb67b26d5ebbca491}

<MemberDefinition
  prototype={<>static bool hasVulnerableLoad (<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp; MF)</>}
  labels = {["static"]}>
Helper to scan a function for loads vulnerable to misspeculation that we want to harden.

We use this to avoid making changes to functions where there is nothing we need to do to harden against misspeculation.

Definition at line <a href="#l00370">370</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### INITIALIZE&#95;PASS&#95;BEGIN() {#a9936c7db2226d0d94430b4e6a6648cc0}

<MemberDefinition
  prototype={<>INITIALIZE&#95;PASS&#95;BEGIN (X86SpeculativeLoadHardeningPass, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a>, &quot;X86 speculative <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpumarklastscratchload-cpp/#a8a3fe89940744b94ffe5dacd6704c2be">load</a> hardener&quot;, false, false)</>}>

Definition at line <a href="#l02262">2262</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### isEFLAGSDefLive() {#ac0e27a6dfaf334669f95954dee3d5920}

<MemberDefinition
  prototype={<>static bool isEFLAGSDefLive (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp; MI)</>}
  labels = {["static"]}>

Definition at line <a href="#l01203">1203</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### isEFLAGSLive() {#a93f8e5dacbcd949d688c3af5f491468d}

<MemberDefinition
  prototype={<>static bool isEFLAGSLive (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp; MBB, <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> I, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/targetregisterinfo">TargetRegisterInfo</a> &amp; TRI)</>}
  labels = {["static"]}>

Definition at line <a href="#l01211">1211</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### splitEdge() {#a18b17899654dd5adb69b62c89ba95783}

<MemberDefinition
  prototype={<>static MachineBasicBlock &amp; splitEdge (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp; MBB, <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp; Succ, int SuccCount, <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42; Br, <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;&amp; UncondBr, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/x86instrinfo">X86InstrInfo</a> &amp; TII)</>}
  labels = {["static"]}>

Definition at line <a href="#l00222">222</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### STATISTIC() {#abbb5cb917c4afe9c66209bc642eb6a5f}

<MemberDefinition
  prototype={<>STATISTIC (NumCondBranchesTraced, &quot;Number of conditional <a href="/docs/api/files/lib/lib/target/lib/target/arc/arcbranchfinalize-cpp/#a14311558a7445776def2d5bc13161ba3">branches</a> traced&quot;)</>}>

Definition at line <a href="#l00064">64</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### STATISTIC() {#aeabc45e5daa9b054a69cfa1215f69b5e}

<MemberDefinition
  prototype={<>STATISTIC (NumBranchesUntraced, &quot;Number of <a href="/docs/api/files/lib/lib/target/lib/target/arc/arcbranchfinalize-cpp/#a14311558a7445776def2d5bc13161ba3">branches</a> unable to trace&quot;)</>}>

Definition at line <a href="#l00065">65</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### STATISTIC() {#a3f8b54dd7dbd4bdef5689d93e4e0d754}

<MemberDefinition
  prototype={<>STATISTIC (NumAddrRegsHardened, &quot;Number of address <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagonoptaddrmode-cpp/#abdd61257a7f5e75ed961036299f26498">mode</a> used registers hardaned&quot;)</>}>

Definition at line <a href="#l00066">66</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### STATISTIC() {#a291e16ec2436c1d92e36feb7f96b35ea}

<MemberDefinition
  prototype={<>STATISTIC (NumPostLoadRegsHardened, &quot;Number of post-<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpumarklastscratchload-cpp/#a8a3fe89940744b94ffe5dacd6704c2be">load</a> register values hardened&quot;)</>}>

Definition at line <a href="#l00068">68</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### STATISTIC() {#aed900ec52c62e93ce048bf67819df513}

<MemberDefinition
  prototype={<>STATISTIC (NumCallsOrJumpsHardened, &quot;Number of calls or jumps requiring extra hardening&quot;)</>}>

Definition at line <a href="#l00070">70</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### STATISTIC() {#a34189f0471defa93aceb2d490f4fc5f6}

<MemberDefinition
  prototype={<>STATISTIC (NumInstsInserted, &quot;Number of <a href="/docs/api/files/lib/lib/codegen/atomicexpandpass-cpp/#a1bcc06b1cb86bd0ea08f33323190bdaa">instructions</a> inserted&quot;)</>}>

Definition at line <a href="#l00072">72</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### STATISTIC() {#ac89256de3537a18323a18efeb9a852d6}

<MemberDefinition
  prototype={<>STATISTIC (NumLFENCEsInserted, &quot;Number of lfence <a href="/docs/api/files/lib/lib/codegen/atomicexpandpass-cpp/#a1bcc06b1cb86bd0ea08f33323190bdaa">instructions</a> inserted&quot;)</>}>

Definition at line <a href="#l00073">73</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Variables

### EnablePostLoadHardening {#a7385b8089f422279adefa5007ef35dc6}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; EnablePostLoadHardening(PASS&#95;KEY &quot;-post-load&quot;, cl::desc(&quot;Harden the value loaded &#42;after&#42; it is loaded by &quot; &quot;flushing the loaded bits to 1. This is hard to do &quot; &quot;in general but can be done easily for GPRs.&quot;), cl::init(true), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00087">87</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### EnableSpeculativeLoadHardening {#a964a795e07ed117f8049f44b16739763}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; EnableSpeculativeLoadHardening(&quot;x86-speculative-load-hardening&quot;, cl::desc(&quot;Force enable speculative load hardening&quot;), cl::init(false), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00075">75</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### false {#a0d80253a045701908e9a2599a6d88b05}

<MemberDefinition
  prototype="X86 speculative load false">

Definition at line <a href="#l02265">2265</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### FenceCallAndRet {#a5ee11464d0d2e030d95afb0db83b801d}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; FenceCallAndRet(PASS&#95;KEY &quot;-fence-call-and-ret&quot;, cl::desc(&quot;Use a full speculation fence to harden both call and ret edges &quot; &quot;rather than a lighter weight mitigation.&quot;), cl::init(false), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00094">94</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### HardenEdgesWithLFENCE {#a921b17e18b1d37ab8ca2b7375df1addf}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; HardenEdgesWithLFENCE(PASS&#95;KEY &quot;-lfence&quot;, cl::desc( &quot;Use LFENCE along each conditional edge to harden against speculative &quot; &quot;loads rather than conditional movs and poisoned pointers.&quot;), cl::init(false), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00080">80</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### hardener {#ac0ec809a83ff46671add6d5a7d19ff37}

<MemberDefinition
  prototype="X86 speculative load hardener">

Definition at line <a href="#l02265">2265</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### HardenIndirectCallsAndJumps {#ade91f65a65e423e2002fb9b25b7b2a5c}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; HardenIndirectCallsAndJumps(PASS&#95;KEY &quot;-indirect&quot;, cl::desc(&quot;Harden indirect calls and jumps against using speculatively &quot; &quot;stored attacker controlled addresses. This is designed to &quot; &quot;mitigate Spectre v1.2 style attacks.&quot;), cl::init(true), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00112">112</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### HardenInterprocedurally {#a3e42304d79c25684c4d464fd35fb868f}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; HardenInterprocedurally(PASS&#95;KEY &quot;-ip&quot;, cl::desc(&quot;Harden interprocedurally by passing our state in and out of &quot; &quot;functions in the high bits of the stack pointer.&quot;), cl::init(true), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00100">100</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### HardenLoads {#a2109babba3ed33aad17d1f97e9aef11b}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; HardenLoads(PASS&#95;KEY &quot;-loads&quot;, cl::desc(&quot;Sanitize loads from memory. When disable, no &quot; &quot;significant security is provided.&quot;), cl::init(true), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00107">107</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### PASS&#95;KEY {#aff35f54c90a52d054a6423bcf2683f1e}

<MemberDefinition
  prototype={<>PASS&#95;KEY</>}>

Definition at line <a href="#l02264">2264</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Defines

### DEBUG&#95;TYPE {#ad78e062f62e0d6e453941fb4ca843e4d}

<MemberDefinition
  prototype={<>#define DEBUG&#95;TYPE&nbsp;&nbsp;&nbsp;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a></>}>

Definition at line <a href="#l00062">62</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### PASS&#95;KEY {#ae0a7815fb436ce6db7cb0a91755daef7}

<MemberDefinition
  prototype={<>#define PASS&#95;KEY&nbsp;&nbsp;&nbsp;&quot;x86-slh&quot;</>}>

Definition at line <a href="#l00061">61</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

</SectionDefinition>

## File Listing

The file content with the documentation metadata removed is:

<ProgramListing>

<Link id="l00001" /><CodeLine lineNumber="1"><Highlight kind="comment">//====- X86SpeculativeLoadHardening.cpp - A Spectre v1 mitigation ---------===//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00002" /><CodeLine lineNumber="2"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00003" /><CodeLine lineNumber="3"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00004" /><CodeLine lineNumber="4"><Highlight kind="normal"></Highlight><Highlight kind="comment">// See https://llvm.org/LICENSE.txt for license information.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00005" /><CodeLine lineNumber="5"><Highlight kind="normal"></Highlight><Highlight kind="comment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00006" /><CodeLine lineNumber="6"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00007" /><CodeLine lineNumber="7"><Highlight kind="normal"></Highlight><Highlight kind="comment">//===----------------------------------------------------------------------===//</Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00008" /><CodeLine lineNumber="8"><Highlight kind="comment">/// \\file</Highlight></CodeLine>
<Link id="l00009" /><CodeLine lineNumber="9"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00010" /><CodeLine lineNumber="10"><Highlight kind="comment">/// Provide a pass which mitigates speculative execution attacks which operate</Highlight></CodeLine>
<Link id="l00011" /><CodeLine lineNumber="11"><Highlight kind="comment">/// by speculating incorrectly past some predicate (a type check, bounds check,</Highlight></CodeLine>
<Link id="l00012" /><CodeLine lineNumber="12"><Highlight kind="comment">/// or other condition) to reach a load with invalid inputs and leak the data</Highlight></CodeLine>
<Link id="l00013" /><CodeLine lineNumber="13"><Highlight kind="comment">/// accessed by that load using a side channel out of the speculative domain.</Highlight></CodeLine>
<Link id="l00014" /><CodeLine lineNumber="14"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00015" /><CodeLine lineNumber="15"><Highlight kind="comment">/// For details on the attacks, see the first variant in both the Project Zero</Highlight></CodeLine>
<Link id="l00016" /><CodeLine lineNumber="16"><Highlight kind="comment">/// writeup and the Spectre paper:</Highlight></CodeLine>
<Link id="l00017" /><CodeLine lineNumber="17"><Highlight kind="comment">/// https://googleprojectzero.blogspot.com/2018/01/reading-privileged-memory-with-side.html</Highlight></CodeLine>
<Link id="l00018" /><CodeLine lineNumber="18"><Highlight kind="comment">/// https://spectreattack.com/spectre.pdf</Highlight></CodeLine>
<Link id="l00019" /><CodeLine lineNumber="19"><Highlight kind="comment">///</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00020" /><CodeLine lineNumber="20"><Highlight kind="normal"></Highlight><Highlight kind="comment">//===----------------------------------------------------------------------===//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00021" /><CodeLine lineNumber="21"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00022" /><CodeLine lineNumber="22"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86-h">X86.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00023" /><CodeLine lineNumber="23"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86instrinfo-h">X86InstrInfo.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00024" /><CodeLine lineNumber="24"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86subtarget-h">X86Subtarget.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00025" /><CodeLine lineNumber="25"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/arrayref-h">llvm/ADT/ArrayRef.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00026" /><CodeLine lineNumber="26"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/densemap-h">llvm/ADT/DenseMap.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00027" /><CodeLine lineNumber="27"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/stlextras-h">llvm/ADT/STLExtras.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00028" /><CodeLine lineNumber="28"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/smallptrset-h">llvm/ADT/SmallPtrSet.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00029" /><CodeLine lineNumber="29"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/smallset-h">llvm/ADT/SmallSet.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00030" /><CodeLine lineNumber="30"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/smallvector-h">llvm/ADT/SmallVector.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00031" /><CodeLine lineNumber="31"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/sparsebitvector-h">llvm/ADT/SparseBitVector.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00032" /><CodeLine lineNumber="32"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h">llvm/ADT/Statistic.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00033" /><CodeLine lineNumber="33"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machinebasicblock-h">llvm/CodeGen/MachineBasicBlock.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00034" /><CodeLine lineNumber="34"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machineconstantpool-h">llvm/CodeGen/MachineConstantPool.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00035" /><CodeLine lineNumber="35"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machinefunction-h">llvm/CodeGen/MachineFunction.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00036" /><CodeLine lineNumber="36"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machinefunctionpass-h">llvm/CodeGen/MachineFunctionPass.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00037" /><CodeLine lineNumber="37"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machineinstr-h">llvm/CodeGen/MachineInstr.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00038" /><CodeLine lineNumber="38"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machineinstrbuilder-h">llvm/CodeGen/MachineInstrBuilder.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00039" /><CodeLine lineNumber="39"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machinemoduleinfo-h">llvm/CodeGen/MachineModuleInfo.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00040" /><CodeLine lineNumber="40"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machineoperand-h">llvm/CodeGen/MachineOperand.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00041" /><CodeLine lineNumber="41"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machineregisterinfo-h">llvm/CodeGen/MachineRegisterInfo.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00042" /><CodeLine lineNumber="42"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machinessaupdater-h">llvm/CodeGen/MachineSSAUpdater.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00043" /><CodeLine lineNumber="43"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/targetinstrinfo-h">llvm/CodeGen/TargetInstrInfo.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00044" /><CodeLine lineNumber="44"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/targetregisterinfo-h">llvm/CodeGen/TargetRegisterInfo.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00045" /><CodeLine lineNumber="45"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/targetschedule-h">llvm/CodeGen/TargetSchedule.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00046" /><CodeLine lineNumber="46"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/targetsubtargetinfo-h">llvm/CodeGen/TargetSubtargetInfo.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00047" /><CodeLine lineNumber="47"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/debugloc-h">llvm/IR/DebugLoc.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00048" /><CodeLine lineNumber="48"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/mc/mcschedule-h">llvm/MC/MCSchedule.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00049" /><CodeLine lineNumber="49"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/pass-h">llvm/Pass.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00050" /><CodeLine lineNumber="50"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h">llvm/Support/CommandLine.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00051" /><CodeLine lineNumber="51"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h">llvm/Support/Debug.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00052" /><CodeLine lineNumber="52"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/raw-ostream-h">llvm/Support/raw&#95;ostream.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00053" /><CodeLine lineNumber="53"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/target/targetmachine-h">llvm/Target/TargetMachine.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00054" /><CodeLine lineNumber="54"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &lt;cassert&gt;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00055" /><CodeLine lineNumber="55"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &lt;iterator&gt;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00056" /><CodeLine lineNumber="56"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &lt;optional&gt;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00057" /><CodeLine lineNumber="57"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &lt;utility&gt;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00058" /><CodeLine lineNumber="58"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00059" /><CodeLine lineNumber="59"><Highlight kind="normal"></Highlight><Highlight kind="keyword">using namespace </Highlight><Highlight kind="normal"><a href="/docs/api/namespaces/llvm">llvm</a>;</Highlight></CodeLine>
<Link id="l00060" /><CodeLine lineNumber="60"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00061" /><CodeLine lineNumber="61" lineLink="#ae0a7815fb436ce6db7cb0a91755daef7"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#define PASS&#95;KEY &quot;x86-slh&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00062" /><CodeLine lineNumber="62" lineLink="#ad78e062f62e0d6e453941fb4ca843e4d"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#define DEBUG&#95;TYPE PASS&#95;KEY</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00063" /><CodeLine lineNumber="63"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00064" /><CodeLine lineNumber="64" lineLink="#abbb5cb917c4afe9c66209bc642eb6a5f"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumCondBranchesTraced, </Highlight><Highlight kind="stringliteral">&quot;Number of conditional branches traced&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00065" /><CodeLine lineNumber="65" lineLink="#aeabc45e5daa9b054a69cfa1215f69b5e"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumBranchesUntraced, </Highlight><Highlight kind="stringliteral">&quot;Number of branches unable to trace&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00066" /><CodeLine lineNumber="66" lineLink="#a3f8b54dd7dbd4bdef5689d93e4e0d754"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumAddrRegsHardened,</Highlight></CodeLine>
<Link id="l00067" /><CodeLine lineNumber="67"><Highlight kind="normal">          </Highlight><Highlight kind="stringliteral">&quot;Number of address mode used registers hardaned&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00068" /><CodeLine lineNumber="68" lineLink="#a291e16ec2436c1d92e36feb7f96b35ea"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumPostLoadRegsHardened,</Highlight></CodeLine>
<Link id="l00069" /><CodeLine lineNumber="69"><Highlight kind="normal">          </Highlight><Highlight kind="stringliteral">&quot;Number of post-load register values hardened&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00070" /><CodeLine lineNumber="70" lineLink="#aed900ec52c62e93ce048bf67819df513"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumCallsOrJumpsHardened,</Highlight></CodeLine>
<Link id="l00071" /><CodeLine lineNumber="71"><Highlight kind="normal">          </Highlight><Highlight kind="stringliteral">&quot;Number of calls or jumps requiring extra hardening&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00072" /><CodeLine lineNumber="72" lineLink="#a34189f0471defa93aceb2d490f4fc5f6"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumInstsInserted, </Highlight><Highlight kind="stringliteral">&quot;Number of instructions inserted&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00073" /><CodeLine lineNumber="73" lineLink="#ac89256de3537a18323a18efeb9a852d6"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumLFENCEsInserted, </Highlight><Highlight kind="stringliteral">&quot;Number of lfence instructions inserted&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00074" /><CodeLine lineNumber="74"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00075" /><CodeLine lineNumber="75" lineLink="#a964a795e07ed117f8049f44b16739763"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a964a795e07ed117f8049f44b16739763">EnableSpeculativeLoadHardening</a>(</Highlight></CodeLine>
<Link id="l00076" /><CodeLine lineNumber="76"><Highlight kind="normal">    </Highlight><Highlight kind="stringliteral">&quot;x86-speculative-load-hardening&quot;</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l00077" /><CodeLine lineNumber="77"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Force enable speculative load hardening&quot;</Highlight><Highlight kind="normal">), <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">),</Highlight></CodeLine>
<Link id="l00078" /><CodeLine lineNumber="78"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</Highlight></CodeLine>
<Link id="l00079" /><CodeLine lineNumber="79"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00080" /><CodeLine lineNumber="80" lineLink="#a921b17e18b1d37ab8ca2b7375df1addf"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a921b17e18b1d37ab8ca2b7375df1addf">HardenEdgesWithLFENCE</a>(</Highlight></CodeLine>
<Link id="l00081" /><CodeLine lineNumber="81"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a> </Highlight><Highlight kind="stringliteral">&quot;-lfence&quot;</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l00082" /><CodeLine lineNumber="82"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight></CodeLine>
<Link id="l00083" /><CodeLine lineNumber="83"><Highlight kind="normal">        </Highlight><Highlight kind="stringliteral">&quot;Use LFENCE along each conditional edge to harden against speculative &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00084" /><CodeLine lineNumber="84"><Highlight kind="normal">        </Highlight><Highlight kind="stringliteral">&quot;loads rather than conditional movs and poisoned pointers.&quot;</Highlight><Highlight kind="normal">),</Highlight></CodeLine>
<Link id="l00085" /><CodeLine lineNumber="85"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</Highlight></CodeLine>
<Link id="l00086" /><CodeLine lineNumber="86"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00087" /><CodeLine lineNumber="87" lineLink="#a7385b8089f422279adefa5007ef35dc6"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a7385b8089f422279adefa5007ef35dc6">EnablePostLoadHardening</a>(</Highlight></CodeLine>
<Link id="l00088" /><CodeLine lineNumber="88"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a> </Highlight><Highlight kind="stringliteral">&quot;-post-load&quot;</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l00089" /><CodeLine lineNumber="89"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Harden the value loaded &#42;after&#42; it is loaded by &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00090" /><CodeLine lineNumber="90"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;flushing the loaded bits to 1 This is hard to do &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00091" /><CodeLine lineNumber="91"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;in general but can be done easily for GPRs.&quot;</Highlight><Highlight kind="normal">),</Highlight></CodeLine>
<Link id="l00092" /><CodeLine lineNumber="92"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</Highlight></CodeLine>
<Link id="l00093" /><CodeLine lineNumber="93"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00094" /><CodeLine lineNumber="94" lineLink="#a5ee11464d0d2e030d95afb0db83b801d"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a5ee11464d0d2e030d95afb0db83b801d">FenceCallAndRet</a>(</Highlight></CodeLine>
<Link id="l00095" /><CodeLine lineNumber="95"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a> </Highlight><Highlight kind="stringliteral">&quot;-fence-call-and-ret&quot;</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l00096" /><CodeLine lineNumber="96"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Use a full speculation fence to harden both call and ret edges &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00097" /><CodeLine lineNumber="97"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;rather than a lighter weight mitigation.&quot;</Highlight><Highlight kind="normal">),</Highlight></CodeLine>
<Link id="l00098" /><CodeLine lineNumber="98"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</Highlight></CodeLine>
<Link id="l00099" /><CodeLine lineNumber="99"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00100" /><CodeLine lineNumber="100" lineLink="#a3e42304d79c25684c4d464fd35fb868f"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a3e42304d79c25684c4d464fd35fb868f">HardenInterprocedurally</a>(</Highlight></CodeLine>
<Link id="l00101" /><CodeLine lineNumber="101"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a> </Highlight><Highlight kind="stringliteral">&quot;-ip&quot;</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l00102" /><CodeLine lineNumber="102"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Harden interprocedurally by passing our state in and out of &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00103" /><CodeLine lineNumber="103"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;functions in the high bits of the stack pointer.&quot;</Highlight><Highlight kind="normal">),</Highlight></CodeLine>
<Link id="l00104" /><CodeLine lineNumber="104"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</Highlight></CodeLine>
<Link id="l00105" /><CodeLine lineNumber="105"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00106" /><CodeLine lineNumber="106"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a></Highlight></CodeLine>
<Link id="l00107" /><CodeLine lineNumber="107" lineLink="#a2109babba3ed33aad17d1f97e9aef11b"><Highlight kind="normal">    <a href="#a2109babba3ed33aad17d1f97e9aef11b">HardenLoads</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a> </Highlight><Highlight kind="stringliteral">&quot;-loads&quot;</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l00108" /><CodeLine lineNumber="108"><Highlight kind="normal">                <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Sanitize loads from memory. When disable, no &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00109" /><CodeLine lineNumber="109"><Highlight kind="normal">                         </Highlight><Highlight kind="stringliteral">&quot;significant security is provided.&quot;</Highlight><Highlight kind="normal">),</Highlight></CodeLine>
<Link id="l00110" /><CodeLine lineNumber="110"><Highlight kind="normal">                <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</Highlight></CodeLine>
<Link id="l00111" /><CodeLine lineNumber="111"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00112" /><CodeLine lineNumber="112" lineLink="#ade91f65a65e423e2002fb9b25b7b2a5c"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#ade91f65a65e423e2002fb9b25b7b2a5c">HardenIndirectCallsAndJumps</a>(</Highlight></CodeLine>
<Link id="l00113" /><CodeLine lineNumber="113"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a> </Highlight><Highlight kind="stringliteral">&quot;-indirect&quot;</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l00114" /><CodeLine lineNumber="114"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Harden indirect calls and jumps against using speculatively &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00115" /><CodeLine lineNumber="115"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;stored attacker controlled addresses. This is designed to &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00116" /><CodeLine lineNumber="116"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;mitigate Spectre v1.2 style attacks.&quot;</Highlight><Highlight kind="normal">),</Highlight></CodeLine>
<Link id="l00117" /><CodeLine lineNumber="117"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</Highlight></CodeLine>
<Link id="l00118" /><CodeLine lineNumber="118"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00119" /><CodeLine lineNumber="119" lineLink="/docs/api/namespaces/anonymous-x86speculativeloadhardening-cpp-"><Highlight kind="normal"></Highlight><Highlight kind="keyword">namespace </Highlight><Highlight kind="normal">&#123;</Highlight></CodeLine>
<Link id="l00120" /><CodeLine lineNumber="120"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00121" /><CodeLine lineNumber="121" lineLink="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass"><Highlight kind="normal"></Highlight><Highlight kind="keyword">class </Highlight><Highlight kind="normal"><a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a77a626d52a8457ef92d87b702df1cb7f">X86SpeculativeLoadHardeningPass</a> : </Highlight><Highlight kind="keyword">public</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/machinefunctionpass/#a29c81d2386f4a727c6d33413807530c8">MachineFunctionPass</a> &#123;</Highlight></CodeLine>
<Link id="l00122" /><CodeLine lineNumber="122"><Highlight kind="normal"></Highlight><Highlight kind="keyword">public</Highlight><Highlight kind="normal">:</Highlight></CodeLine>
<Link id="l00123" /><CodeLine lineNumber="123" lineLink="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a77a626d52a8457ef92d87b702df1cb7f"><Highlight kind="normal">  <a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a77a626d52a8457ef92d87b702df1cb7f">X86SpeculativeLoadHardeningPass</a>() : <a href="/docs/api/classes/llvm/machinefunctionpass/#a29c81d2386f4a727c6d33413807530c8">MachineFunctionPass</a>(<a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a845bb9b2068e7fd8052fc0e53ed461e5">ID</a>) &#123; &#125;</Highlight></CodeLine>
<Link id="l00124" /><CodeLine lineNumber="124"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00125" /><CodeLine lineNumber="125" lineLink="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#afc095bc1100ba5f1e44a49e741303f28"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/stringref">StringRef</a> <a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#afc095bc1100ba5f1e44a49e741303f28">getPassName</a>()</Highlight><Highlight kind="keyword"> const override </Highlight><Highlight kind="normal">&#123;</Highlight></CodeLine>
<Link id="l00126" /><CodeLine lineNumber="126"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="stringliteral">&quot;X86 speculative load hardening&quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00127" /><CodeLine lineNumber="127"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00128" /><CodeLine lineNumber="128"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> runOnMachineFunction(<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF) </Highlight><Highlight kind="keyword">override</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00129" /><CodeLine lineNumber="129"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> getAnalysisUsage(<a href="/docs/api/classes/llvm/analysisusage">AnalysisUsage</a> &amp;AU) </Highlight><Highlight kind="keyword">const override</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00130" /><CodeLine lineNumber="130"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00131" /><CodeLine lineNumber="131"><Highlight kind="comment">  /// Pass identification, replacement for typeid.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00132" /><CodeLine lineNumber="132" lineLink="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a845bb9b2068e7fd8052fc0e53ed461e5"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">char</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a845bb9b2068e7fd8052fc0e53ed461e5">ID</a>;</Highlight></CodeLine>
<Link id="l00133" /><CodeLine lineNumber="133"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00134" /><CodeLine lineNumber="134"><Highlight kind="normal"></Highlight><Highlight kind="keyword">private</Highlight><Highlight kind="normal">:</Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00135" /><CodeLine lineNumber="135"><Highlight kind="comment">  /// The information about a block&#39;s conditional terminators needed to trace</Highlight></CodeLine>
<Link id="l00136" /><CodeLine lineNumber="136"><Highlight kind="comment">  /// our predicate state through the exiting edges.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00137" /><CodeLine lineNumber="137"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">struct </Highlight><Highlight kind="normal">BlockCondInfo &#123;</Highlight></CodeLine>
<Link id="l00138" /><CodeLine lineNumber="138"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>;</Highlight></CodeLine>
<Link id="l00139" /><CodeLine lineNumber="139"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00140" /><CodeLine lineNumber="140"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We mostly have one conditional branch, and in extremely rare cases have</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00141" /><CodeLine lineNumber="141"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// two. Three and more are so rare as to be unimportant for compile time.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00142" /><CodeLine lineNumber="142"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineInstr &#42;, 2&gt;</a> CondBrs;</Highlight></CodeLine>
<Link id="l00143" /><CodeLine lineNumber="143"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00144" /><CodeLine lineNumber="144"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;UncondBr;</Highlight></CodeLine>
<Link id="l00145" /><CodeLine lineNumber="145"><Highlight kind="normal">  &#125;;</Highlight></CodeLine>
<Link id="l00146" /><CodeLine lineNumber="146"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00147" /><CodeLine lineNumber="147"><Highlight kind="comment">  /// Manages the predicate state traced through the program.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00148" /><CodeLine lineNumber="148"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">struct </Highlight><Highlight kind="normal">PredState &#123;</Highlight></CodeLine>
<Link id="l00149" /><CodeLine lineNumber="149"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> InitialReg = 0;</Highlight></CodeLine>
<Link id="l00150" /><CodeLine lineNumber="150"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> PoisonReg = 0;</Highlight></CodeLine>
<Link id="l00151" /><CodeLine lineNumber="151"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00152" /><CodeLine lineNumber="152"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/targetregisterclass">TargetRegisterClass</a> &#42;RC;</Highlight></CodeLine>
<Link id="l00153" /><CodeLine lineNumber="153"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machinessaupdater">MachineSSAUpdater</a> <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>;</Highlight></CodeLine>
<Link id="l00154" /><CodeLine lineNumber="154"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00155" /><CodeLine lineNumber="155"><Highlight kind="normal">    PredState(<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/targetregisterclass">TargetRegisterClass</a> &#42;RC)</Highlight></CodeLine>
<Link id="l00156" /><CodeLine lineNumber="156"><Highlight kind="normal">        : RC(RC), <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>(MF) &#123;&#125;</Highlight></CodeLine>
<Link id="l00157" /><CodeLine lineNumber="157"><Highlight kind="normal">  &#125;;</Highlight></CodeLine>
<Link id="l00158" /><CodeLine lineNumber="158"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00159" /><CodeLine lineNumber="159"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> X86Subtarget &#42;Subtarget = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00160" /><CodeLine lineNumber="160"><Highlight kind="normal">  MachineRegisterInfo &#42;MRI = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00161" /><CodeLine lineNumber="161"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> X86InstrInfo &#42;TII = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00162" /><CodeLine lineNumber="162"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> TargetRegisterInfo &#42;TRI = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00163" /><CodeLine lineNumber="163"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00164" /><CodeLine lineNumber="164"><Highlight kind="normal">  std::optional&lt;PredState&gt; PS;</Highlight></CodeLine>
<Link id="l00165" /><CodeLine lineNumber="165"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00166" /><CodeLine lineNumber="166"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> hardenEdgesWithLFENCE(MachineFunction &amp;MF);</Highlight></CodeLine>
<Link id="l00167" /><CodeLine lineNumber="167"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00168" /><CodeLine lineNumber="168"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#a8fc529c79977cdd01e187986f960a07f">SmallVector&lt;BlockCondInfo, 16&gt;</a> collectBlockCondInfo(MachineFunction &amp;MF);</Highlight></CodeLine>
<Link id="l00169" /><CodeLine lineNumber="169"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00170" /><CodeLine lineNumber="170"><Highlight kind="normal">  SmallVector&lt;MachineInstr &#42;, 16&gt;</Highlight></CodeLine>
<Link id="l00171" /><CodeLine lineNumber="171"><Highlight kind="normal">  tracePredStateThroughCFG(MachineFunction &amp;MF, <a href="/docs/api/namespaces/llvm/#ab9c6b351507d3c0730f4290919d43a12">ArrayRef&lt;BlockCondInfo&gt;</a> Infos);</Highlight></CodeLine>
<Link id="l00172" /><CodeLine lineNumber="172"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00173" /><CodeLine lineNumber="173"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> unfoldCallAndJumpLoads(MachineFunction &amp;MF);</Highlight></CodeLine>
<Link id="l00174" /><CodeLine lineNumber="174"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00175" /><CodeLine lineNumber="175"><Highlight kind="normal">  SmallVector&lt;MachineInstr &#42;, 16&gt;</Highlight></CodeLine>
<Link id="l00176" /><CodeLine lineNumber="176"><Highlight kind="normal">  tracePredStateThroughIndirectBranches(MachineFunction &amp;MF);</Highlight></CodeLine>
<Link id="l00177" /><CodeLine lineNumber="177"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00178" /><CodeLine lineNumber="178"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> tracePredStateThroughBlocksAndHarden(MachineFunction &amp;MF);</Highlight></CodeLine>
<Link id="l00179" /><CodeLine lineNumber="179"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00180" /><CodeLine lineNumber="180"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> saveEFLAGS(MachineBasicBlock &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>,</Highlight></CodeLine>
<Link id="l00181" /><CodeLine lineNumber="181"><Highlight kind="normal">                      <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> InsertPt,</Highlight></CodeLine>
<Link id="l00182" /><CodeLine lineNumber="182"><Highlight kind="normal">                      </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a> &amp;Loc);</Highlight></CodeLine>
<Link id="l00183" /><CodeLine lineNumber="183"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> restoreEFLAGS(MachineBasicBlock &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>,</Highlight></CodeLine>
<Link id="l00184" /><CodeLine lineNumber="184"><Highlight kind="normal">                     <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> InsertPt, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a> &amp;Loc,</Highlight></CodeLine>
<Link id="l00185" /><CodeLine lineNumber="185"><Highlight kind="normal">                     <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/mem2reg-cpp/#a6fde3eb6ca09ddf2fd76432176d817bb">Register</a> <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>);</Highlight></CodeLine>
<Link id="l00186" /><CodeLine lineNumber="186"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00187" /><CodeLine lineNumber="187"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> mergePredStateIntoSP(MachineBasicBlock &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>,</Highlight></CodeLine>
<Link id="l00188" /><CodeLine lineNumber="188"><Highlight kind="normal">                            <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> InsertPt,</Highlight></CodeLine>
<Link id="l00189" /><CodeLine lineNumber="189"><Highlight kind="normal">                            </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a> &amp;Loc, </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> PredStateReg);</Highlight></CodeLine>
<Link id="l00190" /><CodeLine lineNumber="190"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> extractPredStateFromSP(MachineBasicBlock &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>,</Highlight></CodeLine>
<Link id="l00191" /><CodeLine lineNumber="191"><Highlight kind="normal">                                  <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> InsertPt,</Highlight></CodeLine>
<Link id="l00192" /><CodeLine lineNumber="192"><Highlight kind="normal">                                  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a> &amp;Loc);</Highlight></CodeLine>
<Link id="l00193" /><CodeLine lineNumber="193"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00194" /><CodeLine lineNumber="194"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00195" /><CodeLine lineNumber="195"><Highlight kind="normal">  hardenLoadAddr(MachineInstr &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>, MachineOperand &amp;BaseMO,</Highlight></CodeLine>
<Link id="l00196" /><CodeLine lineNumber="196"><Highlight kind="normal">                 MachineOperand &amp;IndexMO,</Highlight></CodeLine>
<Link id="l00197" /><CodeLine lineNumber="197"><Highlight kind="normal">                 SmallDenseMap&lt;unsigned, unsigned, 32&gt; &amp;AddrRegToHardenedReg);</Highlight></CodeLine>
<Link id="l00198" /><CodeLine lineNumber="198"><Highlight kind="normal">  MachineInstr &#42;</Highlight></CodeLine>
<Link id="l00199" /><CodeLine lineNumber="199"><Highlight kind="normal">  sinkPostLoadHardenedInst(MachineInstr &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>,</Highlight></CodeLine>
<Link id="l00200" /><CodeLine lineNumber="200"><Highlight kind="normal">                           SmallPtrSetImpl&lt;MachineInstr &#42;&gt; &amp;HardenedInstrs);</Highlight></CodeLine>
<Link id="l00201" /><CodeLine lineNumber="201"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> canHardenRegister(<a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/mem2reg-cpp/#a6fde3eb6ca09ddf2fd76432176d817bb">Register</a> <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>);</Highlight></CodeLine>
<Link id="l00202" /><CodeLine lineNumber="202"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> hardenValueInRegister(<a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/mem2reg-cpp/#a6fde3eb6ca09ddf2fd76432176d817bb">Register</a> <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>, MachineBasicBlock &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>,</Highlight></CodeLine>
<Link id="l00203" /><CodeLine lineNumber="203"><Highlight kind="normal">                                 <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> InsertPt,</Highlight></CodeLine>
<Link id="l00204" /><CodeLine lineNumber="204"><Highlight kind="normal">                                 </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a> &amp;Loc);</Highlight></CodeLine>
<Link id="l00205" /><CodeLine lineNumber="205"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> hardenPostLoad(MachineInstr &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</Highlight></CodeLine>
<Link id="l00206" /><CodeLine lineNumber="206"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> hardenReturnInstr(MachineInstr &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</Highlight></CodeLine>
<Link id="l00207" /><CodeLine lineNumber="207"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> tracePredStateThroughCall(MachineInstr &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</Highlight></CodeLine>
<Link id="l00208" /><CodeLine lineNumber="208"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> hardenIndirectCallOrJumpInstr(</Highlight></CodeLine>
<Link id="l00209" /><CodeLine lineNumber="209"><Highlight kind="normal">      MachineInstr &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>,</Highlight></CodeLine>
<Link id="l00210" /><CodeLine lineNumber="210"><Highlight kind="normal">      SmallDenseMap&lt;unsigned, unsigned, 32&gt; &amp;AddrRegToHardenedReg);</Highlight></CodeLine>
<Link id="l00211" /><CodeLine lineNumber="211"><Highlight kind="normal">&#125;;</Highlight></CodeLine>
<Link id="l00212" /><CodeLine lineNumber="212"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00213" /><CodeLine lineNumber="213"><Highlight kind="normal">&#125; </Highlight><Highlight kind="comment">// end anonymous namespace</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00214" /><CodeLine lineNumber="214"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00215" /><CodeLine lineNumber="215"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">char</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a845bb9b2068e7fd8052fc0e53ed461e5">X86SpeculativeLoadHardeningPass::ID</a> = 0;</Highlight></CodeLine>
<Link id="l00216" /><CodeLine lineNumber="216"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00217" /><CodeLine lineNumber="217" lineLink="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a395357d9b35c4d32866dac3ab09a335a"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a395357d9b35c4d32866dac3ab09a335a">X86SpeculativeLoadHardeningPass::getAnalysisUsage</a>(</Highlight></CodeLine>
<Link id="l00218" /><CodeLine lineNumber="218"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/analysisusage">AnalysisUsage</a> &amp;AU)</Highlight><Highlight kind="keyword"> const </Highlight><Highlight kind="normal">&#123;</Highlight></CodeLine>
<Link id="l00219" /><CodeLine lineNumber="219"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/machinefunctionpass/#a864fd57b4304ef933b3281d0ef85a88e">MachineFunctionPass::getAnalysisUsage</a>(AU);</Highlight></CodeLine>
<Link id="l00220" /><CodeLine lineNumber="220"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00221" /><CodeLine lineNumber="221"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00222" /><CodeLine lineNumber="222" lineLink="#a18b17899654dd5adb69b62c89ba95783"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="#a18b17899654dd5adb69b62c89ba95783">splitEdge</a>(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>,</Highlight></CodeLine>
<Link id="l00223" /><CodeLine lineNumber="223"><Highlight kind="normal">                                    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;Succ, </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> SuccCount,</Highlight></CodeLine>
<Link id="l00224" /><CodeLine lineNumber="224"><Highlight kind="normal">                                    <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;Br, <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;&amp;UncondBr,</Highlight></CodeLine>
<Link id="l00225" /><CodeLine lineNumber="225"><Highlight kind="normal">                                    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/x86instrinfo">X86InstrInfo</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>) &#123;</Highlight></CodeLine>
<Link id="l00226" /><CodeLine lineNumber="226"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!Succ.<a href="/docs/api/classes/llvm/machinebasicblock/#a1100bfbadd996d464150c6a68fa8dc1d">isEHPad</a>() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Shouldn&#39;t get edges to EH pads!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00227" /><CodeLine lineNumber="227"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00228" /><CodeLine lineNumber="228"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF = &#42;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.getParent();</Highlight></CodeLine>
<Link id="l00229" /><CodeLine lineNumber="229"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00230" /><CodeLine lineNumber="230"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;NewMBB = &#42;MF.<a href="/docs/api/classes/llvm/machinefunction/#adfc62ee16549afaac5bde30156ddc989">CreateMachineBasicBlock</a>();</Highlight></CodeLine>
<Link id="l00231" /><CodeLine lineNumber="231"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00232" /><CodeLine lineNumber="232"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We have to insert the new block immediately after the current one as we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00233" /><CodeLine lineNumber="233"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// don&#39;t know what layout-successor relationships the successor has and we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00234" /><CodeLine lineNumber="234"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// may not be able to (and generally don&#39;t want to) try to fix those up.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00235" /><CodeLine lineNumber="235"><Highlight kind="normal">  MF.<a href="/docs/api/classes/llvm/machinefunction/#af4c0db6d503e0ba3b8e44067023ffbba">insert</a>(std::next(<a href="/docs/api/classes/llvm/machinefunction/#aaba82c71ffdca966cad10eae0992fff9">MachineFunction::iterator</a>(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>)), &amp;NewMBB);</Highlight></CodeLine>
<Link id="l00236" /><CodeLine lineNumber="236"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00237" /><CodeLine lineNumber="237"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Update the branch instruction if necessary.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00238" /><CodeLine lineNumber="238"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Br) &#123;</Highlight></CodeLine>
<Link id="l00239" /><CodeLine lineNumber="239"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Br-&gt;<a href="/docs/api/classes/llvm/machineinstr/#ad67c9230577a0b640c52852c75c93939">getOperand</a>(0).<a href="/docs/api/classes/llvm/machineoperand/#a57e64b633278df75c699e6b98ce15031">getMBB</a>() == &amp;Succ &amp;&amp;</Highlight></CodeLine>
<Link id="l00240" /><CodeLine lineNumber="240"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;Didn&#39;t start with the right target!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00241" /><CodeLine lineNumber="241"><Highlight kind="normal">    Br-&gt;<a href="/docs/api/classes/llvm/machineinstr/#ad67c9230577a0b640c52852c75c93939">getOperand</a>(0).<a href="/docs/api/classes/llvm/machineoperand/#a98e9c9e8ef7cbb6c4aa89a38f21decfa">setMBB</a>(&amp;NewMBB);</Highlight></CodeLine>
<Link id="l00242" /><CodeLine lineNumber="242"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00243" /><CodeLine lineNumber="243"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If this successor was reached through a branch rather than fallthrough,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00244" /><CodeLine lineNumber="244"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// we might have &#42;broken&#42; fallthrough and so need to inject a new</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00245" /><CodeLine lineNumber="245"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// unconditional branch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00246" /><CodeLine lineNumber="246"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!UncondBr) &#123;</Highlight></CodeLine>
<Link id="l00247" /><CodeLine lineNumber="247"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;OldLayoutSucc =</Highlight></CodeLine>
<Link id="l00248" /><CodeLine lineNumber="248"><Highlight kind="normal">          &#42;std::next(<a href="/docs/api/classes/llvm/machinefunction/#aaba82c71ffdca966cad10eae0992fff9">MachineFunction::iterator</a>(&amp;NewMBB));</Highlight></CodeLine>
<Link id="l00249" /><CodeLine lineNumber="249"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.isSuccessor(&amp;OldLayoutSucc) &amp;&amp;</Highlight></CodeLine>
<Link id="l00250" /><CodeLine lineNumber="250"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;Without an unconditional branch, the old layout successor should &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00251" /><CodeLine lineNumber="251"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;be an actual successor!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00252" /><CodeLine lineNumber="252"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> BrBuilder =</Highlight></CodeLine>
<Link id="l00253" /><CodeLine lineNumber="253"><Highlight kind="normal">          <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a>(), <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>.get(X86::JMP&#95;1)).<a href="/docs/api/classes/llvm/machineinstrbuilder/#abf1febf2a98f588146548a3a485d3838">addMBB</a>(&amp;OldLayoutSucc);</Highlight></CodeLine>
<Link id="l00254" /><CodeLine lineNumber="254"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Update the unconditional branch now that we&#39;ve added one.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00255" /><CodeLine lineNumber="255"><Highlight kind="normal">      UncondBr = &amp;&#42;BrBuilder;</Highlight></CodeLine>
<Link id="l00256" /><CodeLine lineNumber="256"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00257" /><CodeLine lineNumber="257"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00258" /><CodeLine lineNumber="258"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Insert unconditional &quot;jump Succ&quot; instruction in the new block if</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00259" /><CodeLine lineNumber="259"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// necessary.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00260" /><CodeLine lineNumber="260"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!NewMBB.<a href="/docs/api/classes/llvm/machinebasicblock/#abd85c9d7c51eb515a550069e9ad9445e">isLayoutSuccessor</a>(&amp;Succ)) &#123;</Highlight></CodeLine>
<Link id="l00261" /><CodeLine lineNumber="261"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineOperand, 4&gt;</a> <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>;</Highlight></CodeLine>
<Link id="l00262" /><CodeLine lineNumber="262"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>.insertBranch(NewMBB, &amp;Succ, </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, Br-&gt;<a href="/docs/api/classes/llvm/machineinstr/#abb10ef030fba4ea901518a0c8dbef3e2">getDebugLoc</a>());</Highlight></CodeLine>
<Link id="l00263" /><CodeLine lineNumber="263"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00264" /><CodeLine lineNumber="264"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00265" /><CodeLine lineNumber="265"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!UncondBr &amp;&amp;</Highlight></CodeLine>
<Link id="l00266" /><CodeLine lineNumber="266"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;Cannot have a branchless successor and an unconditional branch!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00267" /><CodeLine lineNumber="267"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(NewMBB.<a href="/docs/api/classes/llvm/machinebasicblock/#abd85c9d7c51eb515a550069e9ad9445e">isLayoutSuccessor</a>(&amp;Succ) &amp;&amp;</Highlight></CodeLine>
<Link id="l00268" /><CodeLine lineNumber="268"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;A non-branch successor must have been a layout successor before &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00269" /><CodeLine lineNumber="269"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;and now is a layout successor of the new block.&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00270" /><CodeLine lineNumber="270"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00271" /><CodeLine lineNumber="271"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00272" /><CodeLine lineNumber="272"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If this is the only edge to the successor, we can just replace it in the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00273" /><CodeLine lineNumber="273"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// CFG. Otherwise we need to add a new entry in the CFG for the new</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00274" /><CodeLine lineNumber="274"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// successor.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00275" /><CodeLine lineNumber="275"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SuccCount == 1) &#123;</Highlight></CodeLine>
<Link id="l00276" /><CodeLine lineNumber="276"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.replaceSuccessor(&amp;Succ, &amp;NewMBB);</Highlight></CodeLine>
<Link id="l00277" /><CodeLine lineNumber="277"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00278" /><CodeLine lineNumber="278"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.splitSuccessor(&amp;Succ, &amp;NewMBB);</Highlight></CodeLine>
<Link id="l00279" /><CodeLine lineNumber="279"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00280" /><CodeLine lineNumber="280"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00281" /><CodeLine lineNumber="281"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Hook up the edge from the new basic block to the old successor in the CFG.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00282" /><CodeLine lineNumber="282"><Highlight kind="normal">  NewMBB.<a href="/docs/api/classes/llvm/machinebasicblock/#a935e2a8884592189d8f261634a0b24c5">addSuccessor</a>(&amp;Succ);</Highlight></CodeLine>
<Link id="l00283" /><CodeLine lineNumber="283"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00284" /><CodeLine lineNumber="284"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Fix PHI nodes in Succ so they refer to NewMBB instead of MBB.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00285" /><CodeLine lineNumber="285"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> : Succ) &#123;</Highlight></CodeLine>
<Link id="l00286" /><CodeLine lineNumber="286"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isPHI())</Highlight></CodeLine>
<Link id="l00287" /><CodeLine lineNumber="287"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">break</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00288" /><CodeLine lineNumber="288"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> OpIdx = 1, <a href="/docs/api/files/include/include/llvm/include/llvm/demangle/itaniumdemangle-h/#a536e22898d28a9340a4204407a75ad5d">NumOps</a> = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getNumOperands(); OpIdx &lt; <a href="/docs/api/files/include/include/llvm/include/llvm/demangle/itaniumdemangle-h/#a536e22898d28a9340a4204407a75ad5d">NumOps</a>;</Highlight></CodeLine>
<Link id="l00289" /><CodeLine lineNumber="289"><Highlight kind="normal">         OpIdx += 2) &#123;</Highlight></CodeLine>
<Link id="l00290" /><CodeLine lineNumber="290"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;OpV = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(OpIdx);</Highlight></CodeLine>
<Link id="l00291" /><CodeLine lineNumber="291"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;OpMBB = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(OpIdx + 1);</Highlight></CodeLine>
<Link id="l00292" /><CodeLine lineNumber="292"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(OpMBB.<a href="/docs/api/classes/llvm/machineoperand/#afe1784e242ce66da6029b3a681896bd2">isMBB</a>() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Block operand to a PHI is not a block!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00293" /><CodeLine lineNumber="293"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (OpMBB.<a href="/docs/api/classes/llvm/machineoperand/#a57e64b633278df75c699e6b98ce15031">getMBB</a>() != &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>)</Highlight></CodeLine>
<Link id="l00294" /><CodeLine lineNumber="294"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00295" /><CodeLine lineNumber="295"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00296" /><CodeLine lineNumber="296"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// If this is the last edge to the succesor, just replace MBB in the PHI</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00297" /><CodeLine lineNumber="297"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SuccCount == 1) &#123;</Highlight></CodeLine>
<Link id="l00298" /><CodeLine lineNumber="298"><Highlight kind="normal">        OpMBB.<a href="/docs/api/classes/llvm/machineoperand/#a98e9c9e8ef7cbb6c4aa89a38f21decfa">setMBB</a>(&amp;NewMBB);</Highlight></CodeLine>
<Link id="l00299" /><CodeLine lineNumber="299"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">break</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00300" /><CodeLine lineNumber="300"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00301" /><CodeLine lineNumber="301"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00302" /><CodeLine lineNumber="302"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Otherwise, append a new pair of operands for the new incoming edge.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00303" /><CodeLine lineNumber="303"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.addOperand(MF, OpV);</Highlight></CodeLine>
<Link id="l00304" /><CodeLine lineNumber="304"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.addOperand(MF, <a href="/docs/api/classes/llvm/machineoperand/#af38d24646cd711efc334aee49919cdf5">MachineOperand::CreateMBB</a>(&amp;NewMBB));</Highlight></CodeLine>
<Link id="l00305" /><CodeLine lineNumber="305"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">break</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00306" /><CodeLine lineNumber="306"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00307" /><CodeLine lineNumber="307"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00308" /><CodeLine lineNumber="308"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00309" /><CodeLine lineNumber="309"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Inherit live-ins from the successor</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00310" /><CodeLine lineNumber="310"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;LI : Succ.<a href="/docs/api/classes/llvm/machinebasicblock/#a364ed6e68f92f797c0cd9e53ce5ea2a5">liveins</a>())</Highlight></CodeLine>
<Link id="l00311" /><CodeLine lineNumber="311"><Highlight kind="normal">    NewMBB.<a href="/docs/api/classes/llvm/machinebasicblock/#acce9c12cc977a88dc7bc51493ce7681c">addLiveIn</a>(LI);</Highlight></CodeLine>
<Link id="l00312" /><CodeLine lineNumber="312"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00313" /><CodeLine lineNumber="313"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Split edge from &#39;&quot;</Highlight><Highlight kind="normal"> &lt;&lt; <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.getName() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;&#39; to &#39;&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00314" /><CodeLine lineNumber="314"><Highlight kind="normal">                    &lt;&lt; Succ.<a href="/docs/api/classes/llvm/machinebasicblock/#aedf6cb1135961f41f39dc58ca8576123">getName</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;&#39;.\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00315" /><CodeLine lineNumber="315"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> NewMBB;</Highlight></CodeLine>
<Link id="l00316" /><CodeLine lineNumber="316"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00317" /><CodeLine lineNumber="317"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00318" /><CodeLine lineNumber="318"><Highlight kind="comment">/// Removing duplicate PHI operands to leave the PHI in a canonical and</Highlight></CodeLine>
<Link id="l00319" /><CodeLine lineNumber="319"><Highlight kind="comment">/// predictable form.</Highlight></CodeLine>
<Link id="l00320" /><CodeLine lineNumber="320"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00321" /><CodeLine lineNumber="321"><Highlight kind="comment">/// FIXME: It&#39;s really frustrating that we have to do this, but SSA-form in MIR</Highlight></CodeLine>
<Link id="l00322" /><CodeLine lineNumber="322"><Highlight kind="comment">/// isn&#39;t what you might expect. We may have multiple entries in PHI nodes for</Highlight></CodeLine>
<Link id="l00323" /><CodeLine lineNumber="323"><Highlight kind="comment">/// a single predecessor. This makes CFG-updating extremely complex, so here we</Highlight></CodeLine>
<Link id="l00324" /><CodeLine lineNumber="324"><Highlight kind="comment">/// simplify all PHI nodes to a model even simpler than the IR&#39;s model: exactly</Highlight></CodeLine>
<Link id="l00325" /><CodeLine lineNumber="325"><Highlight kind="comment">/// one entry per predecessor, regardless of how many edges there are.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00326" /><CodeLine lineNumber="326" lineLink="#a22244f1af2bc880ef42bfd77068ce13a"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#a22244f1af2bc880ef42bfd77068ce13a">canonicalizePHIOperands</a>(<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF) &#123;</Highlight></CodeLine>
<Link id="l00327" /><CodeLine lineNumber="327"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;MachineBasicBlock &#42;, 4&gt;</a> Preds;</Highlight></CodeLine>
<Link id="l00328" /><CodeLine lineNumber="328"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;int, 4&gt;</a> DupIndices;</Highlight></CodeLine>
<Link id="l00329" /><CodeLine lineNumber="329"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : MF)</Highlight></CodeLine>
<Link id="l00330" /><CodeLine lineNumber="330"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> : <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>) &#123;</Highlight></CodeLine>
<Link id="l00331" /><CodeLine lineNumber="331"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isPHI())</Highlight></CodeLine>
<Link id="l00332" /><CodeLine lineNumber="332"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">break</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00333" /><CodeLine lineNumber="333"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00334" /><CodeLine lineNumber="334"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// First we scan the operands of the PHI looking for duplicate entries</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00335" /><CodeLine lineNumber="335"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// a particular predecessor. We retain the operand index of each duplicate</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00336" /><CodeLine lineNumber="336"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// entry found.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00337" /><CodeLine lineNumber="337"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> OpIdx = 1, <a href="/docs/api/files/include/include/llvm/include/llvm/demangle/itaniumdemangle-h/#a536e22898d28a9340a4204407a75ad5d">NumOps</a> = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getNumOperands(); OpIdx &lt; <a href="/docs/api/files/include/include/llvm/include/llvm/demangle/itaniumdemangle-h/#a536e22898d28a9340a4204407a75ad5d">NumOps</a>;</Highlight></CodeLine>
<Link id="l00338" /><CodeLine lineNumber="338"><Highlight kind="normal">           OpIdx += 2)</Highlight></CodeLine>
<Link id="l00339" /><CodeLine lineNumber="339"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!Preds.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(OpIdx + 1).getMBB()).second)</Highlight></CodeLine>
<Link id="l00340" /><CodeLine lineNumber="340"><Highlight kind="normal">          DupIndices.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(OpIdx);</Highlight></CodeLine>
<Link id="l00341" /><CodeLine lineNumber="341"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00342" /><CodeLine lineNumber="342"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Now walk the duplicate indices, removing both the block and value. Note</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00343" /><CodeLine lineNumber="343"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// that these are stored as a vector making this element-wise removal</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00344" /><CodeLine lineNumber="344"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// :w</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00345" /><CodeLine lineNumber="345"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// potentially quadratic.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00346" /><CodeLine lineNumber="346"><Highlight kind="normal">      </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00347" /><CodeLine lineNumber="347"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// FIXME: It is really frustrating that we have to use a quadratic</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00348" /><CodeLine lineNumber="348"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// removal algorithm here. There should be a better way, but the use-def</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00349" /><CodeLine lineNumber="349"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// updates required make that impossible using the public API.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00350" /><CodeLine lineNumber="350"><Highlight kind="normal">      </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00351" /><CodeLine lineNumber="351"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Note that we have to process these backwards so that we don&#39;t</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00352" /><CodeLine lineNumber="352"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// invalidate other indices with each removal.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00353" /><CodeLine lineNumber="353"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (!DupIndices.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>()) &#123;</Highlight></CodeLine>
<Link id="l00354" /><CodeLine lineNumber="354"><Highlight kind="normal">        </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> OpIdx = DupIndices.<a href="/docs/api/classes/llvm/smallvectorimpl/#a0c8ffe664a36e30d49c84d0aded2fe08">pop&#95;back&#95;val</a>();</Highlight></CodeLine>
<Link id="l00355" /><CodeLine lineNumber="355"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Remove both the block and value operand, again in reverse order to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00356" /><CodeLine lineNumber="356"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// preserve indices.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00357" /><CodeLine lineNumber="357"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.removeOperand(OpIdx + 1);</Highlight></CodeLine>
<Link id="l00358" /><CodeLine lineNumber="358"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.removeOperand(OpIdx);</Highlight></CodeLine>
<Link id="l00359" /><CodeLine lineNumber="359"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00360" /><CodeLine lineNumber="360"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00361" /><CodeLine lineNumber="361"><Highlight kind="normal">      Preds.<a href="/docs/api/classes/llvm/smallptrsetimplbase/#a16413f1a88d8baca228d0a1b4cc0bfc6">clear</a>();</Highlight></CodeLine>
<Link id="l00362" /><CodeLine lineNumber="362"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00363" /><CodeLine lineNumber="363"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00364" /><CodeLine lineNumber="364"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00365" /><CodeLine lineNumber="365"><Highlight kind="comment">/// Helper to scan a function for loads vulnerable to misspeculation that we</Highlight></CodeLine>
<Link id="l00366" /><CodeLine lineNumber="366"><Highlight kind="comment">/// want to harden.</Highlight></CodeLine>
<Link id="l00367" /><CodeLine lineNumber="367"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00368" /><CodeLine lineNumber="368"><Highlight kind="comment">/// We use this to avoid making changes to functions where there is nothing we</Highlight></CodeLine>
<Link id="l00369" /><CodeLine lineNumber="369"><Highlight kind="comment">/// need to do to harden against misspeculation.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00370" /><CodeLine lineNumber="370" lineLink="#abe47da1ba1b5239bb67b26d5ebbca491"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#abe47da1ba1b5239bb67b26d5ebbca491">hasVulnerableLoad</a>(<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF) &#123;</Highlight></CodeLine>
<Link id="l00371" /><CodeLine lineNumber="371"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : MF) &#123;</Highlight></CodeLine>
<Link id="l00372" /><CodeLine lineNumber="372"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> : <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>) &#123;</Highlight></CodeLine>
<Link id="l00373" /><CodeLine lineNumber="373"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Loads within this basic block after an LFENCE are not at risk of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00374" /><CodeLine lineNumber="374"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// speculatively executing with invalid predicates from prior control</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00375" /><CodeLine lineNumber="375"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// flow. So break out of this block but continue scanning the function.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00376" /><CodeLine lineNumber="376"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOpcode() == X86::LFENCE)</Highlight></CodeLine>
<Link id="l00377" /><CodeLine lineNumber="377"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">break</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00378" /><CodeLine lineNumber="378"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00379" /><CodeLine lineNumber="379"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Looking for loads only.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00380" /><CodeLine lineNumber="380"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.mayLoad())</Highlight></CodeLine>
<Link id="l00381" /><CodeLine lineNumber="381"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00382" /><CodeLine lineNumber="382"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00383" /><CodeLine lineNumber="383"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// An MFENCE is modeled as a load but isn&#39;t vulnerable to misspeculation.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00384" /><CodeLine lineNumber="384"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOpcode() == X86::MFENCE)</Highlight></CodeLine>
<Link id="l00385" /><CodeLine lineNumber="385"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00386" /><CodeLine lineNumber="386"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00387" /><CodeLine lineNumber="387"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We found a load.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00388" /><CodeLine lineNumber="388"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00389" /><CodeLine lineNumber="389"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00390" /><CodeLine lineNumber="390"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00391" /><CodeLine lineNumber="391"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00392" /><CodeLine lineNumber="392"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// No loads found.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00393" /><CodeLine lineNumber="393"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00394" /><CodeLine lineNumber="394"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00395" /><CodeLine lineNumber="395"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00396" /><CodeLine lineNumber="396" lineLink="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a862b3b4b5ed250fcfb2d6f9a130f4a0c"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a862b3b4b5ed250fcfb2d6f9a130f4a0c">X86SpeculativeLoadHardeningPass::runOnMachineFunction</a>(</Highlight></CodeLine>
<Link id="l00397" /><CodeLine lineNumber="397"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF) &#123;</Highlight></CodeLine>
<Link id="l00398" /><CodeLine lineNumber="398"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42; &quot;</Highlight><Highlight kind="normal"> &lt;&lt; <a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#afc095bc1100ba5f1e44a49e741303f28">getPassName</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; : &quot;</Highlight><Highlight kind="normal"> &lt;&lt; MF.<a href="/docs/api/classes/llvm/machinefunction/#a3d142c9e7c066059e15232c56dec9e2e">getName</a>()</Highlight></CodeLine>
<Link id="l00399" /><CodeLine lineNumber="399"><Highlight kind="normal">                    &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; &#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00400" /><CodeLine lineNumber="400"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00401" /><CodeLine lineNumber="401"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Only run if this pass is forced enabled or we detect the relevant function</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00402" /><CodeLine lineNumber="402"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// attribute requesting SLH.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00403" /><CodeLine lineNumber="403"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="#a964a795e07ed117f8049f44b16739763">EnableSpeculativeLoadHardening</a> &amp;&amp;</Highlight></CodeLine>
<Link id="l00404" /><CodeLine lineNumber="404"><Highlight kind="normal">      !MF.<a href="/docs/api/classes/llvm/machinefunction/#a977ddce262de45c645be23d951066351">getFunction</a>().<a href="/docs/api/classes/llvm/function/#afb28a4deafe2954b0534cc6399ce518b">hasFnAttribute</a>(Attribute::SpeculativeLoadHardening))</Highlight></CodeLine>
<Link id="l00405" /><CodeLine lineNumber="405"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00406" /><CodeLine lineNumber="406"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00407" /><CodeLine lineNumber="407"><Highlight kind="normal">  Subtarget = &amp;MF.<a href="/docs/api/classes/llvm/machinefunction/#a3825368aca2bc1550d173660df4da6a6">getSubtarget</a>&lt;<a href="/docs/api/classes/llvm/x86subtarget">X86Subtarget</a>&gt;();</Highlight></CodeLine>
<Link id="l00408" /><CodeLine lineNumber="408"><Highlight kind="normal">  MRI = &amp;MF.<a href="/docs/api/classes/llvm/machinefunction/#a810234b6b3d223b7c74a4253fcc5ea5e">getRegInfo</a>();</Highlight></CodeLine>
<Link id="l00409" /><CodeLine lineNumber="409"><Highlight kind="normal">  TII = Subtarget-&gt;getInstrInfo();</Highlight></CodeLine>
<Link id="l00410" /><CodeLine lineNumber="410"><Highlight kind="normal">  TRI = Subtarget-&gt;getRegisterInfo();</Highlight></CodeLine>
<Link id="l00411" /><CodeLine lineNumber="411"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00412" /><CodeLine lineNumber="412"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// FIXME: Support for 32-bit.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00413" /><CodeLine lineNumber="413"><Highlight kind="normal">  PS.emplace(MF, &amp;X86::GR64&#95;NOSPRegClass);</Highlight></CodeLine>
<Link id="l00414" /><CodeLine lineNumber="414"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00415" /><CodeLine lineNumber="415"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MF.<a href="/docs/api/classes/llvm/machinefunction/#ab0789854909cf47f640a85fa2bac29c7">begin</a>() == MF.<a href="/docs/api/classes/llvm/machinefunction/#a9d017af749f76484cb9aec9ff6e4330c">end</a>())</Highlight></CodeLine>
<Link id="l00416" /><CodeLine lineNumber="416"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Nothing to do for a degenerate empty function...</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00417" /><CodeLine lineNumber="417"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00418" /><CodeLine lineNumber="418"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00419" /><CodeLine lineNumber="419"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We support an alternative hardening technique based on a debug flag.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00420" /><CodeLine lineNumber="420"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#a921b17e18b1d37ab8ca2b7375df1addf">HardenEdgesWithLFENCE</a>) &#123;</Highlight></CodeLine>
<Link id="l00421" /><CodeLine lineNumber="421"><Highlight kind="normal">    hardenEdgesWithLFENCE(MF);</Highlight></CodeLine>
<Link id="l00422" /><CodeLine lineNumber="422"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00423" /><CodeLine lineNumber="423"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00424" /><CodeLine lineNumber="424"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00425" /><CodeLine lineNumber="425"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Create a dummy debug loc to use for all the generated code here.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00426" /><CodeLine lineNumber="426"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> <a href="/docs/api/namespaces/llvm/loc">Loc</a>;</Highlight></CodeLine>
<Link id="l00427" /><CodeLine lineNumber="427"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00428" /><CodeLine lineNumber="428"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;Entry = &#42;MF.<a href="/docs/api/classes/llvm/machinefunction/#ab0789854909cf47f640a85fa2bac29c7">begin</a>();</Highlight></CodeLine>
<Link id="l00429" /><CodeLine lineNumber="429"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> EntryInsertPt = Entry.SkipPHIsLabelsAndDebug(Entry.begin());</Highlight></CodeLine>
<Link id="l00430" /><CodeLine lineNumber="430"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00431" /><CodeLine lineNumber="431"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Do a quick scan to see if we have any checkable loads.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00432" /><CodeLine lineNumber="432"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> HasVulnerableLoad = <a href="#abe47da1ba1b5239bb67b26d5ebbca491">hasVulnerableLoad</a>(MF);</Highlight></CodeLine>
<Link id="l00433" /><CodeLine lineNumber="433"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00434" /><CodeLine lineNumber="434"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// See if we have any conditional branching blocks that we will need to trace</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00435" /><CodeLine lineNumber="435"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// predicate state through.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00436" /><CodeLine lineNumber="436"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BlockCondInfo, 16&gt;</a> Infos = collectBlockCondInfo(MF);</Highlight></CodeLine>
<Link id="l00437" /><CodeLine lineNumber="437"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00438" /><CodeLine lineNumber="438"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If we have no interesting conditions or loads, nothing to do here.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00439" /><CodeLine lineNumber="439"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!HasVulnerableLoad &amp;&amp; Infos.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>())</Highlight></CodeLine>
<Link id="l00440" /><CodeLine lineNumber="440"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00441" /><CodeLine lineNumber="441"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00442" /><CodeLine lineNumber="442"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The poison value is required to be an all-ones value for many aspects of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00443" /><CodeLine lineNumber="443"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// this mitigation.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00444" /><CodeLine lineNumber="444"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> PoisonVal = -1;</Highlight></CodeLine>
<Link id="l00445" /><CodeLine lineNumber="445"><Highlight kind="normal">  PS-&gt;PoisonReg = MRI-&gt;createVirtualRegister(PS-&gt;RC);</Highlight></CodeLine>
<Link id="l00446" /><CodeLine lineNumber="446"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(Entry, EntryInsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, TII-&gt;get(X86::MOV64ri32), PS-&gt;PoisonReg)</Highlight></CodeLine>
<Link id="l00447" /><CodeLine lineNumber="447"><Highlight kind="normal">      .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(PoisonVal);</Highlight></CodeLine>
<Link id="l00448" /><CodeLine lineNumber="448"><Highlight kind="normal">  ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l00449" /><CodeLine lineNumber="449"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00450" /><CodeLine lineNumber="450"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If we have loads being hardened and we&#39;ve asked for call and ret edges to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00451" /><CodeLine lineNumber="451"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// get a full fence-based mitigation, inject that fence.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00452" /><CodeLine lineNumber="452"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (HasVulnerableLoad &amp;&amp; <a href="#a5ee11464d0d2e030d95afb0db83b801d">FenceCallAndRet</a>) &#123;</Highlight></CodeLine>
<Link id="l00453" /><CodeLine lineNumber="453"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We need to insert an LFENCE at the start of the function to suspend any</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00454" /><CodeLine lineNumber="454"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// incoming misspeculation from the caller. This helps two-fold: the caller</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00455" /><CodeLine lineNumber="455"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// may not have been protected as this code has been, and this code gets to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00456" /><CodeLine lineNumber="456"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// not take any specific action to protect across calls.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00457" /><CodeLine lineNumber="457"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// FIXME: We could skip this for functions which unconditionally return</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00458" /><CodeLine lineNumber="458"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// a constant.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00459" /><CodeLine lineNumber="459"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(Entry, EntryInsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, TII-&gt;get(X86::LFENCE));</Highlight></CodeLine>
<Link id="l00460" /><CodeLine lineNumber="460"><Highlight kind="normal">    ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l00461" /><CodeLine lineNumber="461"><Highlight kind="normal">    ++NumLFENCEsInserted;</Highlight></CodeLine>
<Link id="l00462" /><CodeLine lineNumber="462"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00463" /><CodeLine lineNumber="463"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00464" /><CodeLine lineNumber="464"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If we guarded the entry with an LFENCE and have no conditionals to protect</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00465" /><CodeLine lineNumber="465"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// in blocks, then we&#39;re done.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00466" /><CodeLine lineNumber="466"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#a5ee11464d0d2e030d95afb0db83b801d">FenceCallAndRet</a> &amp;&amp; Infos.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>())</Highlight></CodeLine>
<Link id="l00467" /><CodeLine lineNumber="467"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We may have changed the function&#39;s code at this point to insert fences.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00468" /><CodeLine lineNumber="468"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00469" /><CodeLine lineNumber="469"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00470" /><CodeLine lineNumber="470"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// For every basic block in the function which can b</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00471" /><CodeLine lineNumber="471"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#a3e42304d79c25684c4d464fd35fb868f">HardenInterprocedurally</a> &amp;&amp; !<a href="#a5ee11464d0d2e030d95afb0db83b801d">FenceCallAndRet</a>) &#123;</Highlight></CodeLine>
<Link id="l00472" /><CodeLine lineNumber="472"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Set up the predicate state by extracting it from the incoming stack</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00473" /><CodeLine lineNumber="473"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// pointer so we pick up any misspeculation in our caller.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00474" /><CodeLine lineNumber="474"><Highlight kind="normal">    PS-&gt;InitialReg = extractPredStateFromSP(Entry, EntryInsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>);</Highlight></CodeLine>
<Link id="l00475" /><CodeLine lineNumber="475"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00476" /><CodeLine lineNumber="476"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Otherwise, just build the predicate state itself by zeroing a register</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00477" /><CodeLine lineNumber="477"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// as we don&#39;t need any initial state.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00478" /><CodeLine lineNumber="478"><Highlight kind="normal">    PS-&gt;InitialReg = MRI-&gt;createVirtualRegister(PS-&gt;RC);</Highlight></CodeLine>
<Link id="l00479" /><CodeLine lineNumber="479"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/register">Register</a> PredStateSubReg = MRI-&gt;createVirtualRegister(&amp;X86::GR32RegClass);</Highlight></CodeLine>
<Link id="l00480" /><CodeLine lineNumber="480"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> ZeroI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(Entry, EntryInsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, TII-&gt;get(X86::MOV32r0),</Highlight></CodeLine>
<Link id="l00481" /><CodeLine lineNumber="481"><Highlight kind="normal">                         PredStateSubReg);</Highlight></CodeLine>
<Link id="l00482" /><CodeLine lineNumber="482"><Highlight kind="normal">    ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l00483" /><CodeLine lineNumber="483"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &#42;ZeroEFLAGSDefOp =</Highlight></CodeLine>
<Link id="l00484" /><CodeLine lineNumber="484"><Highlight kind="normal">        ZeroI-&gt;findRegisterDefOperand(X86::EFLAGS, </Highlight><Highlight kind="comment">/&#42;TRI=&#42;/</Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00485" /><CodeLine lineNumber="485"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(ZeroEFLAGSDefOp &amp;&amp; ZeroEFLAGSDefOp-&gt;<a href="/docs/api/classes/llvm/machineoperand/#a3bf161859e1ad7fd3da485d3cb688d34">isImplicit</a>() &amp;&amp;</Highlight></CodeLine>
<Link id="l00486" /><CodeLine lineNumber="486"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;Must have an implicit def of EFLAGS!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00487" /><CodeLine lineNumber="487"><Highlight kind="normal">    ZeroEFLAGSDefOp-&gt;<a href="/docs/api/classes/llvm/machineoperand/#a61a42c85bd86c6ca4554e27d33c3f798">setIsDead</a>(</Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00488" /><CodeLine lineNumber="488"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(Entry, EntryInsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, TII-&gt;get(X86::SUBREG&#95;TO&#95;REG),</Highlight></CodeLine>
<Link id="l00489" /><CodeLine lineNumber="489"><Highlight kind="normal">            PS-&gt;InitialReg)</Highlight></CodeLine>
<Link id="l00490" /><CodeLine lineNumber="490"><Highlight kind="normal">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(0)</Highlight></CodeLine>
<Link id="l00491" /><CodeLine lineNumber="491"><Highlight kind="normal">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(PredStateSubReg)</Highlight></CodeLine>
<Link id="l00492" /><CodeLine lineNumber="492"><Highlight kind="normal">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(X86::sub&#95;32bit);</Highlight></CodeLine>
<Link id="l00493" /><CodeLine lineNumber="493"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00494" /><CodeLine lineNumber="494"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00495" /><CodeLine lineNumber="495"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We&#39;re going to need to trace predicate state throughout the function&#39;s</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00496" /><CodeLine lineNumber="496"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// CFG. Prepare for this by setting up our initial state of PHIs with unique</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00497" /><CodeLine lineNumber="497"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// predecessor entries and all the initial predicate state.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00498" /><CodeLine lineNumber="498"><Highlight kind="normal">  <a href="#a22244f1af2bc880ef42bfd77068ce13a">canonicalizePHIOperands</a>(MF);</Highlight></CodeLine>
<Link id="l00499" /><CodeLine lineNumber="499"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00500" /><CodeLine lineNumber="500"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Track the updated values in an SSA updater to rewrite into SSA form at the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00501" /><CodeLine lineNumber="501"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// end.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00502" /><CodeLine lineNumber="502"><Highlight kind="normal">  PS-&gt;SSA.Initialize(PS-&gt;InitialReg);</Highlight></CodeLine>
<Link id="l00503" /><CodeLine lineNumber="503"><Highlight kind="normal">  PS-&gt;SSA.AddAvailableValue(&amp;Entry, PS-&gt;InitialReg);</Highlight></CodeLine>
<Link id="l00504" /><CodeLine lineNumber="504"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00505" /><CodeLine lineNumber="505"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Trace through the CFG.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00506" /><CodeLine lineNumber="506"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> CMovs = tracePredStateThroughCFG(MF, Infos);</Highlight></CodeLine>
<Link id="l00507" /><CodeLine lineNumber="507"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00508" /><CodeLine lineNumber="508"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We may also enter basic blocks in this function via exception handling</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00509" /><CodeLine lineNumber="509"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// control flow. Here, if we are hardening interprocedurally, we need to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00510" /><CodeLine lineNumber="510"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// re-capture the predicate state from the throwing code. In the Itanium ABI,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00511" /><CodeLine lineNumber="511"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the throw will always look like a call to &#95;&#95;cxa&#95;throw and will have the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00512" /><CodeLine lineNumber="512"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// predicate state in the stack pointer, so extract fresh predicate state from</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00513" /><CodeLine lineNumber="513"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the stack pointer and make it available in SSA.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00514" /><CodeLine lineNumber="514"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// FIXME: Handle non-itanium ABI EH models.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00515" /><CodeLine lineNumber="515"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#a3e42304d79c25684c4d464fd35fb868f">HardenInterprocedurally</a>) &#123;</Highlight></CodeLine>
<Link id="l00516" /><CodeLine lineNumber="516"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : MF) &#123;</Highlight></CodeLine>
<Link id="l00517" /><CodeLine lineNumber="517"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.isEHScopeEntry() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Only Itanium ABI EH supported!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00518" /><CodeLine lineNumber="518"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.isEHFuncletEntry() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Only Itanium ABI EH supported!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00519" /><CodeLine lineNumber="519"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.isCleanupFuncletEntry() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Only Itanium ABI EH supported!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00520" /><CodeLine lineNumber="520"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.isEHPad())</Highlight></CodeLine>
<Link id="l00521" /><CodeLine lineNumber="521"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00522" /><CodeLine lineNumber="522"><Highlight kind="normal">      PS-&gt;SSA.AddAvailableValue(</Highlight></CodeLine>
<Link id="l00523" /><CodeLine lineNumber="523"><Highlight kind="normal">          &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>,</Highlight></CodeLine>
<Link id="l00524" /><CodeLine lineNumber="524"><Highlight kind="normal">          extractPredStateFromSP(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.SkipPHIsAndLabels(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.begin()), <a href="/docs/api/namespaces/llvm/loc">Loc</a>));</Highlight></CodeLine>
<Link id="l00525" /><CodeLine lineNumber="525"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00526" /><CodeLine lineNumber="526"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00527" /><CodeLine lineNumber="527"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00528" /><CodeLine lineNumber="528"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#ade91f65a65e423e2002fb9b25b7b2a5c">HardenIndirectCallsAndJumps</a>) &#123;</Highlight></CodeLine>
<Link id="l00529" /><CodeLine lineNumber="529"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If we are going to harden calls and jumps we need to unfold their memory</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00530" /><CodeLine lineNumber="530"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// operands.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00531" /><CodeLine lineNumber="531"><Highlight kind="normal">    unfoldCallAndJumpLoads(MF);</Highlight></CodeLine>
<Link id="l00532" /><CodeLine lineNumber="532"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00533" /><CodeLine lineNumber="533"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Then we trace predicate state through the indirect branches.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00534" /><CodeLine lineNumber="534"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> IndirectBrCMovs = tracePredStateThroughIndirectBranches(MF);</Highlight></CodeLine>
<Link id="l00535" /><CodeLine lineNumber="535"><Highlight kind="normal">    CMovs.append(IndirectBrCMovs.begin(), IndirectBrCMovs.end());</Highlight></CodeLine>
<Link id="l00536" /><CodeLine lineNumber="536"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00537" /><CodeLine lineNumber="537"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00538" /><CodeLine lineNumber="538"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now that we have the predicate state available at the start of each block</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00539" /><CodeLine lineNumber="539"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// in the CFG, trace it through each block, hardening vulnerable instructions</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00540" /><CodeLine lineNumber="540"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// as we go.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00541" /><CodeLine lineNumber="541"><Highlight kind="normal">  tracePredStateThroughBlocksAndHarden(MF);</Highlight></CodeLine>
<Link id="l00542" /><CodeLine lineNumber="542"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00543" /><CodeLine lineNumber="543"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now rewrite all the uses of the pred state using the SSA updater to insert</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00544" /><CodeLine lineNumber="544"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// PHIs connecting the state between blocks along the CFG edges.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00545" /><CodeLine lineNumber="545"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;CMovI : CMovs)</Highlight></CodeLine>
<Link id="l00546" /><CodeLine lineNumber="546"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a> : CMovI-&gt;operands()) &#123;</Highlight></CodeLine>
<Link id="l00547" /><CodeLine lineNumber="547"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>.isReg() || <a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>.getReg() != PS-&gt;InitialReg)</Highlight></CodeLine>
<Link id="l00548" /><CodeLine lineNumber="548"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00549" /><CodeLine lineNumber="549"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00550" /><CodeLine lineNumber="550"><Highlight kind="normal">      PS-&gt;SSA.RewriteUse(<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>);</Highlight></CodeLine>
<Link id="l00551" /><CodeLine lineNumber="551"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00552" /><CodeLine lineNumber="552"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00553" /><CodeLine lineNumber="553"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Final speculative load hardened function:\\n&quot;</Highlight><Highlight kind="normal">; MF.<a href="/docs/api/classes/llvm/machinefunction/#a3d931af4280c80a837ee409eb85104f7">dump</a>();</Highlight></CodeLine>
<Link id="l00554" /><CodeLine lineNumber="554"><Highlight kind="normal">             <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">; MF.<a href="/docs/api/classes/llvm/machinefunction/#a8efc9cbc802adc2bb2673b4ba6308869">verify</a>(</Highlight><Highlight kind="keyword">this</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00555" /><CodeLine lineNumber="555"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00556" /><CodeLine lineNumber="556"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00557" /><CodeLine lineNumber="557"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00558" /><CodeLine lineNumber="558"><Highlight kind="comment">/// Implements the naive hardening approach of putting an LFENCE after every</Highlight></CodeLine>
<Link id="l00559" /><CodeLine lineNumber="559"><Highlight kind="comment">/// potentially mis-predicted control flow construct.</Highlight></CodeLine>
<Link id="l00560" /><CodeLine lineNumber="560"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00561" /><CodeLine lineNumber="561"><Highlight kind="comment">/// We include this as an alternative mostly for the purpose of comparison. The</Highlight></CodeLine>
<Link id="l00562" /><CodeLine lineNumber="562"><Highlight kind="comment">/// performance impact of this is expected to be extremely severe and not</Highlight></CodeLine>
<Link id="l00563" /><CodeLine lineNumber="563"><Highlight kind="comment">/// practical for any real-world users.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00564" /><CodeLine lineNumber="564"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> X86SpeculativeLoadHardeningPass::hardenEdgesWithLFENCE(</Highlight></CodeLine>
<Link id="l00565" /><CodeLine lineNumber="565"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF) &#123;</Highlight></CodeLine>
<Link id="l00566" /><CodeLine lineNumber="566"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// First, we scan the function looking for blocks that are reached along edges</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00567" /><CodeLine lineNumber="567"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// that we might want to harden.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00568" /><CodeLine lineNumber="568"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallsetvector">SmallSetVector&lt;MachineBasicBlock &#42;, 8&gt;</a> Blocks;</Highlight></CodeLine>
<Link id="l00569" /><CodeLine lineNumber="569"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : MF) &#123;</Highlight></CodeLine>
<Link id="l00570" /><CodeLine lineNumber="570"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If there are no or only one successor, nothing to do here.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00571" /><CodeLine lineNumber="571"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.succ&#95;size() &lt;= 1)</Highlight></CodeLine>
<Link id="l00572" /><CodeLine lineNumber="572"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00573" /><CodeLine lineNumber="573"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00574" /><CodeLine lineNumber="574"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Skip blocks unless their terminators start with a branch. Other</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00575" /><CodeLine lineNumber="575"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// terminators don&#39;t seem interesting for guarding against misspeculation.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00576" /><CodeLine lineNumber="576"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> TermIt = <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.getFirstTerminator();</Highlight></CodeLine>
<Link id="l00577" /><CodeLine lineNumber="577"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (TermIt == <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.end() || !TermIt-&gt;isBranch())</Highlight></CodeLine>
<Link id="l00578" /><CodeLine lineNumber="578"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00579" /><CodeLine lineNumber="579"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00580" /><CodeLine lineNumber="580"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Add all the non-EH-pad succossors to the blocks we want to harden. We</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00581" /><CodeLine lineNumber="581"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// skip EH pads because there isn&#39;t really a condition of interest on</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00582" /><CodeLine lineNumber="582"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// entering.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00583" /><CodeLine lineNumber="583"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;SuccMBB : <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.successors())</Highlight></CodeLine>
<Link id="l00584" /><CodeLine lineNumber="584"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!SuccMBB-&gt;isEHPad())</Highlight></CodeLine>
<Link id="l00585" /><CodeLine lineNumber="585"><Highlight kind="normal">        Blocks.<a href="/docs/api/classes/llvm/setvector/#af34eb71cc483e84d2eca80575cb9ccde">insert</a>(SuccMBB);</Highlight></CodeLine>
<Link id="l00586" /><CodeLine lineNumber="586"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00587" /><CodeLine lineNumber="587"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00588" /><CodeLine lineNumber="588"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : Blocks) &#123;</Highlight></CodeLine>
<Link id="l00589" /><CodeLine lineNumber="589"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> InsertPt = <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>-&gt;SkipPHIsAndLabels(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>-&gt;begin());</Highlight></CodeLine>
<Link id="l00590" /><CodeLine lineNumber="590"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(&#42;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a>(), <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::LFENCE));</Highlight></CodeLine>
<Link id="l00591" /><CodeLine lineNumber="591"><Highlight kind="normal">    ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l00592" /><CodeLine lineNumber="592"><Highlight kind="normal">    ++NumLFENCEsInserted;</Highlight></CodeLine>
<Link id="l00593" /><CodeLine lineNumber="593"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00594" /><CodeLine lineNumber="594"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00595" /><CodeLine lineNumber="595"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00596" /><CodeLine lineNumber="596"><Highlight kind="normal"><a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;X86SpeculativeLoadHardeningPass::BlockCondInfo, 16&gt;</a></Highlight></CodeLine>
<Link id="l00597" /><CodeLine lineNumber="597"><Highlight kind="normal">X86SpeculativeLoadHardeningPass::collectBlockCondInfo(<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF) &#123;</Highlight></CodeLine>
<Link id="l00598" /><CodeLine lineNumber="598"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BlockCondInfo, 16&gt;</a> Infos;</Highlight></CodeLine>
<Link id="l00599" /><CodeLine lineNumber="599"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00600" /><CodeLine lineNumber="600"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Walk the function and build up a summary for each block&#39;s conditions that</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00601" /><CodeLine lineNumber="601"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// we need to trace through.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00602" /><CodeLine lineNumber="602"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : MF) &#123;</Highlight></CodeLine>
<Link id="l00603" /><CodeLine lineNumber="603"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If there are no or only one successor, nothing to do here.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00604" /><CodeLine lineNumber="604"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.succ&#95;size() &lt;= 1)</Highlight></CodeLine>
<Link id="l00605" /><CodeLine lineNumber="605"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00606" /><CodeLine lineNumber="606"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00607" /><CodeLine lineNumber="607"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We want to reliably handle any conditional branch terminators in the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00608" /><CodeLine lineNumber="608"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// MBB, so we manually analyze the branch. We can handle all of the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00609" /><CodeLine lineNumber="609"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// permutations here, including ones that analyze branch cannot.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00610" /><CodeLine lineNumber="610"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00611" /><CodeLine lineNumber="611"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// The approach is to walk backwards across the terminators, resetting at</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00612" /><CodeLine lineNumber="612"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// any unconditional non-indirect branch, and track all conditional edges</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00613" /><CodeLine lineNumber="613"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// to basic blocks as well as the fallthrough or unconditional successor</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00614" /><CodeLine lineNumber="614"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// edge. For each conditional edge, we track the target and the opposite</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00615" /><CodeLine lineNumber="615"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// condition code in order to inject a &quot;no-op&quot; cmov into that successor</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00616" /><CodeLine lineNumber="616"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// that will harden the predicate. For the fallthrough/unconditional</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00617" /><CodeLine lineNumber="617"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// edge, we inject a separate cmov for each conditional branch with</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00618" /><CodeLine lineNumber="618"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// matching condition codes. This effectively implements an &quot;and&quot; of the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00619" /><CodeLine lineNumber="619"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// condition flags, even if there isn&#39;t a single condition flag that would</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00620" /><CodeLine lineNumber="620"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// directly implement that. We don&#39;t bother trying to optimize either of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00621" /><CodeLine lineNumber="621"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// these cases because if such an optimization is possible, LLVM should</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00622" /><CodeLine lineNumber="622"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// have optimized the conditional &#42;branches&#42; in that way already to reduce</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00623" /><CodeLine lineNumber="623"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// instruction count. This late, we simply assume the minimal number of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00624" /><CodeLine lineNumber="624"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// branch instructions is being emitted and use that to guide our cmov</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00625" /><CodeLine lineNumber="625"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// insertion.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00626" /><CodeLine lineNumber="626"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00627" /><CodeLine lineNumber="627"><Highlight kind="normal">    BlockCondInfo <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a> = &#123;&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, &#123;&#125;, </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">&#125;;</Highlight></CodeLine>
<Link id="l00628" /><CodeLine lineNumber="628"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00629" /><CodeLine lineNumber="629"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Now walk backwards through the terminators and build up successors they</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00630" /><CodeLine lineNumber="630"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// reach and the conditions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00631" /><CodeLine lineNumber="631"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> : <a href="/docs/api/namespaces/llvm/#a6b0ac1fa4f05de76413c5e0ca6334035">llvm::reverse</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>)) &#123;</Highlight></CodeLine>
<Link id="l00632" /><CodeLine lineNumber="632"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Once we&#39;ve handled all the terminators, we&#39;re done.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00633" /><CodeLine lineNumber="633"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isTerminator())</Highlight></CodeLine>
<Link id="l00634" /><CodeLine lineNumber="634"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">break</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00635" /><CodeLine lineNumber="635"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00636" /><CodeLine lineNumber="636"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// If we see a non-branch terminator, we can&#39;t handle anything so bail.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00637" /><CodeLine lineNumber="637"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isBranch()) &#123;</Highlight></CodeLine>
<Link id="l00638" /><CodeLine lineNumber="638"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.CondBrs.clear();</Highlight></CodeLine>
<Link id="l00639" /><CodeLine lineNumber="639"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">break</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00640" /><CodeLine lineNumber="640"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00641" /><CodeLine lineNumber="641"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00642" /><CodeLine lineNumber="642"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// If we see an unconditional branch, reset our state, clear any</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00643" /><CodeLine lineNumber="643"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// fallthrough, and set this is the &quot;else&quot; successor.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00644" /><CodeLine lineNumber="644"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOpcode() == X86::JMP&#95;1) &#123;</Highlight></CodeLine>
<Link id="l00645" /><CodeLine lineNumber="645"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.CondBrs.clear();</Highlight></CodeLine>
<Link id="l00646" /><CodeLine lineNumber="646"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.UncondBr = &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>;</Highlight></CodeLine>
<Link id="l00647" /><CodeLine lineNumber="647"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00648" /><CodeLine lineNumber="648"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00649" /><CodeLine lineNumber="649"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00650" /><CodeLine lineNumber="650"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// If we get an invalid condition, we have an indirect branch or some</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00651" /><CodeLine lineNumber="651"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// other unanalyzable &quot;fallthrough&quot; case. We model this as a nullptr for</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00652" /><CodeLine lineNumber="652"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// the destination so we can still guard any conditional successors.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00653" /><CodeLine lineNumber="653"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Consider code sequences like:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00654" /><CodeLine lineNumber="654"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// &#96;&#96;&#96;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00655" /><CodeLine lineNumber="655"><Highlight kind="normal">      </Highlight><Highlight kind="comment">//   jCC L1</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00656" /><CodeLine lineNumber="656"><Highlight kind="normal">      </Highlight><Highlight kind="comment">//   jmpq &#42;%rax</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00657" /><CodeLine lineNumber="657"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// &#96;&#96;&#96;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00658" /><CodeLine lineNumber="658"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We still want to harden the edge to &#96;L1&#96;.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00659" /><CodeLine lineNumber="659"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/x86/#a0f2b2ef8f4560ffd46c7966e8315142f">X86::getCondFromBranch</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) == <a href="/docs/api/namespaces/llvm/x86/#a1a356a51a1fb4cc3c427599082cf1d2eab1840bfcd789713b29a40d9d55cb41e3">X86::COND&#95;INVALID</a>) &#123;</Highlight></CodeLine>
<Link id="l00660" /><CodeLine lineNumber="660"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.CondBrs.clear();</Highlight></CodeLine>
<Link id="l00661" /><CodeLine lineNumber="661"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.UncondBr = &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>;</Highlight></CodeLine>
<Link id="l00662" /><CodeLine lineNumber="662"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00663" /><CodeLine lineNumber="663"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00664" /><CodeLine lineNumber="664"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00665" /><CodeLine lineNumber="665"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We have a vanilla conditional branch, add it to our list.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00666" /><CodeLine lineNumber="666"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.CondBrs.push&#95;back(&amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</Highlight></CodeLine>
<Link id="l00667" /><CodeLine lineNumber="667"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00668" /><CodeLine lineNumber="668"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.CondBrs.empty()) &#123;</Highlight></CodeLine>
<Link id="l00669" /><CodeLine lineNumber="669"><Highlight kind="normal">      ++NumBranchesUntraced;</Highlight></CodeLine>
<Link id="l00670" /><CodeLine lineNumber="670"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;WARNING: unable to secure successors of block:\\n&quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00671" /><CodeLine lineNumber="671"><Highlight kind="normal">                 <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.dump());</Highlight></CodeLine>
<Link id="l00672" /><CodeLine lineNumber="672"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00673" /><CodeLine lineNumber="673"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00674" /><CodeLine lineNumber="674"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00675" /><CodeLine lineNumber="675"><Highlight kind="normal">    Infos.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>);</Highlight></CodeLine>
<Link id="l00676" /><CodeLine lineNumber="676"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00677" /><CodeLine lineNumber="677"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00678" /><CodeLine lineNumber="678"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> Infos;</Highlight></CodeLine>
<Link id="l00679" /><CodeLine lineNumber="679"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00680" /><CodeLine lineNumber="680"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00681" /><CodeLine lineNumber="681"><Highlight kind="comment">/// Trace the predicate state through the CFG, instrumenting each conditional</Highlight></CodeLine>
<Link id="l00682" /><CodeLine lineNumber="682"><Highlight kind="comment">/// branch such that misspeculation through an edge will poison the predicate</Highlight></CodeLine>
<Link id="l00683" /><CodeLine lineNumber="683"><Highlight kind="comment">/// state.</Highlight></CodeLine>
<Link id="l00684" /><CodeLine lineNumber="684"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00685" /><CodeLine lineNumber="685"><Highlight kind="comment">/// Returns the list of inserted CMov instructions so that they can have their</Highlight></CodeLine>
<Link id="l00686" /><CodeLine lineNumber="686"><Highlight kind="comment">/// uses of the predicate state rewritten into proper SSA form once it is</Highlight></CodeLine>
<Link id="l00687" /><CodeLine lineNumber="687"><Highlight kind="comment">/// complete.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00688" /><CodeLine lineNumber="688"><Highlight kind="normal"><a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineInstr &#42;, 16&gt;</a></Highlight></CodeLine>
<Link id="l00689" /><CodeLine lineNumber="689"><Highlight kind="normal">X86SpeculativeLoadHardeningPass::tracePredStateThroughCFG(</Highlight></CodeLine>
<Link id="l00690" /><CodeLine lineNumber="690"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF, <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;BlockCondInfo&gt;</a> Infos) &#123;</Highlight></CodeLine>
<Link id="l00691" /><CodeLine lineNumber="691"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Collect the inserted cmov instructions so we can rewrite their uses of the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00692" /><CodeLine lineNumber="692"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// predicate state into SSA form.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00693" /><CodeLine lineNumber="693"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineInstr &#42;, 16&gt;</a> CMovs;</Highlight></CodeLine>
<Link id="l00694" /><CodeLine lineNumber="694"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00695" /><CodeLine lineNumber="695"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now walk all of the basic blocks looking for ones that end in conditional</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00696" /><CodeLine lineNumber="696"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// jumps where we need to update this register along each edge.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00697" /><CodeLine lineNumber="697"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> BlockCondInfo &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a> : Infos) &#123;</Highlight></CodeLine>
<Link id="l00698" /><CodeLine lineNumber="698"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> = &#42;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.MBB;</Highlight></CodeLine>
<Link id="l00699" /><CodeLine lineNumber="699"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;MachineInstr &#42;&gt;</a> &amp;CondBrs = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.CondBrs;</Highlight></CodeLine>
<Link id="l00700" /><CodeLine lineNumber="700"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;UncondBr = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.UncondBr;</Highlight></CodeLine>
<Link id="l00701" /><CodeLine lineNumber="701"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00702" /><CodeLine lineNumber="702"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Tracing predicate through block: &quot;</Highlight><Highlight kind="normal"> &lt;&lt; <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.getName()</Highlight></CodeLine>
<Link id="l00703" /><CodeLine lineNumber="703"><Highlight kind="normal">                      &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00704" /><CodeLine lineNumber="704"><Highlight kind="normal">    ++NumCondBranchesTraced;</Highlight></CodeLine>
<Link id="l00705" /><CodeLine lineNumber="705"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00706" /><CodeLine lineNumber="706"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Compute the non-conditional successor as either the target of any</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00707" /><CodeLine lineNumber="707"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// unconditional branch or the layout successor.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00708" /><CodeLine lineNumber="708"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;UncondSucc =</Highlight></CodeLine>
<Link id="l00709" /><CodeLine lineNumber="709"><Highlight kind="normal">        UncondBr ? (UncondBr-&gt;<a href="/docs/api/classes/llvm/machineinstr/#a0363204b5fbab08a46f5a7cd7f376f78">getOpcode</a>() == X86::JMP&#95;1</Highlight></CodeLine>
<Link id="l00710" /><CodeLine lineNumber="710"><Highlight kind="normal">                        ? UncondBr-&gt;<a href="/docs/api/classes/llvm/machineinstr/#ad67c9230577a0b640c52852c75c93939">getOperand</a>(0).<a href="/docs/api/classes/llvm/machineoperand/#a57e64b633278df75c699e6b98ce15031">getMBB</a>()</Highlight></CodeLine>
<Link id="l00711" /><CodeLine lineNumber="711"><Highlight kind="normal">                        : </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">)</Highlight></CodeLine>
<Link id="l00712" /><CodeLine lineNumber="712"><Highlight kind="normal">                 : &amp;&#42;<a href="/docs/api/namespaces/std">std</a>::next(<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a>::<a href="/docs/api/classes/llvm/iplist">iterator</a>(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>));</Highlight></CodeLine>
<Link id="l00713" /><CodeLine lineNumber="713"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00714" /><CodeLine lineNumber="714"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Count how many edges there are to any given successor.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00715" /><CodeLine lineNumber="715"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;MachineBasicBlock &#42;, int&gt;</a> SuccCounts;</Highlight></CodeLine>
<Link id="l00716" /><CodeLine lineNumber="716"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UncondSucc)</Highlight></CodeLine>
<Link id="l00717" /><CodeLine lineNumber="717"><Highlight kind="normal">      ++SuccCounts&#91;UncondSucc&#93;;</Highlight></CodeLine>
<Link id="l00718" /><CodeLine lineNumber="718"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;CondBr : CondBrs)</Highlight></CodeLine>
<Link id="l00719" /><CodeLine lineNumber="719"><Highlight kind="normal">      ++SuccCounts&#91;CondBr-&gt;getOperand(0).getMBB()&#93;;</Highlight></CodeLine>
<Link id="l00720" /><CodeLine lineNumber="720"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00721" /><CodeLine lineNumber="721"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// A lambda to insert cmov instructions into a block checking all of the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00722" /><CodeLine lineNumber="722"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// condition codes in a sequence.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00723" /><CodeLine lineNumber="723"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> BuildCheckingBlockForSuccAndConds =</Highlight></CodeLine>
<Link id="l00724" /><CodeLine lineNumber="724"><Highlight kind="normal">        &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;Succ, </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> SuccCount,</Highlight></CodeLine>
<Link id="l00725" /><CodeLine lineNumber="725"><Highlight kind="normal">            <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;Br, <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;&amp;UncondBr,</Highlight></CodeLine>
<Link id="l00726" /><CodeLine lineNumber="726"><Highlight kind="normal">            <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;X86::CondCode&gt;</a> Conds) &#123;</Highlight></CodeLine>
<Link id="l00727" /><CodeLine lineNumber="727"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// First, we split the edge to insert the checking block into a safe</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00728" /><CodeLine lineNumber="728"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// location.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00729" /><CodeLine lineNumber="729"><Highlight kind="normal">          auto &amp;CheckingMBB =</Highlight></CodeLine>
<Link id="l00730" /><CodeLine lineNumber="730"><Highlight kind="normal">              (SuccCount == 1 &amp;&amp; Succ.pred&#95;size() == 1)</Highlight></CodeLine>
<Link id="l00731" /><CodeLine lineNumber="731"><Highlight kind="normal">                  ? Succ</Highlight></CodeLine>
<Link id="l00732" /><CodeLine lineNumber="732"><Highlight kind="normal">                  : splitEdge(MBB, Succ, SuccCount, Br, UncondBr, &#42;TII);</Highlight></CodeLine>
<Link id="l00733" /><CodeLine lineNumber="733"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00734" /><CodeLine lineNumber="734"><Highlight kind="normal">          bool LiveEFLAGS = Succ.isLiveIn(X86::EFLAGS);</Highlight></CodeLine>
<Link id="l00735" /><CodeLine lineNumber="735"><Highlight kind="normal">          if (!LiveEFLAGS)</Highlight></CodeLine>
<Link id="l00736" /><CodeLine lineNumber="736"><Highlight kind="normal">            CheckingMBB.addLiveIn(X86::EFLAGS);</Highlight></CodeLine>
<Link id="l00737" /><CodeLine lineNumber="737"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00738" /><CodeLine lineNumber="738"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// Now insert the cmovs to implement the checks.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00739" /><CodeLine lineNumber="739"><Highlight kind="normal">          auto InsertPt = CheckingMBB.begin();</Highlight></CodeLine>
<Link id="l00740" /><CodeLine lineNumber="740"><Highlight kind="normal">          assert((InsertPt == CheckingMBB.end() || !InsertPt-&gt;isPHI()) &amp;&amp;</Highlight></CodeLine>
<Link id="l00741" /><CodeLine lineNumber="741"><Highlight kind="normal">                 </Highlight><Highlight kind="stringliteral">&quot;Should never have a PHI in the initial checking block as it &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00742" /><CodeLine lineNumber="742"><Highlight kind="normal">                 </Highlight><Highlight kind="stringliteral">&quot;always has a single predecessor!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00743" /><CodeLine lineNumber="743"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00744" /><CodeLine lineNumber="744"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// We will wire each cmov to each other, but need to start with the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00745" /><CodeLine lineNumber="745"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// incoming pred state.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00746" /><CodeLine lineNumber="746"><Highlight kind="normal">          unsigned CurStateReg = PS-&gt;InitialReg;</Highlight></CodeLine>
<Link id="l00747" /><CodeLine lineNumber="747"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00748" /><CodeLine lineNumber="748"><Highlight kind="normal">          for (X86::CondCode Cond : Conds) &#123;</Highlight></CodeLine>
<Link id="l00749" /><CodeLine lineNumber="749"><Highlight kind="normal">            int PredStateSizeInBytes = TRI-&gt;getRegSizeInBits(&#42;PS-&gt;RC) / 8;</Highlight></CodeLine>
<Link id="l00750" /><CodeLine lineNumber="750"><Highlight kind="normal">            auto CMovOp = X86::getCMovOpcode(PredStateSizeInBytes);</Highlight></CodeLine>
<Link id="l00751" /><CodeLine lineNumber="751"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00752" /><CodeLine lineNumber="752"><Highlight kind="normal">            Register UpdatedStateReg = MRI-&gt;createVirtualRegister(PS-&gt;RC);</Highlight></CodeLine>
<Link id="l00753" /><CodeLine lineNumber="753"><Highlight kind="normal">            </Highlight><Highlight kind="comment">// Note that we intentionally use an empty debug location so that</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00754" /><CodeLine lineNumber="754"><Highlight kind="normal">            </Highlight><Highlight kind="comment">// this picks up the preceding location.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00755" /><CodeLine lineNumber="755"><Highlight kind="normal">            auto CMovI = BuildMI(CheckingMBB, InsertPt, DebugLoc(),</Highlight></CodeLine>
<Link id="l00756" /><CodeLine lineNumber="756"><Highlight kind="normal">                                 TII-&gt;get(CMovOp), UpdatedStateReg)</Highlight></CodeLine>
<Link id="l00757" /><CodeLine lineNumber="757"><Highlight kind="normal">                             .addReg(CurStateReg)</Highlight></CodeLine>
<Link id="l00758" /><CodeLine lineNumber="758"><Highlight kind="normal">                             .addReg(PS-&gt;PoisonReg)</Highlight></CodeLine>
<Link id="l00759" /><CodeLine lineNumber="759"><Highlight kind="normal">                             .addImm(Cond);</Highlight></CodeLine>
<Link id="l00760" /><CodeLine lineNumber="760"><Highlight kind="normal">            </Highlight><Highlight kind="comment">// If this is the last cmov and the EFLAGS weren&#39;t originally</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00761" /><CodeLine lineNumber="761"><Highlight kind="normal">            </Highlight><Highlight kind="comment">// live-in, mark them as killed.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00762" /><CodeLine lineNumber="762"><Highlight kind="normal">            if (!LiveEFLAGS &amp;&amp; Cond == Conds.back())</Highlight></CodeLine>
<Link id="l00763" /><CodeLine lineNumber="763"><Highlight kind="normal">              CMovI-&gt;findRegisterUseOperand(X86::EFLAGS, </Highlight><Highlight kind="comment">/&#42;TRI=&#42;/</Highlight><Highlight kind="normal">nullptr)</Highlight></CodeLine>
<Link id="l00764" /><CodeLine lineNumber="764"><Highlight kind="normal">                  -&gt;setIsKill(true);</Highlight></CodeLine>
<Link id="l00765" /><CodeLine lineNumber="765"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00766" /><CodeLine lineNumber="766"><Highlight kind="normal">            ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l00767" /><CodeLine lineNumber="767"><Highlight kind="normal">            LLVM&#95;DEBUG(dbgs() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Inserting cmov: &quot;</Highlight><Highlight kind="normal">; CMovI-&gt;dump();</Highlight></CodeLine>
<Link id="l00768" /><CodeLine lineNumber="768"><Highlight kind="normal">                       dbgs() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00769" /><CodeLine lineNumber="769"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00770" /><CodeLine lineNumber="770"><Highlight kind="normal">            </Highlight><Highlight kind="comment">// The first one of the cmovs will be using the top level</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00771" /><CodeLine lineNumber="771"><Highlight kind="normal">            </Highlight><Highlight kind="comment">// &#96;PredStateReg&#96; and need to get rewritten into SSA form.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00772" /><CodeLine lineNumber="772"><Highlight kind="normal">            if (CurStateReg == PS-&gt;InitialReg)</Highlight></CodeLine>
<Link id="l00773" /><CodeLine lineNumber="773"><Highlight kind="normal">              CMovs.push&#95;back(&amp;&#42;CMovI);</Highlight></CodeLine>
<Link id="l00774" /><CodeLine lineNumber="774"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00775" /><CodeLine lineNumber="775"><Highlight kind="normal">            </Highlight><Highlight kind="comment">// The next cmov should start from this one&#39;s def.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00776" /><CodeLine lineNumber="776"><Highlight kind="normal">            CurStateReg = UpdatedStateReg;</Highlight></CodeLine>
<Link id="l00777" /><CodeLine lineNumber="777"><Highlight kind="normal">          &#125;</Highlight></CodeLine>
<Link id="l00778" /><CodeLine lineNumber="778"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00779" /><CodeLine lineNumber="779"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// And put the last one into the available values for SSA form of our</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00780" /><CodeLine lineNumber="780"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// predicate state.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00781" /><CodeLine lineNumber="781"><Highlight kind="normal">          PS-&gt;SSA.AddAvailableValue(&amp;CheckingMBB, CurStateReg);</Highlight></CodeLine>
<Link id="l00782" /><CodeLine lineNumber="782"><Highlight kind="normal">        &#125;;</Highlight></CodeLine>
<Link id="l00783" /><CodeLine lineNumber="783"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00784" /><CodeLine lineNumber="784"><Highlight kind="normal">    std::vector&lt;X86::CondCode&gt; UncondCodeSeq;</Highlight></CodeLine>
<Link id="l00785" /><CodeLine lineNumber="785"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;CondBr : CondBrs) &#123;</Highlight></CodeLine>
<Link id="l00786" /><CodeLine lineNumber="786"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;Succ = &#42;CondBr-&gt;getOperand(0).getMBB();</Highlight></CodeLine>
<Link id="l00787" /><CodeLine lineNumber="787"><Highlight kind="normal">      </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> &amp;SuccCount = SuccCounts&#91;&amp;Succ&#93;;</Highlight></CodeLine>
<Link id="l00788" /><CodeLine lineNumber="788"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00789" /><CodeLine lineNumber="789"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/x86/#a1a356a51a1fb4cc3c427599082cf1d2e">X86::CondCode</a> <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a> = <a href="/docs/api/namespaces/llvm/x86/#a0f2b2ef8f4560ffd46c7966e8315142f">X86::getCondFromBranch</a>(&#42;CondBr);</Highlight></CodeLine>
<Link id="l00790" /><CodeLine lineNumber="790"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/x86/#a1a356a51a1fb4cc3c427599082cf1d2e">X86::CondCode</a> InvCond = <a href="/docs/api/namespaces/llvm/x86/#a5c06f5a972e8a78052103840a8c98a3f">X86::GetOppositeBranchCondition</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>);</Highlight></CodeLine>
<Link id="l00791" /><CodeLine lineNumber="791"><Highlight kind="normal">      UncondCodeSeq.push&#95;back(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>);</Highlight></CodeLine>
<Link id="l00792" /><CodeLine lineNumber="792"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00793" /><CodeLine lineNumber="793"><Highlight kind="normal">      BuildCheckingBlockForSuccAndConds(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, Succ, SuccCount, CondBr, UncondBr,</Highlight></CodeLine>
<Link id="l00794" /><CodeLine lineNumber="794"><Highlight kind="normal">                                        &#123;InvCond&#125;);</Highlight></CodeLine>
<Link id="l00795" /><CodeLine lineNumber="795"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00796" /><CodeLine lineNumber="796"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Decrement the successor count now that we&#39;ve split one of the edges.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00797" /><CodeLine lineNumber="797"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We need to keep the count of edges to the successor accurate in order</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00798" /><CodeLine lineNumber="798"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// to know above when to &#42;replace&#42; the successor in the CFG vs. just</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00799" /><CodeLine lineNumber="799"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// adding the new successor.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00800" /><CodeLine lineNumber="800"><Highlight kind="normal">      --SuccCount;</Highlight></CodeLine>
<Link id="l00801" /><CodeLine lineNumber="801"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00802" /><CodeLine lineNumber="802"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00803" /><CodeLine lineNumber="803"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Since we may have split edges and changed the number of successors,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00804" /><CodeLine lineNumber="804"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// normalize the probabilities. This avoids doing it each time we split an</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00805" /><CodeLine lineNumber="805"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// edge.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00806" /><CodeLine lineNumber="806"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.normalizeSuccProbs();</Highlight></CodeLine>
<Link id="l00807" /><CodeLine lineNumber="807"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00808" /><CodeLine lineNumber="808"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Finally, we need to insert cmovs into the &quot;fallthrough&quot; edge. Here, we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00809" /><CodeLine lineNumber="809"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// need to intersect the other condition codes. We can do this by just</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00810" /><CodeLine lineNumber="810"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// doing a cmov for each one.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00811" /><CodeLine lineNumber="811"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!UncondSucc)</Highlight></CodeLine>
<Link id="l00812" /><CodeLine lineNumber="812"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// If we have no fallthrough to protect (perhaps it is an indirect jump?)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00813" /><CodeLine lineNumber="813"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// just skip this and continue.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00814" /><CodeLine lineNumber="814"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00815" /><CodeLine lineNumber="815"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00816" /><CodeLine lineNumber="816"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(SuccCounts&#91;UncondSucc&#93; == 1 &amp;&amp;</Highlight></CodeLine>
<Link id="l00817" /><CodeLine lineNumber="817"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;We should never have more than one edge to the unconditional &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00818" /><CodeLine lineNumber="818"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;successor at this point because every other edge must have been &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00819" /><CodeLine lineNumber="819"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;split above!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00820" /><CodeLine lineNumber="820"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00821" /><CodeLine lineNumber="821"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Sort and unique the codes to minimize them.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00822" /><CodeLine lineNumber="822"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a74cdbd1e4f731e7d7cd83461b8b1de0b">llvm::sort</a>(UncondCodeSeq);</Highlight></CodeLine>
<Link id="l00823" /><CodeLine lineNumber="823"><Highlight kind="normal">    UncondCodeSeq.erase(<a href="/docs/api/namespaces/llvm/#a48f85da577c6ce7d9aed90437dc0d07c">llvm::unique</a>(UncondCodeSeq), UncondCodeSeq.end());</Highlight></CodeLine>
<Link id="l00824" /><CodeLine lineNumber="824"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00825" /><CodeLine lineNumber="825"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Build a checking version of the successor.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00826" /><CodeLine lineNumber="826"><Highlight kind="normal">    BuildCheckingBlockForSuccAndConds(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, &#42;UncondSucc, </Highlight><Highlight kind="comment">/&#42;SuccCount&#42;/</Highlight><Highlight kind="normal"> 1,</Highlight></CodeLine>
<Link id="l00827" /><CodeLine lineNumber="827"><Highlight kind="normal">                                      UncondBr, UncondBr, UncondCodeSeq);</Highlight></CodeLine>
<Link id="l00828" /><CodeLine lineNumber="828"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00829" /><CodeLine lineNumber="829"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00830" /><CodeLine lineNumber="830"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> CMovs;</Highlight></CodeLine>
<Link id="l00831" /><CodeLine lineNumber="831"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00832" /><CodeLine lineNumber="832"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00833" /><CodeLine lineNumber="833"><Highlight kind="comment">/// Compute the register class for the unfolded load.</Highlight></CodeLine>
<Link id="l00834" /><CodeLine lineNumber="834"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00835" /><CodeLine lineNumber="835"><Highlight kind="comment">/// FIXME: This should probably live in X86InstrInfo, potentially by adding</Highlight></CodeLine>
<Link id="l00836" /><CodeLine lineNumber="836"><Highlight kind="comment">/// a way to unfold into a newly created vreg rather than requiring a register</Highlight></CodeLine>
<Link id="l00837" /><CodeLine lineNumber="837"><Highlight kind="comment">/// input.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00838" /><CodeLine lineNumber="838"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/targetregisterclass">TargetRegisterClass</a> &#42;</Highlight></CodeLine>
<Link id="l00839" /><CodeLine lineNumber="839" lineLink="#aa521cd293ac8410168730efe322dce5c"><Highlight kind="normal"><a href="#aa521cd293ac8410168730efe322dce5c">getRegClassForUnfoldedLoad</a>(<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/x86instrinfo">X86InstrInfo</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>,</Highlight></CodeLine>
<Link id="l00840" /><CodeLine lineNumber="840"><Highlight kind="normal">                           </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> Opcode) &#123;</Highlight></CodeLine>
<Link id="l00841" /><CodeLine lineNumber="841"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> Index;</Highlight></CodeLine>
<Link id="l00842" /><CodeLine lineNumber="842"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> UnfoldedOpc = <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>.getOpcodeAfterMemoryUnfold(</Highlight></CodeLine>
<Link id="l00843" /><CodeLine lineNumber="843"><Highlight kind="normal">      Opcode, </Highlight><Highlight kind="comment">/&#42;UnfoldLoad&#42;/</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">, </Highlight><Highlight kind="comment">/&#42;UnfoldStore&#42;/</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">, &amp;Index);</Highlight></CodeLine>
<Link id="l00844" /><CodeLine lineNumber="844"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/mcinstrdesc">MCInstrDesc</a> &amp;<a href="/docs/api/namespaces/llvm/mcid">MCID</a> = <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>.get(UnfoldedOpc);</Highlight></CodeLine>
<Link id="l00845" /><CodeLine lineNumber="845"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>.getRegClass(<a href="/docs/api/namespaces/llvm/mcid">MCID</a>, Index, &amp;<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>.getRegisterInfo(), MF);</Highlight></CodeLine>
<Link id="l00846" /><CodeLine lineNumber="846"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00847" /><CodeLine lineNumber="847"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00848" /><CodeLine lineNumber="848"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> X86SpeculativeLoadHardeningPass::unfoldCallAndJumpLoads(</Highlight></CodeLine>
<Link id="l00849" /><CodeLine lineNumber="849"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF) &#123;</Highlight></CodeLine>
<Link id="l00850" /><CodeLine lineNumber="850"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : MF)</Highlight></CodeLine>
<Link id="l00851" /><CodeLine lineNumber="851"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We use make&#95;early&#95;inc&#95;range here so we can remove instructions if needed</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00852" /><CodeLine lineNumber="852"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// without disturbing the iteration.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00853" /><CodeLine lineNumber="853"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> : <a href="/docs/api/namespaces/llvm/#a3d2cdc4a0db233678e7141c9d6ea3419">llvm::make&#95;early&#95;inc&#95;range</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.instrs())) &#123;</Highlight></CodeLine>
<Link id="l00854" /><CodeLine lineNumber="854"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Must either be a call or a branch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00855" /><CodeLine lineNumber="855"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isCall() &amp;&amp; !<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isBranch())</Highlight></CodeLine>
<Link id="l00856" /><CodeLine lineNumber="856"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00857" /><CodeLine lineNumber="857"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We only care about loading variants of these instructions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00858" /><CodeLine lineNumber="858"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.mayLoad())</Highlight></CodeLine>
<Link id="l00859" /><CodeLine lineNumber="859"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00860" /><CodeLine lineNumber="860"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00861" /><CodeLine lineNumber="861"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">switch</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOpcode()) &#123;</Highlight></CodeLine>
<Link id="l00862" /><CodeLine lineNumber="862"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">default</Highlight><Highlight kind="normal">: &#123;</Highlight></CodeLine>
<Link id="l00863" /><CodeLine lineNumber="863"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(</Highlight></CodeLine>
<Link id="l00864" /><CodeLine lineNumber="864"><Highlight kind="normal">            <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;ERROR: Found an unexpected loading branch or call &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00865" /><CodeLine lineNumber="865"><Highlight kind="normal">                      </Highlight><Highlight kind="stringliteral">&quot;instruction:\\n&quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00866" /><CodeLine lineNumber="866"><Highlight kind="normal">            <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00867" /><CodeLine lineNumber="867"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(</Highlight><Highlight kind="stringliteral">&quot;Unexpected loading branch or call!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00868" /><CodeLine lineNumber="868"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00869" /><CodeLine lineNumber="869"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00870" /><CodeLine lineNumber="870"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::FARCALL16m:</Highlight></CodeLine>
<Link id="l00871" /><CodeLine lineNumber="871"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::FARCALL32m:</Highlight></CodeLine>
<Link id="l00872" /><CodeLine lineNumber="872"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::FARCALL64m:</Highlight></CodeLine>
<Link id="l00873" /><CodeLine lineNumber="873"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::FARJMP16m:</Highlight></CodeLine>
<Link id="l00874" /><CodeLine lineNumber="874"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::FARJMP32m:</Highlight></CodeLine>
<Link id="l00875" /><CodeLine lineNumber="875"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::FARJMP64m:</Highlight></CodeLine>
<Link id="l00876" /><CodeLine lineNumber="876"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// We cannot mitigate far jumps or calls, but we also don&#39;t expect them</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00877" /><CodeLine lineNumber="877"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// to be vulnerable to Spectre v1.2 style attacks.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00878" /><CodeLine lineNumber="878"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00879" /><CodeLine lineNumber="879"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00880" /><CodeLine lineNumber="880"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::CALL16m:</Highlight></CodeLine>
<Link id="l00881" /><CodeLine lineNumber="881"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::CALL16m&#95;NT:</Highlight></CodeLine>
<Link id="l00882" /><CodeLine lineNumber="882"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::CALL32m:</Highlight></CodeLine>
<Link id="l00883" /><CodeLine lineNumber="883"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::CALL32m&#95;NT:</Highlight></CodeLine>
<Link id="l00884" /><CodeLine lineNumber="884"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::CALL64m:</Highlight></CodeLine>
<Link id="l00885" /><CodeLine lineNumber="885"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::CALL64m&#95;NT:</Highlight></CodeLine>
<Link id="l00886" /><CodeLine lineNumber="886"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::JMP16m:</Highlight></CodeLine>
<Link id="l00887" /><CodeLine lineNumber="887"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::JMP16m&#95;NT:</Highlight></CodeLine>
<Link id="l00888" /><CodeLine lineNumber="888"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::JMP32m:</Highlight></CodeLine>
<Link id="l00889" /><CodeLine lineNumber="889"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::JMP32m&#95;NT:</Highlight></CodeLine>
<Link id="l00890" /><CodeLine lineNumber="890"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::JMP64m:</Highlight></CodeLine>
<Link id="l00891" /><CodeLine lineNumber="891"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::JMP64m&#95;NT:</Highlight></CodeLine>
<Link id="l00892" /><CodeLine lineNumber="892"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::TAILJMPm64:</Highlight></CodeLine>
<Link id="l00893" /><CodeLine lineNumber="893"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::TAILJMPm64&#95;REX:</Highlight></CodeLine>
<Link id="l00894" /><CodeLine lineNumber="894"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::TAILJMPm:</Highlight></CodeLine>
<Link id="l00895" /><CodeLine lineNumber="895"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::TCRETURNmi64:</Highlight></CodeLine>
<Link id="l00896" /><CodeLine lineNumber="896"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::TCRETURNmi: &#123;</Highlight></CodeLine>
<Link id="l00897" /><CodeLine lineNumber="897"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Use the generic unfold logic now that we know we&#39;re dealing with</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00898" /><CodeLine lineNumber="898"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// expected instructions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00899" /><CodeLine lineNumber="899"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// FIXME: We don&#39;t have test coverage for all of these!</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00900" /><CodeLine lineNumber="900"><Highlight kind="normal">        </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;UnfoldedRC = <a href="#aa521cd293ac8410168730efe322dce5c">getRegClassForUnfoldedLoad</a>(MF, &#42;<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>, <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOpcode());</Highlight></CodeLine>
<Link id="l00901" /><CodeLine lineNumber="901"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!UnfoldedRC) &#123;</Highlight></CodeLine>
<Link id="l00902" /><CodeLine lineNumber="902"><Highlight kind="normal">          <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>()</Highlight></CodeLine>
<Link id="l00903" /><CodeLine lineNumber="903"><Highlight kind="normal">                         &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;ERROR: Unable to unfold load from instruction:\\n&quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00904" /><CodeLine lineNumber="904"><Highlight kind="normal">                     <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00905" /><CodeLine lineNumber="905"><Highlight kind="normal">          <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(</Highlight><Highlight kind="stringliteral">&quot;Unable to unfold load!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00906" /><CodeLine lineNumber="906"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l00907" /><CodeLine lineNumber="907"><Highlight kind="normal">        <a href="/docs/api/classes/llvm/register">Register</a> <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a> = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(UnfoldedRC);</Highlight></CodeLine>
<Link id="l00908" /><CodeLine lineNumber="908"><Highlight kind="normal">        <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineInstr &#42;, 2&gt;</a> NewMIs;</Highlight></CodeLine>
<Link id="l00909" /><CodeLine lineNumber="909"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// If we were able to compute an unfolded reg class, any failure here</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00910" /><CodeLine lineNumber="910"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// is just a programming error so just assert.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00911" /><CodeLine lineNumber="911"><Highlight kind="normal">        </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> Unfolded =</Highlight></CodeLine>
<Link id="l00912" /><CodeLine lineNumber="912"><Highlight kind="normal">            <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;unfoldMemoryOperand(MF, <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>, <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>, </Highlight><Highlight kind="comment">/&#42;UnfoldLoad&#42;/</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l00913" /><CodeLine lineNumber="913"><Highlight kind="normal">                                     </Highlight><Highlight kind="comment">/&#42;UnfoldStore&#42;/</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">, NewMIs);</Highlight></CodeLine>
<Link id="l00914" /><CodeLine lineNumber="914"><Highlight kind="normal">        (void)Unfolded;</Highlight></CodeLine>
<Link id="l00915" /><CodeLine lineNumber="915"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Unfolded &amp;&amp;</Highlight></CodeLine>
<Link id="l00916" /><CodeLine lineNumber="916"><Highlight kind="normal">               </Highlight><Highlight kind="stringliteral">&quot;Computed unfolded register class but failed to unfold&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00917" /><CodeLine lineNumber="917"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Now stitch the new instructions into place and erase the old one.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00918" /><CodeLine lineNumber="918"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;NewMI : NewMIs)</Highlight></CodeLine>
<Link id="l00919" /><CodeLine lineNumber="919"><Highlight kind="normal">          <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.insert(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getIterator(), NewMI);</Highlight></CodeLine>
<Link id="l00920" /><CodeLine lineNumber="920"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00921" /><CodeLine lineNumber="921"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Update the call info.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00922" /><CodeLine lineNumber="922"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isCandidateForAdditionalCallInfo())</Highlight></CodeLine>
<Link id="l00923" /><CodeLine lineNumber="923"><Highlight kind="normal">          MF.eraseAdditionalCallInfo(&amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</Highlight></CodeLine>
<Link id="l00924" /><CodeLine lineNumber="924"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00925" /><CodeLine lineNumber="925"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.eraseFromParent();</Highlight></CodeLine>
<Link id="l00926" /><CodeLine lineNumber="926"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(&#123;</Highlight></CodeLine>
<Link id="l00927" /><CodeLine lineNumber="927"><Highlight kind="normal">          <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Unfolded load successfully into:\\n&quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00928" /><CodeLine lineNumber="928"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;NewMI : NewMIs) &#123;</Highlight></CodeLine>
<Link id="l00929" /><CodeLine lineNumber="929"><Highlight kind="normal">            NewMI-&gt;dump();</Highlight></CodeLine>
<Link id="l00930" /><CodeLine lineNumber="930"><Highlight kind="normal">            <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00931" /><CodeLine lineNumber="931"><Highlight kind="normal">          &#125;</Highlight></CodeLine>
<Link id="l00932" /><CodeLine lineNumber="932"><Highlight kind="normal">        &#125;);</Highlight></CodeLine>
<Link id="l00933" /><CodeLine lineNumber="933"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00934" /><CodeLine lineNumber="934"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00935" /><CodeLine lineNumber="935"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00936" /><CodeLine lineNumber="936"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/errorhandling-h/#ace243f5c25697a1107cce46626b3dc94">llvm&#95;unreachable</a>(</Highlight><Highlight kind="stringliteral">&quot;Escaped switch with default!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00937" /><CodeLine lineNumber="937"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00938" /><CodeLine lineNumber="938"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00939" /><CodeLine lineNumber="939"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00940" /><CodeLine lineNumber="940"><Highlight kind="comment">/// Trace the predicate state through indirect branches, instrumenting them to</Highlight></CodeLine>
<Link id="l00941" /><CodeLine lineNumber="941"><Highlight kind="comment">/// poison the state if a target is reached that does not match the expected</Highlight></CodeLine>
<Link id="l00942" /><CodeLine lineNumber="942"><Highlight kind="comment">/// target.</Highlight></CodeLine>
<Link id="l00943" /><CodeLine lineNumber="943"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00944" /><CodeLine lineNumber="944"><Highlight kind="comment">/// This is designed to mitigate Spectre variant 1 attacks where an indirect</Highlight></CodeLine>
<Link id="l00945" /><CodeLine lineNumber="945"><Highlight kind="comment">/// branch is trained to predict a particular target and then mispredicts that</Highlight></CodeLine>
<Link id="l00946" /><CodeLine lineNumber="946"><Highlight kind="comment">/// target in a way that can leak data. Despite using an indirect branch, this</Highlight></CodeLine>
<Link id="l00947" /><CodeLine lineNumber="947"><Highlight kind="comment">/// is really a variant 1 style attack: it does not steer execution to an</Highlight></CodeLine>
<Link id="l00948" /><CodeLine lineNumber="948"><Highlight kind="comment">/// arbitrary or attacker controlled address, and it does not require any</Highlight></CodeLine>
<Link id="l00949" /><CodeLine lineNumber="949"><Highlight kind="comment">/// special code executing next to the victim. This attack can also be mitigated</Highlight></CodeLine>
<Link id="l00950" /><CodeLine lineNumber="950"><Highlight kind="comment">/// through retpolines, but those require either replacing indirect branches</Highlight></CodeLine>
<Link id="l00951" /><CodeLine lineNumber="951"><Highlight kind="comment">/// with conditional direct branches or lowering them through a device that</Highlight></CodeLine>
<Link id="l00952" /><CodeLine lineNumber="952"><Highlight kind="comment">/// blocks speculation. This mitigation can replace these retpoline-style</Highlight></CodeLine>
<Link id="l00953" /><CodeLine lineNumber="953"><Highlight kind="comment">/// mitigations for jump tables and other indirect branches within a function</Highlight></CodeLine>
<Link id="l00954" /><CodeLine lineNumber="954"><Highlight kind="comment">/// when variant 2 isn&#39;t a risk while allowing limited speculation. Indirect</Highlight></CodeLine>
<Link id="l00955" /><CodeLine lineNumber="955"><Highlight kind="comment">/// calls, however, cannot be mitigated through this technique without changing</Highlight></CodeLine>
<Link id="l00956" /><CodeLine lineNumber="956"><Highlight kind="comment">/// the ABI in a fundamental way.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00957" /><CodeLine lineNumber="957"><Highlight kind="normal"><a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineInstr &#42;, 16&gt;</a></Highlight></CodeLine>
<Link id="l00958" /><CodeLine lineNumber="958"><Highlight kind="normal">X86SpeculativeLoadHardeningPass::tracePredStateThroughIndirectBranches(</Highlight></CodeLine>
<Link id="l00959" /><CodeLine lineNumber="959"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF) &#123;</Highlight></CodeLine>
<Link id="l00960" /><CodeLine lineNumber="960"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We use the SSAUpdater to insert PHI nodes for the target addresses of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00961" /><CodeLine lineNumber="961"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// indirect branches. We don&#39;t actually need the full power of the SSA updater</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00962" /><CodeLine lineNumber="962"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// in this particular case as we always have immediately available values, but</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00963" /><CodeLine lineNumber="963"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// this avoids us having to re-implement the PHI construction logic.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00964" /><CodeLine lineNumber="964"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/machinessaupdater">MachineSSAUpdater</a> TargetAddrSSA(MF);</Highlight></CodeLine>
<Link id="l00965" /><CodeLine lineNumber="965"><Highlight kind="normal">  TargetAddrSSA.Initialize(<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(&amp;X86::GR64RegClass));</Highlight></CodeLine>
<Link id="l00966" /><CodeLine lineNumber="966"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00967" /><CodeLine lineNumber="967"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Track which blocks were terminated with an indirect branch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00968" /><CodeLine lineNumber="968"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;MachineBasicBlock &#42;, 4&gt;</a> IndirectTerminatedMBBs;</Highlight></CodeLine>
<Link id="l00969" /><CodeLine lineNumber="969"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00970" /><CodeLine lineNumber="970"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We need to know what blocks end up reached via indirect branches. We</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00971" /><CodeLine lineNumber="971"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// expect this to be a subset of those whose address is taken and so track it</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00972" /><CodeLine lineNumber="972"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// directly via the CFG.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00973" /><CodeLine lineNumber="973"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;MachineBasicBlock &#42;, 4&gt;</a> IndirectTargetMBBs;</Highlight></CodeLine>
<Link id="l00974" /><CodeLine lineNumber="974"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00975" /><CodeLine lineNumber="975"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Walk all the blocks which end in an indirect branch and make the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00976" /><CodeLine lineNumber="976"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// target address available.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00977" /><CodeLine lineNumber="977"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : MF) &#123;</Highlight></CodeLine>
<Link id="l00978" /><CodeLine lineNumber="978"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Find the last terminator.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00979" /><CodeLine lineNumber="979"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> MII = <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.instr&#95;rbegin();</Highlight></CodeLine>
<Link id="l00980" /><CodeLine lineNumber="980"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (MII != <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.instr&#95;rend() &amp;&amp; MII-&gt;isDebugInstr())</Highlight></CodeLine>
<Link id="l00981" /><CodeLine lineNumber="981"><Highlight kind="normal">      ++MII;</Highlight></CodeLine>
<Link id="l00982" /><CodeLine lineNumber="982"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MII == <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.instr&#95;rend())</Highlight></CodeLine>
<Link id="l00983" /><CodeLine lineNumber="983"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00984" /><CodeLine lineNumber="984"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;TI = &#42;MII;</Highlight></CodeLine>
<Link id="l00985" /><CodeLine lineNumber="985"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!TI.<a href="/docs/api/classes/llvm/machineinstr/#a0e85c20fe804527f12c86db38ec947ea">isTerminator</a>() || !TI.<a href="/docs/api/classes/llvm/machineinstr/#a5891cdb51072f67e65f7ebd9be1205e7">isBranch</a>())</Highlight></CodeLine>
<Link id="l00986" /><CodeLine lineNumber="986"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// No terminator or non-branch terminator.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00987" /><CodeLine lineNumber="987"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00988" /><CodeLine lineNumber="988"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00989" /><CodeLine lineNumber="989"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> TargetReg;</Highlight></CodeLine>
<Link id="l00990" /><CodeLine lineNumber="990"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00991" /><CodeLine lineNumber="991"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">switch</Highlight><Highlight kind="normal"> (TI.<a href="/docs/api/classes/llvm/machineinstr/#a0363204b5fbab08a46f5a7cd7f376f78">getOpcode</a>()) &#123;</Highlight></CodeLine>
<Link id="l00992" /><CodeLine lineNumber="992"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">default</Highlight><Highlight kind="normal">:</Highlight></CodeLine>
<Link id="l00993" /><CodeLine lineNumber="993"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Direct branch or conditional branch (leading to fallthrough).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00994" /><CodeLine lineNumber="994"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00995" /><CodeLine lineNumber="995"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00996" /><CodeLine lineNumber="996"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::FARJMP16m:</Highlight></CodeLine>
<Link id="l00997" /><CodeLine lineNumber="997"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::FARJMP32m:</Highlight></CodeLine>
<Link id="l00998" /><CodeLine lineNumber="998"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::FARJMP64m:</Highlight></CodeLine>
<Link id="l00999" /><CodeLine lineNumber="999"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We cannot mitigate far jumps or calls, but we also don&#39;t expect them</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01000" /><CodeLine lineNumber="1000"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// to be vulnerable to Spectre v1.2 or v2 (self trained) style attacks.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01001" /><CodeLine lineNumber="1001"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01002" /><CodeLine lineNumber="1002"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01003" /><CodeLine lineNumber="1003"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::JMP16m:</Highlight></CodeLine>
<Link id="l01004" /><CodeLine lineNumber="1004"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::JMP16m&#95;NT:</Highlight></CodeLine>
<Link id="l01005" /><CodeLine lineNumber="1005"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::JMP32m:</Highlight></CodeLine>
<Link id="l01006" /><CodeLine lineNumber="1006"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::JMP32m&#95;NT:</Highlight></CodeLine>
<Link id="l01007" /><CodeLine lineNumber="1007"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::JMP64m:</Highlight></CodeLine>
<Link id="l01008" /><CodeLine lineNumber="1008"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::JMP64m&#95;NT:</Highlight></CodeLine>
<Link id="l01009" /><CodeLine lineNumber="1009"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Mostly as documentation.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01010" /><CodeLine lineNumber="1010"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(</Highlight><Highlight kind="stringliteral">&quot;Memory operand jumps should have been unfolded!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01011" /><CodeLine lineNumber="1011"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01012" /><CodeLine lineNumber="1012"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::JMP16r:</Highlight></CodeLine>
<Link id="l01013" /><CodeLine lineNumber="1013"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(</Highlight></CodeLine>
<Link id="l01014" /><CodeLine lineNumber="1014"><Highlight kind="normal">          </Highlight><Highlight kind="stringliteral">&quot;Support for 16-bit indirect branches is not implemented.&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01015" /><CodeLine lineNumber="1015"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::JMP32r:</Highlight></CodeLine>
<Link id="l01016" /><CodeLine lineNumber="1016"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(</Highlight></CodeLine>
<Link id="l01017" /><CodeLine lineNumber="1017"><Highlight kind="normal">          </Highlight><Highlight kind="stringliteral">&quot;Support for 32-bit indirect branches is not implemented.&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01018" /><CodeLine lineNumber="1018"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01019" /><CodeLine lineNumber="1019"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::JMP64r:</Highlight></CodeLine>
<Link id="l01020" /><CodeLine lineNumber="1020"><Highlight kind="normal">      TargetReg = TI.<a href="/docs/api/classes/llvm/machineinstr/#ad67c9230577a0b640c52852c75c93939">getOperand</a>(0).<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>();</Highlight></CodeLine>
<Link id="l01021" /><CodeLine lineNumber="1021"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01022" /><CodeLine lineNumber="1022"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01023" /><CodeLine lineNumber="1023"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We have definitely found an indirect  branch. Verify that there are no</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01024" /><CodeLine lineNumber="1024"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// preceding conditional branches as we don&#39;t yet support that.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01025" /><CodeLine lineNumber="1025"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a61d13d6824ec46c31260a4fd0997eda0">llvm::any&#95;of</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.terminators(), &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;OtherTI) &#123;</Highlight></CodeLine>
<Link id="l01026" /><CodeLine lineNumber="1026"><Highlight kind="normal">          return !OtherTI.isDebugInstr() &amp;&amp; &amp;OtherTI != &amp;TI;</Highlight></CodeLine>
<Link id="l01027" /><CodeLine lineNumber="1027"><Highlight kind="normal">        &#125;)) &#123;</Highlight></CodeLine>
<Link id="l01028" /><CodeLine lineNumber="1028"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(&#123;</Highlight></CodeLine>
<Link id="l01029" /><CodeLine lineNumber="1029"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;ERROR: Found other terminators in a block with an indirect &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01030" /><CodeLine lineNumber="1030"><Highlight kind="normal">                  </Highlight><Highlight kind="stringliteral">&quot;branch! This is not yet supported! Terminator sequence:\\n&quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01031" /><CodeLine lineNumber="1031"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> : <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.terminators()) &#123;</Highlight></CodeLine>
<Link id="l01032" /><CodeLine lineNumber="1032"><Highlight kind="normal">          <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.dump();</Highlight></CodeLine>
<Link id="l01033" /><CodeLine lineNumber="1033"><Highlight kind="normal">          <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="charliteral">&#39;\\n&#39;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01034" /><CodeLine lineNumber="1034"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l01035" /><CodeLine lineNumber="1035"><Highlight kind="normal">      &#125;);</Highlight></CodeLine>
<Link id="l01036" /><CodeLine lineNumber="1036"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(</Highlight><Highlight kind="stringliteral">&quot;Unimplemented terminator sequence!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01037" /><CodeLine lineNumber="1037"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01038" /><CodeLine lineNumber="1038"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01039" /><CodeLine lineNumber="1039"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Make the target register an available value for this block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01040" /><CodeLine lineNumber="1040"><Highlight kind="normal">    TargetAddrSSA.AddAvailableValue(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, TargetReg);</Highlight></CodeLine>
<Link id="l01041" /><CodeLine lineNumber="1041"><Highlight kind="normal">    IndirectTerminatedMBBs.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</Highlight></CodeLine>
<Link id="l01042" /><CodeLine lineNumber="1042"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01043" /><CodeLine lineNumber="1043"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Add all the successors to our target candidates.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01044" /><CodeLine lineNumber="1044"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ : <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.successors())</Highlight></CodeLine>
<Link id="l01045" /><CodeLine lineNumber="1045"><Highlight kind="normal">      IndirectTargetMBBs.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(Succ);</Highlight></CodeLine>
<Link id="l01046" /><CodeLine lineNumber="1046"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01047" /><CodeLine lineNumber="1047"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01048" /><CodeLine lineNumber="1048"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Keep track of the cmov instructions we insert so we can return them.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01049" /><CodeLine lineNumber="1049"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineInstr &#42;, 16&gt;</a> CMovs;</Highlight></CodeLine>
<Link id="l01050" /><CodeLine lineNumber="1050"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01051" /><CodeLine lineNumber="1051"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If we didn&#39;t find any indirect branches with targets, nothing to do here.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01052" /><CodeLine lineNumber="1052"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (IndirectTargetMBBs.<a href="/docs/api/classes/llvm/smallptrsetimplbase/#af8a50544090e81ac83601aff8f4b0142">empty</a>())</Highlight></CodeLine>
<Link id="l01053" /><CodeLine lineNumber="1053"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> CMovs;</Highlight></CodeLine>
<Link id="l01054" /><CodeLine lineNumber="1054"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01055" /><CodeLine lineNumber="1055"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We found indirect branches and targets that need to be instrumented to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01056" /><CodeLine lineNumber="1056"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// harden loads within them. Walk the blocks of the function (to get a stable</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01057" /><CodeLine lineNumber="1057"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// ordering) and instrument each target of an indirect branch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01058" /><CodeLine lineNumber="1058"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : MF) &#123;</Highlight></CodeLine>
<Link id="l01059" /><CodeLine lineNumber="1059"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Skip the blocks that aren&#39;t candidate targets.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01060" /><CodeLine lineNumber="1060"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!IndirectTargetMBBs.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>))</Highlight></CodeLine>
<Link id="l01061" /><CodeLine lineNumber="1061"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01062" /><CodeLine lineNumber="1062"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01063" /><CodeLine lineNumber="1063"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We don&#39;t expect EH pads to ever be reached via an indirect branch. If</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01064" /><CodeLine lineNumber="1064"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// this is desired for some reason, we could simply skip them here rather</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01065" /><CodeLine lineNumber="1065"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// than asserting.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01066" /><CodeLine lineNumber="1066"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.isEHPad() &amp;&amp;</Highlight></CodeLine>
<Link id="l01067" /><CodeLine lineNumber="1067"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;Unexpected EH pad as target of an indirect branch!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01068" /><CodeLine lineNumber="1068"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01069" /><CodeLine lineNumber="1069"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We should never end up threading EFLAGS into a block to harden</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01070" /><CodeLine lineNumber="1070"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// conditional jumps as there would be an additional successor via the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01071" /><CodeLine lineNumber="1071"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// indirect branch. As a consequence, all such edges would be split before</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01072" /><CodeLine lineNumber="1072"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// reaching here, and the inserted block will handle the EFLAGS-based</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01073" /><CodeLine lineNumber="1073"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// hardening.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01074" /><CodeLine lineNumber="1074"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.isLiveIn(X86::EFLAGS) &amp;&amp;</Highlight></CodeLine>
<Link id="l01075" /><CodeLine lineNumber="1075"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;Cannot check within a block that already has live-in EFLAGS!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01076" /><CodeLine lineNumber="1076"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01077" /><CodeLine lineNumber="1077"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We can&#39;t handle having non-indirect edges into this block unless this is</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01078" /><CodeLine lineNumber="1078"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// the only successor and we can synthesize the necessary target address.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01079" /><CodeLine lineNumber="1079"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Pred : <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.predecessors()) &#123;</Highlight></CodeLine>
<Link id="l01080" /><CodeLine lineNumber="1080"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// If we&#39;ve already handled this by extracting the target directly,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01081" /><CodeLine lineNumber="1081"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// nothing to do.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01082" /><CodeLine lineNumber="1082"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (IndirectTerminatedMBBs.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(Pred))</Highlight></CodeLine>
<Link id="l01083" /><CodeLine lineNumber="1083"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01084" /><CodeLine lineNumber="1084"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01085" /><CodeLine lineNumber="1085"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Otherwise, we have to be the only successor. We generally expect this</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01086" /><CodeLine lineNumber="1086"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// to be true as conditional branches should have had a critical edge</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01087" /><CodeLine lineNumber="1087"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// split already. We don&#39;t however need to worry about EH pad successors</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01088" /><CodeLine lineNumber="1088"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// as they&#39;ll happily ignore the target and their hardening strategy is</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01089" /><CodeLine lineNumber="1089"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// resilient to all ways in which they could be reached speculatively.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01090" /><CodeLine lineNumber="1090"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/namespaces/llvm/#a0d10fe510ced2849a8074fe81e5d04ce">llvm::all&#95;of</a>(Pred-&gt;successors(), &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ) &#123;</Highlight></CodeLine>
<Link id="l01091" /><CodeLine lineNumber="1091"><Highlight kind="normal">            return Succ-&gt;isEHPad() || Succ == &amp;MBB;</Highlight></CodeLine>
<Link id="l01092" /><CodeLine lineNumber="1092"><Highlight kind="normal">          &#125;)) &#123;</Highlight></CodeLine>
<Link id="l01093" /><CodeLine lineNumber="1093"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(&#123;</Highlight></CodeLine>
<Link id="l01094" /><CodeLine lineNumber="1094"><Highlight kind="normal">          <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;ERROR: Found conditional entry to target of indirect &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01095" /><CodeLine lineNumber="1095"><Highlight kind="normal">                    </Highlight><Highlight kind="stringliteral">&quot;branch!\\n&quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01096" /><CodeLine lineNumber="1096"><Highlight kind="normal">          Pred-&gt;dump();</Highlight></CodeLine>
<Link id="l01097" /><CodeLine lineNumber="1097"><Highlight kind="normal">          <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.dump();</Highlight></CodeLine>
<Link id="l01098" /><CodeLine lineNumber="1098"><Highlight kind="normal">        &#125;);</Highlight></CodeLine>
<Link id="l01099" /><CodeLine lineNumber="1099"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(</Highlight><Highlight kind="stringliteral">&quot;Cannot harden a conditional entry to a target of &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01100" /><CodeLine lineNumber="1100"><Highlight kind="normal">                           </Highlight><Highlight kind="stringliteral">&quot;an indirect branch!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01101" /><CodeLine lineNumber="1101"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l01102" /><CodeLine lineNumber="1102"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01103" /><CodeLine lineNumber="1103"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Now we need to compute the address of this block and install it as a</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01104" /><CodeLine lineNumber="1104"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// synthetic target in the predecessor. We do this at the bottom of the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01105" /><CodeLine lineNumber="1105"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// predecessor.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01106" /><CodeLine lineNumber="1106"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> InsertPt = Pred-&gt;getFirstTerminator();</Highlight></CodeLine>
<Link id="l01107" /><CodeLine lineNumber="1107"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/register">Register</a> TargetReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(&amp;X86::GR64RegClass);</Highlight></CodeLine>
<Link id="l01108" /><CodeLine lineNumber="1108"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MF.getTarget().getCodeModel() == <a href="/docs/api/namespaces/llvm/codemodel/#afc59396a9e5809fc92938e203d91a8dfaa2554ef60dc191c6005ba9eecbc9aea0">CodeModel::Small</a> &amp;&amp;</Highlight></CodeLine>
<Link id="l01109" /><CodeLine lineNumber="1109"><Highlight kind="normal">          !Subtarget-&gt;isPositionIndependent()) &#123;</Highlight></CodeLine>
<Link id="l01110" /><CodeLine lineNumber="1110"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Directly materialize it into an immediate.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01111" /><CodeLine lineNumber="1111"><Highlight kind="normal">        </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> AddrI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(&#42;Pred, InsertPt, <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a>(),</Highlight></CodeLine>
<Link id="l01112" /><CodeLine lineNumber="1112"><Highlight kind="normal">                             <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::MOV64ri32), TargetReg)</Highlight></CodeLine>
<Link id="l01113" /><CodeLine lineNumber="1113"><Highlight kind="normal">                         .<a href="/docs/api/classes/llvm/machineinstrbuilder/#abf1febf2a98f588146548a3a485d3838">addMBB</a>(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</Highlight></CodeLine>
<Link id="l01114" /><CodeLine lineNumber="1114"><Highlight kind="normal">        ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l01115" /><CodeLine lineNumber="1115"><Highlight kind="normal">        (void)AddrI;</Highlight></CodeLine>
<Link id="l01116" /><CodeLine lineNumber="1116"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Inserting mov: &quot;</Highlight><Highlight kind="normal">; AddrI-&gt;dump();</Highlight></CodeLine>
<Link id="l01117" /><CodeLine lineNumber="1117"><Highlight kind="normal">                   <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01118" /><CodeLine lineNumber="1118"><Highlight kind="normal">      &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l01119" /><CodeLine lineNumber="1119"><Highlight kind="normal">        </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> AddrI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(&#42;Pred, InsertPt, <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a>(), <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::LEA64r),</Highlight></CodeLine>
<Link id="l01120" /><CodeLine lineNumber="1120"><Highlight kind="normal">                             TargetReg)</Highlight></CodeLine>
<Link id="l01121" /><CodeLine lineNumber="1121"><Highlight kind="normal">                         .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</Highlight><Highlight kind="comment">/&#42;Base&#42;/</Highlight><Highlight kind="normal"> X86::RIP)</Highlight></CodeLine>
<Link id="l01122" /><CodeLine lineNumber="1122"><Highlight kind="normal">                         .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(</Highlight><Highlight kind="comment">/&#42;Scale&#42;/</Highlight><Highlight kind="normal"> 1)</Highlight></CodeLine>
<Link id="l01123" /><CodeLine lineNumber="1123"><Highlight kind="normal">                         .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</Highlight><Highlight kind="comment">/&#42;Index&#42;/</Highlight><Highlight kind="normal"> 0)</Highlight></CodeLine>
<Link id="l01124" /><CodeLine lineNumber="1124"><Highlight kind="normal">                         .<a href="/docs/api/classes/llvm/machineinstrbuilder/#abf1febf2a98f588146548a3a485d3838">addMBB</a>(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>)</Highlight></CodeLine>
<Link id="l01125" /><CodeLine lineNumber="1125"><Highlight kind="normal">                         .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</Highlight><Highlight kind="comment">/&#42;Segment&#42;/</Highlight><Highlight kind="normal"> 0);</Highlight></CodeLine>
<Link id="l01126" /><CodeLine lineNumber="1126"><Highlight kind="normal">        ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l01127" /><CodeLine lineNumber="1127"><Highlight kind="normal">        (void)AddrI;</Highlight></CodeLine>
<Link id="l01128" /><CodeLine lineNumber="1128"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Inserting lea: &quot;</Highlight><Highlight kind="normal">; AddrI-&gt;dump();</Highlight></CodeLine>
<Link id="l01129" /><CodeLine lineNumber="1129"><Highlight kind="normal">                   <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01130" /><CodeLine lineNumber="1130"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l01131" /><CodeLine lineNumber="1131"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// And make this available.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01132" /><CodeLine lineNumber="1132"><Highlight kind="normal">      TargetAddrSSA.AddAvailableValue(Pred, TargetReg);</Highlight></CodeLine>
<Link id="l01133" /><CodeLine lineNumber="1133"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01134" /><CodeLine lineNumber="1134"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01135" /><CodeLine lineNumber="1135"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Materialize the needed SSA value of the target. Note that we need the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01136" /><CodeLine lineNumber="1136"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// middle of the block as this block might at the bottom have an indirect</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01137" /><CodeLine lineNumber="1137"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// branch back to itself. We can do this here because at this point, every</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01138" /><CodeLine lineNumber="1138"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// predecessor of this block has an available value. This is basically just</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01139" /><CodeLine lineNumber="1139"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// automating the construction of a PHI node for this target.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01140" /><CodeLine lineNumber="1140"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/register">Register</a> TargetReg = TargetAddrSSA.GetValueInMiddleOfBlock(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</Highlight></CodeLine>
<Link id="l01141" /><CodeLine lineNumber="1141"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01142" /><CodeLine lineNumber="1142"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Insert a comparison of the incoming target register with this block&#39;s</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01143" /><CodeLine lineNumber="1143"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// address. This also requires us to mark the block as having its address</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01144" /><CodeLine lineNumber="1144"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// taken explicitly.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01145" /><CodeLine lineNumber="1145"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.setMachineBlockAddressTaken();</Highlight></CodeLine>
<Link id="l01146" /><CodeLine lineNumber="1146"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> InsertPt = <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.SkipPHIsLabelsAndDebug(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.begin());</Highlight></CodeLine>
<Link id="l01147" /><CodeLine lineNumber="1147"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MF.getTarget().getCodeModel() == <a href="/docs/api/namespaces/llvm/codemodel/#afc59396a9e5809fc92938e203d91a8dfaa2554ef60dc191c6005ba9eecbc9aea0">CodeModel::Small</a> &amp;&amp;</Highlight></CodeLine>
<Link id="l01148" /><CodeLine lineNumber="1148"><Highlight kind="normal">        !Subtarget-&gt;isPositionIndependent()) &#123;</Highlight></CodeLine>
<Link id="l01149" /><CodeLine lineNumber="1149"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Check directly against a relocated immediate when we can.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01150" /><CodeLine lineNumber="1150"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> CheckI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a>(), <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::CMP64ri32))</Highlight></CodeLine>
<Link id="l01151" /><CodeLine lineNumber="1151"><Highlight kind="normal">                        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(TargetReg, <a href="/docs/api/namespaces/llvm/regstate/#ade26fe5c9b3fe6948def36f7ca12dfc5a9ddde91ef09476d28a088fe57f8e2921">RegState::Kill</a>)</Highlight></CodeLine>
<Link id="l01152" /><CodeLine lineNumber="1152"><Highlight kind="normal">                        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#abf1febf2a98f588146548a3a485d3838">addMBB</a>(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</Highlight></CodeLine>
<Link id="l01153" /><CodeLine lineNumber="1153"><Highlight kind="normal">      ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l01154" /><CodeLine lineNumber="1154"><Highlight kind="normal">      (void)CheckI;</Highlight></CodeLine>
<Link id="l01155" /><CodeLine lineNumber="1155"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Inserting cmp: &quot;</Highlight><Highlight kind="normal">; CheckI-&gt;dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01156" /><CodeLine lineNumber="1156"><Highlight kind="normal">    &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l01157" /><CodeLine lineNumber="1157"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Otherwise compute the address into a register first.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01158" /><CodeLine lineNumber="1158"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/register">Register</a> AddrReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(&amp;X86::GR64RegClass);</Highlight></CodeLine>
<Link id="l01159" /><CodeLine lineNumber="1159"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> AddrI =</Highlight></CodeLine>
<Link id="l01160" /><CodeLine lineNumber="1160"><Highlight kind="normal">          <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a>(), <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::LEA64r), AddrReg)</Highlight></CodeLine>
<Link id="l01161" /><CodeLine lineNumber="1161"><Highlight kind="normal">              .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</Highlight><Highlight kind="comment">/&#42;Base&#42;/</Highlight><Highlight kind="normal"> X86::RIP)</Highlight></CodeLine>
<Link id="l01162" /><CodeLine lineNumber="1162"><Highlight kind="normal">              .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(</Highlight><Highlight kind="comment">/&#42;Scale&#42;/</Highlight><Highlight kind="normal"> 1)</Highlight></CodeLine>
<Link id="l01163" /><CodeLine lineNumber="1163"><Highlight kind="normal">              .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</Highlight><Highlight kind="comment">/&#42;Index&#42;/</Highlight><Highlight kind="normal"> 0)</Highlight></CodeLine>
<Link id="l01164" /><CodeLine lineNumber="1164"><Highlight kind="normal">              .<a href="/docs/api/classes/llvm/machineinstrbuilder/#abf1febf2a98f588146548a3a485d3838">addMBB</a>(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>)</Highlight></CodeLine>
<Link id="l01165" /><CodeLine lineNumber="1165"><Highlight kind="normal">              .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</Highlight><Highlight kind="comment">/&#42;Segment&#42;/</Highlight><Highlight kind="normal"> 0);</Highlight></CodeLine>
<Link id="l01166" /><CodeLine lineNumber="1166"><Highlight kind="normal">      ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l01167" /><CodeLine lineNumber="1167"><Highlight kind="normal">      (void)AddrI;</Highlight></CodeLine>
<Link id="l01168" /><CodeLine lineNumber="1168"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Inserting lea: &quot;</Highlight><Highlight kind="normal">; AddrI-&gt;dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01169" /><CodeLine lineNumber="1169"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> CheckI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a>(), <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::CMP64rr))</Highlight></CodeLine>
<Link id="l01170" /><CodeLine lineNumber="1170"><Highlight kind="normal">                        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(TargetReg, <a href="/docs/api/namespaces/llvm/regstate/#ade26fe5c9b3fe6948def36f7ca12dfc5a9ddde91ef09476d28a088fe57f8e2921">RegState::Kill</a>)</Highlight></CodeLine>
<Link id="l01171" /><CodeLine lineNumber="1171"><Highlight kind="normal">                        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(AddrReg, <a href="/docs/api/namespaces/llvm/regstate/#ade26fe5c9b3fe6948def36f7ca12dfc5a9ddde91ef09476d28a088fe57f8e2921">RegState::Kill</a>);</Highlight></CodeLine>
<Link id="l01172" /><CodeLine lineNumber="1172"><Highlight kind="normal">      ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l01173" /><CodeLine lineNumber="1173"><Highlight kind="normal">      (void)CheckI;</Highlight></CodeLine>
<Link id="l01174" /><CodeLine lineNumber="1174"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Inserting cmp: &quot;</Highlight><Highlight kind="normal">; CheckI-&gt;dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01175" /><CodeLine lineNumber="1175"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01176" /><CodeLine lineNumber="1176"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01177" /><CodeLine lineNumber="1177"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Now cmov over the predicate if the comparison wasn&#39;t equal.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01178" /><CodeLine lineNumber="1178"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> PredStateSizeInBytes = <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>-&gt;getRegSizeInBits(&#42;PS-&gt;RC) / 8;</Highlight></CodeLine>
<Link id="l01179" /><CodeLine lineNumber="1179"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> CMovOp = <a href="/docs/api/namespaces/llvm/x86/#af569f4e4b0acf498c83fa0e58e2eb364">X86::getCMovOpcode</a>(PredStateSizeInBytes);</Highlight></CodeLine>
<Link id="l01180" /><CodeLine lineNumber="1180"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/register">Register</a> UpdatedStateReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(PS-&gt;RC);</Highlight></CodeLine>
<Link id="l01181" /><CodeLine lineNumber="1181"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> CMovI =</Highlight></CodeLine>
<Link id="l01182" /><CodeLine lineNumber="1182"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a>(), <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(CMovOp), UpdatedStateReg)</Highlight></CodeLine>
<Link id="l01183" /><CodeLine lineNumber="1183"><Highlight kind="normal">            .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(PS-&gt;InitialReg)</Highlight></CodeLine>
<Link id="l01184" /><CodeLine lineNumber="1184"><Highlight kind="normal">            .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(PS-&gt;PoisonReg)</Highlight></CodeLine>
<Link id="l01185" /><CodeLine lineNumber="1185"><Highlight kind="normal">            .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(<a href="/docs/api/namespaces/llvm/x86/#a1a356a51a1fb4cc3c427599082cf1d2eacb2f86eaebe8b719f743d17a2d5a5f3d">X86::COND&#95;NE</a>);</Highlight></CodeLine>
<Link id="l01186" /><CodeLine lineNumber="1186"><Highlight kind="normal">    CMovI-&gt;<a href="/docs/api/classes/llvm/machineinstr/#ab692b90c6e0e9b450f407896cbbe4b02">findRegisterUseOperand</a>(X86::EFLAGS, </Highlight><Highlight kind="comment">/&#42;TRI=&#42;/</Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">)</Highlight></CodeLine>
<Link id="l01187" /><CodeLine lineNumber="1187"><Highlight kind="normal">        -&gt;<a href="/docs/api/classes/llvm/machineoperand/#a8a82683fccdef8a5ef772ef03277aee7">setIsKill</a>(</Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01188" /><CodeLine lineNumber="1188"><Highlight kind="normal">    ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l01189" /><CodeLine lineNumber="1189"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Inserting cmov: &quot;</Highlight><Highlight kind="normal">; CMovI-&gt;dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01190" /><CodeLine lineNumber="1190"><Highlight kind="normal">    CMovs.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&amp;&#42;CMovI);</Highlight></CodeLine>
<Link id="l01191" /><CodeLine lineNumber="1191"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01192" /><CodeLine lineNumber="1192"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// And put the new value into the available values for SSA form of our</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01193" /><CodeLine lineNumber="1193"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// predicate state.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01194" /><CodeLine lineNumber="1194"><Highlight kind="normal">    PS-&gt;SSA.AddAvailableValue(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, UpdatedStateReg);</Highlight></CodeLine>
<Link id="l01195" /><CodeLine lineNumber="1195"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01196" /><CodeLine lineNumber="1196"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01197" /><CodeLine lineNumber="1197"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Return all the newly inserted cmov instructions of the predicate state.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01198" /><CodeLine lineNumber="1198"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> CMovs;</Highlight></CodeLine>
<Link id="l01199" /><CodeLine lineNumber="1199"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01200" /><CodeLine lineNumber="1200"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01201" /><CodeLine lineNumber="1201"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Returns true if the MI has EFLAGS as a register def operand and it&#39;s live,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01202" /><CodeLine lineNumber="1202"><Highlight kind="normal"></Highlight><Highlight kind="comment">// otherwise it returns false</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01203" /><CodeLine lineNumber="1203" lineLink="#ac0e27a6dfaf334669f95954dee3d5920"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#ac0e27a6dfaf334669f95954dee3d5920">isEFLAGSDefLive</a>(</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) &#123;</Highlight></CodeLine>
<Link id="l01204" /><CodeLine lineNumber="1204"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &#42;DefOp =</Highlight></CodeLine>
<Link id="l01205" /><CodeLine lineNumber="1205"><Highlight kind="normal">          <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.findRegisterDefOperand(X86::EFLAGS, </Highlight><Highlight kind="comment">/&#42;TRI=&#42;/</Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">)) &#123;</Highlight></CodeLine>
<Link id="l01206" /><CodeLine lineNumber="1206"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> !DefOp-&gt;isDead();</Highlight></CodeLine>
<Link id="l01207" /><CodeLine lineNumber="1207"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01208" /><CodeLine lineNumber="1208"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01209" /><CodeLine lineNumber="1209"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01210" /><CodeLine lineNumber="1210"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01211" /><CodeLine lineNumber="1211" lineLink="#a93f8e5dacbcd949d688c3af5f491468d"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a93f8e5dacbcd949d688c3af5f491468d">isEFLAGSLive</a>(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>,</Highlight></CodeLine>
<Link id="l01212" /><CodeLine lineNumber="1212"><Highlight kind="normal">                         </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/targetregisterinfo">TargetRegisterInfo</a> &amp;<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>) &#123;</Highlight></CodeLine>
<Link id="l01213" /><CodeLine lineNumber="1213"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Check if EFLAGS are alive by seeing if there is a def of them or they</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01214" /><CodeLine lineNumber="1214"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// live-in, and then seeing if that def is in turn used.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01215" /><CodeLine lineNumber="1215"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> : <a href="/docs/api/namespaces/llvm/#a6b0ac1fa4f05de76413c5e0ca6334035">llvm::reverse</a>(<a href="/docs/api/namespaces/llvm/#a341215803e83773a3e97860dc291f121">llvm::make&#95;range</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.begin(), <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))) &#123;</Highlight></CodeLine>
<Link id="l01216" /><CodeLine lineNumber="1216"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &#42;DefOp =</Highlight></CodeLine>
<Link id="l01217" /><CodeLine lineNumber="1217"><Highlight kind="normal">            <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.findRegisterDefOperand(X86::EFLAGS, </Highlight><Highlight kind="comment">/&#42;TRI=&#42;/</Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">)) &#123;</Highlight></CodeLine>
<Link id="l01218" /><CodeLine lineNumber="1218"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// If the def is dead, then EFLAGS is not live.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01219" /><CodeLine lineNumber="1219"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DefOp-&gt;isDead())</Highlight></CodeLine>
<Link id="l01220" /><CodeLine lineNumber="1220"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01221" /><CodeLine lineNumber="1221"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01222" /><CodeLine lineNumber="1222"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Otherwise we&#39;ve def&#39;ed it, and it is live.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01223" /><CodeLine lineNumber="1223"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01224" /><CodeLine lineNumber="1224"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01225" /><CodeLine lineNumber="1225"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// While at this instruction, also check if we use and kill EFLAGS</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01226" /><CodeLine lineNumber="1226"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// which means it isn&#39;t live.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01227" /><CodeLine lineNumber="1227"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.killsRegister(X86::EFLAGS, &amp;<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>))</Highlight></CodeLine>
<Link id="l01228" /><CodeLine lineNumber="1228"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01229" /><CodeLine lineNumber="1229"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01230" /><CodeLine lineNumber="1230"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01231" /><CodeLine lineNumber="1231"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If we didn&#39;t find anything conclusive (neither definitely alive or</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01232" /><CodeLine lineNumber="1232"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// definitely dead) return whether it lives into the block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01233" /><CodeLine lineNumber="1233"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.isLiveIn(X86::EFLAGS);</Highlight></CodeLine>
<Link id="l01234" /><CodeLine lineNumber="1234"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01235" /><CodeLine lineNumber="1235"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l01236" /><CodeLine lineNumber="1236"><Highlight kind="comment">/// Trace the predicate state through each of the blocks in the function,</Highlight></CodeLine>
<Link id="l01237" /><CodeLine lineNumber="1237"><Highlight kind="comment">/// hardening everything necessary along the way.</Highlight></CodeLine>
<Link id="l01238" /><CodeLine lineNumber="1238"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01239" /><CodeLine lineNumber="1239"><Highlight kind="comment">/// We call this routine once the initial predicate state has been established</Highlight></CodeLine>
<Link id="l01240" /><CodeLine lineNumber="1240"><Highlight kind="comment">/// for each basic block in the function in the SSA updater. This routine traces</Highlight></CodeLine>
<Link id="l01241" /><CodeLine lineNumber="1241"><Highlight kind="comment">/// it through the instructions within each basic block, and for non-returning</Highlight></CodeLine>
<Link id="l01242" /><CodeLine lineNumber="1242"><Highlight kind="comment">/// blocks informs the SSA updater about the final state that lives out of the</Highlight></CodeLine>
<Link id="l01243" /><CodeLine lineNumber="1243"><Highlight kind="comment">/// block. Along the way, it hardens any vulnerable instruction using the</Highlight></CodeLine>
<Link id="l01244" /><CodeLine lineNumber="1244"><Highlight kind="comment">/// currently valid predicate state. We have to do these two things together</Highlight></CodeLine>
<Link id="l01245" /><CodeLine lineNumber="1245"><Highlight kind="comment">/// because the SSA updater only works across blocks. Within a block, we track</Highlight></CodeLine>
<Link id="l01246" /><CodeLine lineNumber="1246"><Highlight kind="comment">/// the current predicate state directly and update it as it changes.</Highlight></CodeLine>
<Link id="l01247" /><CodeLine lineNumber="1247"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01248" /><CodeLine lineNumber="1248"><Highlight kind="comment">/// This operates in two passes over each block. First, we analyze the loads in</Highlight></CodeLine>
<Link id="l01249" /><CodeLine lineNumber="1249"><Highlight kind="comment">/// the block to determine which strategy will be used to harden them: hardening</Highlight></CodeLine>
<Link id="l01250" /><CodeLine lineNumber="1250"><Highlight kind="comment">/// the address or hardening the loaded value when loaded into a register</Highlight></CodeLine>
<Link id="l01251" /><CodeLine lineNumber="1251"><Highlight kind="comment">/// amenable to hardening. We have to process these first because the two</Highlight></CodeLine>
<Link id="l01252" /><CodeLine lineNumber="1252"><Highlight kind="comment">/// strategies may interact -- later hardening may change what strategy we wish</Highlight></CodeLine>
<Link id="l01253" /><CodeLine lineNumber="1253"><Highlight kind="comment">/// to use. We also will analyze data dependencies between loads and avoid</Highlight></CodeLine>
<Link id="l01254" /><CodeLine lineNumber="1254"><Highlight kind="comment">/// hardening those loads that are data dependent on a load with a hardened</Highlight></CodeLine>
<Link id="l01255" /><CodeLine lineNumber="1255"><Highlight kind="comment">/// address. We also skip hardening loads already behind an LFENCE as that is</Highlight></CodeLine>
<Link id="l01256" /><CodeLine lineNumber="1256"><Highlight kind="comment">/// sufficient to harden them against misspeculation.</Highlight></CodeLine>
<Link id="l01257" /><CodeLine lineNumber="1257"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01258" /><CodeLine lineNumber="1258"><Highlight kind="comment">/// Second, we actively trace the predicate state through the block, applying</Highlight></CodeLine>
<Link id="l01259" /><CodeLine lineNumber="1259"><Highlight kind="comment">/// the hardening steps we determined necessary in the first pass as we go.</Highlight></CodeLine>
<Link id="l01260" /><CodeLine lineNumber="1260"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01261" /><CodeLine lineNumber="1261"><Highlight kind="comment">/// These two passes are applied to each basic block. We operate one block at a</Highlight></CodeLine>
<Link id="l01262" /><CodeLine lineNumber="1262"><Highlight kind="comment">/// time to simplify reasoning about reachability and sequencing.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01263" /><CodeLine lineNumber="1263"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> X86SpeculativeLoadHardeningPass::tracePredStateThroughBlocksAndHarden(</Highlight></CodeLine>
<Link id="l01264" /><CodeLine lineNumber="1264"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF) &#123;</Highlight></CodeLine>
<Link id="l01265" /><CodeLine lineNumber="1265"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;MachineInstr &#42;, 16&gt;</a> HardenPostLoad;</Highlight></CodeLine>
<Link id="l01266" /><CodeLine lineNumber="1266"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;MachineInstr &#42;, 16&gt;</a> HardenLoadAddr;</Highlight></CodeLine>
<Link id="l01267" /><CodeLine lineNumber="1267"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01268" /><CodeLine lineNumber="1268"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallset">SmallSet&lt;unsigned, 16&gt;</a> HardenedAddrRegs;</Highlight></CodeLine>
<Link id="l01269" /><CodeLine lineNumber="1269"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01270" /><CodeLine lineNumber="1270"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;unsigned, unsigned, 32&gt;</a> AddrRegToHardenedReg;</Highlight></CodeLine>
<Link id="l01271" /><CodeLine lineNumber="1271"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01272" /><CodeLine lineNumber="1272"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Track the set of load-dependent registers through the basic block. Because</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01273" /><CodeLine lineNumber="1273"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the values of these registers have an existing data dependency on a loaded</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01274" /><CodeLine lineNumber="1274"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// value which we would have checked, we can omit any checks on them.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01275" /><CodeLine lineNumber="1275"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/sparsebitvector">SparseBitVector&lt;&gt;</a> LoadDepRegs;</Highlight></CodeLine>
<Link id="l01276" /><CodeLine lineNumber="1276"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01277" /><CodeLine lineNumber="1277"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : MF) &#123;</Highlight></CodeLine>
<Link id="l01278" /><CodeLine lineNumber="1278"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// The first pass over the block: collect all the loads which can have their</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01279" /><CodeLine lineNumber="1279"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// loaded value hardened and all the loads that instead need their address</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01280" /><CodeLine lineNumber="1280"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// hardened. During this walk we propagate load dependence for address</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01281" /><CodeLine lineNumber="1281"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// hardened loads and also look for LFENCE to stop hardening wherever</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01282" /><CodeLine lineNumber="1282"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// possible. When deciding whether or not to harden the loaded value or not,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01283" /><CodeLine lineNumber="1283"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// we check to see if any registers used in the address will have been</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01284" /><CodeLine lineNumber="1284"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// hardened at this point and if so, harden any remaining address registers</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01285" /><CodeLine lineNumber="1285"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// as that often successfully re-uses hardened addresses and minimizes</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01286" /><CodeLine lineNumber="1286"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// instructions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01287" /><CodeLine lineNumber="1287"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01288" /><CodeLine lineNumber="1288"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// FIXME: We should consider an aggressive mode where we continue to keep as</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01289" /><CodeLine lineNumber="1289"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// many loads value hardened even when some address register hardening would</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01290" /><CodeLine lineNumber="1290"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// be free (due to reuse).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01291" /><CodeLine lineNumber="1291"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01292" /><CodeLine lineNumber="1292"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Note that we only need this pass if we are actually hardening loads.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01293" /><CodeLine lineNumber="1293"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64speculationhardening-cpp/#afd315bab7ff3b1adb2920b69ec1adcae">HardenLoads</a>)</Highlight></CodeLine>
<Link id="l01294" /><CodeLine lineNumber="1294"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> : <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>) &#123;</Highlight></CodeLine>
<Link id="l01295" /><CodeLine lineNumber="1295"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// We naively assume that all def&#39;ed registers of an instruction have</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01296" /><CodeLine lineNumber="1296"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// a data dependency on all of their operands.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01297" /><CodeLine lineNumber="1297"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// FIXME: Do a more careful analysis of x86 to build a conservative</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01298" /><CodeLine lineNumber="1298"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// model here.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01299" /><CodeLine lineNumber="1299"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a61d13d6824ec46c31260a4fd0997eda0">llvm::any&#95;of</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.uses(), &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>) &#123;</Highlight></CodeLine>
<Link id="l01300" /><CodeLine lineNumber="1300"><Highlight kind="normal">              return Op.isReg() &amp;&amp; LoadDepRegs.test(Op.getReg());</Highlight></CodeLine>
<Link id="l01301" /><CodeLine lineNumber="1301"><Highlight kind="normal">            &#125;))</Highlight></CodeLine>
<Link id="l01302" /><CodeLine lineNumber="1302"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;Def : <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.defs())</Highlight></CodeLine>
<Link id="l01303" /><CodeLine lineNumber="1303"><Highlight kind="normal">            </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/rdf/#a10793004faece2bb74d3363b5f6ce96f">Def</a>.isReg())</Highlight></CodeLine>
<Link id="l01304" /><CodeLine lineNumber="1304"><Highlight kind="normal">              LoadDepRegs.<a href="/docs/api/classes/llvm/sparsebitvector/#a613c1e44c4e88e9a1e0be386cb5fa828">set</a>(<a href="/docs/api/namespaces/llvm/rdf/#a10793004faece2bb74d3363b5f6ce96f">Def</a>.getReg());</Highlight></CodeLine>
<Link id="l01305" /><CodeLine lineNumber="1305"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01306" /><CodeLine lineNumber="1306"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Both Intel and AMD are guiding that they will change the semantics of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01307" /><CodeLine lineNumber="1307"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// LFENCE to be a speculation barrier, so if we see an LFENCE, there is</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01308" /><CodeLine lineNumber="1308"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// no more need to guard things in this block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01309" /><CodeLine lineNumber="1309"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOpcode() == X86::LFENCE)</Highlight></CodeLine>
<Link id="l01310" /><CodeLine lineNumber="1310"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">break</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01311" /><CodeLine lineNumber="1311"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01312" /><CodeLine lineNumber="1312"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// If this instruction cannot load, nothing to do.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01313" /><CodeLine lineNumber="1313"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.mayLoad())</Highlight></CodeLine>
<Link id="l01314" /><CodeLine lineNumber="1314"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01315" /><CodeLine lineNumber="1315"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01316" /><CodeLine lineNumber="1316"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Some instructions which &quot;load&quot; are trivially safe or unimportant.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01317" /><CodeLine lineNumber="1317"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOpcode() == X86::MFENCE)</Highlight></CodeLine>
<Link id="l01318" /><CodeLine lineNumber="1318"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01319" /><CodeLine lineNumber="1319"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01320" /><CodeLine lineNumber="1320"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Extract the memory operand information about this instruction.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01321" /><CodeLine lineNumber="1321"><Highlight kind="normal">        </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> MemRefBeginIdx = <a href="/docs/api/namespaces/llvm/x86/#a279395a00a782f7e3d6141bc3328a249">X86::getFirstAddrOperandIdx</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</Highlight></CodeLine>
<Link id="l01322" /><CodeLine lineNumber="1322"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MemRefBeginIdx &lt; 0) &#123;</Highlight></CodeLine>
<Link id="l01323" /><CodeLine lineNumber="1323"><Highlight kind="normal">          <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>()</Highlight></CodeLine>
<Link id="l01324" /><CodeLine lineNumber="1324"><Highlight kind="normal">                         &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;WARNING: unable to harden loading instruction: &quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01325" /><CodeLine lineNumber="1325"><Highlight kind="normal">                     <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.dump());</Highlight></CodeLine>
<Link id="l01326" /><CodeLine lineNumber="1326"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01327" /><CodeLine lineNumber="1327"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l01328" /><CodeLine lineNumber="1328"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01329" /><CodeLine lineNumber="1329"><Highlight kind="normal">        <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;BaseMO =</Highlight></CodeLine>
<Link id="l01330" /><CodeLine lineNumber="1330"><Highlight kind="normal">            <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(MemRefBeginIdx + <a href="/docs/api/namespaces/llvm/x86/#a2a5aec578e2e391e99e1705012752d84a319f0e99a1ac9396659683d2638d4f45">X86::AddrBaseReg</a>);</Highlight></CodeLine>
<Link id="l01331" /><CodeLine lineNumber="1331"><Highlight kind="normal">        <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;IndexMO =</Highlight></CodeLine>
<Link id="l01332" /><CodeLine lineNumber="1332"><Highlight kind="normal">            <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(MemRefBeginIdx + <a href="/docs/api/namespaces/llvm/x86/#a2a5aec578e2e391e99e1705012752d84aba7ebe0e28a2c1c4c14343f549c01462">X86::AddrIndexReg</a>);</Highlight></CodeLine>
<Link id="l01333" /><CodeLine lineNumber="1333"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01334" /><CodeLine lineNumber="1334"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// If we have at least one (non-frame-index, non-RIP) register operand,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01335" /><CodeLine lineNumber="1335"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// and neither operand is load-dependent, we need to check the load.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01336" /><CodeLine lineNumber="1336"><Highlight kind="normal">        </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> BaseReg = 0, IndexReg = 0;</Highlight></CodeLine>
<Link id="l01337" /><CodeLine lineNumber="1337"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#ad7213433bd60dc33020246384dc18b9b">isFI</a>() &amp;&amp; BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() != X86::RIP &amp;&amp;</Highlight></CodeLine>
<Link id="l01338" /><CodeLine lineNumber="1338"><Highlight kind="normal">            BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() != X86::NoRegister)</Highlight></CodeLine>
<Link id="l01339" /><CodeLine lineNumber="1339"><Highlight kind="normal">          BaseReg = BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>();</Highlight></CodeLine>
<Link id="l01340" /><CodeLine lineNumber="1340"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (IndexMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() != X86::NoRegister)</Highlight></CodeLine>
<Link id="l01341" /><CodeLine lineNumber="1341"><Highlight kind="normal">          IndexReg = IndexMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>();</Highlight></CodeLine>
<Link id="l01342" /><CodeLine lineNumber="1342"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01343" /><CodeLine lineNumber="1343"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!BaseReg &amp;&amp; !IndexReg)</Highlight></CodeLine>
<Link id="l01344" /><CodeLine lineNumber="1344"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// No register operands!</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01345" /><CodeLine lineNumber="1345"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01346" /><CodeLine lineNumber="1346"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01347" /><CodeLine lineNumber="1347"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// If any register operand is dependent, this load is dependent and we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01348" /><CodeLine lineNumber="1348"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// needn&#39;t check it.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01349" /><CodeLine lineNumber="1349"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// FIXME: Is this true in the case where we are hardening loads after</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01350" /><CodeLine lineNumber="1350"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// they complete? Unclear, need to investigate.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01351" /><CodeLine lineNumber="1351"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> ((BaseReg &amp;&amp; LoadDepRegs.<a href="/docs/api/classes/llvm/sparsebitvector/#aaa2827e67554a0b81f693dc61a3a40b5">test</a>(BaseReg)) ||</Highlight></CodeLine>
<Link id="l01352" /><CodeLine lineNumber="1352"><Highlight kind="normal">            (IndexReg &amp;&amp; LoadDepRegs.<a href="/docs/api/classes/llvm/sparsebitvector/#aaa2827e67554a0b81f693dc61a3a40b5">test</a>(IndexReg)))</Highlight></CodeLine>
<Link id="l01353" /><CodeLine lineNumber="1353"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01354" /><CodeLine lineNumber="1354"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01355" /><CodeLine lineNumber="1355"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// If post-load hardening is enabled, this load is compatible with</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01356" /><CodeLine lineNumber="1356"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// post-load hardening, and we aren&#39;t already going to harden one of the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01357" /><CodeLine lineNumber="1357"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// address registers, queue it up to be hardened post-load. Notably,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01358" /><CodeLine lineNumber="1358"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// even once hardened this won&#39;t introduce a useful dependency that</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01359" /><CodeLine lineNumber="1359"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// could prune out subsequent loads.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01360" /><CodeLine lineNumber="1360"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#a7385b8089f422279adefa5007ef35dc6">EnablePostLoadHardening</a> &amp;&amp; <a href="/docs/api/classes/llvm/x86instrinfo/#a34662990aab5992b0b1ee00a4dd4ad34">X86InstrInfo::isDataInvariantLoad</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) &amp;&amp;</Highlight></CodeLine>
<Link id="l01361" /><CodeLine lineNumber="1361"><Highlight kind="normal">            !<a href="#ac0e27a6dfaf334669f95954dee3d5920">isEFLAGSDefLive</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) &amp;&amp; <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getDesc().getNumDefs() == 1 &amp;&amp;</Highlight></CodeLine>
<Link id="l01362" /><CodeLine lineNumber="1362"><Highlight kind="normal">            <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(0).isReg() &amp;&amp;</Highlight></CodeLine>
<Link id="l01363" /><CodeLine lineNumber="1363"><Highlight kind="normal">            canHardenRegister(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(0).getReg()) &amp;&amp;</Highlight></CodeLine>
<Link id="l01364" /><CodeLine lineNumber="1364"><Highlight kind="normal">            !HardenedAddrRegs.<a href="/docs/api/classes/llvm/smallset/#a2a98f19750ba941ce791b75ca6d77e48">count</a>(BaseReg) &amp;&amp;</Highlight></CodeLine>
<Link id="l01365" /><CodeLine lineNumber="1365"><Highlight kind="normal">            !HardenedAddrRegs.<a href="/docs/api/classes/llvm/smallset/#a2a98f19750ba941ce791b75ca6d77e48">count</a>(IndexReg)) &#123;</Highlight></CodeLine>
<Link id="l01366" /><CodeLine lineNumber="1366"><Highlight kind="normal">          HardenPostLoad.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(&amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</Highlight></CodeLine>
<Link id="l01367" /><CodeLine lineNumber="1367"><Highlight kind="normal">          HardenedAddrRegs.<a href="/docs/api/classes/llvm/smallset/#afcadfef2cf37c3e6dbdbc9cd7bea50a0">insert</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(0).getReg());</Highlight></CodeLine>
<Link id="l01368" /><CodeLine lineNumber="1368"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01369" /><CodeLine lineNumber="1369"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l01370" /><CodeLine lineNumber="1370"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01371" /><CodeLine lineNumber="1371"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Record this instruction for address hardening and record its register</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01372" /><CodeLine lineNumber="1372"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// operands as being address-hardened.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01373" /><CodeLine lineNumber="1373"><Highlight kind="normal">        HardenLoadAddr.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(&amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</Highlight></CodeLine>
<Link id="l01374" /><CodeLine lineNumber="1374"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BaseReg)</Highlight></CodeLine>
<Link id="l01375" /><CodeLine lineNumber="1375"><Highlight kind="normal">          HardenedAddrRegs.<a href="/docs/api/classes/llvm/smallset/#afcadfef2cf37c3e6dbdbc9cd7bea50a0">insert</a>(BaseReg);</Highlight></CodeLine>
<Link id="l01376" /><CodeLine lineNumber="1376"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (IndexReg)</Highlight></CodeLine>
<Link id="l01377" /><CodeLine lineNumber="1377"><Highlight kind="normal">          HardenedAddrRegs.<a href="/docs/api/classes/llvm/smallset/#afcadfef2cf37c3e6dbdbc9cd7bea50a0">insert</a>(IndexReg);</Highlight></CodeLine>
<Link id="l01378" /><CodeLine lineNumber="1378"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01379" /><CodeLine lineNumber="1379"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;Def : <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.defs())</Highlight></CodeLine>
<Link id="l01380" /><CodeLine lineNumber="1380"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/rdf/#a10793004faece2bb74d3363b5f6ce96f">Def</a>.isReg())</Highlight></CodeLine>
<Link id="l01381" /><CodeLine lineNumber="1381"><Highlight kind="normal">            LoadDepRegs.<a href="/docs/api/classes/llvm/sparsebitvector/#a613c1e44c4e88e9a1e0be386cb5fa828">set</a>(<a href="/docs/api/namespaces/llvm/rdf/#a10793004faece2bb74d3363b5f6ce96f">Def</a>.getReg());</Highlight></CodeLine>
<Link id="l01382" /><CodeLine lineNumber="1382"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l01383" /><CodeLine lineNumber="1383"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01384" /><CodeLine lineNumber="1384"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Now re-walk the instructions in the basic block, and apply whichever</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01385" /><CodeLine lineNumber="1385"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// hardening strategy we have elected. Note that we do this in a second</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01386" /><CodeLine lineNumber="1386"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// pass specifically so that we have the complete set of instructions for</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01387" /><CodeLine lineNumber="1387"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// which we will do post-load hardening and can defer it in certain</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01388" /><CodeLine lineNumber="1388"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// circumstances.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01389" /><CodeLine lineNumber="1389"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> : <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>) &#123;</Highlight></CodeLine>
<Link id="l01390" /><CodeLine lineNumber="1390"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64speculationhardening-cpp/#afd315bab7ff3b1adb2920b69ec1adcae">HardenLoads</a>) &#123;</Highlight></CodeLine>
<Link id="l01391" /><CodeLine lineNumber="1391"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// We cannot both require hardening the def of a load and its address.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01392" /><CodeLine lineNumber="1392"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!(HardenLoadAddr.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(&amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) &amp;&amp; HardenPostLoad.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(&amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>)) &amp;&amp;</Highlight></CodeLine>
<Link id="l01393" /><CodeLine lineNumber="1393"><Highlight kind="normal">               </Highlight><Highlight kind="stringliteral">&quot;Requested to harden both the address and def of a load!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01394" /><CodeLine lineNumber="1394"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01395" /><CodeLine lineNumber="1395"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Check if this is a load whose address needs to be hardened.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01396" /><CodeLine lineNumber="1396"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (HardenLoadAddr.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a11045c7973ab24a8d6315b61fa337d4e">erase</a>(&amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>)) &#123;</Highlight></CodeLine>
<Link id="l01397" /><CodeLine lineNumber="1397"><Highlight kind="normal">          </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> MemRefBeginIdx = <a href="/docs/api/namespaces/llvm/x86/#a279395a00a782f7e3d6141bc3328a249">X86::getFirstAddrOperandIdx</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</Highlight></CodeLine>
<Link id="l01398" /><CodeLine lineNumber="1398"><Highlight kind="normal">          <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(MemRefBeginIdx &gt;= 0 &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Cannot have an invalid index here!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01399" /><CodeLine lineNumber="1399"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01400" /><CodeLine lineNumber="1400"><Highlight kind="normal">          <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;BaseMO =</Highlight></CodeLine>
<Link id="l01401" /><CodeLine lineNumber="1401"><Highlight kind="normal">              <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(MemRefBeginIdx + <a href="/docs/api/namespaces/llvm/x86/#a2a5aec578e2e391e99e1705012752d84a319f0e99a1ac9396659683d2638d4f45">X86::AddrBaseReg</a>);</Highlight></CodeLine>
<Link id="l01402" /><CodeLine lineNumber="1402"><Highlight kind="normal">          <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;IndexMO =</Highlight></CodeLine>
<Link id="l01403" /><CodeLine lineNumber="1403"><Highlight kind="normal">              <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(MemRefBeginIdx + <a href="/docs/api/namespaces/llvm/x86/#a2a5aec578e2e391e99e1705012752d84aba7ebe0e28a2c1c4c14343f549c01462">X86::AddrIndexReg</a>);</Highlight></CodeLine>
<Link id="l01404" /><CodeLine lineNumber="1404"><Highlight kind="normal">          hardenLoadAddr(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>, BaseMO, IndexMO, AddrRegToHardenedReg);</Highlight></CodeLine>
<Link id="l01405" /><CodeLine lineNumber="1405"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01406" /><CodeLine lineNumber="1406"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l01407" /><CodeLine lineNumber="1407"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01408" /><CodeLine lineNumber="1408"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Test if this instruction is one of our post load instructions (and</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01409" /><CodeLine lineNumber="1409"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// remove it from the set if so).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01410" /><CodeLine lineNumber="1410"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (HardenPostLoad.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a11045c7973ab24a8d6315b61fa337d4e">erase</a>(&amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>)) &#123;</Highlight></CodeLine>
<Link id="l01411" /><CodeLine lineNumber="1411"><Highlight kind="normal">          <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isCall() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Must not try to post-load harden a call!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01412" /><CodeLine lineNumber="1412"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01413" /><CodeLine lineNumber="1413"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// If this is a data-invariant load and there is no EFLAGS</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01414" /><CodeLine lineNumber="1414"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// interference, we want to try and sink any hardening as far as</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01415" /><CodeLine lineNumber="1415"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// possible.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01416" /><CodeLine lineNumber="1416"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/x86instrinfo/#a34662990aab5992b0b1ee00a4dd4ad34">X86InstrInfo::isDataInvariantLoad</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) &amp;&amp; !<a href="#ac0e27a6dfaf334669f95954dee3d5920">isEFLAGSDefLive</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>)) &#123;</Highlight></CodeLine>
<Link id="l01417" /><CodeLine lineNumber="1417"><Highlight kind="normal">            </Highlight><Highlight kind="comment">// Sink the instruction we&#39;ll need to harden as far as we can down</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01418" /><CodeLine lineNumber="1418"><Highlight kind="normal">            </Highlight><Highlight kind="comment">// the graph.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01419" /><CodeLine lineNumber="1419"><Highlight kind="normal">            <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;SunkMI = sinkPostLoadHardenedInst(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>, HardenPostLoad);</Highlight></CodeLine>
<Link id="l01420" /><CodeLine lineNumber="1420"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01421" /><CodeLine lineNumber="1421"><Highlight kind="normal">            </Highlight><Highlight kind="comment">// If we managed to sink this instruction, update everything so we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01422" /><CodeLine lineNumber="1422"><Highlight kind="normal">            </Highlight><Highlight kind="comment">// harden that instruction when we reach it in the instruction</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01423" /><CodeLine lineNumber="1423"><Highlight kind="normal">            </Highlight><Highlight kind="comment">// sequence.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01424" /><CodeLine lineNumber="1424"><Highlight kind="normal">            </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SunkMI != &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) &#123;</Highlight></CodeLine>
<Link id="l01425" /><CodeLine lineNumber="1425"><Highlight kind="normal">              </Highlight><Highlight kind="comment">// If in sinking there was no instruction needing to be hardened,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01426" /><CodeLine lineNumber="1426"><Highlight kind="normal">              </Highlight><Highlight kind="comment">// we&#39;re done.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01427" /><CodeLine lineNumber="1427"><Highlight kind="normal">              </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!SunkMI)</Highlight></CodeLine>
<Link id="l01428" /><CodeLine lineNumber="1428"><Highlight kind="normal">                </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01429" /><CodeLine lineNumber="1429"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01430" /><CodeLine lineNumber="1430"><Highlight kind="normal">              </Highlight><Highlight kind="comment">// Otherwise, add this to the set of defs we harden.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01431" /><CodeLine lineNumber="1431"><Highlight kind="normal">              HardenPostLoad.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(SunkMI);</Highlight></CodeLine>
<Link id="l01432" /><CodeLine lineNumber="1432"><Highlight kind="normal">              </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01433" /><CodeLine lineNumber="1433"><Highlight kind="normal">            &#125;</Highlight></CodeLine>
<Link id="l01434" /><CodeLine lineNumber="1434"><Highlight kind="normal">          &#125;</Highlight></CodeLine>
<Link id="l01435" /><CodeLine lineNumber="1435"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01436" /><CodeLine lineNumber="1436"><Highlight kind="normal">          </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> HardenedReg = hardenPostLoad(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</Highlight></CodeLine>
<Link id="l01437" /><CodeLine lineNumber="1437"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01438" /><CodeLine lineNumber="1438"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// Mark the resulting hardened register as such so we don&#39;t re-harden.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01439" /><CodeLine lineNumber="1439"><Highlight kind="normal">          AddrRegToHardenedReg&#91;HardenedReg&#93; = HardenedReg;</Highlight></CodeLine>
<Link id="l01440" /><CodeLine lineNumber="1440"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01441" /><CodeLine lineNumber="1441"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01442" /><CodeLine lineNumber="1442"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l01443" /><CodeLine lineNumber="1443"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01444" /><CodeLine lineNumber="1444"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Check for an indirect call or branch that may need its input hardened</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01445" /><CodeLine lineNumber="1445"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// even if we couldn&#39;t find the specific load used, or were able to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01446" /><CodeLine lineNumber="1446"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// avoid hardening it for some reason. Note that here we cannot break</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01447" /><CodeLine lineNumber="1447"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// out afterward as we may still need to handle any call aspect of this</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01448" /><CodeLine lineNumber="1448"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// instruction.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01449" /><CodeLine lineNumber="1449"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> ((<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isCall() || <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isBranch()) &amp;&amp; <a href="#ade91f65a65e423e2002fb9b25b7b2a5c">HardenIndirectCallsAndJumps</a>)</Highlight></CodeLine>
<Link id="l01450" /><CodeLine lineNumber="1450"><Highlight kind="normal">          hardenIndirectCallOrJumpInstr(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>, AddrRegToHardenedReg);</Highlight></CodeLine>
<Link id="l01451" /><CodeLine lineNumber="1451"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l01452" /><CodeLine lineNumber="1452"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01453" /><CodeLine lineNumber="1453"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// After we finish hardening loads we handle interprocedural hardening if</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01454" /><CodeLine lineNumber="1454"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// enabled and relevant for this instruction.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01455" /><CodeLine lineNumber="1455"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="#a3e42304d79c25684c4d464fd35fb868f">HardenInterprocedurally</a>)</Highlight></CodeLine>
<Link id="l01456" /><CodeLine lineNumber="1456"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01457" /><CodeLine lineNumber="1457"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isCall() &amp;&amp; !<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isReturn())</Highlight></CodeLine>
<Link id="l01458" /><CodeLine lineNumber="1458"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01459" /><CodeLine lineNumber="1459"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01460" /><CodeLine lineNumber="1460"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// If this is a direct return (IE, not a tail call) just directly harden</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01461" /><CodeLine lineNumber="1461"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// it.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01462" /><CodeLine lineNumber="1462"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isReturn() &amp;&amp; !<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isCall()) &#123;</Highlight></CodeLine>
<Link id="l01463" /><CodeLine lineNumber="1463"><Highlight kind="normal">        hardenReturnInstr(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</Highlight></CodeLine>
<Link id="l01464" /><CodeLine lineNumber="1464"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01465" /><CodeLine lineNumber="1465"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l01466" /><CodeLine lineNumber="1466"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01467" /><CodeLine lineNumber="1467"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Otherwise we have a call. We need to handle transferring the predicate</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01468" /><CodeLine lineNumber="1468"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// state into a call and recovering it after the call returns (unless this</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01469" /><CodeLine lineNumber="1469"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// is a tail call).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01470" /><CodeLine lineNumber="1470"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isCall() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Should only reach here for calls!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01471" /><CodeLine lineNumber="1471"><Highlight kind="normal">      tracePredStateThroughCall(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</Highlight></CodeLine>
<Link id="l01472" /><CodeLine lineNumber="1472"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01473" /><CodeLine lineNumber="1473"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01474" /><CodeLine lineNumber="1474"><Highlight kind="normal">    HardenPostLoad.<a href="/docs/api/classes/llvm/smallptrsetimplbase/#a16413f1a88d8baca228d0a1b4cc0bfc6">clear</a>();</Highlight></CodeLine>
<Link id="l01475" /><CodeLine lineNumber="1475"><Highlight kind="normal">    HardenLoadAddr.<a href="/docs/api/classes/llvm/smallptrsetimplbase/#a16413f1a88d8baca228d0a1b4cc0bfc6">clear</a>();</Highlight></CodeLine>
<Link id="l01476" /><CodeLine lineNumber="1476"><Highlight kind="normal">    HardenedAddrRegs.<a href="/docs/api/classes/llvm/smallset/#a76b3fc7c102561fb5210d5151531e409">clear</a>();</Highlight></CodeLine>
<Link id="l01477" /><CodeLine lineNumber="1477"><Highlight kind="normal">    AddrRegToHardenedReg.<a href="/docs/api/classes/llvm/densemapbase/#adf4e7878fc0b3b8dcde545178564190d">clear</a>();</Highlight></CodeLine>
<Link id="l01478" /><CodeLine lineNumber="1478"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01479" /><CodeLine lineNumber="1479"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Currently, we only track data-dependent loads within a basic block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01480" /><CodeLine lineNumber="1480"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// FIXME: We should see if this is necessary or if we could be more</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01481" /><CodeLine lineNumber="1481"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// aggressive here without opening up attack avenues.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01482" /><CodeLine lineNumber="1482"><Highlight kind="normal">    LoadDepRegs.<a href="/docs/api/classes/llvm/sparsebitvector/#a4f223ae1e481ce22245c3c7c7736dbe9">clear</a>();</Highlight></CodeLine>
<Link id="l01483" /><CodeLine lineNumber="1483"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01484" /><CodeLine lineNumber="1484"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01485" /><CodeLine lineNumber="1485"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l01486" /><CodeLine lineNumber="1486"><Highlight kind="comment">/// Save EFLAGS into the returned GPR. This can in turn be restored with</Highlight></CodeLine>
<Link id="l01487" /><CodeLine lineNumber="1487"><Highlight kind="comment">/// &#96;restoreEFLAGS&#96;.</Highlight></CodeLine>
<Link id="l01488" /><CodeLine lineNumber="1488"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01489" /><CodeLine lineNumber="1489"><Highlight kind="comment">/// Note that LLVM can only lower very simple patterns of saved and restored</Highlight></CodeLine>
<Link id="l01490" /><CodeLine lineNumber="1490"><Highlight kind="comment">/// EFLAGS registers. The restore should always be within the same basic block</Highlight></CodeLine>
<Link id="l01491" /><CodeLine lineNumber="1491"><Highlight kind="comment">/// as the save so that no PHI nodes are inserted.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01492" /><CodeLine lineNumber="1492"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> X86SpeculativeLoadHardeningPass::saveEFLAGS(</Highlight></CodeLine>
<Link id="l01493" /><CodeLine lineNumber="1493"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> InsertPt,</Highlight></CodeLine>
<Link id="l01494" /><CodeLine lineNumber="1494"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> &amp;<a href="/docs/api/namespaces/llvm/loc">Loc</a>) &#123;</Highlight></CodeLine>
<Link id="l01495" /><CodeLine lineNumber="1495"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// FIXME: Hard coding this to a 32-bit register class seems weird, but matches</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01496" /><CodeLine lineNumber="1496"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// what instruction selection does.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01497" /><CodeLine lineNumber="1497"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/register">Register</a> <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a> = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(&amp;X86::GR32RegClass);</Highlight></CodeLine>
<Link id="l01498" /><CodeLine lineNumber="1498"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We directly copy the FLAGS register and rely on later lowering to clean</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01499" /><CodeLine lineNumber="1499"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// this up into the appropriate setCC instructions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01500" /><CodeLine lineNumber="1500"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::COPY), <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>).<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(X86::EFLAGS);</Highlight></CodeLine>
<Link id="l01501" /><CodeLine lineNumber="1501"><Highlight kind="normal">  ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l01502" /><CodeLine lineNumber="1502"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>;</Highlight></CodeLine>
<Link id="l01503" /><CodeLine lineNumber="1503"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01504" /><CodeLine lineNumber="1504"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l01505" /><CodeLine lineNumber="1505"><Highlight kind="comment">/// Restore EFLAGS from the provided GPR. This should be produced by</Highlight></CodeLine>
<Link id="l01506" /><CodeLine lineNumber="1506"><Highlight kind="comment">/// &#96;saveEFLAGS&#96;.</Highlight></CodeLine>
<Link id="l01507" /><CodeLine lineNumber="1507"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01508" /><CodeLine lineNumber="1508"><Highlight kind="comment">/// This must be done within the same basic block as the save in order to</Highlight></CodeLine>
<Link id="l01509" /><CodeLine lineNumber="1509"><Highlight kind="comment">/// reliably lower.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01510" /><CodeLine lineNumber="1510"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> X86SpeculativeLoadHardeningPass::restoreEFLAGS(</Highlight></CodeLine>
<Link id="l01511" /><CodeLine lineNumber="1511"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> InsertPt,</Highlight></CodeLine>
<Link id="l01512" /><CodeLine lineNumber="1512"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> &amp;<a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/classes/llvm/register">Register</a> <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>) &#123;</Highlight></CodeLine>
<Link id="l01513" /><CodeLine lineNumber="1513"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::COPY), X86::EFLAGS).<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>);</Highlight></CodeLine>
<Link id="l01514" /><CodeLine lineNumber="1514"><Highlight kind="normal">  ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l01515" /><CodeLine lineNumber="1515"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01516" /><CodeLine lineNumber="1516"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l01517" /><CodeLine lineNumber="1517"><Highlight kind="comment">/// Takes the current predicate state (in a register) and merges it into the</Highlight></CodeLine>
<Link id="l01518" /><CodeLine lineNumber="1518"><Highlight kind="comment">/// stack pointer. The state is essentially a single bit, but we merge this in</Highlight></CodeLine>
<Link id="l01519" /><CodeLine lineNumber="1519"><Highlight kind="comment">/// a way that won&#39;t form non-canonical pointers and also will be preserved</Highlight></CodeLine>
<Link id="l01520" /><CodeLine lineNumber="1520"><Highlight kind="comment">/// across normal stack adjustments.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01521" /><CodeLine lineNumber="1521"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> X86SpeculativeLoadHardeningPass::mergePredStateIntoSP(</Highlight></CodeLine>
<Link id="l01522" /><CodeLine lineNumber="1522"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> InsertPt,</Highlight></CodeLine>
<Link id="l01523" /><CodeLine lineNumber="1523"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> &amp;<a href="/docs/api/namespaces/llvm/loc">Loc</a>, </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> PredStateReg) &#123;</Highlight></CodeLine>
<Link id="l01524" /><CodeLine lineNumber="1524"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/register">Register</a> TmpReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(PS-&gt;RC);</Highlight></CodeLine>
<Link id="l01525" /><CodeLine lineNumber="1525"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// FIXME: This hard codes a shift distance based on the number of bits needed</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01526" /><CodeLine lineNumber="1526"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// to stay canonical on 64-bit. We should compute this somehow and support</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01527" /><CodeLine lineNumber="1527"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// 32-bit as part of that.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01528" /><CodeLine lineNumber="1528"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> ShiftI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::SHL64ri), TmpReg)</Highlight></CodeLine>
<Link id="l01529" /><CodeLine lineNumber="1529"><Highlight kind="normal">                    .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(PredStateReg, <a href="/docs/api/namespaces/llvm/regstate/#ade26fe5c9b3fe6948def36f7ca12dfc5a9ddde91ef09476d28a088fe57f8e2921">RegState::Kill</a>)</Highlight></CodeLine>
<Link id="l01530" /><CodeLine lineNumber="1530"><Highlight kind="normal">                    .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(47);</Highlight></CodeLine>
<Link id="l01531" /><CodeLine lineNumber="1531"><Highlight kind="normal">  ShiftI-&gt;<a href="/docs/api/classes/llvm/machineinstr/#afda2c0f22be043ae42b0ec71b661f565">addRegisterDead</a>(X86::EFLAGS, <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>);</Highlight></CodeLine>
<Link id="l01532" /><CodeLine lineNumber="1532"><Highlight kind="normal">  ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l01533" /><CodeLine lineNumber="1533"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> OrI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::OR64rr), X86::RSP)</Highlight></CodeLine>
<Link id="l01534" /><CodeLine lineNumber="1534"><Highlight kind="normal">                 .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(X86::RSP)</Highlight></CodeLine>
<Link id="l01535" /><CodeLine lineNumber="1535"><Highlight kind="normal">                 .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(TmpReg, <a href="/docs/api/namespaces/llvm/regstate/#ade26fe5c9b3fe6948def36f7ca12dfc5a9ddde91ef09476d28a088fe57f8e2921">RegState::Kill</a>);</Highlight></CodeLine>
<Link id="l01536" /><CodeLine lineNumber="1536"><Highlight kind="normal">  OrI-&gt;<a href="/docs/api/classes/llvm/machineinstr/#afda2c0f22be043ae42b0ec71b661f565">addRegisterDead</a>(X86::EFLAGS, <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>);</Highlight></CodeLine>
<Link id="l01537" /><CodeLine lineNumber="1537"><Highlight kind="normal">  ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l01538" /><CodeLine lineNumber="1538"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01539" /><CodeLine lineNumber="1539"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l01540" /><CodeLine lineNumber="1540"><Highlight kind="comment">/// Extracts the predicate state stored in the high bits of the stack pointer.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01541" /><CodeLine lineNumber="1541"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> X86SpeculativeLoadHardeningPass::extractPredStateFromSP(</Highlight></CodeLine>
<Link id="l01542" /><CodeLine lineNumber="1542"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> InsertPt,</Highlight></CodeLine>
<Link id="l01543" /><CodeLine lineNumber="1543"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> &amp;<a href="/docs/api/namespaces/llvm/loc">Loc</a>) &#123;</Highlight></CodeLine>
<Link id="l01544" /><CodeLine lineNumber="1544"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/register">Register</a> PredStateReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(PS-&gt;RC);</Highlight></CodeLine>
<Link id="l01545" /><CodeLine lineNumber="1545"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/register">Register</a> TmpReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(PS-&gt;RC);</Highlight></CodeLine>
<Link id="l01546" /><CodeLine lineNumber="1546"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01547" /><CodeLine lineNumber="1547"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We know that the stack pointer will have any preserved predicate state in</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01548" /><CodeLine lineNumber="1548"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// its high bit. We just want to smear this across the other bits. Turns out,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01549" /><CodeLine lineNumber="1549"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// this is exactly what an arithmetic right shift does.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01550" /><CodeLine lineNumber="1550"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(TargetOpcode::COPY), TmpReg)</Highlight></CodeLine>
<Link id="l01551" /><CodeLine lineNumber="1551"><Highlight kind="normal">      .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(X86::RSP);</Highlight></CodeLine>
<Link id="l01552" /><CodeLine lineNumber="1552"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> ShiftI =</Highlight></CodeLine>
<Link id="l01553" /><CodeLine lineNumber="1553"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::SAR64ri), PredStateReg)</Highlight></CodeLine>
<Link id="l01554" /><CodeLine lineNumber="1554"><Highlight kind="normal">          .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(TmpReg, <a href="/docs/api/namespaces/llvm/regstate/#ade26fe5c9b3fe6948def36f7ca12dfc5a9ddde91ef09476d28a088fe57f8e2921">RegState::Kill</a>)</Highlight></CodeLine>
<Link id="l01555" /><CodeLine lineNumber="1555"><Highlight kind="normal">          .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>-&gt;getRegSizeInBits(&#42;PS-&gt;RC) - 1);</Highlight></CodeLine>
<Link id="l01556" /><CodeLine lineNumber="1556"><Highlight kind="normal">  ShiftI-&gt;<a href="/docs/api/classes/llvm/machineinstr/#afda2c0f22be043ae42b0ec71b661f565">addRegisterDead</a>(X86::EFLAGS, <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>);</Highlight></CodeLine>
<Link id="l01557" /><CodeLine lineNumber="1557"><Highlight kind="normal">  ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l01558" /><CodeLine lineNumber="1558"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01559" /><CodeLine lineNumber="1559"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> PredStateReg;</Highlight></CodeLine>
<Link id="l01560" /><CodeLine lineNumber="1560"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01561" /><CodeLine lineNumber="1561"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01562" /><CodeLine lineNumber="1562"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> X86SpeculativeLoadHardeningPass::hardenLoadAddr(</Highlight></CodeLine>
<Link id="l01563" /><CodeLine lineNumber="1563"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>, <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;BaseMO, <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;IndexMO,</Highlight></CodeLine>
<Link id="l01564" /><CodeLine lineNumber="1564"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;unsigned, unsigned, 32&gt;</a> &amp;AddrRegToHardenedReg) &#123;</Highlight></CodeLine>
<Link id="l01565" /><CodeLine lineNumber="1565"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> = &#42;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getParent();</Highlight></CodeLine>
<Link id="l01566" /><CodeLine lineNumber="1566"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> &amp;<a href="/docs/api/namespaces/llvm/loc">Loc</a> = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getDebugLoc();</Highlight></CodeLine>
<Link id="l01567" /><CodeLine lineNumber="1567"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01568" /><CodeLine lineNumber="1568"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Check if EFLAGS are alive by seeing if there is a def of them or they</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01569" /><CodeLine lineNumber="1569"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// live-in, and then seeing if that def is in turn used.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01570" /><CodeLine lineNumber="1570"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> EFLAGSLive = <a href="#a93f8e5dacbcd949d688c3af5f491468d">isEFLAGSLive</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getIterator(), &#42;<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>);</Highlight></CodeLine>
<Link id="l01571" /><CodeLine lineNumber="1571"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01572" /><CodeLine lineNumber="1572"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineOperand &#42;, 2&gt;</a> HardenOpRegs;</Highlight></CodeLine>
<Link id="l01573" /><CodeLine lineNumber="1573"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01574" /><CodeLine lineNumber="1574"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#ad7213433bd60dc33020246384dc18b9b">isFI</a>()) &#123;</Highlight></CodeLine>
<Link id="l01575" /><CodeLine lineNumber="1575"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// A frame index is never a dynamically controllable load, so only</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01576" /><CodeLine lineNumber="1576"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// harden it if we&#39;re covering fixed address loads as well.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01577" /><CodeLine lineNumber="1577"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(</Highlight></CodeLine>
<Link id="l01578" /><CodeLine lineNumber="1578"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Skipping hardening base of explicit stack frame load: &quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01579" /><CodeLine lineNumber="1579"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01580" /><CodeLine lineNumber="1580"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() == X86::RSP) &#123;</Highlight></CodeLine>
<Link id="l01581" /><CodeLine lineNumber="1581"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Some idempotent atomic operations are lowered directly to a locked</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01582" /><CodeLine lineNumber="1582"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// OR with 0 to the top of stack(or slightly offset from top) which uses an</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01583" /><CodeLine lineNumber="1583"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// explicit RSP register as the base.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01584" /><CodeLine lineNumber="1584"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(IndexMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() == X86::NoRegister &amp;&amp;</Highlight></CodeLine>
<Link id="l01585" /><CodeLine lineNumber="1585"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;Explicit RSP access with dynamic index!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01586" /><CodeLine lineNumber="1586"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(</Highlight></CodeLine>
<Link id="l01587" /><CodeLine lineNumber="1587"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Cannot harden base of explicit RSP offset in a load!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01588" /><CodeLine lineNumber="1588"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() == X86::RIP ||</Highlight></CodeLine>
<Link id="l01589" /><CodeLine lineNumber="1589"><Highlight kind="normal">             BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() == X86::NoRegister) &#123;</Highlight></CodeLine>
<Link id="l01590" /><CodeLine lineNumber="1590"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// For both RIP-relative addressed loads or absolute loads, we cannot</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01591" /><CodeLine lineNumber="1591"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// meaningfully harden them because the address being loaded has no</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01592" /><CodeLine lineNumber="1592"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// dynamic component.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01593" /><CodeLine lineNumber="1593"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01594" /><CodeLine lineNumber="1594"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// FIXME: When using a segment base (like TLS does) we end up with the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01595" /><CodeLine lineNumber="1595"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// dynamic address being the base plus -1 because we can&#39;t mutate the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01596" /><CodeLine lineNumber="1596"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// segment register here. This allows the signed 32-bit offset to point at</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01597" /><CodeLine lineNumber="1597"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// valid segment-relative addresses and load them successfully.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01598" /><CodeLine lineNumber="1598"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(</Highlight></CodeLine>
<Link id="l01599" /><CodeLine lineNumber="1599"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Cannot harden base of &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01600" /><CodeLine lineNumber="1600"><Highlight kind="normal">               &lt;&lt; (BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() == X86::RIP ? </Highlight><Highlight kind="stringliteral">&quot;RIP-relative&quot;</Highlight><Highlight kind="normal"> : </Highlight><Highlight kind="stringliteral">&quot;no-base&quot;</Highlight><Highlight kind="normal">)</Highlight></CodeLine>
<Link id="l01601" /><CodeLine lineNumber="1601"><Highlight kind="normal">               &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; address in a load!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01602" /><CodeLine lineNumber="1602"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l01603" /><CodeLine lineNumber="1603"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#a4c9594c955fec80c73ddd964b5efd554">isReg</a>() &amp;&amp;</Highlight></CodeLine>
<Link id="l01604" /><CodeLine lineNumber="1604"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;Only allowed to have a frame index or register base.&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01605" /><CodeLine lineNumber="1605"><Highlight kind="normal">    HardenOpRegs.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&amp;BaseMO);</Highlight></CodeLine>
<Link id="l01606" /><CodeLine lineNumber="1606"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01607" /><CodeLine lineNumber="1607"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01608" /><CodeLine lineNumber="1608"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (IndexMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() != X86::NoRegister &amp;&amp;</Highlight></CodeLine>
<Link id="l01609" /><CodeLine lineNumber="1609"><Highlight kind="normal">      (HardenOpRegs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>() ||</Highlight></CodeLine>
<Link id="l01610" /><CodeLine lineNumber="1610"><Highlight kind="normal">       HardenOpRegs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a58dc840fc84420b7f0b773794b8101c1">front</a>()-&gt;getReg() != IndexMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>()))</Highlight></CodeLine>
<Link id="l01611" /><CodeLine lineNumber="1611"><Highlight kind="normal">    HardenOpRegs.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&amp;IndexMO);</Highlight></CodeLine>
<Link id="l01612" /><CodeLine lineNumber="1612"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01613" /><CodeLine lineNumber="1613"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((HardenOpRegs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() == 1 || HardenOpRegs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() == 2) &amp;&amp;</Highlight></CodeLine>
<Link id="l01614" /><CodeLine lineNumber="1614"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;Should have exactly one or two registers to harden!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01615" /><CodeLine lineNumber="1615"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((HardenOpRegs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() == 1 ||</Highlight></CodeLine>
<Link id="l01616" /><CodeLine lineNumber="1616"><Highlight kind="normal">          HardenOpRegs&#91;0&#93;-&gt;getReg() != HardenOpRegs&#91;1&#93;-&gt;getReg()) &amp;&amp;</Highlight></CodeLine>
<Link id="l01617" /><CodeLine lineNumber="1617"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;Should not have two of the same registers!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01618" /><CodeLine lineNumber="1618"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01619" /><CodeLine lineNumber="1619"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Remove any registers that have alreaded been checked.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01620" /><CodeLine lineNumber="1620"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#ac9a7de5a04920954ac964059cfc428ad">llvm::erase&#95;if</a>(HardenOpRegs, &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &#42;<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>) &#123;</Highlight></CodeLine>
<Link id="l01621" /><CodeLine lineNumber="1621"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// See if this operand&#39;s register has already been checked.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01622" /><CodeLine lineNumber="1622"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> It = AddrRegToHardenedReg.<a href="/docs/api/classes/llvm/densemapbase/#a0c047f127ed4380a6f383d70bec4eb94">find</a>(<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>-&gt;getReg());</Highlight></CodeLine>
<Link id="l01623" /><CodeLine lineNumber="1623"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (It == AddrRegToHardenedReg.<a href="/docs/api/classes/llvm/densemapbase/#a65520b9c67759099e313d0f4e7b5ff9e">end</a>())</Highlight></CodeLine>
<Link id="l01624" /><CodeLine lineNumber="1624"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Not checked, so retain this one.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01625" /><CodeLine lineNumber="1625"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01626" /><CodeLine lineNumber="1626"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01627" /><CodeLine lineNumber="1627"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Otherwise, we can directly update this operand and remove it.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01628" /><CodeLine lineNumber="1628"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>-&gt;setReg(It-&gt;second);</Highlight></CodeLine>
<Link id="l01629" /><CodeLine lineNumber="1629"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01630" /><CodeLine lineNumber="1630"><Highlight kind="normal">  &#125;);</Highlight></CodeLine>
<Link id="l01631" /><CodeLine lineNumber="1631"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If there are none left, we&#39;re done.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01632" /><CodeLine lineNumber="1632"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (HardenOpRegs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>())</Highlight></CodeLine>
<Link id="l01633" /><CodeLine lineNumber="1633"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01634" /><CodeLine lineNumber="1634"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01635" /><CodeLine lineNumber="1635"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Compute the current predicate state.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01636" /><CodeLine lineNumber="1636"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/register">Register</a> StateReg = PS-&gt;SSA.GetValueAtEndOfBlock(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</Highlight></CodeLine>
<Link id="l01637" /><CodeLine lineNumber="1637"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01638" /><CodeLine lineNumber="1638"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> InsertPt = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getIterator();</Highlight></CodeLine>
<Link id="l01639" /><CodeLine lineNumber="1639"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01640" /><CodeLine lineNumber="1640"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If EFLAGS are live and we don&#39;t have access to instructions that avoid</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01641" /><CodeLine lineNumber="1641"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// clobbering EFLAGS we need to save and restore them. This in turn makes</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01642" /><CodeLine lineNumber="1642"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the EFLAGS no longer live.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01643" /><CodeLine lineNumber="1643"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> FlagsReg = 0;</Highlight></CodeLine>
<Link id="l01644" /><CodeLine lineNumber="1644"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (EFLAGSLive &amp;&amp; !Subtarget-&gt;hasBMI2()) &#123;</Highlight></CodeLine>
<Link id="l01645" /><CodeLine lineNumber="1645"><Highlight kind="normal">    EFLAGSLive = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01646" /><CodeLine lineNumber="1646"><Highlight kind="normal">    FlagsReg = saveEFLAGS(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>);</Highlight></CodeLine>
<Link id="l01647" /><CodeLine lineNumber="1647"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01648" /><CodeLine lineNumber="1648"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01649" /><CodeLine lineNumber="1649"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &#42;<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a> : HardenOpRegs) &#123;</Highlight></CodeLine>
<Link id="l01650" /><CodeLine lineNumber="1650"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/register">Register</a> OpReg = <a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>-&gt;getReg();</Highlight></CodeLine>
<Link id="l01651" /><CodeLine lineNumber="1651"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;OpRC = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;getRegClass(OpReg);</Highlight></CodeLine>
<Link id="l01652" /><CodeLine lineNumber="1652"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/register">Register</a> TmpReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(OpRC);</Highlight></CodeLine>
<Link id="l01653" /><CodeLine lineNumber="1653"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01654" /><CodeLine lineNumber="1654"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If this is a vector register, we&#39;ll need somewhat custom logic to handle</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01655" /><CodeLine lineNumber="1655"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// hardening it.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01656" /><CodeLine lineNumber="1656"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!Subtarget-&gt;hasVLX() &amp;&amp; (OpRC-&gt;hasSuperClassEq(&amp;X86::VR128RegClass) ||</Highlight></CodeLine>
<Link id="l01657" /><CodeLine lineNumber="1657"><Highlight kind="normal">                                 OpRC-&gt;hasSuperClassEq(&amp;X86::VR256RegClass))) &#123;</Highlight></CodeLine>
<Link id="l01658" /><CodeLine lineNumber="1658"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Subtarget-&gt;hasAVX2() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;AVX2-specific register classes!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01659" /><CodeLine lineNumber="1659"><Highlight kind="normal">      </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/systemzii/#af95a60521e541cc7a0f27971c1e83a3aa85ee30c33ec729f12da52e3accbf7078">Is128Bit</a> = OpRC-&gt;hasSuperClassEq(&amp;X86::VR128RegClass);</Highlight></CodeLine>
<Link id="l01660" /><CodeLine lineNumber="1660"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01661" /><CodeLine lineNumber="1661"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Move our state into a vector register.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01662" /><CodeLine lineNumber="1662"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// FIXME: We could skip this at the cost of longer encodings with AVX-512</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01663" /><CodeLine lineNumber="1663"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// but that doesn&#39;t seem likely worth it.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01664" /><CodeLine lineNumber="1664"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/register">Register</a> VStateReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(&amp;X86::VR128RegClass);</Highlight></CodeLine>
<Link id="l01665" /><CodeLine lineNumber="1665"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> MovI =</Highlight></CodeLine>
<Link id="l01666" /><CodeLine lineNumber="1666"><Highlight kind="normal">          <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::VMOV64toPQIrr), VStateReg)</Highlight></CodeLine>
<Link id="l01667" /><CodeLine lineNumber="1667"><Highlight kind="normal">              .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(StateReg);</Highlight></CodeLine>
<Link id="l01668" /><CodeLine lineNumber="1668"><Highlight kind="normal">      (void)MovI;</Highlight></CodeLine>
<Link id="l01669" /><CodeLine lineNumber="1669"><Highlight kind="normal">      ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l01670" /><CodeLine lineNumber="1670"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Inserting mov: &quot;</Highlight><Highlight kind="normal">; MovI-&gt;dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01671" /><CodeLine lineNumber="1671"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01672" /><CodeLine lineNumber="1672"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Broadcast it across the vector register.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01673" /><CodeLine lineNumber="1673"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/register">Register</a> VBStateReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(OpRC);</Highlight></CodeLine>
<Link id="l01674" /><CodeLine lineNumber="1674"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> BroadcastI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>,</Highlight></CodeLine>
<Link id="l01675" /><CodeLine lineNumber="1675"><Highlight kind="normal">                                <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(Is128Bit ? X86::VPBROADCASTQrr</Highlight></CodeLine>
<Link id="l01676" /><CodeLine lineNumber="1676"><Highlight kind="normal">                                                  : X86::VPBROADCASTQYrr),</Highlight></CodeLine>
<Link id="l01677" /><CodeLine lineNumber="1677"><Highlight kind="normal">                                VBStateReg)</Highlight></CodeLine>
<Link id="l01678" /><CodeLine lineNumber="1678"><Highlight kind="normal">                            .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(VStateReg);</Highlight></CodeLine>
<Link id="l01679" /><CodeLine lineNumber="1679"><Highlight kind="normal">      (void)BroadcastI;</Highlight></CodeLine>
<Link id="l01680" /><CodeLine lineNumber="1680"><Highlight kind="normal">      ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l01681" /><CodeLine lineNumber="1681"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Inserting broadcast: &quot;</Highlight><Highlight kind="normal">; BroadcastI-&gt;dump();</Highlight></CodeLine>
<Link id="l01682" /><CodeLine lineNumber="1682"><Highlight kind="normal">                 <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01683" /><CodeLine lineNumber="1683"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01684" /><CodeLine lineNumber="1684"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Merge our potential poison state into the value with a vector or.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01685" /><CodeLine lineNumber="1685"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> OrI =</Highlight></CodeLine>
<Link id="l01686" /><CodeLine lineNumber="1686"><Highlight kind="normal">          <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>,</Highlight></CodeLine>
<Link id="l01687" /><CodeLine lineNumber="1687"><Highlight kind="normal">                  <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(Is128Bit ? X86::VPORrr : X86::VPORYrr), TmpReg)</Highlight></CodeLine>
<Link id="l01688" /><CodeLine lineNumber="1688"><Highlight kind="normal">              .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(VBStateReg)</Highlight></CodeLine>
<Link id="l01689" /><CodeLine lineNumber="1689"><Highlight kind="normal">              .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(OpReg);</Highlight></CodeLine>
<Link id="l01690" /><CodeLine lineNumber="1690"><Highlight kind="normal">      (void)OrI;</Highlight></CodeLine>
<Link id="l01691" /><CodeLine lineNumber="1691"><Highlight kind="normal">      ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l01692" /><CodeLine lineNumber="1692"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Inserting or: &quot;</Highlight><Highlight kind="normal">; OrI-&gt;dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01693" /><CodeLine lineNumber="1693"><Highlight kind="normal">    &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (OpRC-&gt;hasSuperClassEq(&amp;X86::VR128XRegClass) ||</Highlight></CodeLine>
<Link id="l01694" /><CodeLine lineNumber="1694"><Highlight kind="normal">               OpRC-&gt;hasSuperClassEq(&amp;X86::VR256XRegClass) ||</Highlight></CodeLine>
<Link id="l01695" /><CodeLine lineNumber="1695"><Highlight kind="normal">               OpRC-&gt;hasSuperClassEq(&amp;X86::VR512RegClass)) &#123;</Highlight></CodeLine>
<Link id="l01696" /><CodeLine lineNumber="1696"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Subtarget-&gt;hasAVX512() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;AVX512-specific register classes!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01697" /><CodeLine lineNumber="1697"><Highlight kind="normal">      </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/systemzii/#af95a60521e541cc7a0f27971c1e83a3aa85ee30c33ec729f12da52e3accbf7078">Is128Bit</a> = OpRC-&gt;hasSuperClassEq(&amp;X86::VR128XRegClass);</Highlight></CodeLine>
<Link id="l01698" /><CodeLine lineNumber="1698"><Highlight kind="normal">      </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> Is256Bit = OpRC-&gt;hasSuperClassEq(&amp;X86::VR256XRegClass);</Highlight></CodeLine>
<Link id="l01699" /><CodeLine lineNumber="1699"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Is128Bit || Is256Bit)</Highlight></CodeLine>
<Link id="l01700" /><CodeLine lineNumber="1700"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Subtarget-&gt;hasVLX() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;AVX512VL-specific register classes!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01701" /><CodeLine lineNumber="1701"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01702" /><CodeLine lineNumber="1702"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Broadcast our state into a vector register.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01703" /><CodeLine lineNumber="1703"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/register">Register</a> VStateReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(OpRC);</Highlight></CodeLine>
<Link id="l01704" /><CodeLine lineNumber="1704"><Highlight kind="normal">      </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> BroadcastOp = <a href="/docs/api/namespaces/llvm/systemzii/#af95a60521e541cc7a0f27971c1e83a3aa85ee30c33ec729f12da52e3accbf7078">Is128Bit</a> ? X86::VPBROADCASTQrZ128rr</Highlight></CodeLine>
<Link id="l01705" /><CodeLine lineNumber="1705"><Highlight kind="normal">                                      : Is256Bit ? X86::VPBROADCASTQrZ256rr</Highlight></CodeLine>
<Link id="l01706" /><CodeLine lineNumber="1706"><Highlight kind="normal">                                                 : X86::VPBROADCASTQrZrr;</Highlight></CodeLine>
<Link id="l01707" /><CodeLine lineNumber="1707"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> BroadcastI =</Highlight></CodeLine>
<Link id="l01708" /><CodeLine lineNumber="1708"><Highlight kind="normal">          <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(BroadcastOp), VStateReg)</Highlight></CodeLine>
<Link id="l01709" /><CodeLine lineNumber="1709"><Highlight kind="normal">              .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(StateReg);</Highlight></CodeLine>
<Link id="l01710" /><CodeLine lineNumber="1710"><Highlight kind="normal">      (void)BroadcastI;</Highlight></CodeLine>
<Link id="l01711" /><CodeLine lineNumber="1711"><Highlight kind="normal">      ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l01712" /><CodeLine lineNumber="1712"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Inserting broadcast: &quot;</Highlight><Highlight kind="normal">; BroadcastI-&gt;dump();</Highlight></CodeLine>
<Link id="l01713" /><CodeLine lineNumber="1713"><Highlight kind="normal">                 <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01714" /><CodeLine lineNumber="1714"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01715" /><CodeLine lineNumber="1715"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Merge our potential poison state into the value with a vector or.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01716" /><CodeLine lineNumber="1716"><Highlight kind="normal">      </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> OrOp = <a href="/docs/api/namespaces/llvm/systemzii/#af95a60521e541cc7a0f27971c1e83a3aa85ee30c33ec729f12da52e3accbf7078">Is128Bit</a> ? X86::VPORQZ128rr</Highlight></CodeLine>
<Link id="l01717" /><CodeLine lineNumber="1717"><Highlight kind="normal">                               : Is256Bit ? X86::VPORQZ256rr : X86::VPORQZrr;</Highlight></CodeLine>
<Link id="l01718" /><CodeLine lineNumber="1718"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> OrI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(OrOp), TmpReg)</Highlight></CodeLine>
<Link id="l01719" /><CodeLine lineNumber="1719"><Highlight kind="normal">                     .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(VStateReg)</Highlight></CodeLine>
<Link id="l01720" /><CodeLine lineNumber="1720"><Highlight kind="normal">                     .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(OpReg);</Highlight></CodeLine>
<Link id="l01721" /><CodeLine lineNumber="1721"><Highlight kind="normal">      (void)OrI;</Highlight></CodeLine>
<Link id="l01722" /><CodeLine lineNumber="1722"><Highlight kind="normal">      ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l01723" /><CodeLine lineNumber="1723"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Inserting or: &quot;</Highlight><Highlight kind="normal">; OrI-&gt;dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01724" /><CodeLine lineNumber="1724"><Highlight kind="normal">    &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l01725" /><CodeLine lineNumber="1725"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// FIXME: Need to support GR32 here for 32-bit code.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01726" /><CodeLine lineNumber="1726"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(OpRC-&gt;hasSuperClassEq(&amp;X86::GR64RegClass) &amp;&amp;</Highlight></CodeLine>
<Link id="l01727" /><CodeLine lineNumber="1727"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;Not a supported register class for address hardening!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01728" /><CodeLine lineNumber="1728"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01729" /><CodeLine lineNumber="1729"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!EFLAGSLive) &#123;</Highlight></CodeLine>
<Link id="l01730" /><CodeLine lineNumber="1730"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Merge our potential poison state into the value with an or.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01731" /><CodeLine lineNumber="1731"><Highlight kind="normal">        </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> OrI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::OR64rr), TmpReg)</Highlight></CodeLine>
<Link id="l01732" /><CodeLine lineNumber="1732"><Highlight kind="normal">                       .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(StateReg)</Highlight></CodeLine>
<Link id="l01733" /><CodeLine lineNumber="1733"><Highlight kind="normal">                       .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(OpReg);</Highlight></CodeLine>
<Link id="l01734" /><CodeLine lineNumber="1734"><Highlight kind="normal">        OrI-&gt;<a href="/docs/api/classes/llvm/machineinstr/#afda2c0f22be043ae42b0ec71b661f565">addRegisterDead</a>(X86::EFLAGS, <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>);</Highlight></CodeLine>
<Link id="l01735" /><CodeLine lineNumber="1735"><Highlight kind="normal">        ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l01736" /><CodeLine lineNumber="1736"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Inserting or: &quot;</Highlight><Highlight kind="normal">; OrI-&gt;dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01737" /><CodeLine lineNumber="1737"><Highlight kind="normal">      &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l01738" /><CodeLine lineNumber="1738"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// We need to avoid touching EFLAGS so shift out all but the least</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01739" /><CodeLine lineNumber="1739"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// significant bit using the instruction that doesn&#39;t update flags.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01740" /><CodeLine lineNumber="1740"><Highlight kind="normal">        </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> ShiftI =</Highlight></CodeLine>
<Link id="l01741" /><CodeLine lineNumber="1741"><Highlight kind="normal">            <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::SHRX64rr), TmpReg)</Highlight></CodeLine>
<Link id="l01742" /><CodeLine lineNumber="1742"><Highlight kind="normal">                .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(OpReg)</Highlight></CodeLine>
<Link id="l01743" /><CodeLine lineNumber="1743"><Highlight kind="normal">                .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(StateReg);</Highlight></CodeLine>
<Link id="l01744" /><CodeLine lineNumber="1744"><Highlight kind="normal">        (void)ShiftI;</Highlight></CodeLine>
<Link id="l01745" /><CodeLine lineNumber="1745"><Highlight kind="normal">        ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l01746" /><CodeLine lineNumber="1746"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Inserting shrx: &quot;</Highlight><Highlight kind="normal">; ShiftI-&gt;dump();</Highlight></CodeLine>
<Link id="l01747" /><CodeLine lineNumber="1747"><Highlight kind="normal">                   <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01748" /><CodeLine lineNumber="1748"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l01749" /><CodeLine lineNumber="1749"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01750" /><CodeLine lineNumber="1750"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01751" /><CodeLine lineNumber="1751"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Record this register as checked and update the operand.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01752" /><CodeLine lineNumber="1752"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!AddrRegToHardenedReg.<a href="/docs/api/classes/llvm/densemapbase/#a53408c95a7bfb5443b43fb2134c3eb23">count</a>(<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>-&gt;getReg()) &amp;&amp;</Highlight></CodeLine>
<Link id="l01753" /><CodeLine lineNumber="1753"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;Should not have checked this register yet!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01754" /><CodeLine lineNumber="1754"><Highlight kind="normal">    AddrRegToHardenedReg&#91;<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>-&gt;getReg()&#93; = TmpReg;</Highlight></CodeLine>
<Link id="l01755" /><CodeLine lineNumber="1755"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>-&gt;setReg(TmpReg);</Highlight></CodeLine>
<Link id="l01756" /><CodeLine lineNumber="1756"><Highlight kind="normal">    ++NumAddrRegsHardened;</Highlight></CodeLine>
<Link id="l01757" /><CodeLine lineNumber="1757"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01758" /><CodeLine lineNumber="1758"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01759" /><CodeLine lineNumber="1759"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// And restore the flags if needed.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01760" /><CodeLine lineNumber="1760"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (FlagsReg)</Highlight></CodeLine>
<Link id="l01761" /><CodeLine lineNumber="1761"><Highlight kind="normal">    restoreEFLAGS(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, FlagsReg);</Highlight></CodeLine>
<Link id="l01762" /><CodeLine lineNumber="1762"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01763" /><CodeLine lineNumber="1763"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01764" /><CodeLine lineNumber="1764"><Highlight kind="normal"><a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;X86SpeculativeLoadHardeningPass::sinkPostLoadHardenedInst(</Highlight></CodeLine>
<Link id="l01765" /><CodeLine lineNumber="1765"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;InitialMI, <a href="/docs/api/classes/llvm/smallptrsetimpl">SmallPtrSetImpl&lt;MachineInstr &#42;&gt;</a> &amp;HardenedInstrs) &#123;</Highlight></CodeLine>
<Link id="l01766" /><CodeLine lineNumber="1766"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/llvm/x86instrinfo/#a34662990aab5992b0b1ee00a4dd4ad34">X86InstrInfo::isDataInvariantLoad</a>(InitialMI) &amp;&amp;</Highlight></CodeLine>
<Link id="l01767" /><CodeLine lineNumber="1767"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;Cannot get here with a non-invariant load!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01768" /><CodeLine lineNumber="1768"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="#ac0e27a6dfaf334669f95954dee3d5920">isEFLAGSDefLive</a>(InitialMI) &amp;&amp;</Highlight></CodeLine>
<Link id="l01769" /><CodeLine lineNumber="1769"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;Cannot get here with a data invariant load &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01770" /><CodeLine lineNumber="1770"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;that interferes with EFLAGS!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01771" /><CodeLine lineNumber="1771"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01772" /><CodeLine lineNumber="1772"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// See if we can sink hardening the loaded value.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01773" /><CodeLine lineNumber="1773"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> SinkCheckToSingleUse =</Highlight></CodeLine>
<Link id="l01774" /><CodeLine lineNumber="1774"><Highlight kind="normal">      &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) -&gt; std::optional&lt;MachineInstr &#42;&gt; &#123;</Highlight></CodeLine>
<Link id="l01775" /><CodeLine lineNumber="1775"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/register">Register</a> DefReg = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(0).getReg();</Highlight></CodeLine>
<Link id="l01776" /><CodeLine lineNumber="1776"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01777" /><CodeLine lineNumber="1777"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We need to find a single use which we can sink the check. We can</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01778" /><CodeLine lineNumber="1778"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// primarily do this because many uses may already end up checked on their</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01779" /><CodeLine lineNumber="1779"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// own.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01780" /><CodeLine lineNumber="1780"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;SingleUseMI = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01781" /><CodeLine lineNumber="1781"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a> : <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;use&#95;instructions(DefReg)) &#123;</Highlight></CodeLine>
<Link id="l01782" /><CodeLine lineNumber="1782"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// If we&#39;re already going to harden this use, it is data invariant, it</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01783" /><CodeLine lineNumber="1783"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// does not interfere with EFLAGS, and within our block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01784" /><CodeLine lineNumber="1784"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (HardenedInstrs.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>)) &#123;</Highlight></CodeLine>
<Link id="l01785" /><CodeLine lineNumber="1785"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/classes/llvm/x86instrinfo/#a34662990aab5992b0b1ee00a4dd4ad34">X86InstrInfo::isDataInvariantLoad</a>(<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>) || <a href="#ac0e27a6dfaf334669f95954dee3d5920">isEFLAGSDefLive</a>(<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>)) &#123;</Highlight></CodeLine>
<Link id="l01786" /><CodeLine lineNumber="1786"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// If we&#39;ve already decided to harden a non-load, we must have sunk</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01787" /><CodeLine lineNumber="1787"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// some other post-load hardened instruction to it and it must itself</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01788" /><CodeLine lineNumber="1788"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// be data-invariant.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01789" /><CodeLine lineNumber="1789"><Highlight kind="normal">          <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/llvm/x86instrinfo/#ad4539ba2bb699c968f710984d188246f">X86InstrInfo::isDataInvariant</a>(<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>) &amp;&amp;</Highlight></CodeLine>
<Link id="l01790" /><CodeLine lineNumber="1790"><Highlight kind="normal">                 </Highlight><Highlight kind="stringliteral">&quot;Data variant instruction being hardened!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01791" /><CodeLine lineNumber="1791"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01792" /><CodeLine lineNumber="1792"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l01793" /><CodeLine lineNumber="1793"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01794" /><CodeLine lineNumber="1794"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Otherwise, this is a load and the load component can&#39;t be data</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01795" /><CodeLine lineNumber="1795"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// invariant so check how this register is being used.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01796" /><CodeLine lineNumber="1796"><Highlight kind="normal">        </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> MemRefBeginIdx = <a href="/docs/api/namespaces/llvm/x86/#a279395a00a782f7e3d6141bc3328a249">X86::getFirstAddrOperandIdx</a>(<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>);</Highlight></CodeLine>
<Link id="l01797" /><CodeLine lineNumber="1797"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(MemRefBeginIdx &gt;= 0 &amp;&amp;</Highlight></CodeLine>
<Link id="l01798" /><CodeLine lineNumber="1798"><Highlight kind="normal">               </Highlight><Highlight kind="stringliteral">&quot;Should always have mem references here!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01799" /><CodeLine lineNumber="1799"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01800" /><CodeLine lineNumber="1800"><Highlight kind="normal">        <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;BaseMO =</Highlight></CodeLine>
<Link id="l01801" /><CodeLine lineNumber="1801"><Highlight kind="normal">            <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>.getOperand(MemRefBeginIdx + <a href="/docs/api/namespaces/llvm/x86/#a2a5aec578e2e391e99e1705012752d84a319f0e99a1ac9396659683d2638d4f45">X86::AddrBaseReg</a>);</Highlight></CodeLine>
<Link id="l01802" /><CodeLine lineNumber="1802"><Highlight kind="normal">        <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;IndexMO =</Highlight></CodeLine>
<Link id="l01803" /><CodeLine lineNumber="1803"><Highlight kind="normal">            <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>.getOperand(MemRefBeginIdx + <a href="/docs/api/namespaces/llvm/x86/#a2a5aec578e2e391e99e1705012752d84aba7ebe0e28a2c1c4c14343f549c01462">X86::AddrIndexReg</a>);</Highlight></CodeLine>
<Link id="l01804" /><CodeLine lineNumber="1804"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> ((BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#a4c9594c955fec80c73ddd964b5efd554">isReg</a>() &amp;&amp; BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() == DefReg) ||</Highlight></CodeLine>
<Link id="l01805" /><CodeLine lineNumber="1805"><Highlight kind="normal">            (IndexMO.<a href="/docs/api/classes/llvm/machineoperand/#a4c9594c955fec80c73ddd964b5efd554">isReg</a>() &amp;&amp; IndexMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() == DefReg))</Highlight></CodeLine>
<Link id="l01806" /><CodeLine lineNumber="1806"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// The load uses the register as part of its address making it not</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01807" /><CodeLine lineNumber="1807"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// invariant.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01808" /><CodeLine lineNumber="1808"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> &#123;&#125;;</Highlight></CodeLine>
<Link id="l01809" /><CodeLine lineNumber="1809"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01810" /><CodeLine lineNumber="1810"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01811" /><CodeLine lineNumber="1811"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l01812" /><CodeLine lineNumber="1812"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01813" /><CodeLine lineNumber="1813"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SingleUseMI)</Highlight></CodeLine>
<Link id="l01814" /><CodeLine lineNumber="1814"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// We already have a single use, this would make two. Bail.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01815" /><CodeLine lineNumber="1815"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> &#123;&#125;;</Highlight></CodeLine>
<Link id="l01816" /><CodeLine lineNumber="1816"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01817" /><CodeLine lineNumber="1817"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// If this single use isn&#39;t data invariant, isn&#39;t in this block, or has</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01818" /><CodeLine lineNumber="1818"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// interfering EFLAGS, we can&#39;t sink the hardening to it.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01819" /><CodeLine lineNumber="1819"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/classes/llvm/x86instrinfo/#ad4539ba2bb699c968f710984d188246f">X86InstrInfo::isDataInvariant</a>(<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>) || <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>.getParent() != <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getParent() ||</Highlight></CodeLine>
<Link id="l01820" /><CodeLine lineNumber="1820"><Highlight kind="normal">          <a href="#ac0e27a6dfaf334669f95954dee3d5920">isEFLAGSDefLive</a>(<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>))</Highlight></CodeLine>
<Link id="l01821" /><CodeLine lineNumber="1821"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> &#123;&#125;;</Highlight></CodeLine>
<Link id="l01822" /><CodeLine lineNumber="1822"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01823" /><CodeLine lineNumber="1823"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// If this instruction defines multiple registers bail as we won&#39;t harden</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01824" /><CodeLine lineNumber="1824"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// all of them.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01825" /><CodeLine lineNumber="1825"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>.getDesc().getNumDefs() &gt; 1)</Highlight></CodeLine>
<Link id="l01826" /><CodeLine lineNumber="1826"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> &#123;&#125;;</Highlight></CodeLine>
<Link id="l01827" /><CodeLine lineNumber="1827"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01828" /><CodeLine lineNumber="1828"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// If this register isn&#39;t a virtual register we can&#39;t walk uses of sanely,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01829" /><CodeLine lineNumber="1829"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// just bail. Also check that its register class is one of the ones we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01830" /><CodeLine lineNumber="1830"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// can harden.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01831" /><CodeLine lineNumber="1831"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/register">Register</a> UseDefReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>.getOperand(0).getReg();</Highlight></CodeLine>
<Link id="l01832" /><CodeLine lineNumber="1832"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!canHardenRegister(UseDefReg))</Highlight></CodeLine>
<Link id="l01833" /><CodeLine lineNumber="1833"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> &#123;&#125;;</Highlight></CodeLine>
<Link id="l01834" /><CodeLine lineNumber="1834"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01835" /><CodeLine lineNumber="1835"><Highlight kind="normal">      SingleUseMI = &amp;<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>;</Highlight></CodeLine>
<Link id="l01836" /><CodeLine lineNumber="1836"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01837" /><CodeLine lineNumber="1837"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01838" /><CodeLine lineNumber="1838"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If SingleUseMI is still null, there is no use that needs its own</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01839" /><CodeLine lineNumber="1839"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// checking. Otherwise, it is the single use that needs checking.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01840" /><CodeLine lineNumber="1840"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> &#123;SingleUseMI&#125;;</Highlight></CodeLine>
<Link id="l01841" /><CodeLine lineNumber="1841"><Highlight kind="normal">  &#125;;</Highlight></CodeLine>
<Link id="l01842" /><CodeLine lineNumber="1842"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01843" /><CodeLine lineNumber="1843"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> = &amp;InitialMI;</Highlight></CodeLine>
<Link id="l01844" /><CodeLine lineNumber="1844"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (std::optional&lt;MachineInstr &#42;&gt; SingleUse = SinkCheckToSingleUse(&#42;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>)) &#123;</Highlight></CodeLine>
<Link id="l01845" /><CodeLine lineNumber="1845"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Update which MI we&#39;re checking now.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01846" /><CodeLine lineNumber="1846"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> = &#42;SingleUse;</Highlight></CodeLine>
<Link id="l01847" /><CodeLine lineNumber="1847"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>)</Highlight></CodeLine>
<Link id="l01848" /><CodeLine lineNumber="1848"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">break</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01849" /><CodeLine lineNumber="1849"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01850" /><CodeLine lineNumber="1850"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01851" /><CodeLine lineNumber="1851"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>;</Highlight></CodeLine>
<Link id="l01852" /><CodeLine lineNumber="1852"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01853" /><CodeLine lineNumber="1853"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01854" /><CodeLine lineNumber="1854"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> X86SpeculativeLoadHardeningPass::canHardenRegister(<a href="/docs/api/classes/llvm/register">Register</a> <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>) &#123;</Highlight></CodeLine>
<Link id="l01855" /><CodeLine lineNumber="1855"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We only support hardening virtual registers.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01856" /><CodeLine lineNumber="1856"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>.isVirtual())</Highlight></CodeLine>
<Link id="l01857" /><CodeLine lineNumber="1857"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01858" /><CodeLine lineNumber="1858"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01859" /><CodeLine lineNumber="1859"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;RC = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;getRegClass(<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>);</Highlight></CodeLine>
<Link id="l01860" /><CodeLine lineNumber="1860"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> RegBytes = <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>-&gt;getRegSizeInBits(&#42;RC) / 8;</Highlight></CodeLine>
<Link id="l01861" /><CodeLine lineNumber="1861"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (RegBytes &gt; 8)</Highlight></CodeLine>
<Link id="l01862" /><CodeLine lineNumber="1862"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We don&#39;t support post-load hardening of vectors.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01863" /><CodeLine lineNumber="1863"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01864" /><CodeLine lineNumber="1864"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01865" /><CodeLine lineNumber="1865"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> RegIdx = <a href="/docs/api/namespaces/llvm/#a646986783f35e0fef8988f0f28d2589f">Log2&#95;32</a>(RegBytes);</Highlight></CodeLine>
<Link id="l01866" /><CodeLine lineNumber="1866"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(RegIdx &lt; 4 &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Unsupported register size&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01867" /><CodeLine lineNumber="1867"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01868" /><CodeLine lineNumber="1868"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If this register class is explicitly constrained to a class that doesn&#39;t</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01869" /><CodeLine lineNumber="1869"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// require REX prefix, we may not be able to satisfy that constraint when</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01870" /><CodeLine lineNumber="1870"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// emitting the hardening instructions, so bail out here.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01871" /><CodeLine lineNumber="1871"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// FIXME: This seems like a pretty lame hack. The way this comes up is when we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01872" /><CodeLine lineNumber="1872"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// end up both with a NOREX and REX-only register as operands to the hardening</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01873" /><CodeLine lineNumber="1873"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// instructions. It would be better to fix that code to handle this situation</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01874" /><CodeLine lineNumber="1874"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// rather than hack around it in this way.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01875" /><CodeLine lineNumber="1875"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/targetregisterclass">TargetRegisterClass</a> &#42;NOREXRegClasses&#91;&#93; = &#123;</Highlight></CodeLine>
<Link id="l01876" /><CodeLine lineNumber="1876"><Highlight kind="normal">      &amp;X86::GR8&#95;NOREXRegClass, &amp;X86::GR16&#95;NOREXRegClass,</Highlight></CodeLine>
<Link id="l01877" /><CodeLine lineNumber="1877"><Highlight kind="normal">      &amp;X86::GR32&#95;NOREXRegClass, &amp;X86::GR64&#95;NOREXRegClass&#125;;</Highlight></CodeLine>
<Link id="l01878" /><CodeLine lineNumber="1878"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (RC == NOREXRegClasses&#91;RegIdx&#93;)</Highlight></CodeLine>
<Link id="l01879" /><CodeLine lineNumber="1879"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01880" /><CodeLine lineNumber="1880"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01881" /><CodeLine lineNumber="1881"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/targetregisterclass">TargetRegisterClass</a> &#42;GPRRegClasses&#91;&#93; = &#123;</Highlight></CodeLine>
<Link id="l01882" /><CodeLine lineNumber="1882"><Highlight kind="normal">      &amp;X86::GR8RegClass, &amp;X86::GR16RegClass, &amp;X86::GR32RegClass,</Highlight></CodeLine>
<Link id="l01883" /><CodeLine lineNumber="1883"><Highlight kind="normal">      &amp;X86::GR64RegClass&#125;;</Highlight></CodeLine>
<Link id="l01884" /><CodeLine lineNumber="1884"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> RC-&gt;<a href="/docs/api/classes/llvm/targetregisterclass/#abee1c3236731101b249f6eeffd8cd7ba">hasSuperClassEq</a>(GPRRegClasses&#91;RegIdx&#93;);</Highlight></CodeLine>
<Link id="l01885" /><CodeLine lineNumber="1885"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01886" /><CodeLine lineNumber="1886"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l01887" /><CodeLine lineNumber="1887"><Highlight kind="comment">/// Harden a value in a register.</Highlight></CodeLine>
<Link id="l01888" /><CodeLine lineNumber="1888"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01889" /><CodeLine lineNumber="1889"><Highlight kind="comment">/// This is the low-level logic to fully harden a value sitting in a register</Highlight></CodeLine>
<Link id="l01890" /><CodeLine lineNumber="1890"><Highlight kind="comment">/// against leaking during speculative execution.</Highlight></CodeLine>
<Link id="l01891" /><CodeLine lineNumber="1891"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01892" /><CodeLine lineNumber="1892"><Highlight kind="comment">/// Unlike hardening an address that is used by a load, this routine is required</Highlight></CodeLine>
<Link id="l01893" /><CodeLine lineNumber="1893"><Highlight kind="comment">/// to hide &#42;all&#42; incoming bits in the register.</Highlight></CodeLine>
<Link id="l01894" /><CodeLine lineNumber="1894"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01895" /><CodeLine lineNumber="1895"><Highlight kind="comment">/// &#96;Reg&#96; must be a virtual register. Currently, it is required to be a GPR no</Highlight></CodeLine>
<Link id="l01896" /><CodeLine lineNumber="1896"><Highlight kind="comment">/// larger than the predicate state register. FIXME: We should support vector</Highlight></CodeLine>
<Link id="l01897" /><CodeLine lineNumber="1897"><Highlight kind="comment">/// registers here by broadcasting the predicate state.</Highlight></CodeLine>
<Link id="l01898" /><CodeLine lineNumber="1898"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01899" /><CodeLine lineNumber="1899"><Highlight kind="comment">/// The new, hardened virtual register is returned. It will have the same</Highlight></CodeLine>
<Link id="l01900" /><CodeLine lineNumber="1900"><Highlight kind="comment">/// register class as &#96;Reg&#96;.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01901" /><CodeLine lineNumber="1901"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> X86SpeculativeLoadHardeningPass::hardenValueInRegister(</Highlight></CodeLine>
<Link id="l01902" /><CodeLine lineNumber="1902"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/register">Register</a> <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>, <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> InsertPt,</Highlight></CodeLine>
<Link id="l01903" /><CodeLine lineNumber="1903"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> &amp;<a href="/docs/api/namespaces/llvm/loc">Loc</a>) &#123;</Highlight></CodeLine>
<Link id="l01904" /><CodeLine lineNumber="1904"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(canHardenRegister(<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>) &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Cannot harden this register!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01905" /><CodeLine lineNumber="1905"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01906" /><CodeLine lineNumber="1906"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;RC = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;getRegClass(<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>);</Highlight></CodeLine>
<Link id="l01907" /><CodeLine lineNumber="1907"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> Bytes = <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>-&gt;getRegSizeInBits(&#42;RC) / 8;</Highlight></CodeLine>
<Link id="l01908" /><CodeLine lineNumber="1908"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/register">Register</a> StateReg = PS-&gt;SSA.GetValueAtEndOfBlock(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</Highlight></CodeLine>
<Link id="l01909" /><CodeLine lineNumber="1909"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((Bytes == 1 || Bytes == 2 || Bytes == 4 || Bytes == 8) &amp;&amp;</Highlight></CodeLine>
<Link id="l01910" /><CodeLine lineNumber="1910"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;Unknown register size&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01911" /><CodeLine lineNumber="1911"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01912" /><CodeLine lineNumber="1912"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// FIXME: Need to teach this about 32-bit mode.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01913" /><CodeLine lineNumber="1913"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Bytes != 8) &#123;</Highlight></CodeLine>
<Link id="l01914" /><CodeLine lineNumber="1914"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> SubRegImms&#91;&#93; = &#123;X86::sub&#95;8bit, X86::sub&#95;16bit, X86::sub&#95;32bit&#125;;</Highlight></CodeLine>
<Link id="l01915" /><CodeLine lineNumber="1915"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> SubRegImm = SubRegImms&#91;<a href="/docs/api/namespaces/llvm/#a646986783f35e0fef8988f0f28d2589f">Log2&#95;32</a>(Bytes)&#93;;</Highlight></CodeLine>
<Link id="l01916" /><CodeLine lineNumber="1916"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/register">Register</a> NarrowStateReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(RC);</Highlight></CodeLine>
<Link id="l01917" /><CodeLine lineNumber="1917"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(TargetOpcode::COPY), NarrowStateReg)</Highlight></CodeLine>
<Link id="l01918" /><CodeLine lineNumber="1918"><Highlight kind="normal">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(StateReg, 0, SubRegImm);</Highlight></CodeLine>
<Link id="l01919" /><CodeLine lineNumber="1919"><Highlight kind="normal">    StateReg = NarrowStateReg;</Highlight></CodeLine>
<Link id="l01920" /><CodeLine lineNumber="1920"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01921" /><CodeLine lineNumber="1921"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01922" /><CodeLine lineNumber="1922"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> FlagsReg = 0;</Highlight></CodeLine>
<Link id="l01923" /><CodeLine lineNumber="1923"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#a93f8e5dacbcd949d688c3af5f491468d">isEFLAGSLive</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, &#42;<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>))</Highlight></CodeLine>
<Link id="l01924" /><CodeLine lineNumber="1924"><Highlight kind="normal">    FlagsReg = saveEFLAGS(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>);</Highlight></CodeLine>
<Link id="l01925" /><CodeLine lineNumber="1925"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01926" /><CodeLine lineNumber="1926"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/register">Register</a> NewReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(RC);</Highlight></CodeLine>
<Link id="l01927" /><CodeLine lineNumber="1927"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> OrOpCodes&#91;&#93; = &#123;X86::OR8rr, X86::OR16rr, X86::OR32rr, X86::OR64rr&#125;;</Highlight></CodeLine>
<Link id="l01928" /><CodeLine lineNumber="1928"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> OrOpCode = OrOpCodes&#91;<a href="/docs/api/namespaces/llvm/#a646986783f35e0fef8988f0f28d2589f">Log2&#95;32</a>(Bytes)&#93;;</Highlight></CodeLine>
<Link id="l01929" /><CodeLine lineNumber="1929"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> OrI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(OrOpCode), NewReg)</Highlight></CodeLine>
<Link id="l01930" /><CodeLine lineNumber="1930"><Highlight kind="normal">                 .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(StateReg)</Highlight></CodeLine>
<Link id="l01931" /><CodeLine lineNumber="1931"><Highlight kind="normal">                 .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>);</Highlight></CodeLine>
<Link id="l01932" /><CodeLine lineNumber="1932"><Highlight kind="normal">  OrI-&gt;<a href="/docs/api/classes/llvm/machineinstr/#afda2c0f22be043ae42b0ec71b661f565">addRegisterDead</a>(X86::EFLAGS, <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>);</Highlight></CodeLine>
<Link id="l01933" /><CodeLine lineNumber="1933"><Highlight kind="normal">  ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l01934" /><CodeLine lineNumber="1934"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Inserting or: &quot;</Highlight><Highlight kind="normal">; OrI-&gt;dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01935" /><CodeLine lineNumber="1935"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01936" /><CodeLine lineNumber="1936"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (FlagsReg)</Highlight></CodeLine>
<Link id="l01937" /><CodeLine lineNumber="1937"><Highlight kind="normal">    restoreEFLAGS(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, FlagsReg);</Highlight></CodeLine>
<Link id="l01938" /><CodeLine lineNumber="1938"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01939" /><CodeLine lineNumber="1939"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> NewReg;</Highlight></CodeLine>
<Link id="l01940" /><CodeLine lineNumber="1940"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01941" /><CodeLine lineNumber="1941"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l01942" /><CodeLine lineNumber="1942"><Highlight kind="comment">/// Harden a load by hardening the loaded value in the defined register.</Highlight></CodeLine>
<Link id="l01943" /><CodeLine lineNumber="1943"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01944" /><CodeLine lineNumber="1944"><Highlight kind="comment">/// We can harden a non-leaking load into a register without touching the</Highlight></CodeLine>
<Link id="l01945" /><CodeLine lineNumber="1945"><Highlight kind="comment">/// address by just hiding all of the loaded bits during misspeculation. We use</Highlight></CodeLine>
<Link id="l01946" /><CodeLine lineNumber="1946"><Highlight kind="comment">/// an &#96;or&#96; instruction to do this because we set up our poison value as all</Highlight></CodeLine>
<Link id="l01947" /><CodeLine lineNumber="1947"><Highlight kind="comment">/// ones. And the goal is just for the loaded bits to not be exposed to</Highlight></CodeLine>
<Link id="l01948" /><CodeLine lineNumber="1948"><Highlight kind="comment">/// execution and coercing them to one is sufficient.</Highlight></CodeLine>
<Link id="l01949" /><CodeLine lineNumber="1949"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01950" /><CodeLine lineNumber="1950"><Highlight kind="comment">/// Returns the newly hardened register.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01951" /><CodeLine lineNumber="1951"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> X86SpeculativeLoadHardeningPass::hardenPostLoad(<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) &#123;</Highlight></CodeLine>
<Link id="l01952" /><CodeLine lineNumber="1952"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> = &#42;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getParent();</Highlight></CodeLine>
<Link id="l01953" /><CodeLine lineNumber="1953"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> &amp;<a href="/docs/api/namespaces/llvm/loc">Loc</a> = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getDebugLoc();</Highlight></CodeLine>
<Link id="l01954" /><CodeLine lineNumber="1954"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01955" /><CodeLine lineNumber="1955"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;DefOp = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(0);</Highlight></CodeLine>
<Link id="l01956" /><CodeLine lineNumber="1956"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/register">Register</a> OldDefReg = DefOp.getReg();</Highlight></CodeLine>
<Link id="l01957" /><CodeLine lineNumber="1957"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;DefRC = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;getRegClass(OldDefReg);</Highlight></CodeLine>
<Link id="l01958" /><CodeLine lineNumber="1958"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01959" /><CodeLine lineNumber="1959"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Because we want to completely replace the uses of this def&#39;ed value with</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01960" /><CodeLine lineNumber="1960"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the hardened value, create a dedicated new register that will only be used</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01961" /><CodeLine lineNumber="1961"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// to communicate the unhardened value to the hardening.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01962" /><CodeLine lineNumber="1962"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/register">Register</a> UnhardenedReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(DefRC);</Highlight></CodeLine>
<Link id="l01963" /><CodeLine lineNumber="1963"><Highlight kind="normal">  DefOp.setReg(UnhardenedReg);</Highlight></CodeLine>
<Link id="l01964" /><CodeLine lineNumber="1964"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01965" /><CodeLine lineNumber="1965"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now harden this register&#39;s value, getting a hardened reg that is safe to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01966" /><CodeLine lineNumber="1966"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// use. Note that we insert the instructions to compute this &#42;after&#42; the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01967" /><CodeLine lineNumber="1967"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// defining instruction, not before it.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01968" /><CodeLine lineNumber="1968"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> HardenedReg = hardenValueInRegister(</Highlight></CodeLine>
<Link id="l01969" /><CodeLine lineNumber="1969"><Highlight kind="normal">      UnhardenedReg, <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, std::next(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getIterator()), <a href="/docs/api/namespaces/llvm/loc">Loc</a>);</Highlight></CodeLine>
<Link id="l01970" /><CodeLine lineNumber="1970"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01971" /><CodeLine lineNumber="1971"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Finally, replace the old register (which now only has the uses of the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01972" /><CodeLine lineNumber="1972"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// original def) with the hardened register.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01973" /><CodeLine lineNumber="1973"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;replaceRegWith(</Highlight><Highlight kind="comment">/&#42;FromReg&#42;/</Highlight><Highlight kind="normal"> OldDefReg, </Highlight><Highlight kind="comment">/&#42;ToReg&#42;/</Highlight><Highlight kind="normal"> HardenedReg);</Highlight></CodeLine>
<Link id="l01974" /><CodeLine lineNumber="1974"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01975" /><CodeLine lineNumber="1975"><Highlight kind="normal">  ++NumPostLoadRegsHardened;</Highlight></CodeLine>
<Link id="l01976" /><CodeLine lineNumber="1976"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> HardenedReg;</Highlight></CodeLine>
<Link id="l01977" /><CodeLine lineNumber="1977"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01978" /><CodeLine lineNumber="1978"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l01979" /><CodeLine lineNumber="1979"><Highlight kind="comment">/// Harden a return instruction.</Highlight></CodeLine>
<Link id="l01980" /><CodeLine lineNumber="1980"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01981" /><CodeLine lineNumber="1981"><Highlight kind="comment">/// Returns implicitly perform a load which we need to harden. Without hardening</Highlight></CodeLine>
<Link id="l01982" /><CodeLine lineNumber="1982"><Highlight kind="comment">/// this load, an attacker my speculatively write over the return address to</Highlight></CodeLine>
<Link id="l01983" /><CodeLine lineNumber="1983"><Highlight kind="comment">/// steer speculation of the return to an attacker controlled address. This is</Highlight></CodeLine>
<Link id="l01984" /><CodeLine lineNumber="1984"><Highlight kind="comment">/// called Spectre v1.1 or Bounds Check Bypass Store (BCBS) and is described in</Highlight></CodeLine>
<Link id="l01985" /><CodeLine lineNumber="1985"><Highlight kind="comment">/// this paper:</Highlight></CodeLine>
<Link id="l01986" /><CodeLine lineNumber="1986"><Highlight kind="comment">/// https://people.csail.mit.edu/vlk/spectre11.pdf</Highlight></CodeLine>
<Link id="l01987" /><CodeLine lineNumber="1987"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01988" /><CodeLine lineNumber="1988"><Highlight kind="comment">/// We can harden this by introducing an LFENCE that will delay any load of the</Highlight></CodeLine>
<Link id="l01989" /><CodeLine lineNumber="1989"><Highlight kind="comment">/// return address until prior instructions have retired (and thus are not being</Highlight></CodeLine>
<Link id="l01990" /><CodeLine lineNumber="1990"><Highlight kind="comment">/// speculated), or we can harden the address used by the implicit load: the</Highlight></CodeLine>
<Link id="l01991" /><CodeLine lineNumber="1991"><Highlight kind="comment">/// stack pointer.</Highlight></CodeLine>
<Link id="l01992" /><CodeLine lineNumber="1992"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01993" /><CodeLine lineNumber="1993"><Highlight kind="comment">/// If we are not using an LFENCE, hardening the stack pointer has an additional</Highlight></CodeLine>
<Link id="l01994" /><CodeLine lineNumber="1994"><Highlight kind="comment">/// benefit: it allows us to pass the predicate state accumulated in this</Highlight></CodeLine>
<Link id="l01995" /><CodeLine lineNumber="1995"><Highlight kind="comment">/// function back to the caller. In the absence of a BCBS attack on the return,</Highlight></CodeLine>
<Link id="l01996" /><CodeLine lineNumber="1996"><Highlight kind="comment">/// the caller will typically be resumed and speculatively executed due to the</Highlight></CodeLine>
<Link id="l01997" /><CodeLine lineNumber="1997"><Highlight kind="comment">/// Return Stack Buffer (RSB) prediction which is very accurate and has a high</Highlight></CodeLine>
<Link id="l01998" /><CodeLine lineNumber="1998"><Highlight kind="comment">/// priority. It is possible that some code from the caller will be executed</Highlight></CodeLine>
<Link id="l01999" /><CodeLine lineNumber="1999"><Highlight kind="comment">/// speculatively even during a BCBS-attacked return until the steering takes</Highlight></CodeLine>
<Link id="l02000" /><CodeLine lineNumber="2000"><Highlight kind="comment">/// effect. Whenever this happens, the caller can recover the (poisoned)</Highlight></CodeLine>
<Link id="l02001" /><CodeLine lineNumber="2001"><Highlight kind="comment">/// predicate state from the stack pointer and continue to harden loads.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02002" /><CodeLine lineNumber="2002"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> X86SpeculativeLoadHardeningPass::hardenReturnInstr(<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) &#123;</Highlight></CodeLine>
<Link id="l02003" /><CodeLine lineNumber="2003"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> = &#42;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getParent();</Highlight></CodeLine>
<Link id="l02004" /><CodeLine lineNumber="2004"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> &amp;<a href="/docs/api/namespaces/llvm/loc">Loc</a> = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getDebugLoc();</Highlight></CodeLine>
<Link id="l02005" /><CodeLine lineNumber="2005"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> InsertPt = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getIterator();</Highlight></CodeLine>
<Link id="l02006" /><CodeLine lineNumber="2006"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02007" /><CodeLine lineNumber="2007"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#a5ee11464d0d2e030d95afb0db83b801d">FenceCallAndRet</a>)</Highlight></CodeLine>
<Link id="l02008" /><CodeLine lineNumber="2008"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// No need to fence here as we&#39;ll fence at the return site itself. That</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02009" /><CodeLine lineNumber="2009"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// handles more cases than we can handle here.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02010" /><CodeLine lineNumber="2010"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02011" /><CodeLine lineNumber="2011"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02012" /><CodeLine lineNumber="2012"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Take our predicate state, shift it to the high 17 bits (so that we keep</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02013" /><CodeLine lineNumber="2013"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// pointers canonical) and merge it into RSP. This will allow the caller to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02014" /><CodeLine lineNumber="2014"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// extract it when we return (speculatively).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02015" /><CodeLine lineNumber="2015"><Highlight kind="normal">  mergePredStateIntoSP(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, PS-&gt;SSA.GetValueAtEndOfBlock(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>));</Highlight></CodeLine>
<Link id="l02016" /><CodeLine lineNumber="2016"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l02017" /><CodeLine lineNumber="2017"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l02018" /><CodeLine lineNumber="2018"><Highlight kind="comment">/// Trace the predicate state through a call.</Highlight></CodeLine>
<Link id="l02019" /><CodeLine lineNumber="2019"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02020" /><CodeLine lineNumber="2020"><Highlight kind="comment">/// There are several layers of this needed to handle the full complexity of</Highlight></CodeLine>
<Link id="l02021" /><CodeLine lineNumber="2021"><Highlight kind="comment">/// calls.</Highlight></CodeLine>
<Link id="l02022" /><CodeLine lineNumber="2022"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02023" /><CodeLine lineNumber="2023"><Highlight kind="comment">/// First, we need to send the predicate state into the called function. We do</Highlight></CodeLine>
<Link id="l02024" /><CodeLine lineNumber="2024"><Highlight kind="comment">/// this by merging it into the high bits of the stack pointer.</Highlight></CodeLine>
<Link id="l02025" /><CodeLine lineNumber="2025"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02026" /><CodeLine lineNumber="2026"><Highlight kind="comment">/// For tail calls, this is all we need to do.</Highlight></CodeLine>
<Link id="l02027" /><CodeLine lineNumber="2027"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02028" /><CodeLine lineNumber="2028"><Highlight kind="comment">/// For calls where we might return and resume the control flow, we need to</Highlight></CodeLine>
<Link id="l02029" /><CodeLine lineNumber="2029"><Highlight kind="comment">/// extract the predicate state from the high bits of the stack pointer after</Highlight></CodeLine>
<Link id="l02030" /><CodeLine lineNumber="2030"><Highlight kind="comment">/// control returns from the called function.</Highlight></CodeLine>
<Link id="l02031" /><CodeLine lineNumber="2031"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02032" /><CodeLine lineNumber="2032"><Highlight kind="comment">/// We also need to verify that we intended to return to this location in the</Highlight></CodeLine>
<Link id="l02033" /><CodeLine lineNumber="2033"><Highlight kind="comment">/// code. An attacker might arrange for the processor to mispredict the return</Highlight></CodeLine>
<Link id="l02034" /><CodeLine lineNumber="2034"><Highlight kind="comment">/// to this valid but incorrect return address in the program rather than the</Highlight></CodeLine>
<Link id="l02035" /><CodeLine lineNumber="2035"><Highlight kind="comment">/// correct one. See the paper on this attack, called &quot;ret2spec&quot; by the</Highlight></CodeLine>
<Link id="l02036" /><CodeLine lineNumber="2036"><Highlight kind="comment">/// researchers, here:</Highlight></CodeLine>
<Link id="l02037" /><CodeLine lineNumber="2037"><Highlight kind="comment">/// https://christian-rossow.de/publications/ret2spec-ccs2018.pdf</Highlight></CodeLine>
<Link id="l02038" /><CodeLine lineNumber="2038"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02039" /><CodeLine lineNumber="2039"><Highlight kind="comment">/// The way we verify that we returned to the correct location is by preserving</Highlight></CodeLine>
<Link id="l02040" /><CodeLine lineNumber="2040"><Highlight kind="comment">/// the expected return address across the call. One technique involves taking</Highlight></CodeLine>
<Link id="l02041" /><CodeLine lineNumber="2041"><Highlight kind="comment">/// advantage of the red-zone to load the return address from &#96;8(%rsp)&#96; where it</Highlight></CodeLine>
<Link id="l02042" /><CodeLine lineNumber="2042"><Highlight kind="comment">/// was left by the RET instruction when it popped &#96;%rsp&#96;. Alternatively, we can</Highlight></CodeLine>
<Link id="l02043" /><CodeLine lineNumber="2043"><Highlight kind="comment">/// directly save the address into a register that will be preserved across the</Highlight></CodeLine>
<Link id="l02044" /><CodeLine lineNumber="2044"><Highlight kind="comment">/// call. We compare this intended return address against the address</Highlight></CodeLine>
<Link id="l02045" /><CodeLine lineNumber="2045"><Highlight kind="comment">/// immediately following the call (the observed return address). If these</Highlight></CodeLine>
<Link id="l02046" /><CodeLine lineNumber="2046"><Highlight kind="comment">/// mismatch, we have detected misspeculation and can poison our predicate</Highlight></CodeLine>
<Link id="l02047" /><CodeLine lineNumber="2047"><Highlight kind="comment">/// state.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02048" /><CodeLine lineNumber="2048"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> X86SpeculativeLoadHardeningPass::tracePredStateThroughCall(</Highlight></CodeLine>
<Link id="l02049" /><CodeLine lineNumber="2049"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) &#123;</Highlight></CodeLine>
<Link id="l02050" /><CodeLine lineNumber="2050"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> = &#42;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getParent();</Highlight></CodeLine>
<Link id="l02051" /><CodeLine lineNumber="2051"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF = &#42;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.getParent();</Highlight></CodeLine>
<Link id="l02052" /><CodeLine lineNumber="2052"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> InsertPt = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getIterator();</Highlight></CodeLine>
<Link id="l02053" /><CodeLine lineNumber="2053"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> &amp;<a href="/docs/api/namespaces/llvm/loc">Loc</a> = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getDebugLoc();</Highlight></CodeLine>
<Link id="l02054" /><CodeLine lineNumber="2054"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02055" /><CodeLine lineNumber="2055"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#a5ee11464d0d2e030d95afb0db83b801d">FenceCallAndRet</a>) &#123;</Highlight></CodeLine>
<Link id="l02056" /><CodeLine lineNumber="2056"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isReturn())</Highlight></CodeLine>
<Link id="l02057" /><CodeLine lineNumber="2057"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Tail call, we don&#39;t return to this function.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02058" /><CodeLine lineNumber="2058"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// FIXME: We should also handle noreturn calls.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02059" /><CodeLine lineNumber="2059"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02060" /><CodeLine lineNumber="2060"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02061" /><CodeLine lineNumber="2061"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We don&#39;t need to fence before the call because the function should fence</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02062" /><CodeLine lineNumber="2062"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// in its entry. However, we do need to fence after the call returns.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02063" /><CodeLine lineNumber="2063"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Fencing before the return doesn&#39;t correctly handle cases where the return</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02064" /><CodeLine lineNumber="2064"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// itself is mispredicted.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02065" /><CodeLine lineNumber="2065"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, std::next(InsertPt), <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::LFENCE));</Highlight></CodeLine>
<Link id="l02066" /><CodeLine lineNumber="2066"><Highlight kind="normal">    ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l02067" /><CodeLine lineNumber="2067"><Highlight kind="normal">    ++NumLFENCEsInserted;</Highlight></CodeLine>
<Link id="l02068" /><CodeLine lineNumber="2068"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02069" /><CodeLine lineNumber="2069"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02070" /><CodeLine lineNumber="2070"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02071" /><CodeLine lineNumber="2071"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// First, we transfer the predicate state into the called function by merging</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02072" /><CodeLine lineNumber="2072"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// it into the stack pointer. This will kill the current def of the state.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02073" /><CodeLine lineNumber="2073"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/register">Register</a> StateReg = PS-&gt;SSA.GetValueAtEndOfBlock(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</Highlight></CodeLine>
<Link id="l02074" /><CodeLine lineNumber="2074"><Highlight kind="normal">  mergePredStateIntoSP(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, StateReg);</Highlight></CodeLine>
<Link id="l02075" /><CodeLine lineNumber="2075"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02076" /><CodeLine lineNumber="2076"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If this call is also a return, it is a tail call and we don&#39;t need anything</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02077" /><CodeLine lineNumber="2077"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// else to handle it so just return. Also, if there are no further</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02078" /><CodeLine lineNumber="2078"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// instructions and no successors, this call does not return so we can also</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02079" /><CodeLine lineNumber="2079"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// bail.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02080" /><CodeLine lineNumber="2080"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isReturn() || (std::next(InsertPt) == <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.end() &amp;&amp; <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.succ&#95;empty()))</Highlight></CodeLine>
<Link id="l02081" /><CodeLine lineNumber="2081"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02082" /><CodeLine lineNumber="2082"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02083" /><CodeLine lineNumber="2083"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Create a symbol to track the return address and attach it to the call</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02084" /><CodeLine lineNumber="2084"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// machine instruction. We will lower extra symbols attached to call</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02085" /><CodeLine lineNumber="2085"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// instructions as label immediately following the call.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02086" /><CodeLine lineNumber="2086"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/mcsymbol">MCSymbol</a> &#42;RetSymbol =</Highlight></CodeLine>
<Link id="l02087" /><CodeLine lineNumber="2087"><Highlight kind="normal">      MF.<a href="/docs/api/classes/llvm/machinefunction/#a752546c51633c140d9ca4ab98b4781b6">getContext</a>().<a href="/docs/api/classes/llvm/mccontext/#a299bf2f0329389424760f4a7c8af75ac">createTempSymbol</a>(</Highlight><Highlight kind="stringliteral">&quot;slh&#95;ret&#95;addr&quot;</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l02088" /><CodeLine lineNumber="2088"><Highlight kind="normal">                                       </Highlight><Highlight kind="comment">/&#42;AlwaysAddSuffix&#42;/</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02089" /><CodeLine lineNumber="2089"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.setPostInstrSymbol(MF, RetSymbol);</Highlight></CodeLine>
<Link id="l02090" /><CodeLine lineNumber="2090"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02091" /><CodeLine lineNumber="2091"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/targetregisterclass">TargetRegisterClass</a> &#42;AddrRC = &amp;X86::GR64RegClass;</Highlight></CodeLine>
<Link id="l02092" /><CodeLine lineNumber="2092"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> ExpectedRetAddrReg = 0;</Highlight></CodeLine>
<Link id="l02093" /><CodeLine lineNumber="2093"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02094" /><CodeLine lineNumber="2094"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If we have no red zones or if the function returns twice (possibly without</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02095" /><CodeLine lineNumber="2095"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// using the &#96;ret&#96; instruction) like setjmp, we need to save the expected</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02096" /><CodeLine lineNumber="2096"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// return address prior to the call.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02097" /><CodeLine lineNumber="2097"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!Subtarget-&gt;getFrameLowering()-&gt;has128ByteRedZone(MF) ||</Highlight></CodeLine>
<Link id="l02098" /><CodeLine lineNumber="2098"><Highlight kind="normal">      MF.<a href="/docs/api/classes/llvm/machinefunction/#a4b94e0ca517e149914aa0c34ee06c9fa">exposesReturnsTwice</a>()) &#123;</Highlight></CodeLine>
<Link id="l02099" /><CodeLine lineNumber="2099"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If we don&#39;t have red zones, we need to compute the expected return</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02100" /><CodeLine lineNumber="2100"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// address prior to the call and store it in a register that lives across</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02101" /><CodeLine lineNumber="2101"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// the call.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02102" /><CodeLine lineNumber="2102"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02103" /><CodeLine lineNumber="2103"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// In some ways, this is doubly satisfying as a mitigation because it will</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02104" /><CodeLine lineNumber="2104"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// also successfully detect stack smashing bugs in some cases (typically,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02105" /><CodeLine lineNumber="2105"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// when a callee-saved register is used and the callee doesn&#39;t push it onto</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02106" /><CodeLine lineNumber="2106"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// the stack). But that isn&#39;t our primary goal, so we only use it as</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02107" /><CodeLine lineNumber="2107"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// a fallback.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02108" /><CodeLine lineNumber="2108"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02109" /><CodeLine lineNumber="2109"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// FIXME: It isn&#39;t clear that this is reliable in the face of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02110" /><CodeLine lineNumber="2110"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// rematerialization in the register allocator. We somehow need to force</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02111" /><CodeLine lineNumber="2111"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// that to not occur for this particular instruction, and instead to spill</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02112" /><CodeLine lineNumber="2112"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// or otherwise preserve the value computed &#42;prior&#42; to the call.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02113" /><CodeLine lineNumber="2113"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02114" /><CodeLine lineNumber="2114"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// FIXME: It is even less clear why MachineCSE can&#39;t just fold this when we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02115" /><CodeLine lineNumber="2115"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// end up having to use identical instructions both before and after the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02116" /><CodeLine lineNumber="2116"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// call to feed the comparison.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02117" /><CodeLine lineNumber="2117"><Highlight kind="normal">    ExpectedRetAddrReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(AddrRC);</Highlight></CodeLine>
<Link id="l02118" /><CodeLine lineNumber="2118"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MF.<a href="/docs/api/classes/llvm/machinefunction/#af777ff93c9e07a6ff5ffe3226deb3e76">getTarget</a>().<a href="/docs/api/classes/llvm/targetmachine/#ae106f6c6362377b3016f0d174227e193">getCodeModel</a>() == <a href="/docs/api/namespaces/llvm/codemodel/#afc59396a9e5809fc92938e203d91a8dfaa2554ef60dc191c6005ba9eecbc9aea0">CodeModel::Small</a> &amp;&amp;</Highlight></CodeLine>
<Link id="l02119" /><CodeLine lineNumber="2119"><Highlight kind="normal">        !Subtarget-&gt;isPositionIndependent()) &#123;</Highlight></CodeLine>
<Link id="l02120" /><CodeLine lineNumber="2120"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::MOV64ri32), ExpectedRetAddrReg)</Highlight></CodeLine>
<Link id="l02121" /><CodeLine lineNumber="2121"><Highlight kind="normal">          .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a7ffeb5b3940506a54e69e72e26e2a6cd">addSym</a>(RetSymbol);</Highlight></CodeLine>
<Link id="l02122" /><CodeLine lineNumber="2122"><Highlight kind="normal">    &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l02123" /><CodeLine lineNumber="2123"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::LEA64r), ExpectedRetAddrReg)</Highlight></CodeLine>
<Link id="l02124" /><CodeLine lineNumber="2124"><Highlight kind="normal">          .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</Highlight><Highlight kind="comment">/&#42;Base&#42;/</Highlight><Highlight kind="normal"> X86::RIP)</Highlight></CodeLine>
<Link id="l02125" /><CodeLine lineNumber="2125"><Highlight kind="normal">          .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(</Highlight><Highlight kind="comment">/&#42;Scale&#42;/</Highlight><Highlight kind="normal"> 1)</Highlight></CodeLine>
<Link id="l02126" /><CodeLine lineNumber="2126"><Highlight kind="normal">          .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</Highlight><Highlight kind="comment">/&#42;Index&#42;/</Highlight><Highlight kind="normal"> 0)</Highlight></CodeLine>
<Link id="l02127" /><CodeLine lineNumber="2127"><Highlight kind="normal">          .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a7ffeb5b3940506a54e69e72e26e2a6cd">addSym</a>(RetSymbol)</Highlight></CodeLine>
<Link id="l02128" /><CodeLine lineNumber="2128"><Highlight kind="normal">          .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</Highlight><Highlight kind="comment">/&#42;Segment&#42;/</Highlight><Highlight kind="normal"> 0);</Highlight></CodeLine>
<Link id="l02129" /><CodeLine lineNumber="2129"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l02130" /><CodeLine lineNumber="2130"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02131" /><CodeLine lineNumber="2131"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02132" /><CodeLine lineNumber="2132"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Step past the call to handle when it returns.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02133" /><CodeLine lineNumber="2133"><Highlight kind="normal">  ++InsertPt;</Highlight></CodeLine>
<Link id="l02134" /><CodeLine lineNumber="2134"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02135" /><CodeLine lineNumber="2135"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If we didn&#39;t pre-compute the expected return address into a register, then</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02136" /><CodeLine lineNumber="2136"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// red zones are enabled and the return address is still available on the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02137" /><CodeLine lineNumber="2137"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// stack immediately after the call. As the very first instruction, we load it</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02138" /><CodeLine lineNumber="2138"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// into a register.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02139" /><CodeLine lineNumber="2139"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!ExpectedRetAddrReg) &#123;</Highlight></CodeLine>
<Link id="l02140" /><CodeLine lineNumber="2140"><Highlight kind="normal">    ExpectedRetAddrReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(AddrRC);</Highlight></CodeLine>
<Link id="l02141" /><CodeLine lineNumber="2141"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::MOV64rm), ExpectedRetAddrReg)</Highlight></CodeLine>
<Link id="l02142" /><CodeLine lineNumber="2142"><Highlight kind="normal">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</Highlight><Highlight kind="comment">/&#42;Base&#42;/</Highlight><Highlight kind="normal"> X86::RSP)</Highlight></CodeLine>
<Link id="l02143" /><CodeLine lineNumber="2143"><Highlight kind="normal">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(</Highlight><Highlight kind="comment">/&#42;Scale&#42;/</Highlight><Highlight kind="normal"> 1)</Highlight></CodeLine>
<Link id="l02144" /><CodeLine lineNumber="2144"><Highlight kind="normal">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</Highlight><Highlight kind="comment">/&#42;Index&#42;/</Highlight><Highlight kind="normal"> 0)</Highlight></CodeLine>
<Link id="l02145" /><CodeLine lineNumber="2145"><Highlight kind="normal">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(</Highlight><Highlight kind="comment">/&#42;Displacement&#42;/</Highlight><Highlight kind="normal"> -8) </Highlight><Highlight kind="comment">// The stack pointer has been popped, so</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02146" /><CodeLine lineNumber="2146"><Highlight kind="normal">                                     </Highlight><Highlight kind="comment">// the return address is 8-bytes past it.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02147" /><CodeLine lineNumber="2147"><Highlight kind="normal">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</Highlight><Highlight kind="comment">/&#42;Segment&#42;/</Highlight><Highlight kind="normal"> 0);</Highlight></CodeLine>
<Link id="l02148" /><CodeLine lineNumber="2148"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02149" /><CodeLine lineNumber="2149"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02150" /><CodeLine lineNumber="2150"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now we extract the callee&#39;s predicate state from the stack pointer.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02151" /><CodeLine lineNumber="2151"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> NewStateReg = extractPredStateFromSP(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>);</Highlight></CodeLine>
<Link id="l02152" /><CodeLine lineNumber="2152"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02153" /><CodeLine lineNumber="2153"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Test the expected return address against our actual address. If we can</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02154" /><CodeLine lineNumber="2154"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// form this basic block&#39;s address as an immediate, this is easy. Otherwise</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02155" /><CodeLine lineNumber="2155"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// we compute it.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02156" /><CodeLine lineNumber="2156"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MF.<a href="/docs/api/classes/llvm/machinefunction/#af777ff93c9e07a6ff5ffe3226deb3e76">getTarget</a>().<a href="/docs/api/classes/llvm/targetmachine/#ae106f6c6362377b3016f0d174227e193">getCodeModel</a>() == <a href="/docs/api/namespaces/llvm/codemodel/#afc59396a9e5809fc92938e203d91a8dfaa2554ef60dc191c6005ba9eecbc9aea0">CodeModel::Small</a> &amp;&amp;</Highlight></CodeLine>
<Link id="l02157" /><CodeLine lineNumber="2157"><Highlight kind="normal">      !Subtarget-&gt;isPositionIndependent()) &#123;</Highlight></CodeLine>
<Link id="l02158" /><CodeLine lineNumber="2158"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// FIXME: Could we fold this with the load? It would require careful EFLAGS</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02159" /><CodeLine lineNumber="2159"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// management.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02160" /><CodeLine lineNumber="2160"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::CMP64ri32))</Highlight></CodeLine>
<Link id="l02161" /><CodeLine lineNumber="2161"><Highlight kind="normal">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(ExpectedRetAddrReg, <a href="/docs/api/namespaces/llvm/regstate/#ade26fe5c9b3fe6948def36f7ca12dfc5a9ddde91ef09476d28a088fe57f8e2921">RegState::Kill</a>)</Highlight></CodeLine>
<Link id="l02162" /><CodeLine lineNumber="2162"><Highlight kind="normal">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a7ffeb5b3940506a54e69e72e26e2a6cd">addSym</a>(RetSymbol);</Highlight></CodeLine>
<Link id="l02163" /><CodeLine lineNumber="2163"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l02164" /><CodeLine lineNumber="2164"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/register">Register</a> ActualRetAddrReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(AddrRC);</Highlight></CodeLine>
<Link id="l02165" /><CodeLine lineNumber="2165"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::LEA64r), ActualRetAddrReg)</Highlight></CodeLine>
<Link id="l02166" /><CodeLine lineNumber="2166"><Highlight kind="normal">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</Highlight><Highlight kind="comment">/&#42;Base&#42;/</Highlight><Highlight kind="normal"> X86::RIP)</Highlight></CodeLine>
<Link id="l02167" /><CodeLine lineNumber="2167"><Highlight kind="normal">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(</Highlight><Highlight kind="comment">/&#42;Scale&#42;/</Highlight><Highlight kind="normal"> 1)</Highlight></CodeLine>
<Link id="l02168" /><CodeLine lineNumber="2168"><Highlight kind="normal">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</Highlight><Highlight kind="comment">/&#42;Index&#42;/</Highlight><Highlight kind="normal"> 0)</Highlight></CodeLine>
<Link id="l02169" /><CodeLine lineNumber="2169"><Highlight kind="normal">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a7ffeb5b3940506a54e69e72e26e2a6cd">addSym</a>(RetSymbol)</Highlight></CodeLine>
<Link id="l02170" /><CodeLine lineNumber="2170"><Highlight kind="normal">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</Highlight><Highlight kind="comment">/&#42;Segment&#42;/</Highlight><Highlight kind="normal"> 0);</Highlight></CodeLine>
<Link id="l02171" /><CodeLine lineNumber="2171"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::CMP64rr))</Highlight></CodeLine>
<Link id="l02172" /><CodeLine lineNumber="2172"><Highlight kind="normal">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(ExpectedRetAddrReg, <a href="/docs/api/namespaces/llvm/regstate/#ade26fe5c9b3fe6948def36f7ca12dfc5a9ddde91ef09476d28a088fe57f8e2921">RegState::Kill</a>)</Highlight></CodeLine>
<Link id="l02173" /><CodeLine lineNumber="2173"><Highlight kind="normal">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(ActualRetAddrReg, <a href="/docs/api/namespaces/llvm/regstate/#ade26fe5c9b3fe6948def36f7ca12dfc5a9ddde91ef09476d28a088fe57f8e2921">RegState::Kill</a>);</Highlight></CodeLine>
<Link id="l02174" /><CodeLine lineNumber="2174"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02175" /><CodeLine lineNumber="2175"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02176" /><CodeLine lineNumber="2176"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now conditionally update the predicate state we just extracted if we ended</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02177" /><CodeLine lineNumber="2177"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// up at a different return address than expected.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02178" /><CodeLine lineNumber="2178"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">int</Highlight><Highlight kind="normal"> PredStateSizeInBytes = <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>-&gt;getRegSizeInBits(&#42;PS-&gt;RC) / 8;</Highlight></CodeLine>
<Link id="l02179" /><CodeLine lineNumber="2179"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> CMovOp = <a href="/docs/api/namespaces/llvm/x86/#af569f4e4b0acf498c83fa0e58e2eb364">X86::getCMovOpcode</a>(PredStateSizeInBytes);</Highlight></CodeLine>
<Link id="l02180" /><CodeLine lineNumber="2180"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02181" /><CodeLine lineNumber="2181"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/register">Register</a> UpdatedStateReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(PS-&gt;RC);</Highlight></CodeLine>
<Link id="l02182" /><CodeLine lineNumber="2182"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> CMovI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(CMovOp), UpdatedStateReg)</Highlight></CodeLine>
<Link id="l02183" /><CodeLine lineNumber="2183"><Highlight kind="normal">                   .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(NewStateReg, <a href="/docs/api/namespaces/llvm/regstate/#ade26fe5c9b3fe6948def36f7ca12dfc5a9ddde91ef09476d28a088fe57f8e2921">RegState::Kill</a>)</Highlight></CodeLine>
<Link id="l02184" /><CodeLine lineNumber="2184"><Highlight kind="normal">                   .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(PS-&gt;PoisonReg)</Highlight></CodeLine>
<Link id="l02185" /><CodeLine lineNumber="2185"><Highlight kind="normal">                   .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(<a href="/docs/api/namespaces/llvm/x86/#a1a356a51a1fb4cc3c427599082cf1d2eacb2f86eaebe8b719f743d17a2d5a5f3d">X86::COND&#95;NE</a>);</Highlight></CodeLine>
<Link id="l02186" /><CodeLine lineNumber="2186"><Highlight kind="normal">  CMovI-&gt;<a href="/docs/api/classes/llvm/machineinstr/#ab692b90c6e0e9b450f407896cbbe4b02">findRegisterUseOperand</a>(X86::EFLAGS, </Highlight><Highlight kind="comment">/&#42;TRI=&#42;/</Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">)-&gt;<a href="/docs/api/classes/llvm/machineoperand/#a8a82683fccdef8a5ef772ef03277aee7">setIsKill</a>(</Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02187" /><CodeLine lineNumber="2187"><Highlight kind="normal">  ++NumInstsInserted;</Highlight></CodeLine>
<Link id="l02188" /><CodeLine lineNumber="2188"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Inserting cmov: &quot;</Highlight><Highlight kind="normal">; CMovI-&gt;dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02189" /><CodeLine lineNumber="2189"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02190" /><CodeLine lineNumber="2190"><Highlight kind="normal">  PS-&gt;SSA.AddAvailableValue(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, UpdatedStateReg);</Highlight></CodeLine>
<Link id="l02191" /><CodeLine lineNumber="2191"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l02192" /><CodeLine lineNumber="2192"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l02193" /><CodeLine lineNumber="2193"><Highlight kind="comment">/// An attacker may speculatively store over a value that is then speculatively</Highlight></CodeLine>
<Link id="l02194" /><CodeLine lineNumber="2194"><Highlight kind="comment">/// loaded and used as the target of an indirect call or jump instruction. This</Highlight></CodeLine>
<Link id="l02195" /><CodeLine lineNumber="2195"><Highlight kind="comment">/// is called Spectre v1.2 or Bounds Check Bypass Store (BCBS) and is described</Highlight></CodeLine>
<Link id="l02196" /><CodeLine lineNumber="2196"><Highlight kind="comment">/// in this paper:</Highlight></CodeLine>
<Link id="l02197" /><CodeLine lineNumber="2197"><Highlight kind="comment">/// https://people.csail.mit.edu/vlk/spectre11.pdf</Highlight></CodeLine>
<Link id="l02198" /><CodeLine lineNumber="2198"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l02199" /><CodeLine lineNumber="2199"><Highlight kind="comment">/// When this happens, the speculative execution of the call or jump will end up</Highlight></CodeLine>
<Link id="l02200" /><CodeLine lineNumber="2200"><Highlight kind="comment">/// being steered to this attacker controlled address. While most such loads</Highlight></CodeLine>
<Link id="l02201" /><CodeLine lineNumber="2201"><Highlight kind="comment">/// will be adequately hardened already, we want to ensure that they are</Highlight></CodeLine>
<Link id="l02202" /><CodeLine lineNumber="2202"><Highlight kind="comment">/// definitively treated as needing post-load hardening. While address hardening</Highlight></CodeLine>
<Link id="l02203" /><CodeLine lineNumber="2203"><Highlight kind="comment">/// is sufficient to prevent secret data from leaking to the attacker, it may</Highlight></CodeLine>
<Link id="l02204" /><CodeLine lineNumber="2204"><Highlight kind="comment">/// not be sufficient to prevent an attacker from steering speculative</Highlight></CodeLine>
<Link id="l02205" /><CodeLine lineNumber="2205"><Highlight kind="comment">/// execution. We forcibly unfolded all relevant loads above and so will always</Highlight></CodeLine>
<Link id="l02206" /><CodeLine lineNumber="2206"><Highlight kind="comment">/// have an opportunity to post-load harden here, we just need to scan for cases</Highlight></CodeLine>
<Link id="l02207" /><CodeLine lineNumber="2207"><Highlight kind="comment">/// not already flagged and add them.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02208" /><CodeLine lineNumber="2208"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> X86SpeculativeLoadHardeningPass::hardenIndirectCallOrJumpInstr(</Highlight></CodeLine>
<Link id="l02209" /><CodeLine lineNumber="2209"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>,</Highlight></CodeLine>
<Link id="l02210" /><CodeLine lineNumber="2210"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;unsigned, unsigned, 32&gt;</a> &amp;AddrRegToHardenedReg) &#123;</Highlight></CodeLine>
<Link id="l02211" /><CodeLine lineNumber="2211"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">switch</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOpcode()) &#123;</Highlight></CodeLine>
<Link id="l02212" /><CodeLine lineNumber="2212"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::FARCALL16m:</Highlight></CodeLine>
<Link id="l02213" /><CodeLine lineNumber="2213"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::FARCALL32m:</Highlight></CodeLine>
<Link id="l02214" /><CodeLine lineNumber="2214"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::FARCALL64m:</Highlight></CodeLine>
<Link id="l02215" /><CodeLine lineNumber="2215"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::FARJMP16m:</Highlight></CodeLine>
<Link id="l02216" /><CodeLine lineNumber="2216"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::FARJMP32m:</Highlight></CodeLine>
<Link id="l02217" /><CodeLine lineNumber="2217"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> X86::FARJMP64m:</Highlight></CodeLine>
<Link id="l02218" /><CodeLine lineNumber="2218"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We don&#39;t need to harden either far calls or far jumps as they are</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02219" /><CodeLine lineNumber="2219"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// safe from Spectre.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02220" /><CodeLine lineNumber="2220"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02221" /><CodeLine lineNumber="2221"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02222" /><CodeLine lineNumber="2222"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">default</Highlight><Highlight kind="normal">:</Highlight></CodeLine>
<Link id="l02223" /><CodeLine lineNumber="2223"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">break</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02224" /><CodeLine lineNumber="2224"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l02225" /><CodeLine lineNumber="2225"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02226" /><CodeLine lineNumber="2226"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We should never see a loading instruction at this point, as those should</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02227" /><CodeLine lineNumber="2227"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// have been unfolded.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02228" /><CodeLine lineNumber="2228"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.mayLoad() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Found a lingering loading instruction!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l02229" /><CodeLine lineNumber="2229"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02230" /><CodeLine lineNumber="2230"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If the first operand isn&#39;t a register, this is a branch or call</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02231" /><CodeLine lineNumber="2231"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// instruction with an immediate operand which doesn&#39;t need to be hardened.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02232" /><CodeLine lineNumber="2232"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(0).isReg())</Highlight></CodeLine>
<Link id="l02233" /><CodeLine lineNumber="2233"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l02234" /><CodeLine lineNumber="2234"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02235" /><CodeLine lineNumber="2235"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// For all of these, the target register is the first operand of the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02236" /><CodeLine lineNumber="2236"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// instruction.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02237" /><CodeLine lineNumber="2237"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;TargetOp = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(0);</Highlight></CodeLine>
<Link id="l02238" /><CodeLine lineNumber="2238"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/register">Register</a> OldTargetReg = TargetOp.getReg();</Highlight></CodeLine>
<Link id="l02239" /><CodeLine lineNumber="2239"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02240" /><CodeLine lineNumber="2240"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Try to lookup a hardened version of this register. We retain a reference</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02241" /><CodeLine lineNumber="2241"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// here as we want to update the map to track any newly computed hardened</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02242" /><CodeLine lineNumber="2242"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// register.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02243" /><CodeLine lineNumber="2243"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> &amp;HardenedTargetReg = AddrRegToHardenedReg&#91;OldTargetReg&#93;;</Highlight></CodeLine>
<Link id="l02244" /><CodeLine lineNumber="2244"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02245" /><CodeLine lineNumber="2245"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If we don&#39;t have a hardened register yet, compute one. Otherwise, just use</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02246" /><CodeLine lineNumber="2246"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the already hardened register.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02247" /><CodeLine lineNumber="2247"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02248" /><CodeLine lineNumber="2248"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// FIXME: It is a little suspect that we use partially hardened registers that</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02249" /><CodeLine lineNumber="2249"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// only feed addresses. The complexity of partial hardening with SHRX</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02250" /><CodeLine lineNumber="2250"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// continues to pile up. Should definitively measure its value and consider</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02251" /><CodeLine lineNumber="2251"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// eliminating it.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02252" /><CodeLine lineNumber="2252"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!HardenedTargetReg)</Highlight></CodeLine>
<Link id="l02253" /><CodeLine lineNumber="2253"><Highlight kind="normal">    HardenedTargetReg = hardenValueInRegister(</Highlight></CodeLine>
<Link id="l02254" /><CodeLine lineNumber="2254"><Highlight kind="normal">        OldTargetReg, &#42;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getParent(), <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getIterator(), <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getDebugLoc());</Highlight></CodeLine>
<Link id="l02255" /><CodeLine lineNumber="2255"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02256" /><CodeLine lineNumber="2256"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Set the target operand to the hardened register.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02257" /><CodeLine lineNumber="2257"><Highlight kind="normal">  TargetOp.setReg(HardenedTargetReg);</Highlight></CodeLine>
<Link id="l02258" /><CodeLine lineNumber="2258"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02259" /><CodeLine lineNumber="2259"><Highlight kind="normal">  ++NumCallsOrJumpsHardened;</Highlight></CodeLine>
<Link id="l02260" /><CodeLine lineNumber="2260"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l02261" /><CodeLine lineNumber="2261"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02262" /><CodeLine lineNumber="2262" lineLink="#a9936c7db2226d0d94430b4e6a6648cc0"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/passsupport-h/#aaa970fc931c1c63037a8182e028d04b1">INITIALIZE&#95;PASS&#95;BEGIN</a>(<a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a77a626d52a8457ef92d87b702df1cb7f">X86SpeculativeLoadHardeningPass</a>, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a>,</Highlight></CodeLine>
<Link id="l02263" /><CodeLine lineNumber="2263"><Highlight kind="normal">                      </Highlight><Highlight kind="stringliteral">&quot;X86 speculative load hardener&quot;</Highlight><Highlight kind="normal">, </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">, </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">)</Highlight></CodeLine>
<Link id="l02264" /><CodeLine lineNumber="2264" lineLink="#aff35f54c90a52d054a6423bcf2683f1e"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/passsupport-h/#a74ce8276b89067e806f67c45a6d92575">INITIALIZE&#95;PASS&#95;END</a>(<a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a77a626d52a8457ef92d87b702df1cb7f">X86SpeculativeLoadHardeningPass</a>, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a>,</Highlight></CodeLine>
<Link id="l02265" /><CodeLine lineNumber="2265" lineLink="#a0d80253a045701908e9a2599a6d88b05"><Highlight kind="normal">                    </Highlight><Highlight kind="stringliteral">&quot;X86 speculative load hardener&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/false">false</a>, <a href="/docs/api/namespaces/false">false</a>)</Highlight></CodeLine>
<Link id="l02266" /><CodeLine lineNumber="2266"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l02267" /><CodeLine lineNumber="2267" lineLink="/docs/api/namespaces/llvm/#a65f5a5f0179a8e1cbb425fe8bf33069d"><Highlight kind="normal"><a href="/docs/api/classes/llvm/functionpass">FunctionPass</a> &#42;<a href="/docs/api/namespaces/llvm">llvm</a>::<a href="/docs/api/namespaces/llvm/#a65f5a5f0179a8e1cbb425fe8bf33069d">createX86SpeculativeLoadHardeningPass</a>() &#123;</Highlight></CodeLine>
<Link id="l02268" /><CodeLine lineNumber="2268"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">new</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a77a626d52a8457ef92d87b702df1cb7f">X86SpeculativeLoadHardeningPass</a>();</Highlight></CodeLine>
<Link id="l02269" /><CodeLine lineNumber="2269"><Highlight kind="normal">&#125;</Highlight></CodeLine>

</ProgramListing>


</DoxygenPage>
