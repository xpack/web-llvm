---

# DO NOT EDIT!
# Automatically generated via docusaurus-plugin-doxygen by Doxygen.

slug: /api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp
custom_edit_url: null
keywords:
  - doxygen
  - reference
  - file

---

import Link from '@docusaurus/Link'

import CodeLine from '@xpack/docusaurus-plugin-doxygen/components/CodeLine'
import DoxygenPage from '@xpack/docusaurus-plugin-doxygen/components/DoxygenPage'
import IncludesList from '@xpack/docusaurus-plugin-doxygen/components/IncludesList'
import IncludesListItem from '@xpack/docusaurus-plugin-doxygen/components/IncludesListItem'
import MemberDefinition from '@xpack/docusaurus-plugin-doxygen/components/MemberDefinition'
import MembersIndex from '@xpack/docusaurus-plugin-doxygen/components/MembersIndex'
import MembersIndexItem from '@xpack/docusaurus-plugin-doxygen/components/MembersIndexItem'
import ProgramListing from '@xpack/docusaurus-plugin-doxygen/components/ProgramListing'
import SectionDefinition from '@xpack/docusaurus-plugin-doxygen/components/SectionDefinition'

import pluginConfig from '@site/docusaurus-plugin-doxygen-config.json'

# The `X86SpeculativeLoadHardening.cpp` File Reference

<DoxygenPage pluginConfig={pluginConfig}>

Provide a pass which mitigates speculative execution attacks which operate by speculating incorrectly past some predicate (a type check, bounds check, or other condition) to reach a load with invalid inputs and leak the data accessed by that load using a side channel out of the speculative domain. <a href="#details">More...</a>

## Included Headers

<IncludesList>
<IncludesListItem
  filePath="X86.h"
  permalink="/docs/api/files/lib/lib/target/lib/target/x86/x86-h"
  isLocal="true" />
<IncludesListItem
  filePath="X86InstrInfo.h"
  permalink="/docs/api/files/lib/lib/target/lib/target/x86/x86instrinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="X86Subtarget.h"
  permalink="/docs/api/files/lib/lib/target/lib/target/x86/x86subtarget-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/ArrayRef.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/arrayref-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/DenseMap.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/densemap-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/STLExtras.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/stlextras-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SmallPtrSet.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/smallptrset-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SmallSet.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/smallset-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SmallVector.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/smallvector-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SparseBitVector.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/sparsebitvector-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/Statistic.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineBasicBlock.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machinebasicblock-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineConstantPool.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machineconstantpool-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineFunction.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machinefunction-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineFunctionPass.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machinefunctionpass-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineInstr.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machineinstr-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineInstrBuilder.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machineinstrbuilder-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineModuleInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machinemoduleinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineOperand.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machineoperand-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineRegisterInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machineregisterinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/MachineSSAUpdater.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/machinessaupdater-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/TargetInstrInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/targetinstrinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/TargetRegisterInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/targetregisterinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/TargetSchedule.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/targetschedule-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/CodeGen/TargetSubtargetInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/codegen/targetsubtargetinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/DebugLoc.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/debugloc-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/MC/MCSchedule.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/mc/mcschedule-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Pass.h"
  permalink="/docs/api/files/include/include/llvm/pass-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/CommandLine.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/Debug.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/debug-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/raw_ostream.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/raw-ostream-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Target/TargetMachine.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/target/targetmachine-h"
  isLocal="true" />
<IncludesListItem
  filePath="cassert"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="iterator"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="optional"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="utility"
  permalink=""
  isLocal="false" />
</IncludesList>

## Namespaces Index

<MembersIndex>

<MembersIndexItem
  type="namespace"
  name={<><a href="/docs/api/namespaces/anonymous-x86speculativeloadhardening-cpp-">anonymous&#123;X86SpeculativeLoadHardening.cpp&#125;</a></>}>
</MembersIndexItem>

</MembersIndex>

## Classes Index

<MembersIndex>

<MembersIndexItem
  type="class"
  name={<><a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass">X86SpeculativeLoadHardeningPass</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type="struct"
  name={<><a href="/docs/api/structs/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/blockcondinfo">BlockCondInfo</a></>}>
The information about a block&#39;s conditional terminators needed to trace our predicate state through the exiting edges. <a href="/docs/api/structs/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/blockcondinfo/#details">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="struct"
  name={<><a href="/docs/api/structs/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/predstate">PredState</a></>}>
Manages the predicate state traced through the program. <a href="/docs/api/structs/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/predstate/#details">More...</a>
</MembersIndexItem>

</MembersIndex>

## Functions Index

<MembersIndex>

<MembersIndexItem
  type="void"
  name={<><a href="#a22244f1af2bc880ef42bfd77068ce13a">canonicalizePHIOperands</a> (MachineFunction &amp;MF)</>}>
Removing duplicate PHI operands to leave the PHI in a canonical and predictable form. <a href="#a22244f1af2bc880ef42bfd77068ce13a">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/targetregisterclass">TargetRegisterClass</a> &#42;</>}
  name={<><a href="#aa521cd293ac8410168730efe322dce5c">getRegClassForUnfoldedLoad</a> (MachineFunction &amp;MF, const X86InstrInfo &amp;TII, unsigned Opcode)</>}>
Compute the register class for the unfolded load. <a href="#aa521cd293ac8410168730efe322dce5c">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#abe47da1ba1b5239bb67b26d5ebbca491">hasVulnerableLoad</a> (MachineFunction &amp;MF)</>}>
Helper to scan a function for loads vulnerable to misspeculation that we want to harden. <a href="#abe47da1ba1b5239bb67b26d5ebbca491">More...</a>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#a9936c7db2226d0d94430b4e6a6648cc0">INITIALIZE&#95;PASS&#95;BEGIN</a> (X86SpeculativeLoadHardeningPass, PASS&#95;KEY, &quot;X86 speculative load hardener&quot;, false, false) INITIALIZE&#95;PASS&#95;END(X86SpeculativeLoadHardeningPass</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#ac0e27a6dfaf334669f95954dee3d5920">isEFLAGSDefLive</a> (const MachineInstr &amp;MI)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a93f8e5dacbcd949d688c3af5f491468d">isEFLAGSLive</a> (MachineBasicBlock &amp;MBB, MachineBasicBlock::iterator I, const TargetRegisterInfo &amp;TRI)</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;</>}
  name={<><a href="#a18b17899654dd5adb69b62c89ba95783">splitEdge</a> (MachineBasicBlock &amp;MBB, MachineBasicBlock &amp;Succ, int SuccCount, MachineInstr &#42;Br, MachineInstr &#42;&amp;UncondBr, const X86InstrInfo &amp;TII)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#abbb5cb917c4afe9c66209bc642eb6a5f">STATISTIC</a> (NumCondBranchesTraced, &quot;Number of conditional branches traced&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#aeabc45e5daa9b054a69cfa1215f69b5e">STATISTIC</a> (NumBranchesUntraced, &quot;Number of branches unable to trace&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#a3f8b54dd7dbd4bdef5689d93e4e0d754">STATISTIC</a> (NumAddrRegsHardened, &quot;Number of address mode used registers hardaned&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#a291e16ec2436c1d92e36feb7f96b35ea">STATISTIC</a> (NumPostLoadRegsHardened, &quot;Number of post-load register values hardened&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#aed900ec52c62e93ce048bf67819df513">STATISTIC</a> (NumCallsOrJumpsHardened, &quot;Number of calls or jumps requiring extra hardening&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#a34189f0471defa93aceb2d490f4fc5f6">STATISTIC</a> (NumInstsInserted, &quot;Number of instructions inserted&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#ac89256de3537a18323a18efeb9a852d6">STATISTIC</a> (NumLFENCEsInserted, &quot;Number of lfence instructions inserted&quot;)</>}>
</MembersIndexItem>

</MembersIndex>

## Variables Index

<MembersIndex>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a7385b8089f422279adefa5007ef35dc6">EnablePostLoadHardening</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a964a795e07ed117f8049f44b16739763">EnableSpeculativeLoadHardening</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<>X86 speculative <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpumarklastscratchload-cpp/#a8a3fe89940744b94ffe5dacd6704c2be">load</a></>}
  name={<><a href="#a0d80253a045701908e9a2599a6d88b05">false</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a5ee11464d0d2e030d95afb0db83b801d">FenceCallAndRet</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a921b17e18b1d37ab8ca2b7375df1addf">HardenEdgesWithLFENCE</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<>X86 speculative <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpumarklastscratchload-cpp/#a8a3fe89940744b94ffe5dacd6704c2be">load</a></>}
  name={<><a href="#ac0ec809a83ff46671add6d5a7d19ff37">hardener</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#ade91f65a65e423e2002fb9b25b7b2a5c">HardenIndirectCallsAndJumps</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a3e42304d79c25684c4d464fd35fb868f">HardenInterprocedurally</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a2109babba3ed33aad17d1f97e9aef11b">HardenLoads</a></>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#aff35f54c90a52d054a6423bcf2683f1e">PASS&#95;KEY</a></>}>
</MembersIndexItem>

</MembersIndex>

## Defines Index

<MembersIndex>

<MembersIndexItem
  type="#define"
  name={<><a href="#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>&nbsp;&nbsp;&nbsp;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type="#define"
  name={<><a href="#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a>&nbsp;&nbsp;&nbsp;&quot;x86-slh&quot;</>}>
</MembersIndexItem>

</MembersIndex>

## Description {#details}

Provide a pass which mitigates speculative execution attacks which operate by speculating incorrectly past some predicate (a type check, bounds check, or other condition) to reach a load with invalid inputs and leak the data accessed by that load using a side channel out of the speculative domain.

For details on the attacks, see the first variant in both the Project Zero writeup and the Spectre paper: <a href="https://googleprojectzero.blogspot.com/2018/01/reading-privileged-memory-with-side.html">https://googleprojectzero.blogspot.com/2018/01/reading-privileged-memory-with-side.html</a> <a href="https://spectreattack.com/spectre.pdf">https://spectreattack.com/spectre.pdf</a>

<SectionDefinition>

## Functions

### canonicalizePHIOperands() {#a22244f1af2bc880ef42bfd77068ce13a}

<MemberDefinition
  prototype={<>static void canonicalizePHIOperands (<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp; MF)</>}
  labels = {["static"]}>
Removing duplicate PHI operands to leave the PHI in a canonical and predictable form.

FIXME: It&#39;s really frustrating that we have to do this, but SSA-form in MIR isn&#39;t what you might expect. We may have multiple entries in PHI nodes for a single predecessor. This makes CFG-updating extremely complex, so here we simplify all PHI nodes to a model even simpler than the IR&#39;s model: exactly one entry per predecessor, regardless of how many edges there are.

Definition at line <a href="#l00326">326</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### getRegClassForUnfoldedLoad() {#aa521cd293ac8410168730efe322dce5c}

<MemberDefinition
  prototype={<>static const TargetRegisterClass &#42; getRegClassForUnfoldedLoad (<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp; MF, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/x86instrinfo">X86InstrInfo</a> &amp; TII, unsigned Opcode)</>}
  labels = {["static"]}>
Compute the register class for the unfolded load.

FIXME: This should probably live in <a href="/docs/api/classes/llvm/x86instrinfo">X86InstrInfo</a>, potentially by adding a way to unfold into a newly created vreg rather than requiring a register input.

Definition at line <a href="#l00839">839</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### hasVulnerableLoad() {#abe47da1ba1b5239bb67b26d5ebbca491}

<MemberDefinition
  prototype={<>static bool hasVulnerableLoad (<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp; MF)</>}
  labels = {["static"]}>
Helper to scan a function for loads vulnerable to misspeculation that we want to harden.

We use this to avoid making changes to functions where there is nothing we need to do to harden against misspeculation.

Definition at line <a href="#l00370">370</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### INITIALIZE&#95;PASS&#95;BEGIN() {#a9936c7db2226d0d94430b4e6a6648cc0}

<MemberDefinition
  prototype={<>INITIALIZE&#95;PASS&#95;BEGIN (X86SpeculativeLoadHardeningPass, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a>, &quot;X86 speculative <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpumarklastscratchload-cpp/#a8a3fe89940744b94ffe5dacd6704c2be">load</a> hardener&quot;, false, false)</>}>

Definition at line <a href="#l02262">2262</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### isEFLAGSDefLive() {#ac0e27a6dfaf334669f95954dee3d5920}

<MemberDefinition
  prototype={<>static bool isEFLAGSDefLive (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp; MI)</>}
  labels = {["static"]}>

Definition at line <a href="#l01203">1203</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### isEFLAGSLive() {#a93f8e5dacbcd949d688c3af5f491468d}

<MemberDefinition
  prototype={<>static bool isEFLAGSLive (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp; MBB, <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> I, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/targetregisterinfo">TargetRegisterInfo</a> &amp; TRI)</>}
  labels = {["static"]}>

Definition at line <a href="#l01211">1211</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### splitEdge() {#a18b17899654dd5adb69b62c89ba95783}

<MemberDefinition
  prototype={<>static MachineBasicBlock &amp; splitEdge (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp; MBB, <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp; Succ, int SuccCount, <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42; Br, <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;&amp; UncondBr, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> <a href="/docs/api/classes/llvm/x86instrinfo">X86InstrInfo</a> &amp; TII)</>}
  labels = {["static"]}>

Definition at line <a href="#l00222">222</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### STATISTIC() {#abbb5cb917c4afe9c66209bc642eb6a5f}

<MemberDefinition
  prototype={<>STATISTIC (NumCondBranchesTraced, &quot;Number of conditional <a href="/docs/api/files/lib/lib/target/lib/target/arc/arcbranchfinalize-cpp/#a14311558a7445776def2d5bc13161ba3">branches</a> traced&quot;)</>}>

Definition at line <a href="#l00064">64</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### STATISTIC() {#aeabc45e5daa9b054a69cfa1215f69b5e}

<MemberDefinition
  prototype={<>STATISTIC (NumBranchesUntraced, &quot;Number of <a href="/docs/api/files/lib/lib/target/lib/target/arc/arcbranchfinalize-cpp/#a14311558a7445776def2d5bc13161ba3">branches</a> unable to trace&quot;)</>}>

Definition at line <a href="#l00065">65</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### STATISTIC() {#a3f8b54dd7dbd4bdef5689d93e4e0d754}

<MemberDefinition
  prototype={<>STATISTIC (NumAddrRegsHardened, &quot;Number of address <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagonoptaddrmode-cpp/#abdd61257a7f5e75ed961036299f26498">mode</a> used registers hardaned&quot;)</>}>

Definition at line <a href="#l00066">66</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### STATISTIC() {#a291e16ec2436c1d92e36feb7f96b35ea}

<MemberDefinition
  prototype={<>STATISTIC (NumPostLoadRegsHardened, &quot;Number of post-<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpumarklastscratchload-cpp/#a8a3fe89940744b94ffe5dacd6704c2be">load</a> register values hardened&quot;)</>}>

Definition at line <a href="#l00068">68</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### STATISTIC() {#aed900ec52c62e93ce048bf67819df513}

<MemberDefinition
  prototype={<>STATISTIC (NumCallsOrJumpsHardened, &quot;Number of calls or jumps requiring extra hardening&quot;)</>}>

Definition at line <a href="#l00070">70</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### STATISTIC() {#a34189f0471defa93aceb2d490f4fc5f6}

<MemberDefinition
  prototype={<>STATISTIC (NumInstsInserted, &quot;Number of <a href="/docs/api/files/lib/lib/codegen/atomicexpandpass-cpp/#a1bcc06b1cb86bd0ea08f33323190bdaa">instructions</a> inserted&quot;)</>}>

Definition at line <a href="#l00072">72</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### STATISTIC() {#ac89256de3537a18323a18efeb9a852d6}

<MemberDefinition
  prototype={<>STATISTIC (NumLFENCEsInserted, &quot;Number of lfence <a href="/docs/api/files/lib/lib/codegen/atomicexpandpass-cpp/#a1bcc06b1cb86bd0ea08f33323190bdaa">instructions</a> inserted&quot;)</>}>

Definition at line <a href="#l00073">73</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Variables

### EnablePostLoadHardening {#a7385b8089f422279adefa5007ef35dc6}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; EnablePostLoadHardening(PASS&#95;KEY &quot;-post-load&quot;, cl::desc(&quot;Harden the value loaded &#42;after&#42; it is loaded by &quot; &quot;flushing the loaded bits to 1. This is hard to do &quot; &quot;in general but can be done easily for GPRs.&quot;), cl::init(true), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00087">87</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### EnableSpeculativeLoadHardening {#a964a795e07ed117f8049f44b16739763}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; EnableSpeculativeLoadHardening(&quot;x86-speculative-load-hardening&quot;, cl::desc(&quot;Force enable speculative load hardening&quot;), cl::init(false), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00075">75</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### false {#a0d80253a045701908e9a2599a6d88b05}

<MemberDefinition
  prototype="X86 speculative load false">

Definition at line <a href="#l02265">2265</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### FenceCallAndRet {#a5ee11464d0d2e030d95afb0db83b801d}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; FenceCallAndRet(PASS&#95;KEY &quot;-fence-call-and-ret&quot;, cl::desc(&quot;Use a full speculation fence to harden both call and ret edges &quot; &quot;rather than a lighter weight mitigation.&quot;), cl::init(false), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00094">94</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### HardenEdgesWithLFENCE {#a921b17e18b1d37ab8ca2b7375df1addf}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; HardenEdgesWithLFENCE(PASS&#95;KEY &quot;-lfence&quot;, cl::desc( &quot;Use LFENCE along each conditional edge to harden against speculative &quot; &quot;loads rather than conditional movs and poisoned pointers.&quot;), cl::init(false), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00080">80</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### hardener {#ac0ec809a83ff46671add6d5a7d19ff37}

<MemberDefinition
  prototype="X86 speculative load hardener">

Definition at line <a href="#l02265">2265</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### HardenIndirectCallsAndJumps {#ade91f65a65e423e2002fb9b25b7b2a5c}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; HardenIndirectCallsAndJumps(PASS&#95;KEY &quot;-indirect&quot;, cl::desc(&quot;Harden indirect calls and jumps against using speculatively &quot; &quot;stored attacker controlled addresses. This is designed to &quot; &quot;mitigate Spectre v1.2 style attacks.&quot;), cl::init(true), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00112">112</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### HardenInterprocedurally {#a3e42304d79c25684c4d464fd35fb868f}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; HardenInterprocedurally(PASS&#95;KEY &quot;-ip&quot;, cl::desc(&quot;Harden interprocedurally by passing our state in and out of &quot; &quot;functions in the high bits of the stack pointer.&quot;), cl::init(true), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00100">100</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### HardenLoads {#a2109babba3ed33aad17d1f97e9aef11b}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; HardenLoads(PASS&#95;KEY &quot;-loads&quot;, cl::desc(&quot;Sanitize loads from memory. When disable, no &quot; &quot;significant security is provided.&quot;), cl::init(true), cl::Hidden)</>}
  labels = {["static"]}>

Definition at line <a href="#l00107">107</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### PASS&#95;KEY {#aff35f54c90a52d054a6423bcf2683f1e}

<MemberDefinition
  prototype={<>PASS&#95;KEY</>}>

Definition at line <a href="#l02264">2264</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Defines

### DEBUG&#95;TYPE {#ad78e062f62e0d6e453941fb4ca843e4d}

<MemberDefinition
  prototype={<>#define DEBUG&#95;TYPE&nbsp;&nbsp;&nbsp;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a></>}>

Definition at line <a href="#l00062">62</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

### PASS&#95;KEY {#ae0a7815fb436ce6db7cb0a91755daef7}

<MemberDefinition
  prototype={<>#define PASS&#95;KEY&nbsp;&nbsp;&nbsp;&quot;x86-slh&quot;</>}>

Definition at line <a href="#l00061">61</a> of file <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86speculativeloadhardening-cpp">X86SpeculativeLoadHardening.cpp</a>.
</MemberDefinition>

</SectionDefinition>

## File Listing

The file content with the documentation metadata removed is:

<ProgramListing>

<Link id="l00001" /><CodeLine lineNumber="1"><span class="doxyHighlightComment">//====- X86SpeculativeLoadHardening.cpp - A Spectre v1 mitigation ---------===//</span></CodeLine>
<Link id="l00002" /><CodeLine lineNumber="2"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00003" /><CodeLine lineNumber="3"><span class="doxyHighlightComment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</span></CodeLine>
<Link id="l00004" /><CodeLine lineNumber="4"><span class="doxyHighlightComment">// See https://llvm.org/LICENSE.txt for license information.</span></CodeLine>
<Link id="l00005" /><CodeLine lineNumber="5"><span class="doxyHighlightComment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</span></CodeLine>
<Link id="l00006" /><CodeLine lineNumber="6"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00007" /><CodeLine lineNumber="7"><span class="doxyHighlightComment">//===----------------------------------------------------------------------===//</span></CodeLine>
<Link id="l00008" /><CodeLine lineNumber="8"><span class="doxyHighlightComment">/// \\file</span></CodeLine>
<Link id="l00009" /><CodeLine lineNumber="9"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00010" /><CodeLine lineNumber="10"><span class="doxyHighlightComment">/// Provide a pass which mitigates speculative execution attacks which operate</span></CodeLine>
<Link id="l00011" /><CodeLine lineNumber="11"><span class="doxyHighlightComment">/// by speculating incorrectly past some predicate (a type check, bounds check,</span></CodeLine>
<Link id="l00012" /><CodeLine lineNumber="12"><span class="doxyHighlightComment">/// or other condition) to reach a load with invalid inputs and leak the data</span></CodeLine>
<Link id="l00013" /><CodeLine lineNumber="13"><span class="doxyHighlightComment">/// accessed by that load using a side channel out of the speculative domain.</span></CodeLine>
<Link id="l00014" /><CodeLine lineNumber="14"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00015" /><CodeLine lineNumber="15"><span class="doxyHighlightComment">/// For details on the attacks, see the first variant in both the Project Zero</span></CodeLine>
<Link id="l00016" /><CodeLine lineNumber="16"><span class="doxyHighlightComment">/// writeup and the Spectre paper:</span></CodeLine>
<Link id="l00017" /><CodeLine lineNumber="17"><span class="doxyHighlightComment">/// https://googleprojectzero.blogspot.com/2018/01/reading-privileged-memory-with-side.html</span></CodeLine>
<Link id="l00018" /><CodeLine lineNumber="18"><span class="doxyHighlightComment">/// https://spectreattack.com/spectre.pdf</span></CodeLine>
<Link id="l00019" /><CodeLine lineNumber="19"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00020" /><CodeLine lineNumber="20"><span class="doxyHighlightComment">//===----------------------------------------------------------------------===//</span></CodeLine>
<Link id="l00021" /><CodeLine lineNumber="21"></CodeLine>
<Link id="l00022" /><CodeLine lineNumber="22"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86-h">X86.h</a>&quot;</span></CodeLine>
<Link id="l00023" /><CodeLine lineNumber="23"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86instrinfo-h">X86InstrInfo.h</a>&quot;</span></CodeLine>
<Link id="l00024" /><CodeLine lineNumber="24"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86subtarget-h">X86Subtarget.h</a>&quot;</span></CodeLine>
<Link id="l00025" /><CodeLine lineNumber="25"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/arrayref-h">llvm/ADT/ArrayRef.h</a>&quot;</span></CodeLine>
<Link id="l00026" /><CodeLine lineNumber="26"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/densemap-h">llvm/ADT/DenseMap.h</a>&quot;</span></CodeLine>
<Link id="l00027" /><CodeLine lineNumber="27"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/stlextras-h">llvm/ADT/STLExtras.h</a>&quot;</span></CodeLine>
<Link id="l00028" /><CodeLine lineNumber="28"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/smallptrset-h">llvm/ADT/SmallPtrSet.h</a>&quot;</span></CodeLine>
<Link id="l00029" /><CodeLine lineNumber="29"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/smallset-h">llvm/ADT/SmallSet.h</a>&quot;</span></CodeLine>
<Link id="l00030" /><CodeLine lineNumber="30"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/smallvector-h">llvm/ADT/SmallVector.h</a>&quot;</span></CodeLine>
<Link id="l00031" /><CodeLine lineNumber="31"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/sparsebitvector-h">llvm/ADT/SparseBitVector.h</a>&quot;</span></CodeLine>
<Link id="l00032" /><CodeLine lineNumber="32"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h">llvm/ADT/Statistic.h</a>&quot;</span></CodeLine>
<Link id="l00033" /><CodeLine lineNumber="33"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machinebasicblock-h">llvm/CodeGen/MachineBasicBlock.h</a>&quot;</span></CodeLine>
<Link id="l00034" /><CodeLine lineNumber="34"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machineconstantpool-h">llvm/CodeGen/MachineConstantPool.h</a>&quot;</span></CodeLine>
<Link id="l00035" /><CodeLine lineNumber="35"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machinefunction-h">llvm/CodeGen/MachineFunction.h</a>&quot;</span></CodeLine>
<Link id="l00036" /><CodeLine lineNumber="36"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machinefunctionpass-h">llvm/CodeGen/MachineFunctionPass.h</a>&quot;</span></CodeLine>
<Link id="l00037" /><CodeLine lineNumber="37"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machineinstr-h">llvm/CodeGen/MachineInstr.h</a>&quot;</span></CodeLine>
<Link id="l00038" /><CodeLine lineNumber="38"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machineinstrbuilder-h">llvm/CodeGen/MachineInstrBuilder.h</a>&quot;</span></CodeLine>
<Link id="l00039" /><CodeLine lineNumber="39"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machinemoduleinfo-h">llvm/CodeGen/MachineModuleInfo.h</a>&quot;</span></CodeLine>
<Link id="l00040" /><CodeLine lineNumber="40"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machineoperand-h">llvm/CodeGen/MachineOperand.h</a>&quot;</span></CodeLine>
<Link id="l00041" /><CodeLine lineNumber="41"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machineregisterinfo-h">llvm/CodeGen/MachineRegisterInfo.h</a>&quot;</span></CodeLine>
<Link id="l00042" /><CodeLine lineNumber="42"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/machinessaupdater-h">llvm/CodeGen/MachineSSAUpdater.h</a>&quot;</span></CodeLine>
<Link id="l00043" /><CodeLine lineNumber="43"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/targetinstrinfo-h">llvm/CodeGen/TargetInstrInfo.h</a>&quot;</span></CodeLine>
<Link id="l00044" /><CodeLine lineNumber="44"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/targetregisterinfo-h">llvm/CodeGen/TargetRegisterInfo.h</a>&quot;</span></CodeLine>
<Link id="l00045" /><CodeLine lineNumber="45"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/targetschedule-h">llvm/CodeGen/TargetSchedule.h</a>&quot;</span></CodeLine>
<Link id="l00046" /><CodeLine lineNumber="46"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/codegen/targetsubtargetinfo-h">llvm/CodeGen/TargetSubtargetInfo.h</a>&quot;</span></CodeLine>
<Link id="l00047" /><CodeLine lineNumber="47"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/debugloc-h">llvm/IR/DebugLoc.h</a>&quot;</span></CodeLine>
<Link id="l00048" /><CodeLine lineNumber="48"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/mc/mcschedule-h">llvm/MC/MCSchedule.h</a>&quot;</span></CodeLine>
<Link id="l00049" /><CodeLine lineNumber="49"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/pass-h">llvm/Pass.h</a>&quot;</span></CodeLine>
<Link id="l00050" /><CodeLine lineNumber="50"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h">llvm/Support/CommandLine.h</a>&quot;</span></CodeLine>
<Link id="l00051" /><CodeLine lineNumber="51"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h">llvm/Support/Debug.h</a>&quot;</span></CodeLine>
<Link id="l00052" /><CodeLine lineNumber="52"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/raw-ostream-h">llvm/Support/raw&#95;ostream.h</a>&quot;</span></CodeLine>
<Link id="l00053" /><CodeLine lineNumber="53"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/target/targetmachine-h">llvm/Target/TargetMachine.h</a>&quot;</span></CodeLine>
<Link id="l00054" /><CodeLine lineNumber="54"><span class="doxyHighlightPreprocessor">#include &lt;cassert&gt;</span></CodeLine>
<Link id="l00055" /><CodeLine lineNumber="55"><span class="doxyHighlightPreprocessor">#include &lt;iterator&gt;</span></CodeLine>
<Link id="l00056" /><CodeLine lineNumber="56"><span class="doxyHighlightPreprocessor">#include &lt;optional&gt;</span></CodeLine>
<Link id="l00057" /><CodeLine lineNumber="57"><span class="doxyHighlightPreprocessor">#include &lt;utility&gt;</span></CodeLine>
<Link id="l00058" /><CodeLine lineNumber="58"></CodeLine>
<Link id="l00059" /><CodeLine lineNumber="59"><span class="doxyHighlightKeyword">using namespace </span><span class="doxyHighlight"><a href="/docs/api/namespaces/llvm">llvm</a>;</span></CodeLine>
<Link id="l00060" /><CodeLine lineNumber="60"></CodeLine>
<Link id="l00061" /><CodeLine lineNumber="61" lineLink="#ae0a7815fb436ce6db7cb0a91755daef7"><span class="doxyHighlightPreprocessor">#define PASS&#95;KEY &quot;x86-slh&quot;</span></CodeLine>
<Link id="l00062" /><CodeLine lineNumber="62" lineLink="#ad78e062f62e0d6e453941fb4ca843e4d"><span class="doxyHighlightPreprocessor">#define DEBUG&#95;TYPE PASS&#95;KEY</span></CodeLine>
<Link id="l00063" /><CodeLine lineNumber="63"></CodeLine>
<Link id="l00064" /><CodeLine lineNumber="64" lineLink="#abbb5cb917c4afe9c66209bc642eb6a5f"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumCondBranchesTraced, </span><span class="doxyHighlightStringLiteral">&quot;Number of conditional branches traced&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00065" /><CodeLine lineNumber="65" lineLink="#aeabc45e5daa9b054a69cfa1215f69b5e"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumBranchesUntraced, </span><span class="doxyHighlightStringLiteral">&quot;Number of branches unable to trace&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00066" /><CodeLine lineNumber="66" lineLink="#a3f8b54dd7dbd4bdef5689d93e4e0d754"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumAddrRegsHardened,</span></CodeLine>
<Link id="l00067" /><CodeLine lineNumber="67"><span class="doxyHighlight">          </span><span class="doxyHighlightStringLiteral">&quot;Number of address mode used registers hardaned&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00068" /><CodeLine lineNumber="68" lineLink="#a291e16ec2436c1d92e36feb7f96b35ea"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumPostLoadRegsHardened,</span></CodeLine>
<Link id="l00069" /><CodeLine lineNumber="69"><span class="doxyHighlight">          </span><span class="doxyHighlightStringLiteral">&quot;Number of post-load register values hardened&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00070" /><CodeLine lineNumber="70" lineLink="#aed900ec52c62e93ce048bf67819df513"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumCallsOrJumpsHardened,</span></CodeLine>
<Link id="l00071" /><CodeLine lineNumber="71"><span class="doxyHighlight">          </span><span class="doxyHighlightStringLiteral">&quot;Number of calls or jumps requiring extra hardening&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00072" /><CodeLine lineNumber="72" lineLink="#a34189f0471defa93aceb2d490f4fc5f6"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumInstsInserted, </span><span class="doxyHighlightStringLiteral">&quot;Number of instructions inserted&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00073" /><CodeLine lineNumber="73" lineLink="#ac89256de3537a18323a18efeb9a852d6"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumLFENCEsInserted, </span><span class="doxyHighlightStringLiteral">&quot;Number of lfence instructions inserted&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00074" /><CodeLine lineNumber="74"></CodeLine>
<Link id="l00075" /><CodeLine lineNumber="75" lineLink="#a964a795e07ed117f8049f44b16739763"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a964a795e07ed117f8049f44b16739763">EnableSpeculativeLoadHardening</a>(</span></CodeLine>
<Link id="l00076" /><CodeLine lineNumber="76"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;x86-speculative-load-hardening&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00077" /><CodeLine lineNumber="77"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Force enable speculative load hardening&quot;</span><span class="doxyHighlight">), <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00078" /><CodeLine lineNumber="78"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00079" /><CodeLine lineNumber="79"></CodeLine>
<Link id="l00080" /><CodeLine lineNumber="80" lineLink="#a921b17e18b1d37ab8ca2b7375df1addf"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a921b17e18b1d37ab8ca2b7375df1addf">HardenEdgesWithLFENCE</a>(</span></CodeLine>
<Link id="l00081" /><CodeLine lineNumber="81"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a> </span><span class="doxyHighlightStringLiteral">&quot;-lfence&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00082" /><CodeLine lineNumber="82"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span></CodeLine>
<Link id="l00083" /><CodeLine lineNumber="83"><span class="doxyHighlight">        </span><span class="doxyHighlightStringLiteral">&quot;Use LFENCE along each conditional edge to harden against speculative &quot;</span></CodeLine>
<Link id="l00084" /><CodeLine lineNumber="84"><span class="doxyHighlight">        </span><span class="doxyHighlightStringLiteral">&quot;loads rather than conditional movs and poisoned pointers.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00085" /><CodeLine lineNumber="85"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00086" /><CodeLine lineNumber="86"></CodeLine>
<Link id="l00087" /><CodeLine lineNumber="87" lineLink="#a7385b8089f422279adefa5007ef35dc6"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a7385b8089f422279adefa5007ef35dc6">EnablePostLoadHardening</a>(</span></CodeLine>
<Link id="l00088" /><CodeLine lineNumber="88"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a> </span><span class="doxyHighlightStringLiteral">&quot;-post-load&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00089" /><CodeLine lineNumber="89"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Harden the value loaded &#42;after&#42; it is loaded by &quot;</span></CodeLine>
<Link id="l00090" /><CodeLine lineNumber="90"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;flushing the loaded bits to 1 This is hard to do &quot;</span></CodeLine>
<Link id="l00091" /><CodeLine lineNumber="91"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;in general but can be done easily for GPRs.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00092" /><CodeLine lineNumber="92"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00093" /><CodeLine lineNumber="93"></CodeLine>
<Link id="l00094" /><CodeLine lineNumber="94" lineLink="#a5ee11464d0d2e030d95afb0db83b801d"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a5ee11464d0d2e030d95afb0db83b801d">FenceCallAndRet</a>(</span></CodeLine>
<Link id="l00095" /><CodeLine lineNumber="95"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a> </span><span class="doxyHighlightStringLiteral">&quot;-fence-call-and-ret&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00096" /><CodeLine lineNumber="96"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Use a full speculation fence to harden both call and ret edges &quot;</span></CodeLine>
<Link id="l00097" /><CodeLine lineNumber="97"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;rather than a lighter weight mitigation.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00098" /><CodeLine lineNumber="98"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00099" /><CodeLine lineNumber="99"></CodeLine>
<Link id="l00100" /><CodeLine lineNumber="100" lineLink="#a3e42304d79c25684c4d464fd35fb868f"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a3e42304d79c25684c4d464fd35fb868f">HardenInterprocedurally</a>(</span></CodeLine>
<Link id="l00101" /><CodeLine lineNumber="101"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a> </span><span class="doxyHighlightStringLiteral">&quot;-ip&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00102" /><CodeLine lineNumber="102"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Harden interprocedurally by passing our state in and out of &quot;</span></CodeLine>
<Link id="l00103" /><CodeLine lineNumber="103"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;functions in the high bits of the stack pointer.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00104" /><CodeLine lineNumber="104"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00105" /><CodeLine lineNumber="105"></CodeLine>
<Link id="l00106" /><CodeLine lineNumber="106"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a></span></CodeLine>
<Link id="l00107" /><CodeLine lineNumber="107" lineLink="#a2109babba3ed33aad17d1f97e9aef11b"><span class="doxyHighlight">    <a href="#a2109babba3ed33aad17d1f97e9aef11b">HardenLoads</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a> </span><span class="doxyHighlightStringLiteral">&quot;-loads&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00108" /><CodeLine lineNumber="108"><span class="doxyHighlight">                <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Sanitize loads from memory. When disable, no &quot;</span></CodeLine>
<Link id="l00109" /><CodeLine lineNumber="109"><span class="doxyHighlight">                         </span><span class="doxyHighlightStringLiteral">&quot;significant security is provided.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00110" /><CodeLine lineNumber="110"><span class="doxyHighlight">                <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00111" /><CodeLine lineNumber="111"></CodeLine>
<Link id="l00112" /><CodeLine lineNumber="112" lineLink="#ade91f65a65e423e2002fb9b25b7b2a5c"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#ade91f65a65e423e2002fb9b25b7b2a5c">HardenIndirectCallsAndJumps</a>(</span></CodeLine>
<Link id="l00113" /><CodeLine lineNumber="113"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a> </span><span class="doxyHighlightStringLiteral">&quot;-indirect&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00114" /><CodeLine lineNumber="114"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Harden indirect calls and jumps against using speculatively &quot;</span></CodeLine>
<Link id="l00115" /><CodeLine lineNumber="115"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;stored attacker controlled addresses. This is designed to &quot;</span></CodeLine>
<Link id="l00116" /><CodeLine lineNumber="116"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;mitigate Spectre v1.2 style attacks.&quot;</span><span class="doxyHighlight">),</span></CodeLine>
<Link id="l00117" /><CodeLine lineNumber="117"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>);</span></CodeLine>
<Link id="l00118" /><CodeLine lineNumber="118"></CodeLine>
<Link id="l00119" /><CodeLine lineNumber="119" lineLink="/docs/api/namespaces/anonymous-x86speculativeloadhardening-cpp-"><span class="doxyHighlightKeyword">namespace </span><span class="doxyHighlight">&#123;</span></CodeLine>
<Link id="l00120" /><CodeLine lineNumber="120"></CodeLine>
<Link id="l00121" /><CodeLine lineNumber="121" lineLink="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass"><span class="doxyHighlightKeyword">class </span><span class="doxyHighlight"><a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a77a626d52a8457ef92d87b702df1cb7f">X86SpeculativeLoadHardeningPass</a> : </span><span class="doxyHighlightKeyword">public</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinefunctionpass/#a29c81d2386f4a727c6d33413807530c8">MachineFunctionPass</a> &#123;</span></CodeLine>
<Link id="l00122" /><CodeLine lineNumber="122"><span class="doxyHighlightKeyword">public</span><span class="doxyHighlight">:</span></CodeLine>
<Link id="l00123" /><CodeLine lineNumber="123" lineLink="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a77a626d52a8457ef92d87b702df1cb7f"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a77a626d52a8457ef92d87b702df1cb7f">X86SpeculativeLoadHardeningPass</a>() : <a href="/docs/api/classes/llvm/machinefunctionpass/#a29c81d2386f4a727c6d33413807530c8">MachineFunctionPass</a>(<a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a845bb9b2068e7fd8052fc0e53ed461e5">ID</a>) &#123; &#125;</span></CodeLine>
<Link id="l00124" /><CodeLine lineNumber="124"></CodeLine>
<Link id="l00125" /><CodeLine lineNumber="125" lineLink="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#afc095bc1100ba5f1e44a49e741303f28"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/stringref">StringRef</a> <a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#afc095bc1100ba5f1e44a49e741303f28">getPassName</a>()</span><span class="doxyHighlightKeyword"> const override </span><span class="doxyHighlight">&#123;</span></CodeLine>
<Link id="l00126" /><CodeLine lineNumber="126"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightStringLiteral">&quot;X86 speculative load hardening&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00127" /><CodeLine lineNumber="127"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00128" /><CodeLine lineNumber="128"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> runOnMachineFunction(<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF) </span><span class="doxyHighlightKeyword">override</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00129" /><CodeLine lineNumber="129"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> getAnalysisUsage(<a href="/docs/api/classes/llvm/analysisusage">AnalysisUsage</a> &amp;AU) </span><span class="doxyHighlightKeyword">const override</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00130" /><CodeLine lineNumber="130"></CodeLine>
<Link id="l00131" /><CodeLine lineNumber="131"><span class="doxyHighlightComment">  /// Pass identification, replacement for typeid.</span></CodeLine>
<Link id="l00132" /><CodeLine lineNumber="132" lineLink="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a845bb9b2068e7fd8052fc0e53ed461e5"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">char</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a845bb9b2068e7fd8052fc0e53ed461e5">ID</a>;</span></CodeLine>
<Link id="l00133" /><CodeLine lineNumber="133"></CodeLine>
<Link id="l00134" /><CodeLine lineNumber="134"><span class="doxyHighlightKeyword">private</span><span class="doxyHighlight">:</span></CodeLine>
<Link id="l00135" /><CodeLine lineNumber="135"><span class="doxyHighlightComment">  /// The information about a block&#39;s conditional terminators needed to trace</span></CodeLine>
<Link id="l00136" /><CodeLine lineNumber="136"><span class="doxyHighlightComment">  /// our predicate state through the exiting edges.</span></CodeLine>
<Link id="l00137" /><CodeLine lineNumber="137"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">struct </span><span class="doxyHighlight">BlockCondInfo &#123;</span></CodeLine>
<Link id="l00138" /><CodeLine lineNumber="138"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>;</span></CodeLine>
<Link id="l00139" /><CodeLine lineNumber="139"></CodeLine>
<Link id="l00140" /><CodeLine lineNumber="140"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We mostly have one conditional branch, and in extremely rare cases have</span></CodeLine>
<Link id="l00141" /><CodeLine lineNumber="141"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// two. Three and more are so rare as to be unimportant for compile time.</span></CodeLine>
<Link id="l00142" /><CodeLine lineNumber="142"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineInstr &#42;, 2&gt;</a> CondBrs;</span></CodeLine>
<Link id="l00143" /><CodeLine lineNumber="143"></CodeLine>
<Link id="l00144" /><CodeLine lineNumber="144"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;UncondBr;</span></CodeLine>
<Link id="l00145" /><CodeLine lineNumber="145"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l00146" /><CodeLine lineNumber="146"></CodeLine>
<Link id="l00147" /><CodeLine lineNumber="147"><span class="doxyHighlightComment">  /// Manages the predicate state traced through the program.</span></CodeLine>
<Link id="l00148" /><CodeLine lineNumber="148"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">struct </span><span class="doxyHighlight">PredState &#123;</span></CodeLine>
<Link id="l00149" /><CodeLine lineNumber="149"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> InitialReg = 0;</span></CodeLine>
<Link id="l00150" /><CodeLine lineNumber="150"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> PoisonReg = 0;</span></CodeLine>
<Link id="l00151" /><CodeLine lineNumber="151"></CodeLine>
<Link id="l00152" /><CodeLine lineNumber="152"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/targetregisterclass">TargetRegisterClass</a> &#42;RC;</span></CodeLine>
<Link id="l00153" /><CodeLine lineNumber="153"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinessaupdater">MachineSSAUpdater</a> <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>;</span></CodeLine>
<Link id="l00154" /><CodeLine lineNumber="154"></CodeLine>
<Link id="l00155" /><CodeLine lineNumber="155"><span class="doxyHighlight">    PredState(<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/targetregisterclass">TargetRegisterClass</a> &#42;RC)</span></CodeLine>
<Link id="l00156" /><CodeLine lineNumber="156"><span class="doxyHighlight">        : RC(RC), <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>(MF) &#123;&#125;</span></CodeLine>
<Link id="l00157" /><CodeLine lineNumber="157"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l00158" /><CodeLine lineNumber="158"></CodeLine>
<Link id="l00159" /><CodeLine lineNumber="159"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> X86Subtarget &#42;Subtarget = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00160" /><CodeLine lineNumber="160"><span class="doxyHighlight">  MachineRegisterInfo &#42;MRI = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00161" /><CodeLine lineNumber="161"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> X86InstrInfo &#42;TII = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00162" /><CodeLine lineNumber="162"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> TargetRegisterInfo &#42;TRI = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00163" /><CodeLine lineNumber="163"></CodeLine>
<Link id="l00164" /><CodeLine lineNumber="164"><span class="doxyHighlight">  std::optional&lt;PredState&gt; PS;</span></CodeLine>
<Link id="l00165" /><CodeLine lineNumber="165"></CodeLine>
<Link id="l00166" /><CodeLine lineNumber="166"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> hardenEdgesWithLFENCE(MachineFunction &amp;MF);</span></CodeLine>
<Link id="l00167" /><CodeLine lineNumber="167"></CodeLine>
<Link id="l00168" /><CodeLine lineNumber="168"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a8fc529c79977cdd01e187986f960a07f">SmallVector&lt;BlockCondInfo, 16&gt;</a> collectBlockCondInfo(MachineFunction &amp;MF);</span></CodeLine>
<Link id="l00169" /><CodeLine lineNumber="169"></CodeLine>
<Link id="l00170" /><CodeLine lineNumber="170"><span class="doxyHighlight">  SmallVector&lt;MachineInstr &#42;, 16&gt;</span></CodeLine>
<Link id="l00171" /><CodeLine lineNumber="171"><span class="doxyHighlight">  tracePredStateThroughCFG(MachineFunction &amp;MF, <a href="/docs/api/namespaces/llvm/#ab9c6b351507d3c0730f4290919d43a12">ArrayRef&lt;BlockCondInfo&gt;</a> Infos);</span></CodeLine>
<Link id="l00172" /><CodeLine lineNumber="172"></CodeLine>
<Link id="l00173" /><CodeLine lineNumber="173"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> unfoldCallAndJumpLoads(MachineFunction &amp;MF);</span></CodeLine>
<Link id="l00174" /><CodeLine lineNumber="174"></CodeLine>
<Link id="l00175" /><CodeLine lineNumber="175"><span class="doxyHighlight">  SmallVector&lt;MachineInstr &#42;, 16&gt;</span></CodeLine>
<Link id="l00176" /><CodeLine lineNumber="176"><span class="doxyHighlight">  tracePredStateThroughIndirectBranches(MachineFunction &amp;MF);</span></CodeLine>
<Link id="l00177" /><CodeLine lineNumber="177"></CodeLine>
<Link id="l00178" /><CodeLine lineNumber="178"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> tracePredStateThroughBlocksAndHarden(MachineFunction &amp;MF);</span></CodeLine>
<Link id="l00179" /><CodeLine lineNumber="179"></CodeLine>
<Link id="l00180" /><CodeLine lineNumber="180"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> saveEFLAGS(MachineBasicBlock &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>,</span></CodeLine>
<Link id="l00181" /><CodeLine lineNumber="181"><span class="doxyHighlight">                      <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> InsertPt,</span></CodeLine>
<Link id="l00182" /><CodeLine lineNumber="182"><span class="doxyHighlight">                      </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a> &amp;Loc);</span></CodeLine>
<Link id="l00183" /><CodeLine lineNumber="183"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> restoreEFLAGS(MachineBasicBlock &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>,</span></CodeLine>
<Link id="l00184" /><CodeLine lineNumber="184"><span class="doxyHighlight">                     <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> InsertPt, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a> &amp;Loc,</span></CodeLine>
<Link id="l00185" /><CodeLine lineNumber="185"><span class="doxyHighlight">                     <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/mem2reg-cpp/#a6fde3eb6ca09ddf2fd76432176d817bb">Register</a> <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>);</span></CodeLine>
<Link id="l00186" /><CodeLine lineNumber="186"></CodeLine>
<Link id="l00187" /><CodeLine lineNumber="187"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> mergePredStateIntoSP(MachineBasicBlock &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>,</span></CodeLine>
<Link id="l00188" /><CodeLine lineNumber="188"><span class="doxyHighlight">                            <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> InsertPt,</span></CodeLine>
<Link id="l00189" /><CodeLine lineNumber="189"><span class="doxyHighlight">                            </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a> &amp;Loc, </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> PredStateReg);</span></CodeLine>
<Link id="l00190" /><CodeLine lineNumber="190"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> extractPredStateFromSP(MachineBasicBlock &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>,</span></CodeLine>
<Link id="l00191" /><CodeLine lineNumber="191"><span class="doxyHighlight">                                  <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> InsertPt,</span></CodeLine>
<Link id="l00192" /><CodeLine lineNumber="192"><span class="doxyHighlight">                                  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a> &amp;Loc);</span></CodeLine>
<Link id="l00193" /><CodeLine lineNumber="193"></CodeLine>
<Link id="l00194" /><CodeLine lineNumber="194"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span></CodeLine>
<Link id="l00195" /><CodeLine lineNumber="195"><span class="doxyHighlight">  hardenLoadAddr(MachineInstr &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>, MachineOperand &amp;BaseMO,</span></CodeLine>
<Link id="l00196" /><CodeLine lineNumber="196"><span class="doxyHighlight">                 MachineOperand &amp;IndexMO,</span></CodeLine>
<Link id="l00197" /><CodeLine lineNumber="197"><span class="doxyHighlight">                 SmallDenseMap&lt;unsigned, unsigned, 32&gt; &amp;AddrRegToHardenedReg);</span></CodeLine>
<Link id="l00198" /><CodeLine lineNumber="198"><span class="doxyHighlight">  MachineInstr &#42;</span></CodeLine>
<Link id="l00199" /><CodeLine lineNumber="199"><span class="doxyHighlight">  sinkPostLoadHardenedInst(MachineInstr &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>,</span></CodeLine>
<Link id="l00200" /><CodeLine lineNumber="200"><span class="doxyHighlight">                           SmallPtrSetImpl&lt;MachineInstr &#42;&gt; &amp;HardenedInstrs);</span></CodeLine>
<Link id="l00201" /><CodeLine lineNumber="201"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> canHardenRegister(<a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/mem2reg-cpp/#a6fde3eb6ca09ddf2fd76432176d817bb">Register</a> <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>);</span></CodeLine>
<Link id="l00202" /><CodeLine lineNumber="202"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> hardenValueInRegister(<a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/mem2reg-cpp/#a6fde3eb6ca09ddf2fd76432176d817bb">Register</a> <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>, MachineBasicBlock &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>,</span></CodeLine>
<Link id="l00203" /><CodeLine lineNumber="203"><span class="doxyHighlight">                                 <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> InsertPt,</span></CodeLine>
<Link id="l00204" /><CodeLine lineNumber="204"><span class="doxyHighlight">                                 </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a> &amp;Loc);</span></CodeLine>
<Link id="l00205" /><CodeLine lineNumber="205"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> hardenPostLoad(MachineInstr &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</span></CodeLine>
<Link id="l00206" /><CodeLine lineNumber="206"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> hardenReturnInstr(MachineInstr &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</span></CodeLine>
<Link id="l00207" /><CodeLine lineNumber="207"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> tracePredStateThroughCall(MachineInstr &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</span></CodeLine>
<Link id="l00208" /><CodeLine lineNumber="208"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> hardenIndirectCallOrJumpInstr(</span></CodeLine>
<Link id="l00209" /><CodeLine lineNumber="209"><span class="doxyHighlight">      MachineInstr &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>,</span></CodeLine>
<Link id="l00210" /><CodeLine lineNumber="210"><span class="doxyHighlight">      SmallDenseMap&lt;unsigned, unsigned, 32&gt; &amp;AddrRegToHardenedReg);</span></CodeLine>
<Link id="l00211" /><CodeLine lineNumber="211"><span class="doxyHighlight">&#125;;</span></CodeLine>
<Link id="l00212" /><CodeLine lineNumber="212"></CodeLine>
<Link id="l00213" /><CodeLine lineNumber="213"><span class="doxyHighlight">&#125; </span><span class="doxyHighlightComment">// end anonymous namespace</span></CodeLine>
<Link id="l00214" /><CodeLine lineNumber="214"></CodeLine>
<Link id="l00215" /><CodeLine lineNumber="215"><span class="doxyHighlightKeywordType">char</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a845bb9b2068e7fd8052fc0e53ed461e5">X86SpeculativeLoadHardeningPass::ID</a> = 0;</span></CodeLine>
<Link id="l00216" /><CodeLine lineNumber="216"></CodeLine>
<Link id="l00217" /><CodeLine lineNumber="217" lineLink="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a395357d9b35c4d32866dac3ab09a335a"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a395357d9b35c4d32866dac3ab09a335a">X86SpeculativeLoadHardeningPass::getAnalysisUsage</a>(</span></CodeLine>
<Link id="l00218" /><CodeLine lineNumber="218"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/analysisusage">AnalysisUsage</a> &amp;AU)</span><span class="doxyHighlightKeyword"> const </span><span class="doxyHighlight">&#123;</span></CodeLine>
<Link id="l00219" /><CodeLine lineNumber="219"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinefunctionpass/#a864fd57b4304ef933b3281d0ef85a88e">MachineFunctionPass::getAnalysisUsage</a>(AU);</span></CodeLine>
<Link id="l00220" /><CodeLine lineNumber="220"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00221" /><CodeLine lineNumber="221"></CodeLine>
<Link id="l00222" /><CodeLine lineNumber="222" lineLink="#a18b17899654dd5adb69b62c89ba95783"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="#a18b17899654dd5adb69b62c89ba95783">splitEdge</a>(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>,</span></CodeLine>
<Link id="l00223" /><CodeLine lineNumber="223"><span class="doxyHighlight">                                    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;Succ, </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> SuccCount,</span></CodeLine>
<Link id="l00224" /><CodeLine lineNumber="224"><span class="doxyHighlight">                                    <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;Br, <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;&amp;UncondBr,</span></CodeLine>
<Link id="l00225" /><CodeLine lineNumber="225"><span class="doxyHighlight">                                    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/x86instrinfo">X86InstrInfo</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>) &#123;</span></CodeLine>
<Link id="l00226" /><CodeLine lineNumber="226"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!Succ.<a href="/docs/api/classes/llvm/machinebasicblock/#a1100bfbadd996d464150c6a68fa8dc1d">isEHPad</a>() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Shouldn&#39;t get edges to EH pads!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00227" /><CodeLine lineNumber="227"></CodeLine>
<Link id="l00228" /><CodeLine lineNumber="228"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF = &#42;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.getParent();</span></CodeLine>
<Link id="l00229" /><CodeLine lineNumber="229"></CodeLine>
<Link id="l00230" /><CodeLine lineNumber="230"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;NewMBB = &#42;MF.<a href="/docs/api/classes/llvm/machinefunction/#adfc62ee16549afaac5bde30156ddc989">CreateMachineBasicBlock</a>();</span></CodeLine>
<Link id="l00231" /><CodeLine lineNumber="231"></CodeLine>
<Link id="l00232" /><CodeLine lineNumber="232"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We have to insert the new block immediately after the current one as we</span></CodeLine>
<Link id="l00233" /><CodeLine lineNumber="233"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// don&#39;t know what layout-successor relationships the successor has and we</span></CodeLine>
<Link id="l00234" /><CodeLine lineNumber="234"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// may not be able to (and generally don&#39;t want to) try to fix those up.</span></CodeLine>
<Link id="l00235" /><CodeLine lineNumber="235"><span class="doxyHighlight">  MF.<a href="/docs/api/classes/llvm/machinefunction/#af4c0db6d503e0ba3b8e44067023ffbba">insert</a>(std::next(<a href="/docs/api/classes/llvm/machinefunction/#aaba82c71ffdca966cad10eae0992fff9">MachineFunction::iterator</a>(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>)), &amp;NewMBB);</span></CodeLine>
<Link id="l00236" /><CodeLine lineNumber="236"></CodeLine>
<Link id="l00237" /><CodeLine lineNumber="237"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Update the branch instruction if necessary.</span></CodeLine>
<Link id="l00238" /><CodeLine lineNumber="238"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Br) &#123;</span></CodeLine>
<Link id="l00239" /><CodeLine lineNumber="239"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Br-&gt;<a href="/docs/api/classes/llvm/machineinstr/#ad67c9230577a0b640c52852c75c93939">getOperand</a>(0).<a href="/docs/api/classes/llvm/machineoperand/#a57e64b633278df75c699e6b98ce15031">getMBB</a>() == &amp;Succ &amp;&amp;</span></CodeLine>
<Link id="l00240" /><CodeLine lineNumber="240"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;Didn&#39;t start with the right target!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00241" /><CodeLine lineNumber="241"><span class="doxyHighlight">    Br-&gt;<a href="/docs/api/classes/llvm/machineinstr/#ad67c9230577a0b640c52852c75c93939">getOperand</a>(0).<a href="/docs/api/classes/llvm/machineoperand/#a98e9c9e8ef7cbb6c4aa89a38f21decfa">setMBB</a>(&amp;NewMBB);</span></CodeLine>
<Link id="l00242" /><CodeLine lineNumber="242"></CodeLine>
<Link id="l00243" /><CodeLine lineNumber="243"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If this successor was reached through a branch rather than fallthrough,</span></CodeLine>
<Link id="l00244" /><CodeLine lineNumber="244"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// we might have &#42;broken&#42; fallthrough and so need to inject a new</span></CodeLine>
<Link id="l00245" /><CodeLine lineNumber="245"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// unconditional branch.</span></CodeLine>
<Link id="l00246" /><CodeLine lineNumber="246"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!UncondBr) &#123;</span></CodeLine>
<Link id="l00247" /><CodeLine lineNumber="247"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;OldLayoutSucc =</span></CodeLine>
<Link id="l00248" /><CodeLine lineNumber="248"><span class="doxyHighlight">          &#42;std::next(<a href="/docs/api/classes/llvm/machinefunction/#aaba82c71ffdca966cad10eae0992fff9">MachineFunction::iterator</a>(&amp;NewMBB));</span></CodeLine>
<Link id="l00249" /><CodeLine lineNumber="249"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.isSuccessor(&amp;OldLayoutSucc) &amp;&amp;</span></CodeLine>
<Link id="l00250" /><CodeLine lineNumber="250"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;Without an unconditional branch, the old layout successor should &quot;</span></CodeLine>
<Link id="l00251" /><CodeLine lineNumber="251"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;be an actual successor!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00252" /><CodeLine lineNumber="252"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> BrBuilder =</span></CodeLine>
<Link id="l00253" /><CodeLine lineNumber="253"><span class="doxyHighlight">          <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a>(), <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>.get(X86::JMP&#95;1)).<a href="/docs/api/classes/llvm/machineinstrbuilder/#abf1febf2a98f588146548a3a485d3838">addMBB</a>(&amp;OldLayoutSucc);</span></CodeLine>
<Link id="l00254" /><CodeLine lineNumber="254"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Update the unconditional branch now that we&#39;ve added one.</span></CodeLine>
<Link id="l00255" /><CodeLine lineNumber="255"><span class="doxyHighlight">      UncondBr = &amp;&#42;BrBuilder;</span></CodeLine>
<Link id="l00256" /><CodeLine lineNumber="256"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00257" /><CodeLine lineNumber="257"></CodeLine>
<Link id="l00258" /><CodeLine lineNumber="258"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Insert unconditional &quot;jump Succ&quot; instruction in the new block if</span></CodeLine>
<Link id="l00259" /><CodeLine lineNumber="259"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// necessary.</span></CodeLine>
<Link id="l00260" /><CodeLine lineNumber="260"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!NewMBB.<a href="/docs/api/classes/llvm/machinebasicblock/#abd85c9d7c51eb515a550069e9ad9445e">isLayoutSuccessor</a>(&amp;Succ)) &#123;</span></CodeLine>
<Link id="l00261" /><CodeLine lineNumber="261"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineOperand, 4&gt;</a> <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>;</span></CodeLine>
<Link id="l00262" /><CodeLine lineNumber="262"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>.insertBranch(NewMBB, &amp;Succ, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, Br-&gt;<a href="/docs/api/classes/llvm/machineinstr/#abb10ef030fba4ea901518a0c8dbef3e2">getDebugLoc</a>());</span></CodeLine>
<Link id="l00263" /><CodeLine lineNumber="263"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00264" /><CodeLine lineNumber="264"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00265" /><CodeLine lineNumber="265"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!UncondBr &amp;&amp;</span></CodeLine>
<Link id="l00266" /><CodeLine lineNumber="266"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;Cannot have a branchless successor and an unconditional branch!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00267" /><CodeLine lineNumber="267"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(NewMBB.<a href="/docs/api/classes/llvm/machinebasicblock/#abd85c9d7c51eb515a550069e9ad9445e">isLayoutSuccessor</a>(&amp;Succ) &amp;&amp;</span></CodeLine>
<Link id="l00268" /><CodeLine lineNumber="268"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;A non-branch successor must have been a layout successor before &quot;</span></CodeLine>
<Link id="l00269" /><CodeLine lineNumber="269"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;and now is a layout successor of the new block.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00270" /><CodeLine lineNumber="270"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00271" /><CodeLine lineNumber="271"></CodeLine>
<Link id="l00272" /><CodeLine lineNumber="272"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If this is the only edge to the successor, we can just replace it in the</span></CodeLine>
<Link id="l00273" /><CodeLine lineNumber="273"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// CFG. Otherwise we need to add a new entry in the CFG for the new</span></CodeLine>
<Link id="l00274" /><CodeLine lineNumber="274"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// successor.</span></CodeLine>
<Link id="l00275" /><CodeLine lineNumber="275"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SuccCount == 1) &#123;</span></CodeLine>
<Link id="l00276" /><CodeLine lineNumber="276"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.replaceSuccessor(&amp;Succ, &amp;NewMBB);</span></CodeLine>
<Link id="l00277" /><CodeLine lineNumber="277"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00278" /><CodeLine lineNumber="278"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.splitSuccessor(&amp;Succ, &amp;NewMBB);</span></CodeLine>
<Link id="l00279" /><CodeLine lineNumber="279"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00280" /><CodeLine lineNumber="280"></CodeLine>
<Link id="l00281" /><CodeLine lineNumber="281"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Hook up the edge from the new basic block to the old successor in the CFG.</span></CodeLine>
<Link id="l00282" /><CodeLine lineNumber="282"><span class="doxyHighlight">  NewMBB.<a href="/docs/api/classes/llvm/machinebasicblock/#a935e2a8884592189d8f261634a0b24c5">addSuccessor</a>(&amp;Succ);</span></CodeLine>
<Link id="l00283" /><CodeLine lineNumber="283"></CodeLine>
<Link id="l00284" /><CodeLine lineNumber="284"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Fix PHI nodes in Succ so they refer to NewMBB instead of MBB.</span></CodeLine>
<Link id="l00285" /><CodeLine lineNumber="285"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> : Succ) &#123;</span></CodeLine>
<Link id="l00286" /><CodeLine lineNumber="286"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isPHI())</span></CodeLine>
<Link id="l00287" /><CodeLine lineNumber="287"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00288" /><CodeLine lineNumber="288"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> OpIdx = 1, <a href="/docs/api/files/include/include/llvm/include/llvm/demangle/itaniumdemangle-h/#a536e22898d28a9340a4204407a75ad5d">NumOps</a> = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getNumOperands(); OpIdx &lt; <a href="/docs/api/files/include/include/llvm/include/llvm/demangle/itaniumdemangle-h/#a536e22898d28a9340a4204407a75ad5d">NumOps</a>;</span></CodeLine>
<Link id="l00289" /><CodeLine lineNumber="289"><span class="doxyHighlight">         OpIdx += 2) &#123;</span></CodeLine>
<Link id="l00290" /><CodeLine lineNumber="290"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;OpV = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(OpIdx);</span></CodeLine>
<Link id="l00291" /><CodeLine lineNumber="291"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;OpMBB = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(OpIdx + 1);</span></CodeLine>
<Link id="l00292" /><CodeLine lineNumber="292"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(OpMBB.<a href="/docs/api/classes/llvm/machineoperand/#afe1784e242ce66da6029b3a681896bd2">isMBB</a>() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Block operand to a PHI is not a block!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00293" /><CodeLine lineNumber="293"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (OpMBB.<a href="/docs/api/classes/llvm/machineoperand/#a57e64b633278df75c699e6b98ce15031">getMBB</a>() != &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>)</span></CodeLine>
<Link id="l00294" /><CodeLine lineNumber="294"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00295" /><CodeLine lineNumber="295"></CodeLine>
<Link id="l00296" /><CodeLine lineNumber="296"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If this is the last edge to the succesor, just replace MBB in the PHI</span></CodeLine>
<Link id="l00297" /><CodeLine lineNumber="297"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SuccCount == 1) &#123;</span></CodeLine>
<Link id="l00298" /><CodeLine lineNumber="298"><span class="doxyHighlight">        OpMBB.<a href="/docs/api/classes/llvm/machineoperand/#a98e9c9e8ef7cbb6c4aa89a38f21decfa">setMBB</a>(&amp;NewMBB);</span></CodeLine>
<Link id="l00299" /><CodeLine lineNumber="299"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00300" /><CodeLine lineNumber="300"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00301" /><CodeLine lineNumber="301"></CodeLine>
<Link id="l00302" /><CodeLine lineNumber="302"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Otherwise, append a new pair of operands for the new incoming edge.</span></CodeLine>
<Link id="l00303" /><CodeLine lineNumber="303"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.addOperand(MF, OpV);</span></CodeLine>
<Link id="l00304" /><CodeLine lineNumber="304"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.addOperand(MF, <a href="/docs/api/classes/llvm/machineoperand/#af38d24646cd711efc334aee49919cdf5">MachineOperand::CreateMBB</a>(&amp;NewMBB));</span></CodeLine>
<Link id="l00305" /><CodeLine lineNumber="305"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00306" /><CodeLine lineNumber="306"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00307" /><CodeLine lineNumber="307"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00308" /><CodeLine lineNumber="308"></CodeLine>
<Link id="l00309" /><CodeLine lineNumber="309"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Inherit live-ins from the successor</span></CodeLine>
<Link id="l00310" /><CodeLine lineNumber="310"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;LI : Succ.<a href="/docs/api/classes/llvm/machinebasicblock/#a364ed6e68f92f797c0cd9e53ce5ea2a5">liveins</a>())</span></CodeLine>
<Link id="l00311" /><CodeLine lineNumber="311"><span class="doxyHighlight">    NewMBB.<a href="/docs/api/classes/llvm/machinebasicblock/#acce9c12cc977a88dc7bc51493ce7681c">addLiveIn</a>(LI);</span></CodeLine>
<Link id="l00312" /><CodeLine lineNumber="312"></CodeLine>
<Link id="l00313" /><CodeLine lineNumber="313"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Split edge from &#39;&quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.getName() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;&#39; to &#39;&quot;</span></CodeLine>
<Link id="l00314" /><CodeLine lineNumber="314"><span class="doxyHighlight">                    &lt;&lt; Succ.<a href="/docs/api/classes/llvm/machinebasicblock/#aedf6cb1135961f41f39dc58ca8576123">getName</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;&#39;.\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00315" /><CodeLine lineNumber="315"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> NewMBB;</span></CodeLine>
<Link id="l00316" /><CodeLine lineNumber="316"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00317" /><CodeLine lineNumber="317"></CodeLine>
<Link id="l00318" /><CodeLine lineNumber="318"><span class="doxyHighlightComment">/// Removing duplicate PHI operands to leave the PHI in a canonical and</span></CodeLine>
<Link id="l00319" /><CodeLine lineNumber="319"><span class="doxyHighlightComment">/// predictable form.</span></CodeLine>
<Link id="l00320" /><CodeLine lineNumber="320"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00321" /><CodeLine lineNumber="321"><span class="doxyHighlightComment">/// FIXME: It&#39;s really frustrating that we have to do this, but SSA-form in MIR</span></CodeLine>
<Link id="l00322" /><CodeLine lineNumber="322"><span class="doxyHighlightComment">/// isn&#39;t what you might expect. We may have multiple entries in PHI nodes for</span></CodeLine>
<Link id="l00323" /><CodeLine lineNumber="323"><span class="doxyHighlightComment">/// a single predecessor. This makes CFG-updating extremely complex, so here we</span></CodeLine>
<Link id="l00324" /><CodeLine lineNumber="324"><span class="doxyHighlightComment">/// simplify all PHI nodes to a model even simpler than the IR&#39;s model: exactly</span></CodeLine>
<Link id="l00325" /><CodeLine lineNumber="325"><span class="doxyHighlightComment">/// one entry per predecessor, regardless of how many edges there are.</span></CodeLine>
<Link id="l00326" /><CodeLine lineNumber="326" lineLink="#a22244f1af2bc880ef42bfd77068ce13a"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#a22244f1af2bc880ef42bfd77068ce13a">canonicalizePHIOperands</a>(<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF) &#123;</span></CodeLine>
<Link id="l00327" /><CodeLine lineNumber="327"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;MachineBasicBlock &#42;, 4&gt;</a> Preds;</span></CodeLine>
<Link id="l00328" /><CodeLine lineNumber="328"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;int, 4&gt;</a> DupIndices;</span></CodeLine>
<Link id="l00329" /><CodeLine lineNumber="329"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : MF)</span></CodeLine>
<Link id="l00330" /><CodeLine lineNumber="330"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> : <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>) &#123;</span></CodeLine>
<Link id="l00331" /><CodeLine lineNumber="331"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isPHI())</span></CodeLine>
<Link id="l00332" /><CodeLine lineNumber="332"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00333" /><CodeLine lineNumber="333"></CodeLine>
<Link id="l00334" /><CodeLine lineNumber="334"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// First we scan the operands of the PHI looking for duplicate entries</span></CodeLine>
<Link id="l00335" /><CodeLine lineNumber="335"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// a particular predecessor. We retain the operand index of each duplicate</span></CodeLine>
<Link id="l00336" /><CodeLine lineNumber="336"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// entry found.</span></CodeLine>
<Link id="l00337" /><CodeLine lineNumber="337"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> OpIdx = 1, <a href="/docs/api/files/include/include/llvm/include/llvm/demangle/itaniumdemangle-h/#a536e22898d28a9340a4204407a75ad5d">NumOps</a> = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getNumOperands(); OpIdx &lt; <a href="/docs/api/files/include/include/llvm/include/llvm/demangle/itaniumdemangle-h/#a536e22898d28a9340a4204407a75ad5d">NumOps</a>;</span></CodeLine>
<Link id="l00338" /><CodeLine lineNumber="338"><span class="doxyHighlight">           OpIdx += 2)</span></CodeLine>
<Link id="l00339" /><CodeLine lineNumber="339"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Preds.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(OpIdx + 1).getMBB()).second)</span></CodeLine>
<Link id="l00340" /><CodeLine lineNumber="340"><span class="doxyHighlight">          DupIndices.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(OpIdx);</span></CodeLine>
<Link id="l00341" /><CodeLine lineNumber="341"></CodeLine>
<Link id="l00342" /><CodeLine lineNumber="342"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Now walk the duplicate indices, removing both the block and value. Note</span></CodeLine>
<Link id="l00343" /><CodeLine lineNumber="343"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// that these are stored as a vector making this element-wise removal</span></CodeLine>
<Link id="l00344" /><CodeLine lineNumber="344"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// :w</span></CodeLine>
<Link id="l00345" /><CodeLine lineNumber="345"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// potentially quadratic.</span></CodeLine>
<Link id="l00346" /><CodeLine lineNumber="346"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00347" /><CodeLine lineNumber="347"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// FIXME: It is really frustrating that we have to use a quadratic</span></CodeLine>
<Link id="l00348" /><CodeLine lineNumber="348"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// removal algorithm here. There should be a better way, but the use-def</span></CodeLine>
<Link id="l00349" /><CodeLine lineNumber="349"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// updates required make that impossible using the public API.</span></CodeLine>
<Link id="l00350" /><CodeLine lineNumber="350"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00351" /><CodeLine lineNumber="351"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Note that we have to process these backwards so that we don&#39;t</span></CodeLine>
<Link id="l00352" /><CodeLine lineNumber="352"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// invalidate other indices with each removal.</span></CodeLine>
<Link id="l00353" /><CodeLine lineNumber="353"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">while</span><span class="doxyHighlight"> (!DupIndices.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>()) &#123;</span></CodeLine>
<Link id="l00354" /><CodeLine lineNumber="354"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> OpIdx = DupIndices.<a href="/docs/api/classes/llvm/smallvectorimpl/#a0c8ffe664a36e30d49c84d0aded2fe08">pop&#95;back&#95;val</a>();</span></CodeLine>
<Link id="l00355" /><CodeLine lineNumber="355"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Remove both the block and value operand, again in reverse order to</span></CodeLine>
<Link id="l00356" /><CodeLine lineNumber="356"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// preserve indices.</span></CodeLine>
<Link id="l00357" /><CodeLine lineNumber="357"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.removeOperand(OpIdx + 1);</span></CodeLine>
<Link id="l00358" /><CodeLine lineNumber="358"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.removeOperand(OpIdx);</span></CodeLine>
<Link id="l00359" /><CodeLine lineNumber="359"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00360" /><CodeLine lineNumber="360"></CodeLine>
<Link id="l00361" /><CodeLine lineNumber="361"><span class="doxyHighlight">      Preds.<a href="/docs/api/classes/llvm/smallptrsetimplbase/#a16413f1a88d8baca228d0a1b4cc0bfc6">clear</a>();</span></CodeLine>
<Link id="l00362" /><CodeLine lineNumber="362"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00363" /><CodeLine lineNumber="363"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00364" /><CodeLine lineNumber="364"></CodeLine>
<Link id="l00365" /><CodeLine lineNumber="365"><span class="doxyHighlightComment">/// Helper to scan a function for loads vulnerable to misspeculation that we</span></CodeLine>
<Link id="l00366" /><CodeLine lineNumber="366"><span class="doxyHighlightComment">/// want to harden.</span></CodeLine>
<Link id="l00367" /><CodeLine lineNumber="367"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00368" /><CodeLine lineNumber="368"><span class="doxyHighlightComment">/// We use this to avoid making changes to functions where there is nothing we</span></CodeLine>
<Link id="l00369" /><CodeLine lineNumber="369"><span class="doxyHighlightComment">/// need to do to harden against misspeculation.</span></CodeLine>
<Link id="l00370" /><CodeLine lineNumber="370" lineLink="#abe47da1ba1b5239bb67b26d5ebbca491"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#abe47da1ba1b5239bb67b26d5ebbca491">hasVulnerableLoad</a>(<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF) &#123;</span></CodeLine>
<Link id="l00371" /><CodeLine lineNumber="371"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : MF) &#123;</span></CodeLine>
<Link id="l00372" /><CodeLine lineNumber="372"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> : <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>) &#123;</span></CodeLine>
<Link id="l00373" /><CodeLine lineNumber="373"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Loads within this basic block after an LFENCE are not at risk of</span></CodeLine>
<Link id="l00374" /><CodeLine lineNumber="374"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// speculatively executing with invalid predicates from prior control</span></CodeLine>
<Link id="l00375" /><CodeLine lineNumber="375"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// flow. So break out of this block but continue scanning the function.</span></CodeLine>
<Link id="l00376" /><CodeLine lineNumber="376"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOpcode() == X86::LFENCE)</span></CodeLine>
<Link id="l00377" /><CodeLine lineNumber="377"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00378" /><CodeLine lineNumber="378"></CodeLine>
<Link id="l00379" /><CodeLine lineNumber="379"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Looking for loads only.</span></CodeLine>
<Link id="l00380" /><CodeLine lineNumber="380"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.mayLoad())</span></CodeLine>
<Link id="l00381" /><CodeLine lineNumber="381"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00382" /><CodeLine lineNumber="382"></CodeLine>
<Link id="l00383" /><CodeLine lineNumber="383"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// An MFENCE is modeled as a load but isn&#39;t vulnerable to misspeculation.</span></CodeLine>
<Link id="l00384" /><CodeLine lineNumber="384"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOpcode() == X86::MFENCE)</span></CodeLine>
<Link id="l00385" /><CodeLine lineNumber="385"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00386" /><CodeLine lineNumber="386"></CodeLine>
<Link id="l00387" /><CodeLine lineNumber="387"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// We found a load.</span></CodeLine>
<Link id="l00388" /><CodeLine lineNumber="388"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00389" /><CodeLine lineNumber="389"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00390" /><CodeLine lineNumber="390"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00391" /><CodeLine lineNumber="391"></CodeLine>
<Link id="l00392" /><CodeLine lineNumber="392"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// No loads found.</span></CodeLine>
<Link id="l00393" /><CodeLine lineNumber="393"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00394" /><CodeLine lineNumber="394"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00395" /><CodeLine lineNumber="395"></CodeLine>
<Link id="l00396" /><CodeLine lineNumber="396" lineLink="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a862b3b4b5ed250fcfb2d6f9a130f4a0c"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a862b3b4b5ed250fcfb2d6f9a130f4a0c">X86SpeculativeLoadHardeningPass::runOnMachineFunction</a>(</span></CodeLine>
<Link id="l00397" /><CodeLine lineNumber="397"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF) &#123;</span></CodeLine>
<Link id="l00398" /><CodeLine lineNumber="398"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42; &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#afc095bc1100ba5f1e44a49e741303f28">getPassName</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; : &quot;</span><span class="doxyHighlight"> &lt;&lt; MF.<a href="/docs/api/classes/llvm/machinefunction/#a3d142c9e7c066059e15232c56dec9e2e">getName</a>()</span></CodeLine>
<Link id="l00399" /><CodeLine lineNumber="399"><span class="doxyHighlight">                    &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; &#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00400" /><CodeLine lineNumber="400"></CodeLine>
<Link id="l00401" /><CodeLine lineNumber="401"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Only run if this pass is forced enabled or we detect the relevant function</span></CodeLine>
<Link id="l00402" /><CodeLine lineNumber="402"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// attribute requesting SLH.</span></CodeLine>
<Link id="l00403" /><CodeLine lineNumber="403"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="#a964a795e07ed117f8049f44b16739763">EnableSpeculativeLoadHardening</a> &amp;&amp;</span></CodeLine>
<Link id="l00404" /><CodeLine lineNumber="404"><span class="doxyHighlight">      !MF.<a href="/docs/api/classes/llvm/machinefunction/#a977ddce262de45c645be23d951066351">getFunction</a>().<a href="/docs/api/classes/llvm/function/#afb28a4deafe2954b0534cc6399ce518b">hasFnAttribute</a>(Attribute::SpeculativeLoadHardening))</span></CodeLine>
<Link id="l00405" /><CodeLine lineNumber="405"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00406" /><CodeLine lineNumber="406"></CodeLine>
<Link id="l00407" /><CodeLine lineNumber="407"><span class="doxyHighlight">  Subtarget = &amp;MF.<a href="/docs/api/classes/llvm/machinefunction/#a3825368aca2bc1550d173660df4da6a6">getSubtarget</a>&lt;<a href="/docs/api/classes/llvm/x86subtarget">X86Subtarget</a>&gt;();</span></CodeLine>
<Link id="l00408" /><CodeLine lineNumber="408"><span class="doxyHighlight">  MRI = &amp;MF.<a href="/docs/api/classes/llvm/machinefunction/#a810234b6b3d223b7c74a4253fcc5ea5e">getRegInfo</a>();</span></CodeLine>
<Link id="l00409" /><CodeLine lineNumber="409"><span class="doxyHighlight">  TII = Subtarget-&gt;getInstrInfo();</span></CodeLine>
<Link id="l00410" /><CodeLine lineNumber="410"><span class="doxyHighlight">  TRI = Subtarget-&gt;getRegisterInfo();</span></CodeLine>
<Link id="l00411" /><CodeLine lineNumber="411"></CodeLine>
<Link id="l00412" /><CodeLine lineNumber="412"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// FIXME: Support for 32-bit.</span></CodeLine>
<Link id="l00413" /><CodeLine lineNumber="413"><span class="doxyHighlight">  PS.emplace(MF, &amp;X86::GR64&#95;NOSPRegClass);</span></CodeLine>
<Link id="l00414" /><CodeLine lineNumber="414"></CodeLine>
<Link id="l00415" /><CodeLine lineNumber="415"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (MF.<a href="/docs/api/classes/llvm/machinefunction/#ab0789854909cf47f640a85fa2bac29c7">begin</a>() == MF.<a href="/docs/api/classes/llvm/machinefunction/#a9d017af749f76484cb9aec9ff6e4330c">end</a>())</span></CodeLine>
<Link id="l00416" /><CodeLine lineNumber="416"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Nothing to do for a degenerate empty function...</span></CodeLine>
<Link id="l00417" /><CodeLine lineNumber="417"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00418" /><CodeLine lineNumber="418"></CodeLine>
<Link id="l00419" /><CodeLine lineNumber="419"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We support an alternative hardening technique based on a debug flag.</span></CodeLine>
<Link id="l00420" /><CodeLine lineNumber="420"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a921b17e18b1d37ab8ca2b7375df1addf">HardenEdgesWithLFENCE</a>) &#123;</span></CodeLine>
<Link id="l00421" /><CodeLine lineNumber="421"><span class="doxyHighlight">    hardenEdgesWithLFENCE(MF);</span></CodeLine>
<Link id="l00422" /><CodeLine lineNumber="422"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00423" /><CodeLine lineNumber="423"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00424" /><CodeLine lineNumber="424"></CodeLine>
<Link id="l00425" /><CodeLine lineNumber="425"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create a dummy debug loc to use for all the generated code here.</span></CodeLine>
<Link id="l00426" /><CodeLine lineNumber="426"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> <a href="/docs/api/namespaces/llvm/loc">Loc</a>;</span></CodeLine>
<Link id="l00427" /><CodeLine lineNumber="427"></CodeLine>
<Link id="l00428" /><CodeLine lineNumber="428"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;Entry = &#42;MF.<a href="/docs/api/classes/llvm/machinefunction/#ab0789854909cf47f640a85fa2bac29c7">begin</a>();</span></CodeLine>
<Link id="l00429" /><CodeLine lineNumber="429"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> EntryInsertPt = Entry.SkipPHIsLabelsAndDebug(Entry.begin());</span></CodeLine>
<Link id="l00430" /><CodeLine lineNumber="430"></CodeLine>
<Link id="l00431" /><CodeLine lineNumber="431"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Do a quick scan to see if we have any checkable loads.</span></CodeLine>
<Link id="l00432" /><CodeLine lineNumber="432"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> HasVulnerableLoad = <a href="#abe47da1ba1b5239bb67b26d5ebbca491">hasVulnerableLoad</a>(MF);</span></CodeLine>
<Link id="l00433" /><CodeLine lineNumber="433"></CodeLine>
<Link id="l00434" /><CodeLine lineNumber="434"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// See if we have any conditional branching blocks that we will need to trace</span></CodeLine>
<Link id="l00435" /><CodeLine lineNumber="435"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// predicate state through.</span></CodeLine>
<Link id="l00436" /><CodeLine lineNumber="436"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BlockCondInfo, 16&gt;</a> Infos = collectBlockCondInfo(MF);</span></CodeLine>
<Link id="l00437" /><CodeLine lineNumber="437"></CodeLine>
<Link id="l00438" /><CodeLine lineNumber="438"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we have no interesting conditions or loads, nothing to do here.</span></CodeLine>
<Link id="l00439" /><CodeLine lineNumber="439"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!HasVulnerableLoad &amp;&amp; Infos.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>())</span></CodeLine>
<Link id="l00440" /><CodeLine lineNumber="440"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00441" /><CodeLine lineNumber="441"></CodeLine>
<Link id="l00442" /><CodeLine lineNumber="442"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The poison value is required to be an all-ones value for many aspects of</span></CodeLine>
<Link id="l00443" /><CodeLine lineNumber="443"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// this mitigation.</span></CodeLine>
<Link id="l00444" /><CodeLine lineNumber="444"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> PoisonVal = -1;</span></CodeLine>
<Link id="l00445" /><CodeLine lineNumber="445"><span class="doxyHighlight">  PS-&gt;PoisonReg = MRI-&gt;createVirtualRegister(PS-&gt;RC);</span></CodeLine>
<Link id="l00446" /><CodeLine lineNumber="446"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(Entry, EntryInsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, TII-&gt;get(X86::MOV64ri32), PS-&gt;PoisonReg)</span></CodeLine>
<Link id="l00447" /><CodeLine lineNumber="447"><span class="doxyHighlight">      .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(PoisonVal);</span></CodeLine>
<Link id="l00448" /><CodeLine lineNumber="448"><span class="doxyHighlight">  ++NumInstsInserted;</span></CodeLine>
<Link id="l00449" /><CodeLine lineNumber="449"></CodeLine>
<Link id="l00450" /><CodeLine lineNumber="450"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we have loads being hardened and we&#39;ve asked for call and ret edges to</span></CodeLine>
<Link id="l00451" /><CodeLine lineNumber="451"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// get a full fence-based mitigation, inject that fence.</span></CodeLine>
<Link id="l00452" /><CodeLine lineNumber="452"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (HasVulnerableLoad &amp;&amp; <a href="#a5ee11464d0d2e030d95afb0db83b801d">FenceCallAndRet</a>) &#123;</span></CodeLine>
<Link id="l00453" /><CodeLine lineNumber="453"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We need to insert an LFENCE at the start of the function to suspend any</span></CodeLine>
<Link id="l00454" /><CodeLine lineNumber="454"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// incoming misspeculation from the caller. This helps two-fold: the caller</span></CodeLine>
<Link id="l00455" /><CodeLine lineNumber="455"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// may not have been protected as this code has been, and this code gets to</span></CodeLine>
<Link id="l00456" /><CodeLine lineNumber="456"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// not take any specific action to protect across calls.</span></CodeLine>
<Link id="l00457" /><CodeLine lineNumber="457"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// FIXME: We could skip this for functions which unconditionally return</span></CodeLine>
<Link id="l00458" /><CodeLine lineNumber="458"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// a constant.</span></CodeLine>
<Link id="l00459" /><CodeLine lineNumber="459"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(Entry, EntryInsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, TII-&gt;get(X86::LFENCE));</span></CodeLine>
<Link id="l00460" /><CodeLine lineNumber="460"><span class="doxyHighlight">    ++NumInstsInserted;</span></CodeLine>
<Link id="l00461" /><CodeLine lineNumber="461"><span class="doxyHighlight">    ++NumLFENCEsInserted;</span></CodeLine>
<Link id="l00462" /><CodeLine lineNumber="462"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00463" /><CodeLine lineNumber="463"></CodeLine>
<Link id="l00464" /><CodeLine lineNumber="464"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we guarded the entry with an LFENCE and have no conditionals to protect</span></CodeLine>
<Link id="l00465" /><CodeLine lineNumber="465"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// in blocks, then we&#39;re done.</span></CodeLine>
<Link id="l00466" /><CodeLine lineNumber="466"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a5ee11464d0d2e030d95afb0db83b801d">FenceCallAndRet</a> &amp;&amp; Infos.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>())</span></CodeLine>
<Link id="l00467" /><CodeLine lineNumber="467"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We may have changed the function&#39;s code at this point to insert fences.</span></CodeLine>
<Link id="l00468" /><CodeLine lineNumber="468"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00469" /><CodeLine lineNumber="469"></CodeLine>
<Link id="l00470" /><CodeLine lineNumber="470"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For every basic block in the function which can b</span></CodeLine>
<Link id="l00471" /><CodeLine lineNumber="471"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a3e42304d79c25684c4d464fd35fb868f">HardenInterprocedurally</a> &amp;&amp; !<a href="#a5ee11464d0d2e030d95afb0db83b801d">FenceCallAndRet</a>) &#123;</span></CodeLine>
<Link id="l00472" /><CodeLine lineNumber="472"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Set up the predicate state by extracting it from the incoming stack</span></CodeLine>
<Link id="l00473" /><CodeLine lineNumber="473"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// pointer so we pick up any misspeculation in our caller.</span></CodeLine>
<Link id="l00474" /><CodeLine lineNumber="474"><span class="doxyHighlight">    PS-&gt;InitialReg = extractPredStateFromSP(Entry, EntryInsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>);</span></CodeLine>
<Link id="l00475" /><CodeLine lineNumber="475"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00476" /><CodeLine lineNumber="476"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Otherwise, just build the predicate state itself by zeroing a register</span></CodeLine>
<Link id="l00477" /><CodeLine lineNumber="477"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// as we don&#39;t need any initial state.</span></CodeLine>
<Link id="l00478" /><CodeLine lineNumber="478"><span class="doxyHighlight">    PS-&gt;InitialReg = MRI-&gt;createVirtualRegister(PS-&gt;RC);</span></CodeLine>
<Link id="l00479" /><CodeLine lineNumber="479"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/register">Register</a> PredStateSubReg = MRI-&gt;createVirtualRegister(&amp;X86::GR32RegClass);</span></CodeLine>
<Link id="l00480" /><CodeLine lineNumber="480"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> ZeroI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(Entry, EntryInsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, TII-&gt;get(X86::MOV32r0),</span></CodeLine>
<Link id="l00481" /><CodeLine lineNumber="481"><span class="doxyHighlight">                         PredStateSubReg);</span></CodeLine>
<Link id="l00482" /><CodeLine lineNumber="482"><span class="doxyHighlight">    ++NumInstsInserted;</span></CodeLine>
<Link id="l00483" /><CodeLine lineNumber="483"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &#42;ZeroEFLAGSDefOp =</span></CodeLine>
<Link id="l00484" /><CodeLine lineNumber="484"><span class="doxyHighlight">        ZeroI-&gt;findRegisterDefOperand(X86::EFLAGS, </span><span class="doxyHighlightComment">/&#42;TRI=&#42;/</span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00485" /><CodeLine lineNumber="485"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(ZeroEFLAGSDefOp &amp;&amp; ZeroEFLAGSDefOp-&gt;<a href="/docs/api/classes/llvm/machineoperand/#a3bf161859e1ad7fd3da485d3cb688d34">isImplicit</a>() &amp;&amp;</span></CodeLine>
<Link id="l00486" /><CodeLine lineNumber="486"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;Must have an implicit def of EFLAGS!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00487" /><CodeLine lineNumber="487"><span class="doxyHighlight">    ZeroEFLAGSDefOp-&gt;<a href="/docs/api/classes/llvm/machineoperand/#a61a42c85bd86c6ca4554e27d33c3f798">setIsDead</a>(</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00488" /><CodeLine lineNumber="488"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(Entry, EntryInsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, TII-&gt;get(X86::SUBREG&#95;TO&#95;REG),</span></CodeLine>
<Link id="l00489" /><CodeLine lineNumber="489"><span class="doxyHighlight">            PS-&gt;InitialReg)</span></CodeLine>
<Link id="l00490" /><CodeLine lineNumber="490"><span class="doxyHighlight">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(0)</span></CodeLine>
<Link id="l00491" /><CodeLine lineNumber="491"><span class="doxyHighlight">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(PredStateSubReg)</span></CodeLine>
<Link id="l00492" /><CodeLine lineNumber="492"><span class="doxyHighlight">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(X86::sub&#95;32bit);</span></CodeLine>
<Link id="l00493" /><CodeLine lineNumber="493"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00494" /><CodeLine lineNumber="494"></CodeLine>
<Link id="l00495" /><CodeLine lineNumber="495"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We&#39;re going to need to trace predicate state throughout the function&#39;s</span></CodeLine>
<Link id="l00496" /><CodeLine lineNumber="496"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// CFG. Prepare for this by setting up our initial state of PHIs with unique</span></CodeLine>
<Link id="l00497" /><CodeLine lineNumber="497"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// predecessor entries and all the initial predicate state.</span></CodeLine>
<Link id="l00498" /><CodeLine lineNumber="498"><span class="doxyHighlight">  <a href="#a22244f1af2bc880ef42bfd77068ce13a">canonicalizePHIOperands</a>(MF);</span></CodeLine>
<Link id="l00499" /><CodeLine lineNumber="499"></CodeLine>
<Link id="l00500" /><CodeLine lineNumber="500"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Track the updated values in an SSA updater to rewrite into SSA form at the</span></CodeLine>
<Link id="l00501" /><CodeLine lineNumber="501"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// end.</span></CodeLine>
<Link id="l00502" /><CodeLine lineNumber="502"><span class="doxyHighlight">  PS-&gt;SSA.Initialize(PS-&gt;InitialReg);</span></CodeLine>
<Link id="l00503" /><CodeLine lineNumber="503"><span class="doxyHighlight">  PS-&gt;SSA.AddAvailableValue(&amp;Entry, PS-&gt;InitialReg);</span></CodeLine>
<Link id="l00504" /><CodeLine lineNumber="504"></CodeLine>
<Link id="l00505" /><CodeLine lineNumber="505"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Trace through the CFG.</span></CodeLine>
<Link id="l00506" /><CodeLine lineNumber="506"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> CMovs = tracePredStateThroughCFG(MF, Infos);</span></CodeLine>
<Link id="l00507" /><CodeLine lineNumber="507"></CodeLine>
<Link id="l00508" /><CodeLine lineNumber="508"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We may also enter basic blocks in this function via exception handling</span></CodeLine>
<Link id="l00509" /><CodeLine lineNumber="509"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// control flow. Here, if we are hardening interprocedurally, we need to</span></CodeLine>
<Link id="l00510" /><CodeLine lineNumber="510"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// re-capture the predicate state from the throwing code. In the Itanium ABI,</span></CodeLine>
<Link id="l00511" /><CodeLine lineNumber="511"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the throw will always look like a call to &#95;&#95;cxa&#95;throw and will have the</span></CodeLine>
<Link id="l00512" /><CodeLine lineNumber="512"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// predicate state in the stack pointer, so extract fresh predicate state from</span></CodeLine>
<Link id="l00513" /><CodeLine lineNumber="513"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the stack pointer and make it available in SSA.</span></CodeLine>
<Link id="l00514" /><CodeLine lineNumber="514"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// FIXME: Handle non-itanium ABI EH models.</span></CodeLine>
<Link id="l00515" /><CodeLine lineNumber="515"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a3e42304d79c25684c4d464fd35fb868f">HardenInterprocedurally</a>) &#123;</span></CodeLine>
<Link id="l00516" /><CodeLine lineNumber="516"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : MF) &#123;</span></CodeLine>
<Link id="l00517" /><CodeLine lineNumber="517"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.isEHScopeEntry() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Only Itanium ABI EH supported!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00518" /><CodeLine lineNumber="518"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.isEHFuncletEntry() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Only Itanium ABI EH supported!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00519" /><CodeLine lineNumber="519"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.isCleanupFuncletEntry() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Only Itanium ABI EH supported!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00520" /><CodeLine lineNumber="520"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.isEHPad())</span></CodeLine>
<Link id="l00521" /><CodeLine lineNumber="521"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00522" /><CodeLine lineNumber="522"><span class="doxyHighlight">      PS-&gt;SSA.AddAvailableValue(</span></CodeLine>
<Link id="l00523" /><CodeLine lineNumber="523"><span class="doxyHighlight">          &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>,</span></CodeLine>
<Link id="l00524" /><CodeLine lineNumber="524"><span class="doxyHighlight">          extractPredStateFromSP(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.SkipPHIsAndLabels(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.begin()), <a href="/docs/api/namespaces/llvm/loc">Loc</a>));</span></CodeLine>
<Link id="l00525" /><CodeLine lineNumber="525"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00526" /><CodeLine lineNumber="526"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00527" /><CodeLine lineNumber="527"></CodeLine>
<Link id="l00528" /><CodeLine lineNumber="528"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#ade91f65a65e423e2002fb9b25b7b2a5c">HardenIndirectCallsAndJumps</a>) &#123;</span></CodeLine>
<Link id="l00529" /><CodeLine lineNumber="529"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If we are going to harden calls and jumps we need to unfold their memory</span></CodeLine>
<Link id="l00530" /><CodeLine lineNumber="530"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// operands.</span></CodeLine>
<Link id="l00531" /><CodeLine lineNumber="531"><span class="doxyHighlight">    unfoldCallAndJumpLoads(MF);</span></CodeLine>
<Link id="l00532" /><CodeLine lineNumber="532"></CodeLine>
<Link id="l00533" /><CodeLine lineNumber="533"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Then we trace predicate state through the indirect branches.</span></CodeLine>
<Link id="l00534" /><CodeLine lineNumber="534"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> IndirectBrCMovs = tracePredStateThroughIndirectBranches(MF);</span></CodeLine>
<Link id="l00535" /><CodeLine lineNumber="535"><span class="doxyHighlight">    CMovs.append(IndirectBrCMovs.begin(), IndirectBrCMovs.end());</span></CodeLine>
<Link id="l00536" /><CodeLine lineNumber="536"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00537" /><CodeLine lineNumber="537"></CodeLine>
<Link id="l00538" /><CodeLine lineNumber="538"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Now that we have the predicate state available at the start of each block</span></CodeLine>
<Link id="l00539" /><CodeLine lineNumber="539"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// in the CFG, trace it through each block, hardening vulnerable instructions</span></CodeLine>
<Link id="l00540" /><CodeLine lineNumber="540"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// as we go.</span></CodeLine>
<Link id="l00541" /><CodeLine lineNumber="541"><span class="doxyHighlight">  tracePredStateThroughBlocksAndHarden(MF);</span></CodeLine>
<Link id="l00542" /><CodeLine lineNumber="542"></CodeLine>
<Link id="l00543" /><CodeLine lineNumber="543"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Now rewrite all the uses of the pred state using the SSA updater to insert</span></CodeLine>
<Link id="l00544" /><CodeLine lineNumber="544"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// PHIs connecting the state between blocks along the CFG edges.</span></CodeLine>
<Link id="l00545" /><CodeLine lineNumber="545"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;CMovI : CMovs)</span></CodeLine>
<Link id="l00546" /><CodeLine lineNumber="546"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a> : CMovI-&gt;operands()) &#123;</span></CodeLine>
<Link id="l00547" /><CodeLine lineNumber="547"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>.isReg() || <a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>.getReg() != PS-&gt;InitialReg)</span></CodeLine>
<Link id="l00548" /><CodeLine lineNumber="548"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00549" /><CodeLine lineNumber="549"></CodeLine>
<Link id="l00550" /><CodeLine lineNumber="550"><span class="doxyHighlight">      PS-&gt;SSA.RewriteUse(<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>);</span></CodeLine>
<Link id="l00551" /><CodeLine lineNumber="551"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00552" /><CodeLine lineNumber="552"></CodeLine>
<Link id="l00553" /><CodeLine lineNumber="553"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Final speculative load hardened function:\\n&quot;</span><span class="doxyHighlight">; MF.<a href="/docs/api/classes/llvm/machinefunction/#a3d931af4280c80a837ee409eb85104f7">dump</a>();</span></CodeLine>
<Link id="l00554" /><CodeLine lineNumber="554"><span class="doxyHighlight">             <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">; MF.<a href="/docs/api/classes/llvm/machinefunction/#a8efc9cbc802adc2bb2673b4ba6308869">verify</a>(</span><span class="doxyHighlightKeyword">this</span><span class="doxyHighlight">));</span></CodeLine>
<Link id="l00555" /><CodeLine lineNumber="555"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00556" /><CodeLine lineNumber="556"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00557" /><CodeLine lineNumber="557"></CodeLine>
<Link id="l00558" /><CodeLine lineNumber="558"><span class="doxyHighlightComment">/// Implements the naive hardening approach of putting an LFENCE after every</span></CodeLine>
<Link id="l00559" /><CodeLine lineNumber="559"><span class="doxyHighlightComment">/// potentially mis-predicted control flow construct.</span></CodeLine>
<Link id="l00560" /><CodeLine lineNumber="560"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00561" /><CodeLine lineNumber="561"><span class="doxyHighlightComment">/// We include this as an alternative mostly for the purpose of comparison. The</span></CodeLine>
<Link id="l00562" /><CodeLine lineNumber="562"><span class="doxyHighlightComment">/// performance impact of this is expected to be extremely severe and not</span></CodeLine>
<Link id="l00563" /><CodeLine lineNumber="563"><span class="doxyHighlightComment">/// practical for any real-world users.</span></CodeLine>
<Link id="l00564" /><CodeLine lineNumber="564"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> X86SpeculativeLoadHardeningPass::hardenEdgesWithLFENCE(</span></CodeLine>
<Link id="l00565" /><CodeLine lineNumber="565"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF) &#123;</span></CodeLine>
<Link id="l00566" /><CodeLine lineNumber="566"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// First, we scan the function looking for blocks that are reached along edges</span></CodeLine>
<Link id="l00567" /><CodeLine lineNumber="567"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// that we might want to harden.</span></CodeLine>
<Link id="l00568" /><CodeLine lineNumber="568"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallsetvector">SmallSetVector&lt;MachineBasicBlock &#42;, 8&gt;</a> Blocks;</span></CodeLine>
<Link id="l00569" /><CodeLine lineNumber="569"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : MF) &#123;</span></CodeLine>
<Link id="l00570" /><CodeLine lineNumber="570"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If there are no or only one successor, nothing to do here.</span></CodeLine>
<Link id="l00571" /><CodeLine lineNumber="571"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.succ&#95;size() &lt;= 1)</span></CodeLine>
<Link id="l00572" /><CodeLine lineNumber="572"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00573" /><CodeLine lineNumber="573"></CodeLine>
<Link id="l00574" /><CodeLine lineNumber="574"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Skip blocks unless their terminators start with a branch. Other</span></CodeLine>
<Link id="l00575" /><CodeLine lineNumber="575"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// terminators don&#39;t seem interesting for guarding against misspeculation.</span></CodeLine>
<Link id="l00576" /><CodeLine lineNumber="576"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> TermIt = <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.getFirstTerminator();</span></CodeLine>
<Link id="l00577" /><CodeLine lineNumber="577"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (TermIt == <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.end() || !TermIt-&gt;isBranch())</span></CodeLine>
<Link id="l00578" /><CodeLine lineNumber="578"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00579" /><CodeLine lineNumber="579"></CodeLine>
<Link id="l00580" /><CodeLine lineNumber="580"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Add all the non-EH-pad succossors to the blocks we want to harden. We</span></CodeLine>
<Link id="l00581" /><CodeLine lineNumber="581"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// skip EH pads because there isn&#39;t really a condition of interest on</span></CodeLine>
<Link id="l00582" /><CodeLine lineNumber="582"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// entering.</span></CodeLine>
<Link id="l00583" /><CodeLine lineNumber="583"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;SuccMBB : <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.successors())</span></CodeLine>
<Link id="l00584" /><CodeLine lineNumber="584"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!SuccMBB-&gt;isEHPad())</span></CodeLine>
<Link id="l00585" /><CodeLine lineNumber="585"><span class="doxyHighlight">        Blocks.<a href="/docs/api/classes/llvm/setvector/#af34eb71cc483e84d2eca80575cb9ccde">insert</a>(SuccMBB);</span></CodeLine>
<Link id="l00586" /><CodeLine lineNumber="586"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00587" /><CodeLine lineNumber="587"></CodeLine>
<Link id="l00588" /><CodeLine lineNumber="588"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : Blocks) &#123;</span></CodeLine>
<Link id="l00589" /><CodeLine lineNumber="589"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> InsertPt = <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>-&gt;SkipPHIsAndLabels(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>-&gt;begin());</span></CodeLine>
<Link id="l00590" /><CodeLine lineNumber="590"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(&#42;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a>(), <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::LFENCE));</span></CodeLine>
<Link id="l00591" /><CodeLine lineNumber="591"><span class="doxyHighlight">    ++NumInstsInserted;</span></CodeLine>
<Link id="l00592" /><CodeLine lineNumber="592"><span class="doxyHighlight">    ++NumLFENCEsInserted;</span></CodeLine>
<Link id="l00593" /><CodeLine lineNumber="593"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00594" /><CodeLine lineNumber="594"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00595" /><CodeLine lineNumber="595"></CodeLine>
<Link id="l00596" /><CodeLine lineNumber="596"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;X86SpeculativeLoadHardeningPass::BlockCondInfo, 16&gt;</a></span></CodeLine>
<Link id="l00597" /><CodeLine lineNumber="597"><span class="doxyHighlight">X86SpeculativeLoadHardeningPass::collectBlockCondInfo(<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF) &#123;</span></CodeLine>
<Link id="l00598" /><CodeLine lineNumber="598"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BlockCondInfo, 16&gt;</a> Infos;</span></CodeLine>
<Link id="l00599" /><CodeLine lineNumber="599"></CodeLine>
<Link id="l00600" /><CodeLine lineNumber="600"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Walk the function and build up a summary for each block&#39;s conditions that</span></CodeLine>
<Link id="l00601" /><CodeLine lineNumber="601"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// we need to trace through.</span></CodeLine>
<Link id="l00602" /><CodeLine lineNumber="602"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : MF) &#123;</span></CodeLine>
<Link id="l00603" /><CodeLine lineNumber="603"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If there are no or only one successor, nothing to do here.</span></CodeLine>
<Link id="l00604" /><CodeLine lineNumber="604"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.succ&#95;size() &lt;= 1)</span></CodeLine>
<Link id="l00605" /><CodeLine lineNumber="605"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00606" /><CodeLine lineNumber="606"></CodeLine>
<Link id="l00607" /><CodeLine lineNumber="607"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We want to reliably handle any conditional branch terminators in the</span></CodeLine>
<Link id="l00608" /><CodeLine lineNumber="608"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// MBB, so we manually analyze the branch. We can handle all of the</span></CodeLine>
<Link id="l00609" /><CodeLine lineNumber="609"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// permutations here, including ones that analyze branch cannot.</span></CodeLine>
<Link id="l00610" /><CodeLine lineNumber="610"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00611" /><CodeLine lineNumber="611"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// The approach is to walk backwards across the terminators, resetting at</span></CodeLine>
<Link id="l00612" /><CodeLine lineNumber="612"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// any unconditional non-indirect branch, and track all conditional edges</span></CodeLine>
<Link id="l00613" /><CodeLine lineNumber="613"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// to basic blocks as well as the fallthrough or unconditional successor</span></CodeLine>
<Link id="l00614" /><CodeLine lineNumber="614"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// edge. For each conditional edge, we track the target and the opposite</span></CodeLine>
<Link id="l00615" /><CodeLine lineNumber="615"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// condition code in order to inject a &quot;no-op&quot; cmov into that successor</span></CodeLine>
<Link id="l00616" /><CodeLine lineNumber="616"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// that will harden the predicate. For the fallthrough/unconditional</span></CodeLine>
<Link id="l00617" /><CodeLine lineNumber="617"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// edge, we inject a separate cmov for each conditional branch with</span></CodeLine>
<Link id="l00618" /><CodeLine lineNumber="618"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// matching condition codes. This effectively implements an &quot;and&quot; of the</span></CodeLine>
<Link id="l00619" /><CodeLine lineNumber="619"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// condition flags, even if there isn&#39;t a single condition flag that would</span></CodeLine>
<Link id="l00620" /><CodeLine lineNumber="620"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// directly implement that. We don&#39;t bother trying to optimize either of</span></CodeLine>
<Link id="l00621" /><CodeLine lineNumber="621"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// these cases because if such an optimization is possible, LLVM should</span></CodeLine>
<Link id="l00622" /><CodeLine lineNumber="622"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// have optimized the conditional &#42;branches&#42; in that way already to reduce</span></CodeLine>
<Link id="l00623" /><CodeLine lineNumber="623"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// instruction count. This late, we simply assume the minimal number of</span></CodeLine>
<Link id="l00624" /><CodeLine lineNumber="624"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// branch instructions is being emitted and use that to guide our cmov</span></CodeLine>
<Link id="l00625" /><CodeLine lineNumber="625"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// insertion.</span></CodeLine>
<Link id="l00626" /><CodeLine lineNumber="626"></CodeLine>
<Link id="l00627" /><CodeLine lineNumber="627"><span class="doxyHighlight">    BlockCondInfo <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a> = &#123;&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, &#123;&#125;, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">&#125;;</span></CodeLine>
<Link id="l00628" /><CodeLine lineNumber="628"></CodeLine>
<Link id="l00629" /><CodeLine lineNumber="629"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Now walk backwards through the terminators and build up successors they</span></CodeLine>
<Link id="l00630" /><CodeLine lineNumber="630"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// reach and the conditions.</span></CodeLine>
<Link id="l00631" /><CodeLine lineNumber="631"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> : <a href="/docs/api/namespaces/llvm/#a6b0ac1fa4f05de76413c5e0ca6334035">llvm::reverse</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>)) &#123;</span></CodeLine>
<Link id="l00632" /><CodeLine lineNumber="632"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Once we&#39;ve handled all the terminators, we&#39;re done.</span></CodeLine>
<Link id="l00633" /><CodeLine lineNumber="633"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isTerminator())</span></CodeLine>
<Link id="l00634" /><CodeLine lineNumber="634"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00635" /><CodeLine lineNumber="635"></CodeLine>
<Link id="l00636" /><CodeLine lineNumber="636"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If we see a non-branch terminator, we can&#39;t handle anything so bail.</span></CodeLine>
<Link id="l00637" /><CodeLine lineNumber="637"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isBranch()) &#123;</span></CodeLine>
<Link id="l00638" /><CodeLine lineNumber="638"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.CondBrs.clear();</span></CodeLine>
<Link id="l00639" /><CodeLine lineNumber="639"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00640" /><CodeLine lineNumber="640"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00641" /><CodeLine lineNumber="641"></CodeLine>
<Link id="l00642" /><CodeLine lineNumber="642"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If we see an unconditional branch, reset our state, clear any</span></CodeLine>
<Link id="l00643" /><CodeLine lineNumber="643"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// fallthrough, and set this is the &quot;else&quot; successor.</span></CodeLine>
<Link id="l00644" /><CodeLine lineNumber="644"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOpcode() == X86::JMP&#95;1) &#123;</span></CodeLine>
<Link id="l00645" /><CodeLine lineNumber="645"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.CondBrs.clear();</span></CodeLine>
<Link id="l00646" /><CodeLine lineNumber="646"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.UncondBr = &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>;</span></CodeLine>
<Link id="l00647" /><CodeLine lineNumber="647"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00648" /><CodeLine lineNumber="648"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00649" /><CodeLine lineNumber="649"></CodeLine>
<Link id="l00650" /><CodeLine lineNumber="650"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If we get an invalid condition, we have an indirect branch or some</span></CodeLine>
<Link id="l00651" /><CodeLine lineNumber="651"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// other unanalyzable &quot;fallthrough&quot; case. We model this as a nullptr for</span></CodeLine>
<Link id="l00652" /><CodeLine lineNumber="652"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// the destination so we can still guard any conditional successors.</span></CodeLine>
<Link id="l00653" /><CodeLine lineNumber="653"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Consider code sequences like:</span></CodeLine>
<Link id="l00654" /><CodeLine lineNumber="654"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// &#96;&#96;&#96;</span></CodeLine>
<Link id="l00655" /><CodeLine lineNumber="655"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//   jCC L1</span></CodeLine>
<Link id="l00656" /><CodeLine lineNumber="656"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">//   jmpq &#42;%rax</span></CodeLine>
<Link id="l00657" /><CodeLine lineNumber="657"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// &#96;&#96;&#96;</span></CodeLine>
<Link id="l00658" /><CodeLine lineNumber="658"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// We still want to harden the edge to &#96;L1&#96;.</span></CodeLine>
<Link id="l00659" /><CodeLine lineNumber="659"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/x86/#a0f2b2ef8f4560ffd46c7966e8315142f">X86::getCondFromBranch</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) == <a href="/docs/api/namespaces/llvm/x86/#a1a356a51a1fb4cc3c427599082cf1d2eab1840bfcd789713b29a40d9d55cb41e3">X86::COND&#95;INVALID</a>) &#123;</span></CodeLine>
<Link id="l00660" /><CodeLine lineNumber="660"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.CondBrs.clear();</span></CodeLine>
<Link id="l00661" /><CodeLine lineNumber="661"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.UncondBr = &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>;</span></CodeLine>
<Link id="l00662" /><CodeLine lineNumber="662"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00663" /><CodeLine lineNumber="663"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00664" /><CodeLine lineNumber="664"></CodeLine>
<Link id="l00665" /><CodeLine lineNumber="665"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// We have a vanilla conditional branch, add it to our list.</span></CodeLine>
<Link id="l00666" /><CodeLine lineNumber="666"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.CondBrs.push&#95;back(&amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</span></CodeLine>
<Link id="l00667" /><CodeLine lineNumber="667"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00668" /><CodeLine lineNumber="668"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.CondBrs.empty()) &#123;</span></CodeLine>
<Link id="l00669" /><CodeLine lineNumber="669"><span class="doxyHighlight">      ++NumBranchesUntraced;</span></CodeLine>
<Link id="l00670" /><CodeLine lineNumber="670"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;WARNING: unable to secure successors of block:\\n&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00671" /><CodeLine lineNumber="671"><span class="doxyHighlight">                 <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.dump());</span></CodeLine>
<Link id="l00672" /><CodeLine lineNumber="672"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00673" /><CodeLine lineNumber="673"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00674" /><CodeLine lineNumber="674"></CodeLine>
<Link id="l00675" /><CodeLine lineNumber="675"><span class="doxyHighlight">    Infos.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>);</span></CodeLine>
<Link id="l00676" /><CodeLine lineNumber="676"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00677" /><CodeLine lineNumber="677"></CodeLine>
<Link id="l00678" /><CodeLine lineNumber="678"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Infos;</span></CodeLine>
<Link id="l00679" /><CodeLine lineNumber="679"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00680" /><CodeLine lineNumber="680"></CodeLine>
<Link id="l00681" /><CodeLine lineNumber="681"><span class="doxyHighlightComment">/// Trace the predicate state through the CFG, instrumenting each conditional</span></CodeLine>
<Link id="l00682" /><CodeLine lineNumber="682"><span class="doxyHighlightComment">/// branch such that misspeculation through an edge will poison the predicate</span></CodeLine>
<Link id="l00683" /><CodeLine lineNumber="683"><span class="doxyHighlightComment">/// state.</span></CodeLine>
<Link id="l00684" /><CodeLine lineNumber="684"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00685" /><CodeLine lineNumber="685"><span class="doxyHighlightComment">/// Returns the list of inserted CMov instructions so that they can have their</span></CodeLine>
<Link id="l00686" /><CodeLine lineNumber="686"><span class="doxyHighlightComment">/// uses of the predicate state rewritten into proper SSA form once it is</span></CodeLine>
<Link id="l00687" /><CodeLine lineNumber="687"><span class="doxyHighlightComment">/// complete.</span></CodeLine>
<Link id="l00688" /><CodeLine lineNumber="688"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineInstr &#42;, 16&gt;</a></span></CodeLine>
<Link id="l00689" /><CodeLine lineNumber="689"><span class="doxyHighlight">X86SpeculativeLoadHardeningPass::tracePredStateThroughCFG(</span></CodeLine>
<Link id="l00690" /><CodeLine lineNumber="690"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF, <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;BlockCondInfo&gt;</a> Infos) &#123;</span></CodeLine>
<Link id="l00691" /><CodeLine lineNumber="691"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Collect the inserted cmov instructions so we can rewrite their uses of the</span></CodeLine>
<Link id="l00692" /><CodeLine lineNumber="692"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// predicate state into SSA form.</span></CodeLine>
<Link id="l00693" /><CodeLine lineNumber="693"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineInstr &#42;, 16&gt;</a> CMovs;</span></CodeLine>
<Link id="l00694" /><CodeLine lineNumber="694"></CodeLine>
<Link id="l00695" /><CodeLine lineNumber="695"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Now walk all of the basic blocks looking for ones that end in conditional</span></CodeLine>
<Link id="l00696" /><CodeLine lineNumber="696"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// jumps where we need to update this register along each edge.</span></CodeLine>
<Link id="l00697" /><CodeLine lineNumber="697"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> BlockCondInfo &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a> : Infos) &#123;</span></CodeLine>
<Link id="l00698" /><CodeLine lineNumber="698"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> = &#42;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.MBB;</span></CodeLine>
<Link id="l00699" /><CodeLine lineNumber="699"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;MachineInstr &#42;&gt;</a> &amp;CondBrs = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.CondBrs;</span></CodeLine>
<Link id="l00700" /><CodeLine lineNumber="700"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;UncondBr = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.UncondBr;</span></CodeLine>
<Link id="l00701" /><CodeLine lineNumber="701"></CodeLine>
<Link id="l00702" /><CodeLine lineNumber="702"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Tracing predicate through block: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.getName()</span></CodeLine>
<Link id="l00703" /><CodeLine lineNumber="703"><span class="doxyHighlight">                      &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00704" /><CodeLine lineNumber="704"><span class="doxyHighlight">    ++NumCondBranchesTraced;</span></CodeLine>
<Link id="l00705" /><CodeLine lineNumber="705"></CodeLine>
<Link id="l00706" /><CodeLine lineNumber="706"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Compute the non-conditional successor as either the target of any</span></CodeLine>
<Link id="l00707" /><CodeLine lineNumber="707"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// unconditional branch or the layout successor.</span></CodeLine>
<Link id="l00708" /><CodeLine lineNumber="708"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;UncondSucc =</span></CodeLine>
<Link id="l00709" /><CodeLine lineNumber="709"><span class="doxyHighlight">        UncondBr ? (UncondBr-&gt;<a href="/docs/api/classes/llvm/machineinstr/#a0363204b5fbab08a46f5a7cd7f376f78">getOpcode</a>() == X86::JMP&#95;1</span></CodeLine>
<Link id="l00710" /><CodeLine lineNumber="710"><span class="doxyHighlight">                        ? UncondBr-&gt;<a href="/docs/api/classes/llvm/machineinstr/#ad67c9230577a0b640c52852c75c93939">getOperand</a>(0).<a href="/docs/api/classes/llvm/machineoperand/#a57e64b633278df75c699e6b98ce15031">getMBB</a>()</span></CodeLine>
<Link id="l00711" /><CodeLine lineNumber="711"><span class="doxyHighlight">                        : </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l00712" /><CodeLine lineNumber="712"><span class="doxyHighlight">                 : &amp;&#42;<a href="/docs/api/namespaces/std">std</a>::next(<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a>::<a href="/docs/api/classes/llvm/iplist">iterator</a>(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>));</span></CodeLine>
<Link id="l00713" /><CodeLine lineNumber="713"></CodeLine>
<Link id="l00714" /><CodeLine lineNumber="714"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Count how many edges there are to any given successor.</span></CodeLine>
<Link id="l00715" /><CodeLine lineNumber="715"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;MachineBasicBlock &#42;, int&gt;</a> SuccCounts;</span></CodeLine>
<Link id="l00716" /><CodeLine lineNumber="716"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (UncondSucc)</span></CodeLine>
<Link id="l00717" /><CodeLine lineNumber="717"><span class="doxyHighlight">      ++SuccCounts&#91;UncondSucc&#93;;</span></CodeLine>
<Link id="l00718" /><CodeLine lineNumber="718"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CondBr : CondBrs)</span></CodeLine>
<Link id="l00719" /><CodeLine lineNumber="719"><span class="doxyHighlight">      ++SuccCounts&#91;CondBr-&gt;getOperand(0).getMBB()&#93;;</span></CodeLine>
<Link id="l00720" /><CodeLine lineNumber="720"></CodeLine>
<Link id="l00721" /><CodeLine lineNumber="721"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// A lambda to insert cmov instructions into a block checking all of the</span></CodeLine>
<Link id="l00722" /><CodeLine lineNumber="722"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// condition codes in a sequence.</span></CodeLine>
<Link id="l00723" /><CodeLine lineNumber="723"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> BuildCheckingBlockForSuccAndConds =</span></CodeLine>
<Link id="l00724" /><CodeLine lineNumber="724"><span class="doxyHighlight">        &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;Succ, </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> SuccCount,</span></CodeLine>
<Link id="l00725" /><CodeLine lineNumber="725"><span class="doxyHighlight">            <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;Br, <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;&amp;UncondBr,</span></CodeLine>
<Link id="l00726" /><CodeLine lineNumber="726"><span class="doxyHighlight">            <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;X86::CondCode&gt;</a> Conds) &#123;</span></CodeLine>
<Link id="l00727" /><CodeLine lineNumber="727"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// First, we split the edge to insert the checking block into a safe</span></CodeLine>
<Link id="l00728" /><CodeLine lineNumber="728"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// location.</span></CodeLine>
<Link id="l00729" /><CodeLine lineNumber="729"><span class="doxyHighlight">          auto &amp;CheckingMBB =</span></CodeLine>
<Link id="l00730" /><CodeLine lineNumber="730"><span class="doxyHighlight">              (SuccCount == 1 &amp;&amp; Succ.pred&#95;size() == 1)</span></CodeLine>
<Link id="l00731" /><CodeLine lineNumber="731"><span class="doxyHighlight">                  ? Succ</span></CodeLine>
<Link id="l00732" /><CodeLine lineNumber="732"><span class="doxyHighlight">                  : splitEdge(MBB, Succ, SuccCount, Br, UncondBr, &#42;TII);</span></CodeLine>
<Link id="l00733" /><CodeLine lineNumber="733"></CodeLine>
<Link id="l00734" /><CodeLine lineNumber="734"><span class="doxyHighlight">          bool LiveEFLAGS = Succ.isLiveIn(X86::EFLAGS);</span></CodeLine>
<Link id="l00735" /><CodeLine lineNumber="735"><span class="doxyHighlight">          if (!LiveEFLAGS)</span></CodeLine>
<Link id="l00736" /><CodeLine lineNumber="736"><span class="doxyHighlight">            CheckingMBB.addLiveIn(X86::EFLAGS);</span></CodeLine>
<Link id="l00737" /><CodeLine lineNumber="737"></CodeLine>
<Link id="l00738" /><CodeLine lineNumber="738"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// Now insert the cmovs to implement the checks.</span></CodeLine>
<Link id="l00739" /><CodeLine lineNumber="739"><span class="doxyHighlight">          auto InsertPt = CheckingMBB.begin();</span></CodeLine>
<Link id="l00740" /><CodeLine lineNumber="740"><span class="doxyHighlight">          assert((InsertPt == CheckingMBB.end() || !InsertPt-&gt;isPHI()) &amp;&amp;</span></CodeLine>
<Link id="l00741" /><CodeLine lineNumber="741"><span class="doxyHighlight">                 </span><span class="doxyHighlightStringLiteral">&quot;Should never have a PHI in the initial checking block as it &quot;</span></CodeLine>
<Link id="l00742" /><CodeLine lineNumber="742"><span class="doxyHighlight">                 </span><span class="doxyHighlightStringLiteral">&quot;always has a single predecessor!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00743" /><CodeLine lineNumber="743"></CodeLine>
<Link id="l00744" /><CodeLine lineNumber="744"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// We will wire each cmov to each other, but need to start with the</span></CodeLine>
<Link id="l00745" /><CodeLine lineNumber="745"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// incoming pred state.</span></CodeLine>
<Link id="l00746" /><CodeLine lineNumber="746"><span class="doxyHighlight">          unsigned CurStateReg = PS-&gt;InitialReg;</span></CodeLine>
<Link id="l00747" /><CodeLine lineNumber="747"></CodeLine>
<Link id="l00748" /><CodeLine lineNumber="748"><span class="doxyHighlight">          for (X86::CondCode Cond : Conds) &#123;</span></CodeLine>
<Link id="l00749" /><CodeLine lineNumber="749"><span class="doxyHighlight">            int PredStateSizeInBytes = TRI-&gt;getRegSizeInBits(&#42;PS-&gt;RC) / 8;</span></CodeLine>
<Link id="l00750" /><CodeLine lineNumber="750"><span class="doxyHighlight">            auto CMovOp = X86::getCMovOpcode(PredStateSizeInBytes);</span></CodeLine>
<Link id="l00751" /><CodeLine lineNumber="751"></CodeLine>
<Link id="l00752" /><CodeLine lineNumber="752"><span class="doxyHighlight">            Register UpdatedStateReg = MRI-&gt;createVirtualRegister(PS-&gt;RC);</span></CodeLine>
<Link id="l00753" /><CodeLine lineNumber="753"><span class="doxyHighlight">            </span><span class="doxyHighlightComment">// Note that we intentionally use an empty debug location so that</span></CodeLine>
<Link id="l00754" /><CodeLine lineNumber="754"><span class="doxyHighlight">            </span><span class="doxyHighlightComment">// this picks up the preceding location.</span></CodeLine>
<Link id="l00755" /><CodeLine lineNumber="755"><span class="doxyHighlight">            auto CMovI = BuildMI(CheckingMBB, InsertPt, DebugLoc(),</span></CodeLine>
<Link id="l00756" /><CodeLine lineNumber="756"><span class="doxyHighlight">                                 TII-&gt;get(CMovOp), UpdatedStateReg)</span></CodeLine>
<Link id="l00757" /><CodeLine lineNumber="757"><span class="doxyHighlight">                             .addReg(CurStateReg)</span></CodeLine>
<Link id="l00758" /><CodeLine lineNumber="758"><span class="doxyHighlight">                             .addReg(PS-&gt;PoisonReg)</span></CodeLine>
<Link id="l00759" /><CodeLine lineNumber="759"><span class="doxyHighlight">                             .addImm(Cond);</span></CodeLine>
<Link id="l00760" /><CodeLine lineNumber="760"><span class="doxyHighlight">            </span><span class="doxyHighlightComment">// If this is the last cmov and the EFLAGS weren&#39;t originally</span></CodeLine>
<Link id="l00761" /><CodeLine lineNumber="761"><span class="doxyHighlight">            </span><span class="doxyHighlightComment">// live-in, mark them as killed.</span></CodeLine>
<Link id="l00762" /><CodeLine lineNumber="762"><span class="doxyHighlight">            if (!LiveEFLAGS &amp;&amp; Cond == Conds.back())</span></CodeLine>
<Link id="l00763" /><CodeLine lineNumber="763"><span class="doxyHighlight">              CMovI-&gt;findRegisterUseOperand(X86::EFLAGS, </span><span class="doxyHighlightComment">/&#42;TRI=&#42;/</span><span class="doxyHighlight">nullptr)</span></CodeLine>
<Link id="l00764" /><CodeLine lineNumber="764"><span class="doxyHighlight">                  -&gt;setIsKill(true);</span></CodeLine>
<Link id="l00765" /><CodeLine lineNumber="765"></CodeLine>
<Link id="l00766" /><CodeLine lineNumber="766"><span class="doxyHighlight">            ++NumInstsInserted;</span></CodeLine>
<Link id="l00767" /><CodeLine lineNumber="767"><span class="doxyHighlight">            LLVM&#95;DEBUG(dbgs() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Inserting cmov: &quot;</span><span class="doxyHighlight">; CMovI-&gt;dump();</span></CodeLine>
<Link id="l00768" /><CodeLine lineNumber="768"><span class="doxyHighlight">                       dbgs() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00769" /><CodeLine lineNumber="769"></CodeLine>
<Link id="l00770" /><CodeLine lineNumber="770"><span class="doxyHighlight">            </span><span class="doxyHighlightComment">// The first one of the cmovs will be using the top level</span></CodeLine>
<Link id="l00771" /><CodeLine lineNumber="771"><span class="doxyHighlight">            </span><span class="doxyHighlightComment">// &#96;PredStateReg&#96; and need to get rewritten into SSA form.</span></CodeLine>
<Link id="l00772" /><CodeLine lineNumber="772"><span class="doxyHighlight">            if (CurStateReg == PS-&gt;InitialReg)</span></CodeLine>
<Link id="l00773" /><CodeLine lineNumber="773"><span class="doxyHighlight">              CMovs.push&#95;back(&amp;&#42;CMovI);</span></CodeLine>
<Link id="l00774" /><CodeLine lineNumber="774"></CodeLine>
<Link id="l00775" /><CodeLine lineNumber="775"><span class="doxyHighlight">            </span><span class="doxyHighlightComment">// The next cmov should start from this one&#39;s def.</span></CodeLine>
<Link id="l00776" /><CodeLine lineNumber="776"><span class="doxyHighlight">            CurStateReg = UpdatedStateReg;</span></CodeLine>
<Link id="l00777" /><CodeLine lineNumber="777"><span class="doxyHighlight">          &#125;</span></CodeLine>
<Link id="l00778" /><CodeLine lineNumber="778"></CodeLine>
<Link id="l00779" /><CodeLine lineNumber="779"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// And put the last one into the available values for SSA form of our</span></CodeLine>
<Link id="l00780" /><CodeLine lineNumber="780"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// predicate state.</span></CodeLine>
<Link id="l00781" /><CodeLine lineNumber="781"><span class="doxyHighlight">          PS-&gt;SSA.AddAvailableValue(&amp;CheckingMBB, CurStateReg);</span></CodeLine>
<Link id="l00782" /><CodeLine lineNumber="782"><span class="doxyHighlight">        &#125;;</span></CodeLine>
<Link id="l00783" /><CodeLine lineNumber="783"></CodeLine>
<Link id="l00784" /><CodeLine lineNumber="784"><span class="doxyHighlight">    std::vector&lt;X86::CondCode&gt; UncondCodeSeq;</span></CodeLine>
<Link id="l00785" /><CodeLine lineNumber="785"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CondBr : CondBrs) &#123;</span></CodeLine>
<Link id="l00786" /><CodeLine lineNumber="786"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;Succ = &#42;CondBr-&gt;getOperand(0).getMBB();</span></CodeLine>
<Link id="l00787" /><CodeLine lineNumber="787"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> &amp;SuccCount = SuccCounts&#91;&amp;Succ&#93;;</span></CodeLine>
<Link id="l00788" /><CodeLine lineNumber="788"></CodeLine>
<Link id="l00789" /><CodeLine lineNumber="789"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/x86/#a1a356a51a1fb4cc3c427599082cf1d2e">X86::CondCode</a> <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a> = <a href="/docs/api/namespaces/llvm/x86/#a0f2b2ef8f4560ffd46c7966e8315142f">X86::getCondFromBranch</a>(&#42;CondBr);</span></CodeLine>
<Link id="l00790" /><CodeLine lineNumber="790"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/x86/#a1a356a51a1fb4cc3c427599082cf1d2e">X86::CondCode</a> InvCond = <a href="/docs/api/namespaces/llvm/x86/#a5c06f5a972e8a78052103840a8c98a3f">X86::GetOppositeBranchCondition</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>);</span></CodeLine>
<Link id="l00791" /><CodeLine lineNumber="791"><span class="doxyHighlight">      UncondCodeSeq.push&#95;back(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>);</span></CodeLine>
<Link id="l00792" /><CodeLine lineNumber="792"></CodeLine>
<Link id="l00793" /><CodeLine lineNumber="793"><span class="doxyHighlight">      BuildCheckingBlockForSuccAndConds(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, Succ, SuccCount, CondBr, UncondBr,</span></CodeLine>
<Link id="l00794" /><CodeLine lineNumber="794"><span class="doxyHighlight">                                        &#123;InvCond&#125;);</span></CodeLine>
<Link id="l00795" /><CodeLine lineNumber="795"></CodeLine>
<Link id="l00796" /><CodeLine lineNumber="796"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Decrement the successor count now that we&#39;ve split one of the edges.</span></CodeLine>
<Link id="l00797" /><CodeLine lineNumber="797"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// We need to keep the count of edges to the successor accurate in order</span></CodeLine>
<Link id="l00798" /><CodeLine lineNumber="798"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// to know above when to &#42;replace&#42; the successor in the CFG vs. just</span></CodeLine>
<Link id="l00799" /><CodeLine lineNumber="799"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// adding the new successor.</span></CodeLine>
<Link id="l00800" /><CodeLine lineNumber="800"><span class="doxyHighlight">      --SuccCount;</span></CodeLine>
<Link id="l00801" /><CodeLine lineNumber="801"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00802" /><CodeLine lineNumber="802"></CodeLine>
<Link id="l00803" /><CodeLine lineNumber="803"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Since we may have split edges and changed the number of successors,</span></CodeLine>
<Link id="l00804" /><CodeLine lineNumber="804"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// normalize the probabilities. This avoids doing it each time we split an</span></CodeLine>
<Link id="l00805" /><CodeLine lineNumber="805"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// edge.</span></CodeLine>
<Link id="l00806" /><CodeLine lineNumber="806"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.normalizeSuccProbs();</span></CodeLine>
<Link id="l00807" /><CodeLine lineNumber="807"></CodeLine>
<Link id="l00808" /><CodeLine lineNumber="808"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Finally, we need to insert cmovs into the &quot;fallthrough&quot; edge. Here, we</span></CodeLine>
<Link id="l00809" /><CodeLine lineNumber="809"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// need to intersect the other condition codes. We can do this by just</span></CodeLine>
<Link id="l00810" /><CodeLine lineNumber="810"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// doing a cmov for each one.</span></CodeLine>
<Link id="l00811" /><CodeLine lineNumber="811"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!UncondSucc)</span></CodeLine>
<Link id="l00812" /><CodeLine lineNumber="812"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If we have no fallthrough to protect (perhaps it is an indirect jump?)</span></CodeLine>
<Link id="l00813" /><CodeLine lineNumber="813"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// just skip this and continue.</span></CodeLine>
<Link id="l00814" /><CodeLine lineNumber="814"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00815" /><CodeLine lineNumber="815"></CodeLine>
<Link id="l00816" /><CodeLine lineNumber="816"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(SuccCounts&#91;UncondSucc&#93; == 1 &amp;&amp;</span></CodeLine>
<Link id="l00817" /><CodeLine lineNumber="817"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;We should never have more than one edge to the unconditional &quot;</span></CodeLine>
<Link id="l00818" /><CodeLine lineNumber="818"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;successor at this point because every other edge must have been &quot;</span></CodeLine>
<Link id="l00819" /><CodeLine lineNumber="819"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;split above!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00820" /><CodeLine lineNumber="820"></CodeLine>
<Link id="l00821" /><CodeLine lineNumber="821"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Sort and unique the codes to minimize them.</span></CodeLine>
<Link id="l00822" /><CodeLine lineNumber="822"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a74cdbd1e4f731e7d7cd83461b8b1de0b">llvm::sort</a>(UncondCodeSeq);</span></CodeLine>
<Link id="l00823" /><CodeLine lineNumber="823"><span class="doxyHighlight">    UncondCodeSeq.erase(<a href="/docs/api/namespaces/llvm/#a48f85da577c6ce7d9aed90437dc0d07c">llvm::unique</a>(UncondCodeSeq), UncondCodeSeq.end());</span></CodeLine>
<Link id="l00824" /><CodeLine lineNumber="824"></CodeLine>
<Link id="l00825" /><CodeLine lineNumber="825"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Build a checking version of the successor.</span></CodeLine>
<Link id="l00826" /><CodeLine lineNumber="826"><span class="doxyHighlight">    BuildCheckingBlockForSuccAndConds(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, &#42;UncondSucc, </span><span class="doxyHighlightComment">/&#42;SuccCount&#42;/</span><span class="doxyHighlight"> 1,</span></CodeLine>
<Link id="l00827" /><CodeLine lineNumber="827"><span class="doxyHighlight">                                      UncondBr, UncondBr, UncondCodeSeq);</span></CodeLine>
<Link id="l00828" /><CodeLine lineNumber="828"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00829" /><CodeLine lineNumber="829"></CodeLine>
<Link id="l00830" /><CodeLine lineNumber="830"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> CMovs;</span></CodeLine>
<Link id="l00831" /><CodeLine lineNumber="831"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00832" /><CodeLine lineNumber="832"></CodeLine>
<Link id="l00833" /><CodeLine lineNumber="833"><span class="doxyHighlightComment">/// Compute the register class for the unfolded load.</span></CodeLine>
<Link id="l00834" /><CodeLine lineNumber="834"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00835" /><CodeLine lineNumber="835"><span class="doxyHighlightComment">/// FIXME: This should probably live in X86InstrInfo, potentially by adding</span></CodeLine>
<Link id="l00836" /><CodeLine lineNumber="836"><span class="doxyHighlightComment">/// a way to unfold into a newly created vreg rather than requiring a register</span></CodeLine>
<Link id="l00837" /><CodeLine lineNumber="837"><span class="doxyHighlightComment">/// input.</span></CodeLine>
<Link id="l00838" /><CodeLine lineNumber="838"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/targetregisterclass">TargetRegisterClass</a> &#42;</span></CodeLine>
<Link id="l00839" /><CodeLine lineNumber="839" lineLink="#aa521cd293ac8410168730efe322dce5c"><span class="doxyHighlight"><a href="#aa521cd293ac8410168730efe322dce5c">getRegClassForUnfoldedLoad</a>(<a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/x86instrinfo">X86InstrInfo</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>,</span></CodeLine>
<Link id="l00840" /><CodeLine lineNumber="840"><span class="doxyHighlight">                           </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> Opcode) &#123;</span></CodeLine>
<Link id="l00841" /><CodeLine lineNumber="841"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> Index;</span></CodeLine>
<Link id="l00842" /><CodeLine lineNumber="842"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> UnfoldedOpc = <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>.getOpcodeAfterMemoryUnfold(</span></CodeLine>
<Link id="l00843" /><CodeLine lineNumber="843"><span class="doxyHighlight">      Opcode, </span><span class="doxyHighlightComment">/&#42;UnfoldLoad&#42;/</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">, </span><span class="doxyHighlightComment">/&#42;UnfoldStore&#42;/</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">, &amp;Index);</span></CodeLine>
<Link id="l00844" /><CodeLine lineNumber="844"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/mcinstrdesc">MCInstrDesc</a> &amp;<a href="/docs/api/namespaces/llvm/mcid">MCID</a> = <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>.get(UnfoldedOpc);</span></CodeLine>
<Link id="l00845" /><CodeLine lineNumber="845"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>.getRegClass(<a href="/docs/api/namespaces/llvm/mcid">MCID</a>, Index, &amp;<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>.getRegisterInfo(), MF);</span></CodeLine>
<Link id="l00846" /><CodeLine lineNumber="846"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00847" /><CodeLine lineNumber="847"></CodeLine>
<Link id="l00848" /><CodeLine lineNumber="848"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> X86SpeculativeLoadHardeningPass::unfoldCallAndJumpLoads(</span></CodeLine>
<Link id="l00849" /><CodeLine lineNumber="849"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF) &#123;</span></CodeLine>
<Link id="l00850" /><CodeLine lineNumber="850"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : MF)</span></CodeLine>
<Link id="l00851" /><CodeLine lineNumber="851"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We use make&#95;early&#95;inc&#95;range here so we can remove instructions if needed</span></CodeLine>
<Link id="l00852" /><CodeLine lineNumber="852"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// without disturbing the iteration.</span></CodeLine>
<Link id="l00853" /><CodeLine lineNumber="853"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> : <a href="/docs/api/namespaces/llvm/#a3d2cdc4a0db233678e7141c9d6ea3419">llvm::make&#95;early&#95;inc&#95;range</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.instrs())) &#123;</span></CodeLine>
<Link id="l00854" /><CodeLine lineNumber="854"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Must either be a call or a branch.</span></CodeLine>
<Link id="l00855" /><CodeLine lineNumber="855"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isCall() &amp;&amp; !<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isBranch())</span></CodeLine>
<Link id="l00856" /><CodeLine lineNumber="856"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00857" /><CodeLine lineNumber="857"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// We only care about loading variants of these instructions.</span></CodeLine>
<Link id="l00858" /><CodeLine lineNumber="858"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.mayLoad())</span></CodeLine>
<Link id="l00859" /><CodeLine lineNumber="859"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00860" /><CodeLine lineNumber="860"></CodeLine>
<Link id="l00861" /><CodeLine lineNumber="861"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOpcode()) &#123;</span></CodeLine>
<Link id="l00862" /><CodeLine lineNumber="862"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">default</span><span class="doxyHighlight">: &#123;</span></CodeLine>
<Link id="l00863" /><CodeLine lineNumber="863"><span class="doxyHighlight">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(</span></CodeLine>
<Link id="l00864" /><CodeLine lineNumber="864"><span class="doxyHighlight">            <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;ERROR: Found an unexpected loading branch or call &quot;</span></CodeLine>
<Link id="l00865" /><CodeLine lineNumber="865"><span class="doxyHighlight">                      </span><span class="doxyHighlightStringLiteral">&quot;instruction:\\n&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00866" /><CodeLine lineNumber="866"><span class="doxyHighlight">            <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00867" /><CodeLine lineNumber="867"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(</span><span class="doxyHighlightStringLiteral">&quot;Unexpected loading branch or call!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00868" /><CodeLine lineNumber="868"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00869" /><CodeLine lineNumber="869"></CodeLine>
<Link id="l00870" /><CodeLine lineNumber="870"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::FARCALL16m:</span></CodeLine>
<Link id="l00871" /><CodeLine lineNumber="871"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::FARCALL32m:</span></CodeLine>
<Link id="l00872" /><CodeLine lineNumber="872"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::FARCALL64m:</span></CodeLine>
<Link id="l00873" /><CodeLine lineNumber="873"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::FARJMP16m:</span></CodeLine>
<Link id="l00874" /><CodeLine lineNumber="874"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::FARJMP32m:</span></CodeLine>
<Link id="l00875" /><CodeLine lineNumber="875"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::FARJMP64m:</span></CodeLine>
<Link id="l00876" /><CodeLine lineNumber="876"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// We cannot mitigate far jumps or calls, but we also don&#39;t expect them</span></CodeLine>
<Link id="l00877" /><CodeLine lineNumber="877"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// to be vulnerable to Spectre v1.2 style attacks.</span></CodeLine>
<Link id="l00878" /><CodeLine lineNumber="878"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00879" /><CodeLine lineNumber="879"></CodeLine>
<Link id="l00880" /><CodeLine lineNumber="880"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::CALL16m:</span></CodeLine>
<Link id="l00881" /><CodeLine lineNumber="881"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::CALL16m&#95;NT:</span></CodeLine>
<Link id="l00882" /><CodeLine lineNumber="882"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::CALL32m:</span></CodeLine>
<Link id="l00883" /><CodeLine lineNumber="883"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::CALL32m&#95;NT:</span></CodeLine>
<Link id="l00884" /><CodeLine lineNumber="884"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::CALL64m:</span></CodeLine>
<Link id="l00885" /><CodeLine lineNumber="885"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::CALL64m&#95;NT:</span></CodeLine>
<Link id="l00886" /><CodeLine lineNumber="886"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::JMP16m:</span></CodeLine>
<Link id="l00887" /><CodeLine lineNumber="887"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::JMP16m&#95;NT:</span></CodeLine>
<Link id="l00888" /><CodeLine lineNumber="888"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::JMP32m:</span></CodeLine>
<Link id="l00889" /><CodeLine lineNumber="889"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::JMP32m&#95;NT:</span></CodeLine>
<Link id="l00890" /><CodeLine lineNumber="890"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::JMP64m:</span></CodeLine>
<Link id="l00891" /><CodeLine lineNumber="891"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::JMP64m&#95;NT:</span></CodeLine>
<Link id="l00892" /><CodeLine lineNumber="892"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::TAILJMPm64:</span></CodeLine>
<Link id="l00893" /><CodeLine lineNumber="893"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::TAILJMPm64&#95;REX:</span></CodeLine>
<Link id="l00894" /><CodeLine lineNumber="894"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::TAILJMPm:</span></CodeLine>
<Link id="l00895" /><CodeLine lineNumber="895"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::TCRETURNmi64:</span></CodeLine>
<Link id="l00896" /><CodeLine lineNumber="896"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::TCRETURNmi: &#123;</span></CodeLine>
<Link id="l00897" /><CodeLine lineNumber="897"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Use the generic unfold logic now that we know we&#39;re dealing with</span></CodeLine>
<Link id="l00898" /><CodeLine lineNumber="898"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// expected instructions.</span></CodeLine>
<Link id="l00899" /><CodeLine lineNumber="899"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// FIXME: We don&#39;t have test coverage for all of these!</span></CodeLine>
<Link id="l00900" /><CodeLine lineNumber="900"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;UnfoldedRC = <a href="#aa521cd293ac8410168730efe322dce5c">getRegClassForUnfoldedLoad</a>(MF, &#42;<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>, <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOpcode());</span></CodeLine>
<Link id="l00901" /><CodeLine lineNumber="901"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!UnfoldedRC) &#123;</span></CodeLine>
<Link id="l00902" /><CodeLine lineNumber="902"><span class="doxyHighlight">          <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>()</span></CodeLine>
<Link id="l00903" /><CodeLine lineNumber="903"><span class="doxyHighlight">                         &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;ERROR: Unable to unfold load from instruction:\\n&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00904" /><CodeLine lineNumber="904"><span class="doxyHighlight">                     <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00905" /><CodeLine lineNumber="905"><span class="doxyHighlight">          <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(</span><span class="doxyHighlightStringLiteral">&quot;Unable to unfold load!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00906" /><CodeLine lineNumber="906"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l00907" /><CodeLine lineNumber="907"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/register">Register</a> <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a> = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(UnfoldedRC);</span></CodeLine>
<Link id="l00908" /><CodeLine lineNumber="908"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineInstr &#42;, 2&gt;</a> NewMIs;</span></CodeLine>
<Link id="l00909" /><CodeLine lineNumber="909"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// If we were able to compute an unfolded reg class, any failure here</span></CodeLine>
<Link id="l00910" /><CodeLine lineNumber="910"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// is just a programming error so just assert.</span></CodeLine>
<Link id="l00911" /><CodeLine lineNumber="911"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> Unfolded =</span></CodeLine>
<Link id="l00912" /><CodeLine lineNumber="912"><span class="doxyHighlight">            <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;unfoldMemoryOperand(MF, <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>, <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>, </span><span class="doxyHighlightComment">/&#42;UnfoldLoad&#42;/</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00913" /><CodeLine lineNumber="913"><span class="doxyHighlight">                                     </span><span class="doxyHighlightComment">/&#42;UnfoldStore&#42;/</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">, NewMIs);</span></CodeLine>
<Link id="l00914" /><CodeLine lineNumber="914"><span class="doxyHighlight">        (void)Unfolded;</span></CodeLine>
<Link id="l00915" /><CodeLine lineNumber="915"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Unfolded &amp;&amp;</span></CodeLine>
<Link id="l00916" /><CodeLine lineNumber="916"><span class="doxyHighlight">               </span><span class="doxyHighlightStringLiteral">&quot;Computed unfolded register class but failed to unfold&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00917" /><CodeLine lineNumber="917"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Now stitch the new instructions into place and erase the old one.</span></CodeLine>
<Link id="l00918" /><CodeLine lineNumber="918"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewMI : NewMIs)</span></CodeLine>
<Link id="l00919" /><CodeLine lineNumber="919"><span class="doxyHighlight">          <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.insert(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getIterator(), NewMI);</span></CodeLine>
<Link id="l00920" /><CodeLine lineNumber="920"></CodeLine>
<Link id="l00921" /><CodeLine lineNumber="921"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Update the call info.</span></CodeLine>
<Link id="l00922" /><CodeLine lineNumber="922"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isCandidateForAdditionalCallInfo())</span></CodeLine>
<Link id="l00923" /><CodeLine lineNumber="923"><span class="doxyHighlight">          MF.eraseAdditionalCallInfo(&amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</span></CodeLine>
<Link id="l00924" /><CodeLine lineNumber="924"></CodeLine>
<Link id="l00925" /><CodeLine lineNumber="925"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.eraseFromParent();</span></CodeLine>
<Link id="l00926" /><CodeLine lineNumber="926"><span class="doxyHighlight">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(&#123;</span></CodeLine>
<Link id="l00927" /><CodeLine lineNumber="927"><span class="doxyHighlight">          <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Unfolded load successfully into:\\n&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00928" /><CodeLine lineNumber="928"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewMI : NewMIs) &#123;</span></CodeLine>
<Link id="l00929" /><CodeLine lineNumber="929"><span class="doxyHighlight">            NewMI-&gt;dump();</span></CodeLine>
<Link id="l00930" /><CodeLine lineNumber="930"><span class="doxyHighlight">            <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00931" /><CodeLine lineNumber="931"><span class="doxyHighlight">          &#125;</span></CodeLine>
<Link id="l00932" /><CodeLine lineNumber="932"><span class="doxyHighlight">        &#125;);</span></CodeLine>
<Link id="l00933" /><CodeLine lineNumber="933"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00934" /><CodeLine lineNumber="934"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00935" /><CodeLine lineNumber="935"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00936" /><CodeLine lineNumber="936"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/errorhandling-h/#ace243f5c25697a1107cce46626b3dc94">llvm&#95;unreachable</a>(</span><span class="doxyHighlightStringLiteral">&quot;Escaped switch with default!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00937" /><CodeLine lineNumber="937"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00938" /><CodeLine lineNumber="938"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00939" /><CodeLine lineNumber="939"></CodeLine>
<Link id="l00940" /><CodeLine lineNumber="940"><span class="doxyHighlightComment">/// Trace the predicate state through indirect branches, instrumenting them to</span></CodeLine>
<Link id="l00941" /><CodeLine lineNumber="941"><span class="doxyHighlightComment">/// poison the state if a target is reached that does not match the expected</span></CodeLine>
<Link id="l00942" /><CodeLine lineNumber="942"><span class="doxyHighlightComment">/// target.</span></CodeLine>
<Link id="l00943" /><CodeLine lineNumber="943"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00944" /><CodeLine lineNumber="944"><span class="doxyHighlightComment">/// This is designed to mitigate Spectre variant 1 attacks where an indirect</span></CodeLine>
<Link id="l00945" /><CodeLine lineNumber="945"><span class="doxyHighlightComment">/// branch is trained to predict a particular target and then mispredicts that</span></CodeLine>
<Link id="l00946" /><CodeLine lineNumber="946"><span class="doxyHighlightComment">/// target in a way that can leak data. Despite using an indirect branch, this</span></CodeLine>
<Link id="l00947" /><CodeLine lineNumber="947"><span class="doxyHighlightComment">/// is really a variant 1 style attack: it does not steer execution to an</span></CodeLine>
<Link id="l00948" /><CodeLine lineNumber="948"><span class="doxyHighlightComment">/// arbitrary or attacker controlled address, and it does not require any</span></CodeLine>
<Link id="l00949" /><CodeLine lineNumber="949"><span class="doxyHighlightComment">/// special code executing next to the victim. This attack can also be mitigated</span></CodeLine>
<Link id="l00950" /><CodeLine lineNumber="950"><span class="doxyHighlightComment">/// through retpolines, but those require either replacing indirect branches</span></CodeLine>
<Link id="l00951" /><CodeLine lineNumber="951"><span class="doxyHighlightComment">/// with conditional direct branches or lowering them through a device that</span></CodeLine>
<Link id="l00952" /><CodeLine lineNumber="952"><span class="doxyHighlightComment">/// blocks speculation. This mitigation can replace these retpoline-style</span></CodeLine>
<Link id="l00953" /><CodeLine lineNumber="953"><span class="doxyHighlightComment">/// mitigations for jump tables and other indirect branches within a function</span></CodeLine>
<Link id="l00954" /><CodeLine lineNumber="954"><span class="doxyHighlightComment">/// when variant 2 isn&#39;t a risk while allowing limited speculation. Indirect</span></CodeLine>
<Link id="l00955" /><CodeLine lineNumber="955"><span class="doxyHighlightComment">/// calls, however, cannot be mitigated through this technique without changing</span></CodeLine>
<Link id="l00956" /><CodeLine lineNumber="956"><span class="doxyHighlightComment">/// the ABI in a fundamental way.</span></CodeLine>
<Link id="l00957" /><CodeLine lineNumber="957"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineInstr &#42;, 16&gt;</a></span></CodeLine>
<Link id="l00958" /><CodeLine lineNumber="958"><span class="doxyHighlight">X86SpeculativeLoadHardeningPass::tracePredStateThroughIndirectBranches(</span></CodeLine>
<Link id="l00959" /><CodeLine lineNumber="959"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF) &#123;</span></CodeLine>
<Link id="l00960" /><CodeLine lineNumber="960"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We use the SSAUpdater to insert PHI nodes for the target addresses of</span></CodeLine>
<Link id="l00961" /><CodeLine lineNumber="961"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// indirect branches. We don&#39;t actually need the full power of the SSA updater</span></CodeLine>
<Link id="l00962" /><CodeLine lineNumber="962"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// in this particular case as we always have immediately available values, but</span></CodeLine>
<Link id="l00963" /><CodeLine lineNumber="963"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// this avoids us having to re-implement the PHI construction logic.</span></CodeLine>
<Link id="l00964" /><CodeLine lineNumber="964"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinessaupdater">MachineSSAUpdater</a> TargetAddrSSA(MF);</span></CodeLine>
<Link id="l00965" /><CodeLine lineNumber="965"><span class="doxyHighlight">  TargetAddrSSA.Initialize(<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(&amp;X86::GR64RegClass));</span></CodeLine>
<Link id="l00966" /><CodeLine lineNumber="966"></CodeLine>
<Link id="l00967" /><CodeLine lineNumber="967"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Track which blocks were terminated with an indirect branch.</span></CodeLine>
<Link id="l00968" /><CodeLine lineNumber="968"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;MachineBasicBlock &#42;, 4&gt;</a> IndirectTerminatedMBBs;</span></CodeLine>
<Link id="l00969" /><CodeLine lineNumber="969"></CodeLine>
<Link id="l00970" /><CodeLine lineNumber="970"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We need to know what blocks end up reached via indirect branches. We</span></CodeLine>
<Link id="l00971" /><CodeLine lineNumber="971"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// expect this to be a subset of those whose address is taken and so track it</span></CodeLine>
<Link id="l00972" /><CodeLine lineNumber="972"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// directly via the CFG.</span></CodeLine>
<Link id="l00973" /><CodeLine lineNumber="973"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;MachineBasicBlock &#42;, 4&gt;</a> IndirectTargetMBBs;</span></CodeLine>
<Link id="l00974" /><CodeLine lineNumber="974"></CodeLine>
<Link id="l00975" /><CodeLine lineNumber="975"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Walk all the blocks which end in an indirect branch and make the</span></CodeLine>
<Link id="l00976" /><CodeLine lineNumber="976"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// target address available.</span></CodeLine>
<Link id="l00977" /><CodeLine lineNumber="977"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : MF) &#123;</span></CodeLine>
<Link id="l00978" /><CodeLine lineNumber="978"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Find the last terminator.</span></CodeLine>
<Link id="l00979" /><CodeLine lineNumber="979"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> MII = <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.instr&#95;rbegin();</span></CodeLine>
<Link id="l00980" /><CodeLine lineNumber="980"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">while</span><span class="doxyHighlight"> (MII != <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.instr&#95;rend() &amp;&amp; MII-&gt;isDebugInstr())</span></CodeLine>
<Link id="l00981" /><CodeLine lineNumber="981"><span class="doxyHighlight">      ++MII;</span></CodeLine>
<Link id="l00982" /><CodeLine lineNumber="982"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (MII == <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.instr&#95;rend())</span></CodeLine>
<Link id="l00983" /><CodeLine lineNumber="983"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00984" /><CodeLine lineNumber="984"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;TI = &#42;MII;</span></CodeLine>
<Link id="l00985" /><CodeLine lineNumber="985"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!TI.<a href="/docs/api/classes/llvm/machineinstr/#a0e85c20fe804527f12c86db38ec947ea">isTerminator</a>() || !TI.<a href="/docs/api/classes/llvm/machineinstr/#a5891cdb51072f67e65f7ebd9be1205e7">isBranch</a>())</span></CodeLine>
<Link id="l00986" /><CodeLine lineNumber="986"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// No terminator or non-branch terminator.</span></CodeLine>
<Link id="l00987" /><CodeLine lineNumber="987"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00988" /><CodeLine lineNumber="988"></CodeLine>
<Link id="l00989" /><CodeLine lineNumber="989"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> TargetReg;</span></CodeLine>
<Link id="l00990" /><CodeLine lineNumber="990"></CodeLine>
<Link id="l00991" /><CodeLine lineNumber="991"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (TI.<a href="/docs/api/classes/llvm/machineinstr/#a0363204b5fbab08a46f5a7cd7f376f78">getOpcode</a>()) &#123;</span></CodeLine>
<Link id="l00992" /><CodeLine lineNumber="992"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">default</span><span class="doxyHighlight">:</span></CodeLine>
<Link id="l00993" /><CodeLine lineNumber="993"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Direct branch or conditional branch (leading to fallthrough).</span></CodeLine>
<Link id="l00994" /><CodeLine lineNumber="994"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00995" /><CodeLine lineNumber="995"></CodeLine>
<Link id="l00996" /><CodeLine lineNumber="996"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::FARJMP16m:</span></CodeLine>
<Link id="l00997" /><CodeLine lineNumber="997"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::FARJMP32m:</span></CodeLine>
<Link id="l00998" /><CodeLine lineNumber="998"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::FARJMP64m:</span></CodeLine>
<Link id="l00999" /><CodeLine lineNumber="999"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// We cannot mitigate far jumps or calls, but we also don&#39;t expect them</span></CodeLine>
<Link id="l01000" /><CodeLine lineNumber="1000"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// to be vulnerable to Spectre v1.2 or v2 (self trained) style attacks.</span></CodeLine>
<Link id="l01001" /><CodeLine lineNumber="1001"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01002" /><CodeLine lineNumber="1002"></CodeLine>
<Link id="l01003" /><CodeLine lineNumber="1003"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::JMP16m:</span></CodeLine>
<Link id="l01004" /><CodeLine lineNumber="1004"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::JMP16m&#95;NT:</span></CodeLine>
<Link id="l01005" /><CodeLine lineNumber="1005"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::JMP32m:</span></CodeLine>
<Link id="l01006" /><CodeLine lineNumber="1006"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::JMP32m&#95;NT:</span></CodeLine>
<Link id="l01007" /><CodeLine lineNumber="1007"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::JMP64m:</span></CodeLine>
<Link id="l01008" /><CodeLine lineNumber="1008"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::JMP64m&#95;NT:</span></CodeLine>
<Link id="l01009" /><CodeLine lineNumber="1009"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Mostly as documentation.</span></CodeLine>
<Link id="l01010" /><CodeLine lineNumber="1010"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(</span><span class="doxyHighlightStringLiteral">&quot;Memory operand jumps should have been unfolded!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01011" /><CodeLine lineNumber="1011"></CodeLine>
<Link id="l01012" /><CodeLine lineNumber="1012"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::JMP16r:</span></CodeLine>
<Link id="l01013" /><CodeLine lineNumber="1013"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(</span></CodeLine>
<Link id="l01014" /><CodeLine lineNumber="1014"><span class="doxyHighlight">          </span><span class="doxyHighlightStringLiteral">&quot;Support for 16-bit indirect branches is not implemented.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01015" /><CodeLine lineNumber="1015"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::JMP32r:</span></CodeLine>
<Link id="l01016" /><CodeLine lineNumber="1016"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(</span></CodeLine>
<Link id="l01017" /><CodeLine lineNumber="1017"><span class="doxyHighlight">          </span><span class="doxyHighlightStringLiteral">&quot;Support for 32-bit indirect branches is not implemented.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01018" /><CodeLine lineNumber="1018"></CodeLine>
<Link id="l01019" /><CodeLine lineNumber="1019"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::JMP64r:</span></CodeLine>
<Link id="l01020" /><CodeLine lineNumber="1020"><span class="doxyHighlight">      TargetReg = TI.<a href="/docs/api/classes/llvm/machineinstr/#ad67c9230577a0b640c52852c75c93939">getOperand</a>(0).<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>();</span></CodeLine>
<Link id="l01021" /><CodeLine lineNumber="1021"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01022" /><CodeLine lineNumber="1022"></CodeLine>
<Link id="l01023" /><CodeLine lineNumber="1023"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We have definitely found an indirect  branch. Verify that there are no</span></CodeLine>
<Link id="l01024" /><CodeLine lineNumber="1024"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// preceding conditional branches as we don&#39;t yet support that.</span></CodeLine>
<Link id="l01025" /><CodeLine lineNumber="1025"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a61d13d6824ec46c31260a4fd0997eda0">llvm::any&#95;of</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.terminators(), &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;OtherTI) &#123;</span></CodeLine>
<Link id="l01026" /><CodeLine lineNumber="1026"><span class="doxyHighlight">          return !OtherTI.isDebugInstr() &amp;&amp; &amp;OtherTI != &amp;TI;</span></CodeLine>
<Link id="l01027" /><CodeLine lineNumber="1027"><span class="doxyHighlight">        &#125;)) &#123;</span></CodeLine>
<Link id="l01028" /><CodeLine lineNumber="1028"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(&#123;</span></CodeLine>
<Link id="l01029" /><CodeLine lineNumber="1029"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;ERROR: Found other terminators in a block with an indirect &quot;</span></CodeLine>
<Link id="l01030" /><CodeLine lineNumber="1030"><span class="doxyHighlight">                  </span><span class="doxyHighlightStringLiteral">&quot;branch! This is not yet supported! Terminator sequence:\\n&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01031" /><CodeLine lineNumber="1031"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> : <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.terminators()) &#123;</span></CodeLine>
<Link id="l01032" /><CodeLine lineNumber="1032"><span class="doxyHighlight">          <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.dump();</span></CodeLine>
<Link id="l01033" /><CodeLine lineNumber="1033"><span class="doxyHighlight">          <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightCharLiteral">&#39;\\n&#39;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01034" /><CodeLine lineNumber="1034"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l01035" /><CodeLine lineNumber="1035"><span class="doxyHighlight">      &#125;);</span></CodeLine>
<Link id="l01036" /><CodeLine lineNumber="1036"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(</span><span class="doxyHighlightStringLiteral">&quot;Unimplemented terminator sequence!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01037" /><CodeLine lineNumber="1037"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01038" /><CodeLine lineNumber="1038"></CodeLine>
<Link id="l01039" /><CodeLine lineNumber="1039"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Make the target register an available value for this block.</span></CodeLine>
<Link id="l01040" /><CodeLine lineNumber="1040"><span class="doxyHighlight">    TargetAddrSSA.AddAvailableValue(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, TargetReg);</span></CodeLine>
<Link id="l01041" /><CodeLine lineNumber="1041"><span class="doxyHighlight">    IndirectTerminatedMBBs.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</span></CodeLine>
<Link id="l01042" /><CodeLine lineNumber="1042"></CodeLine>
<Link id="l01043" /><CodeLine lineNumber="1043"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Add all the successors to our target candidates.</span></CodeLine>
<Link id="l01044" /><CodeLine lineNumber="1044"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ : <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.successors())</span></CodeLine>
<Link id="l01045" /><CodeLine lineNumber="1045"><span class="doxyHighlight">      IndirectTargetMBBs.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(Succ);</span></CodeLine>
<Link id="l01046" /><CodeLine lineNumber="1046"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01047" /><CodeLine lineNumber="1047"></CodeLine>
<Link id="l01048" /><CodeLine lineNumber="1048"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Keep track of the cmov instructions we insert so we can return them.</span></CodeLine>
<Link id="l01049" /><CodeLine lineNumber="1049"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineInstr &#42;, 16&gt;</a> CMovs;</span></CodeLine>
<Link id="l01050" /><CodeLine lineNumber="1050"></CodeLine>
<Link id="l01051" /><CodeLine lineNumber="1051"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we didn&#39;t find any indirect branches with targets, nothing to do here.</span></CodeLine>
<Link id="l01052" /><CodeLine lineNumber="1052"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IndirectTargetMBBs.<a href="/docs/api/classes/llvm/smallptrsetimplbase/#af8a50544090e81ac83601aff8f4b0142">empty</a>())</span></CodeLine>
<Link id="l01053" /><CodeLine lineNumber="1053"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> CMovs;</span></CodeLine>
<Link id="l01054" /><CodeLine lineNumber="1054"></CodeLine>
<Link id="l01055" /><CodeLine lineNumber="1055"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We found indirect branches and targets that need to be instrumented to</span></CodeLine>
<Link id="l01056" /><CodeLine lineNumber="1056"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// harden loads within them. Walk the blocks of the function (to get a stable</span></CodeLine>
<Link id="l01057" /><CodeLine lineNumber="1057"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// ordering) and instrument each target of an indirect branch.</span></CodeLine>
<Link id="l01058" /><CodeLine lineNumber="1058"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : MF) &#123;</span></CodeLine>
<Link id="l01059" /><CodeLine lineNumber="1059"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Skip the blocks that aren&#39;t candidate targets.</span></CodeLine>
<Link id="l01060" /><CodeLine lineNumber="1060"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!IndirectTargetMBBs.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>))</span></CodeLine>
<Link id="l01061" /><CodeLine lineNumber="1061"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01062" /><CodeLine lineNumber="1062"></CodeLine>
<Link id="l01063" /><CodeLine lineNumber="1063"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We don&#39;t expect EH pads to ever be reached via an indirect branch. If</span></CodeLine>
<Link id="l01064" /><CodeLine lineNumber="1064"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// this is desired for some reason, we could simply skip them here rather</span></CodeLine>
<Link id="l01065" /><CodeLine lineNumber="1065"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// than asserting.</span></CodeLine>
<Link id="l01066" /><CodeLine lineNumber="1066"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.isEHPad() &amp;&amp;</span></CodeLine>
<Link id="l01067" /><CodeLine lineNumber="1067"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;Unexpected EH pad as target of an indirect branch!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01068" /><CodeLine lineNumber="1068"></CodeLine>
<Link id="l01069" /><CodeLine lineNumber="1069"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We should never end up threading EFLAGS into a block to harden</span></CodeLine>
<Link id="l01070" /><CodeLine lineNumber="1070"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// conditional jumps as there would be an additional successor via the</span></CodeLine>
<Link id="l01071" /><CodeLine lineNumber="1071"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// indirect branch. As a consequence, all such edges would be split before</span></CodeLine>
<Link id="l01072" /><CodeLine lineNumber="1072"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// reaching here, and the inserted block will handle the EFLAGS-based</span></CodeLine>
<Link id="l01073" /><CodeLine lineNumber="1073"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// hardening.</span></CodeLine>
<Link id="l01074" /><CodeLine lineNumber="1074"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.isLiveIn(X86::EFLAGS) &amp;&amp;</span></CodeLine>
<Link id="l01075" /><CodeLine lineNumber="1075"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;Cannot check within a block that already has live-in EFLAGS!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01076" /><CodeLine lineNumber="1076"></CodeLine>
<Link id="l01077" /><CodeLine lineNumber="1077"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We can&#39;t handle having non-indirect edges into this block unless this is</span></CodeLine>
<Link id="l01078" /><CodeLine lineNumber="1078"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// the only successor and we can synthesize the necessary target address.</span></CodeLine>
<Link id="l01079" /><CodeLine lineNumber="1079"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Pred : <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.predecessors()) &#123;</span></CodeLine>
<Link id="l01080" /><CodeLine lineNumber="1080"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If we&#39;ve already handled this by extracting the target directly,</span></CodeLine>
<Link id="l01081" /><CodeLine lineNumber="1081"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// nothing to do.</span></CodeLine>
<Link id="l01082" /><CodeLine lineNumber="1082"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IndirectTerminatedMBBs.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(Pred))</span></CodeLine>
<Link id="l01083" /><CodeLine lineNumber="1083"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01084" /><CodeLine lineNumber="1084"></CodeLine>
<Link id="l01085" /><CodeLine lineNumber="1085"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Otherwise, we have to be the only successor. We generally expect this</span></CodeLine>
<Link id="l01086" /><CodeLine lineNumber="1086"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// to be true as conditional branches should have had a critical edge</span></CodeLine>
<Link id="l01087" /><CodeLine lineNumber="1087"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// split already. We don&#39;t however need to worry about EH pad successors</span></CodeLine>
<Link id="l01088" /><CodeLine lineNumber="1088"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// as they&#39;ll happily ignore the target and their hardening strategy is</span></CodeLine>
<Link id="l01089" /><CodeLine lineNumber="1089"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// resilient to all ways in which they could be reached speculatively.</span></CodeLine>
<Link id="l01090" /><CodeLine lineNumber="1090"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/#a0d10fe510ced2849a8074fe81e5d04ce">llvm::all&#95;of</a>(Pred-&gt;successors(), &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &#42;Succ) &#123;</span></CodeLine>
<Link id="l01091" /><CodeLine lineNumber="1091"><span class="doxyHighlight">            return Succ-&gt;isEHPad() || Succ == &amp;MBB;</span></CodeLine>
<Link id="l01092" /><CodeLine lineNumber="1092"><span class="doxyHighlight">          &#125;)) &#123;</span></CodeLine>
<Link id="l01093" /><CodeLine lineNumber="1093"><span class="doxyHighlight">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(&#123;</span></CodeLine>
<Link id="l01094" /><CodeLine lineNumber="1094"><span class="doxyHighlight">          <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;ERROR: Found conditional entry to target of indirect &quot;</span></CodeLine>
<Link id="l01095" /><CodeLine lineNumber="1095"><span class="doxyHighlight">                    </span><span class="doxyHighlightStringLiteral">&quot;branch!\\n&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01096" /><CodeLine lineNumber="1096"><span class="doxyHighlight">          Pred-&gt;dump();</span></CodeLine>
<Link id="l01097" /><CodeLine lineNumber="1097"><span class="doxyHighlight">          <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.dump();</span></CodeLine>
<Link id="l01098" /><CodeLine lineNumber="1098"><span class="doxyHighlight">        &#125;);</span></CodeLine>
<Link id="l01099" /><CodeLine lineNumber="1099"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a7f2a3d4dcfee70225988aec53ff1e173">report&#95;fatal&#95;error</a>(</span><span class="doxyHighlightStringLiteral">&quot;Cannot harden a conditional entry to a target of &quot;</span></CodeLine>
<Link id="l01100" /><CodeLine lineNumber="1100"><span class="doxyHighlight">                           </span><span class="doxyHighlightStringLiteral">&quot;an indirect branch!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01101" /><CodeLine lineNumber="1101"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01102" /><CodeLine lineNumber="1102"></CodeLine>
<Link id="l01103" /><CodeLine lineNumber="1103"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Now we need to compute the address of this block and install it as a</span></CodeLine>
<Link id="l01104" /><CodeLine lineNumber="1104"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// synthetic target in the predecessor. We do this at the bottom of the</span></CodeLine>
<Link id="l01105" /><CodeLine lineNumber="1105"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// predecessor.</span></CodeLine>
<Link id="l01106" /><CodeLine lineNumber="1106"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> InsertPt = Pred-&gt;getFirstTerminator();</span></CodeLine>
<Link id="l01107" /><CodeLine lineNumber="1107"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/register">Register</a> TargetReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(&amp;X86::GR64RegClass);</span></CodeLine>
<Link id="l01108" /><CodeLine lineNumber="1108"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (MF.getTarget().getCodeModel() == <a href="/docs/api/namespaces/llvm/codemodel/#afc59396a9e5809fc92938e203d91a8dfaa2554ef60dc191c6005ba9eecbc9aea0">CodeModel::Small</a> &amp;&amp;</span></CodeLine>
<Link id="l01109" /><CodeLine lineNumber="1109"><span class="doxyHighlight">          !Subtarget-&gt;isPositionIndependent()) &#123;</span></CodeLine>
<Link id="l01110" /><CodeLine lineNumber="1110"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Directly materialize it into an immediate.</span></CodeLine>
<Link id="l01111" /><CodeLine lineNumber="1111"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> AddrI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(&#42;Pred, InsertPt, <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a>(),</span></CodeLine>
<Link id="l01112" /><CodeLine lineNumber="1112"><span class="doxyHighlight">                             <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::MOV64ri32), TargetReg)</span></CodeLine>
<Link id="l01113" /><CodeLine lineNumber="1113"><span class="doxyHighlight">                         .<a href="/docs/api/classes/llvm/machineinstrbuilder/#abf1febf2a98f588146548a3a485d3838">addMBB</a>(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</span></CodeLine>
<Link id="l01114" /><CodeLine lineNumber="1114"><span class="doxyHighlight">        ++NumInstsInserted;</span></CodeLine>
<Link id="l01115" /><CodeLine lineNumber="1115"><span class="doxyHighlight">        (void)AddrI;</span></CodeLine>
<Link id="l01116" /><CodeLine lineNumber="1116"><span class="doxyHighlight">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Inserting mov: &quot;</span><span class="doxyHighlight">; AddrI-&gt;dump();</span></CodeLine>
<Link id="l01117" /><CodeLine lineNumber="1117"><span class="doxyHighlight">                   <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01118" /><CodeLine lineNumber="1118"><span class="doxyHighlight">      &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l01119" /><CodeLine lineNumber="1119"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> AddrI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(&#42;Pred, InsertPt, <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a>(), <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::LEA64r),</span></CodeLine>
<Link id="l01120" /><CodeLine lineNumber="1120"><span class="doxyHighlight">                             TargetReg)</span></CodeLine>
<Link id="l01121" /><CodeLine lineNumber="1121"><span class="doxyHighlight">                         .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</span><span class="doxyHighlightComment">/&#42;Base&#42;/</span><span class="doxyHighlight"> X86::RIP)</span></CodeLine>
<Link id="l01122" /><CodeLine lineNumber="1122"><span class="doxyHighlight">                         .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(</span><span class="doxyHighlightComment">/&#42;Scale&#42;/</span><span class="doxyHighlight"> 1)</span></CodeLine>
<Link id="l01123" /><CodeLine lineNumber="1123"><span class="doxyHighlight">                         .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</span><span class="doxyHighlightComment">/&#42;Index&#42;/</span><span class="doxyHighlight"> 0)</span></CodeLine>
<Link id="l01124" /><CodeLine lineNumber="1124"><span class="doxyHighlight">                         .<a href="/docs/api/classes/llvm/machineinstrbuilder/#abf1febf2a98f588146548a3a485d3838">addMBB</a>(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>)</span></CodeLine>
<Link id="l01125" /><CodeLine lineNumber="1125"><span class="doxyHighlight">                         .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</span><span class="doxyHighlightComment">/&#42;Segment&#42;/</span><span class="doxyHighlight"> 0);</span></CodeLine>
<Link id="l01126" /><CodeLine lineNumber="1126"><span class="doxyHighlight">        ++NumInstsInserted;</span></CodeLine>
<Link id="l01127" /><CodeLine lineNumber="1127"><span class="doxyHighlight">        (void)AddrI;</span></CodeLine>
<Link id="l01128" /><CodeLine lineNumber="1128"><span class="doxyHighlight">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Inserting lea: &quot;</span><span class="doxyHighlight">; AddrI-&gt;dump();</span></CodeLine>
<Link id="l01129" /><CodeLine lineNumber="1129"><span class="doxyHighlight">                   <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01130" /><CodeLine lineNumber="1130"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01131" /><CodeLine lineNumber="1131"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// And make this available.</span></CodeLine>
<Link id="l01132" /><CodeLine lineNumber="1132"><span class="doxyHighlight">      TargetAddrSSA.AddAvailableValue(Pred, TargetReg);</span></CodeLine>
<Link id="l01133" /><CodeLine lineNumber="1133"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01134" /><CodeLine lineNumber="1134"></CodeLine>
<Link id="l01135" /><CodeLine lineNumber="1135"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Materialize the needed SSA value of the target. Note that we need the</span></CodeLine>
<Link id="l01136" /><CodeLine lineNumber="1136"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// middle of the block as this block might at the bottom have an indirect</span></CodeLine>
<Link id="l01137" /><CodeLine lineNumber="1137"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// branch back to itself. We can do this here because at this point, every</span></CodeLine>
<Link id="l01138" /><CodeLine lineNumber="1138"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// predecessor of this block has an available value. This is basically just</span></CodeLine>
<Link id="l01139" /><CodeLine lineNumber="1139"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// automating the construction of a PHI node for this target.</span></CodeLine>
<Link id="l01140" /><CodeLine lineNumber="1140"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/register">Register</a> TargetReg = TargetAddrSSA.GetValueInMiddleOfBlock(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</span></CodeLine>
<Link id="l01141" /><CodeLine lineNumber="1141"></CodeLine>
<Link id="l01142" /><CodeLine lineNumber="1142"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Insert a comparison of the incoming target register with this block&#39;s</span></CodeLine>
<Link id="l01143" /><CodeLine lineNumber="1143"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// address. This also requires us to mark the block as having its address</span></CodeLine>
<Link id="l01144" /><CodeLine lineNumber="1144"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// taken explicitly.</span></CodeLine>
<Link id="l01145" /><CodeLine lineNumber="1145"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.setMachineBlockAddressTaken();</span></CodeLine>
<Link id="l01146" /><CodeLine lineNumber="1146"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> InsertPt = <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.SkipPHIsLabelsAndDebug(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.begin());</span></CodeLine>
<Link id="l01147" /><CodeLine lineNumber="1147"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (MF.getTarget().getCodeModel() == <a href="/docs/api/namespaces/llvm/codemodel/#afc59396a9e5809fc92938e203d91a8dfaa2554ef60dc191c6005ba9eecbc9aea0">CodeModel::Small</a> &amp;&amp;</span></CodeLine>
<Link id="l01148" /><CodeLine lineNumber="1148"><span class="doxyHighlight">        !Subtarget-&gt;isPositionIndependent()) &#123;</span></CodeLine>
<Link id="l01149" /><CodeLine lineNumber="1149"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Check directly against a relocated immediate when we can.</span></CodeLine>
<Link id="l01150" /><CodeLine lineNumber="1150"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> CheckI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a>(), <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::CMP64ri32))</span></CodeLine>
<Link id="l01151" /><CodeLine lineNumber="1151"><span class="doxyHighlight">                        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(TargetReg, <a href="/docs/api/namespaces/llvm/regstate/#ade26fe5c9b3fe6948def36f7ca12dfc5a9ddde91ef09476d28a088fe57f8e2921">RegState::Kill</a>)</span></CodeLine>
<Link id="l01152" /><CodeLine lineNumber="1152"><span class="doxyHighlight">                        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#abf1febf2a98f588146548a3a485d3838">addMBB</a>(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</span></CodeLine>
<Link id="l01153" /><CodeLine lineNumber="1153"><span class="doxyHighlight">      ++NumInstsInserted;</span></CodeLine>
<Link id="l01154" /><CodeLine lineNumber="1154"><span class="doxyHighlight">      (void)CheckI;</span></CodeLine>
<Link id="l01155" /><CodeLine lineNumber="1155"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Inserting cmp: &quot;</span><span class="doxyHighlight">; CheckI-&gt;dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01156" /><CodeLine lineNumber="1156"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l01157" /><CodeLine lineNumber="1157"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Otherwise compute the address into a register first.</span></CodeLine>
<Link id="l01158" /><CodeLine lineNumber="1158"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/register">Register</a> AddrReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(&amp;X86::GR64RegClass);</span></CodeLine>
<Link id="l01159" /><CodeLine lineNumber="1159"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> AddrI =</span></CodeLine>
<Link id="l01160" /><CodeLine lineNumber="1160"><span class="doxyHighlight">          <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a>(), <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::LEA64r), AddrReg)</span></CodeLine>
<Link id="l01161" /><CodeLine lineNumber="1161"><span class="doxyHighlight">              .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</span><span class="doxyHighlightComment">/&#42;Base&#42;/</span><span class="doxyHighlight"> X86::RIP)</span></CodeLine>
<Link id="l01162" /><CodeLine lineNumber="1162"><span class="doxyHighlight">              .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(</span><span class="doxyHighlightComment">/&#42;Scale&#42;/</span><span class="doxyHighlight"> 1)</span></CodeLine>
<Link id="l01163" /><CodeLine lineNumber="1163"><span class="doxyHighlight">              .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</span><span class="doxyHighlightComment">/&#42;Index&#42;/</span><span class="doxyHighlight"> 0)</span></CodeLine>
<Link id="l01164" /><CodeLine lineNumber="1164"><span class="doxyHighlight">              .<a href="/docs/api/classes/llvm/machineinstrbuilder/#abf1febf2a98f588146548a3a485d3838">addMBB</a>(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>)</span></CodeLine>
<Link id="l01165" /><CodeLine lineNumber="1165"><span class="doxyHighlight">              .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</span><span class="doxyHighlightComment">/&#42;Segment&#42;/</span><span class="doxyHighlight"> 0);</span></CodeLine>
<Link id="l01166" /><CodeLine lineNumber="1166"><span class="doxyHighlight">      ++NumInstsInserted;</span></CodeLine>
<Link id="l01167" /><CodeLine lineNumber="1167"><span class="doxyHighlight">      (void)AddrI;</span></CodeLine>
<Link id="l01168" /><CodeLine lineNumber="1168"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Inserting lea: &quot;</span><span class="doxyHighlight">; AddrI-&gt;dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01169" /><CodeLine lineNumber="1169"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> CheckI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a>(), <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::CMP64rr))</span></CodeLine>
<Link id="l01170" /><CodeLine lineNumber="1170"><span class="doxyHighlight">                        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(TargetReg, <a href="/docs/api/namespaces/llvm/regstate/#ade26fe5c9b3fe6948def36f7ca12dfc5a9ddde91ef09476d28a088fe57f8e2921">RegState::Kill</a>)</span></CodeLine>
<Link id="l01171" /><CodeLine lineNumber="1171"><span class="doxyHighlight">                        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(AddrReg, <a href="/docs/api/namespaces/llvm/regstate/#ade26fe5c9b3fe6948def36f7ca12dfc5a9ddde91ef09476d28a088fe57f8e2921">RegState::Kill</a>);</span></CodeLine>
<Link id="l01172" /><CodeLine lineNumber="1172"><span class="doxyHighlight">      ++NumInstsInserted;</span></CodeLine>
<Link id="l01173" /><CodeLine lineNumber="1173"><span class="doxyHighlight">      (void)CheckI;</span></CodeLine>
<Link id="l01174" /><CodeLine lineNumber="1174"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Inserting cmp: &quot;</span><span class="doxyHighlight">; CheckI-&gt;dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01175" /><CodeLine lineNumber="1175"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01176" /><CodeLine lineNumber="1176"></CodeLine>
<Link id="l01177" /><CodeLine lineNumber="1177"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Now cmov over the predicate if the comparison wasn&#39;t equal.</span></CodeLine>
<Link id="l01178" /><CodeLine lineNumber="1178"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> PredStateSizeInBytes = <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>-&gt;getRegSizeInBits(&#42;PS-&gt;RC) / 8;</span></CodeLine>
<Link id="l01179" /><CodeLine lineNumber="1179"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> CMovOp = <a href="/docs/api/namespaces/llvm/x86/#af569f4e4b0acf498c83fa0e58e2eb364">X86::getCMovOpcode</a>(PredStateSizeInBytes);</span></CodeLine>
<Link id="l01180" /><CodeLine lineNumber="1180"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/register">Register</a> UpdatedStateReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(PS-&gt;RC);</span></CodeLine>
<Link id="l01181" /><CodeLine lineNumber="1181"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> CMovI =</span></CodeLine>
<Link id="l01182" /><CodeLine lineNumber="1182"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/dwarf-linker/#a463a58e257d5f6fb2c39eb9a2474fc24ac2e06fc138163b7095fa483616a0a47a">DebugLoc</a>(), <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(CMovOp), UpdatedStateReg)</span></CodeLine>
<Link id="l01183" /><CodeLine lineNumber="1183"><span class="doxyHighlight">            .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(PS-&gt;InitialReg)</span></CodeLine>
<Link id="l01184" /><CodeLine lineNumber="1184"><span class="doxyHighlight">            .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(PS-&gt;PoisonReg)</span></CodeLine>
<Link id="l01185" /><CodeLine lineNumber="1185"><span class="doxyHighlight">            .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(<a href="/docs/api/namespaces/llvm/x86/#a1a356a51a1fb4cc3c427599082cf1d2eacb2f86eaebe8b719f743d17a2d5a5f3d">X86::COND&#95;NE</a>);</span></CodeLine>
<Link id="l01186" /><CodeLine lineNumber="1186"><span class="doxyHighlight">    CMovI-&gt;<a href="/docs/api/classes/llvm/machineinstr/#ab692b90c6e0e9b450f407896cbbe4b02">findRegisterUseOperand</a>(X86::EFLAGS, </span><span class="doxyHighlightComment">/&#42;TRI=&#42;/</span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l01187" /><CodeLine lineNumber="1187"><span class="doxyHighlight">        -&gt;<a href="/docs/api/classes/llvm/machineoperand/#a8a82683fccdef8a5ef772ef03277aee7">setIsKill</a>(</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01188" /><CodeLine lineNumber="1188"><span class="doxyHighlight">    ++NumInstsInserted;</span></CodeLine>
<Link id="l01189" /><CodeLine lineNumber="1189"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Inserting cmov: &quot;</span><span class="doxyHighlight">; CMovI-&gt;dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01190" /><CodeLine lineNumber="1190"><span class="doxyHighlight">    CMovs.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&amp;&#42;CMovI);</span></CodeLine>
<Link id="l01191" /><CodeLine lineNumber="1191"></CodeLine>
<Link id="l01192" /><CodeLine lineNumber="1192"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// And put the new value into the available values for SSA form of our</span></CodeLine>
<Link id="l01193" /><CodeLine lineNumber="1193"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// predicate state.</span></CodeLine>
<Link id="l01194" /><CodeLine lineNumber="1194"><span class="doxyHighlight">    PS-&gt;SSA.AddAvailableValue(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, UpdatedStateReg);</span></CodeLine>
<Link id="l01195" /><CodeLine lineNumber="1195"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01196" /><CodeLine lineNumber="1196"></CodeLine>
<Link id="l01197" /><CodeLine lineNumber="1197"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Return all the newly inserted cmov instructions of the predicate state.</span></CodeLine>
<Link id="l01198" /><CodeLine lineNumber="1198"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> CMovs;</span></CodeLine>
<Link id="l01199" /><CodeLine lineNumber="1199"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01200" /><CodeLine lineNumber="1200"></CodeLine>
<Link id="l01201" /><CodeLine lineNumber="1201"><span class="doxyHighlightComment">// Returns true if the MI has EFLAGS as a register def operand and it&#39;s live,</span></CodeLine>
<Link id="l01202" /><CodeLine lineNumber="1202"><span class="doxyHighlightComment">// otherwise it returns false</span></CodeLine>
<Link id="l01203" /><CodeLine lineNumber="1203" lineLink="#ac0e27a6dfaf334669f95954dee3d5920"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#ac0e27a6dfaf334669f95954dee3d5920">isEFLAGSDefLive</a>(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) &#123;</span></CodeLine>
<Link id="l01204" /><CodeLine lineNumber="1204"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &#42;DefOp =</span></CodeLine>
<Link id="l01205" /><CodeLine lineNumber="1205"><span class="doxyHighlight">          <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.findRegisterDefOperand(X86::EFLAGS, </span><span class="doxyHighlightComment">/&#42;TRI=&#42;/</span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">)) &#123;</span></CodeLine>
<Link id="l01206" /><CodeLine lineNumber="1206"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> !DefOp-&gt;isDead();</span></CodeLine>
<Link id="l01207" /><CodeLine lineNumber="1207"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01208" /><CodeLine lineNumber="1208"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01209" /><CodeLine lineNumber="1209"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01210" /><CodeLine lineNumber="1210"></CodeLine>
<Link id="l01211" /><CodeLine lineNumber="1211" lineLink="#a93f8e5dacbcd949d688c3af5f491468d"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#a93f8e5dacbcd949d688c3af5f491468d">isEFLAGSLive</a>(<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>,</span></CodeLine>
<Link id="l01212" /><CodeLine lineNumber="1212"><span class="doxyHighlight">                         </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/targetregisterinfo">TargetRegisterInfo</a> &amp;<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>) &#123;</span></CodeLine>
<Link id="l01213" /><CodeLine lineNumber="1213"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Check if EFLAGS are alive by seeing if there is a def of them or they</span></CodeLine>
<Link id="l01214" /><CodeLine lineNumber="1214"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// live-in, and then seeing if that def is in turn used.</span></CodeLine>
<Link id="l01215" /><CodeLine lineNumber="1215"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> : <a href="/docs/api/namespaces/llvm/#a6b0ac1fa4f05de76413c5e0ca6334035">llvm::reverse</a>(<a href="/docs/api/namespaces/llvm/#a341215803e83773a3e97860dc291f121">llvm::make&#95;range</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.begin(), <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))) &#123;</span></CodeLine>
<Link id="l01216" /><CodeLine lineNumber="1216"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &#42;DefOp =</span></CodeLine>
<Link id="l01217" /><CodeLine lineNumber="1217"><span class="doxyHighlight">            <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.findRegisterDefOperand(X86::EFLAGS, </span><span class="doxyHighlightComment">/&#42;TRI=&#42;/</span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">)) &#123;</span></CodeLine>
<Link id="l01218" /><CodeLine lineNumber="1218"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If the def is dead, then EFLAGS is not live.</span></CodeLine>
<Link id="l01219" /><CodeLine lineNumber="1219"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (DefOp-&gt;isDead())</span></CodeLine>
<Link id="l01220" /><CodeLine lineNumber="1220"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01221" /><CodeLine lineNumber="1221"></CodeLine>
<Link id="l01222" /><CodeLine lineNumber="1222"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Otherwise we&#39;ve def&#39;ed it, and it is live.</span></CodeLine>
<Link id="l01223" /><CodeLine lineNumber="1223"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01224" /><CodeLine lineNumber="1224"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01225" /><CodeLine lineNumber="1225"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// While at this instruction, also check if we use and kill EFLAGS</span></CodeLine>
<Link id="l01226" /><CodeLine lineNumber="1226"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// which means it isn&#39;t live.</span></CodeLine>
<Link id="l01227" /><CodeLine lineNumber="1227"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.killsRegister(X86::EFLAGS, &amp;<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>))</span></CodeLine>
<Link id="l01228" /><CodeLine lineNumber="1228"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01229" /><CodeLine lineNumber="1229"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01230" /><CodeLine lineNumber="1230"></CodeLine>
<Link id="l01231" /><CodeLine lineNumber="1231"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we didn&#39;t find anything conclusive (neither definitely alive or</span></CodeLine>
<Link id="l01232" /><CodeLine lineNumber="1232"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// definitely dead) return whether it lives into the block.</span></CodeLine>
<Link id="l01233" /><CodeLine lineNumber="1233"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.isLiveIn(X86::EFLAGS);</span></CodeLine>
<Link id="l01234" /><CodeLine lineNumber="1234"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01235" /><CodeLine lineNumber="1235"></CodeLine>
<Link id="l01236" /><CodeLine lineNumber="1236"><span class="doxyHighlightComment">/// Trace the predicate state through each of the blocks in the function,</span></CodeLine>
<Link id="l01237" /><CodeLine lineNumber="1237"><span class="doxyHighlightComment">/// hardening everything necessary along the way.</span></CodeLine>
<Link id="l01238" /><CodeLine lineNumber="1238"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01239" /><CodeLine lineNumber="1239"><span class="doxyHighlightComment">/// We call this routine once the initial predicate state has been established</span></CodeLine>
<Link id="l01240" /><CodeLine lineNumber="1240"><span class="doxyHighlightComment">/// for each basic block in the function in the SSA updater. This routine traces</span></CodeLine>
<Link id="l01241" /><CodeLine lineNumber="1241"><span class="doxyHighlightComment">/// it through the instructions within each basic block, and for non-returning</span></CodeLine>
<Link id="l01242" /><CodeLine lineNumber="1242"><span class="doxyHighlightComment">/// blocks informs the SSA updater about the final state that lives out of the</span></CodeLine>
<Link id="l01243" /><CodeLine lineNumber="1243"><span class="doxyHighlightComment">/// block. Along the way, it hardens any vulnerable instruction using the</span></CodeLine>
<Link id="l01244" /><CodeLine lineNumber="1244"><span class="doxyHighlightComment">/// currently valid predicate state. We have to do these two things together</span></CodeLine>
<Link id="l01245" /><CodeLine lineNumber="1245"><span class="doxyHighlightComment">/// because the SSA updater only works across blocks. Within a block, we track</span></CodeLine>
<Link id="l01246" /><CodeLine lineNumber="1246"><span class="doxyHighlightComment">/// the current predicate state directly and update it as it changes.</span></CodeLine>
<Link id="l01247" /><CodeLine lineNumber="1247"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01248" /><CodeLine lineNumber="1248"><span class="doxyHighlightComment">/// This operates in two passes over each block. First, we analyze the loads in</span></CodeLine>
<Link id="l01249" /><CodeLine lineNumber="1249"><span class="doxyHighlightComment">/// the block to determine which strategy will be used to harden them: hardening</span></CodeLine>
<Link id="l01250" /><CodeLine lineNumber="1250"><span class="doxyHighlightComment">/// the address or hardening the loaded value when loaded into a register</span></CodeLine>
<Link id="l01251" /><CodeLine lineNumber="1251"><span class="doxyHighlightComment">/// amenable to hardening. We have to process these first because the two</span></CodeLine>
<Link id="l01252" /><CodeLine lineNumber="1252"><span class="doxyHighlightComment">/// strategies may interact -- later hardening may change what strategy we wish</span></CodeLine>
<Link id="l01253" /><CodeLine lineNumber="1253"><span class="doxyHighlightComment">/// to use. We also will analyze data dependencies between loads and avoid</span></CodeLine>
<Link id="l01254" /><CodeLine lineNumber="1254"><span class="doxyHighlightComment">/// hardening those loads that are data dependent on a load with a hardened</span></CodeLine>
<Link id="l01255" /><CodeLine lineNumber="1255"><span class="doxyHighlightComment">/// address. We also skip hardening loads already behind an LFENCE as that is</span></CodeLine>
<Link id="l01256" /><CodeLine lineNumber="1256"><span class="doxyHighlightComment">/// sufficient to harden them against misspeculation.</span></CodeLine>
<Link id="l01257" /><CodeLine lineNumber="1257"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01258" /><CodeLine lineNumber="1258"><span class="doxyHighlightComment">/// Second, we actively trace the predicate state through the block, applying</span></CodeLine>
<Link id="l01259" /><CodeLine lineNumber="1259"><span class="doxyHighlightComment">/// the hardening steps we determined necessary in the first pass as we go.</span></CodeLine>
<Link id="l01260" /><CodeLine lineNumber="1260"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01261" /><CodeLine lineNumber="1261"><span class="doxyHighlightComment">/// These two passes are applied to each basic block. We operate one block at a</span></CodeLine>
<Link id="l01262" /><CodeLine lineNumber="1262"><span class="doxyHighlightComment">/// time to simplify reasoning about reachability and sequencing.</span></CodeLine>
<Link id="l01263" /><CodeLine lineNumber="1263"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> X86SpeculativeLoadHardeningPass::tracePredStateThroughBlocksAndHarden(</span></CodeLine>
<Link id="l01264" /><CodeLine lineNumber="1264"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF) &#123;</span></CodeLine>
<Link id="l01265" /><CodeLine lineNumber="1265"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;MachineInstr &#42;, 16&gt;</a> HardenPostLoad;</span></CodeLine>
<Link id="l01266" /><CodeLine lineNumber="1266"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;MachineInstr &#42;, 16&gt;</a> HardenLoadAddr;</span></CodeLine>
<Link id="l01267" /><CodeLine lineNumber="1267"></CodeLine>
<Link id="l01268" /><CodeLine lineNumber="1268"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallset">SmallSet&lt;unsigned, 16&gt;</a> HardenedAddrRegs;</span></CodeLine>
<Link id="l01269" /><CodeLine lineNumber="1269"></CodeLine>
<Link id="l01270" /><CodeLine lineNumber="1270"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;unsigned, unsigned, 32&gt;</a> AddrRegToHardenedReg;</span></CodeLine>
<Link id="l01271" /><CodeLine lineNumber="1271"></CodeLine>
<Link id="l01272" /><CodeLine lineNumber="1272"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Track the set of load-dependent registers through the basic block. Because</span></CodeLine>
<Link id="l01273" /><CodeLine lineNumber="1273"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the values of these registers have an existing data dependency on a loaded</span></CodeLine>
<Link id="l01274" /><CodeLine lineNumber="1274"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// value which we would have checked, we can omit any checks on them.</span></CodeLine>
<Link id="l01275" /><CodeLine lineNumber="1275"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/sparsebitvector">SparseBitVector&lt;&gt;</a> LoadDepRegs;</span></CodeLine>
<Link id="l01276" /><CodeLine lineNumber="1276"></CodeLine>
<Link id="l01277" /><CodeLine lineNumber="1277"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> : MF) &#123;</span></CodeLine>
<Link id="l01278" /><CodeLine lineNumber="1278"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// The first pass over the block: collect all the loads which can have their</span></CodeLine>
<Link id="l01279" /><CodeLine lineNumber="1279"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// loaded value hardened and all the loads that instead need their address</span></CodeLine>
<Link id="l01280" /><CodeLine lineNumber="1280"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// hardened. During this walk we propagate load dependence for address</span></CodeLine>
<Link id="l01281" /><CodeLine lineNumber="1281"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// hardened loads and also look for LFENCE to stop hardening wherever</span></CodeLine>
<Link id="l01282" /><CodeLine lineNumber="1282"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// possible. When deciding whether or not to harden the loaded value or not,</span></CodeLine>
<Link id="l01283" /><CodeLine lineNumber="1283"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// we check to see if any registers used in the address will have been</span></CodeLine>
<Link id="l01284" /><CodeLine lineNumber="1284"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// hardened at this point and if so, harden any remaining address registers</span></CodeLine>
<Link id="l01285" /><CodeLine lineNumber="1285"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// as that often successfully re-uses hardened addresses and minimizes</span></CodeLine>
<Link id="l01286" /><CodeLine lineNumber="1286"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// instructions.</span></CodeLine>
<Link id="l01287" /><CodeLine lineNumber="1287"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01288" /><CodeLine lineNumber="1288"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// FIXME: We should consider an aggressive mode where we continue to keep as</span></CodeLine>
<Link id="l01289" /><CodeLine lineNumber="1289"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// many loads value hardened even when some address register hardening would</span></CodeLine>
<Link id="l01290" /><CodeLine lineNumber="1290"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// be free (due to reuse).</span></CodeLine>
<Link id="l01291" /><CodeLine lineNumber="1291"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01292" /><CodeLine lineNumber="1292"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Note that we only need this pass if we are actually hardening loads.</span></CodeLine>
<Link id="l01293" /><CodeLine lineNumber="1293"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64speculationhardening-cpp/#afd315bab7ff3b1adb2920b69ec1adcae">HardenLoads</a>)</span></CodeLine>
<Link id="l01294" /><CodeLine lineNumber="1294"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> : <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>) &#123;</span></CodeLine>
<Link id="l01295" /><CodeLine lineNumber="1295"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// We naively assume that all def&#39;ed registers of an instruction have</span></CodeLine>
<Link id="l01296" /><CodeLine lineNumber="1296"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// a data dependency on all of their operands.</span></CodeLine>
<Link id="l01297" /><CodeLine lineNumber="1297"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// FIXME: Do a more careful analysis of x86 to build a conservative</span></CodeLine>
<Link id="l01298" /><CodeLine lineNumber="1298"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// model here.</span></CodeLine>
<Link id="l01299" /><CodeLine lineNumber="1299"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a61d13d6824ec46c31260a4fd0997eda0">llvm::any&#95;of</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.uses(), &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>) &#123;</span></CodeLine>
<Link id="l01300" /><CodeLine lineNumber="1300"><span class="doxyHighlight">              return Op.isReg() &amp;&amp; LoadDepRegs.test(Op.getReg());</span></CodeLine>
<Link id="l01301" /><CodeLine lineNumber="1301"><span class="doxyHighlight">            &#125;))</span></CodeLine>
<Link id="l01302" /><CodeLine lineNumber="1302"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;Def : <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.defs())</span></CodeLine>
<Link id="l01303" /><CodeLine lineNumber="1303"><span class="doxyHighlight">            </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/rdf/#a10793004faece2bb74d3363b5f6ce96f">Def</a>.isReg())</span></CodeLine>
<Link id="l01304" /><CodeLine lineNumber="1304"><span class="doxyHighlight">              LoadDepRegs.<a href="/docs/api/classes/llvm/sparsebitvector/#a613c1e44c4e88e9a1e0be386cb5fa828">set</a>(<a href="/docs/api/namespaces/llvm/rdf/#a10793004faece2bb74d3363b5f6ce96f">Def</a>.getReg());</span></CodeLine>
<Link id="l01305" /><CodeLine lineNumber="1305"></CodeLine>
<Link id="l01306" /><CodeLine lineNumber="1306"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Both Intel and AMD are guiding that they will change the semantics of</span></CodeLine>
<Link id="l01307" /><CodeLine lineNumber="1307"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// LFENCE to be a speculation barrier, so if we see an LFENCE, there is</span></CodeLine>
<Link id="l01308" /><CodeLine lineNumber="1308"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// no more need to guard things in this block.</span></CodeLine>
<Link id="l01309" /><CodeLine lineNumber="1309"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOpcode() == X86::LFENCE)</span></CodeLine>
<Link id="l01310" /><CodeLine lineNumber="1310"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01311" /><CodeLine lineNumber="1311"></CodeLine>
<Link id="l01312" /><CodeLine lineNumber="1312"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// If this instruction cannot load, nothing to do.</span></CodeLine>
<Link id="l01313" /><CodeLine lineNumber="1313"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.mayLoad())</span></CodeLine>
<Link id="l01314" /><CodeLine lineNumber="1314"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01315" /><CodeLine lineNumber="1315"></CodeLine>
<Link id="l01316" /><CodeLine lineNumber="1316"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Some instructions which &quot;load&quot; are trivially safe or unimportant.</span></CodeLine>
<Link id="l01317" /><CodeLine lineNumber="1317"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOpcode() == X86::MFENCE)</span></CodeLine>
<Link id="l01318" /><CodeLine lineNumber="1318"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01319" /><CodeLine lineNumber="1319"></CodeLine>
<Link id="l01320" /><CodeLine lineNumber="1320"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Extract the memory operand information about this instruction.</span></CodeLine>
<Link id="l01321" /><CodeLine lineNumber="1321"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> MemRefBeginIdx = <a href="/docs/api/namespaces/llvm/x86/#a279395a00a782f7e3d6141bc3328a249">X86::getFirstAddrOperandIdx</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</span></CodeLine>
<Link id="l01322" /><CodeLine lineNumber="1322"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (MemRefBeginIdx &lt; 0) &#123;</span></CodeLine>
<Link id="l01323" /><CodeLine lineNumber="1323"><span class="doxyHighlight">          <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>()</span></CodeLine>
<Link id="l01324" /><CodeLine lineNumber="1324"><span class="doxyHighlight">                         &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;WARNING: unable to harden loading instruction: &quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01325" /><CodeLine lineNumber="1325"><span class="doxyHighlight">                     <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.dump());</span></CodeLine>
<Link id="l01326" /><CodeLine lineNumber="1326"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01327" /><CodeLine lineNumber="1327"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l01328" /><CodeLine lineNumber="1328"></CodeLine>
<Link id="l01329" /><CodeLine lineNumber="1329"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;BaseMO =</span></CodeLine>
<Link id="l01330" /><CodeLine lineNumber="1330"><span class="doxyHighlight">            <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(MemRefBeginIdx + <a href="/docs/api/namespaces/llvm/x86/#a2a5aec578e2e391e99e1705012752d84a319f0e99a1ac9396659683d2638d4f45">X86::AddrBaseReg</a>);</span></CodeLine>
<Link id="l01331" /><CodeLine lineNumber="1331"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;IndexMO =</span></CodeLine>
<Link id="l01332" /><CodeLine lineNumber="1332"><span class="doxyHighlight">            <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(MemRefBeginIdx + <a href="/docs/api/namespaces/llvm/x86/#a2a5aec578e2e391e99e1705012752d84aba7ebe0e28a2c1c4c14343f549c01462">X86::AddrIndexReg</a>);</span></CodeLine>
<Link id="l01333" /><CodeLine lineNumber="1333"></CodeLine>
<Link id="l01334" /><CodeLine lineNumber="1334"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// If we have at least one (non-frame-index, non-RIP) register operand,</span></CodeLine>
<Link id="l01335" /><CodeLine lineNumber="1335"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// and neither operand is load-dependent, we need to check the load.</span></CodeLine>
<Link id="l01336" /><CodeLine lineNumber="1336"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> BaseReg = 0, IndexReg = 0;</span></CodeLine>
<Link id="l01337" /><CodeLine lineNumber="1337"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#ad7213433bd60dc33020246384dc18b9b">isFI</a>() &amp;&amp; BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() != X86::RIP &amp;&amp;</span></CodeLine>
<Link id="l01338" /><CodeLine lineNumber="1338"><span class="doxyHighlight">            BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() != X86::NoRegister)</span></CodeLine>
<Link id="l01339" /><CodeLine lineNumber="1339"><span class="doxyHighlight">          BaseReg = BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>();</span></CodeLine>
<Link id="l01340" /><CodeLine lineNumber="1340"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IndexMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() != X86::NoRegister)</span></CodeLine>
<Link id="l01341" /><CodeLine lineNumber="1341"><span class="doxyHighlight">          IndexReg = IndexMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>();</span></CodeLine>
<Link id="l01342" /><CodeLine lineNumber="1342"></CodeLine>
<Link id="l01343" /><CodeLine lineNumber="1343"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!BaseReg &amp;&amp; !IndexReg)</span></CodeLine>
<Link id="l01344" /><CodeLine lineNumber="1344"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// No register operands!</span></CodeLine>
<Link id="l01345" /><CodeLine lineNumber="1345"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01346" /><CodeLine lineNumber="1346"></CodeLine>
<Link id="l01347" /><CodeLine lineNumber="1347"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// If any register operand is dependent, this load is dependent and we</span></CodeLine>
<Link id="l01348" /><CodeLine lineNumber="1348"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// needn&#39;t check it.</span></CodeLine>
<Link id="l01349" /><CodeLine lineNumber="1349"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// FIXME: Is this true in the case where we are hardening loads after</span></CodeLine>
<Link id="l01350" /><CodeLine lineNumber="1350"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// they complete? Unclear, need to investigate.</span></CodeLine>
<Link id="l01351" /><CodeLine lineNumber="1351"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> ((BaseReg &amp;&amp; LoadDepRegs.<a href="/docs/api/classes/llvm/sparsebitvector/#aaa2827e67554a0b81f693dc61a3a40b5">test</a>(BaseReg)) ||</span></CodeLine>
<Link id="l01352" /><CodeLine lineNumber="1352"><span class="doxyHighlight">            (IndexReg &amp;&amp; LoadDepRegs.<a href="/docs/api/classes/llvm/sparsebitvector/#aaa2827e67554a0b81f693dc61a3a40b5">test</a>(IndexReg)))</span></CodeLine>
<Link id="l01353" /><CodeLine lineNumber="1353"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01354" /><CodeLine lineNumber="1354"></CodeLine>
<Link id="l01355" /><CodeLine lineNumber="1355"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// If post-load hardening is enabled, this load is compatible with</span></CodeLine>
<Link id="l01356" /><CodeLine lineNumber="1356"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// post-load hardening, and we aren&#39;t already going to harden one of the</span></CodeLine>
<Link id="l01357" /><CodeLine lineNumber="1357"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// address registers, queue it up to be hardened post-load. Notably,</span></CodeLine>
<Link id="l01358" /><CodeLine lineNumber="1358"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// even once hardened this won&#39;t introduce a useful dependency that</span></CodeLine>
<Link id="l01359" /><CodeLine lineNumber="1359"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// could prune out subsequent loads.</span></CodeLine>
<Link id="l01360" /><CodeLine lineNumber="1360"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a7385b8089f422279adefa5007ef35dc6">EnablePostLoadHardening</a> &amp;&amp; <a href="/docs/api/classes/llvm/x86instrinfo/#a34662990aab5992b0b1ee00a4dd4ad34">X86InstrInfo::isDataInvariantLoad</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) &amp;&amp;</span></CodeLine>
<Link id="l01361" /><CodeLine lineNumber="1361"><span class="doxyHighlight">            !<a href="#ac0e27a6dfaf334669f95954dee3d5920">isEFLAGSDefLive</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) &amp;&amp; <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getDesc().getNumDefs() == 1 &amp;&amp;</span></CodeLine>
<Link id="l01362" /><CodeLine lineNumber="1362"><span class="doxyHighlight">            <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(0).isReg() &amp;&amp;</span></CodeLine>
<Link id="l01363" /><CodeLine lineNumber="1363"><span class="doxyHighlight">            canHardenRegister(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(0).getReg()) &amp;&amp;</span></CodeLine>
<Link id="l01364" /><CodeLine lineNumber="1364"><span class="doxyHighlight">            !HardenedAddrRegs.<a href="/docs/api/classes/llvm/smallset/#a2a98f19750ba941ce791b75ca6d77e48">count</a>(BaseReg) &amp;&amp;</span></CodeLine>
<Link id="l01365" /><CodeLine lineNumber="1365"><span class="doxyHighlight">            !HardenedAddrRegs.<a href="/docs/api/classes/llvm/smallset/#a2a98f19750ba941ce791b75ca6d77e48">count</a>(IndexReg)) &#123;</span></CodeLine>
<Link id="l01366" /><CodeLine lineNumber="1366"><span class="doxyHighlight">          HardenPostLoad.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(&amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</span></CodeLine>
<Link id="l01367" /><CodeLine lineNumber="1367"><span class="doxyHighlight">          HardenedAddrRegs.<a href="/docs/api/classes/llvm/smallset/#afcadfef2cf37c3e6dbdbc9cd7bea50a0">insert</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(0).getReg());</span></CodeLine>
<Link id="l01368" /><CodeLine lineNumber="1368"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01369" /><CodeLine lineNumber="1369"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l01370" /><CodeLine lineNumber="1370"></CodeLine>
<Link id="l01371" /><CodeLine lineNumber="1371"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Record this instruction for address hardening and record its register</span></CodeLine>
<Link id="l01372" /><CodeLine lineNumber="1372"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// operands as being address-hardened.</span></CodeLine>
<Link id="l01373" /><CodeLine lineNumber="1373"><span class="doxyHighlight">        HardenLoadAddr.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(&amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</span></CodeLine>
<Link id="l01374" /><CodeLine lineNumber="1374"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BaseReg)</span></CodeLine>
<Link id="l01375" /><CodeLine lineNumber="1375"><span class="doxyHighlight">          HardenedAddrRegs.<a href="/docs/api/classes/llvm/smallset/#afcadfef2cf37c3e6dbdbc9cd7bea50a0">insert</a>(BaseReg);</span></CodeLine>
<Link id="l01376" /><CodeLine lineNumber="1376"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IndexReg)</span></CodeLine>
<Link id="l01377" /><CodeLine lineNumber="1377"><span class="doxyHighlight">          HardenedAddrRegs.<a href="/docs/api/classes/llvm/smallset/#afcadfef2cf37c3e6dbdbc9cd7bea50a0">insert</a>(IndexReg);</span></CodeLine>
<Link id="l01378" /><CodeLine lineNumber="1378"></CodeLine>
<Link id="l01379" /><CodeLine lineNumber="1379"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;Def : <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.defs())</span></CodeLine>
<Link id="l01380" /><CodeLine lineNumber="1380"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/rdf/#a10793004faece2bb74d3363b5f6ce96f">Def</a>.isReg())</span></CodeLine>
<Link id="l01381" /><CodeLine lineNumber="1381"><span class="doxyHighlight">            LoadDepRegs.<a href="/docs/api/classes/llvm/sparsebitvector/#a613c1e44c4e88e9a1e0be386cb5fa828">set</a>(<a href="/docs/api/namespaces/llvm/rdf/#a10793004faece2bb74d3363b5f6ce96f">Def</a>.getReg());</span></CodeLine>
<Link id="l01382" /><CodeLine lineNumber="1382"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01383" /><CodeLine lineNumber="1383"></CodeLine>
<Link id="l01384" /><CodeLine lineNumber="1384"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Now re-walk the instructions in the basic block, and apply whichever</span></CodeLine>
<Link id="l01385" /><CodeLine lineNumber="1385"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// hardening strategy we have elected. Note that we do this in a second</span></CodeLine>
<Link id="l01386" /><CodeLine lineNumber="1386"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// pass specifically so that we have the complete set of instructions for</span></CodeLine>
<Link id="l01387" /><CodeLine lineNumber="1387"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// which we will do post-load hardening and can defer it in certain</span></CodeLine>
<Link id="l01388" /><CodeLine lineNumber="1388"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// circumstances.</span></CodeLine>
<Link id="l01389" /><CodeLine lineNumber="1389"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> : <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>) &#123;</span></CodeLine>
<Link id="l01390" /><CodeLine lineNumber="1390"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64speculationhardening-cpp/#afd315bab7ff3b1adb2920b69ec1adcae">HardenLoads</a>) &#123;</span></CodeLine>
<Link id="l01391" /><CodeLine lineNumber="1391"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// We cannot both require hardening the def of a load and its address.</span></CodeLine>
<Link id="l01392" /><CodeLine lineNumber="1392"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!(HardenLoadAddr.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(&amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) &amp;&amp; HardenPostLoad.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(&amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>)) &amp;&amp;</span></CodeLine>
<Link id="l01393" /><CodeLine lineNumber="1393"><span class="doxyHighlight">               </span><span class="doxyHighlightStringLiteral">&quot;Requested to harden both the address and def of a load!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01394" /><CodeLine lineNumber="1394"></CodeLine>
<Link id="l01395" /><CodeLine lineNumber="1395"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Check if this is a load whose address needs to be hardened.</span></CodeLine>
<Link id="l01396" /><CodeLine lineNumber="1396"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (HardenLoadAddr.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a11045c7973ab24a8d6315b61fa337d4e">erase</a>(&amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>)) &#123;</span></CodeLine>
<Link id="l01397" /><CodeLine lineNumber="1397"><span class="doxyHighlight">          </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> MemRefBeginIdx = <a href="/docs/api/namespaces/llvm/x86/#a279395a00a782f7e3d6141bc3328a249">X86::getFirstAddrOperandIdx</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</span></CodeLine>
<Link id="l01398" /><CodeLine lineNumber="1398"><span class="doxyHighlight">          <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(MemRefBeginIdx &gt;= 0 &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Cannot have an invalid index here!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01399" /><CodeLine lineNumber="1399"></CodeLine>
<Link id="l01400" /><CodeLine lineNumber="1400"><span class="doxyHighlight">          <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;BaseMO =</span></CodeLine>
<Link id="l01401" /><CodeLine lineNumber="1401"><span class="doxyHighlight">              <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(MemRefBeginIdx + <a href="/docs/api/namespaces/llvm/x86/#a2a5aec578e2e391e99e1705012752d84a319f0e99a1ac9396659683d2638d4f45">X86::AddrBaseReg</a>);</span></CodeLine>
<Link id="l01402" /><CodeLine lineNumber="1402"><span class="doxyHighlight">          <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;IndexMO =</span></CodeLine>
<Link id="l01403" /><CodeLine lineNumber="1403"><span class="doxyHighlight">              <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(MemRefBeginIdx + <a href="/docs/api/namespaces/llvm/x86/#a2a5aec578e2e391e99e1705012752d84aba7ebe0e28a2c1c4c14343f549c01462">X86::AddrIndexReg</a>);</span></CodeLine>
<Link id="l01404" /><CodeLine lineNumber="1404"><span class="doxyHighlight">          hardenLoadAddr(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>, BaseMO, IndexMO, AddrRegToHardenedReg);</span></CodeLine>
<Link id="l01405" /><CodeLine lineNumber="1405"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01406" /><CodeLine lineNumber="1406"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l01407" /><CodeLine lineNumber="1407"></CodeLine>
<Link id="l01408" /><CodeLine lineNumber="1408"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Test if this instruction is one of our post load instructions (and</span></CodeLine>
<Link id="l01409" /><CodeLine lineNumber="1409"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// remove it from the set if so).</span></CodeLine>
<Link id="l01410" /><CodeLine lineNumber="1410"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (HardenPostLoad.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a11045c7973ab24a8d6315b61fa337d4e">erase</a>(&amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>)) &#123;</span></CodeLine>
<Link id="l01411" /><CodeLine lineNumber="1411"><span class="doxyHighlight">          <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isCall() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Must not try to post-load harden a call!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01412" /><CodeLine lineNumber="1412"></CodeLine>
<Link id="l01413" /><CodeLine lineNumber="1413"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// If this is a data-invariant load and there is no EFLAGS</span></CodeLine>
<Link id="l01414" /><CodeLine lineNumber="1414"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// interference, we want to try and sink any hardening as far as</span></CodeLine>
<Link id="l01415" /><CodeLine lineNumber="1415"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// possible.</span></CodeLine>
<Link id="l01416" /><CodeLine lineNumber="1416"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/x86instrinfo/#a34662990aab5992b0b1ee00a4dd4ad34">X86InstrInfo::isDataInvariantLoad</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) &amp;&amp; !<a href="#ac0e27a6dfaf334669f95954dee3d5920">isEFLAGSDefLive</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>)) &#123;</span></CodeLine>
<Link id="l01417" /><CodeLine lineNumber="1417"><span class="doxyHighlight">            </span><span class="doxyHighlightComment">// Sink the instruction we&#39;ll need to harden as far as we can down</span></CodeLine>
<Link id="l01418" /><CodeLine lineNumber="1418"><span class="doxyHighlight">            </span><span class="doxyHighlightComment">// the graph.</span></CodeLine>
<Link id="l01419" /><CodeLine lineNumber="1419"><span class="doxyHighlight">            <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;SunkMI = sinkPostLoadHardenedInst(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>, HardenPostLoad);</span></CodeLine>
<Link id="l01420" /><CodeLine lineNumber="1420"></CodeLine>
<Link id="l01421" /><CodeLine lineNumber="1421"><span class="doxyHighlight">            </span><span class="doxyHighlightComment">// If we managed to sink this instruction, update everything so we</span></CodeLine>
<Link id="l01422" /><CodeLine lineNumber="1422"><span class="doxyHighlight">            </span><span class="doxyHighlightComment">// harden that instruction when we reach it in the instruction</span></CodeLine>
<Link id="l01423" /><CodeLine lineNumber="1423"><span class="doxyHighlight">            </span><span class="doxyHighlightComment">// sequence.</span></CodeLine>
<Link id="l01424" /><CodeLine lineNumber="1424"><span class="doxyHighlight">            </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SunkMI != &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) &#123;</span></CodeLine>
<Link id="l01425" /><CodeLine lineNumber="1425"><span class="doxyHighlight">              </span><span class="doxyHighlightComment">// If in sinking there was no instruction needing to be hardened,</span></CodeLine>
<Link id="l01426" /><CodeLine lineNumber="1426"><span class="doxyHighlight">              </span><span class="doxyHighlightComment">// we&#39;re done.</span></CodeLine>
<Link id="l01427" /><CodeLine lineNumber="1427"><span class="doxyHighlight">              </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!SunkMI)</span></CodeLine>
<Link id="l01428" /><CodeLine lineNumber="1428"><span class="doxyHighlight">                </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01429" /><CodeLine lineNumber="1429"></CodeLine>
<Link id="l01430" /><CodeLine lineNumber="1430"><span class="doxyHighlight">              </span><span class="doxyHighlightComment">// Otherwise, add this to the set of defs we harden.</span></CodeLine>
<Link id="l01431" /><CodeLine lineNumber="1431"><span class="doxyHighlight">              HardenPostLoad.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(SunkMI);</span></CodeLine>
<Link id="l01432" /><CodeLine lineNumber="1432"><span class="doxyHighlight">              </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01433" /><CodeLine lineNumber="1433"><span class="doxyHighlight">            &#125;</span></CodeLine>
<Link id="l01434" /><CodeLine lineNumber="1434"><span class="doxyHighlight">          &#125;</span></CodeLine>
<Link id="l01435" /><CodeLine lineNumber="1435"></CodeLine>
<Link id="l01436" /><CodeLine lineNumber="1436"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> HardenedReg = hardenPostLoad(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</span></CodeLine>
<Link id="l01437" /><CodeLine lineNumber="1437"></CodeLine>
<Link id="l01438" /><CodeLine lineNumber="1438"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// Mark the resulting hardened register as such so we don&#39;t re-harden.</span></CodeLine>
<Link id="l01439" /><CodeLine lineNumber="1439"><span class="doxyHighlight">          AddrRegToHardenedReg&#91;HardenedReg&#93; = HardenedReg;</span></CodeLine>
<Link id="l01440" /><CodeLine lineNumber="1440"></CodeLine>
<Link id="l01441" /><CodeLine lineNumber="1441"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01442" /><CodeLine lineNumber="1442"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l01443" /><CodeLine lineNumber="1443"></CodeLine>
<Link id="l01444" /><CodeLine lineNumber="1444"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Check for an indirect call or branch that may need its input hardened</span></CodeLine>
<Link id="l01445" /><CodeLine lineNumber="1445"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// even if we couldn&#39;t find the specific load used, or were able to</span></CodeLine>
<Link id="l01446" /><CodeLine lineNumber="1446"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// avoid hardening it for some reason. Note that here we cannot break</span></CodeLine>
<Link id="l01447" /><CodeLine lineNumber="1447"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// out afterward as we may still need to handle any call aspect of this</span></CodeLine>
<Link id="l01448" /><CodeLine lineNumber="1448"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// instruction.</span></CodeLine>
<Link id="l01449" /><CodeLine lineNumber="1449"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> ((<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isCall() || <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isBranch()) &amp;&amp; <a href="#ade91f65a65e423e2002fb9b25b7b2a5c">HardenIndirectCallsAndJumps</a>)</span></CodeLine>
<Link id="l01450" /><CodeLine lineNumber="1450"><span class="doxyHighlight">          hardenIndirectCallOrJumpInstr(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>, AddrRegToHardenedReg);</span></CodeLine>
<Link id="l01451" /><CodeLine lineNumber="1451"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01452" /><CodeLine lineNumber="1452"></CodeLine>
<Link id="l01453" /><CodeLine lineNumber="1453"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// After we finish hardening loads we handle interprocedural hardening if</span></CodeLine>
<Link id="l01454" /><CodeLine lineNumber="1454"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// enabled and relevant for this instruction.</span></CodeLine>
<Link id="l01455" /><CodeLine lineNumber="1455"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="#a3e42304d79c25684c4d464fd35fb868f">HardenInterprocedurally</a>)</span></CodeLine>
<Link id="l01456" /><CodeLine lineNumber="1456"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01457" /><CodeLine lineNumber="1457"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isCall() &amp;&amp; !<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isReturn())</span></CodeLine>
<Link id="l01458" /><CodeLine lineNumber="1458"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01459" /><CodeLine lineNumber="1459"></CodeLine>
<Link id="l01460" /><CodeLine lineNumber="1460"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If this is a direct return (IE, not a tail call) just directly harden</span></CodeLine>
<Link id="l01461" /><CodeLine lineNumber="1461"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// it.</span></CodeLine>
<Link id="l01462" /><CodeLine lineNumber="1462"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isReturn() &amp;&amp; !<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isCall()) &#123;</span></CodeLine>
<Link id="l01463" /><CodeLine lineNumber="1463"><span class="doxyHighlight">        hardenReturnInstr(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</span></CodeLine>
<Link id="l01464" /><CodeLine lineNumber="1464"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01465" /><CodeLine lineNumber="1465"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01466" /><CodeLine lineNumber="1466"></CodeLine>
<Link id="l01467" /><CodeLine lineNumber="1467"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Otherwise we have a call. We need to handle transferring the predicate</span></CodeLine>
<Link id="l01468" /><CodeLine lineNumber="1468"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// state into a call and recovering it after the call returns (unless this</span></CodeLine>
<Link id="l01469" /><CodeLine lineNumber="1469"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// is a tail call).</span></CodeLine>
<Link id="l01470" /><CodeLine lineNumber="1470"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isCall() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Should only reach here for calls!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01471" /><CodeLine lineNumber="1471"><span class="doxyHighlight">      tracePredStateThroughCall(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>);</span></CodeLine>
<Link id="l01472" /><CodeLine lineNumber="1472"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01473" /><CodeLine lineNumber="1473"></CodeLine>
<Link id="l01474" /><CodeLine lineNumber="1474"><span class="doxyHighlight">    HardenPostLoad.<a href="/docs/api/classes/llvm/smallptrsetimplbase/#a16413f1a88d8baca228d0a1b4cc0bfc6">clear</a>();</span></CodeLine>
<Link id="l01475" /><CodeLine lineNumber="1475"><span class="doxyHighlight">    HardenLoadAddr.<a href="/docs/api/classes/llvm/smallptrsetimplbase/#a16413f1a88d8baca228d0a1b4cc0bfc6">clear</a>();</span></CodeLine>
<Link id="l01476" /><CodeLine lineNumber="1476"><span class="doxyHighlight">    HardenedAddrRegs.<a href="/docs/api/classes/llvm/smallset/#a76b3fc7c102561fb5210d5151531e409">clear</a>();</span></CodeLine>
<Link id="l01477" /><CodeLine lineNumber="1477"><span class="doxyHighlight">    AddrRegToHardenedReg.<a href="/docs/api/classes/llvm/densemapbase/#adf4e7878fc0b3b8dcde545178564190d">clear</a>();</span></CodeLine>
<Link id="l01478" /><CodeLine lineNumber="1478"></CodeLine>
<Link id="l01479" /><CodeLine lineNumber="1479"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Currently, we only track data-dependent loads within a basic block.</span></CodeLine>
<Link id="l01480" /><CodeLine lineNumber="1480"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// FIXME: We should see if this is necessary or if we could be more</span></CodeLine>
<Link id="l01481" /><CodeLine lineNumber="1481"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// aggressive here without opening up attack avenues.</span></CodeLine>
<Link id="l01482" /><CodeLine lineNumber="1482"><span class="doxyHighlight">    LoadDepRegs.<a href="/docs/api/classes/llvm/sparsebitvector/#a4f223ae1e481ce22245c3c7c7736dbe9">clear</a>();</span></CodeLine>
<Link id="l01483" /><CodeLine lineNumber="1483"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01484" /><CodeLine lineNumber="1484"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01485" /><CodeLine lineNumber="1485"></CodeLine>
<Link id="l01486" /><CodeLine lineNumber="1486"><span class="doxyHighlightComment">/// Save EFLAGS into the returned GPR. This can in turn be restored with</span></CodeLine>
<Link id="l01487" /><CodeLine lineNumber="1487"><span class="doxyHighlightComment">/// &#96;restoreEFLAGS&#96;.</span></CodeLine>
<Link id="l01488" /><CodeLine lineNumber="1488"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01489" /><CodeLine lineNumber="1489"><span class="doxyHighlightComment">/// Note that LLVM can only lower very simple patterns of saved and restored</span></CodeLine>
<Link id="l01490" /><CodeLine lineNumber="1490"><span class="doxyHighlightComment">/// EFLAGS registers. The restore should always be within the same basic block</span></CodeLine>
<Link id="l01491" /><CodeLine lineNumber="1491"><span class="doxyHighlightComment">/// as the save so that no PHI nodes are inserted.</span></CodeLine>
<Link id="l01492" /><CodeLine lineNumber="1492"><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> X86SpeculativeLoadHardeningPass::saveEFLAGS(</span></CodeLine>
<Link id="l01493" /><CodeLine lineNumber="1493"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> InsertPt,</span></CodeLine>
<Link id="l01494" /><CodeLine lineNumber="1494"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> &amp;<a href="/docs/api/namespaces/llvm/loc">Loc</a>) &#123;</span></CodeLine>
<Link id="l01495" /><CodeLine lineNumber="1495"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// FIXME: Hard coding this to a 32-bit register class seems weird, but matches</span></CodeLine>
<Link id="l01496" /><CodeLine lineNumber="1496"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// what instruction selection does.</span></CodeLine>
<Link id="l01497" /><CodeLine lineNumber="1497"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/register">Register</a> <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a> = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(&amp;X86::GR32RegClass);</span></CodeLine>
<Link id="l01498" /><CodeLine lineNumber="1498"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We directly copy the FLAGS register and rely on later lowering to clean</span></CodeLine>
<Link id="l01499" /><CodeLine lineNumber="1499"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// this up into the appropriate setCC instructions.</span></CodeLine>
<Link id="l01500" /><CodeLine lineNumber="1500"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::COPY), <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>).<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(X86::EFLAGS);</span></CodeLine>
<Link id="l01501" /><CodeLine lineNumber="1501"><span class="doxyHighlight">  ++NumInstsInserted;</span></CodeLine>
<Link id="l01502" /><CodeLine lineNumber="1502"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>;</span></CodeLine>
<Link id="l01503" /><CodeLine lineNumber="1503"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01504" /><CodeLine lineNumber="1504"></CodeLine>
<Link id="l01505" /><CodeLine lineNumber="1505"><span class="doxyHighlightComment">/// Restore EFLAGS from the provided GPR. This should be produced by</span></CodeLine>
<Link id="l01506" /><CodeLine lineNumber="1506"><span class="doxyHighlightComment">/// &#96;saveEFLAGS&#96;.</span></CodeLine>
<Link id="l01507" /><CodeLine lineNumber="1507"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01508" /><CodeLine lineNumber="1508"><span class="doxyHighlightComment">/// This must be done within the same basic block as the save in order to</span></CodeLine>
<Link id="l01509" /><CodeLine lineNumber="1509"><span class="doxyHighlightComment">/// reliably lower.</span></CodeLine>
<Link id="l01510" /><CodeLine lineNumber="1510"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> X86SpeculativeLoadHardeningPass::restoreEFLAGS(</span></CodeLine>
<Link id="l01511" /><CodeLine lineNumber="1511"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> InsertPt,</span></CodeLine>
<Link id="l01512" /><CodeLine lineNumber="1512"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> &amp;<a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/classes/llvm/register">Register</a> <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>) &#123;</span></CodeLine>
<Link id="l01513" /><CodeLine lineNumber="1513"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::COPY), X86::EFLAGS).<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>);</span></CodeLine>
<Link id="l01514" /><CodeLine lineNumber="1514"><span class="doxyHighlight">  ++NumInstsInserted;</span></CodeLine>
<Link id="l01515" /><CodeLine lineNumber="1515"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01516" /><CodeLine lineNumber="1516"></CodeLine>
<Link id="l01517" /><CodeLine lineNumber="1517"><span class="doxyHighlightComment">/// Takes the current predicate state (in a register) and merges it into the</span></CodeLine>
<Link id="l01518" /><CodeLine lineNumber="1518"><span class="doxyHighlightComment">/// stack pointer. The state is essentially a single bit, but we merge this in</span></CodeLine>
<Link id="l01519" /><CodeLine lineNumber="1519"><span class="doxyHighlightComment">/// a way that won&#39;t form non-canonical pointers and also will be preserved</span></CodeLine>
<Link id="l01520" /><CodeLine lineNumber="1520"><span class="doxyHighlightComment">/// across normal stack adjustments.</span></CodeLine>
<Link id="l01521" /><CodeLine lineNumber="1521"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> X86SpeculativeLoadHardeningPass::mergePredStateIntoSP(</span></CodeLine>
<Link id="l01522" /><CodeLine lineNumber="1522"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> InsertPt,</span></CodeLine>
<Link id="l01523" /><CodeLine lineNumber="1523"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> &amp;<a href="/docs/api/namespaces/llvm/loc">Loc</a>, </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> PredStateReg) &#123;</span></CodeLine>
<Link id="l01524" /><CodeLine lineNumber="1524"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/register">Register</a> TmpReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(PS-&gt;RC);</span></CodeLine>
<Link id="l01525" /><CodeLine lineNumber="1525"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// FIXME: This hard codes a shift distance based on the number of bits needed</span></CodeLine>
<Link id="l01526" /><CodeLine lineNumber="1526"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// to stay canonical on 64-bit. We should compute this somehow and support</span></CodeLine>
<Link id="l01527" /><CodeLine lineNumber="1527"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// 32-bit as part of that.</span></CodeLine>
<Link id="l01528" /><CodeLine lineNumber="1528"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> ShiftI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::SHL64ri), TmpReg)</span></CodeLine>
<Link id="l01529" /><CodeLine lineNumber="1529"><span class="doxyHighlight">                    .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(PredStateReg, <a href="/docs/api/namespaces/llvm/regstate/#ade26fe5c9b3fe6948def36f7ca12dfc5a9ddde91ef09476d28a088fe57f8e2921">RegState::Kill</a>)</span></CodeLine>
<Link id="l01530" /><CodeLine lineNumber="1530"><span class="doxyHighlight">                    .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(47);</span></CodeLine>
<Link id="l01531" /><CodeLine lineNumber="1531"><span class="doxyHighlight">  ShiftI-&gt;<a href="/docs/api/classes/llvm/machineinstr/#afda2c0f22be043ae42b0ec71b661f565">addRegisterDead</a>(X86::EFLAGS, <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>);</span></CodeLine>
<Link id="l01532" /><CodeLine lineNumber="1532"><span class="doxyHighlight">  ++NumInstsInserted;</span></CodeLine>
<Link id="l01533" /><CodeLine lineNumber="1533"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> OrI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::OR64rr), X86::RSP)</span></CodeLine>
<Link id="l01534" /><CodeLine lineNumber="1534"><span class="doxyHighlight">                 .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(X86::RSP)</span></CodeLine>
<Link id="l01535" /><CodeLine lineNumber="1535"><span class="doxyHighlight">                 .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(TmpReg, <a href="/docs/api/namespaces/llvm/regstate/#ade26fe5c9b3fe6948def36f7ca12dfc5a9ddde91ef09476d28a088fe57f8e2921">RegState::Kill</a>);</span></CodeLine>
<Link id="l01536" /><CodeLine lineNumber="1536"><span class="doxyHighlight">  OrI-&gt;<a href="/docs/api/classes/llvm/machineinstr/#afda2c0f22be043ae42b0ec71b661f565">addRegisterDead</a>(X86::EFLAGS, <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>);</span></CodeLine>
<Link id="l01537" /><CodeLine lineNumber="1537"><span class="doxyHighlight">  ++NumInstsInserted;</span></CodeLine>
<Link id="l01538" /><CodeLine lineNumber="1538"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01539" /><CodeLine lineNumber="1539"></CodeLine>
<Link id="l01540" /><CodeLine lineNumber="1540"><span class="doxyHighlightComment">/// Extracts the predicate state stored in the high bits of the stack pointer.</span></CodeLine>
<Link id="l01541" /><CodeLine lineNumber="1541"><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> X86SpeculativeLoadHardeningPass::extractPredStateFromSP(</span></CodeLine>
<Link id="l01542" /><CodeLine lineNumber="1542"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> InsertPt,</span></CodeLine>
<Link id="l01543" /><CodeLine lineNumber="1543"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> &amp;<a href="/docs/api/namespaces/llvm/loc">Loc</a>) &#123;</span></CodeLine>
<Link id="l01544" /><CodeLine lineNumber="1544"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/register">Register</a> PredStateReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(PS-&gt;RC);</span></CodeLine>
<Link id="l01545" /><CodeLine lineNumber="1545"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/register">Register</a> TmpReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(PS-&gt;RC);</span></CodeLine>
<Link id="l01546" /><CodeLine lineNumber="1546"></CodeLine>
<Link id="l01547" /><CodeLine lineNumber="1547"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We know that the stack pointer will have any preserved predicate state in</span></CodeLine>
<Link id="l01548" /><CodeLine lineNumber="1548"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// its high bit. We just want to smear this across the other bits. Turns out,</span></CodeLine>
<Link id="l01549" /><CodeLine lineNumber="1549"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// this is exactly what an arithmetic right shift does.</span></CodeLine>
<Link id="l01550" /><CodeLine lineNumber="1550"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(TargetOpcode::COPY), TmpReg)</span></CodeLine>
<Link id="l01551" /><CodeLine lineNumber="1551"><span class="doxyHighlight">      .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(X86::RSP);</span></CodeLine>
<Link id="l01552" /><CodeLine lineNumber="1552"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> ShiftI =</span></CodeLine>
<Link id="l01553" /><CodeLine lineNumber="1553"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::SAR64ri), PredStateReg)</span></CodeLine>
<Link id="l01554" /><CodeLine lineNumber="1554"><span class="doxyHighlight">          .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(TmpReg, <a href="/docs/api/namespaces/llvm/regstate/#ade26fe5c9b3fe6948def36f7ca12dfc5a9ddde91ef09476d28a088fe57f8e2921">RegState::Kill</a>)</span></CodeLine>
<Link id="l01555" /><CodeLine lineNumber="1555"><span class="doxyHighlight">          .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>-&gt;getRegSizeInBits(&#42;PS-&gt;RC) - 1);</span></CodeLine>
<Link id="l01556" /><CodeLine lineNumber="1556"><span class="doxyHighlight">  ShiftI-&gt;<a href="/docs/api/classes/llvm/machineinstr/#afda2c0f22be043ae42b0ec71b661f565">addRegisterDead</a>(X86::EFLAGS, <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>);</span></CodeLine>
<Link id="l01557" /><CodeLine lineNumber="1557"><span class="doxyHighlight">  ++NumInstsInserted;</span></CodeLine>
<Link id="l01558" /><CodeLine lineNumber="1558"></CodeLine>
<Link id="l01559" /><CodeLine lineNumber="1559"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> PredStateReg;</span></CodeLine>
<Link id="l01560" /><CodeLine lineNumber="1560"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01561" /><CodeLine lineNumber="1561"></CodeLine>
<Link id="l01562" /><CodeLine lineNumber="1562"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> X86SpeculativeLoadHardeningPass::hardenLoadAddr(</span></CodeLine>
<Link id="l01563" /><CodeLine lineNumber="1563"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>, <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;BaseMO, <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;IndexMO,</span></CodeLine>
<Link id="l01564" /><CodeLine lineNumber="1564"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;unsigned, unsigned, 32&gt;</a> &amp;AddrRegToHardenedReg) &#123;</span></CodeLine>
<Link id="l01565" /><CodeLine lineNumber="1565"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> = &#42;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getParent();</span></CodeLine>
<Link id="l01566" /><CodeLine lineNumber="1566"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> &amp;<a href="/docs/api/namespaces/llvm/loc">Loc</a> = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getDebugLoc();</span></CodeLine>
<Link id="l01567" /><CodeLine lineNumber="1567"></CodeLine>
<Link id="l01568" /><CodeLine lineNumber="1568"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Check if EFLAGS are alive by seeing if there is a def of them or they</span></CodeLine>
<Link id="l01569" /><CodeLine lineNumber="1569"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// live-in, and then seeing if that def is in turn used.</span></CodeLine>
<Link id="l01570" /><CodeLine lineNumber="1570"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> EFLAGSLive = <a href="#a93f8e5dacbcd949d688c3af5f491468d">isEFLAGSLive</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getIterator(), &#42;<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>);</span></CodeLine>
<Link id="l01571" /><CodeLine lineNumber="1571"></CodeLine>
<Link id="l01572" /><CodeLine lineNumber="1572"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MachineOperand &#42;, 2&gt;</a> HardenOpRegs;</span></CodeLine>
<Link id="l01573" /><CodeLine lineNumber="1573"></CodeLine>
<Link id="l01574" /><CodeLine lineNumber="1574"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#ad7213433bd60dc33020246384dc18b9b">isFI</a>()) &#123;</span></CodeLine>
<Link id="l01575" /><CodeLine lineNumber="1575"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// A frame index is never a dynamically controllable load, so only</span></CodeLine>
<Link id="l01576" /><CodeLine lineNumber="1576"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// harden it if we&#39;re covering fixed address loads as well.</span></CodeLine>
<Link id="l01577" /><CodeLine lineNumber="1577"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(</span></CodeLine>
<Link id="l01578" /><CodeLine lineNumber="1578"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Skipping hardening base of explicit stack frame load: &quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01579" /><CodeLine lineNumber="1579"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01580" /><CodeLine lineNumber="1580"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() == X86::RSP) &#123;</span></CodeLine>
<Link id="l01581" /><CodeLine lineNumber="1581"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Some idempotent atomic operations are lowered directly to a locked</span></CodeLine>
<Link id="l01582" /><CodeLine lineNumber="1582"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// OR with 0 to the top of stack(or slightly offset from top) which uses an</span></CodeLine>
<Link id="l01583" /><CodeLine lineNumber="1583"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// explicit RSP register as the base.</span></CodeLine>
<Link id="l01584" /><CodeLine lineNumber="1584"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(IndexMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() == X86::NoRegister &amp;&amp;</span></CodeLine>
<Link id="l01585" /><CodeLine lineNumber="1585"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;Explicit RSP access with dynamic index!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01586" /><CodeLine lineNumber="1586"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(</span></CodeLine>
<Link id="l01587" /><CodeLine lineNumber="1587"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Cannot harden base of explicit RSP offset in a load!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01588" /><CodeLine lineNumber="1588"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() == X86::RIP ||</span></CodeLine>
<Link id="l01589" /><CodeLine lineNumber="1589"><span class="doxyHighlight">             BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() == X86::NoRegister) &#123;</span></CodeLine>
<Link id="l01590" /><CodeLine lineNumber="1590"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// For both RIP-relative addressed loads or absolute loads, we cannot</span></CodeLine>
<Link id="l01591" /><CodeLine lineNumber="1591"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// meaningfully harden them because the address being loaded has no</span></CodeLine>
<Link id="l01592" /><CodeLine lineNumber="1592"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// dynamic component.</span></CodeLine>
<Link id="l01593" /><CodeLine lineNumber="1593"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l01594" /><CodeLine lineNumber="1594"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// FIXME: When using a segment base (like TLS does) we end up with the</span></CodeLine>
<Link id="l01595" /><CodeLine lineNumber="1595"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// dynamic address being the base plus -1 because we can&#39;t mutate the</span></CodeLine>
<Link id="l01596" /><CodeLine lineNumber="1596"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// segment register here. This allows the signed 32-bit offset to point at</span></CodeLine>
<Link id="l01597" /><CodeLine lineNumber="1597"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// valid segment-relative addresses and load them successfully.</span></CodeLine>
<Link id="l01598" /><CodeLine lineNumber="1598"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(</span></CodeLine>
<Link id="l01599" /><CodeLine lineNumber="1599"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Cannot harden base of &quot;</span></CodeLine>
<Link id="l01600" /><CodeLine lineNumber="1600"><span class="doxyHighlight">               &lt;&lt; (BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() == X86::RIP ? </span><span class="doxyHighlightStringLiteral">&quot;RIP-relative&quot;</span><span class="doxyHighlight"> : </span><span class="doxyHighlightStringLiteral">&quot;no-base&quot;</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l01601" /><CodeLine lineNumber="1601"><span class="doxyHighlight">               &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; address in a load!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01602" /><CodeLine lineNumber="1602"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l01603" /><CodeLine lineNumber="1603"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#a4c9594c955fec80c73ddd964b5efd554">isReg</a>() &amp;&amp;</span></CodeLine>
<Link id="l01604" /><CodeLine lineNumber="1604"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;Only allowed to have a frame index or register base.&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01605" /><CodeLine lineNumber="1605"><span class="doxyHighlight">    HardenOpRegs.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&amp;BaseMO);</span></CodeLine>
<Link id="l01606" /><CodeLine lineNumber="1606"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01607" /><CodeLine lineNumber="1607"></CodeLine>
<Link id="l01608" /><CodeLine lineNumber="1608"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IndexMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() != X86::NoRegister &amp;&amp;</span></CodeLine>
<Link id="l01609" /><CodeLine lineNumber="1609"><span class="doxyHighlight">      (HardenOpRegs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>() ||</span></CodeLine>
<Link id="l01610" /><CodeLine lineNumber="1610"><span class="doxyHighlight">       HardenOpRegs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a58dc840fc84420b7f0b773794b8101c1">front</a>()-&gt;getReg() != IndexMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>()))</span></CodeLine>
<Link id="l01611" /><CodeLine lineNumber="1611"><span class="doxyHighlight">    HardenOpRegs.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&amp;IndexMO);</span></CodeLine>
<Link id="l01612" /><CodeLine lineNumber="1612"></CodeLine>
<Link id="l01613" /><CodeLine lineNumber="1613"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((HardenOpRegs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() == 1 || HardenOpRegs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() == 2) &amp;&amp;</span></CodeLine>
<Link id="l01614" /><CodeLine lineNumber="1614"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;Should have exactly one or two registers to harden!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01615" /><CodeLine lineNumber="1615"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((HardenOpRegs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() == 1 ||</span></CodeLine>
<Link id="l01616" /><CodeLine lineNumber="1616"><span class="doxyHighlight">          HardenOpRegs&#91;0&#93;-&gt;getReg() != HardenOpRegs&#91;1&#93;-&gt;getReg()) &amp;&amp;</span></CodeLine>
<Link id="l01617" /><CodeLine lineNumber="1617"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;Should not have two of the same registers!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01618" /><CodeLine lineNumber="1618"></CodeLine>
<Link id="l01619" /><CodeLine lineNumber="1619"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Remove any registers that have alreaded been checked.</span></CodeLine>
<Link id="l01620" /><CodeLine lineNumber="1620"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#ac9a7de5a04920954ac964059cfc428ad">llvm::erase&#95;if</a>(HardenOpRegs, &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &#42;<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>) &#123;</span></CodeLine>
<Link id="l01621" /><CodeLine lineNumber="1621"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// See if this operand&#39;s register has already been checked.</span></CodeLine>
<Link id="l01622" /><CodeLine lineNumber="1622"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> It = AddrRegToHardenedReg.<a href="/docs/api/classes/llvm/densemapbase/#a0c047f127ed4380a6f383d70bec4eb94">find</a>(<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>-&gt;getReg());</span></CodeLine>
<Link id="l01623" /><CodeLine lineNumber="1623"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (It == AddrRegToHardenedReg.<a href="/docs/api/classes/llvm/densemapbase/#a65520b9c67759099e313d0f4e7b5ff9e">end</a>())</span></CodeLine>
<Link id="l01624" /><CodeLine lineNumber="1624"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Not checked, so retain this one.</span></CodeLine>
<Link id="l01625" /><CodeLine lineNumber="1625"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01626" /><CodeLine lineNumber="1626"></CodeLine>
<Link id="l01627" /><CodeLine lineNumber="1627"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Otherwise, we can directly update this operand and remove it.</span></CodeLine>
<Link id="l01628" /><CodeLine lineNumber="1628"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>-&gt;setReg(It-&gt;second);</span></CodeLine>
<Link id="l01629" /><CodeLine lineNumber="1629"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01630" /><CodeLine lineNumber="1630"><span class="doxyHighlight">  &#125;);</span></CodeLine>
<Link id="l01631" /><CodeLine lineNumber="1631"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If there are none left, we&#39;re done.</span></CodeLine>
<Link id="l01632" /><CodeLine lineNumber="1632"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (HardenOpRegs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>())</span></CodeLine>
<Link id="l01633" /><CodeLine lineNumber="1633"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01634" /><CodeLine lineNumber="1634"></CodeLine>
<Link id="l01635" /><CodeLine lineNumber="1635"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Compute the current predicate state.</span></CodeLine>
<Link id="l01636" /><CodeLine lineNumber="1636"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/register">Register</a> StateReg = PS-&gt;SSA.GetValueAtEndOfBlock(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</span></CodeLine>
<Link id="l01637" /><CodeLine lineNumber="1637"></CodeLine>
<Link id="l01638" /><CodeLine lineNumber="1638"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> InsertPt = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getIterator();</span></CodeLine>
<Link id="l01639" /><CodeLine lineNumber="1639"></CodeLine>
<Link id="l01640" /><CodeLine lineNumber="1640"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If EFLAGS are live and we don&#39;t have access to instructions that avoid</span></CodeLine>
<Link id="l01641" /><CodeLine lineNumber="1641"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// clobbering EFLAGS we need to save and restore them. This in turn makes</span></CodeLine>
<Link id="l01642" /><CodeLine lineNumber="1642"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the EFLAGS no longer live.</span></CodeLine>
<Link id="l01643" /><CodeLine lineNumber="1643"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> FlagsReg = 0;</span></CodeLine>
<Link id="l01644" /><CodeLine lineNumber="1644"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (EFLAGSLive &amp;&amp; !Subtarget-&gt;hasBMI2()) &#123;</span></CodeLine>
<Link id="l01645" /><CodeLine lineNumber="1645"><span class="doxyHighlight">    EFLAGSLive = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01646" /><CodeLine lineNumber="1646"><span class="doxyHighlight">    FlagsReg = saveEFLAGS(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>);</span></CodeLine>
<Link id="l01647" /><CodeLine lineNumber="1647"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01648" /><CodeLine lineNumber="1648"></CodeLine>
<Link id="l01649" /><CodeLine lineNumber="1649"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &#42;<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a> : HardenOpRegs) &#123;</span></CodeLine>
<Link id="l01650" /><CodeLine lineNumber="1650"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/register">Register</a> OpReg = <a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>-&gt;getReg();</span></CodeLine>
<Link id="l01651" /><CodeLine lineNumber="1651"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;OpRC = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;getRegClass(OpReg);</span></CodeLine>
<Link id="l01652" /><CodeLine lineNumber="1652"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/register">Register</a> TmpReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(OpRC);</span></CodeLine>
<Link id="l01653" /><CodeLine lineNumber="1653"></CodeLine>
<Link id="l01654" /><CodeLine lineNumber="1654"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If this is a vector register, we&#39;ll need somewhat custom logic to handle</span></CodeLine>
<Link id="l01655" /><CodeLine lineNumber="1655"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// hardening it.</span></CodeLine>
<Link id="l01656" /><CodeLine lineNumber="1656"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Subtarget-&gt;hasVLX() &amp;&amp; (OpRC-&gt;hasSuperClassEq(&amp;X86::VR128RegClass) ||</span></CodeLine>
<Link id="l01657" /><CodeLine lineNumber="1657"><span class="doxyHighlight">                                 OpRC-&gt;hasSuperClassEq(&amp;X86::VR256RegClass))) &#123;</span></CodeLine>
<Link id="l01658" /><CodeLine lineNumber="1658"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Subtarget-&gt;hasAVX2() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;AVX2-specific register classes!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01659" /><CodeLine lineNumber="1659"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/systemzii/#af95a60521e541cc7a0f27971c1e83a3aa85ee30c33ec729f12da52e3accbf7078">Is128Bit</a> = OpRC-&gt;hasSuperClassEq(&amp;X86::VR128RegClass);</span></CodeLine>
<Link id="l01660" /><CodeLine lineNumber="1660"></CodeLine>
<Link id="l01661" /><CodeLine lineNumber="1661"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Move our state into a vector register.</span></CodeLine>
<Link id="l01662" /><CodeLine lineNumber="1662"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// FIXME: We could skip this at the cost of longer encodings with AVX-512</span></CodeLine>
<Link id="l01663" /><CodeLine lineNumber="1663"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// but that doesn&#39;t seem likely worth it.</span></CodeLine>
<Link id="l01664" /><CodeLine lineNumber="1664"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/register">Register</a> VStateReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(&amp;X86::VR128RegClass);</span></CodeLine>
<Link id="l01665" /><CodeLine lineNumber="1665"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> MovI =</span></CodeLine>
<Link id="l01666" /><CodeLine lineNumber="1666"><span class="doxyHighlight">          <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::VMOV64toPQIrr), VStateReg)</span></CodeLine>
<Link id="l01667" /><CodeLine lineNumber="1667"><span class="doxyHighlight">              .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(StateReg);</span></CodeLine>
<Link id="l01668" /><CodeLine lineNumber="1668"><span class="doxyHighlight">      (void)MovI;</span></CodeLine>
<Link id="l01669" /><CodeLine lineNumber="1669"><span class="doxyHighlight">      ++NumInstsInserted;</span></CodeLine>
<Link id="l01670" /><CodeLine lineNumber="1670"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Inserting mov: &quot;</span><span class="doxyHighlight">; MovI-&gt;dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01671" /><CodeLine lineNumber="1671"></CodeLine>
<Link id="l01672" /><CodeLine lineNumber="1672"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Broadcast it across the vector register.</span></CodeLine>
<Link id="l01673" /><CodeLine lineNumber="1673"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/register">Register</a> VBStateReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(OpRC);</span></CodeLine>
<Link id="l01674" /><CodeLine lineNumber="1674"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> BroadcastI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>,</span></CodeLine>
<Link id="l01675" /><CodeLine lineNumber="1675"><span class="doxyHighlight">                                <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(Is128Bit ? X86::VPBROADCASTQrr</span></CodeLine>
<Link id="l01676" /><CodeLine lineNumber="1676"><span class="doxyHighlight">                                                  : X86::VPBROADCASTQYrr),</span></CodeLine>
<Link id="l01677" /><CodeLine lineNumber="1677"><span class="doxyHighlight">                                VBStateReg)</span></CodeLine>
<Link id="l01678" /><CodeLine lineNumber="1678"><span class="doxyHighlight">                            .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(VStateReg);</span></CodeLine>
<Link id="l01679" /><CodeLine lineNumber="1679"><span class="doxyHighlight">      (void)BroadcastI;</span></CodeLine>
<Link id="l01680" /><CodeLine lineNumber="1680"><span class="doxyHighlight">      ++NumInstsInserted;</span></CodeLine>
<Link id="l01681" /><CodeLine lineNumber="1681"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Inserting broadcast: &quot;</span><span class="doxyHighlight">; BroadcastI-&gt;dump();</span></CodeLine>
<Link id="l01682" /><CodeLine lineNumber="1682"><span class="doxyHighlight">                 <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01683" /><CodeLine lineNumber="1683"></CodeLine>
<Link id="l01684" /><CodeLine lineNumber="1684"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Merge our potential poison state into the value with a vector or.</span></CodeLine>
<Link id="l01685" /><CodeLine lineNumber="1685"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> OrI =</span></CodeLine>
<Link id="l01686" /><CodeLine lineNumber="1686"><span class="doxyHighlight">          <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>,</span></CodeLine>
<Link id="l01687" /><CodeLine lineNumber="1687"><span class="doxyHighlight">                  <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(Is128Bit ? X86::VPORrr : X86::VPORYrr), TmpReg)</span></CodeLine>
<Link id="l01688" /><CodeLine lineNumber="1688"><span class="doxyHighlight">              .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(VBStateReg)</span></CodeLine>
<Link id="l01689" /><CodeLine lineNumber="1689"><span class="doxyHighlight">              .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(OpReg);</span></CodeLine>
<Link id="l01690" /><CodeLine lineNumber="1690"><span class="doxyHighlight">      (void)OrI;</span></CodeLine>
<Link id="l01691" /><CodeLine lineNumber="1691"><span class="doxyHighlight">      ++NumInstsInserted;</span></CodeLine>
<Link id="l01692" /><CodeLine lineNumber="1692"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Inserting or: &quot;</span><span class="doxyHighlight">; OrI-&gt;dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01693" /><CodeLine lineNumber="1693"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (OpRC-&gt;hasSuperClassEq(&amp;X86::VR128XRegClass) ||</span></CodeLine>
<Link id="l01694" /><CodeLine lineNumber="1694"><span class="doxyHighlight">               OpRC-&gt;hasSuperClassEq(&amp;X86::VR256XRegClass) ||</span></CodeLine>
<Link id="l01695" /><CodeLine lineNumber="1695"><span class="doxyHighlight">               OpRC-&gt;hasSuperClassEq(&amp;X86::VR512RegClass)) &#123;</span></CodeLine>
<Link id="l01696" /><CodeLine lineNumber="1696"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Subtarget-&gt;hasAVX512() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;AVX512-specific register classes!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01697" /><CodeLine lineNumber="1697"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/systemzii/#af95a60521e541cc7a0f27971c1e83a3aa85ee30c33ec729f12da52e3accbf7078">Is128Bit</a> = OpRC-&gt;hasSuperClassEq(&amp;X86::VR128XRegClass);</span></CodeLine>
<Link id="l01698" /><CodeLine lineNumber="1698"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> Is256Bit = OpRC-&gt;hasSuperClassEq(&amp;X86::VR256XRegClass);</span></CodeLine>
<Link id="l01699" /><CodeLine lineNumber="1699"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Is128Bit || Is256Bit)</span></CodeLine>
<Link id="l01700" /><CodeLine lineNumber="1700"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Subtarget-&gt;hasVLX() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;AVX512VL-specific register classes!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01701" /><CodeLine lineNumber="1701"></CodeLine>
<Link id="l01702" /><CodeLine lineNumber="1702"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Broadcast our state into a vector register.</span></CodeLine>
<Link id="l01703" /><CodeLine lineNumber="1703"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/register">Register</a> VStateReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(OpRC);</span></CodeLine>
<Link id="l01704" /><CodeLine lineNumber="1704"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> BroadcastOp = <a href="/docs/api/namespaces/llvm/systemzii/#af95a60521e541cc7a0f27971c1e83a3aa85ee30c33ec729f12da52e3accbf7078">Is128Bit</a> ? X86::VPBROADCASTQrZ128rr</span></CodeLine>
<Link id="l01705" /><CodeLine lineNumber="1705"><span class="doxyHighlight">                                      : Is256Bit ? X86::VPBROADCASTQrZ256rr</span></CodeLine>
<Link id="l01706" /><CodeLine lineNumber="1706"><span class="doxyHighlight">                                                 : X86::VPBROADCASTQrZrr;</span></CodeLine>
<Link id="l01707" /><CodeLine lineNumber="1707"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> BroadcastI =</span></CodeLine>
<Link id="l01708" /><CodeLine lineNumber="1708"><span class="doxyHighlight">          <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(BroadcastOp), VStateReg)</span></CodeLine>
<Link id="l01709" /><CodeLine lineNumber="1709"><span class="doxyHighlight">              .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(StateReg);</span></CodeLine>
<Link id="l01710" /><CodeLine lineNumber="1710"><span class="doxyHighlight">      (void)BroadcastI;</span></CodeLine>
<Link id="l01711" /><CodeLine lineNumber="1711"><span class="doxyHighlight">      ++NumInstsInserted;</span></CodeLine>
<Link id="l01712" /><CodeLine lineNumber="1712"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Inserting broadcast: &quot;</span><span class="doxyHighlight">; BroadcastI-&gt;dump();</span></CodeLine>
<Link id="l01713" /><CodeLine lineNumber="1713"><span class="doxyHighlight">                 <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01714" /><CodeLine lineNumber="1714"></CodeLine>
<Link id="l01715" /><CodeLine lineNumber="1715"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Merge our potential poison state into the value with a vector or.</span></CodeLine>
<Link id="l01716" /><CodeLine lineNumber="1716"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> OrOp = <a href="/docs/api/namespaces/llvm/systemzii/#af95a60521e541cc7a0f27971c1e83a3aa85ee30c33ec729f12da52e3accbf7078">Is128Bit</a> ? X86::VPORQZ128rr</span></CodeLine>
<Link id="l01717" /><CodeLine lineNumber="1717"><span class="doxyHighlight">                               : Is256Bit ? X86::VPORQZ256rr : X86::VPORQZrr;</span></CodeLine>
<Link id="l01718" /><CodeLine lineNumber="1718"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> OrI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(OrOp), TmpReg)</span></CodeLine>
<Link id="l01719" /><CodeLine lineNumber="1719"><span class="doxyHighlight">                     .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(VStateReg)</span></CodeLine>
<Link id="l01720" /><CodeLine lineNumber="1720"><span class="doxyHighlight">                     .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(OpReg);</span></CodeLine>
<Link id="l01721" /><CodeLine lineNumber="1721"><span class="doxyHighlight">      (void)OrI;</span></CodeLine>
<Link id="l01722" /><CodeLine lineNumber="1722"><span class="doxyHighlight">      ++NumInstsInserted;</span></CodeLine>
<Link id="l01723" /><CodeLine lineNumber="1723"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Inserting or: &quot;</span><span class="doxyHighlight">; OrI-&gt;dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01724" /><CodeLine lineNumber="1724"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l01725" /><CodeLine lineNumber="1725"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// FIXME: Need to support GR32 here for 32-bit code.</span></CodeLine>
<Link id="l01726" /><CodeLine lineNumber="1726"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(OpRC-&gt;hasSuperClassEq(&amp;X86::GR64RegClass) &amp;&amp;</span></CodeLine>
<Link id="l01727" /><CodeLine lineNumber="1727"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;Not a supported register class for address hardening!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01728" /><CodeLine lineNumber="1728"></CodeLine>
<Link id="l01729" /><CodeLine lineNumber="1729"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!EFLAGSLive) &#123;</span></CodeLine>
<Link id="l01730" /><CodeLine lineNumber="1730"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Merge our potential poison state into the value with an or.</span></CodeLine>
<Link id="l01731" /><CodeLine lineNumber="1731"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> OrI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::OR64rr), TmpReg)</span></CodeLine>
<Link id="l01732" /><CodeLine lineNumber="1732"><span class="doxyHighlight">                       .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(StateReg)</span></CodeLine>
<Link id="l01733" /><CodeLine lineNumber="1733"><span class="doxyHighlight">                       .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(OpReg);</span></CodeLine>
<Link id="l01734" /><CodeLine lineNumber="1734"><span class="doxyHighlight">        OrI-&gt;<a href="/docs/api/classes/llvm/machineinstr/#afda2c0f22be043ae42b0ec71b661f565">addRegisterDead</a>(X86::EFLAGS, <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>);</span></CodeLine>
<Link id="l01735" /><CodeLine lineNumber="1735"><span class="doxyHighlight">        ++NumInstsInserted;</span></CodeLine>
<Link id="l01736" /><CodeLine lineNumber="1736"><span class="doxyHighlight">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Inserting or: &quot;</span><span class="doxyHighlight">; OrI-&gt;dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01737" /><CodeLine lineNumber="1737"><span class="doxyHighlight">      &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l01738" /><CodeLine lineNumber="1738"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// We need to avoid touching EFLAGS so shift out all but the least</span></CodeLine>
<Link id="l01739" /><CodeLine lineNumber="1739"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// significant bit using the instruction that doesn&#39;t update flags.</span></CodeLine>
<Link id="l01740" /><CodeLine lineNumber="1740"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> ShiftI =</span></CodeLine>
<Link id="l01741" /><CodeLine lineNumber="1741"><span class="doxyHighlight">            <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::SHRX64rr), TmpReg)</span></CodeLine>
<Link id="l01742" /><CodeLine lineNumber="1742"><span class="doxyHighlight">                .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(OpReg)</span></CodeLine>
<Link id="l01743" /><CodeLine lineNumber="1743"><span class="doxyHighlight">                .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(StateReg);</span></CodeLine>
<Link id="l01744" /><CodeLine lineNumber="1744"><span class="doxyHighlight">        (void)ShiftI;</span></CodeLine>
<Link id="l01745" /><CodeLine lineNumber="1745"><span class="doxyHighlight">        ++NumInstsInserted;</span></CodeLine>
<Link id="l01746" /><CodeLine lineNumber="1746"><span class="doxyHighlight">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Inserting shrx: &quot;</span><span class="doxyHighlight">; ShiftI-&gt;dump();</span></CodeLine>
<Link id="l01747" /><CodeLine lineNumber="1747"><span class="doxyHighlight">                   <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01748" /><CodeLine lineNumber="1748"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01749" /><CodeLine lineNumber="1749"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01750" /><CodeLine lineNumber="1750"></CodeLine>
<Link id="l01751" /><CodeLine lineNumber="1751"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Record this register as checked and update the operand.</span></CodeLine>
<Link id="l01752" /><CodeLine lineNumber="1752"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!AddrRegToHardenedReg.<a href="/docs/api/classes/llvm/densemapbase/#a53408c95a7bfb5443b43fb2134c3eb23">count</a>(<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>-&gt;getReg()) &amp;&amp;</span></CodeLine>
<Link id="l01753" /><CodeLine lineNumber="1753"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;Should not have checked this register yet!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01754" /><CodeLine lineNumber="1754"><span class="doxyHighlight">    AddrRegToHardenedReg&#91;<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>-&gt;getReg()&#93; = TmpReg;</span></CodeLine>
<Link id="l01755" /><CodeLine lineNumber="1755"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>-&gt;setReg(TmpReg);</span></CodeLine>
<Link id="l01756" /><CodeLine lineNumber="1756"><span class="doxyHighlight">    ++NumAddrRegsHardened;</span></CodeLine>
<Link id="l01757" /><CodeLine lineNumber="1757"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01758" /><CodeLine lineNumber="1758"></CodeLine>
<Link id="l01759" /><CodeLine lineNumber="1759"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// And restore the flags if needed.</span></CodeLine>
<Link id="l01760" /><CodeLine lineNumber="1760"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FlagsReg)</span></CodeLine>
<Link id="l01761" /><CodeLine lineNumber="1761"><span class="doxyHighlight">    restoreEFLAGS(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, FlagsReg);</span></CodeLine>
<Link id="l01762" /><CodeLine lineNumber="1762"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01763" /><CodeLine lineNumber="1763"></CodeLine>
<Link id="l01764" /><CodeLine lineNumber="1764"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;X86SpeculativeLoadHardeningPass::sinkPostLoadHardenedInst(</span></CodeLine>
<Link id="l01765" /><CodeLine lineNumber="1765"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;InitialMI, <a href="/docs/api/classes/llvm/smallptrsetimpl">SmallPtrSetImpl&lt;MachineInstr &#42;&gt;</a> &amp;HardenedInstrs) &#123;</span></CodeLine>
<Link id="l01766" /><CodeLine lineNumber="1766"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/llvm/x86instrinfo/#a34662990aab5992b0b1ee00a4dd4ad34">X86InstrInfo::isDataInvariantLoad</a>(InitialMI) &amp;&amp;</span></CodeLine>
<Link id="l01767" /><CodeLine lineNumber="1767"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;Cannot get here with a non-invariant load!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01768" /><CodeLine lineNumber="1768"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="#ac0e27a6dfaf334669f95954dee3d5920">isEFLAGSDefLive</a>(InitialMI) &amp;&amp;</span></CodeLine>
<Link id="l01769" /><CodeLine lineNumber="1769"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;Cannot get here with a data invariant load &quot;</span></CodeLine>
<Link id="l01770" /><CodeLine lineNumber="1770"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;that interferes with EFLAGS!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01771" /><CodeLine lineNumber="1771"></CodeLine>
<Link id="l01772" /><CodeLine lineNumber="1772"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// See if we can sink hardening the loaded value.</span></CodeLine>
<Link id="l01773" /><CodeLine lineNumber="1773"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> SinkCheckToSingleUse =</span></CodeLine>
<Link id="l01774" /><CodeLine lineNumber="1774"><span class="doxyHighlight">      &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) -&gt; std::optional&lt;MachineInstr &#42;&gt; &#123;</span></CodeLine>
<Link id="l01775" /><CodeLine lineNumber="1775"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/register">Register</a> DefReg = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(0).getReg();</span></CodeLine>
<Link id="l01776" /><CodeLine lineNumber="1776"></CodeLine>
<Link id="l01777" /><CodeLine lineNumber="1777"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We need to find a single use which we can sink the check. We can</span></CodeLine>
<Link id="l01778" /><CodeLine lineNumber="1778"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// primarily do this because many uses may already end up checked on their</span></CodeLine>
<Link id="l01779" /><CodeLine lineNumber="1779"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// own.</span></CodeLine>
<Link id="l01780" /><CodeLine lineNumber="1780"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;SingleUseMI = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01781" /><CodeLine lineNumber="1781"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a> : <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;use&#95;instructions(DefReg)) &#123;</span></CodeLine>
<Link id="l01782" /><CodeLine lineNumber="1782"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If we&#39;re already going to harden this use, it is data invariant, it</span></CodeLine>
<Link id="l01783" /><CodeLine lineNumber="1783"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// does not interfere with EFLAGS, and within our block.</span></CodeLine>
<Link id="l01784" /><CodeLine lineNumber="1784"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (HardenedInstrs.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a1f475b0df44ebd7169e720fa1bf9169e">count</a>(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>)) &#123;</span></CodeLine>
<Link id="l01785" /><CodeLine lineNumber="1785"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/classes/llvm/x86instrinfo/#a34662990aab5992b0b1ee00a4dd4ad34">X86InstrInfo::isDataInvariantLoad</a>(<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>) || <a href="#ac0e27a6dfaf334669f95954dee3d5920">isEFLAGSDefLive</a>(<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>)) &#123;</span></CodeLine>
<Link id="l01786" /><CodeLine lineNumber="1786"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// If we&#39;ve already decided to harden a non-load, we must have sunk</span></CodeLine>
<Link id="l01787" /><CodeLine lineNumber="1787"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// some other post-load hardened instruction to it and it must itself</span></CodeLine>
<Link id="l01788" /><CodeLine lineNumber="1788"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// be data-invariant.</span></CodeLine>
<Link id="l01789" /><CodeLine lineNumber="1789"><span class="doxyHighlight">          <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/llvm/x86instrinfo/#ad4539ba2bb699c968f710984d188246f">X86InstrInfo::isDataInvariant</a>(<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>) &amp;&amp;</span></CodeLine>
<Link id="l01790" /><CodeLine lineNumber="1790"><span class="doxyHighlight">                 </span><span class="doxyHighlightStringLiteral">&quot;Data variant instruction being hardened!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01791" /><CodeLine lineNumber="1791"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01792" /><CodeLine lineNumber="1792"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l01793" /><CodeLine lineNumber="1793"></CodeLine>
<Link id="l01794" /><CodeLine lineNumber="1794"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Otherwise, this is a load and the load component can&#39;t be data</span></CodeLine>
<Link id="l01795" /><CodeLine lineNumber="1795"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// invariant so check how this register is being used.</span></CodeLine>
<Link id="l01796" /><CodeLine lineNumber="1796"><span class="doxyHighlight">        </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> MemRefBeginIdx = <a href="/docs/api/namespaces/llvm/x86/#a279395a00a782f7e3d6141bc3328a249">X86::getFirstAddrOperandIdx</a>(<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>);</span></CodeLine>
<Link id="l01797" /><CodeLine lineNumber="1797"><span class="doxyHighlight">        <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(MemRefBeginIdx &gt;= 0 &amp;&amp;</span></CodeLine>
<Link id="l01798" /><CodeLine lineNumber="1798"><span class="doxyHighlight">               </span><span class="doxyHighlightStringLiteral">&quot;Should always have mem references here!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01799" /><CodeLine lineNumber="1799"></CodeLine>
<Link id="l01800" /><CodeLine lineNumber="1800"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;BaseMO =</span></CodeLine>
<Link id="l01801" /><CodeLine lineNumber="1801"><span class="doxyHighlight">            <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>.getOperand(MemRefBeginIdx + <a href="/docs/api/namespaces/llvm/x86/#a2a5aec578e2e391e99e1705012752d84a319f0e99a1ac9396659683d2638d4f45">X86::AddrBaseReg</a>);</span></CodeLine>
<Link id="l01802" /><CodeLine lineNumber="1802"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/machineoperand">MachineOperand</a> &amp;IndexMO =</span></CodeLine>
<Link id="l01803" /><CodeLine lineNumber="1803"><span class="doxyHighlight">            <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>.getOperand(MemRefBeginIdx + <a href="/docs/api/namespaces/llvm/x86/#a2a5aec578e2e391e99e1705012752d84aba7ebe0e28a2c1c4c14343f549c01462">X86::AddrIndexReg</a>);</span></CodeLine>
<Link id="l01804" /><CodeLine lineNumber="1804"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> ((BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#a4c9594c955fec80c73ddd964b5efd554">isReg</a>() &amp;&amp; BaseMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() == DefReg) ||</span></CodeLine>
<Link id="l01805" /><CodeLine lineNumber="1805"><span class="doxyHighlight">            (IndexMO.<a href="/docs/api/classes/llvm/machineoperand/#a4c9594c955fec80c73ddd964b5efd554">isReg</a>() &amp;&amp; IndexMO.<a href="/docs/api/classes/llvm/machineoperand/#ac0035d7c1c860501c877c20e6e93297b">getReg</a>() == DefReg))</span></CodeLine>
<Link id="l01806" /><CodeLine lineNumber="1806"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// The load uses the register as part of its address making it not</span></CodeLine>
<Link id="l01807" /><CodeLine lineNumber="1807"><span class="doxyHighlight">          </span><span class="doxyHighlightComment">// invariant.</span></CodeLine>
<Link id="l01808" /><CodeLine lineNumber="1808"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &#123;&#125;;</span></CodeLine>
<Link id="l01809" /><CodeLine lineNumber="1809"></CodeLine>
<Link id="l01810" /><CodeLine lineNumber="1810"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01811" /><CodeLine lineNumber="1811"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l01812" /><CodeLine lineNumber="1812"></CodeLine>
<Link id="l01813" /><CodeLine lineNumber="1813"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SingleUseMI)</span></CodeLine>
<Link id="l01814" /><CodeLine lineNumber="1814"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// We already have a single use, this would make two. Bail.</span></CodeLine>
<Link id="l01815" /><CodeLine lineNumber="1815"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &#123;&#125;;</span></CodeLine>
<Link id="l01816" /><CodeLine lineNumber="1816"></CodeLine>
<Link id="l01817" /><CodeLine lineNumber="1817"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If this single use isn&#39;t data invariant, isn&#39;t in this block, or has</span></CodeLine>
<Link id="l01818" /><CodeLine lineNumber="1818"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// interfering EFLAGS, we can&#39;t sink the hardening to it.</span></CodeLine>
<Link id="l01819" /><CodeLine lineNumber="1819"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/classes/llvm/x86instrinfo/#ad4539ba2bb699c968f710984d188246f">X86InstrInfo::isDataInvariant</a>(<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>) || <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>.getParent() != <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getParent() ||</span></CodeLine>
<Link id="l01820" /><CodeLine lineNumber="1820"><span class="doxyHighlight">          <a href="#ac0e27a6dfaf334669f95954dee3d5920">isEFLAGSDefLive</a>(<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>))</span></CodeLine>
<Link id="l01821" /><CodeLine lineNumber="1821"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &#123;&#125;;</span></CodeLine>
<Link id="l01822" /><CodeLine lineNumber="1822"></CodeLine>
<Link id="l01823" /><CodeLine lineNumber="1823"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If this instruction defines multiple registers bail as we won&#39;t harden</span></CodeLine>
<Link id="l01824" /><CodeLine lineNumber="1824"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// all of them.</span></CodeLine>
<Link id="l01825" /><CodeLine lineNumber="1825"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>.getDesc().getNumDefs() &gt; 1)</span></CodeLine>
<Link id="l01826" /><CodeLine lineNumber="1826"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &#123;&#125;;</span></CodeLine>
<Link id="l01827" /><CodeLine lineNumber="1827"></CodeLine>
<Link id="l01828" /><CodeLine lineNumber="1828"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// If this register isn&#39;t a virtual register we can&#39;t walk uses of sanely,</span></CodeLine>
<Link id="l01829" /><CodeLine lineNumber="1829"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// just bail. Also check that its register class is one of the ones we</span></CodeLine>
<Link id="l01830" /><CodeLine lineNumber="1830"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// can harden.</span></CodeLine>
<Link id="l01831" /><CodeLine lineNumber="1831"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/register">Register</a> UseDefReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>.getOperand(0).getReg();</span></CodeLine>
<Link id="l01832" /><CodeLine lineNumber="1832"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!canHardenRegister(UseDefReg))</span></CodeLine>
<Link id="l01833" /><CodeLine lineNumber="1833"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &#123;&#125;;</span></CodeLine>
<Link id="l01834" /><CodeLine lineNumber="1834"></CodeLine>
<Link id="l01835" /><CodeLine lineNumber="1835"><span class="doxyHighlight">      SingleUseMI = &amp;<a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64expandpseudoinsts-cpp/#a6cf2f8996b1e9aaf2d7a435aaa62382f">UseMI</a>;</span></CodeLine>
<Link id="l01836" /><CodeLine lineNumber="1836"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01837" /><CodeLine lineNumber="1837"></CodeLine>
<Link id="l01838" /><CodeLine lineNumber="1838"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If SingleUseMI is still null, there is no use that needs its own</span></CodeLine>
<Link id="l01839" /><CodeLine lineNumber="1839"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// checking. Otherwise, it is the single use that needs checking.</span></CodeLine>
<Link id="l01840" /><CodeLine lineNumber="1840"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &#123;SingleUseMI&#125;;</span></CodeLine>
<Link id="l01841" /><CodeLine lineNumber="1841"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l01842" /><CodeLine lineNumber="1842"></CodeLine>
<Link id="l01843" /><CodeLine lineNumber="1843"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &#42;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> = &amp;InitialMI;</span></CodeLine>
<Link id="l01844" /><CodeLine lineNumber="1844"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">while</span><span class="doxyHighlight"> (std::optional&lt;MachineInstr &#42;&gt; SingleUse = SinkCheckToSingleUse(&#42;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>)) &#123;</span></CodeLine>
<Link id="l01845" /><CodeLine lineNumber="1845"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Update which MI we&#39;re checking now.</span></CodeLine>
<Link id="l01846" /><CodeLine lineNumber="1846"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a> = &#42;SingleUse;</span></CodeLine>
<Link id="l01847" /><CodeLine lineNumber="1847"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>)</span></CodeLine>
<Link id="l01848" /><CodeLine lineNumber="1848"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01849" /><CodeLine lineNumber="1849"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01850" /><CodeLine lineNumber="1850"></CodeLine>
<Link id="l01851" /><CodeLine lineNumber="1851"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>;</span></CodeLine>
<Link id="l01852" /><CodeLine lineNumber="1852"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01853" /><CodeLine lineNumber="1853"></CodeLine>
<Link id="l01854" /><CodeLine lineNumber="1854"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> X86SpeculativeLoadHardeningPass::canHardenRegister(<a href="/docs/api/classes/llvm/register">Register</a> <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>) &#123;</span></CodeLine>
<Link id="l01855" /><CodeLine lineNumber="1855"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We only support hardening virtual registers.</span></CodeLine>
<Link id="l01856" /><CodeLine lineNumber="1856"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>.isVirtual())</span></CodeLine>
<Link id="l01857" /><CodeLine lineNumber="1857"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01858" /><CodeLine lineNumber="1858"></CodeLine>
<Link id="l01859" /><CodeLine lineNumber="1859"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;RC = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;getRegClass(<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>);</span></CodeLine>
<Link id="l01860" /><CodeLine lineNumber="1860"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> RegBytes = <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>-&gt;getRegSizeInBits(&#42;RC) / 8;</span></CodeLine>
<Link id="l01861" /><CodeLine lineNumber="1861"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (RegBytes &gt; 8)</span></CodeLine>
<Link id="l01862" /><CodeLine lineNumber="1862"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We don&#39;t support post-load hardening of vectors.</span></CodeLine>
<Link id="l01863" /><CodeLine lineNumber="1863"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01864" /><CodeLine lineNumber="1864"></CodeLine>
<Link id="l01865" /><CodeLine lineNumber="1865"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> RegIdx = <a href="/docs/api/namespaces/llvm/#a646986783f35e0fef8988f0f28d2589f">Log2&#95;32</a>(RegBytes);</span></CodeLine>
<Link id="l01866" /><CodeLine lineNumber="1866"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(RegIdx &lt; 4 &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Unsupported register size&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01867" /><CodeLine lineNumber="1867"></CodeLine>
<Link id="l01868" /><CodeLine lineNumber="1868"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If this register class is explicitly constrained to a class that doesn&#39;t</span></CodeLine>
<Link id="l01869" /><CodeLine lineNumber="1869"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// require REX prefix, we may not be able to satisfy that constraint when</span></CodeLine>
<Link id="l01870" /><CodeLine lineNumber="1870"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// emitting the hardening instructions, so bail out here.</span></CodeLine>
<Link id="l01871" /><CodeLine lineNumber="1871"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// FIXME: This seems like a pretty lame hack. The way this comes up is when we</span></CodeLine>
<Link id="l01872" /><CodeLine lineNumber="1872"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// end up both with a NOREX and REX-only register as operands to the hardening</span></CodeLine>
<Link id="l01873" /><CodeLine lineNumber="1873"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// instructions. It would be better to fix that code to handle this situation</span></CodeLine>
<Link id="l01874" /><CodeLine lineNumber="1874"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// rather than hack around it in this way.</span></CodeLine>
<Link id="l01875" /><CodeLine lineNumber="1875"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/targetregisterclass">TargetRegisterClass</a> &#42;NOREXRegClasses&#91;&#93; = &#123;</span></CodeLine>
<Link id="l01876" /><CodeLine lineNumber="1876"><span class="doxyHighlight">      &amp;X86::GR8&#95;NOREXRegClass, &amp;X86::GR16&#95;NOREXRegClass,</span></CodeLine>
<Link id="l01877" /><CodeLine lineNumber="1877"><span class="doxyHighlight">      &amp;X86::GR32&#95;NOREXRegClass, &amp;X86::GR64&#95;NOREXRegClass&#125;;</span></CodeLine>
<Link id="l01878" /><CodeLine lineNumber="1878"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (RC == NOREXRegClasses&#91;RegIdx&#93;)</span></CodeLine>
<Link id="l01879" /><CodeLine lineNumber="1879"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01880" /><CodeLine lineNumber="1880"></CodeLine>
<Link id="l01881" /><CodeLine lineNumber="1881"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/targetregisterclass">TargetRegisterClass</a> &#42;GPRRegClasses&#91;&#93; = &#123;</span></CodeLine>
<Link id="l01882" /><CodeLine lineNumber="1882"><span class="doxyHighlight">      &amp;X86::GR8RegClass, &amp;X86::GR16RegClass, &amp;X86::GR32RegClass,</span></CodeLine>
<Link id="l01883" /><CodeLine lineNumber="1883"><span class="doxyHighlight">      &amp;X86::GR64RegClass&#125;;</span></CodeLine>
<Link id="l01884" /><CodeLine lineNumber="1884"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> RC-&gt;<a href="/docs/api/classes/llvm/targetregisterclass/#abee1c3236731101b249f6eeffd8cd7ba">hasSuperClassEq</a>(GPRRegClasses&#91;RegIdx&#93;);</span></CodeLine>
<Link id="l01885" /><CodeLine lineNumber="1885"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01886" /><CodeLine lineNumber="1886"></CodeLine>
<Link id="l01887" /><CodeLine lineNumber="1887"><span class="doxyHighlightComment">/// Harden a value in a register.</span></CodeLine>
<Link id="l01888" /><CodeLine lineNumber="1888"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01889" /><CodeLine lineNumber="1889"><span class="doxyHighlightComment">/// This is the low-level logic to fully harden a value sitting in a register</span></CodeLine>
<Link id="l01890" /><CodeLine lineNumber="1890"><span class="doxyHighlightComment">/// against leaking during speculative execution.</span></CodeLine>
<Link id="l01891" /><CodeLine lineNumber="1891"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01892" /><CodeLine lineNumber="1892"><span class="doxyHighlightComment">/// Unlike hardening an address that is used by a load, this routine is required</span></CodeLine>
<Link id="l01893" /><CodeLine lineNumber="1893"><span class="doxyHighlightComment">/// to hide &#42;all&#42; incoming bits in the register.</span></CodeLine>
<Link id="l01894" /><CodeLine lineNumber="1894"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01895" /><CodeLine lineNumber="1895"><span class="doxyHighlightComment">/// &#96;Reg&#96; must be a virtual register. Currently, it is required to be a GPR no</span></CodeLine>
<Link id="l01896" /><CodeLine lineNumber="1896"><span class="doxyHighlightComment">/// larger than the predicate state register. FIXME: We should support vector</span></CodeLine>
<Link id="l01897" /><CodeLine lineNumber="1897"><span class="doxyHighlightComment">/// registers here by broadcasting the predicate state.</span></CodeLine>
<Link id="l01898" /><CodeLine lineNumber="1898"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01899" /><CodeLine lineNumber="1899"><span class="doxyHighlightComment">/// The new, hardened virtual register is returned. It will have the same</span></CodeLine>
<Link id="l01900" /><CodeLine lineNumber="1900"><span class="doxyHighlightComment">/// register class as &#96;Reg&#96;.</span></CodeLine>
<Link id="l01901" /><CodeLine lineNumber="1901"><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> X86SpeculativeLoadHardeningPass::hardenValueInRegister(</span></CodeLine>
<Link id="l01902" /><CodeLine lineNumber="1902"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/register">Register</a> <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>, <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, <a href="/docs/api/classes/llvm/machinebasicblock/#ae34c996b58df9b9ce6695a0c8b70c533">MachineBasicBlock::iterator</a> InsertPt,</span></CodeLine>
<Link id="l01903" /><CodeLine lineNumber="1903"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> &amp;<a href="/docs/api/namespaces/llvm/loc">Loc</a>) &#123;</span></CodeLine>
<Link id="l01904" /><CodeLine lineNumber="1904"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(canHardenRegister(<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>) &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Cannot harden this register!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01905" /><CodeLine lineNumber="1905"></CodeLine>
<Link id="l01906" /><CodeLine lineNumber="1906"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;RC = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;getRegClass(<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>);</span></CodeLine>
<Link id="l01907" /><CodeLine lineNumber="1907"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> Bytes = <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>-&gt;getRegSizeInBits(&#42;RC) / 8;</span></CodeLine>
<Link id="l01908" /><CodeLine lineNumber="1908"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/register">Register</a> StateReg = PS-&gt;SSA.GetValueAtEndOfBlock(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</span></CodeLine>
<Link id="l01909" /><CodeLine lineNumber="1909"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((Bytes == 1 || Bytes == 2 || Bytes == 4 || Bytes == 8) &amp;&amp;</span></CodeLine>
<Link id="l01910" /><CodeLine lineNumber="1910"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;Unknown register size&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01911" /><CodeLine lineNumber="1911"></CodeLine>
<Link id="l01912" /><CodeLine lineNumber="1912"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// FIXME: Need to teach this about 32-bit mode.</span></CodeLine>
<Link id="l01913" /><CodeLine lineNumber="1913"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Bytes != 8) &#123;</span></CodeLine>
<Link id="l01914" /><CodeLine lineNumber="1914"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> SubRegImms&#91;&#93; = &#123;X86::sub&#95;8bit, X86::sub&#95;16bit, X86::sub&#95;32bit&#125;;</span></CodeLine>
<Link id="l01915" /><CodeLine lineNumber="1915"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> SubRegImm = SubRegImms&#91;<a href="/docs/api/namespaces/llvm/#a646986783f35e0fef8988f0f28d2589f">Log2&#95;32</a>(Bytes)&#93;;</span></CodeLine>
<Link id="l01916" /><CodeLine lineNumber="1916"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/register">Register</a> NarrowStateReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(RC);</span></CodeLine>
<Link id="l01917" /><CodeLine lineNumber="1917"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(TargetOpcode::COPY), NarrowStateReg)</span></CodeLine>
<Link id="l01918" /><CodeLine lineNumber="1918"><span class="doxyHighlight">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(StateReg, 0, SubRegImm);</span></CodeLine>
<Link id="l01919" /><CodeLine lineNumber="1919"><span class="doxyHighlight">    StateReg = NarrowStateReg;</span></CodeLine>
<Link id="l01920" /><CodeLine lineNumber="1920"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01921" /><CodeLine lineNumber="1921"></CodeLine>
<Link id="l01922" /><CodeLine lineNumber="1922"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> FlagsReg = 0;</span></CodeLine>
<Link id="l01923" /><CodeLine lineNumber="1923"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a93f8e5dacbcd949d688c3af5f491468d">isEFLAGSLive</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, &#42;<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>))</span></CodeLine>
<Link id="l01924" /><CodeLine lineNumber="1924"><span class="doxyHighlight">    FlagsReg = saveEFLAGS(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>);</span></CodeLine>
<Link id="l01925" /><CodeLine lineNumber="1925"></CodeLine>
<Link id="l01926" /><CodeLine lineNumber="1926"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/register">Register</a> NewReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(RC);</span></CodeLine>
<Link id="l01927" /><CodeLine lineNumber="1927"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> OrOpCodes&#91;&#93; = &#123;X86::OR8rr, X86::OR16rr, X86::OR32rr, X86::OR64rr&#125;;</span></CodeLine>
<Link id="l01928" /><CodeLine lineNumber="1928"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> OrOpCode = OrOpCodes&#91;<a href="/docs/api/namespaces/llvm/#a646986783f35e0fef8988f0f28d2589f">Log2&#95;32</a>(Bytes)&#93;;</span></CodeLine>
<Link id="l01929" /><CodeLine lineNumber="1929"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> OrI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(OrOpCode), NewReg)</span></CodeLine>
<Link id="l01930" /><CodeLine lineNumber="1930"><span class="doxyHighlight">                 .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(StateReg)</span></CodeLine>
<Link id="l01931" /><CodeLine lineNumber="1931"><span class="doxyHighlight">                 .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(<a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a359e1ff26f6d466d927a61aae45b05c3">Reg</a>);</span></CodeLine>
<Link id="l01932" /><CodeLine lineNumber="1932"><span class="doxyHighlight">  OrI-&gt;<a href="/docs/api/classes/llvm/machineinstr/#afda2c0f22be043ae42b0ec71b661f565">addRegisterDead</a>(X86::EFLAGS, <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>);</span></CodeLine>
<Link id="l01933" /><CodeLine lineNumber="1933"><span class="doxyHighlight">  ++NumInstsInserted;</span></CodeLine>
<Link id="l01934" /><CodeLine lineNumber="1934"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Inserting or: &quot;</span><span class="doxyHighlight">; OrI-&gt;dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01935" /><CodeLine lineNumber="1935"></CodeLine>
<Link id="l01936" /><CodeLine lineNumber="1936"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FlagsReg)</span></CodeLine>
<Link id="l01937" /><CodeLine lineNumber="1937"><span class="doxyHighlight">    restoreEFLAGS(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, FlagsReg);</span></CodeLine>
<Link id="l01938" /><CodeLine lineNumber="1938"></CodeLine>
<Link id="l01939" /><CodeLine lineNumber="1939"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> NewReg;</span></CodeLine>
<Link id="l01940" /><CodeLine lineNumber="1940"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01941" /><CodeLine lineNumber="1941"></CodeLine>
<Link id="l01942" /><CodeLine lineNumber="1942"><span class="doxyHighlightComment">/// Harden a load by hardening the loaded value in the defined register.</span></CodeLine>
<Link id="l01943" /><CodeLine lineNumber="1943"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01944" /><CodeLine lineNumber="1944"><span class="doxyHighlightComment">/// We can harden a non-leaking load into a register without touching the</span></CodeLine>
<Link id="l01945" /><CodeLine lineNumber="1945"><span class="doxyHighlightComment">/// address by just hiding all of the loaded bits during misspeculation. We use</span></CodeLine>
<Link id="l01946" /><CodeLine lineNumber="1946"><span class="doxyHighlightComment">/// an &#96;or&#96; instruction to do this because we set up our poison value as all</span></CodeLine>
<Link id="l01947" /><CodeLine lineNumber="1947"><span class="doxyHighlightComment">/// ones. And the goal is just for the loaded bits to not be exposed to</span></CodeLine>
<Link id="l01948" /><CodeLine lineNumber="1948"><span class="doxyHighlightComment">/// execution and coercing them to one is sufficient.</span></CodeLine>
<Link id="l01949" /><CodeLine lineNumber="1949"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01950" /><CodeLine lineNumber="1950"><span class="doxyHighlightComment">/// Returns the newly hardened register.</span></CodeLine>
<Link id="l01951" /><CodeLine lineNumber="1951"><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> X86SpeculativeLoadHardeningPass::hardenPostLoad(<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) &#123;</span></CodeLine>
<Link id="l01952" /><CodeLine lineNumber="1952"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> = &#42;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getParent();</span></CodeLine>
<Link id="l01953" /><CodeLine lineNumber="1953"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> &amp;<a href="/docs/api/namespaces/llvm/loc">Loc</a> = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getDebugLoc();</span></CodeLine>
<Link id="l01954" /><CodeLine lineNumber="1954"></CodeLine>
<Link id="l01955" /><CodeLine lineNumber="1955"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;DefOp = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(0);</span></CodeLine>
<Link id="l01956" /><CodeLine lineNumber="1956"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/register">Register</a> OldDefReg = DefOp.getReg();</span></CodeLine>
<Link id="l01957" /><CodeLine lineNumber="1957"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;DefRC = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;getRegClass(OldDefReg);</span></CodeLine>
<Link id="l01958" /><CodeLine lineNumber="1958"></CodeLine>
<Link id="l01959" /><CodeLine lineNumber="1959"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Because we want to completely replace the uses of this def&#39;ed value with</span></CodeLine>
<Link id="l01960" /><CodeLine lineNumber="1960"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the hardened value, create a dedicated new register that will only be used</span></CodeLine>
<Link id="l01961" /><CodeLine lineNumber="1961"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// to communicate the unhardened value to the hardening.</span></CodeLine>
<Link id="l01962" /><CodeLine lineNumber="1962"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/register">Register</a> UnhardenedReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(DefRC);</span></CodeLine>
<Link id="l01963" /><CodeLine lineNumber="1963"><span class="doxyHighlight">  DefOp.setReg(UnhardenedReg);</span></CodeLine>
<Link id="l01964" /><CodeLine lineNumber="1964"></CodeLine>
<Link id="l01965" /><CodeLine lineNumber="1965"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Now harden this register&#39;s value, getting a hardened reg that is safe to</span></CodeLine>
<Link id="l01966" /><CodeLine lineNumber="1966"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// use. Note that we insert the instructions to compute this &#42;after&#42; the</span></CodeLine>
<Link id="l01967" /><CodeLine lineNumber="1967"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// defining instruction, not before it.</span></CodeLine>
<Link id="l01968" /><CodeLine lineNumber="1968"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> HardenedReg = hardenValueInRegister(</span></CodeLine>
<Link id="l01969" /><CodeLine lineNumber="1969"><span class="doxyHighlight">      UnhardenedReg, <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, std::next(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getIterator()), <a href="/docs/api/namespaces/llvm/loc">Loc</a>);</span></CodeLine>
<Link id="l01970" /><CodeLine lineNumber="1970"></CodeLine>
<Link id="l01971" /><CodeLine lineNumber="1971"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Finally, replace the old register (which now only has the uses of the</span></CodeLine>
<Link id="l01972" /><CodeLine lineNumber="1972"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// original def) with the hardened register.</span></CodeLine>
<Link id="l01973" /><CodeLine lineNumber="1973"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;replaceRegWith(</span><span class="doxyHighlightComment">/&#42;FromReg&#42;/</span><span class="doxyHighlight"> OldDefReg, </span><span class="doxyHighlightComment">/&#42;ToReg&#42;/</span><span class="doxyHighlight"> HardenedReg);</span></CodeLine>
<Link id="l01974" /><CodeLine lineNumber="1974"></CodeLine>
<Link id="l01975" /><CodeLine lineNumber="1975"><span class="doxyHighlight">  ++NumPostLoadRegsHardened;</span></CodeLine>
<Link id="l01976" /><CodeLine lineNumber="1976"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> HardenedReg;</span></CodeLine>
<Link id="l01977" /><CodeLine lineNumber="1977"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l01978" /><CodeLine lineNumber="1978"></CodeLine>
<Link id="l01979" /><CodeLine lineNumber="1979"><span class="doxyHighlightComment">/// Harden a return instruction.</span></CodeLine>
<Link id="l01980" /><CodeLine lineNumber="1980"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01981" /><CodeLine lineNumber="1981"><span class="doxyHighlightComment">/// Returns implicitly perform a load which we need to harden. Without hardening</span></CodeLine>
<Link id="l01982" /><CodeLine lineNumber="1982"><span class="doxyHighlightComment">/// this load, an attacker my speculatively write over the return address to</span></CodeLine>
<Link id="l01983" /><CodeLine lineNumber="1983"><span class="doxyHighlightComment">/// steer speculation of the return to an attacker controlled address. This is</span></CodeLine>
<Link id="l01984" /><CodeLine lineNumber="1984"><span class="doxyHighlightComment">/// called Spectre v1.1 or Bounds Check Bypass Store (BCBS) and is described in</span></CodeLine>
<Link id="l01985" /><CodeLine lineNumber="1985"><span class="doxyHighlightComment">/// this paper:</span></CodeLine>
<Link id="l01986" /><CodeLine lineNumber="1986"><span class="doxyHighlightComment">/// https://people.csail.mit.edu/vlk/spectre11.pdf</span></CodeLine>
<Link id="l01987" /><CodeLine lineNumber="1987"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01988" /><CodeLine lineNumber="1988"><span class="doxyHighlightComment">/// We can harden this by introducing an LFENCE that will delay any load of the</span></CodeLine>
<Link id="l01989" /><CodeLine lineNumber="1989"><span class="doxyHighlightComment">/// return address until prior instructions have retired (and thus are not being</span></CodeLine>
<Link id="l01990" /><CodeLine lineNumber="1990"><span class="doxyHighlightComment">/// speculated), or we can harden the address used by the implicit load: the</span></CodeLine>
<Link id="l01991" /><CodeLine lineNumber="1991"><span class="doxyHighlightComment">/// stack pointer.</span></CodeLine>
<Link id="l01992" /><CodeLine lineNumber="1992"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l01993" /><CodeLine lineNumber="1993"><span class="doxyHighlightComment">/// If we are not using an LFENCE, hardening the stack pointer has an additional</span></CodeLine>
<Link id="l01994" /><CodeLine lineNumber="1994"><span class="doxyHighlightComment">/// benefit: it allows us to pass the predicate state accumulated in this</span></CodeLine>
<Link id="l01995" /><CodeLine lineNumber="1995"><span class="doxyHighlightComment">/// function back to the caller. In the absence of a BCBS attack on the return,</span></CodeLine>
<Link id="l01996" /><CodeLine lineNumber="1996"><span class="doxyHighlightComment">/// the caller will typically be resumed and speculatively executed due to the</span></CodeLine>
<Link id="l01997" /><CodeLine lineNumber="1997"><span class="doxyHighlightComment">/// Return Stack Buffer (RSB) prediction which is very accurate and has a high</span></CodeLine>
<Link id="l01998" /><CodeLine lineNumber="1998"><span class="doxyHighlightComment">/// priority. It is possible that some code from the caller will be executed</span></CodeLine>
<Link id="l01999" /><CodeLine lineNumber="1999"><span class="doxyHighlightComment">/// speculatively even during a BCBS-attacked return until the steering takes</span></CodeLine>
<Link id="l02000" /><CodeLine lineNumber="2000"><span class="doxyHighlightComment">/// effect. Whenever this happens, the caller can recover the (poisoned)</span></CodeLine>
<Link id="l02001" /><CodeLine lineNumber="2001"><span class="doxyHighlightComment">/// predicate state from the stack pointer and continue to harden loads.</span></CodeLine>
<Link id="l02002" /><CodeLine lineNumber="2002"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> X86SpeculativeLoadHardeningPass::hardenReturnInstr(<a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) &#123;</span></CodeLine>
<Link id="l02003" /><CodeLine lineNumber="2003"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> = &#42;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getParent();</span></CodeLine>
<Link id="l02004" /><CodeLine lineNumber="2004"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> &amp;<a href="/docs/api/namespaces/llvm/loc">Loc</a> = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getDebugLoc();</span></CodeLine>
<Link id="l02005" /><CodeLine lineNumber="2005"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> InsertPt = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getIterator();</span></CodeLine>
<Link id="l02006" /><CodeLine lineNumber="2006"></CodeLine>
<Link id="l02007" /><CodeLine lineNumber="2007"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a5ee11464d0d2e030d95afb0db83b801d">FenceCallAndRet</a>)</span></CodeLine>
<Link id="l02008" /><CodeLine lineNumber="2008"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// No need to fence here as we&#39;ll fence at the return site itself. That</span></CodeLine>
<Link id="l02009" /><CodeLine lineNumber="2009"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// handles more cases than we can handle here.</span></CodeLine>
<Link id="l02010" /><CodeLine lineNumber="2010"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02011" /><CodeLine lineNumber="2011"></CodeLine>
<Link id="l02012" /><CodeLine lineNumber="2012"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Take our predicate state, shift it to the high 17 bits (so that we keep</span></CodeLine>
<Link id="l02013" /><CodeLine lineNumber="2013"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// pointers canonical) and merge it into RSP. This will allow the caller to</span></CodeLine>
<Link id="l02014" /><CodeLine lineNumber="2014"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// extract it when we return (speculatively).</span></CodeLine>
<Link id="l02015" /><CodeLine lineNumber="2015"><span class="doxyHighlight">  mergePredStateIntoSP(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, PS-&gt;SSA.GetValueAtEndOfBlock(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>));</span></CodeLine>
<Link id="l02016" /><CodeLine lineNumber="2016"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02017" /><CodeLine lineNumber="2017"></CodeLine>
<Link id="l02018" /><CodeLine lineNumber="2018"><span class="doxyHighlightComment">/// Trace the predicate state through a call.</span></CodeLine>
<Link id="l02019" /><CodeLine lineNumber="2019"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l02020" /><CodeLine lineNumber="2020"><span class="doxyHighlightComment">/// There are several layers of this needed to handle the full complexity of</span></CodeLine>
<Link id="l02021" /><CodeLine lineNumber="2021"><span class="doxyHighlightComment">/// calls.</span></CodeLine>
<Link id="l02022" /><CodeLine lineNumber="2022"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l02023" /><CodeLine lineNumber="2023"><span class="doxyHighlightComment">/// First, we need to send the predicate state into the called function. We do</span></CodeLine>
<Link id="l02024" /><CodeLine lineNumber="2024"><span class="doxyHighlightComment">/// this by merging it into the high bits of the stack pointer.</span></CodeLine>
<Link id="l02025" /><CodeLine lineNumber="2025"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l02026" /><CodeLine lineNumber="2026"><span class="doxyHighlightComment">/// For tail calls, this is all we need to do.</span></CodeLine>
<Link id="l02027" /><CodeLine lineNumber="2027"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l02028" /><CodeLine lineNumber="2028"><span class="doxyHighlightComment">/// For calls where we might return and resume the control flow, we need to</span></CodeLine>
<Link id="l02029" /><CodeLine lineNumber="2029"><span class="doxyHighlightComment">/// extract the predicate state from the high bits of the stack pointer after</span></CodeLine>
<Link id="l02030" /><CodeLine lineNumber="2030"><span class="doxyHighlightComment">/// control returns from the called function.</span></CodeLine>
<Link id="l02031" /><CodeLine lineNumber="2031"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l02032" /><CodeLine lineNumber="2032"><span class="doxyHighlightComment">/// We also need to verify that we intended to return to this location in the</span></CodeLine>
<Link id="l02033" /><CodeLine lineNumber="2033"><span class="doxyHighlightComment">/// code. An attacker might arrange for the processor to mispredict the return</span></CodeLine>
<Link id="l02034" /><CodeLine lineNumber="2034"><span class="doxyHighlightComment">/// to this valid but incorrect return address in the program rather than the</span></CodeLine>
<Link id="l02035" /><CodeLine lineNumber="2035"><span class="doxyHighlightComment">/// correct one. See the paper on this attack, called &quot;ret2spec&quot; by the</span></CodeLine>
<Link id="l02036" /><CodeLine lineNumber="2036"><span class="doxyHighlightComment">/// researchers, here:</span></CodeLine>
<Link id="l02037" /><CodeLine lineNumber="2037"><span class="doxyHighlightComment">/// https://christian-rossow.de/publications/ret2spec-ccs2018.pdf</span></CodeLine>
<Link id="l02038" /><CodeLine lineNumber="2038"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l02039" /><CodeLine lineNumber="2039"><span class="doxyHighlightComment">/// The way we verify that we returned to the correct location is by preserving</span></CodeLine>
<Link id="l02040" /><CodeLine lineNumber="2040"><span class="doxyHighlightComment">/// the expected return address across the call. One technique involves taking</span></CodeLine>
<Link id="l02041" /><CodeLine lineNumber="2041"><span class="doxyHighlightComment">/// advantage of the red-zone to load the return address from &#96;8(%rsp)&#96; where it</span></CodeLine>
<Link id="l02042" /><CodeLine lineNumber="2042"><span class="doxyHighlightComment">/// was left by the RET instruction when it popped &#96;%rsp&#96;. Alternatively, we can</span></CodeLine>
<Link id="l02043" /><CodeLine lineNumber="2043"><span class="doxyHighlightComment">/// directly save the address into a register that will be preserved across the</span></CodeLine>
<Link id="l02044" /><CodeLine lineNumber="2044"><span class="doxyHighlightComment">/// call. We compare this intended return address against the address</span></CodeLine>
<Link id="l02045" /><CodeLine lineNumber="2045"><span class="doxyHighlightComment">/// immediately following the call (the observed return address). If these</span></CodeLine>
<Link id="l02046" /><CodeLine lineNumber="2046"><span class="doxyHighlightComment">/// mismatch, we have detected misspeculation and can poison our predicate</span></CodeLine>
<Link id="l02047" /><CodeLine lineNumber="2047"><span class="doxyHighlightComment">/// state.</span></CodeLine>
<Link id="l02048" /><CodeLine lineNumber="2048"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> X86SpeculativeLoadHardeningPass::tracePredStateThroughCall(</span></CodeLine>
<Link id="l02049" /><CodeLine lineNumber="2049"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>) &#123;</span></CodeLine>
<Link id="l02050" /><CodeLine lineNumber="2050"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinebasicblock">MachineBasicBlock</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a> = &#42;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getParent();</span></CodeLine>
<Link id="l02051" /><CodeLine lineNumber="2051"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/machinefunction">MachineFunction</a> &amp;MF = &#42;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.getParent();</span></CodeLine>
<Link id="l02052" /><CodeLine lineNumber="2052"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> InsertPt = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getIterator();</span></CodeLine>
<Link id="l02053" /><CodeLine lineNumber="2053"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/debugloc">DebugLoc</a> &amp;<a href="/docs/api/namespaces/llvm/loc">Loc</a> = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getDebugLoc();</span></CodeLine>
<Link id="l02054" /><CodeLine lineNumber="2054"></CodeLine>
<Link id="l02055" /><CodeLine lineNumber="2055"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a5ee11464d0d2e030d95afb0db83b801d">FenceCallAndRet</a>) &#123;</span></CodeLine>
<Link id="l02056" /><CodeLine lineNumber="2056"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isReturn())</span></CodeLine>
<Link id="l02057" /><CodeLine lineNumber="2057"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Tail call, we don&#39;t return to this function.</span></CodeLine>
<Link id="l02058" /><CodeLine lineNumber="2058"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// FIXME: We should also handle noreturn calls.</span></CodeLine>
<Link id="l02059" /><CodeLine lineNumber="2059"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02060" /><CodeLine lineNumber="2060"></CodeLine>
<Link id="l02061" /><CodeLine lineNumber="2061"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We don&#39;t need to fence before the call because the function should fence</span></CodeLine>
<Link id="l02062" /><CodeLine lineNumber="2062"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// in its entry. However, we do need to fence after the call returns.</span></CodeLine>
<Link id="l02063" /><CodeLine lineNumber="2063"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Fencing before the return doesn&#39;t correctly handle cases where the return</span></CodeLine>
<Link id="l02064" /><CodeLine lineNumber="2064"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// itself is mispredicted.</span></CodeLine>
<Link id="l02065" /><CodeLine lineNumber="2065"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, std::next(InsertPt), <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::LFENCE));</span></CodeLine>
<Link id="l02066" /><CodeLine lineNumber="2066"><span class="doxyHighlight">    ++NumInstsInserted;</span></CodeLine>
<Link id="l02067" /><CodeLine lineNumber="2067"><span class="doxyHighlight">    ++NumLFENCEsInserted;</span></CodeLine>
<Link id="l02068" /><CodeLine lineNumber="2068"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02069" /><CodeLine lineNumber="2069"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02070" /><CodeLine lineNumber="2070"></CodeLine>
<Link id="l02071" /><CodeLine lineNumber="2071"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// First, we transfer the predicate state into the called function by merging</span></CodeLine>
<Link id="l02072" /><CodeLine lineNumber="2072"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// it into the stack pointer. This will kill the current def of the state.</span></CodeLine>
<Link id="l02073" /><CodeLine lineNumber="2073"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/register">Register</a> StateReg = PS-&gt;SSA.GetValueAtEndOfBlock(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>);</span></CodeLine>
<Link id="l02074" /><CodeLine lineNumber="2074"><span class="doxyHighlight">  mergePredStateIntoSP(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, StateReg);</span></CodeLine>
<Link id="l02075" /><CodeLine lineNumber="2075"></CodeLine>
<Link id="l02076" /><CodeLine lineNumber="2076"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If this call is also a return, it is a tail call and we don&#39;t need anything</span></CodeLine>
<Link id="l02077" /><CodeLine lineNumber="2077"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// else to handle it so just return. Also, if there are no further</span></CodeLine>
<Link id="l02078" /><CodeLine lineNumber="2078"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// instructions and no successors, this call does not return so we can also</span></CodeLine>
<Link id="l02079" /><CodeLine lineNumber="2079"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// bail.</span></CodeLine>
<Link id="l02080" /><CodeLine lineNumber="2080"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.isReturn() || (std::next(InsertPt) == <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.end() &amp;&amp; <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>.succ&#95;empty()))</span></CodeLine>
<Link id="l02081" /><CodeLine lineNumber="2081"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02082" /><CodeLine lineNumber="2082"></CodeLine>
<Link id="l02083" /><CodeLine lineNumber="2083"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create a symbol to track the return address and attach it to the call</span></CodeLine>
<Link id="l02084" /><CodeLine lineNumber="2084"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// machine instruction. We will lower extra symbols attached to call</span></CodeLine>
<Link id="l02085" /><CodeLine lineNumber="2085"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// instructions as label immediately following the call.</span></CodeLine>
<Link id="l02086" /><CodeLine lineNumber="2086"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/mcsymbol">MCSymbol</a> &#42;RetSymbol =</span></CodeLine>
<Link id="l02087" /><CodeLine lineNumber="2087"><span class="doxyHighlight">      MF.<a href="/docs/api/classes/llvm/machinefunction/#a752546c51633c140d9ca4ab98b4781b6">getContext</a>().<a href="/docs/api/classes/llvm/mccontext/#a299bf2f0329389424760f4a7c8af75ac">createTempSymbol</a>(</span><span class="doxyHighlightStringLiteral">&quot;slh&#95;ret&#95;addr&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l02088" /><CodeLine lineNumber="2088"><span class="doxyHighlight">                                       </span><span class="doxyHighlightComment">/&#42;AlwaysAddSuffix&#42;/</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02089" /><CodeLine lineNumber="2089"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.setPostInstrSymbol(MF, RetSymbol);</span></CodeLine>
<Link id="l02090" /><CodeLine lineNumber="2090"></CodeLine>
<Link id="l02091" /><CodeLine lineNumber="2091"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/targetregisterclass">TargetRegisterClass</a> &#42;AddrRC = &amp;X86::GR64RegClass;</span></CodeLine>
<Link id="l02092" /><CodeLine lineNumber="2092"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> ExpectedRetAddrReg = 0;</span></CodeLine>
<Link id="l02093" /><CodeLine lineNumber="2093"></CodeLine>
<Link id="l02094" /><CodeLine lineNumber="2094"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we have no red zones or if the function returns twice (possibly without</span></CodeLine>
<Link id="l02095" /><CodeLine lineNumber="2095"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// using the &#96;ret&#96; instruction) like setjmp, we need to save the expected</span></CodeLine>
<Link id="l02096" /><CodeLine lineNumber="2096"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// return address prior to the call.</span></CodeLine>
<Link id="l02097" /><CodeLine lineNumber="2097"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Subtarget-&gt;getFrameLowering()-&gt;has128ByteRedZone(MF) ||</span></CodeLine>
<Link id="l02098" /><CodeLine lineNumber="2098"><span class="doxyHighlight">      MF.<a href="/docs/api/classes/llvm/machinefunction/#a4b94e0ca517e149914aa0c34ee06c9fa">exposesReturnsTwice</a>()) &#123;</span></CodeLine>
<Link id="l02099" /><CodeLine lineNumber="2099"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If we don&#39;t have red zones, we need to compute the expected return</span></CodeLine>
<Link id="l02100" /><CodeLine lineNumber="2100"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// address prior to the call and store it in a register that lives across</span></CodeLine>
<Link id="l02101" /><CodeLine lineNumber="2101"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// the call.</span></CodeLine>
<Link id="l02102" /><CodeLine lineNumber="2102"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l02103" /><CodeLine lineNumber="2103"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// In some ways, this is doubly satisfying as a mitigation because it will</span></CodeLine>
<Link id="l02104" /><CodeLine lineNumber="2104"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// also successfully detect stack smashing bugs in some cases (typically,</span></CodeLine>
<Link id="l02105" /><CodeLine lineNumber="2105"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// when a callee-saved register is used and the callee doesn&#39;t push it onto</span></CodeLine>
<Link id="l02106" /><CodeLine lineNumber="2106"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// the stack). But that isn&#39;t our primary goal, so we only use it as</span></CodeLine>
<Link id="l02107" /><CodeLine lineNumber="2107"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// a fallback.</span></CodeLine>
<Link id="l02108" /><CodeLine lineNumber="2108"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l02109" /><CodeLine lineNumber="2109"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// FIXME: It isn&#39;t clear that this is reliable in the face of</span></CodeLine>
<Link id="l02110" /><CodeLine lineNumber="2110"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// rematerialization in the register allocator. We somehow need to force</span></CodeLine>
<Link id="l02111" /><CodeLine lineNumber="2111"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// that to not occur for this particular instruction, and instead to spill</span></CodeLine>
<Link id="l02112" /><CodeLine lineNumber="2112"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// or otherwise preserve the value computed &#42;prior&#42; to the call.</span></CodeLine>
<Link id="l02113" /><CodeLine lineNumber="2113"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l02114" /><CodeLine lineNumber="2114"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// FIXME: It is even less clear why MachineCSE can&#39;t just fold this when we</span></CodeLine>
<Link id="l02115" /><CodeLine lineNumber="2115"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// end up having to use identical instructions both before and after the</span></CodeLine>
<Link id="l02116" /><CodeLine lineNumber="2116"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// call to feed the comparison.</span></CodeLine>
<Link id="l02117" /><CodeLine lineNumber="2117"><span class="doxyHighlight">    ExpectedRetAddrReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(AddrRC);</span></CodeLine>
<Link id="l02118" /><CodeLine lineNumber="2118"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (MF.<a href="/docs/api/classes/llvm/machinefunction/#af777ff93c9e07a6ff5ffe3226deb3e76">getTarget</a>().<a href="/docs/api/classes/llvm/targetmachine/#ae106f6c6362377b3016f0d174227e193">getCodeModel</a>() == <a href="/docs/api/namespaces/llvm/codemodel/#afc59396a9e5809fc92938e203d91a8dfaa2554ef60dc191c6005ba9eecbc9aea0">CodeModel::Small</a> &amp;&amp;</span></CodeLine>
<Link id="l02119" /><CodeLine lineNumber="2119"><span class="doxyHighlight">        !Subtarget-&gt;isPositionIndependent()) &#123;</span></CodeLine>
<Link id="l02120" /><CodeLine lineNumber="2120"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::MOV64ri32), ExpectedRetAddrReg)</span></CodeLine>
<Link id="l02121" /><CodeLine lineNumber="2121"><span class="doxyHighlight">          .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a7ffeb5b3940506a54e69e72e26e2a6cd">addSym</a>(RetSymbol);</span></CodeLine>
<Link id="l02122" /><CodeLine lineNumber="2122"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l02123" /><CodeLine lineNumber="2123"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::LEA64r), ExpectedRetAddrReg)</span></CodeLine>
<Link id="l02124" /><CodeLine lineNumber="2124"><span class="doxyHighlight">          .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</span><span class="doxyHighlightComment">/&#42;Base&#42;/</span><span class="doxyHighlight"> X86::RIP)</span></CodeLine>
<Link id="l02125" /><CodeLine lineNumber="2125"><span class="doxyHighlight">          .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(</span><span class="doxyHighlightComment">/&#42;Scale&#42;/</span><span class="doxyHighlight"> 1)</span></CodeLine>
<Link id="l02126" /><CodeLine lineNumber="2126"><span class="doxyHighlight">          .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</span><span class="doxyHighlightComment">/&#42;Index&#42;/</span><span class="doxyHighlight"> 0)</span></CodeLine>
<Link id="l02127" /><CodeLine lineNumber="2127"><span class="doxyHighlight">          .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a7ffeb5b3940506a54e69e72e26e2a6cd">addSym</a>(RetSymbol)</span></CodeLine>
<Link id="l02128" /><CodeLine lineNumber="2128"><span class="doxyHighlight">          .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</span><span class="doxyHighlightComment">/&#42;Segment&#42;/</span><span class="doxyHighlight"> 0);</span></CodeLine>
<Link id="l02129" /><CodeLine lineNumber="2129"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l02130" /><CodeLine lineNumber="2130"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02131" /><CodeLine lineNumber="2131"></CodeLine>
<Link id="l02132" /><CodeLine lineNumber="2132"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Step past the call to handle when it returns.</span></CodeLine>
<Link id="l02133" /><CodeLine lineNumber="2133"><span class="doxyHighlight">  ++InsertPt;</span></CodeLine>
<Link id="l02134" /><CodeLine lineNumber="2134"></CodeLine>
<Link id="l02135" /><CodeLine lineNumber="2135"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we didn&#39;t pre-compute the expected return address into a register, then</span></CodeLine>
<Link id="l02136" /><CodeLine lineNumber="2136"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// red zones are enabled and the return address is still available on the</span></CodeLine>
<Link id="l02137" /><CodeLine lineNumber="2137"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// stack immediately after the call. As the very first instruction, we load it</span></CodeLine>
<Link id="l02138" /><CodeLine lineNumber="2138"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// into a register.</span></CodeLine>
<Link id="l02139" /><CodeLine lineNumber="2139"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!ExpectedRetAddrReg) &#123;</span></CodeLine>
<Link id="l02140" /><CodeLine lineNumber="2140"><span class="doxyHighlight">    ExpectedRetAddrReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(AddrRC);</span></CodeLine>
<Link id="l02141" /><CodeLine lineNumber="2141"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::MOV64rm), ExpectedRetAddrReg)</span></CodeLine>
<Link id="l02142" /><CodeLine lineNumber="2142"><span class="doxyHighlight">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</span><span class="doxyHighlightComment">/&#42;Base&#42;/</span><span class="doxyHighlight"> X86::RSP)</span></CodeLine>
<Link id="l02143" /><CodeLine lineNumber="2143"><span class="doxyHighlight">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(</span><span class="doxyHighlightComment">/&#42;Scale&#42;/</span><span class="doxyHighlight"> 1)</span></CodeLine>
<Link id="l02144" /><CodeLine lineNumber="2144"><span class="doxyHighlight">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</span><span class="doxyHighlightComment">/&#42;Index&#42;/</span><span class="doxyHighlight"> 0)</span></CodeLine>
<Link id="l02145" /><CodeLine lineNumber="2145"><span class="doxyHighlight">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(</span><span class="doxyHighlightComment">/&#42;Displacement&#42;/</span><span class="doxyHighlight"> -8) </span><span class="doxyHighlightComment">// The stack pointer has been popped, so</span></CodeLine>
<Link id="l02146" /><CodeLine lineNumber="2146"><span class="doxyHighlight">                                     </span><span class="doxyHighlightComment">// the return address is 8-bytes past it.</span></CodeLine>
<Link id="l02147" /><CodeLine lineNumber="2147"><span class="doxyHighlight">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</span><span class="doxyHighlightComment">/&#42;Segment&#42;/</span><span class="doxyHighlight"> 0);</span></CodeLine>
<Link id="l02148" /><CodeLine lineNumber="2148"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02149" /><CodeLine lineNumber="2149"></CodeLine>
<Link id="l02150" /><CodeLine lineNumber="2150"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Now we extract the callee&#39;s predicate state from the stack pointer.</span></CodeLine>
<Link id="l02151" /><CodeLine lineNumber="2151"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NewStateReg = extractPredStateFromSP(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>);</span></CodeLine>
<Link id="l02152" /><CodeLine lineNumber="2152"></CodeLine>
<Link id="l02153" /><CodeLine lineNumber="2153"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Test the expected return address against our actual address. If we can</span></CodeLine>
<Link id="l02154" /><CodeLine lineNumber="2154"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// form this basic block&#39;s address as an immediate, this is easy. Otherwise</span></CodeLine>
<Link id="l02155" /><CodeLine lineNumber="2155"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// we compute it.</span></CodeLine>
<Link id="l02156" /><CodeLine lineNumber="2156"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (MF.<a href="/docs/api/classes/llvm/machinefunction/#af777ff93c9e07a6ff5ffe3226deb3e76">getTarget</a>().<a href="/docs/api/classes/llvm/targetmachine/#ae106f6c6362377b3016f0d174227e193">getCodeModel</a>() == <a href="/docs/api/namespaces/llvm/codemodel/#afc59396a9e5809fc92938e203d91a8dfaa2554ef60dc191c6005ba9eecbc9aea0">CodeModel::Small</a> &amp;&amp;</span></CodeLine>
<Link id="l02157" /><CodeLine lineNumber="2157"><span class="doxyHighlight">      !Subtarget-&gt;isPositionIndependent()) &#123;</span></CodeLine>
<Link id="l02158" /><CodeLine lineNumber="2158"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// FIXME: Could we fold this with the load? It would require careful EFLAGS</span></CodeLine>
<Link id="l02159" /><CodeLine lineNumber="2159"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// management.</span></CodeLine>
<Link id="l02160" /><CodeLine lineNumber="2160"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::CMP64ri32))</span></CodeLine>
<Link id="l02161" /><CodeLine lineNumber="2161"><span class="doxyHighlight">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(ExpectedRetAddrReg, <a href="/docs/api/namespaces/llvm/regstate/#ade26fe5c9b3fe6948def36f7ca12dfc5a9ddde91ef09476d28a088fe57f8e2921">RegState::Kill</a>)</span></CodeLine>
<Link id="l02162" /><CodeLine lineNumber="2162"><span class="doxyHighlight">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a7ffeb5b3940506a54e69e72e26e2a6cd">addSym</a>(RetSymbol);</span></CodeLine>
<Link id="l02163" /><CodeLine lineNumber="2163"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l02164" /><CodeLine lineNumber="2164"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/register">Register</a> ActualRetAddrReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(AddrRC);</span></CodeLine>
<Link id="l02165" /><CodeLine lineNumber="2165"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::LEA64r), ActualRetAddrReg)</span></CodeLine>
<Link id="l02166" /><CodeLine lineNumber="2166"><span class="doxyHighlight">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</span><span class="doxyHighlightComment">/&#42;Base&#42;/</span><span class="doxyHighlight"> X86::RIP)</span></CodeLine>
<Link id="l02167" /><CodeLine lineNumber="2167"><span class="doxyHighlight">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(</span><span class="doxyHighlightComment">/&#42;Scale&#42;/</span><span class="doxyHighlight"> 1)</span></CodeLine>
<Link id="l02168" /><CodeLine lineNumber="2168"><span class="doxyHighlight">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</span><span class="doxyHighlightComment">/&#42;Index&#42;/</span><span class="doxyHighlight"> 0)</span></CodeLine>
<Link id="l02169" /><CodeLine lineNumber="2169"><span class="doxyHighlight">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a7ffeb5b3940506a54e69e72e26e2a6cd">addSym</a>(RetSymbol)</span></CodeLine>
<Link id="l02170" /><CodeLine lineNumber="2170"><span class="doxyHighlight">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(</span><span class="doxyHighlightComment">/&#42;Segment&#42;/</span><span class="doxyHighlight"> 0);</span></CodeLine>
<Link id="l02171" /><CodeLine lineNumber="2171"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(X86::CMP64rr))</span></CodeLine>
<Link id="l02172" /><CodeLine lineNumber="2172"><span class="doxyHighlight">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(ExpectedRetAddrReg, <a href="/docs/api/namespaces/llvm/regstate/#ade26fe5c9b3fe6948def36f7ca12dfc5a9ddde91ef09476d28a088fe57f8e2921">RegState::Kill</a>)</span></CodeLine>
<Link id="l02173" /><CodeLine lineNumber="2173"><span class="doxyHighlight">        .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(ActualRetAddrReg, <a href="/docs/api/namespaces/llvm/regstate/#ade26fe5c9b3fe6948def36f7ca12dfc5a9ddde91ef09476d28a088fe57f8e2921">RegState::Kill</a>);</span></CodeLine>
<Link id="l02174" /><CodeLine lineNumber="2174"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02175" /><CodeLine lineNumber="2175"></CodeLine>
<Link id="l02176" /><CodeLine lineNumber="2176"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Now conditionally update the predicate state we just extracted if we ended</span></CodeLine>
<Link id="l02177" /><CodeLine lineNumber="2177"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// up at a different return address than expected.</span></CodeLine>
<Link id="l02178" /><CodeLine lineNumber="2178"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> PredStateSizeInBytes = <a href="/docs/api/files/lib/lib/codegen/machinesink-cpp/#a0f36ed1bc17fc1aa97fe291c439a0698">TRI</a>-&gt;getRegSizeInBits(&#42;PS-&gt;RC) / 8;</span></CodeLine>
<Link id="l02179" /><CodeLine lineNumber="2179"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> CMovOp = <a href="/docs/api/namespaces/llvm/x86/#af569f4e4b0acf498c83fa0e58e2eb364">X86::getCMovOpcode</a>(PredStateSizeInBytes);</span></CodeLine>
<Link id="l02180" /><CodeLine lineNumber="2180"></CodeLine>
<Link id="l02181" /><CodeLine lineNumber="2181"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/register">Register</a> UpdatedStateReg = <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64advsimdscalarpass-cpp/#aacd2ab195054a3e6a74bfbb9d5d571c8">MRI</a>-&gt;createVirtualRegister(PS-&gt;RC);</span></CodeLine>
<Link id="l02182" /><CodeLine lineNumber="2182"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> CMovI = <a href="/docs/api/namespaces/llvm/#a17e04afcf0c5efeb0eb6a9a45287b5e4">BuildMI</a>(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, InsertPt, <a href="/docs/api/namespaces/llvm/loc">Loc</a>, <a href="/docs/api/files/lib/lib/target/lib/target/hexagon/hexagoncopytocombine-cpp/#a1d40004718218dbdf06b496766299101">TII</a>-&gt;get(CMovOp), UpdatedStateReg)</span></CodeLine>
<Link id="l02183" /><CodeLine lineNumber="2183"><span class="doxyHighlight">                   .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(NewStateReg, <a href="/docs/api/namespaces/llvm/regstate/#ade26fe5c9b3fe6948def36f7ca12dfc5a9ddde91ef09476d28a088fe57f8e2921">RegState::Kill</a>)</span></CodeLine>
<Link id="l02184" /><CodeLine lineNumber="2184"><span class="doxyHighlight">                   .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a927857fc69e4b4f0cde307f86f180df5">addReg</a>(PS-&gt;PoisonReg)</span></CodeLine>
<Link id="l02185" /><CodeLine lineNumber="2185"><span class="doxyHighlight">                   .<a href="/docs/api/classes/llvm/machineinstrbuilder/#a6c1f959947905135c7dd215b64957654">addImm</a>(<a href="/docs/api/namespaces/llvm/x86/#a1a356a51a1fb4cc3c427599082cf1d2eacb2f86eaebe8b719f743d17a2d5a5f3d">X86::COND&#95;NE</a>);</span></CodeLine>
<Link id="l02186" /><CodeLine lineNumber="2186"><span class="doxyHighlight">  CMovI-&gt;<a href="/docs/api/classes/llvm/machineinstr/#ab692b90c6e0e9b450f407896cbbe4b02">findRegisterUseOperand</a>(X86::EFLAGS, </span><span class="doxyHighlightComment">/&#42;TRI=&#42;/</span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">)-&gt;<a href="/docs/api/classes/llvm/machineoperand/#a8a82683fccdef8a5ef772ef03277aee7">setIsKill</a>(</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02187" /><CodeLine lineNumber="2187"><span class="doxyHighlight">  ++NumInstsInserted;</span></CodeLine>
<Link id="l02188" /><CodeLine lineNumber="2188"><span class="doxyHighlight">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;  Inserting cmov: &quot;</span><span class="doxyHighlight">; CMovI-&gt;dump(); <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02189" /><CodeLine lineNumber="2189"></CodeLine>
<Link id="l02190" /><CodeLine lineNumber="2190"><span class="doxyHighlight">  PS-&gt;SSA.AddAvailableValue(&amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#a5958512eae2979bd2eb383977996a600">MBB</a>, UpdatedStateReg);</span></CodeLine>
<Link id="l02191" /><CodeLine lineNumber="2191"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02192" /><CodeLine lineNumber="2192"></CodeLine>
<Link id="l02193" /><CodeLine lineNumber="2193"><span class="doxyHighlightComment">/// An attacker may speculatively store over a value that is then speculatively</span></CodeLine>
<Link id="l02194" /><CodeLine lineNumber="2194"><span class="doxyHighlightComment">/// loaded and used as the target of an indirect call or jump instruction. This</span></CodeLine>
<Link id="l02195" /><CodeLine lineNumber="2195"><span class="doxyHighlightComment">/// is called Spectre v1.2 or Bounds Check Bypass Store (BCBS) and is described</span></CodeLine>
<Link id="l02196" /><CodeLine lineNumber="2196"><span class="doxyHighlightComment">/// in this paper:</span></CodeLine>
<Link id="l02197" /><CodeLine lineNumber="2197"><span class="doxyHighlightComment">/// https://people.csail.mit.edu/vlk/spectre11.pdf</span></CodeLine>
<Link id="l02198" /><CodeLine lineNumber="2198"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l02199" /><CodeLine lineNumber="2199"><span class="doxyHighlightComment">/// When this happens, the speculative execution of the call or jump will end up</span></CodeLine>
<Link id="l02200" /><CodeLine lineNumber="2200"><span class="doxyHighlightComment">/// being steered to this attacker controlled address. While most such loads</span></CodeLine>
<Link id="l02201" /><CodeLine lineNumber="2201"><span class="doxyHighlightComment">/// will be adequately hardened already, we want to ensure that they are</span></CodeLine>
<Link id="l02202" /><CodeLine lineNumber="2202"><span class="doxyHighlightComment">/// definitively treated as needing post-load hardening. While address hardening</span></CodeLine>
<Link id="l02203" /><CodeLine lineNumber="2203"><span class="doxyHighlightComment">/// is sufficient to prevent secret data from leaking to the attacker, it may</span></CodeLine>
<Link id="l02204" /><CodeLine lineNumber="2204"><span class="doxyHighlightComment">/// not be sufficient to prevent an attacker from steering speculative</span></CodeLine>
<Link id="l02205" /><CodeLine lineNumber="2205"><span class="doxyHighlightComment">/// execution. We forcibly unfolded all relevant loads above and so will always</span></CodeLine>
<Link id="l02206" /><CodeLine lineNumber="2206"><span class="doxyHighlightComment">/// have an opportunity to post-load harden here, we just need to scan for cases</span></CodeLine>
<Link id="l02207" /><CodeLine lineNumber="2207"><span class="doxyHighlightComment">/// not already flagged and add them.</span></CodeLine>
<Link id="l02208" /><CodeLine lineNumber="2208"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> X86SpeculativeLoadHardeningPass::hardenIndirectCallOrJumpInstr(</span></CodeLine>
<Link id="l02209" /><CodeLine lineNumber="2209"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/machineinstr">MachineInstr</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>,</span></CodeLine>
<Link id="l02210" /><CodeLine lineNumber="2210"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;unsigned, unsigned, 32&gt;</a> &amp;AddrRegToHardenedReg) &#123;</span></CodeLine>
<Link id="l02211" /><CodeLine lineNumber="2211"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOpcode()) &#123;</span></CodeLine>
<Link id="l02212" /><CodeLine lineNumber="2212"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::FARCALL16m:</span></CodeLine>
<Link id="l02213" /><CodeLine lineNumber="2213"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::FARCALL32m:</span></CodeLine>
<Link id="l02214" /><CodeLine lineNumber="2214"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::FARCALL64m:</span></CodeLine>
<Link id="l02215" /><CodeLine lineNumber="2215"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::FARJMP16m:</span></CodeLine>
<Link id="l02216" /><CodeLine lineNumber="2216"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::FARJMP32m:</span></CodeLine>
<Link id="l02217" /><CodeLine lineNumber="2217"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> X86::FARJMP64m:</span></CodeLine>
<Link id="l02218" /><CodeLine lineNumber="2218"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We don&#39;t need to harden either far calls or far jumps as they are</span></CodeLine>
<Link id="l02219" /><CodeLine lineNumber="2219"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// safe from Spectre.</span></CodeLine>
<Link id="l02220" /><CodeLine lineNumber="2220"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02221" /><CodeLine lineNumber="2221"></CodeLine>
<Link id="l02222" /><CodeLine lineNumber="2222"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">default</span><span class="doxyHighlight">:</span></CodeLine>
<Link id="l02223" /><CodeLine lineNumber="2223"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02224" /><CodeLine lineNumber="2224"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l02225" /><CodeLine lineNumber="2225"></CodeLine>
<Link id="l02226" /><CodeLine lineNumber="2226"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We should never see a loading instruction at this point, as those should</span></CodeLine>
<Link id="l02227" /><CodeLine lineNumber="2227"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// have been unfolded.</span></CodeLine>
<Link id="l02228" /><CodeLine lineNumber="2228"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.mayLoad() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Found a lingering loading instruction!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l02229" /><CodeLine lineNumber="2229"></CodeLine>
<Link id="l02230" /><CodeLine lineNumber="2230"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the first operand isn&#39;t a register, this is a branch or call</span></CodeLine>
<Link id="l02231" /><CodeLine lineNumber="2231"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// instruction with an immediate operand which doesn&#39;t need to be hardened.</span></CodeLine>
<Link id="l02232" /><CodeLine lineNumber="2232"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(0).isReg())</span></CodeLine>
<Link id="l02233" /><CodeLine lineNumber="2233"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l02234" /><CodeLine lineNumber="2234"></CodeLine>
<Link id="l02235" /><CodeLine lineNumber="2235"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For all of these, the target register is the first operand of the</span></CodeLine>
<Link id="l02236" /><CodeLine lineNumber="2236"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// instruction.</span></CodeLine>
<Link id="l02237" /><CodeLine lineNumber="2237"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;TargetOp = <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getOperand(0);</span></CodeLine>
<Link id="l02238" /><CodeLine lineNumber="2238"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/register">Register</a> OldTargetReg = TargetOp.getReg();</span></CodeLine>
<Link id="l02239" /><CodeLine lineNumber="2239"></CodeLine>
<Link id="l02240" /><CodeLine lineNumber="2240"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Try to lookup a hardened version of this register. We retain a reference</span></CodeLine>
<Link id="l02241" /><CodeLine lineNumber="2241"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// here as we want to update the map to track any newly computed hardened</span></CodeLine>
<Link id="l02242" /><CodeLine lineNumber="2242"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// register.</span></CodeLine>
<Link id="l02243" /><CodeLine lineNumber="2243"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> &amp;HardenedTargetReg = AddrRegToHardenedReg&#91;OldTargetReg&#93;;</span></CodeLine>
<Link id="l02244" /><CodeLine lineNumber="2244"></CodeLine>
<Link id="l02245" /><CodeLine lineNumber="2245"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we don&#39;t have a hardened register yet, compute one. Otherwise, just use</span></CodeLine>
<Link id="l02246" /><CodeLine lineNumber="2246"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the already hardened register.</span></CodeLine>
<Link id="l02247" /><CodeLine lineNumber="2247"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l02248" /><CodeLine lineNumber="2248"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// FIXME: It is a little suspect that we use partially hardened registers that</span></CodeLine>
<Link id="l02249" /><CodeLine lineNumber="2249"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// only feed addresses. The complexity of partial hardening with SHRX</span></CodeLine>
<Link id="l02250" /><CodeLine lineNumber="2250"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// continues to pile up. Should definitively measure its value and consider</span></CodeLine>
<Link id="l02251" /><CodeLine lineNumber="2251"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// eliminating it.</span></CodeLine>
<Link id="l02252" /><CodeLine lineNumber="2252"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!HardenedTargetReg)</span></CodeLine>
<Link id="l02253" /><CodeLine lineNumber="2253"><span class="doxyHighlight">    HardenedTargetReg = hardenValueInRegister(</span></CodeLine>
<Link id="l02254" /><CodeLine lineNumber="2254"><span class="doxyHighlight">        OldTargetReg, &#42;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getParent(), <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getIterator(), <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/irtranslator-cpp/#abe44dfdea65b4f7e11e0a608ab708b76">MI</a>.getDebugLoc());</span></CodeLine>
<Link id="l02255" /><CodeLine lineNumber="2255"></CodeLine>
<Link id="l02256" /><CodeLine lineNumber="2256"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Set the target operand to the hardened register.</span></CodeLine>
<Link id="l02257" /><CodeLine lineNumber="2257"><span class="doxyHighlight">  TargetOp.setReg(HardenedTargetReg);</span></CodeLine>
<Link id="l02258" /><CodeLine lineNumber="2258"></CodeLine>
<Link id="l02259" /><CodeLine lineNumber="2259"><span class="doxyHighlight">  ++NumCallsOrJumpsHardened;</span></CodeLine>
<Link id="l02260" /><CodeLine lineNumber="2260"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l02261" /><CodeLine lineNumber="2261"></CodeLine>
<Link id="l02262" /><CodeLine lineNumber="2262" lineLink="#a9936c7db2226d0d94430b4e6a6648cc0"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/passsupport-h/#aaa970fc931c1c63037a8182e028d04b1">INITIALIZE&#95;PASS&#95;BEGIN</a>(<a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a77a626d52a8457ef92d87b702df1cb7f">X86SpeculativeLoadHardeningPass</a>, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a>,</span></CodeLine>
<Link id="l02263" /><CodeLine lineNumber="2263"><span class="doxyHighlight">                      </span><span class="doxyHighlightStringLiteral">&quot;X86 speculative load hardener&quot;</span><span class="doxyHighlight">, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">)</span></CodeLine>
<Link id="l02264" /><CodeLine lineNumber="2264" lineLink="#aff35f54c90a52d054a6423bcf2683f1e"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/passsupport-h/#a74ce8276b89067e806f67c45a6d92575">INITIALIZE&#95;PASS&#95;END</a>(<a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a77a626d52a8457ef92d87b702df1cb7f">X86SpeculativeLoadHardeningPass</a>, <a href="/docs/api/files/lib/lib/target/lib/target/x86/x86flagscopylowering-cpp/#ae0a7815fb436ce6db7cb0a91755daef7">PASS&#95;KEY</a>,</span></CodeLine>
<Link id="l02265" /><CodeLine lineNumber="2265" lineLink="#a0d80253a045701908e9a2599a6d88b05"><span class="doxyHighlight">                    </span><span class="doxyHighlightStringLiteral">&quot;X86 speculative load hardener&quot;</span><span class="doxyHighlight">, <a href="/docs/api/namespaces/false">false</a>, <a href="/docs/api/namespaces/false">false</a>)</span></CodeLine>
<Link id="l02266" /><CodeLine lineNumber="2266"></CodeLine>
<Link id="l02267" /><CodeLine lineNumber="2267" lineLink="/docs/api/namespaces/llvm/#a65f5a5f0179a8e1cbb425fe8bf33069d"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/functionpass">FunctionPass</a> &#42;<a href="/docs/api/namespaces/llvm">llvm</a>::<a href="/docs/api/namespaces/llvm/#a65f5a5f0179a8e1cbb425fe8bf33069d">createX86SpeculativeLoadHardeningPass</a>() &#123;</span></CodeLine>
<Link id="l02268" /><CodeLine lineNumber="2268"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">new</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-x86speculativeloadhardening-cpp-/x86speculativeloadhardeningpass/#a77a626d52a8457ef92d87b702df1cb7f">X86SpeculativeLoadHardeningPass</a>();</span></CodeLine>
<Link id="l02269" /><CodeLine lineNumber="2269"><span class="doxyHighlight">&#125;</span></CodeLine>

</ProgramListing>


</DoxygenPage>
