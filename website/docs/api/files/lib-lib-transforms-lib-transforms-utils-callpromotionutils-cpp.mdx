---

# DO NOT EDIT!
# Automatically generated via docusaurus-plugin-doxygen by Doxygen.

slug: /api/files/lib/lib/transforms/lib/transforms/utils/callpromotionutils-cpp
custom_edit_url: null
keywords:
  - doxygen
  - reference
  - file

---

import Link from '@docusaurus/Link'

import CodeLine from '@xpack/docusaurus-plugin-doxygen/components/CodeLine'
import DoxygenPage from '@xpack/docusaurus-plugin-doxygen/components/DoxygenPage'
import IncludesList from '@xpack/docusaurus-plugin-doxygen/components/IncludesList'
import IncludesListItem from '@xpack/docusaurus-plugin-doxygen/components/IncludesListItem'
import MemberDefinition from '@xpack/docusaurus-plugin-doxygen/components/MemberDefinition'
import MembersIndex from '@xpack/docusaurus-plugin-doxygen/components/MembersIndex'
import MembersIndexItem from '@xpack/docusaurus-plugin-doxygen/components/MembersIndexItem'
import ProgramListing from '@xpack/docusaurus-plugin-doxygen/components/ProgramListing'
import SectionDefinition from '@xpack/docusaurus-plugin-doxygen/components/SectionDefinition'

import pluginConfig from '@site/docusaurus-plugin-doxygen-config.json'

# The `CallPromotionUtils.cpp` File Reference

<DoxygenPage pluginConfig={pluginConfig}>



## Included Headers

<IncludesList>
<IncludesListItem
  filePath="llvm/Transforms/Utils/CallPromotionUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/callpromotionutils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/CtxProfAnalysis.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/ctxprofanalysis-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/Loads.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/loads-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/TypeMetadataUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/typemetadatautils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/AttributeMask.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/attributemask-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Constant.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/constant-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/IRBuilder.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/irbuilder-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Instructions.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/instructions-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/IntrinsicInst.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/intrinsicinst-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Module.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/module-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ProfileData/PGOCtxProfReader.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/profiledata/pgoctxprofreader-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/BasicBlockUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/basicblockutils-h"
  isLocal="true" />
</IncludesList>

## Functions Index

<MembersIndex>

<MembersIndexItem
  type="void"
  name={<><a href="#a8c9ae0be5e6bcad90cdf141962a117f3">createRetBitCast</a> (CallBase &amp;CB, Type &#42;RetTy, CastInst &#42;&#42;RetBitCast)</>}>
Cast a call or invoke instruction to the given type. <a href="#a8c9ae0be5e6bcad90cdf141962a117f3">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#abdf3ba57973320bd702d3b12b0b8fa8c">createRetPHINode</a> (Instruction &#42;OrigInst, Instruction &#42;NewInst, BasicBlock &#42;MergeBlock, IRBuilder&lt;&gt; &amp;Builder)</>}>
Create a phi node for the returned value of a call or invoke instruction. <a href="#abdf3ba57973320bd702d3b12b0b8fa8c">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a51ff57d75f102e980e39535df6ff00bb">fixupPHINodeForNormalDest</a> (InvokeInst &#42;Invoke, BasicBlock &#42;OrigBlock, BasicBlock &#42;MergeBlock)</>}>
Fix-up phi nodes in an invoke instruction&#39;s normal destination. <a href="#a51ff57d75f102e980e39535df6ff00bb">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a59b92d3bbd9b21b61a2afbb73c10c3b0">fixupPHINodeForUnwindDest</a> (InvokeInst &#42;Invoke, BasicBlock &#42;OrigBlock, BasicBlock &#42;ThenBlock, BasicBlock &#42;ElseBlock)</>}>
Fix-up phi nodes in an invoke instruction&#39;s unwind destination. <a href="#a59b92d3bbd9b21b61a2afbb73c10c3b0">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/callbase">CallBase</a> &amp;</>}
  name={<><a href="#aaabc735841282ccafdf43b7c165b030e">versionCallSiteWithCond</a> (CallBase &amp;CB, Value &#42;Cond, MDNode &#42;BranchWeights)</>}>
<a href="/docs/api/classes/predicate">Predicate</a> and clone the given call site. <a href="#aaabc735841282ccafdf43b7c165b030e">More...</a>
</MembersIndexItem>

</MembersIndex>

## Defines Index

<MembersIndex>

<MembersIndexItem
  type="#define"
  name={<><a href="#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>&nbsp;&nbsp;&nbsp;&quot;call-promotion-utils&quot;</>}>
</MembersIndexItem>

</MembersIndex>


<SectionDefinition>

## Functions

### createRetBitCast() {#a8c9ae0be5e6bcad90cdf141962a117f3}

<MemberDefinition
  prototype={<>static void createRetBitCast (<a href="/docs/api/classes/llvm/callbase">CallBase</a> &amp; CB, <a href="/docs/api/classes/llvm/type">Type</a> &#42; RetTy, <a href="/docs/api/classes/llvm/castinst">CastInst</a> &#42;&#42; RetBitCast)</>}
  labels = {["static"]}>
Cast a call or invoke instruction to the given type.

When promoting a call site, the return type of the call site might not match that of the callee. If this is the case, we have to cast the returned value to the correct type. The location of the cast depends on if we have a call or invoke instruction.

For example, if the call instruction below requires a bitcast after promotion:

orig&#95;bb: t0 = call i32 @func() ...

The bitcast is placed after the call instruction:

orig&#95;bb: ; Uses of the original return value are replaced by uses of the bitcast. t0 = call i32 @func() t1 = bitcast i32 t0 to ... ...

A similar transformation is performed for invoke instructions. However, since invokes are terminating, a new block is created for the bitcast. For example, if the invoke instruction below requires a bitcast after promotion:

orig&#95;bb: t0 = invoke i32 @func() to label normal&#95;dst unwind label unwind&#95;dst

The edge between the original block and the invoke&#39;s normal destination is split, and the bitcast is placed there:

orig&#95;bb: t0 = invoke i32 @func() to label split&#95;bb unwind label unwind&#95;dst

split&#95;bb: ; Uses of the original return value are replaced by uses of the bitcast. t1 = bitcast i32 t0 to ... br label normal&#95;dst

Definition at line <a href="#l00168">168</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/callpromotionutils-cpp">CallPromotionUtils.cpp</a>.
</MemberDefinition>

### createRetPHINode() {#abdf3ba57973320bd702d3b12b0b8fa8c}

<MemberDefinition
  prototype={<>static void createRetPHINode (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42; OrigInst, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42; NewInst, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; MergeBlock, <a href="/docs/api/classes/llvm/irbuilder">IRBuilder</a>&lt;&gt; &amp; Builder)</>}
  labels = {["static"]}>
Create a phi node for the returned value of a call or invoke instruction.

After versioning a call or invoke instruction that returns a value, we have to merge the value of the original and new instructions. We do this by creating a phi node and replacing uses of the original instruction with this phi node.

For example, if <code>OrigInst</code> is defined in &quot;else&#95;bb&quot; and <code>NewInst</code> is defined in &quot;then&#95;bb&quot;, we create the following phi node:

; Uses of the original instruction are replaced by uses of the phi node. t0 = phi i32 &#91; orig&#95;inst, else&#95;bb &#93;, &#91; new&#95;inst, then&#95;bb &#93;,

Definition at line <a href="#l00113">113</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/callpromotionutils-cpp">CallPromotionUtils.cpp</a>.
</MemberDefinition>

### fixupPHINodeForNormalDest() {#a51ff57d75f102e980e39535df6ff00bb}

<MemberDefinition
  prototype={<>static void fixupPHINodeForNormalDest (<a href="/docs/api/classes/llvm/invokeinst">InvokeInst</a> &#42; Invoke, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; OrigBlock, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; MergeBlock)</>}
  labels = {["static"]}>
Fix-up phi nodes in an invoke instruction&#39;s normal destination.

After versioning an invoke instruction, values coming from the original block will now be coming from the &quot;merge&quot; block. For example, in the code below:

then&#95;bb: t0 = invoke i32 ptr() to label merge&#95;bb unwind label unwind&#95;dst

else&#95;bb: t1 = invoke i32 ptr() to label merge&#95;bb unwind label unwind&#95;dst

merge&#95;bb: t2 = phi i32 &#91; t0, then&#95;bb &#93;, &#91; t1, else&#95;bb &#93; br normal&#95;dst

normal&#95;dst: t3 = phi i32 &#91; x, orig&#95;bb &#93;, ...

&quot;orig&#95;bb&quot; is no longer a predecessor of &quot;normal&#95;dst&quot;, so the phi nodes in &quot;normal&#95;dst&quot; must be fixed to refer to &quot;merge&#95;bb&quot;:

normal&#95;dst: t3 = phi i32 &#91; x, merge&#95;bb &#93;, ...

Definition at line <a href="#l00056">56</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/callpromotionutils-cpp">CallPromotionUtils.cpp</a>.
</MemberDefinition>

### fixupPHINodeForUnwindDest() {#a59b92d3bbd9b21b61a2afbb73c10c3b0}

<MemberDefinition
  prototype={<>static void fixupPHINodeForUnwindDest (<a href="/docs/api/classes/llvm/invokeinst">InvokeInst</a> &#42; Invoke, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; OrigBlock, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; ThenBlock, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; ElseBlock)</>}
  labels = {["static"]}>
Fix-up phi nodes in an invoke instruction&#39;s unwind destination.

After versioning an invoke instruction, values coming from the original block will now be coming from either the &quot;then&quot; block or the &quot;else&quot; block. For example, in the code below:

then&#95;bb: t0 = invoke i32 ptr() to label merge&#95;bb unwind label unwind&#95;dst

else&#95;bb: t1 = invoke i32 ptr() to label merge&#95;bb unwind label unwind&#95;dst

unwind&#95;dst: t3 = phi i32 &#91; x, orig&#95;bb &#93;, ...

&quot;orig&#95;bb&quot; is no longer a predecessor of &quot;unwind&#95;dst&quot;, so the phi nodes in &quot;unwind&#95;dst&quot; must be fixed to refer to &quot;then&#95;bb&quot; and &quot;else&#95;bb&quot;:

unwind&#95;dst: t3 = phi i32 &#91; x, then&#95;bb &#93;, &#91; x, else&#95;bb &#93;, ...

Definition at line <a href="#l00087">87</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/callpromotionutils-cpp">CallPromotionUtils.cpp</a>.
</MemberDefinition>

### versionCallSiteWithCond() {#aaabc735841282ccafdf43b7c165b030e}

<MemberDefinition
  prototype={<>static CallBase &amp; versionCallSiteWithCond (<a href="/docs/api/classes/llvm/callbase">CallBase</a> &amp; CB, <a href="/docs/api/classes/llvm/value">Value</a> &#42; Cond, <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42; BranchWeights)</>}
  labels = {["static"]}>
<a href="/docs/api/classes/predicate">Predicate</a> and clone the given call site.

This function creates an if-then-else structure at the location of the call site. The &quot;if&quot; condition is specified by <code>Cond</code>. The original call site is moved into the &quot;else&quot; block, and a clone of the call site is placed in the &quot;then&quot; block. The cloned instruction is returned.

For example, the call instruction below:

orig&#95;bb: t0 = call i32 ptr() ...

Is replace by the following:

orig&#95;bb: cond = Cond br i1 cond, then&#95;bb, else&#95;bb

then&#95;bb: ; The clone of the original call instruction is placed in the &quot;then&quot; ; block. It is not yet promoted. t1 = call i32 ptr() br merge&#95;bb

else&#95;bb: ; The original call instruction is moved to the &quot;else&quot; block. t0 = call i32 ptr() br merge&#95;bb

merge&#95;bb: ; Uses of the original call instruction are replaced by uses of the phi ; node. t2 = phi i32 &#91; t0, else&#95;bb &#93;, &#91; t1, then&#95;bb &#93; ...

A similar transformation is performed for invoke instructions. However, since invokes are terminating, more work is required. For example, the invoke instruction below:

orig&#95;bb: t0 = invoke ptr() to label normal&#95;dst unwind label unwind&#95;dst

Is replace by the following:

orig&#95;bb: cond = Cond br i1 cond, then&#95;bb, else&#95;bb

then&#95;bb: ; The clone of the original invoke instruction is placed in the &quot;then&quot; ; block, and its normal destination is set to the &quot;merge&quot; block. It is ; not yet promoted. t1 = invoke i32 ptr() to label merge&#95;bb unwind label unwind&#95;dst

else&#95;bb: ; The original invoke instruction is moved into the &quot;else&quot; block, and ; its normal destination is set to the &quot;merge&quot; block. t0 = invoke i32 ptr() to label merge&#95;bb unwind label unwind&#95;dst

merge&#95;bb: ; Uses of the original invoke instruction are replaced by uses of the ; phi node, and the merge block branches to the normal destination. t2 = phi i32 &#91; t0, else&#95;bb &#93;, &#91; t1, then&#95;bb &#93; br normal&#95;dst

An indirect musttail call is processed slightly differently in that:
<ul>
<li>No merge block needed for the orginal and the cloned callsite, since either one ends the flow. No phi node is needed either.</li>
<li>The return statement following the original call site is duplicated too and placed immediately after the cloned call site per the IR convention.</li>
</ul>


For example, the musttail call instruction below:

orig&#95;bb: t0 = musttail call i32 ptr() ...

Is replaced by the following:

cond&#95;bb: cond = Cond br i1 cond, then&#95;bb, orig&#95;bb

then&#95;bb: ; The clone of the original call instruction is placed in the &quot;then&quot; ; block. It is not yet promoted. t1 = musttail call i32 ptr() ret t1

orig&#95;bb: ; The original call instruction stays in its original block. t0 = musttail call i32 ptr() ret t0

Definition at line <a href="#l00287">287</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/callpromotionutils-cpp">CallPromotionUtils.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Defines

### DEBUG&#95;TYPE {#ad78e062f62e0d6e453941fb4ca843e4d}

<MemberDefinition
  prototype={<>#define DEBUG&#95;TYPE&nbsp;&nbsp;&nbsp;&quot;call-promotion-utils&quot;</>}>

Definition at line <a href="#l00029">29</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/callpromotionutils-cpp">CallPromotionUtils.cpp</a>.
</MemberDefinition>

</SectionDefinition>

## File Listing

The file content with the documentation metadata removed is:

<ProgramListing>

<Link id="l00001" /><CodeLine lineNumber="1"><span class="doxyHighlightComment">//===- CallPromotionUtils.cpp - Utilities for call promotion ----&#42;- C++ -&#42;-===//</span></CodeLine>
<Link id="l00002" /><CodeLine lineNumber="2"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00003" /><CodeLine lineNumber="3"><span class="doxyHighlightComment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</span></CodeLine>
<Link id="l00004" /><CodeLine lineNumber="4"><span class="doxyHighlightComment">// See https://llvm.org/LICENSE.txt for license information.</span></CodeLine>
<Link id="l00005" /><CodeLine lineNumber="5"><span class="doxyHighlightComment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</span></CodeLine>
<Link id="l00006" /><CodeLine lineNumber="6"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00007" /><CodeLine lineNumber="7"><span class="doxyHighlightComment">//===----------------------------------------------------------------------===//</span></CodeLine>
<Link id="l00008" /><CodeLine lineNumber="8"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00009" /><CodeLine lineNumber="9"><span class="doxyHighlightComment">// This file implements utilities useful for promoting indirect call sites to</span></CodeLine>
<Link id="l00010" /><CodeLine lineNumber="10"><span class="doxyHighlightComment">// direct call sites.</span></CodeLine>
<Link id="l00011" /><CodeLine lineNumber="11"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00012" /><CodeLine lineNumber="12"><span class="doxyHighlightComment">//===----------------------------------------------------------------------===//</span></CodeLine>
<Link id="l00013" /><CodeLine lineNumber="13"></CodeLine>
<Link id="l00014" /><CodeLine lineNumber="14"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/callpromotionutils-h">llvm/Transforms/Utils/CallPromotionUtils.h</a>&quot;</span></CodeLine>
<Link id="l00015" /><CodeLine lineNumber="15"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/ctxprofanalysis-h">llvm/Analysis/CtxProfAnalysis.h</a>&quot;</span></CodeLine>
<Link id="l00016" /><CodeLine lineNumber="16"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/loads-h">llvm/Analysis/Loads.h</a>&quot;</span></CodeLine>
<Link id="l00017" /><CodeLine lineNumber="17"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/typemetadatautils-h">llvm/Analysis/TypeMetadataUtils.h</a>&quot;</span></CodeLine>
<Link id="l00018" /><CodeLine lineNumber="18"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/attributemask-h">llvm/IR/AttributeMask.h</a>&quot;</span></CodeLine>
<Link id="l00019" /><CodeLine lineNumber="19"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/constant-h">llvm/IR/Constant.h</a>&quot;</span></CodeLine>
<Link id="l00020" /><CodeLine lineNumber="20"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/irbuilder-h">llvm/IR/IRBuilder.h</a>&quot;</span></CodeLine>
<Link id="l00021" /><CodeLine lineNumber="21"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/instructions-h">llvm/IR/Instructions.h</a>&quot;</span></CodeLine>
<Link id="l00022" /><CodeLine lineNumber="22"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/intrinsicinst-h">llvm/IR/IntrinsicInst.h</a>&quot;</span></CodeLine>
<Link id="l00023" /><CodeLine lineNumber="23"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/module-h">llvm/IR/Module.h</a>&quot;</span></CodeLine>
<Link id="l00024" /><CodeLine lineNumber="24"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/profiledata/pgoctxprofreader-h">llvm/ProfileData/PGOCtxProfReader.h</a>&quot;</span></CodeLine>
<Link id="l00025" /><CodeLine lineNumber="25"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/basicblockutils-h">llvm/Transforms/Utils/BasicBlockUtils.h</a>&quot;</span></CodeLine>
<Link id="l00026" /><CodeLine lineNumber="26"></CodeLine>
<Link id="l00027" /><CodeLine lineNumber="27"><span class="doxyHighlightKeyword">using namespace </span><span class="doxyHighlight"><a href="/docs/api/namespaces/llvm">llvm</a>;</span></CodeLine>
<Link id="l00028" /><CodeLine lineNumber="28"></CodeLine>
<Link id="l00029" /><CodeLine lineNumber="29" lineLink="#ad78e062f62e0d6e453941fb4ca843e4d"><span class="doxyHighlightPreprocessor">#define DEBUG&#95;TYPE &quot;call-promotion-utils&quot;</span></CodeLine>
<Link id="l00030" /><CodeLine lineNumber="30"></CodeLine>
<Link id="l00031" /><CodeLine lineNumber="31"><span class="doxyHighlightComment">/// Fix-up phi nodes in an invoke instruction&#39;s normal destination.</span></CodeLine>
<Link id="l00032" /><CodeLine lineNumber="32"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00033" /><CodeLine lineNumber="33"><span class="doxyHighlightComment">/// After versioning an invoke instruction, values coming from the original</span></CodeLine>
<Link id="l00034" /><CodeLine lineNumber="34"><span class="doxyHighlightComment">/// block will now be coming from the &quot;merge&quot; block. For example, in the code</span></CodeLine>
<Link id="l00035" /><CodeLine lineNumber="35"><span class="doxyHighlightComment">/// below:</span></CodeLine>
<Link id="l00036" /><CodeLine lineNumber="36"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00037" /><CodeLine lineNumber="37"><span class="doxyHighlightComment">///   then&#95;bb:</span></CodeLine>
<Link id="l00038" /><CodeLine lineNumber="38"><span class="doxyHighlightComment">///     %t0 = invoke i32 %ptr() to label %merge&#95;bb unwind label %unwind&#95;dst</span></CodeLine>
<Link id="l00039" /><CodeLine lineNumber="39"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00040" /><CodeLine lineNumber="40"><span class="doxyHighlightComment">///   else&#95;bb:</span></CodeLine>
<Link id="l00041" /><CodeLine lineNumber="41"><span class="doxyHighlightComment">///     %t1 = invoke i32 %ptr() to label %merge&#95;bb unwind label %unwind&#95;dst</span></CodeLine>
<Link id="l00042" /><CodeLine lineNumber="42"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00043" /><CodeLine lineNumber="43"><span class="doxyHighlightComment">///   merge&#95;bb:</span></CodeLine>
<Link id="l00044" /><CodeLine lineNumber="44"><span class="doxyHighlightComment">///     %t2 = phi i32 &#91; %t0, %then&#95;bb &#93;, &#91; %t1, %else&#95;bb &#93;</span></CodeLine>
<Link id="l00045" /><CodeLine lineNumber="45"><span class="doxyHighlightComment">///     br %normal&#95;dst</span></CodeLine>
<Link id="l00046" /><CodeLine lineNumber="46"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00047" /><CodeLine lineNumber="47"><span class="doxyHighlightComment">///   normal&#95;dst:</span></CodeLine>
<Link id="l00048" /><CodeLine lineNumber="48"><span class="doxyHighlightComment">///     %t3 = phi i32 &#91; %x, %orig&#95;bb &#93;, ...</span></CodeLine>
<Link id="l00049" /><CodeLine lineNumber="49"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00050" /><CodeLine lineNumber="50"><span class="doxyHighlightComment">/// &quot;orig&#95;bb&quot; is no longer a predecessor of &quot;normal&#95;dst&quot;, so the phi nodes in</span></CodeLine>
<Link id="l00051" /><CodeLine lineNumber="51"><span class="doxyHighlightComment">/// &quot;normal&#95;dst&quot; must be fixed to refer to &quot;merge&#95;bb&quot;:</span></CodeLine>
<Link id="l00052" /><CodeLine lineNumber="52"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00053" /><CodeLine lineNumber="53"><span class="doxyHighlightComment">///    normal&#95;dst:</span></CodeLine>
<Link id="l00054" /><CodeLine lineNumber="54"><span class="doxyHighlightComment">///      %t3 = phi i32 &#91; %x, %merge&#95;bb &#93;, ...</span></CodeLine>
<Link id="l00055" /><CodeLine lineNumber="55"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00056" /><CodeLine lineNumber="56" lineLink="#a51ff57d75f102e980e39535df6ff00bb"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#a51ff57d75f102e980e39535df6ff00bb">fixupPHINodeForNormalDest</a>(<a href="/docs/api/classes/llvm/invokeinst">InvokeInst</a> &#42;Invoke, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;OrigBlock,</span></CodeLine>
<Link id="l00057" /><CodeLine lineNumber="57"><span class="doxyHighlight">                                      <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;MergeBlock) &#123;</span></CodeLine>
<Link id="l00058" /><CodeLine lineNumber="58"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/phinode">PHINode</a> &amp;Phi : Invoke-&gt;<a href="/docs/api/classes/llvm/invokeinst/#abefe36dd5104481a69ddd11d409abc10">getNormalDest</a>()-&gt;<a href="/docs/api/classes/llvm/basicblock/#a13da92d2694197fbcb5b95fd94e7570d">phis</a>()) &#123;</span></CodeLine>
<Link id="l00059" /><CodeLine lineNumber="59"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> Idx = Phi.getBasicBlockIndex(OrigBlock);</span></CodeLine>
<Link id="l00060" /><CodeLine lineNumber="60"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Idx == -1)</span></CodeLine>
<Link id="l00061" /><CodeLine lineNumber="61"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00062" /><CodeLine lineNumber="62"><span class="doxyHighlight">    Phi.setIncomingBlock(Idx, MergeBlock);</span></CodeLine>
<Link id="l00063" /><CodeLine lineNumber="63"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00064" /><CodeLine lineNumber="64"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00065" /><CodeLine lineNumber="65"></CodeLine>
<Link id="l00066" /><CodeLine lineNumber="66"><span class="doxyHighlightComment">/// Fix-up phi nodes in an invoke instruction&#39;s unwind destination.</span></CodeLine>
<Link id="l00067" /><CodeLine lineNumber="67"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00068" /><CodeLine lineNumber="68"><span class="doxyHighlightComment">/// After versioning an invoke instruction, values coming from the original</span></CodeLine>
<Link id="l00069" /><CodeLine lineNumber="69"><span class="doxyHighlightComment">/// block will now be coming from either the &quot;then&quot; block or the &quot;else&quot; block.</span></CodeLine>
<Link id="l00070" /><CodeLine lineNumber="70"><span class="doxyHighlightComment">/// For example, in the code below:</span></CodeLine>
<Link id="l00071" /><CodeLine lineNumber="71"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00072" /><CodeLine lineNumber="72"><span class="doxyHighlightComment">///   then&#95;bb:</span></CodeLine>
<Link id="l00073" /><CodeLine lineNumber="73"><span class="doxyHighlightComment">///     %t0 = invoke i32 %ptr() to label %merge&#95;bb unwind label %unwind&#95;dst</span></CodeLine>
<Link id="l00074" /><CodeLine lineNumber="74"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00075" /><CodeLine lineNumber="75"><span class="doxyHighlightComment">///   else&#95;bb:</span></CodeLine>
<Link id="l00076" /><CodeLine lineNumber="76"><span class="doxyHighlightComment">///     %t1 = invoke i32 %ptr() to label %merge&#95;bb unwind label %unwind&#95;dst</span></CodeLine>
<Link id="l00077" /><CodeLine lineNumber="77"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00078" /><CodeLine lineNumber="78"><span class="doxyHighlightComment">///   unwind&#95;dst:</span></CodeLine>
<Link id="l00079" /><CodeLine lineNumber="79"><span class="doxyHighlightComment">///     %t3 = phi i32 &#91; %x, %orig&#95;bb &#93;, ...</span></CodeLine>
<Link id="l00080" /><CodeLine lineNumber="80"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00081" /><CodeLine lineNumber="81"><span class="doxyHighlightComment">/// &quot;orig&#95;bb&quot; is no longer a predecessor of &quot;unwind&#95;dst&quot;, so the phi nodes in</span></CodeLine>
<Link id="l00082" /><CodeLine lineNumber="82"><span class="doxyHighlightComment">/// &quot;unwind&#95;dst&quot; must be fixed to refer to &quot;then&#95;bb&quot; and &quot;else&#95;bb&quot;:</span></CodeLine>
<Link id="l00083" /><CodeLine lineNumber="83"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00084" /><CodeLine lineNumber="84"><span class="doxyHighlightComment">///   unwind&#95;dst:</span></CodeLine>
<Link id="l00085" /><CodeLine lineNumber="85"><span class="doxyHighlightComment">///     %t3 = phi i32 &#91; %x, %then&#95;bb &#93;, &#91; %x, %else&#95;bb &#93;, ...</span></CodeLine>
<Link id="l00086" /><CodeLine lineNumber="86"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00087" /><CodeLine lineNumber="87" lineLink="#a59b92d3bbd9b21b61a2afbb73c10c3b0"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#a59b92d3bbd9b21b61a2afbb73c10c3b0">fixupPHINodeForUnwindDest</a>(<a href="/docs/api/classes/llvm/invokeinst">InvokeInst</a> &#42;Invoke, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;OrigBlock,</span></CodeLine>
<Link id="l00088" /><CodeLine lineNumber="88"><span class="doxyHighlight">                                      <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ThenBlock,</span></CodeLine>
<Link id="l00089" /><CodeLine lineNumber="89"><span class="doxyHighlight">                                      <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ElseBlock) &#123;</span></CodeLine>
<Link id="l00090" /><CodeLine lineNumber="90"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/phinode">PHINode</a> &amp;Phi : Invoke-&gt;<a href="/docs/api/classes/llvm/invokeinst/#a07cd85c19a9298b5a4fe2abbe29472aa">getUnwindDest</a>()-&gt;<a href="/docs/api/classes/llvm/basicblock/#a13da92d2694197fbcb5b95fd94e7570d">phis</a>()) &#123;</span></CodeLine>
<Link id="l00091" /><CodeLine lineNumber="91"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> Idx = Phi.getBasicBlockIndex(OrigBlock);</span></CodeLine>
<Link id="l00092" /><CodeLine lineNumber="92"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Idx == -1)</span></CodeLine>
<Link id="l00093" /><CodeLine lineNumber="93"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00094" /><CodeLine lineNumber="94"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;V = Phi.getIncomingValue(Idx);</span></CodeLine>
<Link id="l00095" /><CodeLine lineNumber="95"><span class="doxyHighlight">    Phi.setIncomingBlock(Idx, ThenBlock);</span></CodeLine>
<Link id="l00096" /><CodeLine lineNumber="96"><span class="doxyHighlight">    Phi.addIncoming(V, ElseBlock);</span></CodeLine>
<Link id="l00097" /><CodeLine lineNumber="97"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00098" /><CodeLine lineNumber="98"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00099" /><CodeLine lineNumber="99"></CodeLine>
<Link id="l00100" /><CodeLine lineNumber="100"><span class="doxyHighlightComment">/// Create a phi node for the returned value of a call or invoke instruction.</span></CodeLine>
<Link id="l00101" /><CodeLine lineNumber="101"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00102" /><CodeLine lineNumber="102"><span class="doxyHighlightComment">/// After versioning a call or invoke instruction that returns a value, we have</span></CodeLine>
<Link id="l00103" /><CodeLine lineNumber="103"><span class="doxyHighlightComment">/// to merge the value of the original and new instructions. We do this by</span></CodeLine>
<Link id="l00104" /><CodeLine lineNumber="104"><span class="doxyHighlightComment">/// creating a phi node and replacing uses of the original instruction with this</span></CodeLine>
<Link id="l00105" /><CodeLine lineNumber="105"><span class="doxyHighlightComment">/// phi node.</span></CodeLine>
<Link id="l00106" /><CodeLine lineNumber="106"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00107" /><CodeLine lineNumber="107"><span class="doxyHighlightComment">/// For example, if \\p OrigInst is defined in &quot;else&#95;bb&quot; and \\p NewInst is</span></CodeLine>
<Link id="l00108" /><CodeLine lineNumber="108"><span class="doxyHighlightComment">/// defined in &quot;then&#95;bb&quot;, we create the following phi node:</span></CodeLine>
<Link id="l00109" /><CodeLine lineNumber="109"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00110" /><CodeLine lineNumber="110"><span class="doxyHighlightComment">///   ; Uses of the original instruction are replaced by uses of the phi node.</span></CodeLine>
<Link id="l00111" /><CodeLine lineNumber="111"><span class="doxyHighlightComment">///   %t0 = phi i32 &#91; %orig&#95;inst, %else&#95;bb &#93;, &#91; %new&#95;inst, %then&#95;bb &#93;,</span></CodeLine>
<Link id="l00112" /><CodeLine lineNumber="112"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00113" /><CodeLine lineNumber="113" lineLink="#abdf3ba57973320bd702d3b12b0b8fa8c"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#abdf3ba57973320bd702d3b12b0b8fa8c">createRetPHINode</a>(<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;OrigInst, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;NewInst,</span></CodeLine>
<Link id="l00114" /><CodeLine lineNumber="114"><span class="doxyHighlight">                             <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;MergeBlock, <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> &amp;Builder) &#123;</span></CodeLine>
<Link id="l00115" /><CodeLine lineNumber="115"></CodeLine>
<Link id="l00116" /><CodeLine lineNumber="116"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (OrigInst-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>()-&gt;<a href="/docs/api/classes/llvm/type/#ae8eaa0b4eeac52a2b2282cb1bfd981ae">isVoidTy</a>() || OrigInst-&gt;<a href="/docs/api/classes/llvm/value/#a9d7de807ebdfe1819df3ff6cb0f16158">use&#95;empty</a>())</span></CodeLine>
<Link id="l00117" /><CodeLine lineNumber="117"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00118" /><CodeLine lineNumber="118"></CodeLine>
<Link id="l00119" /><CodeLine lineNumber="119"><span class="doxyHighlight">  Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#ace45cae6925c65e9d6916e09dd5b17cc">SetInsertPoint</a>(MergeBlock, MergeBlock-&gt;<a href="/docs/api/classes/llvm/basicblock/#a0ed5f3ab3c2e4196ee0cffffa080c062">begin</a>());</span></CodeLine>
<Link id="l00120" /><CodeLine lineNumber="120"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;Phi = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a876fb556ecea804faa2cd8ad1e498ec3">CreatePHI</a>(OrigInst-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>(), 0);</span></CodeLine>
<Link id="l00121" /><CodeLine lineNumber="121"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;User &#42;, 16&gt;</a> UsersToUpdate(OrigInst-&gt;<a href="/docs/api/classes/llvm/value/#a411cf3e3932f209ce3374cb31adc1da6">users</a>());</span></CodeLine>
<Link id="l00122" /><CodeLine lineNumber="122"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/user">User</a> &#42;U : UsersToUpdate)</span></CodeLine>
<Link id="l00123" /><CodeLine lineNumber="123"><span class="doxyHighlight">    U-&gt;replaceUsesOfWith(OrigInst, Phi);</span></CodeLine>
<Link id="l00124" /><CodeLine lineNumber="124"><span class="doxyHighlight">  Phi-&gt;addIncoming(OrigInst, OrigInst-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>());</span></CodeLine>
<Link id="l00125" /><CodeLine lineNumber="125"><span class="doxyHighlight">  Phi-&gt;addIncoming(NewInst, NewInst-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>());</span></CodeLine>
<Link id="l00126" /><CodeLine lineNumber="126"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00127" /><CodeLine lineNumber="127"></CodeLine>
<Link id="l00128" /><CodeLine lineNumber="128"><span class="doxyHighlightComment">/// Cast a call or invoke instruction to the given type.</span></CodeLine>
<Link id="l00129" /><CodeLine lineNumber="129"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00130" /><CodeLine lineNumber="130"><span class="doxyHighlightComment">/// When promoting a call site, the return type of the call site might not match</span></CodeLine>
<Link id="l00131" /><CodeLine lineNumber="131"><span class="doxyHighlightComment">/// that of the callee. If this is the case, we have to cast the returned value</span></CodeLine>
<Link id="l00132" /><CodeLine lineNumber="132"><span class="doxyHighlightComment">/// to the correct type. The location of the cast depends on if we have a call</span></CodeLine>
<Link id="l00133" /><CodeLine lineNumber="133"><span class="doxyHighlightComment">/// or invoke instruction.</span></CodeLine>
<Link id="l00134" /><CodeLine lineNumber="134"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00135" /><CodeLine lineNumber="135"><span class="doxyHighlightComment">/// For example, if the call instruction below requires a bitcast after</span></CodeLine>
<Link id="l00136" /><CodeLine lineNumber="136"><span class="doxyHighlightComment">/// promotion:</span></CodeLine>
<Link id="l00137" /><CodeLine lineNumber="137"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00138" /><CodeLine lineNumber="138"><span class="doxyHighlightComment">///   orig&#95;bb:</span></CodeLine>
<Link id="l00139" /><CodeLine lineNumber="139"><span class="doxyHighlightComment">///     %t0 = call i32 @func()</span></CodeLine>
<Link id="l00140" /><CodeLine lineNumber="140"><span class="doxyHighlightComment">///     ...</span></CodeLine>
<Link id="l00141" /><CodeLine lineNumber="141"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00142" /><CodeLine lineNumber="142"><span class="doxyHighlightComment">/// The bitcast is placed after the call instruction:</span></CodeLine>
<Link id="l00143" /><CodeLine lineNumber="143"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00144" /><CodeLine lineNumber="144"><span class="doxyHighlightComment">///   orig&#95;bb:</span></CodeLine>
<Link id="l00145" /><CodeLine lineNumber="145"><span class="doxyHighlightComment">///     ; Uses of the original return value are replaced by uses of the bitcast.</span></CodeLine>
<Link id="l00146" /><CodeLine lineNumber="146"><span class="doxyHighlightComment">///     %t0 = call i32 @func()</span></CodeLine>
<Link id="l00147" /><CodeLine lineNumber="147"><span class="doxyHighlightComment">///     %t1 = bitcast i32 %t0 to ...</span></CodeLine>
<Link id="l00148" /><CodeLine lineNumber="148"><span class="doxyHighlightComment">///     ...</span></CodeLine>
<Link id="l00149" /><CodeLine lineNumber="149"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00150" /><CodeLine lineNumber="150"><span class="doxyHighlightComment">/// A similar transformation is performed for invoke instructions. However,</span></CodeLine>
<Link id="l00151" /><CodeLine lineNumber="151"><span class="doxyHighlightComment">/// since invokes are terminating, a new block is created for the bitcast. For</span></CodeLine>
<Link id="l00152" /><CodeLine lineNumber="152"><span class="doxyHighlightComment">/// example, if the invoke instruction below requires a bitcast after promotion:</span></CodeLine>
<Link id="l00153" /><CodeLine lineNumber="153"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00154" /><CodeLine lineNumber="154"><span class="doxyHighlightComment">///   orig&#95;bb:</span></CodeLine>
<Link id="l00155" /><CodeLine lineNumber="155"><span class="doxyHighlightComment">///     %t0 = invoke i32 @func() to label %normal&#95;dst unwind label %unwind&#95;dst</span></CodeLine>
<Link id="l00156" /><CodeLine lineNumber="156"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00157" /><CodeLine lineNumber="157"><span class="doxyHighlightComment">/// The edge between the original block and the invoke&#39;s normal destination is</span></CodeLine>
<Link id="l00158" /><CodeLine lineNumber="158"><span class="doxyHighlightComment">/// split, and the bitcast is placed there:</span></CodeLine>
<Link id="l00159" /><CodeLine lineNumber="159"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00160" /><CodeLine lineNumber="160"><span class="doxyHighlightComment">///   orig&#95;bb:</span></CodeLine>
<Link id="l00161" /><CodeLine lineNumber="161"><span class="doxyHighlightComment">///     %t0 = invoke i32 @func() to label %split&#95;bb unwind label %unwind&#95;dst</span></CodeLine>
<Link id="l00162" /><CodeLine lineNumber="162"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00163" /><CodeLine lineNumber="163"><span class="doxyHighlightComment">///   split&#95;bb:</span></CodeLine>
<Link id="l00164" /><CodeLine lineNumber="164"><span class="doxyHighlightComment">///     ; Uses of the original return value are replaced by uses of the bitcast.</span></CodeLine>
<Link id="l00165" /><CodeLine lineNumber="165"><span class="doxyHighlightComment">///     %t1 = bitcast i32 %t0 to ...</span></CodeLine>
<Link id="l00166" /><CodeLine lineNumber="166"><span class="doxyHighlightComment">///     br label %normal&#95;dst</span></CodeLine>
<Link id="l00167" /><CodeLine lineNumber="167"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00168" /><CodeLine lineNumber="168" lineLink="#a8c9ae0be5e6bcad90cdf141962a117f3"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#a8c9ae0be5e6bcad90cdf141962a117f3">createRetBitCast</a>(<a href="/docs/api/classes/llvm/callbase">CallBase</a> &amp;CB, <a href="/docs/api/classes/llvm/type">Type</a> &#42;RetTy, <a href="/docs/api/classes/llvm/castinst">CastInst</a> &#42;&#42;RetBitCast) &#123;</span></CodeLine>
<Link id="l00169" /><CodeLine lineNumber="169"></CodeLine>
<Link id="l00170" /><CodeLine lineNumber="170"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Save the users of the calling instruction. These uses will be changed to</span></CodeLine>
<Link id="l00171" /><CodeLine lineNumber="171"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// use the bitcast after we create it.</span></CodeLine>
<Link id="l00172" /><CodeLine lineNumber="172"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;User &#42;, 16&gt;</a> UsersToUpdate(CB.<a href="/docs/api/classes/llvm/value/#a411cf3e3932f209ce3374cb31adc1da6">users</a>());</span></CodeLine>
<Link id="l00173" /><CodeLine lineNumber="173"></CodeLine>
<Link id="l00174" /><CodeLine lineNumber="174"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Determine an appropriate location to create the bitcast for the return</span></CodeLine>
<Link id="l00175" /><CodeLine lineNumber="175"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// value. The location depends on if we have a call or invoke instruction.</span></CodeLine>
<Link id="l00176" /><CodeLine lineNumber="176"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> InsertBefore;</span></CodeLine>
<Link id="l00177" /><CodeLine lineNumber="177"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Invoke = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;InvokeInst&gt;</a>(&amp;CB))</span></CodeLine>
<Link id="l00178" /><CodeLine lineNumber="178"><span class="doxyHighlight">    InsertBefore =</span></CodeLine>
<Link id="l00179" /><CodeLine lineNumber="179"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#adf83581f514774264d616eef5706cf6e">SplitEdge</a>(Invoke-&gt;getParent(), Invoke-&gt;getNormalDest())-&gt;<a href="/docs/api/classes/llvm/basicblock/#a0ed5f3ab3c2e4196ee0cffffa080c062">begin</a>();</span></CodeLine>
<Link id="l00180" /><CodeLine lineNumber="180"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00181" /><CodeLine lineNumber="181"><span class="doxyHighlight">    InsertBefore = std::next(CB.<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>());</span></CodeLine>
<Link id="l00182" /><CodeLine lineNumber="182"></CodeLine>
<Link id="l00183" /><CodeLine lineNumber="183"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Bitcast the return value to the correct type.</span></CodeLine>
<Link id="l00184" /><CodeLine lineNumber="184"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Cast = <a href="/docs/api/classes/llvm/castinst/#acdb02479a44bbebcabf8b7b5e1baa921">CastInst::CreateBitOrPointerCast</a>(&amp;CB, RetTy, </span><span class="doxyHighlightStringLiteral">&quot;&quot;</span><span class="doxyHighlight">, InsertBefore);</span></CodeLine>
<Link id="l00185" /><CodeLine lineNumber="185"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (RetBitCast)</span></CodeLine>
<Link id="l00186" /><CodeLine lineNumber="186"><span class="doxyHighlight">    &#42;RetBitCast = Cast;</span></CodeLine>
<Link id="l00187" /><CodeLine lineNumber="187"></CodeLine>
<Link id="l00188" /><CodeLine lineNumber="188"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Replace all the original uses of the calling instruction with the bitcast.</span></CodeLine>
<Link id="l00189" /><CodeLine lineNumber="189"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/user">User</a> &#42;U : UsersToUpdate)</span></CodeLine>
<Link id="l00190" /><CodeLine lineNumber="190"><span class="doxyHighlight">    U-&gt;<a href="/docs/api/classes/llvm/user/#a1600c7959045cb6b6a5f5a1d427ec67e">replaceUsesOfWith</a>(&amp;CB, Cast);</span></CodeLine>
<Link id="l00191" /><CodeLine lineNumber="191"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00192" /><CodeLine lineNumber="192"></CodeLine>
<Link id="l00193" /><CodeLine lineNumber="193"><span class="doxyHighlightComment">/// Predicate and clone the given call site.</span></CodeLine>
<Link id="l00194" /><CodeLine lineNumber="194"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00195" /><CodeLine lineNumber="195"><span class="doxyHighlightComment">/// This function creates an if-then-else structure at the location of the call</span></CodeLine>
<Link id="l00196" /><CodeLine lineNumber="196"><span class="doxyHighlightComment">/// site. The &quot;if&quot; condition is specified by &#96;Cond&#96;.</span></CodeLine>
<Link id="l00197" /><CodeLine lineNumber="197"><span class="doxyHighlightComment">/// The original call site is moved into the &quot;else&quot; block, and a clone of the</span></CodeLine>
<Link id="l00198" /><CodeLine lineNumber="198"><span class="doxyHighlightComment">/// call site is placed in the &quot;then&quot; block. The cloned instruction is returned.</span></CodeLine>
<Link id="l00199" /><CodeLine lineNumber="199"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00200" /><CodeLine lineNumber="200"><span class="doxyHighlightComment">/// For example, the call instruction below:</span></CodeLine>
<Link id="l00201" /><CodeLine lineNumber="201"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00202" /><CodeLine lineNumber="202"><span class="doxyHighlightComment">///   orig&#95;bb:</span></CodeLine>
<Link id="l00203" /><CodeLine lineNumber="203"><span class="doxyHighlightComment">///     %t0 = call i32 %ptr()</span></CodeLine>
<Link id="l00204" /><CodeLine lineNumber="204"><span class="doxyHighlightComment">///     ...</span></CodeLine>
<Link id="l00205" /><CodeLine lineNumber="205"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00206" /><CodeLine lineNumber="206"><span class="doxyHighlightComment">/// Is replace by the following:</span></CodeLine>
<Link id="l00207" /><CodeLine lineNumber="207"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00208" /><CodeLine lineNumber="208"><span class="doxyHighlightComment">///   orig&#95;bb:</span></CodeLine>
<Link id="l00209" /><CodeLine lineNumber="209"><span class="doxyHighlightComment">///     %cond = Cond</span></CodeLine>
<Link id="l00210" /><CodeLine lineNumber="210"><span class="doxyHighlightComment">///     br i1 %cond, %then&#95;bb, %else&#95;bb</span></CodeLine>
<Link id="l00211" /><CodeLine lineNumber="211"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00212" /><CodeLine lineNumber="212"><span class="doxyHighlightComment">///   then&#95;bb:</span></CodeLine>
<Link id="l00213" /><CodeLine lineNumber="213"><span class="doxyHighlightComment">///     ; The clone of the original call instruction is placed in the &quot;then&quot;</span></CodeLine>
<Link id="l00214" /><CodeLine lineNumber="214"><span class="doxyHighlightComment">///     ; block. It is not yet promoted.</span></CodeLine>
<Link id="l00215" /><CodeLine lineNumber="215"><span class="doxyHighlightComment">///     %t1 = call i32 %ptr()</span></CodeLine>
<Link id="l00216" /><CodeLine lineNumber="216"><span class="doxyHighlightComment">///     br merge&#95;bb</span></CodeLine>
<Link id="l00217" /><CodeLine lineNumber="217"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00218" /><CodeLine lineNumber="218"><span class="doxyHighlightComment">///   else&#95;bb:</span></CodeLine>
<Link id="l00219" /><CodeLine lineNumber="219"><span class="doxyHighlightComment">///     ; The original call instruction is moved to the &quot;else&quot; block.</span></CodeLine>
<Link id="l00220" /><CodeLine lineNumber="220"><span class="doxyHighlightComment">///     %t0 = call i32 %ptr()</span></CodeLine>
<Link id="l00221" /><CodeLine lineNumber="221"><span class="doxyHighlightComment">///     br merge&#95;bb</span></CodeLine>
<Link id="l00222" /><CodeLine lineNumber="222"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00223" /><CodeLine lineNumber="223"><span class="doxyHighlightComment">///   merge&#95;bb:</span></CodeLine>
<Link id="l00224" /><CodeLine lineNumber="224"><span class="doxyHighlightComment">///     ; Uses of the original call instruction are replaced by uses of the phi</span></CodeLine>
<Link id="l00225" /><CodeLine lineNumber="225"><span class="doxyHighlightComment">///     ; node.</span></CodeLine>
<Link id="l00226" /><CodeLine lineNumber="226"><span class="doxyHighlightComment">///     %t2 = phi i32 &#91; %t0, %else&#95;bb &#93;, &#91; %t1, %then&#95;bb &#93;</span></CodeLine>
<Link id="l00227" /><CodeLine lineNumber="227"><span class="doxyHighlightComment">///     ...</span></CodeLine>
<Link id="l00228" /><CodeLine lineNumber="228"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00229" /><CodeLine lineNumber="229"><span class="doxyHighlightComment">/// A similar transformation is performed for invoke instructions. However,</span></CodeLine>
<Link id="l00230" /><CodeLine lineNumber="230"><span class="doxyHighlightComment">/// since invokes are terminating, more work is required. For example, the</span></CodeLine>
<Link id="l00231" /><CodeLine lineNumber="231"><span class="doxyHighlightComment">/// invoke instruction below:</span></CodeLine>
<Link id="l00232" /><CodeLine lineNumber="232"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00233" /><CodeLine lineNumber="233"><span class="doxyHighlightComment">///   orig&#95;bb:</span></CodeLine>
<Link id="l00234" /><CodeLine lineNumber="234"><span class="doxyHighlightComment">///     %t0 = invoke %ptr() to label %normal&#95;dst unwind label %unwind&#95;dst</span></CodeLine>
<Link id="l00235" /><CodeLine lineNumber="235"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00236" /><CodeLine lineNumber="236"><span class="doxyHighlightComment">/// Is replace by the following:</span></CodeLine>
<Link id="l00237" /><CodeLine lineNumber="237"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00238" /><CodeLine lineNumber="238"><span class="doxyHighlightComment">///   orig&#95;bb:</span></CodeLine>
<Link id="l00239" /><CodeLine lineNumber="239"><span class="doxyHighlightComment">///     %cond = Cond</span></CodeLine>
<Link id="l00240" /><CodeLine lineNumber="240"><span class="doxyHighlightComment">///     br i1 %cond, %then&#95;bb, %else&#95;bb</span></CodeLine>
<Link id="l00241" /><CodeLine lineNumber="241"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00242" /><CodeLine lineNumber="242"><span class="doxyHighlightComment">///   then&#95;bb:</span></CodeLine>
<Link id="l00243" /><CodeLine lineNumber="243"><span class="doxyHighlightComment">///     ; The clone of the original invoke instruction is placed in the &quot;then&quot;</span></CodeLine>
<Link id="l00244" /><CodeLine lineNumber="244"><span class="doxyHighlightComment">///     ; block, and its normal destination is set to the &quot;merge&quot; block. It is</span></CodeLine>
<Link id="l00245" /><CodeLine lineNumber="245"><span class="doxyHighlightComment">///     ; not yet promoted.</span></CodeLine>
<Link id="l00246" /><CodeLine lineNumber="246"><span class="doxyHighlightComment">///     %t1 = invoke i32 %ptr() to label %merge&#95;bb unwind label %unwind&#95;dst</span></CodeLine>
<Link id="l00247" /><CodeLine lineNumber="247"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00248" /><CodeLine lineNumber="248"><span class="doxyHighlightComment">///   else&#95;bb:</span></CodeLine>
<Link id="l00249" /><CodeLine lineNumber="249"><span class="doxyHighlightComment">///     ; The original invoke instruction is moved into the &quot;else&quot; block, and</span></CodeLine>
<Link id="l00250" /><CodeLine lineNumber="250"><span class="doxyHighlightComment">///     ; its normal destination is set to the &quot;merge&quot; block.</span></CodeLine>
<Link id="l00251" /><CodeLine lineNumber="251"><span class="doxyHighlightComment">///     %t0 = invoke i32 %ptr() to label %merge&#95;bb unwind label %unwind&#95;dst</span></CodeLine>
<Link id="l00252" /><CodeLine lineNumber="252"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00253" /><CodeLine lineNumber="253"><span class="doxyHighlightComment">///   merge&#95;bb:</span></CodeLine>
<Link id="l00254" /><CodeLine lineNumber="254"><span class="doxyHighlightComment">///     ; Uses of the original invoke instruction are replaced by uses of the</span></CodeLine>
<Link id="l00255" /><CodeLine lineNumber="255"><span class="doxyHighlightComment">///     ; phi node, and the merge block branches to the normal destination.</span></CodeLine>
<Link id="l00256" /><CodeLine lineNumber="256"><span class="doxyHighlightComment">///     %t2 = phi i32 &#91; %t0, %else&#95;bb &#93;, &#91; %t1, %then&#95;bb &#93;</span></CodeLine>
<Link id="l00257" /><CodeLine lineNumber="257"><span class="doxyHighlightComment">///     br %normal&#95;dst</span></CodeLine>
<Link id="l00258" /><CodeLine lineNumber="258"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00259" /><CodeLine lineNumber="259"><span class="doxyHighlightComment">/// An indirect musttail call is processed slightly differently in that:</span></CodeLine>
<Link id="l00260" /><CodeLine lineNumber="260"><span class="doxyHighlightComment">/// 1 No merge block needed for the orginal and the cloned callsite, since</span></CodeLine>
<Link id="l00261" /><CodeLine lineNumber="261"><span class="doxyHighlightComment">///    either one ends the flow. No phi node is needed either.</span></CodeLine>
<Link id="l00262" /><CodeLine lineNumber="262"><span class="doxyHighlightComment">/// 2 The return statement following the original call site is duplicated too</span></CodeLine>
<Link id="l00263" /><CodeLine lineNumber="263"><span class="doxyHighlightComment">///    and placed immediately after the cloned call site per the IR convention.</span></CodeLine>
<Link id="l00264" /><CodeLine lineNumber="264"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00265" /><CodeLine lineNumber="265"><span class="doxyHighlightComment">/// For example, the musttail call instruction below:</span></CodeLine>
<Link id="l00266" /><CodeLine lineNumber="266"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00267" /><CodeLine lineNumber="267"><span class="doxyHighlightComment">///   orig&#95;bb:</span></CodeLine>
<Link id="l00268" /><CodeLine lineNumber="268"><span class="doxyHighlightComment">///     %t0 = musttail call i32 %ptr()</span></CodeLine>
<Link id="l00269" /><CodeLine lineNumber="269"><span class="doxyHighlightComment">///     ...</span></CodeLine>
<Link id="l00270" /><CodeLine lineNumber="270"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00271" /><CodeLine lineNumber="271"><span class="doxyHighlightComment">/// Is replaced by the following:</span></CodeLine>
<Link id="l00272" /><CodeLine lineNumber="272"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00273" /><CodeLine lineNumber="273"><span class="doxyHighlightComment">///   cond&#95;bb:</span></CodeLine>
<Link id="l00274" /><CodeLine lineNumber="274"><span class="doxyHighlightComment">///     %cond = Cond</span></CodeLine>
<Link id="l00275" /><CodeLine lineNumber="275"><span class="doxyHighlightComment">///     br i1 %cond, %then&#95;bb, %orig&#95;bb</span></CodeLine>
<Link id="l00276" /><CodeLine lineNumber="276"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00277" /><CodeLine lineNumber="277"><span class="doxyHighlightComment">///   then&#95;bb:</span></CodeLine>
<Link id="l00278" /><CodeLine lineNumber="278"><span class="doxyHighlightComment">///     ; The clone of the original call instruction is placed in the &quot;then&quot;</span></CodeLine>
<Link id="l00279" /><CodeLine lineNumber="279"><span class="doxyHighlightComment">///     ; block. It is not yet promoted.</span></CodeLine>
<Link id="l00280" /><CodeLine lineNumber="280"><span class="doxyHighlightComment">///     %t1 = musttail call i32 %ptr()</span></CodeLine>
<Link id="l00281" /><CodeLine lineNumber="281"><span class="doxyHighlightComment">///     ret %t1</span></CodeLine>
<Link id="l00282" /><CodeLine lineNumber="282"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00283" /><CodeLine lineNumber="283"><span class="doxyHighlightComment">///   orig&#95;bb:</span></CodeLine>
<Link id="l00284" /><CodeLine lineNumber="284"><span class="doxyHighlightComment">///     ; The original call instruction stays in its original block.</span></CodeLine>
<Link id="l00285" /><CodeLine lineNumber="285"><span class="doxyHighlightComment">///     %t0 = musttail call i32 %ptr()</span></CodeLine>
<Link id="l00286" /><CodeLine lineNumber="286"><span class="doxyHighlightComment">///     ret %t0</span></CodeLine>
<Link id="l00287" /><CodeLine lineNumber="287" lineLink="#aaabc735841282ccafdf43b7c165b030e"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/callbase">CallBase</a> &amp;<a href="#aaabc735841282ccafdf43b7c165b030e">versionCallSiteWithCond</a>(<a href="/docs/api/classes/llvm/callbase">CallBase</a> &amp;CB, <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>,</span></CodeLine>
<Link id="l00288" /><CodeLine lineNumber="288"><span class="doxyHighlight">                                         <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42;BranchWeights) &#123;</span></CodeLine>
<Link id="l00289" /><CodeLine lineNumber="289"></CodeLine>
<Link id="l00290" /><CodeLine lineNumber="290"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> Builder(&amp;CB);</span></CodeLine>
<Link id="l00291" /><CodeLine lineNumber="291"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/callbase">CallBase</a> &#42;OrigInst = &amp;CB;</span></CodeLine>
<Link id="l00292" /><CodeLine lineNumber="292"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;OrigBlock = OrigInst-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>();</span></CodeLine>
<Link id="l00293" /><CodeLine lineNumber="293"></CodeLine>
<Link id="l00294" /><CodeLine lineNumber="294"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (OrigInst-&gt;<a href="/docs/api/classes/llvm/callbase/#a50426b12f4acb3d9f74d0778948e9597">isMustTailCall</a>()) &#123;</span></CodeLine>
<Link id="l00295" /><CodeLine lineNumber="295"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Create an if-then structure. The original instruction stays in its block,</span></CodeLine>
<Link id="l00296" /><CodeLine lineNumber="296"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// and a clone of the original instruction is placed in the &quot;then&quot; block.</span></CodeLine>
<Link id="l00297" /><CodeLine lineNumber="297"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;ThenTerm =</span></CodeLine>
<Link id="l00298" /><CodeLine lineNumber="298"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#ad957413955739c91204c96e33e0cc933">SplitBlockAndInsertIfThen</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, &amp;CB, </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">, BranchWeights);</span></CodeLine>
<Link id="l00299" /><CodeLine lineNumber="299"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ThenBlock = ThenTerm-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>();</span></CodeLine>
<Link id="l00300" /><CodeLine lineNumber="300"><span class="doxyHighlight">    ThenBlock-&gt;<a href="/docs/api/classes/llvm/value/#a35ee267850af7c235474a8c46c7ac5af">setName</a>(</span><span class="doxyHighlightStringLiteral">&quot;if.true.direct&#95;targ&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00301" /><CodeLine lineNumber="301"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/callbase">CallBase</a> &#42;NewInst = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CallBase&gt;</a>(OrigInst-&gt;<a href="/docs/api/classes/llvm/instruction/#a0a4d51e372293abe5e5f6dac133e80a6">clone</a>());</span></CodeLine>
<Link id="l00302" /><CodeLine lineNumber="302"><span class="doxyHighlight">    NewInst-&gt;<a href="/docs/api/classes/llvm/instruction/#a482498a1c760122fd33c7fc8190dd277">insertBefore</a>(ThenTerm-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>());</span></CodeLine>
<Link id="l00303" /><CodeLine lineNumber="303"></CodeLine>
<Link id="l00304" /><CodeLine lineNumber="304"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Place a clone of the optional bitcast after the new call site.</span></CodeLine>
<Link id="l00305" /><CodeLine lineNumber="305"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;NewRetVal = NewInst;</span></CodeLine>
<Link id="l00306" /><CodeLine lineNumber="306"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/#ab13c360340346d082b959b8cd79f2c1a">Next</a> = OrigInst-&gt;<a href="/docs/api/classes/llvm/ilist-node-with-parent/#a62ee7ece4986606d41363bc1f70d5ab2">getNextNode</a>();</span></CodeLine>
<Link id="l00307" /><CodeLine lineNumber="307"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;BitCast = <a href="/docs/api/namespaces/llvm/#a5f6182886dc2f96c204299e92c1565d5">dyn&#95;cast&#95;or&#95;null&lt;BitCastInst&gt;</a>(<a href="/docs/api/namespaces/llvm/#ab13c360340346d082b959b8cd79f2c1a">Next</a>)) &#123;</span></CodeLine>
<Link id="l00308" /><CodeLine lineNumber="308"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BitCast-&gt;getOperand(0) == OrigInst &amp;&amp;</span></CodeLine>
<Link id="l00309" /><CodeLine lineNumber="309"><span class="doxyHighlight">             </span><span class="doxyHighlightStringLiteral">&quot;bitcast following musttail call must use the call&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00310" /><CodeLine lineNumber="310"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> NewBitCast = BitCast-&gt;clone();</span></CodeLine>
<Link id="l00311" /><CodeLine lineNumber="311"><span class="doxyHighlight">      NewBitCast-&gt;replaceUsesOfWith(OrigInst, NewInst);</span></CodeLine>
<Link id="l00312" /><CodeLine lineNumber="312"><span class="doxyHighlight">      NewBitCast-&gt;insertBefore(ThenTerm-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>());</span></CodeLine>
<Link id="l00313" /><CodeLine lineNumber="313"><span class="doxyHighlight">      NewRetVal = NewBitCast;</span></CodeLine>
<Link id="l00314" /><CodeLine lineNumber="314"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#ab13c360340346d082b959b8cd79f2c1a">Next</a> = BitCast-&gt;getNextNode();</span></CodeLine>
<Link id="l00315" /><CodeLine lineNumber="315"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00316" /><CodeLine lineNumber="316"></CodeLine>
<Link id="l00317" /><CodeLine lineNumber="317"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Place a clone of the return instruction after the new call site.</span></CodeLine>
<Link id="l00318" /><CodeLine lineNumber="318"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/returninst">ReturnInst</a> &#42;Ret = <a href="/docs/api/namespaces/llvm/#a5f6182886dc2f96c204299e92c1565d5">dyn&#95;cast&#95;or&#95;null&lt;ReturnInst&gt;</a>(<a href="/docs/api/namespaces/llvm/#ab13c360340346d082b959b8cd79f2c1a">Next</a>);</span></CodeLine>
<Link id="l00319" /><CodeLine lineNumber="319"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Ret &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;musttail call must precede a ret with an optional bitcast&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00320" /><CodeLine lineNumber="320"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> NewRet = Ret-&gt;clone();</span></CodeLine>
<Link id="l00321" /><CodeLine lineNumber="321"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Ret-&gt;getReturnValue())</span></CodeLine>
<Link id="l00322" /><CodeLine lineNumber="322"><span class="doxyHighlight">      NewRet-&gt;replaceUsesOfWith(Ret-&gt;getReturnValue(), NewRetVal);</span></CodeLine>
<Link id="l00323" /><CodeLine lineNumber="323"><span class="doxyHighlight">    NewRet-&gt;insertBefore(ThenTerm-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>());</span></CodeLine>
<Link id="l00324" /><CodeLine lineNumber="324"></CodeLine>
<Link id="l00325" /><CodeLine lineNumber="325"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// A return instructions is terminating, so we don&#39;t need the terminator</span></CodeLine>
<Link id="l00326" /><CodeLine lineNumber="326"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// instruction just created.</span></CodeLine>
<Link id="l00327" /><CodeLine lineNumber="327"><span class="doxyHighlight">    ThenTerm-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</span></CodeLine>
<Link id="l00328" /><CodeLine lineNumber="328"></CodeLine>
<Link id="l00329" /><CodeLine lineNumber="329"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &#42;NewInst;</span></CodeLine>
<Link id="l00330" /><CodeLine lineNumber="330"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00331" /><CodeLine lineNumber="331"></CodeLine>
<Link id="l00332" /><CodeLine lineNumber="332"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create an if-then-else structure. The original instruction is moved into</span></CodeLine>
<Link id="l00333" /><CodeLine lineNumber="333"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the &quot;else&quot; block, and a clone of the original instruction is placed in the</span></CodeLine>
<Link id="l00334" /><CodeLine lineNumber="334"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// &quot;then&quot; block.</span></CodeLine>
<Link id="l00335" /><CodeLine lineNumber="335"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;ThenTerm = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00336" /><CodeLine lineNumber="336"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;ElseTerm = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00337" /><CodeLine lineNumber="337"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a7ac00229d8c59902686f52ed061cdc80">SplitBlockAndInsertIfThenElse</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, &amp;CB, &amp;ThenTerm, &amp;ElseTerm, BranchWeights);</span></CodeLine>
<Link id="l00338" /><CodeLine lineNumber="338"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ThenBlock = ThenTerm-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>();</span></CodeLine>
<Link id="l00339" /><CodeLine lineNumber="339"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ElseBlock = ElseTerm-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>();</span></CodeLine>
<Link id="l00340" /><CodeLine lineNumber="340"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;MergeBlock = OrigInst-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>();</span></CodeLine>
<Link id="l00341" /><CodeLine lineNumber="341"></CodeLine>
<Link id="l00342" /><CodeLine lineNumber="342"><span class="doxyHighlight">  ThenBlock-&gt;<a href="/docs/api/classes/llvm/value/#a35ee267850af7c235474a8c46c7ac5af">setName</a>(</span><span class="doxyHighlightStringLiteral">&quot;if.true.direct&#95;targ&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00343" /><CodeLine lineNumber="343"><span class="doxyHighlight">  ElseBlock-&gt;<a href="/docs/api/classes/llvm/value/#a35ee267850af7c235474a8c46c7ac5af">setName</a>(</span><span class="doxyHighlightStringLiteral">&quot;if.false.orig&#95;indirect&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00344" /><CodeLine lineNumber="344"><span class="doxyHighlight">  MergeBlock-&gt;<a href="/docs/api/classes/llvm/value/#a35ee267850af7c235474a8c46c7ac5af">setName</a>(</span><span class="doxyHighlightStringLiteral">&quot;if.end.icp&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00345" /><CodeLine lineNumber="345"></CodeLine>
<Link id="l00346" /><CodeLine lineNumber="346"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/callbase">CallBase</a> &#42;NewInst = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;CallBase&gt;</a>(OrigInst-&gt;<a href="/docs/api/classes/llvm/instruction/#a0a4d51e372293abe5e5f6dac133e80a6">clone</a>());</span></CodeLine>
<Link id="l00347" /><CodeLine lineNumber="347"><span class="doxyHighlight">  OrigInst-&gt;<a href="/docs/api/classes/llvm/instruction/#af67d1f3a518964d80a109bb3d9d5cf1e">moveBefore</a>(ElseTerm-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>());</span></CodeLine>
<Link id="l00348" /><CodeLine lineNumber="348"><span class="doxyHighlight">  NewInst-&gt;<a href="/docs/api/classes/llvm/instruction/#a482498a1c760122fd33c7fc8190dd277">insertBefore</a>(ThenTerm-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>());</span></CodeLine>
<Link id="l00349" /><CodeLine lineNumber="349"></CodeLine>
<Link id="l00350" /><CodeLine lineNumber="350"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the original call site is an invoke instruction, we have extra work to</span></CodeLine>
<Link id="l00351" /><CodeLine lineNumber="351"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// do since invoke instructions are terminating. We have to fix-up phi nodes</span></CodeLine>
<Link id="l00352" /><CodeLine lineNumber="352"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// in the invoke&#39;s normal and unwind destinations.</span></CodeLine>
<Link id="l00353" /><CodeLine lineNumber="353"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;OrigInvoke = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;InvokeInst&gt;</a>(OrigInst)) &#123;</span></CodeLine>
<Link id="l00354" /><CodeLine lineNumber="354"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewInvoke = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;InvokeInst&gt;</a>(NewInst);</span></CodeLine>
<Link id="l00355" /><CodeLine lineNumber="355"></CodeLine>
<Link id="l00356" /><CodeLine lineNumber="356"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Invoke instructions are terminating, so we don&#39;t need the terminator</span></CodeLine>
<Link id="l00357" /><CodeLine lineNumber="357"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// instructions that were just created.</span></CodeLine>
<Link id="l00358" /><CodeLine lineNumber="358"><span class="doxyHighlight">    ThenTerm-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</span></CodeLine>
<Link id="l00359" /><CodeLine lineNumber="359"><span class="doxyHighlight">    ElseTerm-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</span></CodeLine>
<Link id="l00360" /><CodeLine lineNumber="360"></CodeLine>
<Link id="l00361" /><CodeLine lineNumber="361"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Branch from the &quot;merge&quot; block to the original normal destination.</span></CodeLine>
<Link id="l00362" /><CodeLine lineNumber="362"><span class="doxyHighlight">    Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#ace45cae6925c65e9d6916e09dd5b17cc">SetInsertPoint</a>(MergeBlock);</span></CodeLine>
<Link id="l00363" /><CodeLine lineNumber="363"><span class="doxyHighlight">    Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#abab736a0141f903dc32a6f48828ad908">CreateBr</a>(OrigInvoke-&gt;getNormalDest());</span></CodeLine>
<Link id="l00364" /><CodeLine lineNumber="364"></CodeLine>
<Link id="l00365" /><CodeLine lineNumber="365"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Fix-up phi nodes in the original invoke&#39;s normal and unwind destinations.</span></CodeLine>
<Link id="l00366" /><CodeLine lineNumber="366"><span class="doxyHighlight">    <a href="#a51ff57d75f102e980e39535df6ff00bb">fixupPHINodeForNormalDest</a>(OrigInvoke, OrigBlock, MergeBlock);</span></CodeLine>
<Link id="l00367" /><CodeLine lineNumber="367"><span class="doxyHighlight">    <a href="#a59b92d3bbd9b21b61a2afbb73c10c3b0">fixupPHINodeForUnwindDest</a>(OrigInvoke, MergeBlock, ThenBlock, ElseBlock);</span></CodeLine>
<Link id="l00368" /><CodeLine lineNumber="368"></CodeLine>
<Link id="l00369" /><CodeLine lineNumber="369"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Now set the normal destinations of the invoke instructions to be the</span></CodeLine>
<Link id="l00370" /><CodeLine lineNumber="370"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// &quot;merge&quot; block.</span></CodeLine>
<Link id="l00371" /><CodeLine lineNumber="371"><span class="doxyHighlight">    OrigInvoke-&gt;setNormalDest(MergeBlock);</span></CodeLine>
<Link id="l00372" /><CodeLine lineNumber="372"><span class="doxyHighlight">    NewInvoke-&gt;setNormalDest(MergeBlock);</span></CodeLine>
<Link id="l00373" /><CodeLine lineNumber="373"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00374" /><CodeLine lineNumber="374"></CodeLine>
<Link id="l00375" /><CodeLine lineNumber="375"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create a phi node for the returned value of the call site.</span></CodeLine>
<Link id="l00376" /><CodeLine lineNumber="376"><span class="doxyHighlight">  <a href="#abdf3ba57973320bd702d3b12b0b8fa8c">createRetPHINode</a>(OrigInst, NewInst, MergeBlock, Builder);</span></CodeLine>
<Link id="l00377" /><CodeLine lineNumber="377"></CodeLine>
<Link id="l00378" /><CodeLine lineNumber="378"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &#42;NewInst;</span></CodeLine>
<Link id="l00379" /><CodeLine lineNumber="379"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00380" /><CodeLine lineNumber="380"></CodeLine>
<Link id="l00381" /><CodeLine lineNumber="381"><span class="doxyHighlightComment">// Predicate and clone the given call site using condition &#96;CB.callee ==</span></CodeLine>
<Link id="l00382" /><CodeLine lineNumber="382"><span class="doxyHighlightComment">// Callee&#96;. See the comment &#96;versionCallSiteWithCond&#96; for the transformation.</span></CodeLine>
<Link id="l00383" /><CodeLine lineNumber="383" lineLink="/docs/api/namespaces/llvm/#a84163d559062da6b736ab943644e0a16"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/callbase">CallBase</a> &amp;<a href="/docs/api/namespaces/llvm/#a84163d559062da6b736ab943644e0a16">llvm::versionCallSite</a>(<a href="/docs/api/classes/llvm/callbase">CallBase</a> &amp;CB, <a href="/docs/api/classes/llvm/value">Value</a> &#42;Callee,</span></CodeLine>
<Link id="l00384" /><CodeLine lineNumber="384"><span class="doxyHighlight">                                <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42;BranchWeights) &#123;</span></CodeLine>
<Link id="l00385" /><CodeLine lineNumber="385"></CodeLine>
<Link id="l00386" /><CodeLine lineNumber="386"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> Builder(&amp;CB);</span></CodeLine>
<Link id="l00387" /><CodeLine lineNumber="387"></CodeLine>
<Link id="l00388" /><CodeLine lineNumber="388"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Create the compare. The called value and callee must have the same type to</span></CodeLine>
<Link id="l00389" /><CodeLine lineNumber="389"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// be compared.</span></CodeLine>
<Link id="l00390" /><CodeLine lineNumber="390"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CB.<a href="/docs/api/classes/llvm/callbase/#a8d13199cbf4d080d3b5dcf330dad5d2c">getCalledOperand</a>()-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>() != Callee-&gt;getType())</span></CodeLine>
<Link id="l00391" /><CodeLine lineNumber="391"><span class="doxyHighlight">    Callee = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a932f08e32ea37a7019902ee467beb268">CreateBitCast</a>(Callee, CB.<a href="/docs/api/classes/llvm/callbase/#a8d13199cbf4d080d3b5dcf330dad5d2c">getCalledOperand</a>()-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>());</span></CodeLine>
<Link id="l00392" /><CodeLine lineNumber="392"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a> = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a8c75539a39f167f352b37ccdd788a7e4">CreateICmpEQ</a>(CB.<a href="/docs/api/classes/llvm/callbase/#a8d13199cbf4d080d3b5dcf330dad5d2c">getCalledOperand</a>(), Callee);</span></CodeLine>
<Link id="l00393" /><CodeLine lineNumber="393"></CodeLine>
<Link id="l00394" /><CodeLine lineNumber="394"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="#aaabc735841282ccafdf43b7c165b030e">versionCallSiteWithCond</a>(CB, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, BranchWeights);</span></CodeLine>
<Link id="l00395" /><CodeLine lineNumber="395"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00396" /><CodeLine lineNumber="396"></CodeLine>
<Link id="l00397" /><CodeLine lineNumber="397" lineLink="/docs/api/namespaces/llvm/#a0e5b9e42ea84622605acea0b0d721fda"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/#a0e5b9e42ea84622605acea0b0d721fda">llvm::isLegalToPromote</a>(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/callbase">CallBase</a> &amp;CB, <a href="/docs/api/classes/llvm/function">Function</a> &#42;Callee,</span></CodeLine>
<Link id="l00398" /><CodeLine lineNumber="398"><span class="doxyHighlight">                            </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">char</span><span class="doxyHighlight"> &#42;&#42;FailureReason) &#123;</span></CodeLine>
<Link id="l00399" /><CodeLine lineNumber="399"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!CB.<a href="/docs/api/classes/llvm/callbase/#a2b1ae7cf1bafdd43d1fee4c6ad0a2913">getCalledFunction</a>() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Only indirect call sites can be promoted&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00400" /><CodeLine lineNumber="400"></CodeLine>
<Link id="l00401" /><CodeLine lineNumber="401"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a> = Callee-&gt;getDataLayout();</span></CodeLine>
<Link id="l00402" /><CodeLine lineNumber="402"></CodeLine>
<Link id="l00403" /><CodeLine lineNumber="403"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Check the return type. The callee&#39;s return value type must be bitcast</span></CodeLine>
<Link id="l00404" /><CodeLine lineNumber="404"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// compatible with the call site&#39;s type.</span></CodeLine>
<Link id="l00405" /><CodeLine lineNumber="405"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/type">Type</a> &#42;CallRetTy = CB.<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>();</span></CodeLine>
<Link id="l00406" /><CodeLine lineNumber="406"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/type">Type</a> &#42;FuncRetTy = Callee-&gt;getReturnType();</span></CodeLine>
<Link id="l00407" /><CodeLine lineNumber="407"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CallRetTy != FuncRetTy)</span></CodeLine>
<Link id="l00408" /><CodeLine lineNumber="408"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/classes/llvm/castinst/#a94f850488e8bda1d1b400821d6d61bd1">CastInst::isBitOrNoopPointerCastable</a>(FuncRetTy, CallRetTy, <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>)) &#123;</span></CodeLine>
<Link id="l00409" /><CodeLine lineNumber="409"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FailureReason)</span></CodeLine>
<Link id="l00410" /><CodeLine lineNumber="410"><span class="doxyHighlight">        &#42;FailureReason = </span><span class="doxyHighlightStringLiteral">&quot;Return type mismatch&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00411" /><CodeLine lineNumber="411"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00412" /><CodeLine lineNumber="412"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00413" /><CodeLine lineNumber="413"></CodeLine>
<Link id="l00414" /><CodeLine lineNumber="414"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The number of formal arguments of the callee.</span></CodeLine>
<Link id="l00415" /><CodeLine lineNumber="415"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumParams = Callee-&gt;getFunctionType()-&gt;getNumParams();</span></CodeLine>
<Link id="l00416" /><CodeLine lineNumber="416"></CodeLine>
<Link id="l00417" /><CodeLine lineNumber="417"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The number of actual arguments in the call.</span></CodeLine>
<Link id="l00418" /><CodeLine lineNumber="418"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NumArgs = CB.<a href="/docs/api/classes/llvm/callbase/#adde2ea00dd2613ee41bfe91908e4e68e">arg&#95;size</a>();</span></CodeLine>
<Link id="l00419" /><CodeLine lineNumber="419"></CodeLine>
<Link id="l00420" /><CodeLine lineNumber="420"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Check the number of arguments. The callee and call site must agree on the</span></CodeLine>
<Link id="l00421" /><CodeLine lineNumber="421"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// number of arguments.</span></CodeLine>
<Link id="l00422" /><CodeLine lineNumber="422"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NumArgs != NumParams &amp;&amp; !Callee-&gt;isVarArg()) &#123;</span></CodeLine>
<Link id="l00423" /><CodeLine lineNumber="423"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FailureReason)</span></CodeLine>
<Link id="l00424" /><CodeLine lineNumber="424"><span class="doxyHighlight">      &#42;FailureReason = </span><span class="doxyHighlightStringLiteral">&quot;The number of arguments mismatch&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00425" /><CodeLine lineNumber="425"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00426" /><CodeLine lineNumber="426"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00427" /><CodeLine lineNumber="427"></CodeLine>
<Link id="l00428" /><CodeLine lineNumber="428"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Check the argument types. The callee&#39;s formal argument types must be</span></CodeLine>
<Link id="l00429" /><CodeLine lineNumber="429"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// bitcast compatible with the corresponding actual argument types of the call</span></CodeLine>
<Link id="l00430" /><CodeLine lineNumber="430"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// site.</span></CodeLine>
<Link id="l00431" /><CodeLine lineNumber="431"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = 0;</span></CodeLine>
<Link id="l00432" /><CodeLine lineNumber="432"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (; <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> &lt; NumParams; ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &#123;</span></CodeLine>
<Link id="l00433" /><CodeLine lineNumber="433"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Make sure that the callee and call agree on byval/inalloca. The types do</span></CodeLine>
<Link id="l00434" /><CodeLine lineNumber="434"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// not have to match.</span></CodeLine>
<Link id="l00435" /><CodeLine lineNumber="435"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Callee-&gt;hasParamAttribute(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, Attribute::ByVal) !=</span></CodeLine>
<Link id="l00436" /><CodeLine lineNumber="436"><span class="doxyHighlight">        CB.<a href="/docs/api/classes/llvm/callbase/#ae0c55761fce39dd71617690b04385193">getAttributes</a>().hasParamAttr(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, Attribute::ByVal)) &#123;</span></CodeLine>
<Link id="l00437" /><CodeLine lineNumber="437"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FailureReason)</span></CodeLine>
<Link id="l00438" /><CodeLine lineNumber="438"><span class="doxyHighlight">        &#42;FailureReason = </span><span class="doxyHighlightStringLiteral">&quot;byval mismatch&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00439" /><CodeLine lineNumber="439"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00440" /><CodeLine lineNumber="440"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00441" /><CodeLine lineNumber="441"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Callee-&gt;hasParamAttribute(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, Attribute::InAlloca) !=</span></CodeLine>
<Link id="l00442" /><CodeLine lineNumber="442"><span class="doxyHighlight">        CB.<a href="/docs/api/classes/llvm/callbase/#ae0c55761fce39dd71617690b04385193">getAttributes</a>().hasParamAttr(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, Attribute::InAlloca)) &#123;</span></CodeLine>
<Link id="l00443" /><CodeLine lineNumber="443"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FailureReason)</span></CodeLine>
<Link id="l00444" /><CodeLine lineNumber="444"><span class="doxyHighlight">        &#42;FailureReason = </span><span class="doxyHighlightStringLiteral">&quot;inalloca mismatch&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00445" /><CodeLine lineNumber="445"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00446" /><CodeLine lineNumber="446"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00447" /><CodeLine lineNumber="447"></CodeLine>
<Link id="l00448" /><CodeLine lineNumber="448"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/type">Type</a> &#42;FormalTy = Callee-&gt;getFunctionType()-&gt;getFunctionParamType(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</span></CodeLine>
<Link id="l00449" /><CodeLine lineNumber="449"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/type">Type</a> &#42;ActualTy = CB.<a href="/docs/api/classes/llvm/callbase/#aabd76e6a8a23a5af1ce4d3c310d88bcd">getArgOperand</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>();</span></CodeLine>
<Link id="l00450" /><CodeLine lineNumber="450"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FormalTy == ActualTy)</span></CodeLine>
<Link id="l00451" /><CodeLine lineNumber="451"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00452" /><CodeLine lineNumber="452"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/classes/llvm/castinst/#a94f850488e8bda1d1b400821d6d61bd1">CastInst::isBitOrNoopPointerCastable</a>(ActualTy, FormalTy, <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>)) &#123;</span></CodeLine>
<Link id="l00453" /><CodeLine lineNumber="453"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FailureReason)</span></CodeLine>
<Link id="l00454" /><CodeLine lineNumber="454"><span class="doxyHighlight">        &#42;FailureReason = </span><span class="doxyHighlightStringLiteral">&quot;Argument type mismatch&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00455" /><CodeLine lineNumber="455"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00456" /><CodeLine lineNumber="456"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00457" /><CodeLine lineNumber="457"></CodeLine>
<Link id="l00458" /><CodeLine lineNumber="458"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// MustTail call needs stricter type match. See</span></CodeLine>
<Link id="l00459" /><CodeLine lineNumber="459"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Verifier::verifyMustTailCall().</span></CodeLine>
<Link id="l00460" /><CodeLine lineNumber="460"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CB.<a href="/docs/api/classes/llvm/callbase/#a50426b12f4acb3d9f74d0778948e9597">isMustTailCall</a>()) &#123;</span></CodeLine>
<Link id="l00461" /><CodeLine lineNumber="461"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/pointertype">PointerType</a> &#42;PF = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;PointerType&gt;</a>(FormalTy);</span></CodeLine>
<Link id="l00462" /><CodeLine lineNumber="462"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/pointertype">PointerType</a> &#42;PA = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;PointerType&gt;</a>(ActualTy);</span></CodeLine>
<Link id="l00463" /><CodeLine lineNumber="463"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!PF || !PA || PF-&gt;<a href="/docs/api/classes/llvm/pointertype/#af8aeced5e71d2589fa3e9791043af5cb">getAddressSpace</a>() != PA-&gt;<a href="/docs/api/classes/llvm/pointertype/#af8aeced5e71d2589fa3e9791043af5cb">getAddressSpace</a>()) &#123;</span></CodeLine>
<Link id="l00464" /><CodeLine lineNumber="464"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FailureReason)</span></CodeLine>
<Link id="l00465" /><CodeLine lineNumber="465"><span class="doxyHighlight">          &#42;FailureReason = </span><span class="doxyHighlightStringLiteral">&quot;Musttail call Argument type mismatch&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00466" /><CodeLine lineNumber="466"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00467" /><CodeLine lineNumber="467"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00468" /><CodeLine lineNumber="468"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00469" /><CodeLine lineNumber="469"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00470" /><CodeLine lineNumber="470"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (; <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> &lt; NumArgs; <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>++) &#123;</span></CodeLine>
<Link id="l00471" /><CodeLine lineNumber="471"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Vararg functions can have more arguments than parameters.</span></CodeLine>
<Link id="l00472" /><CodeLine lineNumber="472"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Callee-&gt;isVarArg());</span></CodeLine>
<Link id="l00473" /><CodeLine lineNumber="473"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CB.<a href="/docs/api/classes/llvm/callbase/#a4cbb2344996abd4332716e76178ad4f4">paramHasAttr</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, Attribute::StructRet)) &#123;</span></CodeLine>
<Link id="l00474" /><CodeLine lineNumber="474"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FailureReason)</span></CodeLine>
<Link id="l00475" /><CodeLine lineNumber="475"><span class="doxyHighlight">        &#42;FailureReason = </span><span class="doxyHighlightStringLiteral">&quot;SRet arg to vararg function&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00476" /><CodeLine lineNumber="476"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00477" /><CodeLine lineNumber="477"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00478" /><CodeLine lineNumber="478"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00479" /><CodeLine lineNumber="479"></CodeLine>
<Link id="l00480" /><CodeLine lineNumber="480"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00481" /><CodeLine lineNumber="481"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00482" /><CodeLine lineNumber="482"></CodeLine>
<Link id="l00483" /><CodeLine lineNumber="483" lineLink="/docs/api/namespaces/llvm/#a90c1755a8480ebc1dcc4f05d56271b00"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/callbase">CallBase</a> &amp;<a href="/docs/api/namespaces/llvm/#a90c1755a8480ebc1dcc4f05d56271b00">llvm::promoteCall</a>(<a href="/docs/api/classes/llvm/callbase">CallBase</a> &amp;CB, <a href="/docs/api/classes/llvm/function">Function</a> &#42;Callee,</span></CodeLine>
<Link id="l00484" /><CodeLine lineNumber="484"><span class="doxyHighlight">                            <a href="/docs/api/classes/llvm/castinst">CastInst</a> &#42;&#42;RetBitCast) &#123;</span></CodeLine>
<Link id="l00485" /><CodeLine lineNumber="485"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!CB.<a href="/docs/api/classes/llvm/callbase/#a2b1ae7cf1bafdd43d1fee4c6ad0a2913">getCalledFunction</a>() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Only indirect call sites can be promoted&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00486" /><CodeLine lineNumber="486"></CodeLine>
<Link id="l00487" /><CodeLine lineNumber="487"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Set the called function of the call site to be the given callee (but don&#39;t</span></CodeLine>
<Link id="l00488" /><CodeLine lineNumber="488"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// change the type).</span></CodeLine>
<Link id="l00489" /><CodeLine lineNumber="489"><span class="doxyHighlight">  CB.<a href="/docs/api/classes/llvm/callbase/#ad70fe60b7ed052c6a74863944b518251">setCalledOperand</a>(Callee);</span></CodeLine>
<Link id="l00490" /><CodeLine lineNumber="490"></CodeLine>
<Link id="l00491" /><CodeLine lineNumber="491"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Since the call site will no longer be direct, we must clear metadata that</span></CodeLine>
<Link id="l00492" /><CodeLine lineNumber="492"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// is only appropriate for indirect calls. This includes !prof and !callees</span></CodeLine>
<Link id="l00493" /><CodeLine lineNumber="493"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// metadata.</span></CodeLine>
<Link id="l00494" /><CodeLine lineNumber="494"><span class="doxyHighlight">  CB.<a href="/docs/api/classes/llvm/instruction/#a9247a212ea89acc9573fa7e7f557eaba">setMetadata</a>(LLVMContext::MD&#95;prof, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00495" /><CodeLine lineNumber="495"><span class="doxyHighlight">  CB.<a href="/docs/api/classes/llvm/instruction/#a9247a212ea89acc9573fa7e7f557eaba">setMetadata</a>(LLVMContext::MD&#95;callees, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00496" /><CodeLine lineNumber="496"></CodeLine>
<Link id="l00497" /><CodeLine lineNumber="497"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the function type of the call site matches that of the callee, no</span></CodeLine>
<Link id="l00498" /><CodeLine lineNumber="498"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// additional work is required.</span></CodeLine>
<Link id="l00499" /><CodeLine lineNumber="499"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CB.<a href="/docs/api/classes/llvm/callbase/#ac3c35bd078a268a207f607d0f57dadba">getFunctionType</a>() == Callee-&gt;getFunctionType())</span></CodeLine>
<Link id="l00500" /><CodeLine lineNumber="500"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> CB;</span></CodeLine>
<Link id="l00501" /><CodeLine lineNumber="501"></CodeLine>
<Link id="l00502" /><CodeLine lineNumber="502"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Save the return types of the call site and callee.</span></CodeLine>
<Link id="l00503" /><CodeLine lineNumber="503"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/type">Type</a> &#42;CallSiteRetTy = CB.<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>();</span></CodeLine>
<Link id="l00504" /><CodeLine lineNumber="504"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/type">Type</a> &#42;CalleeRetTy = Callee-&gt;getReturnType();</span></CodeLine>
<Link id="l00505" /><CodeLine lineNumber="505"></CodeLine>
<Link id="l00506" /><CodeLine lineNumber="506"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Change the function type of the call site the match that of the callee.</span></CodeLine>
<Link id="l00507" /><CodeLine lineNumber="507"><span class="doxyHighlight">  CB.<a href="/docs/api/classes/llvm/callbase/#aba272b7337f4e135f28eeb0bcc69adbb">mutateFunctionType</a>(Callee-&gt;getFunctionType());</span></CodeLine>
<Link id="l00508" /><CodeLine lineNumber="508"></CodeLine>
<Link id="l00509" /><CodeLine lineNumber="509"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Inspect the arguments of the call site. If an argument&#39;s type doesn&#39;t</span></CodeLine>
<Link id="l00510" /><CodeLine lineNumber="510"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// match the corresponding formal argument&#39;s type in the callee, bitcast it</span></CodeLine>
<Link id="l00511" /><CodeLine lineNumber="511"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// to the correct type.</span></CodeLine>
<Link id="l00512" /><CodeLine lineNumber="512"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> CalleeType = Callee-&gt;getFunctionType();</span></CodeLine>
<Link id="l00513" /><CodeLine lineNumber="513"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> CalleeParamNum = CalleeType-&gt;getNumParams();</span></CodeLine>
<Link id="l00514" /><CodeLine lineNumber="514"></CodeLine>
<Link id="l00515" /><CodeLine lineNumber="515"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/llvmcontext">LLVMContext</a> &amp;Ctx = Callee-&gt;getContext();</span></CodeLine>
<Link id="l00516" /><CodeLine lineNumber="516"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> AttributeList &amp;CallerPAL = CB.<a href="/docs/api/classes/llvm/callbase/#ae0c55761fce39dd71617690b04385193">getAttributes</a>();</span></CodeLine>
<Link id="l00517" /><CodeLine lineNumber="517"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The new list of argument attributes.</span></CodeLine>
<Link id="l00518" /><CodeLine lineNumber="518"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;AttributeSet, 4&gt;</a> NewArgAttrs;</span></CodeLine>
<Link id="l00519" /><CodeLine lineNumber="519"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> AttributeChanged = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00520" /><CodeLine lineNumber="520"></CodeLine>
<Link id="l00521" /><CodeLine lineNumber="521"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> ArgNo = 0; ArgNo &lt; CalleeParamNum; ++ArgNo) &#123;</span></CodeLine>
<Link id="l00522" /><CodeLine lineNumber="522"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Arg = CB.<a href="/docs/api/classes/llvm/callbase/#aabd76e6a8a23a5af1ce4d3c310d88bcd">getArgOperand</a>(ArgNo);</span></CodeLine>
<Link id="l00523" /><CodeLine lineNumber="523"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/type">Type</a> &#42;FormalTy = CalleeType-&gt;getParamType(ArgNo);</span></CodeLine>
<Link id="l00524" /><CodeLine lineNumber="524"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/type">Type</a> &#42;ActualTy = Arg-&gt;getType();</span></CodeLine>
<Link id="l00525" /><CodeLine lineNumber="525"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FormalTy != ActualTy) &#123;</span></CodeLine>
<Link id="l00526" /><CodeLine lineNumber="526"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Cast =</span></CodeLine>
<Link id="l00527" /><CodeLine lineNumber="527"><span class="doxyHighlight">          <a href="/docs/api/classes/llvm/castinst/#acdb02479a44bbebcabf8b7b5e1baa921">CastInst::CreateBitOrPointerCast</a>(Arg, FormalTy, </span><span class="doxyHighlightStringLiteral">&quot;&quot;</span><span class="doxyHighlight">, CB.<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>());</span></CodeLine>
<Link id="l00528" /><CodeLine lineNumber="528"><span class="doxyHighlight">      CB.<a href="/docs/api/classes/llvm/callbase/#abc10b887caad109288ffceb230493a85">setArgOperand</a>(ArgNo, Cast);</span></CodeLine>
<Link id="l00529" /><CodeLine lineNumber="529"></CodeLine>
<Link id="l00530" /><CodeLine lineNumber="530"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Remove any incompatible attributes for the argument.</span></CodeLine>
<Link id="l00531" /><CodeLine lineNumber="531"><span class="doxyHighlight">      AttrBuilder ArgAttrs(Ctx, CallerPAL.getParamAttrs(ArgNo));</span></CodeLine>
<Link id="l00532" /><CodeLine lineNumber="532"><span class="doxyHighlight">      ArgAttrs.remove(AttributeFuncs::typeIncompatible(</span></CodeLine>
<Link id="l00533" /><CodeLine lineNumber="533"><span class="doxyHighlight">          FormalTy, CallerPAL.getParamAttrs(ArgNo)));</span></CodeLine>
<Link id="l00534" /><CodeLine lineNumber="534"></CodeLine>
<Link id="l00535" /><CodeLine lineNumber="535"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// We may have a different byval/inalloca type.</span></CodeLine>
<Link id="l00536" /><CodeLine lineNumber="536"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ArgAttrs.getByValType())</span></CodeLine>
<Link id="l00537" /><CodeLine lineNumber="537"><span class="doxyHighlight">        ArgAttrs.addByValAttr(Callee-&gt;getParamByValType(ArgNo));</span></CodeLine>
<Link id="l00538" /><CodeLine lineNumber="538"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ArgAttrs.getInAllocaType())</span></CodeLine>
<Link id="l00539" /><CodeLine lineNumber="539"><span class="doxyHighlight">        ArgAttrs.addInAllocaAttr(Callee-&gt;getParamInAllocaType(ArgNo));</span></CodeLine>
<Link id="l00540" /><CodeLine lineNumber="540"></CodeLine>
<Link id="l00541" /><CodeLine lineNumber="541"><span class="doxyHighlight">      NewArgAttrs.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(<a href="/docs/api/classes/llvm/attributeset/#ae8ed437b15a7ca943716e5284a9cb9a6">AttributeSet::get</a>(Ctx, ArgAttrs));</span></CodeLine>
<Link id="l00542" /><CodeLine lineNumber="542"><span class="doxyHighlight">      AttributeChanged = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00543" /><CodeLine lineNumber="543"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00544" /><CodeLine lineNumber="544"><span class="doxyHighlight">      NewArgAttrs.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(CallerPAL.getParamAttrs(ArgNo));</span></CodeLine>
<Link id="l00545" /><CodeLine lineNumber="545"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00546" /><CodeLine lineNumber="546"></CodeLine>
<Link id="l00547" /><CodeLine lineNumber="547"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the return type of the call site doesn&#39;t match that of the callee, cast</span></CodeLine>
<Link id="l00548" /><CodeLine lineNumber="548"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the returned value to the appropriate type.</span></CodeLine>
<Link id="l00549" /><CodeLine lineNumber="549"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Remove any incompatible return value attribute.</span></CodeLine>
<Link id="l00550" /><CodeLine lineNumber="550"><span class="doxyHighlight">  AttrBuilder RAttrs(Ctx, CallerPAL.getRetAttrs());</span></CodeLine>
<Link id="l00551" /><CodeLine lineNumber="551"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CallSiteRetTy-&gt;<a href="/docs/api/classes/llvm/type/#ae8eaa0b4eeac52a2b2282cb1bfd981ae">isVoidTy</a>() &amp;&amp; CallSiteRetTy != CalleeRetTy) &#123;</span></CodeLine>
<Link id="l00552" /><CodeLine lineNumber="552"><span class="doxyHighlight">    <a href="#a8c9ae0be5e6bcad90cdf141962a117f3">createRetBitCast</a>(CB, CallSiteRetTy, RetBitCast);</span></CodeLine>
<Link id="l00553" /><CodeLine lineNumber="553"><span class="doxyHighlight">    RAttrs.remove(</span></CodeLine>
<Link id="l00554" /><CodeLine lineNumber="554"><span class="doxyHighlight">        AttributeFuncs::typeIncompatible(CalleeRetTy, CallerPAL.getRetAttrs()));</span></CodeLine>
<Link id="l00555" /><CodeLine lineNumber="555"><span class="doxyHighlight">    AttributeChanged = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00556" /><CodeLine lineNumber="556"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00557" /><CodeLine lineNumber="557"></CodeLine>
<Link id="l00558" /><CodeLine lineNumber="558"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Set the new callsite attribute.</span></CodeLine>
<Link id="l00559" /><CodeLine lineNumber="559"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (AttributeChanged)</span></CodeLine>
<Link id="l00560" /><CodeLine lineNumber="560"><span class="doxyHighlight">    CB.<a href="/docs/api/classes/llvm/callbase/#a9da3b29e8e71b9be4645874e1721207a">setAttributes</a>(AttributeList::get(Ctx, CallerPAL.getFnAttrs(),</span></CodeLine>
<Link id="l00561" /><CodeLine lineNumber="561"><span class="doxyHighlight">                                        <a href="/docs/api/classes/llvm/attributeset/#ae8ed437b15a7ca943716e5284a9cb9a6">AttributeSet::get</a>(Ctx, RAttrs),</span></CodeLine>
<Link id="l00562" /><CodeLine lineNumber="562"><span class="doxyHighlight">                                        NewArgAttrs));</span></CodeLine>
<Link id="l00563" /><CodeLine lineNumber="563"></CodeLine>
<Link id="l00564" /><CodeLine lineNumber="564"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> CB;</span></CodeLine>
<Link id="l00565" /><CodeLine lineNumber="565"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00566" /><CodeLine lineNumber="566"></CodeLine>
<Link id="l00567" /><CodeLine lineNumber="567" lineLink="/docs/api/namespaces/llvm/#a23c23396eb61a7a78555e926700dbf47"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/callbase">CallBase</a> &amp;<a href="/docs/api/namespaces/llvm/#a23c23396eb61a7a78555e926700dbf47">llvm::promoteCallWithIfThenElse</a>(<a href="/docs/api/classes/llvm/callbase">CallBase</a> &amp;CB, <a href="/docs/api/classes/llvm/function">Function</a> &#42;Callee,</span></CodeLine>
<Link id="l00568" /><CodeLine lineNumber="568"><span class="doxyHighlight">                                          <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42;BranchWeights) &#123;</span></CodeLine>
<Link id="l00569" /><CodeLine lineNumber="569"></CodeLine>
<Link id="l00570" /><CodeLine lineNumber="570"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Version the indirect call site. If the called value is equal to the given</span></CodeLine>
<Link id="l00571" /><CodeLine lineNumber="571"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// callee, &#39;NewInst&#39; will be executed, otherwise the original call site will</span></CodeLine>
<Link id="l00572" /><CodeLine lineNumber="572"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// be executed.</span></CodeLine>
<Link id="l00573" /><CodeLine lineNumber="573"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/callbase">CallBase</a> &amp;NewInst = <a href="/docs/api/namespaces/llvm/#a84163d559062da6b736ab943644e0a16">versionCallSite</a>(CB, Callee, BranchWeights);</span></CodeLine>
<Link id="l00574" /><CodeLine lineNumber="574"></CodeLine>
<Link id="l00575" /><CodeLine lineNumber="575"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Promote &#39;NewInst&#39; so that it directly calls the desired function.</span></CodeLine>
<Link id="l00576" /><CodeLine lineNumber="576"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/#a90c1755a8480ebc1dcc4f05d56271b00">promoteCall</a>(NewInst, Callee);</span></CodeLine>
<Link id="l00577" /><CodeLine lineNumber="577"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00578" /><CodeLine lineNumber="578"></CodeLine>
<Link id="l00579" /><CodeLine lineNumber="579" lineLink="/docs/api/namespaces/llvm/#a9469fd548994812c12e4c10d42ec82a3"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/callbase">CallBase</a> &#42;<a href="/docs/api/namespaces/llvm/#a23c23396eb61a7a78555e926700dbf47">llvm::promoteCallWithIfThenElse</a>(<a href="/docs/api/classes/llvm/callbase">CallBase</a> &amp;CB, <a href="/docs/api/classes/llvm/function">Function</a> &amp;Callee,</span></CodeLine>
<Link id="l00580" /><CodeLine lineNumber="580"><span class="doxyHighlight">                                          <a href="/docs/api/classes/llvm/pgocontextualprofile">PGOContextualProfile</a> &amp;CtxProf) &#123;</span></CodeLine>
<Link id="l00581" /><CodeLine lineNumber="581"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(CB.<a href="/docs/api/classes/llvm/callbase/#a574efc7d85ff014d5f15e077f3c82e6b">isIndirectCall</a>());</span></CodeLine>
<Link id="l00582" /><CodeLine lineNumber="582"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CtxProf.<a href="/docs/api/classes/llvm/pgocontextualprofile/#af33a9e09888e910edab4b81d2b601f80">isFunctionKnown</a>(Callee))</span></CodeLine>
<Link id="l00583" /><CodeLine lineNumber="583"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00584" /><CodeLine lineNumber="584"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;Caller = &#42;CB.<a href="/docs/api/classes/llvm/instruction/#a6a66ebb3aa12757479a3c88de77d78f8">getFunction</a>();</span></CodeLine>
<Link id="l00585" /><CodeLine lineNumber="585"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;CSInstr = <a href="/docs/api/classes/llvm/ctxprofanalysis/#aa20d83f600303548f2e24aa2fc98e377">CtxProfAnalysis::getCallsiteInstrumentation</a>(CB);</span></CodeLine>
<Link id="l00586" /><CodeLine lineNumber="586"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CSInstr)</span></CodeLine>
<Link id="l00587" /><CodeLine lineNumber="587"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00588" /><CodeLine lineNumber="588"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> uint64&#95;t CSIndex = CSInstr-&gt;getIndex()-&gt;getZExtValue();</span></CodeLine>
<Link id="l00589" /><CodeLine lineNumber="589"></CodeLine>
<Link id="l00590" /><CodeLine lineNumber="590"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/callbase">CallBase</a> &amp;<a href="/docs/api/namespaces/llvm/#a0e00fad9c34de40b1e31f3aa6f8e024caf8d0d4845b0b074d9f2e0f2ace6683da">DirectCall</a> = <a href="/docs/api/namespaces/llvm/#a90c1755a8480ebc1dcc4f05d56271b00">promoteCall</a>(</span></CodeLine>
<Link id="l00591" /><CodeLine lineNumber="591"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#a84163d559062da6b736ab943644e0a16">versionCallSite</a>(CB, &amp;Callee, </span><span class="doxyHighlightComment">/&#42;BranchWeights=&#42;/</span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">), &amp;Callee);</span></CodeLine>
<Link id="l00592" /><CodeLine lineNumber="592"><span class="doxyHighlight">  CSInstr-&gt;moveBefore(CB.<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>());</span></CodeLine>
<Link id="l00593" /><CodeLine lineNumber="593"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> NewCSID = CtxProf.<a href="/docs/api/classes/llvm/pgocontextualprofile/#ac3c5b4f301446a93ad24380ce9108e4e">allocateNextCallsiteIndex</a>(Caller);</span></CodeLine>
<Link id="l00594" /><CodeLine lineNumber="594"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;NewCSInstr = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;InstrProfCallsite&gt;</a>(CSInstr-&gt;clone());</span></CodeLine>
<Link id="l00595" /><CodeLine lineNumber="595"><span class="doxyHighlight">  NewCSInstr-&gt;setIndex(NewCSID);</span></CodeLine>
<Link id="l00596" /><CodeLine lineNumber="596"><span class="doxyHighlight">  NewCSInstr-&gt;setCallee(&amp;Callee);</span></CodeLine>
<Link id="l00597" /><CodeLine lineNumber="597"><span class="doxyHighlight">  NewCSInstr-&gt;insertBefore(<a href="/docs/api/namespaces/llvm/#a0e00fad9c34de40b1e31f3aa6f8e024caf8d0d4845b0b074d9f2e0f2ace6683da">DirectCall</a>.getIterator());</span></CodeLine>
<Link id="l00598" /><CodeLine lineNumber="598"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;DirectBB = &#42;<a href="/docs/api/namespaces/llvm/#a0e00fad9c34de40b1e31f3aa6f8e024caf8d0d4845b0b074d9f2e0f2ace6683da">DirectCall</a>.getParent();</span></CodeLine>
<Link id="l00599" /><CodeLine lineNumber="599"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;IndirectBB = &#42;CB.<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>();</span></CodeLine>
<Link id="l00600" /><CodeLine lineNumber="600"></CodeLine>
<Link id="l00601" /><CodeLine lineNumber="601"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((<a href="/docs/api/classes/llvm/ctxprofanalysis/#a3a31a6be1881280b30e349edabc9ca43">CtxProfAnalysis::getBBInstrumentation</a>(IndirectBB) == </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">) &amp;&amp;</span></CodeLine>
<Link id="l00602" /><CodeLine lineNumber="602"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;The ICP direct BB is new, it shouldn&#39;t have instrumentation&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00603" /><CodeLine lineNumber="603"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((<a href="/docs/api/classes/llvm/ctxprofanalysis/#a3a31a6be1881280b30e349edabc9ca43">CtxProfAnalysis::getBBInstrumentation</a>(DirectBB) == </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">) &amp;&amp;</span></CodeLine>
<Link id="l00604" /><CodeLine lineNumber="604"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;The ICP indirect BB is new, it shouldn&#39;t have instrumentation&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00605" /><CodeLine lineNumber="605"></CodeLine>
<Link id="l00606" /><CodeLine lineNumber="606"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Allocate counters for the new basic blocks.</span></CodeLine>
<Link id="l00607" /><CodeLine lineNumber="607"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> uint32&#95;t DirectID = CtxProf.<a href="/docs/api/classes/llvm/pgocontextualprofile/#a84796b39de9d068136440712aa81fdc2">allocateNextCounterIndex</a>(Caller);</span></CodeLine>
<Link id="l00608" /><CodeLine lineNumber="608"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> uint32&#95;t IndirectID = CtxProf.<a href="/docs/api/classes/llvm/pgocontextualprofile/#a84796b39de9d068136440712aa81fdc2">allocateNextCounterIndex</a>(Caller);</span></CodeLine>
<Link id="l00609" /><CodeLine lineNumber="609"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;EntryBBIns =</span></CodeLine>
<Link id="l00610" /><CodeLine lineNumber="610"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/ctxprofanalysis/#a3a31a6be1881280b30e349edabc9ca43">CtxProfAnalysis::getBBInstrumentation</a>(Caller.getEntryBlock());</span></CodeLine>
<Link id="l00611" /><CodeLine lineNumber="611"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;DirectBBIns = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;InstrProfCntrInstBase&gt;</a>(EntryBBIns-&gt;clone());</span></CodeLine>
<Link id="l00612" /><CodeLine lineNumber="612"><span class="doxyHighlight">  DirectBBIns-&gt;setIndex(DirectID);</span></CodeLine>
<Link id="l00613" /><CodeLine lineNumber="613"><span class="doxyHighlight">  DirectBBIns-&gt;insertInto(&amp;DirectBB, DirectBB.getFirstInsertionPt());</span></CodeLine>
<Link id="l00614" /><CodeLine lineNumber="614"></CodeLine>
<Link id="l00615" /><CodeLine lineNumber="615"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;IndirectBBIns = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;InstrProfCntrInstBase&gt;</a>(EntryBBIns-&gt;clone());</span></CodeLine>
<Link id="l00616" /><CodeLine lineNumber="616"><span class="doxyHighlight">  IndirectBBIns-&gt;setIndex(IndirectID);</span></CodeLine>
<Link id="l00617" /><CodeLine lineNumber="617"><span class="doxyHighlight">  IndirectBBIns-&gt;insertInto(&amp;IndirectBB, IndirectBB.getFirstInsertionPt());</span></CodeLine>
<Link id="l00618" /><CodeLine lineNumber="618"></CodeLine>
<Link id="l00619" /><CodeLine lineNumber="619"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/globalvalue/#a3af0428ec6e48cb2f05c199b7b9f7e07">GlobalValue::GUID</a> CalleeGUID = <a href="/docs/api/classes/llvm/assignguidpass/#a00cd72af35cb6bdeae06467500b531ae">AssignGUIDPass::getGUID</a>(Callee);</span></CodeLine>
<Link id="l00620" /><CodeLine lineNumber="620"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> uint32&#95;t NewCountersSize = IndirectID + 1;</span></CodeLine>
<Link id="l00621" /><CodeLine lineNumber="621"></CodeLine>
<Link id="l00622" /><CodeLine lineNumber="622"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> ProfileUpdater = &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/pgoctxprofcontext">PGOCtxProfContext</a> &amp;Ctx) &#123;</span></CodeLine>
<Link id="l00623" /><CodeLine lineNumber="623"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Ctx.guid() == <a href="/docs/api/classes/llvm/assignguidpass/#a00cd72af35cb6bdeae06467500b531ae">AssignGUIDPass::getGUID</a>(Caller));</span></CodeLine>
<Link id="l00624" /><CodeLine lineNumber="624"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(NewCountersSize - 2 == Ctx.counters().size());</span></CodeLine>
<Link id="l00625" /><CodeLine lineNumber="625"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// All the ctx-es belonging to a function must have the same size counters.</span></CodeLine>
<Link id="l00626" /><CodeLine lineNumber="626"><span class="doxyHighlight">    Ctx.resizeCounters(NewCountersSize);</span></CodeLine>
<Link id="l00627" /><CodeLine lineNumber="627"></CodeLine>
<Link id="l00628" /><CodeLine lineNumber="628"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Maybe in this context, the indirect callsite wasn&#39;t observed at all. That</span></CodeLine>
<Link id="l00629" /><CodeLine lineNumber="629"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// would make both direct and indirect BBs cold - which is what we already</span></CodeLine>
<Link id="l00630" /><CodeLine lineNumber="630"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// have from resising the counters.</span></CodeLine>
<Link id="l00631" /><CodeLine lineNumber="631"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Ctx.hasCallsite(CSIndex))</span></CodeLine>
<Link id="l00632" /><CodeLine lineNumber="632"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00633" /><CodeLine lineNumber="633"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;CSData = Ctx.callsite(CSIndex);</span></CodeLine>
<Link id="l00634" /><CodeLine lineNumber="634"></CodeLine>
<Link id="l00635" /><CodeLine lineNumber="635"><span class="doxyHighlight">    uint64&#95;t TotalCount = 0;</span></CodeLine>
<Link id="l00636" /><CodeLine lineNumber="636"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;&#91;<a href="/docs/api/files/lib/lib/target/lib/target/hexagon/lib/target/hexagon/mctargetdesc/hexagonmccodeemitter-cpp/#ae4dfd7b0d66121016d6466d2ff10e8ba">&#95;</a>, V&#93; : CSData)</span></CodeLine>
<Link id="l00637" /><CodeLine lineNumber="637"><span class="doxyHighlight">      TotalCount += V.getEntrycount();</span></CodeLine>
<Link id="l00638" /><CodeLine lineNumber="638"><span class="doxyHighlight">    uint64&#95;t DirectCount = 0;</span></CodeLine>
<Link id="l00639" /><CodeLine lineNumber="639"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If we called the direct target, update the DirectCount. If we didn&#39;t, we</span></CodeLine>
<Link id="l00640" /><CodeLine lineNumber="640"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// still want to update the indirect BB (to which the TotalCount goes, in</span></CodeLine>
<Link id="l00641" /><CodeLine lineNumber="641"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// that case).</span></CodeLine>
<Link id="l00642" /><CodeLine lineNumber="642"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> It = CSData.find(CalleeGUID); It != CSData.end()) &#123;</span></CodeLine>
<Link id="l00643" /><CodeLine lineNumber="643"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(CalleeGUID == It-&gt;second.guid());</span></CodeLine>
<Link id="l00644" /><CodeLine lineNumber="644"><span class="doxyHighlight">      DirectCount = It-&gt;second.getEntrycount();</span></CodeLine>
<Link id="l00645" /><CodeLine lineNumber="645"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// This direct target needs to be moved to this caller under the</span></CodeLine>
<Link id="l00646" /><CodeLine lineNumber="646"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// newly-allocated callsite index.</span></CodeLine>
<Link id="l00647" /><CodeLine lineNumber="647"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Ctx.callsites().count(NewCSID) == 0);</span></CodeLine>
<Link id="l00648" /><CodeLine lineNumber="648"><span class="doxyHighlight">      Ctx.ingestContext(NewCSID, std::move(It-&gt;second));</span></CodeLine>
<Link id="l00649" /><CodeLine lineNumber="649"><span class="doxyHighlight">      CSData.erase(CalleeGUID);</span></CodeLine>
<Link id="l00650" /><CodeLine lineNumber="650"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00651" /><CodeLine lineNumber="651"></CodeLine>
<Link id="l00652" /><CodeLine lineNumber="652"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(TotalCount &gt;= DirectCount);</span></CodeLine>
<Link id="l00653" /><CodeLine lineNumber="653"><span class="doxyHighlight">    uint64&#95;t IndirectCount = TotalCount - DirectCount;</span></CodeLine>
<Link id="l00654" /><CodeLine lineNumber="654"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// The ICP&#39;s effect is as-if the direct BB would have been taken DirectCount</span></CodeLine>
<Link id="l00655" /><CodeLine lineNumber="655"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// times, and the indirect BB, IndirectCount times</span></CodeLine>
<Link id="l00656" /><CodeLine lineNumber="656"><span class="doxyHighlight">    Ctx.counters()&#91;DirectID&#93; = DirectCount;</span></CodeLine>
<Link id="l00657" /><CodeLine lineNumber="657"><span class="doxyHighlight">    Ctx.counters()&#91;IndirectID&#93; = IndirectCount;</span></CodeLine>
<Link id="l00658" /><CodeLine lineNumber="658"></CodeLine>
<Link id="l00659" /><CodeLine lineNumber="659"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l00660" /><CodeLine lineNumber="660"><span class="doxyHighlight">  CtxProf.<a href="/docs/api/classes/llvm/pgocontextualprofile/#a4c63680ee62ec8bd5918b4389e26bcd1">update</a>(ProfileUpdater, Caller);</span></CodeLine>
<Link id="l00661" /><CodeLine lineNumber="661"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> &amp;<a href="/docs/api/namespaces/llvm/#a0e00fad9c34de40b1e31f3aa6f8e024caf8d0d4845b0b074d9f2e0f2ace6683da">DirectCall</a>;</span></CodeLine>
<Link id="l00662" /><CodeLine lineNumber="662"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00663" /><CodeLine lineNumber="663"></CodeLine>
<Link id="l00664" /><CodeLine lineNumber="664" lineLink="/docs/api/namespaces/llvm/#ae529107c3b550f7e2fe6128a26c8f1da"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/callbase">CallBase</a> &amp;<a href="/docs/api/namespaces/llvm/#ae529107c3b550f7e2fe6128a26c8f1da">llvm::promoteCallWithVTableCmp</a>(<a href="/docs/api/classes/llvm/callbase">CallBase</a> &amp;CB, <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;VPtr,</span></CodeLine>
<Link id="l00665" /><CodeLine lineNumber="665"><span class="doxyHighlight">                                         <a href="/docs/api/classes/llvm/function">Function</a> &#42;Callee,</span></CodeLine>
<Link id="l00666" /><CodeLine lineNumber="666"><span class="doxyHighlight">                                         <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;Constant &#42;&gt;</a> AddressPoints,</span></CodeLine>
<Link id="l00667" /><CodeLine lineNumber="667"><span class="doxyHighlight">                                         <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42;BranchWeights) &#123;</span></CodeLine>
<Link id="l00668" /><CodeLine lineNumber="668"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!AddressPoints.<a href="/docs/api/classes/llvm/arrayref/#ac835b8735b1b2faec0efdca236e37d94">empty</a>() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Caller should guarantee&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00669" /><CodeLine lineNumber="669"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> Builder(&amp;CB);</span></CodeLine>
<Link id="l00670" /><CodeLine lineNumber="670"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Value &#42;, 2&gt;</a> ICmps;</span></CodeLine>
<Link id="l00671" /><CodeLine lineNumber="671"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;AddressPoint : AddressPoints)</span></CodeLine>
<Link id="l00672" /><CodeLine lineNumber="672"><span class="doxyHighlight">    ICmps.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a8c75539a39f167f352b37ccdd788a7e4">CreateICmpEQ</a>(VPtr, AddressPoint));</span></CodeLine>
<Link id="l00673" /><CodeLine lineNumber="673"></CodeLine>
<Link id="l00674" /><CodeLine lineNumber="674"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: Perform tree height reduction if the number of ICmps is high.</span></CodeLine>
<Link id="l00675" /><CodeLine lineNumber="675"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a> = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#ab61be8e3cf17e9848aeeeabacfa1b09a">CreateOr</a>(ICmps);</span></CodeLine>
<Link id="l00676" /><CodeLine lineNumber="676"></CodeLine>
<Link id="l00677" /><CodeLine lineNumber="677"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Version the indirect call site. If Cond is true, &#39;NewInst&#39; will be</span></CodeLine>
<Link id="l00678" /><CodeLine lineNumber="678"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// executed, otherwise the original call site will be executed.</span></CodeLine>
<Link id="l00679" /><CodeLine lineNumber="679"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/callbase">CallBase</a> &amp;NewInst = <a href="#aaabc735841282ccafdf43b7c165b030e">versionCallSiteWithCond</a>(CB, <a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>, BranchWeights);</span></CodeLine>
<Link id="l00680" /><CodeLine lineNumber="680"></CodeLine>
<Link id="l00681" /><CodeLine lineNumber="681"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Promote &#39;NewInst&#39; so that it directly calls the desired function.</span></CodeLine>
<Link id="l00682" /><CodeLine lineNumber="682"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/#a90c1755a8480ebc1dcc4f05d56271b00">promoteCall</a>(NewInst, Callee);</span></CodeLine>
<Link id="l00683" /><CodeLine lineNumber="683"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00684" /><CodeLine lineNumber="684"></CodeLine>
<Link id="l00685" /><CodeLine lineNumber="685" lineLink="/docs/api/namespaces/llvm/#ad3219f7b717320ae52f53ccb09ad5a84"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/#ad3219f7b717320ae52f53ccb09ad5a84">llvm::tryPromoteCall</a>(<a href="/docs/api/classes/llvm/callbase">CallBase</a> &amp;CB) &#123;</span></CodeLine>
<Link id="l00686" /><CodeLine lineNumber="686"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!CB.<a href="/docs/api/classes/llvm/callbase/#a2b1ae7cf1bafdd43d1fee4c6ad0a2913">getCalledFunction</a>());</span></CodeLine>
<Link id="l00687" /><CodeLine lineNumber="687"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/module">Module</a> &#42;M = CB.<a href="/docs/api/classes/llvm/callbase/#afac5b39bcbb90d660f83d9b4bd8c6d95">getCaller</a>()-&gt;<a href="/docs/api/classes/llvm/globalvalue/#a739b30c811f1eece61b05320ddf44e5b">getParent</a>();</span></CodeLine>
<Link id="l00688" /><CodeLine lineNumber="688"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/datalayout">DataLayout</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a> = M-&gt;getDataLayout();</span></CodeLine>
<Link id="l00689" /><CodeLine lineNumber="689"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;Callee = CB.<a href="/docs/api/classes/llvm/callbase/#a8d13199cbf4d080d3b5dcf330dad5d2c">getCalledOperand</a>();</span></CodeLine>
<Link id="l00690" /><CodeLine lineNumber="690"></CodeLine>
<Link id="l00691" /><CodeLine lineNumber="691"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/loadinst">LoadInst</a> &#42;VTableEntryLoad = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;LoadInst&gt;</a>(Callee);</span></CodeLine>
<Link id="l00692" /><CodeLine lineNumber="692"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!VTableEntryLoad)</span></CodeLine>
<Link id="l00693" /><CodeLine lineNumber="693"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">; </span><span class="doxyHighlightComment">// Not a vtable entry load.</span></CodeLine>
<Link id="l00694" /><CodeLine lineNumber="694"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;VTableEntryPtr = VTableEntryLoad-&gt;<a href="/docs/api/classes/llvm/loadinst/#a2d1ff28d6923802e165905b8d1766e76">getPointerOperand</a>();</span></CodeLine>
<Link id="l00695" /><CodeLine lineNumber="695"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/apint">APInt</a> VTableOffset(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>.getIndexTypeSizeInBits(VTableEntryPtr-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>()), 0);</span></CodeLine>
<Link id="l00696" /><CodeLine lineNumber="696"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;VTableBasePtr = VTableEntryPtr-&gt;<a href="/docs/api/classes/llvm/value/#a23c582e2452eeb2b2cf6e0c43eca617e">stripAndAccumulateConstantOffsets</a>(</span></CodeLine>
<Link id="l00697" /><CodeLine lineNumber="697"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>, VTableOffset, </span><span class="doxyHighlightComment">/&#42; AllowNonInbounds &#42;/</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00698" /><CodeLine lineNumber="698"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/loadinst">LoadInst</a> &#42;VTablePtrLoad = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;LoadInst&gt;</a>(VTableBasePtr);</span></CodeLine>
<Link id="l00699" /><CodeLine lineNumber="699"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!VTablePtrLoad)</span></CodeLine>
<Link id="l00700" /><CodeLine lineNumber="700"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">; </span><span class="doxyHighlightComment">// Not a vtable load.</span></CodeLine>
<Link id="l00701" /><CodeLine lineNumber="701"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;Object = VTablePtrLoad-&gt;<a href="/docs/api/classes/llvm/loadinst/#a2d1ff28d6923802e165905b8d1766e76">getPointerOperand</a>();</span></CodeLine>
<Link id="l00702" /><CodeLine lineNumber="702"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/apint">APInt</a> ObjectOffset(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>.getIndexTypeSizeInBits(Object-&gt;getType()), 0);</span></CodeLine>
<Link id="l00703" /><CodeLine lineNumber="703"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;ObjectBase = Object-&gt;stripAndAccumulateConstantOffsets(</span></CodeLine>
<Link id="l00704" /><CodeLine lineNumber="704"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>, ObjectOffset, </span><span class="doxyHighlightComment">/&#42; AllowNonInbounds &#42;/</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00705" /><CodeLine lineNumber="705"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!(<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;AllocaInst&gt;</a>(ObjectBase) &amp;&amp; ObjectOffset == 0))</span></CodeLine>
<Link id="l00706" /><CodeLine lineNumber="706"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Not an Alloca or the offset isn&#39;t zero.</span></CodeLine>
<Link id="l00707" /><CodeLine lineNumber="707"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00708" /><CodeLine lineNumber="708"></CodeLine>
<Link id="l00709" /><CodeLine lineNumber="709"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Look for the vtable pointer store into the object by the ctor.</span></CodeLine>
<Link id="l00710" /><CodeLine lineNumber="710"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> BBI(VTablePtrLoad);</span></CodeLine>
<Link id="l00711" /><CodeLine lineNumber="711"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;VTablePtr = <a href="/docs/api/namespaces/llvm/#a459b627931605e520bf7d14e074af7c1">FindAvailableLoadedValue</a>(</span></CodeLine>
<Link id="l00712" /><CodeLine lineNumber="712"><span class="doxyHighlight">      VTablePtrLoad, VTablePtrLoad-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>(), BBI, 0, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00713" /><CodeLine lineNumber="713"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!VTablePtr || !VTablePtr-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>()-&gt;<a href="/docs/api/classes/llvm/type/#a3b996fbf8458aafffc86cb98a68d0a47">isPointerTy</a>())</span></CodeLine>
<Link id="l00714" /><CodeLine lineNumber="714"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">; </span><span class="doxyHighlightComment">// No vtable found.</span></CodeLine>
<Link id="l00715" /><CodeLine lineNumber="715"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/apint">APInt</a> VTableOffsetGVBase(<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>.getIndexTypeSizeInBits(VTablePtr-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>()), 0);</span></CodeLine>
<Link id="l00716" /><CodeLine lineNumber="716"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;VTableGVBase = VTablePtr-&gt;<a href="/docs/api/classes/llvm/value/#a23c582e2452eeb2b2cf6e0c43eca617e">stripAndAccumulateConstantOffsets</a>(</span></CodeLine>
<Link id="l00717" /><CodeLine lineNumber="717"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>, VTableOffsetGVBase, </span><span class="doxyHighlightComment">/&#42; AllowNonInbounds &#42;/</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00718" /><CodeLine lineNumber="718"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/globalvariable">GlobalVariable</a> &#42;GV = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;GlobalVariable&gt;</a>(VTableGVBase);</span></CodeLine>
<Link id="l00719" /><CodeLine lineNumber="719"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!(GV &amp;&amp; GV-&gt;<a href="/docs/api/classes/llvm/globalvariable/#aa859e108741fa64681b63f0c0c672512">isConstant</a>() &amp;&amp; GV-&gt;<a href="/docs/api/classes/llvm/globalvariable/#aec2d700d8b1e57f830a673c39a1f30dc">hasDefinitiveInitializer</a>()))</span></CodeLine>
<Link id="l00720" /><CodeLine lineNumber="720"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Not in the form of a global constant variable with an initializer.</span></CodeLine>
<Link id="l00721" /><CodeLine lineNumber="721"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00722" /><CodeLine lineNumber="722"></CodeLine>
<Link id="l00723" /><CodeLine lineNumber="723"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/apint">APInt</a> VTableGVOffset = VTableOffsetGVBase + VTableOffset;</span></CodeLine>
<Link id="l00724" /><CodeLine lineNumber="724"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!(VTableGVOffset.<a href="/docs/api/classes/llvm/apint/#a3015474e70e59c0a3ed4f9f0e8644b75">getActiveBits</a>() &lt;= 64))</span></CodeLine>
<Link id="l00725" /><CodeLine lineNumber="725"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">; </span><span class="doxyHighlightComment">// Out of range.</span></CodeLine>
<Link id="l00726" /><CodeLine lineNumber="726"></CodeLine>
<Link id="l00727" /><CodeLine lineNumber="727"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;DirectCallee = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00728" /><CodeLine lineNumber="728"><span class="doxyHighlight">  std::tie(DirectCallee, std::ignore) =</span></CodeLine>
<Link id="l00729" /><CodeLine lineNumber="729"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#afc0a5ead9186ecbdc82f6ebe331c25ee">getFunctionAtVTableOffset</a>(GV, VTableGVOffset.<a href="/docs/api/classes/llvm/apint/#a217e0207d9cc8e046c2dccbf0e4bb198">getZExtValue</a>(), &#42;M);</span></CodeLine>
<Link id="l00730" /><CodeLine lineNumber="730"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!DirectCallee)</span></CodeLine>
<Link id="l00731" /><CodeLine lineNumber="731"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">; </span><span class="doxyHighlightComment">// No function pointer found.</span></CodeLine>
<Link id="l00732" /><CodeLine lineNumber="732"></CodeLine>
<Link id="l00733" /><CodeLine lineNumber="733"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/#a0e5b9e42ea84622605acea0b0d721fda">isLegalToPromote</a>(CB, DirectCallee))</span></CodeLine>
<Link id="l00734" /><CodeLine lineNumber="734"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00735" /><CodeLine lineNumber="735"></CodeLine>
<Link id="l00736" /><CodeLine lineNumber="736"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Success.</span></CodeLine>
<Link id="l00737" /><CodeLine lineNumber="737"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a90c1755a8480ebc1dcc4f05d56271b00">promoteCall</a>(CB, DirectCallee);</span></CodeLine>
<Link id="l00738" /><CodeLine lineNumber="738"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00739" /><CodeLine lineNumber="739"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00740" /><CodeLine lineNumber="740"></CodeLine>
<Link id="l00741" /><CodeLine lineNumber="741"><span class="doxyHighlightPreprocessor">#undef DEBUG&#95;TYPE</span></CodeLine>

</ProgramListing>


</DoxygenPage>
