---

# DO NOT EDIT!
# Automatically generated via docusaurus-plugin-doxygen by Doxygen.

slug: /api/files/lib/lib/transforms/lib/transforms/utils/looprotationutils-cpp
custom_edit_url: null
keywords:
  - doxygen
  - reference
  - file

---

import Link from '@docusaurus/Link'

import CodeLine from '@xpack/docusaurus-plugin-doxygen/components/CodeLine'
import DoxygenPage from '@xpack/docusaurus-plugin-doxygen/components/DoxygenPage'
import Highlight from '@xpack/docusaurus-plugin-doxygen/components/Highlight'
import IncludesList from '@xpack/docusaurus-plugin-doxygen/components/IncludesList'
import IncludesListItem from '@xpack/docusaurus-plugin-doxygen/components/IncludesListItem'
import MemberDefinition from '@xpack/docusaurus-plugin-doxygen/components/MemberDefinition'
import MembersIndex from '@xpack/docusaurus-plugin-doxygen/components/MembersIndex'
import MembersIndexItem from '@xpack/docusaurus-plugin-doxygen/components/MembersIndexItem'
import ProgramListing from '@xpack/docusaurus-plugin-doxygen/components/ProgramListing'
import SectionDefinition from '@xpack/docusaurus-plugin-doxygen/components/SectionDefinition'

import pluginConfig from '@site/docusaurus-plugin-doxygen-config.json'

# The `LoopRotationUtils.cpp` File Reference

<DoxygenPage pluginConfig={pluginConfig}>



## Included Headers

<IncludesList>
<IncludesListItem
  filePath="llvm/Transforms/Utils/LoopRotationUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/looprotationutils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/Statistic.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/AssumptionCache.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/assumptioncache-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/CodeMetrics.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/codemetrics-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/DomTreeUpdater.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/domtreeupdater-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/InstructionSimplify.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/instructionsimplify-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/LoopInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/loopinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/MemorySSA.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/memoryssa-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/MemorySSAUpdater.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/memoryssaupdater-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/ScalarEvolution.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/scalarevolution-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/ValueTracking.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/valuetracking-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/CFG.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/cfg-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/DebugInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/debuginfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Dominators.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/dominators-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/IntrinsicInst.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/intrinsicinst-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/MDBuilder.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/mdbuilder-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/ProfDataUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/profdatautils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/CommandLine.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/Debug.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/debug-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/raw_ostream.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/raw-ostream-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/BasicBlockUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/basicblockutils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/Cloning.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/cloning-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/Local.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/local-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/SSAUpdater.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/ssaupdater-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/ValueMapper.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/valuemapper-h"
  isLocal="true" />
</IncludesList>

## Namespaces Index

<MembersIndex>

<MembersIndexItem
  type="namespace"
  name={<><a href="/docs/api/namespaces/anonymous-looprotationutils-cpp-">anonymous&#123;LoopRotationUtils.cpp&#125;</a></>}>
</MembersIndexItem>

</MembersIndex>

## Classes Index

<MembersIndex>

<MembersIndexItem
  type="class"
  name={<><a href="/docs/api/classes/anonymous-namespace-looprotationutils-cpp-/looprotate">LoopRotate</a></>}>
A simple loop rotation transformation. <a href="/docs/api/classes/anonymous-namespace-looprotationutils-cpp-/looprotate/#details">More...</a>
</MembersIndexItem>

</MembersIndex>

## Functions Index

<MembersIndex>

<MembersIndexItem
  type="bool"
  name={<><a href="#a20d58a0069048b80461676a4132ad1d4">canRotateDeoptimizingLatchExit</a> (Loop &#42;L)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#ad2e3518508b7df1cb9b6ab4dba6557f1">InsertNewValueIntoMap</a> (ValueToValueMapTy &amp;VM, Value &#42;K, Value &#42;V)</>}>
Insert (K, V) pair into the <a href="/docs/api/namespaces/llvm/#afab3631a764c3f3a60ca9b1c0d7d5967">ValueToValueMap</a>, and verify the key did not previously exist in the map, and the value was inserted. <a href="#ad2e3518508b7df1cb9b6ab4dba6557f1">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a7fdcbbf4a72726c120dc9d33b6ee13bb">profitableToRotateLoopExitingLatch</a> (Loop &#42;L)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#aea660fd3de70e7854de06b7e212f0ecd">RewriteUsesOfClonedInstructions</a> (BasicBlock &#42;OrigHeader, BasicBlock &#42;OrigPreheader, ValueToValueMapTy &amp;ValueMap, ScalarEvolution &#42;SE, SmallVectorImpl&lt; PHINode &#42; &gt; &#42;InsertedPHIs)</>}>
RewriteUsesOfClonedInstructions - We just cloned the instructions from the old header into the preheader. <a href="#aea660fd3de70e7854de06b7e212f0ecd">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a41713fe2635c183d98e1a6b7c1cedff5">shouldSpeculateInstrs</a> (BasicBlock::iterator Begin, BasicBlock::iterator End, Loop &#42;L)</>}>
Determine whether the instructions in this range may be safely and cheaply speculated. <a href="#a41713fe2635c183d98e1a6b7c1cedff5">More...</a>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#ab54b6c45fa67a830ab68ece621676e74">STATISTIC</a> (NumNotRotatedDueToHeaderSize, &quot;Number of loops not rotated due to the header size&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#a03b9836f584e3f46850a4889d49f670f">STATISTIC</a> (NumInstrsHoisted, &quot;Number of instructions hoisted into loop preheader&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#ad8482926aa8caca42d99d7f5e4fe92fb">STATISTIC</a> (NumInstrsDuplicated, &quot;Number of instructions cloned into loop preheader&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#ae387cea5ba11fc0784fecdd607f6dde6">STATISTIC</a> (NumRotated, &quot;Number of loops rotated&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#ace004655a04ad52b7fc02fb8e3cf7b0f">updateBranchWeights</a> (BranchInst &amp;PreHeaderBI, BranchInst &amp;LoopBI, bool HasConditionalPreHeader, bool SuccsSwapped)</>}>
</MembersIndexItem>

</MembersIndex>

## Variables Index

<MembersIndex>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a4c85d9b35e543ff80a5f5cedc4982362">MultiRotate</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<>uint32&#95;t</>}
  name={<><a href="#a15d56cf0ab9ff631ca76412249bbb1e2">ZeroTripCountWeights</a> = &#123;1, 127&#125;</>}>
</MembersIndexItem>

</MembersIndex>

## Defines Index

<MembersIndex>

<MembersIndexItem
  type="#define"
  name={<><a href="#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>&nbsp;&nbsp;&nbsp;&quot;loop-rotate&quot;</>}>
</MembersIndexItem>

</MembersIndex>


<SectionDefinition>

## Functions

### canRotateDeoptimizingLatchExit() {#a20d58a0069048b80461676a4132ad1d4}

<MemberDefinition
  prototype={<>static bool canRotateDeoptimizingLatchExit (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42; L)</>}
  labels = {["static"]}>

Definition at line <a href="#l00238">238</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looprotationutils-cpp">LoopRotationUtils.cpp</a>.
</MemberDefinition>

### InsertNewValueIntoMap() {#ad2e3518508b7df1cb9b6ab4dba6557f1}

<MemberDefinition
  prototype={<>static void InsertNewValueIntoMap (<a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp; VM, <a href="/docs/api/classes/llvm/value">Value</a> &#42; K, <a href="/docs/api/classes/llvm/value">Value</a> &#42; V)</>}
  labels = {["static"]}>
Insert (K, V) pair into the <a href="/docs/api/namespaces/llvm/#afab3631a764c3f3a60ca9b1c0d7d5967">ValueToValueMap</a>, and verify the key did not previously exist in the map, and the value was inserted.

Definition at line <a href="#l00092">92</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looprotationutils-cpp">LoopRotationUtils.cpp</a>.
</MemberDefinition>

### profitableToRotateLoopExitingLatch() {#a7fdcbbf4a72726c120dc9d33b6ee13bb}

<MemberDefinition
  prototype={<>static bool profitableToRotateLoopExitingLatch (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42; L)</>}
  labels = {["static"]}>

Definition at line <a href="#l00213">213</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looprotationutils-cpp">LoopRotationUtils.cpp</a>.
</MemberDefinition>

### RewriteUsesOfClonedInstructions() {#aea660fd3de70e7854de06b7e212f0ecd}

<MemberDefinition
  prototype={<>static void RewriteUsesOfClonedInstructions (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; OrigHeader, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; OrigPreheader, <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp; ValueMap, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42; SE, <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt; <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42; &gt; &#42; InsertedPHIs)</>}
  labels = {["static"]}>
RewriteUsesOfClonedInstructions - We just cloned the instructions from the old header into the preheader.

If there were uses of the values produced by these instruction that were outside of the loop, we have to insert PHI nodes to merge the two values. Do this now.

Definition at line <a href="#l00101">101</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looprotationutils-cpp">LoopRotationUtils.cpp</a>.
</MemberDefinition>

### shouldSpeculateInstrs() {#a41713fe2635c183d98e1a6b7c1cedff5}

<MemberDefinition
  prototype={<>static bool shouldSpeculateInstrs (<a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> Begin, <a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> End, <a href="/docs/api/classes/llvm/loop">Loop</a> &#42; L)</>}
  labels = {["static"]}>
Determine whether the instructions in this range may be safely and cheaply speculated.

This is not an important enough situation to develop complex heuristics. We handle a single arithmetic instruction along with any type conversions.

Definition at line <a href="#l00942">942</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looprotationutils-cpp">LoopRotationUtils.cpp</a>.
</MemberDefinition>

### STATISTIC() {#ab54b6c45fa67a830ab68ece621676e74}

<MemberDefinition
  prototype={<>STATISTIC (NumNotRotatedDueToHeaderSize, &quot;Number of <a href="/docs/api/files/lib/lib/analysis/loopinfo-cpp/#a49ae40a9c91d665793aaed656c26ca30">loops</a> not rotated due to the header size&quot;)</>}>

Definition at line <a href="#l00042">42</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looprotationutils-cpp">LoopRotationUtils.cpp</a>.
</MemberDefinition>

### STATISTIC() {#a03b9836f584e3f46850a4889d49f670f}

<MemberDefinition
  prototype={<>STATISTIC (NumInstrsHoisted, &quot;Number of <a href="/docs/api/files/lib/lib/codegen/atomicexpandpass-cpp/#a1bcc06b1cb86bd0ea08f33323190bdaa">instructions</a> hoisted into loop preheader&quot;)</>}>

Definition at line <a href="#l00044">44</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looprotationutils-cpp">LoopRotationUtils.cpp</a>.
</MemberDefinition>

### STATISTIC() {#ad8482926aa8caca42d99d7f5e4fe92fb}

<MemberDefinition
  prototype={<>STATISTIC (NumInstrsDuplicated, &quot;Number of <a href="/docs/api/files/lib/lib/codegen/atomicexpandpass-cpp/#a1bcc06b1cb86bd0ea08f33323190bdaa">instructions</a> cloned into loop preheader&quot;)</>}>

Definition at line <a href="#l00046">46</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looprotationutils-cpp">LoopRotationUtils.cpp</a>.
</MemberDefinition>

### STATISTIC() {#ae387cea5ba11fc0784fecdd607f6dde6}

<MemberDefinition
  prototype={<>STATISTIC (NumRotated, &quot;Number of <a href="/docs/api/files/lib/lib/analysis/loopinfo-cpp/#a49ae40a9c91d665793aaed656c26ca30">loops</a> rotated&quot;)</>}>

Definition at line <a href="#l00048">48</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looprotationutils-cpp">LoopRotationUtils.cpp</a>.
</MemberDefinition>

### updateBranchWeights() {#ace004655a04ad52b7fc02fb8e3cf7b0f}

<MemberDefinition
  prototype={<>static void updateBranchWeights (<a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &amp; PreHeaderBI, <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &amp; LoopBI, bool HasConditionalPreHeader, bool SuccsSwapped)</>}
  labels = {["static"]}>

Definition at line <a href="#l00276">276</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looprotationutils-cpp">LoopRotationUtils.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Variables

### MultiRotate {#a4c85d9b35e543ff80a5f5cedc4982362}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; MultiRotate(&quot;loop-rotate-multi&quot;, cl::init(false), cl::Hidden, cl::desc(&quot;Allow loop rotation multiple times in order to reach &quot; &quot;a better latch exit&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00051">51</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looprotationutils-cpp">LoopRotationUtils.cpp</a>.
</MemberDefinition>

### ZeroTripCountWeights {#a15d56cf0ab9ff631ca76412249bbb1e2}

<MemberDefinition
  prototype={<>uint32&#95;t ZeroTripCountWeights&#91;&#93; = &#123;1, 127&#125;</>}
  labels = {["constexpr", "static"]}>

Definition at line <a href="#l00056">56</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looprotationutils-cpp">LoopRotationUtils.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Defines

### DEBUG&#95;TYPE {#ad78e062f62e0d6e453941fb4ca843e4d}

<MemberDefinition
  prototype={<>#define DEBUG&#95;TYPE&nbsp;&nbsp;&nbsp;&quot;loop-rotate&quot;</>}>

Definition at line <a href="#l00040">40</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looprotationutils-cpp">LoopRotationUtils.cpp</a>.
</MemberDefinition>

</SectionDefinition>

## File Listing

The file content with the documentation metadata removed is:

<ProgramListing>

<Link id="l00001" /><CodeLine lineNumber="1"><Highlight kind="comment">//===----------------- LoopRotationUtils.cpp -----------------------------===//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00002" /><CodeLine lineNumber="2"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00003" /><CodeLine lineNumber="3"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00004" /><CodeLine lineNumber="4"><Highlight kind="normal"></Highlight><Highlight kind="comment">// See https://llvm.org/LICENSE.txt for license information.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00005" /><CodeLine lineNumber="5"><Highlight kind="normal"></Highlight><Highlight kind="comment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00006" /><CodeLine lineNumber="6"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00007" /><CodeLine lineNumber="7"><Highlight kind="normal"></Highlight><Highlight kind="comment">//===----------------------------------------------------------------------===//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00008" /><CodeLine lineNumber="8"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00009" /><CodeLine lineNumber="9"><Highlight kind="normal"></Highlight><Highlight kind="comment">// This file provides utilities to convert a loop into a loop with bottom test.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00010" /><CodeLine lineNumber="10"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00011" /><CodeLine lineNumber="11"><Highlight kind="normal"></Highlight><Highlight kind="comment">//===----------------------------------------------------------------------===//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00012" /><CodeLine lineNumber="12"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00013" /><CodeLine lineNumber="13"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/looprotationutils-h">llvm/Transforms/Utils/LoopRotationUtils.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00014" /><CodeLine lineNumber="14"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h">llvm/ADT/Statistic.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00015" /><CodeLine lineNumber="15"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/assumptioncache-h">llvm/Analysis/AssumptionCache.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00016" /><CodeLine lineNumber="16"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/codemetrics-h">llvm/Analysis/CodeMetrics.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00017" /><CodeLine lineNumber="17"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/domtreeupdater-h">llvm/Analysis/DomTreeUpdater.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00018" /><CodeLine lineNumber="18"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/instructionsimplify-h">llvm/Analysis/InstructionSimplify.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00019" /><CodeLine lineNumber="19"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/loopinfo-h">llvm/Analysis/LoopInfo.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00020" /><CodeLine lineNumber="20"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/memoryssa-h">llvm/Analysis/MemorySSA.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00021" /><CodeLine lineNumber="21"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/memoryssaupdater-h">llvm/Analysis/MemorySSAUpdater.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00022" /><CodeLine lineNumber="22"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/scalarevolution-h">llvm/Analysis/ScalarEvolution.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00023" /><CodeLine lineNumber="23"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/valuetracking-h">llvm/Analysis/ValueTracking.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00024" /><CodeLine lineNumber="24"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/cfg-h">llvm/IR/CFG.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00025" /><CodeLine lineNumber="25"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/debuginfo-h">llvm/IR/DebugInfo.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00026" /><CodeLine lineNumber="26"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/dominators-h">llvm/IR/Dominators.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00027" /><CodeLine lineNumber="27"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/intrinsicinst-h">llvm/IR/IntrinsicInst.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00028" /><CodeLine lineNumber="28"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/mdbuilder-h">llvm/IR/MDBuilder.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00029" /><CodeLine lineNumber="29"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/profdatautils-h">llvm/IR/ProfDataUtils.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00030" /><CodeLine lineNumber="30"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h">llvm/Support/CommandLine.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00031" /><CodeLine lineNumber="31"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h">llvm/Support/Debug.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00032" /><CodeLine lineNumber="32"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/raw-ostream-h">llvm/Support/raw&#95;ostream.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00033" /><CodeLine lineNumber="33"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/basicblockutils-h">llvm/Transforms/Utils/BasicBlockUtils.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00034" /><CodeLine lineNumber="34"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/cloning-h">llvm/Transforms/Utils/Cloning.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00035" /><CodeLine lineNumber="35"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/local-h">llvm/Transforms/Utils/Local.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00036" /><CodeLine lineNumber="36"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/ssaupdater-h">llvm/Transforms/Utils/SSAUpdater.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00037" /><CodeLine lineNumber="37"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/valuemapper-h">llvm/Transforms/Utils/ValueMapper.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00038" /><CodeLine lineNumber="38"><Highlight kind="normal"></Highlight><Highlight kind="keyword">using namespace </Highlight><Highlight kind="normal"><a href="/docs/api/namespaces/llvm">llvm</a>;</Highlight></CodeLine>
<Link id="l00039" /><CodeLine lineNumber="39"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00040" /><CodeLine lineNumber="40" lineLink="#ad78e062f62e0d6e453941fb4ca843e4d"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#define DEBUG&#95;TYPE &quot;loop-rotate&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00041" /><CodeLine lineNumber="41"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00042" /><CodeLine lineNumber="42" lineLink="#ab54b6c45fa67a830ab68ece621676e74"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumNotRotatedDueToHeaderSize,</Highlight></CodeLine>
<Link id="l00043" /><CodeLine lineNumber="43"><Highlight kind="normal">          </Highlight><Highlight kind="stringliteral">&quot;Number of loops not rotated due to the header size&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00044" /><CodeLine lineNumber="44" lineLink="#a03b9836f584e3f46850a4889d49f670f"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumInstrsHoisted,</Highlight></CodeLine>
<Link id="l00045" /><CodeLine lineNumber="45"><Highlight kind="normal">          </Highlight><Highlight kind="stringliteral">&quot;Number of instructions hoisted into loop preheader&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00046" /><CodeLine lineNumber="46" lineLink="#ad8482926aa8caca42d99d7f5e4fe92fb"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumInstrsDuplicated,</Highlight></CodeLine>
<Link id="l00047" /><CodeLine lineNumber="47"><Highlight kind="normal">          </Highlight><Highlight kind="stringliteral">&quot;Number of instructions cloned into loop preheader&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00048" /><CodeLine lineNumber="48" lineLink="#ae387cea5ba11fc0784fecdd607f6dde6"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumRotated, </Highlight><Highlight kind="stringliteral">&quot;Number of loops rotated&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00049" /><CodeLine lineNumber="49"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00050" /><CodeLine lineNumber="50"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a></Highlight></CodeLine>
<Link id="l00051" /><CodeLine lineNumber="51" lineLink="#a4c85d9b35e543ff80a5f5cedc4982362"><Highlight kind="normal">    <a href="#a4c85d9b35e543ff80a5f5cedc4982362">MultiRotate</a>(</Highlight><Highlight kind="stringliteral">&quot;loop-rotate-multi&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</Highlight></CodeLine>
<Link id="l00052" /><CodeLine lineNumber="52"><Highlight kind="normal">                <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Allow loop rotation multiple times in order to reach &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00053" /><CodeLine lineNumber="53"><Highlight kind="normal">                         </Highlight><Highlight kind="stringliteral">&quot;a better latch exit&quot;</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00054" /><CodeLine lineNumber="54"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00055" /><CodeLine lineNumber="55"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Probability that a rotated loop has zero trip count / is never entered.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00056" /><CodeLine lineNumber="56" lineLink="#a15d56cf0ab9ff631ca76412249bbb1e2"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">constexpr</Highlight><Highlight kind="normal"> uint32&#95;t <a href="#a15d56cf0ab9ff631ca76412249bbb1e2">ZeroTripCountWeights</a>&#91;&#93; = &#123;1, 127&#125;;</Highlight></CodeLine>
<Link id="l00057" /><CodeLine lineNumber="57"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00058" /><CodeLine lineNumber="58" lineLink="/docs/api/namespaces/anonymous-looprotationutils-cpp-"><Highlight kind="normal"></Highlight><Highlight kind="keyword">namespace </Highlight><Highlight kind="normal">&#123;</Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00059" /><CodeLine lineNumber="59"><Highlight kind="comment">/// A simple loop rotation transformation.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00060" /><CodeLine lineNumber="60" lineLink="/docs/api/classes/anonymous-namespace-looprotationutils-cpp-/looprotate"><Highlight kind="normal"></Highlight><Highlight kind="keyword">class </Highlight><Highlight kind="normal"><a href="/docs/api/classes/anonymous-namespace-looprotationutils-cpp-/looprotate/#a6458617345354f31e0642b0fa1c096cf">LoopRotate</a> &#123;</Highlight></CodeLine>
<Link id="l00061" /><CodeLine lineNumber="61"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> MaxHeaderSize;</Highlight></CodeLine>
<Link id="l00062" /><CodeLine lineNumber="62"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &#42;LI;</Highlight></CodeLine>
<Link id="l00063" /><CodeLine lineNumber="63"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/targettransforminfo">TargetTransformInfo</a> &#42;TTI;</Highlight></CodeLine>
<Link id="l00064" /><CodeLine lineNumber="64"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &#42;AC;</Highlight></CodeLine>
<Link id="l00065" /><CodeLine lineNumber="65"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &#42;DT;</Highlight></CodeLine>
<Link id="l00066" /><CodeLine lineNumber="66"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42;SE;</Highlight></CodeLine>
<Link id="l00067" /><CodeLine lineNumber="67"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42;MSSAU;</Highlight></CodeLine>
<Link id="l00068" /><CodeLine lineNumber="68"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/structs/llvm/simplifyquery">SimplifyQuery</a> &amp;SQ;</Highlight></CodeLine>
<Link id="l00069" /><CodeLine lineNumber="69"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> RotationOnly;</Highlight></CodeLine>
<Link id="l00070" /><CodeLine lineNumber="70"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> IsUtilMode;</Highlight></CodeLine>
<Link id="l00071" /><CodeLine lineNumber="71"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> PrepareForLTO;</Highlight></CodeLine>
<Link id="l00072" /><CodeLine lineNumber="72"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00073" /><CodeLine lineNumber="73"><Highlight kind="normal"></Highlight><Highlight kind="keyword">public</Highlight><Highlight kind="normal">:</Highlight></CodeLine>
<Link id="l00074" /><CodeLine lineNumber="74" lineLink="/docs/api/classes/anonymous-namespace-looprotationutils-cpp-/looprotate/#a6458617345354f31e0642b0fa1c096cf"><Highlight kind="normal">  <a href="/docs/api/classes/anonymous-namespace-looprotationutils-cpp-/looprotate/#a6458617345354f31e0642b0fa1c096cf">LoopRotate</a>(</Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> MaxHeaderSize, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &#42;LI,</Highlight></CodeLine>
<Link id="l00075" /><CodeLine lineNumber="75"><Highlight kind="normal">             </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/targettransforminfo">TargetTransformInfo</a> &#42;TTI, <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &#42;AC,</Highlight></CodeLine>
<Link id="l00076" /><CodeLine lineNumber="76"><Highlight kind="normal">             <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &#42;DT, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42;SE, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42;MSSAU,</Highlight></CodeLine>
<Link id="l00077" /><CodeLine lineNumber="77"><Highlight kind="normal">             </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/structs/llvm/simplifyquery">SimplifyQuery</a> &amp;SQ, </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> RotationOnly, </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> IsUtilMode,</Highlight></CodeLine>
<Link id="l00078" /><CodeLine lineNumber="78"><Highlight kind="normal">             </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> PrepareForLTO)</Highlight></CodeLine>
<Link id="l00079" /><CodeLine lineNumber="79"><Highlight kind="normal">      : MaxHeaderSize(MaxHeaderSize), LI(LI), TTI(TTI), AC(AC), DT(DT), SE(SE),</Highlight></CodeLine>
<Link id="l00080" /><CodeLine lineNumber="80"><Highlight kind="normal">        MSSAU(MSSAU), SQ(SQ), RotationOnly(RotationOnly),</Highlight></CodeLine>
<Link id="l00081" /><CodeLine lineNumber="81"><Highlight kind="normal">        IsUtilMode(IsUtilMode), PrepareForLTO(PrepareForLTO) &#123;&#125;</Highlight></CodeLine>
<Link id="l00082" /><CodeLine lineNumber="82"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> processLoop(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L);</Highlight></CodeLine>
<Link id="l00083" /><CodeLine lineNumber="83"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00084" /><CodeLine lineNumber="84"><Highlight kind="normal"></Highlight><Highlight kind="keyword">private</Highlight><Highlight kind="normal">:</Highlight></CodeLine>
<Link id="l00085" /><CodeLine lineNumber="85"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> rotateLoop(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L, </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> SimplifiedLatch);</Highlight></CodeLine>
<Link id="l00086" /><CodeLine lineNumber="86"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> simplifyLoopLatch(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L);</Highlight></CodeLine>
<Link id="l00087" /><CodeLine lineNumber="87"><Highlight kind="normal">&#125;;</Highlight></CodeLine>
<Link id="l00088" /><CodeLine lineNumber="88"><Highlight kind="normal">&#125; </Highlight><Highlight kind="comment">// end anonymous namespace</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00089" /><CodeLine lineNumber="89"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00090" /><CodeLine lineNumber="90"><Highlight kind="comment">/// Insert (K, V) pair into the ValueToValueMap, and verify the key did not</Highlight></CodeLine>
<Link id="l00091" /><CodeLine lineNumber="91"><Highlight kind="comment">/// previously exist in the map, and the value was inserted.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00092" /><CodeLine lineNumber="92" lineLink="#ad2e3518508b7df1cb9b6ab4dba6557f1"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#ad2e3518508b7df1cb9b6ab4dba6557f1">InsertNewValueIntoMap</a>(<a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp;VM, <a href="/docs/api/classes/llvm/value">Value</a> &#42;K, <a href="/docs/api/classes/llvm/value">Value</a> &#42;V) &#123;</Highlight></CodeLine>
<Link id="l00093" /><CodeLine lineNumber="93"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> Inserted = VM.<a href="/docs/api/classes/llvm/valuemap/#a920909a106e8ee711c1f2c74ea259124">insert</a>(&#123;K, V&#125;).second;</Highlight></CodeLine>
<Link id="l00094" /><CodeLine lineNumber="94"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Inserted);</Highlight></CodeLine>
<Link id="l00095" /><CodeLine lineNumber="95"><Highlight kind="normal">  (void)Inserted;</Highlight></CodeLine>
<Link id="l00096" /><CodeLine lineNumber="96"><Highlight kind="normal">&#125;</Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00097" /><CodeLine lineNumber="97"><Highlight kind="comment">/// RewriteUsesOfClonedInstructions - We just cloned the instructions from the</Highlight></CodeLine>
<Link id="l00098" /><CodeLine lineNumber="98"><Highlight kind="comment">/// old header into the preheader.  If there were uses of the values produced by</Highlight></CodeLine>
<Link id="l00099" /><CodeLine lineNumber="99"><Highlight kind="comment">/// these instruction that were outside of the loop, we have to insert PHI nodes</Highlight></CodeLine>
<Link id="l00100" /><CodeLine lineNumber="100"><Highlight kind="comment">/// to merge the two values.  Do this now.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00101" /><CodeLine lineNumber="101" lineLink="#aea660fd3de70e7854de06b7e212f0ecd"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#aea660fd3de70e7854de06b7e212f0ecd">RewriteUsesOfClonedInstructions</a>(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;OrigHeader,</Highlight></CodeLine>
<Link id="l00102" /><CodeLine lineNumber="102"><Highlight kind="normal">                                            <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;OrigPreheader,</Highlight></CodeLine>
<Link id="l00103" /><CodeLine lineNumber="103"><Highlight kind="normal">                                            <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp;<a href="/docs/api/classes/llvm/valuemap">ValueMap</a>,</Highlight></CodeLine>
<Link id="l00104" /><CodeLine lineNumber="104"><Highlight kind="normal">                                            <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42;SE,</Highlight></CodeLine>
<Link id="l00105" /><CodeLine lineNumber="105"><Highlight kind="normal">                                <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;PHINode&#42;&gt;</a> &#42;InsertedPHIs) &#123;</Highlight></CodeLine>
<Link id="l00106" /><CodeLine lineNumber="106"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Remove PHI node entries that are no longer live.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00107" /><CodeLine lineNumber="107"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#abb2b3a60ccc38a28239e19a1646e0c8a">E</a> = OrigHeader-&gt;<a href="/docs/api/classes/llvm/basicblock/#a0b4e7bee9b8575cc7db73329f1a561bd">end</a>();</Highlight></CodeLine>
<Link id="l00108" /><CodeLine lineNumber="108"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = OrigHeader-&gt;<a href="/docs/api/classes/llvm/basicblock/#a0ed5f3ab3c2e4196ee0cffffa080c062">begin</a>(); <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;PN = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;PHINode&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>); ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)</Highlight></CodeLine>
<Link id="l00109" /><CodeLine lineNumber="109"><Highlight kind="normal">    PN-&gt;removeIncomingValue(PN-&gt;getBasicBlockIndex(OrigPreheader));</Highlight></CodeLine>
<Link id="l00110" /><CodeLine lineNumber="110"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00111" /><CodeLine lineNumber="111"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now fix up users of the instructions in OrigHeader, inserting PHI nodes</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00112" /><CodeLine lineNumber="112"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// as necessary.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00113" /><CodeLine lineNumber="113"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/ssaupdater">SSAUpdater</a> <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>(InsertedPHIs);</Highlight></CodeLine>
<Link id="l00114" /><CodeLine lineNumber="114"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = OrigHeader-&gt;<a href="/docs/api/classes/llvm/basicblock/#a0ed5f3ab3c2e4196ee0cffffa080c062">begin</a>(); <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> != <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#abb2b3a60ccc38a28239e19a1646e0c8a">E</a>; ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &#123;</Highlight></CodeLine>
<Link id="l00115" /><CodeLine lineNumber="115"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;OrigHeaderVal = &amp;&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</Highlight></CodeLine>
<Link id="l00116" /><CodeLine lineNumber="116"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00117" /><CodeLine lineNumber="117"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If there are no uses of the value (e.g. because it returns void), there</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00118" /><CodeLine lineNumber="118"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// is nothing to rewrite.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00119" /><CodeLine lineNumber="119"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (OrigHeaderVal-&gt;<a href="/docs/api/classes/llvm/value/#a9d7de807ebdfe1819df3ff6cb0f16158">use&#95;empty</a>())</Highlight></CodeLine>
<Link id="l00120" /><CodeLine lineNumber="120"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00121" /><CodeLine lineNumber="121"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00122" /><CodeLine lineNumber="122"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;OrigPreHeaderVal = <a href="/docs/api/classes/llvm/valuemap">ValueMap</a>.<a href="/docs/api/classes/llvm/valuemap/#a15f92579a5fc316dab8cd1fad51015ef">lookup</a>(OrigHeaderVal);</Highlight></CodeLine>
<Link id="l00123" /><CodeLine lineNumber="123"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00124" /><CodeLine lineNumber="124"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// The value now exits in two versions: the initial value in the preheader</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00125" /><CodeLine lineNumber="125"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// and the loop &quot;next&quot; value in the original header.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00126" /><CodeLine lineNumber="126"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>.Initialize(OrigHeaderVal-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>(), OrigHeaderVal-&gt;<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>());</Highlight></CodeLine>
<Link id="l00127" /><CodeLine lineNumber="127"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Force re-computation of OrigHeaderVal, as some users now need to use the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00128" /><CodeLine lineNumber="128"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// new PHI node.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00129" /><CodeLine lineNumber="129"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SE)</Highlight></CodeLine>
<Link id="l00130" /><CodeLine lineNumber="130"><Highlight kind="normal">      SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a804545e5b568edec8b970da32cd37359">forgetValue</a>(OrigHeaderVal);</Highlight></CodeLine>
<Link id="l00131" /><CodeLine lineNumber="131"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>.AddAvailableValue(OrigHeader, OrigHeaderVal);</Highlight></CodeLine>
<Link id="l00132" /><CodeLine lineNumber="132"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>.AddAvailableValue(OrigPreheader, OrigPreHeaderVal);</Highlight></CodeLine>
<Link id="l00133" /><CodeLine lineNumber="133"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00134" /><CodeLine lineNumber="134"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Visit each use of the OrigHeader instruction.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00135" /><CodeLine lineNumber="135"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/use">Use</a> &amp;U : <a href="/docs/api/namespaces/llvm/#a3d2cdc4a0db233678e7141c9d6ea3419">llvm::make&#95;early&#95;inc&#95;range</a>(OrigHeaderVal-&gt;<a href="/docs/api/classes/llvm/value/#abf855b7cd63a0cd7f73759e396f280c9">uses</a>())) &#123;</Highlight></CodeLine>
<Link id="l00136" /><CodeLine lineNumber="136"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// SSAUpdater can&#39;t handle a non-PHI use in the same block as an</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00137" /><CodeLine lineNumber="137"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// earlier def. We can easily handle those cases manually.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00138" /><CodeLine lineNumber="138"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;UserInst = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Instruction&gt;</a>(U.getUser());</Highlight></CodeLine>
<Link id="l00139" /><CodeLine lineNumber="139"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;PHINode&gt;</a>(UserInst)) &#123;</Highlight></CodeLine>
<Link id="l00140" /><CodeLine lineNumber="140"><Highlight kind="normal">        <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;UserBB = UserInst-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>();</Highlight></CodeLine>
<Link id="l00141" /><CodeLine lineNumber="141"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00142" /><CodeLine lineNumber="142"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// The original users in the OrigHeader are already using the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00143" /><CodeLine lineNumber="143"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// original definitions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00144" /><CodeLine lineNumber="144"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UserBB == OrigHeader)</Highlight></CodeLine>
<Link id="l00145" /><CodeLine lineNumber="145"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00146" /><CodeLine lineNumber="146"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00147" /><CodeLine lineNumber="147"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Users in the OrigPreHeader need to use the value to which the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00148" /><CodeLine lineNumber="148"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// original definitions are mapped.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00149" /><CodeLine lineNumber="149"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UserBB == OrigPreheader) &#123;</Highlight></CodeLine>
<Link id="l00150" /><CodeLine lineNumber="150"><Highlight kind="normal">          U = OrigPreHeaderVal;</Highlight></CodeLine>
<Link id="l00151" /><CodeLine lineNumber="151"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00152" /><CodeLine lineNumber="152"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l00153" /><CodeLine lineNumber="153"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00154" /><CodeLine lineNumber="154"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00155" /><CodeLine lineNumber="155"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Anything else can be handled by SSAUpdater.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00156" /><CodeLine lineNumber="156"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>.RewriteUse(U);</Highlight></CodeLine>
<Link id="l00157" /><CodeLine lineNumber="157"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00158" /><CodeLine lineNumber="158"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00159" /><CodeLine lineNumber="159"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Replace MetadataAsValue(ValueAsMetadata(OrigHeaderVal)) uses in debug</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00160" /><CodeLine lineNumber="160"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// intrinsics.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00161" /><CodeLine lineNumber="161"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;DbgValueInst &#42;, 1&gt;</a> DbgValues;</Highlight></CodeLine>
<Link id="l00162" /><CodeLine lineNumber="162"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;DbgVariableRecord &#42;, 1&gt;</a> DbgVariableRecords;</Highlight></CodeLine>
<Link id="l00163" /><CodeLine lineNumber="163"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a4d7448a42ae4db532d3ba40e250ec825">llvm::findDbgValues</a>(DbgValues, OrigHeaderVal, &amp;DbgVariableRecords);</Highlight></CodeLine>
<Link id="l00164" /><CodeLine lineNumber="164"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;<a href="/docs/api/classes/livedebugvalues/dbgvalue">DbgValue</a> : DbgValues) &#123;</Highlight></CodeLine>
<Link id="l00165" /><CodeLine lineNumber="165"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// The original users in the OrigHeader are already using the original</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00166" /><CodeLine lineNumber="166"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// definitions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00167" /><CodeLine lineNumber="167"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;UserBB = <a href="/docs/api/classes/livedebugvalues/dbgvalue">DbgValue</a>-&gt;getParent();</Highlight></CodeLine>
<Link id="l00168" /><CodeLine lineNumber="168"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UserBB == OrigHeader)</Highlight></CodeLine>
<Link id="l00169" /><CodeLine lineNumber="169"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00170" /><CodeLine lineNumber="170"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00171" /><CodeLine lineNumber="171"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Users in the OrigPreHeader need to use the value to which the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00172" /><CodeLine lineNumber="172"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// original definitions are mapped and anything else can be handled by</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00173" /><CodeLine lineNumber="173"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// the SSAUpdater. To avoid adding PHINodes, check if the value is</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00174" /><CodeLine lineNumber="174"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// available in UserBB, if not substitute poison.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00175" /><CodeLine lineNumber="175"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;NewVal;</Highlight></CodeLine>
<Link id="l00176" /><CodeLine lineNumber="176"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UserBB == OrigPreheader)</Highlight></CodeLine>
<Link id="l00177" /><CodeLine lineNumber="177"><Highlight kind="normal">        NewVal = OrigPreHeaderVal;</Highlight></CodeLine>
<Link id="l00178" /><CodeLine lineNumber="178"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>.HasValueForBlock(UserBB))</Highlight></CodeLine>
<Link id="l00179" /><CodeLine lineNumber="179"><Highlight kind="normal">        NewVal = <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>.GetValueInMiddleOfBlock(UserBB);</Highlight></CodeLine>
<Link id="l00180" /><CodeLine lineNumber="180"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00181" /><CodeLine lineNumber="181"><Highlight kind="normal">        NewVal = <a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(OrigHeaderVal-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>());</Highlight></CodeLine>
<Link id="l00182" /><CodeLine lineNumber="182"><Highlight kind="normal">      <a href="/docs/api/classes/livedebugvalues/dbgvalue">DbgValue</a>-&gt;replaceVariableLocationOp(OrigHeaderVal, NewVal);</Highlight></CodeLine>
<Link id="l00183" /><CodeLine lineNumber="183"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00184" /><CodeLine lineNumber="184"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00185" /><CodeLine lineNumber="185"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// RemoveDIs: duplicate implementation for non-instruction debug-info</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00186" /><CodeLine lineNumber="186"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// storage in DbgVariableRecords.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00187" /><CodeLine lineNumber="187"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/dbgvariablerecord">DbgVariableRecord</a> &#42;DVR : DbgVariableRecords) &#123;</Highlight></CodeLine>
<Link id="l00188" /><CodeLine lineNumber="188"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// The original users in the OrigHeader are already using the original</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00189" /><CodeLine lineNumber="189"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// definitions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00190" /><CodeLine lineNumber="190"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;UserBB = DVR-&gt;<a href="/docs/api/classes/llvm/basicblock/#a952da10b9a7ffd3b3bdeefae13c525a3">getMarker</a>()-&gt;<a href="/docs/api/classes/llvm/dbgmarker/#acf6be32c12a1a6509d7ac0a4d0819f3f">getParent</a>();</Highlight></CodeLine>
<Link id="l00191" /><CodeLine lineNumber="191"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UserBB == OrigHeader)</Highlight></CodeLine>
<Link id="l00192" /><CodeLine lineNumber="192"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00193" /><CodeLine lineNumber="193"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00194" /><CodeLine lineNumber="194"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Users in the OrigPreHeader need to use the value to which the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00195" /><CodeLine lineNumber="195"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// original definitions are mapped and anything else can be handled by</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00196" /><CodeLine lineNumber="196"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// the SSAUpdater. To avoid adding PHINodes, check if the value is</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00197" /><CodeLine lineNumber="197"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// available in UserBB, if not substitute poison.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00198" /><CodeLine lineNumber="198"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;NewVal;</Highlight></CodeLine>
<Link id="l00199" /><CodeLine lineNumber="199"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UserBB == OrigPreheader)</Highlight></CodeLine>
<Link id="l00200" /><CodeLine lineNumber="200"><Highlight kind="normal">        NewVal = OrigPreHeaderVal;</Highlight></CodeLine>
<Link id="l00201" /><CodeLine lineNumber="201"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>.HasValueForBlock(UserBB))</Highlight></CodeLine>
<Link id="l00202" /><CodeLine lineNumber="202"><Highlight kind="normal">        NewVal = <a href="/docs/api/files/lib/lib/analysis/memoryssa-cpp/#a20a60bdac22b099d87d8cb0c1d554120">SSA</a>.GetValueInMiddleOfBlock(UserBB);</Highlight></CodeLine>
<Link id="l00203" /><CodeLine lineNumber="203"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00204" /><CodeLine lineNumber="204"><Highlight kind="normal">        NewVal = <a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(OrigHeaderVal-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>());</Highlight></CodeLine>
<Link id="l00205" /><CodeLine lineNumber="205"><Highlight kind="normal">      DVR-&gt;replaceVariableLocationOp(OrigHeaderVal, NewVal);</Highlight></CodeLine>
<Link id="l00206" /><CodeLine lineNumber="206"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00207" /><CodeLine lineNumber="207"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00208" /><CodeLine lineNumber="208"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00209" /><CodeLine lineNumber="209"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00210" /><CodeLine lineNumber="210"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Assuming both header and latch are exiting, look for a phi which is only</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00211" /><CodeLine lineNumber="211"><Highlight kind="normal"></Highlight><Highlight kind="comment">// used outside the loop (via a LCSSA phi) in the exit from the header.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00212" /><CodeLine lineNumber="212"><Highlight kind="normal"></Highlight><Highlight kind="comment">// This means that rotating the loop can remove the phi.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00213" /><CodeLine lineNumber="213" lineLink="#a7fdcbbf4a72726c120dc9d33b6ee13bb"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a7fdcbbf4a72726c120dc9d33b6ee13bb">profitableToRotateLoopExitingLatch</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L) &#123;</Highlight></CodeLine>
<Link id="l00214" /><CodeLine lineNumber="214"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Header = L-&gt;getHeader();</Highlight></CodeLine>
<Link id="l00215" /><CodeLine lineNumber="215"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;BI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BranchInst&gt;</a>(Header-&gt;getTerminator());</Highlight></CodeLine>
<Link id="l00216" /><CodeLine lineNumber="216"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(BI &amp;&amp; BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#a7e4be8b16fbd68c9045a388904044e01">isConditional</a>() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;need header with conditional exit&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00217" /><CodeLine lineNumber="217"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;HeaderExit = BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(0);</Highlight></CodeLine>
<Link id="l00218" /><CodeLine lineNumber="218"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L-&gt;contains(HeaderExit))</Highlight></CodeLine>
<Link id="l00219" /><CodeLine lineNumber="219"><Highlight kind="normal">    HeaderExit = BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(1);</Highlight></CodeLine>
<Link id="l00220" /><CodeLine lineNumber="220"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00221" /><CodeLine lineNumber="221"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;Phi : Header-&gt;phis()) &#123;</Highlight></CodeLine>
<Link id="l00222" /><CodeLine lineNumber="222"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Look for uses of this phi in the loop/via exits other than the header.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00223" /><CodeLine lineNumber="223"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a61d13d6824ec46c31260a4fd0997eda0">llvm::any&#95;of</a>(Phi.users(), &#91;HeaderExit&#93;(</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/user">User</a> &#42;U) &#123;</Highlight></CodeLine>
<Link id="l00224" /><CodeLine lineNumber="224"><Highlight kind="normal">          return cast&lt;Instruction&gt;(U)-&gt;getParent() != HeaderExit;</Highlight></CodeLine>
<Link id="l00225" /><CodeLine lineNumber="225"><Highlight kind="normal">        &#125;))</Highlight></CodeLine>
<Link id="l00226" /><CodeLine lineNumber="226"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00227" /><CodeLine lineNumber="227"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00228" /><CodeLine lineNumber="228"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00229" /><CodeLine lineNumber="229"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00230" /><CodeLine lineNumber="230"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00231" /><CodeLine lineNumber="231"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00232" /><CodeLine lineNumber="232"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Check that latch exit is deoptimizing (which means - very unlikely to happen)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00233" /><CodeLine lineNumber="233"><Highlight kind="normal"></Highlight><Highlight kind="comment">// and there is another exit from the loop which is non-deoptimizing.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00234" /><CodeLine lineNumber="234"><Highlight kind="normal"></Highlight><Highlight kind="comment">// If we rotate latch to that exit our loop has a better chance of being fully</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00235" /><CodeLine lineNumber="235"><Highlight kind="normal"></Highlight><Highlight kind="comment">// canonical.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00236" /><CodeLine lineNumber="236"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00237" /><CodeLine lineNumber="237"><Highlight kind="normal"></Highlight><Highlight kind="comment">// It can give false positives in some rare cases.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00238" /><CodeLine lineNumber="238" lineLink="#a20d58a0069048b80461676a4132ad1d4"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a20d58a0069048b80461676a4132ad1d4">canRotateDeoptimizingLatchExit</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L) &#123;</Highlight></CodeLine>
<Link id="l00239" /><CodeLine lineNumber="239"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Latch = L-&gt;getLoopLatch();</Highlight></CodeLine>
<Link id="l00240" /><CodeLine lineNumber="240"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Latch &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;need latch&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00241" /><CodeLine lineNumber="241"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;BI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BranchInst&gt;</a>(Latch-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l00242" /><CodeLine lineNumber="242"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Need normal exiting latch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00243" /><CodeLine lineNumber="243"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!BI || !BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#a7e4be8b16fbd68c9045a388904044e01">isConditional</a>())</Highlight></CodeLine>
<Link id="l00244" /><CodeLine lineNumber="244"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00245" /><CodeLine lineNumber="245"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00246" /><CodeLine lineNumber="246"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Exit = BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(1);</Highlight></CodeLine>
<Link id="l00247" /><CodeLine lineNumber="247"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L-&gt;contains(Exit))</Highlight></CodeLine>
<Link id="l00248" /><CodeLine lineNumber="248"><Highlight kind="normal">    Exit = BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(0);</Highlight></CodeLine>
<Link id="l00249" /><CodeLine lineNumber="249"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00250" /><CodeLine lineNumber="250"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Latch exit is non-deoptimizing, no need to rotate.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00251" /><CodeLine lineNumber="251"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!Exit-&gt;getPostdominatingDeoptimizeCall())</Highlight></CodeLine>
<Link id="l00252" /><CodeLine lineNumber="252"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00253" /><CodeLine lineNumber="253"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00254" /><CodeLine lineNumber="254"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 4&gt;</a> Exits;</Highlight></CodeLine>
<Link id="l00255" /><CodeLine lineNumber="255"><Highlight kind="normal">  L-&gt;getUniqueExitBlocks(Exits);</Highlight></CodeLine>
<Link id="l00256" /><CodeLine lineNumber="256"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!Exits.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>()) &#123;</Highlight></CodeLine>
<Link id="l00257" /><CodeLine lineNumber="257"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// There is at least one non-deoptimizing exit.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00258" /><CodeLine lineNumber="258"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00259" /><CodeLine lineNumber="259"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Note, that BasicBlock::getPostdominatingDeoptimizeCall is not exact,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00260" /><CodeLine lineNumber="260"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// as it can conservatively return false for deoptimizing exits with</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00261" /><CodeLine lineNumber="261"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// complex enough control flow down to deoptimize call.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00262" /><CodeLine lineNumber="262"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00263" /><CodeLine lineNumber="263"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// That means here we can report success for a case where</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00264" /><CodeLine lineNumber="264"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// all exits are deoptimizing but one of them has complex enough</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00265" /><CodeLine lineNumber="265"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// control flow (e.g. with loops).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00266" /><CodeLine lineNumber="266"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00267" /><CodeLine lineNumber="267"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// That should be a very rare case and false positives for this function</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00268" /><CodeLine lineNumber="268"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// have compile-time effect only.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00269" /><CodeLine lineNumber="269"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/#a61d13d6824ec46c31260a4fd0997eda0">any&#95;of</a>(Exits, &#91;&#93;(</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB) &#123;</Highlight></CodeLine>
<Link id="l00270" /><CodeLine lineNumber="270"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> !BB-&gt;<a href="/docs/api/classes/llvm/basicblock/#ae8a9915f25abfe7ff5010da686e446c2">getPostdominatingDeoptimizeCall</a>();</Highlight></CodeLine>
<Link id="l00271" /><CodeLine lineNumber="271"><Highlight kind="normal">    &#125;);</Highlight></CodeLine>
<Link id="l00272" /><CodeLine lineNumber="272"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00273" /><CodeLine lineNumber="273"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00274" /><CodeLine lineNumber="274"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00275" /><CodeLine lineNumber="275"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00276" /><CodeLine lineNumber="276" lineLink="#ace004655a04ad52b7fc02fb8e3cf7b0f"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#ace004655a04ad52b7fc02fb8e3cf7b0f">updateBranchWeights</a>(<a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &amp;PreHeaderBI, <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &amp;LoopBI,</Highlight></CodeLine>
<Link id="l00277" /><CodeLine lineNumber="277"><Highlight kind="normal">                                </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> HasConditionalPreHeader,</Highlight></CodeLine>
<Link id="l00278" /><CodeLine lineNumber="278"><Highlight kind="normal">                                </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> SuccsSwapped) &#123;</Highlight></CodeLine>
<Link id="l00279" /><CodeLine lineNumber="279"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42;WeightMD = <a href="/docs/api/namespaces/llvm/#a3475c6d4bdcc4da34ea01a05f01becf2">getBranchWeightMDNode</a>(PreHeaderBI);</Highlight></CodeLine>
<Link id="l00280" /><CodeLine lineNumber="280"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (WeightMD == </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">)</Highlight></CodeLine>
<Link id="l00281" /><CodeLine lineNumber="281"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00282" /><CodeLine lineNumber="282"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00283" /><CodeLine lineNumber="283"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// LoopBI should currently be a clone of PreHeaderBI with the same</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00284" /><CodeLine lineNumber="284"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// metadata. But we double check to make sure we don&#39;t have a degenerate case</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00285" /><CodeLine lineNumber="285"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// where instsimplify changed the instructions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00286" /><CodeLine lineNumber="286"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (WeightMD != <a href="/docs/api/namespaces/llvm/#a3475c6d4bdcc4da34ea01a05f01becf2">getBranchWeightMDNode</a>(LoopBI))</Highlight></CodeLine>
<Link id="l00287" /><CodeLine lineNumber="287"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00288" /><CodeLine lineNumber="288"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00289" /><CodeLine lineNumber="289"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;uint32&#95;t, 2&gt;</a> Weights;</Highlight></CodeLine>
<Link id="l00290" /><CodeLine lineNumber="290"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#a9dd75bd614e308588ff636bbe93265cc">extractFromBranchWeightMD32</a>(WeightMD, Weights);</Highlight></CodeLine>
<Link id="l00291" /><CodeLine lineNumber="291"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Weights.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() != 2)</Highlight></CodeLine>
<Link id="l00292" /><CodeLine lineNumber="292"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00293" /><CodeLine lineNumber="293"><Highlight kind="normal">  uint32&#95;t OrigLoopExitWeight = Weights&#91;0&#93;;</Highlight></CodeLine>
<Link id="l00294" /><CodeLine lineNumber="294"><Highlight kind="normal">  uint32&#95;t OrigLoopBackedgeWeight = Weights&#91;1&#93;;</Highlight></CodeLine>
<Link id="l00295" /><CodeLine lineNumber="295"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00296" /><CodeLine lineNumber="296"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SuccsSwapped)</Highlight></CodeLine>
<Link id="l00297" /><CodeLine lineNumber="297"><Highlight kind="normal">    <a href="/docs/api/namespaces/std/#ab8424022895aee3e366fb9a32f2883cb">std::swap</a>(OrigLoopExitWeight, OrigLoopBackedgeWeight);</Highlight></CodeLine>
<Link id="l00298" /><CodeLine lineNumber="298"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00299" /><CodeLine lineNumber="299"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Update branch weights. Consider the following edge-counts:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00300" /><CodeLine lineNumber="300"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00301" /><CodeLine lineNumber="301"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//    |  |--------             |</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00302" /><CodeLine lineNumber="302"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//    V  V       |             V</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00303" /><CodeLine lineNumber="303"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   Br i1 ...   |            Br i1 ...</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00304" /><CodeLine lineNumber="304"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   |       |   |            |     |</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00305" /><CodeLine lineNumber="305"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//  x|      y|   |  becomes:  |   y0|  |-----</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00306" /><CodeLine lineNumber="306"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   V       V   |            |     V  V    |</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00307" /><CodeLine lineNumber="307"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Exit    Loop  |            |    Loop     |</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00308" /><CodeLine lineNumber="308"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//           |   |            |   Br i1 ... |</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00309" /><CodeLine lineNumber="309"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//           -----            |   |      |  |</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00310" /><CodeLine lineNumber="310"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//                          x0| x1|   y1 |  |</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00311" /><CodeLine lineNumber="311"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//                            V   V      ----</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00312" /><CodeLine lineNumber="312"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//                            Exit</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00313" /><CodeLine lineNumber="313"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00314" /><CodeLine lineNumber="314"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The following must hold:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00315" /><CodeLine lineNumber="315"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//  -  x == x0 + x1        # counts to &quot;exit&quot; must stay the same.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00316" /><CodeLine lineNumber="316"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//  - y0 == x - x0 == x1   # how often loop was entered at all.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00317" /><CodeLine lineNumber="317"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//  - y1 == y - y0         # How often loop was repeated (after first iter.).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00318" /><CodeLine lineNumber="318"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00319" /><CodeLine lineNumber="319"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We cannot generally deduce how often we had a zero-trip count loop so we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00320" /><CodeLine lineNumber="320"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// have to make a guess for how to distribute x among the new x0 and x1.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00321" /><CodeLine lineNumber="321"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00322" /><CodeLine lineNumber="322"><Highlight kind="normal">  uint32&#95;t ExitWeight0;    </Highlight><Highlight kind="comment">// aka x0</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00323" /><CodeLine lineNumber="323"><Highlight kind="normal">  uint32&#95;t ExitWeight1;    </Highlight><Highlight kind="comment">// aka x1</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00324" /><CodeLine lineNumber="324"><Highlight kind="normal">  uint32&#95;t EnterWeight;    </Highlight><Highlight kind="comment">// aka y0</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00325" /><CodeLine lineNumber="325"><Highlight kind="normal">  uint32&#95;t LoopBackWeight; </Highlight><Highlight kind="comment">// aka y1</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00326" /><CodeLine lineNumber="326"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (OrigLoopExitWeight &gt; 0 &amp;&amp; OrigLoopBackedgeWeight &gt; 0) &#123;</Highlight></CodeLine>
<Link id="l00327" /><CodeLine lineNumber="327"><Highlight kind="normal">    ExitWeight0 = 0;</Highlight></CodeLine>
<Link id="l00328" /><CodeLine lineNumber="328"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (HasConditionalPreHeader) &#123;</Highlight></CodeLine>
<Link id="l00329" /><CodeLine lineNumber="329"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Here we cannot know how many 0-trip count loops we have, so we guess:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00330" /><CodeLine lineNumber="330"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (OrigLoopBackedgeWeight &gt;= OrigLoopExitWeight) &#123;</Highlight></CodeLine>
<Link id="l00331" /><CodeLine lineNumber="331"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// If the loop count is bigger than the exit count then we set</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00332" /><CodeLine lineNumber="332"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// probabilities as if 0-trip count nearly never happens.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00333" /><CodeLine lineNumber="333"><Highlight kind="normal">        ExitWeight0 = <a href="#a15d56cf0ab9ff631ca76412249bbb1e2">ZeroTripCountWeights</a>&#91;0&#93;;</Highlight></CodeLine>
<Link id="l00334" /><CodeLine lineNumber="334"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Scale up counts if necessary so we can match &#96;ZeroTripCountWeights&#96;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00335" /><CodeLine lineNumber="335"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// for the &#96;ExitWeight0&#96;:&#96;ExitWeight1&#96; (aka &#96;x0&#96;:&#96;x1&#96; ratio&#96;) ratio.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00336" /><CodeLine lineNumber="336"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (OrigLoopExitWeight &lt; <a href="#a15d56cf0ab9ff631ca76412249bbb1e2">ZeroTripCountWeights</a>&#91;1&#93; + ExitWeight0) &#123;</Highlight></CodeLine>
<Link id="l00337" /><CodeLine lineNumber="337"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// ... but don&#39;t overflow.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00338" /><CodeLine lineNumber="338"><Highlight kind="normal">          uint32&#95;t </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> HighBit = uint32&#95;t&#123;1&#125; &lt;&lt; (</Highlight><Highlight kind="keyword">sizeof</Highlight><Highlight kind="normal">(uint32&#95;t) &#42; 8 - 1);</Highlight></CodeLine>
<Link id="l00339" /><CodeLine lineNumber="339"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> ((OrigLoopBackedgeWeight &amp; HighBit) != 0 ||</Highlight></CodeLine>
<Link id="l00340" /><CodeLine lineNumber="340"><Highlight kind="normal">              (OrigLoopExitWeight &amp; HighBit) != 0)</Highlight></CodeLine>
<Link id="l00341" /><CodeLine lineNumber="341"><Highlight kind="normal">            </Highlight><Highlight kind="keywordflow">break</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00342" /><CodeLine lineNumber="342"><Highlight kind="normal">          OrigLoopBackedgeWeight &lt;&lt;= 1;</Highlight></CodeLine>
<Link id="l00343" /><CodeLine lineNumber="343"><Highlight kind="normal">          OrigLoopExitWeight &lt;&lt;= 1;</Highlight></CodeLine>
<Link id="l00344" /><CodeLine lineNumber="344"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l00345" /><CodeLine lineNumber="345"><Highlight kind="normal">      &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00346" /><CodeLine lineNumber="346"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// If there&#39;s a higher exit-count than backedge-count then we set</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00347" /><CodeLine lineNumber="347"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// probabilities as if there are only 0-trip and 1-trip cases.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00348" /><CodeLine lineNumber="348"><Highlight kind="normal">        ExitWeight0 = OrigLoopExitWeight - OrigLoopBackedgeWeight;</Highlight></CodeLine>
<Link id="l00349" /><CodeLine lineNumber="349"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00350" /><CodeLine lineNumber="350"><Highlight kind="normal">    &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00351" /><CodeLine lineNumber="351"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Theoretically, if the loop body must be executed at least once, the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00352" /><CodeLine lineNumber="352"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// backedge count must be not less than exit count. However the branch</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00353" /><CodeLine lineNumber="353"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// weight collected by sampling-based PGO may be not very accurate due to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00354" /><CodeLine lineNumber="354"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// sampling. Therefore this workaround is required here to avoid underflow</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00355" /><CodeLine lineNumber="355"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// of unsigned in following update of branch weight.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00356" /><CodeLine lineNumber="356"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (OrigLoopExitWeight &gt; OrigLoopBackedgeWeight)</Highlight></CodeLine>
<Link id="l00357" /><CodeLine lineNumber="357"><Highlight kind="normal">        OrigLoopBackedgeWeight = OrigLoopExitWeight;</Highlight></CodeLine>
<Link id="l00358" /><CodeLine lineNumber="358"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00359" /><CodeLine lineNumber="359"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(OrigLoopExitWeight &gt;= ExitWeight0 &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Bad branch weight&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00360" /><CodeLine lineNumber="360"><Highlight kind="normal">    ExitWeight1 = OrigLoopExitWeight - ExitWeight0;</Highlight></CodeLine>
<Link id="l00361" /><CodeLine lineNumber="361"><Highlight kind="normal">    EnterWeight = ExitWeight1;</Highlight></CodeLine>
<Link id="l00362" /><CodeLine lineNumber="362"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(OrigLoopBackedgeWeight &gt;= EnterWeight &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Bad branch weight&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00363" /><CodeLine lineNumber="363"><Highlight kind="normal">    LoopBackWeight = OrigLoopBackedgeWeight - EnterWeight;</Highlight></CodeLine>
<Link id="l00364" /><CodeLine lineNumber="364"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (OrigLoopExitWeight == 0) &#123;</Highlight></CodeLine>
<Link id="l00365" /><CodeLine lineNumber="365"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (OrigLoopBackedgeWeight == 0) &#123;</Highlight></CodeLine>
<Link id="l00366" /><CodeLine lineNumber="366"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// degenerate case... keep everything zero...</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00367" /><CodeLine lineNumber="367"><Highlight kind="normal">      ExitWeight0 = 0;</Highlight></CodeLine>
<Link id="l00368" /><CodeLine lineNumber="368"><Highlight kind="normal">      ExitWeight1 = 0;</Highlight></CodeLine>
<Link id="l00369" /><CodeLine lineNumber="369"><Highlight kind="normal">      EnterWeight = 0;</Highlight></CodeLine>
<Link id="l00370" /><CodeLine lineNumber="370"><Highlight kind="normal">      LoopBackWeight = 0;</Highlight></CodeLine>
<Link id="l00371" /><CodeLine lineNumber="371"><Highlight kind="normal">    &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00372" /><CodeLine lineNumber="372"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Special case &quot;LoopExitWeight == 0&quot; weights which behaves like an</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00373" /><CodeLine lineNumber="373"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// endless where we don&#39;t want loop-enttry (y0) to be the same as</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00374" /><CodeLine lineNumber="374"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// loop-exit (x1).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00375" /><CodeLine lineNumber="375"><Highlight kind="normal">      ExitWeight0 = 0;</Highlight></CodeLine>
<Link id="l00376" /><CodeLine lineNumber="376"><Highlight kind="normal">      ExitWeight1 = 0;</Highlight></CodeLine>
<Link id="l00377" /><CodeLine lineNumber="377"><Highlight kind="normal">      EnterWeight = 1;</Highlight></CodeLine>
<Link id="l00378" /><CodeLine lineNumber="378"><Highlight kind="normal">      LoopBackWeight = OrigLoopBackedgeWeight;</Highlight></CodeLine>
<Link id="l00379" /><CodeLine lineNumber="379"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00380" /><CodeLine lineNumber="380"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00381" /><CodeLine lineNumber="381"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// loop is never entered.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00382" /><CodeLine lineNumber="382"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(OrigLoopBackedgeWeight == 0 &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;remaining case is backedge zero&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00383" /><CodeLine lineNumber="383"><Highlight kind="normal">    ExitWeight0 = 1;</Highlight></CodeLine>
<Link id="l00384" /><CodeLine lineNumber="384"><Highlight kind="normal">    ExitWeight1 = 1;</Highlight></CodeLine>
<Link id="l00385" /><CodeLine lineNumber="385"><Highlight kind="normal">    EnterWeight = 0;</Highlight></CodeLine>
<Link id="l00386" /><CodeLine lineNumber="386"><Highlight kind="normal">    LoopBackWeight = 0;</Highlight></CodeLine>
<Link id="l00387" /><CodeLine lineNumber="387"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00388" /><CodeLine lineNumber="388"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00389" /><CodeLine lineNumber="389"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> uint32&#95;t LoopBIWeights&#91;&#93; = &#123;</Highlight></CodeLine>
<Link id="l00390" /><CodeLine lineNumber="390"><Highlight kind="normal">      SuccsSwapped ? LoopBackWeight : ExitWeight1,</Highlight></CodeLine>
<Link id="l00391" /><CodeLine lineNumber="391"><Highlight kind="normal">      SuccsSwapped ? ExitWeight1 : LoopBackWeight,</Highlight></CodeLine>
<Link id="l00392" /><CodeLine lineNumber="392"><Highlight kind="normal">  &#125;;</Highlight></CodeLine>
<Link id="l00393" /><CodeLine lineNumber="393"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#a6cf82c052d63a1b464be8e48ff38c48e">setBranchWeights</a>(LoopBI, LoopBIWeights, </Highlight><Highlight kind="comment">/&#42;IsExpected=&#42;/</Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00394" /><CodeLine lineNumber="394"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (HasConditionalPreHeader) &#123;</Highlight></CodeLine>
<Link id="l00395" /><CodeLine lineNumber="395"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> uint32&#95;t PreHeaderBIWeights&#91;&#93; = &#123;</Highlight></CodeLine>
<Link id="l00396" /><CodeLine lineNumber="396"><Highlight kind="normal">        SuccsSwapped ? EnterWeight : ExitWeight0,</Highlight></CodeLine>
<Link id="l00397" /><CodeLine lineNumber="397"><Highlight kind="normal">        SuccsSwapped ? ExitWeight0 : EnterWeight,</Highlight></CodeLine>
<Link id="l00398" /><CodeLine lineNumber="398"><Highlight kind="normal">    &#125;;</Highlight></CodeLine>
<Link id="l00399" /><CodeLine lineNumber="399"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a6cf82c052d63a1b464be8e48ff38c48e">setBranchWeights</a>(PreHeaderBI, PreHeaderBIWeights, </Highlight><Highlight kind="comment">/&#42;IsExpected=&#42;/</Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00400" /><CodeLine lineNumber="400"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00401" /><CodeLine lineNumber="401"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00402" /><CodeLine lineNumber="402"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00403" /><CodeLine lineNumber="403"><Highlight kind="comment">/// Rotate loop LP. Return true if the loop is rotated.</Highlight></CodeLine>
<Link id="l00404" /><CodeLine lineNumber="404"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00405" /><CodeLine lineNumber="405"><Highlight kind="comment">/// \\param SimplifiedLatch is true if the latch was just folded into the final</Highlight></CodeLine>
<Link id="l00406" /><CodeLine lineNumber="406"><Highlight kind="comment">/// loop exit. In this case we may want to rotate even though the new latch is</Highlight></CodeLine>
<Link id="l00407" /><CodeLine lineNumber="407"><Highlight kind="comment">/// now an exiting branch. This rotation would have happened had the latch not</Highlight></CodeLine>
<Link id="l00408" /><CodeLine lineNumber="408"><Highlight kind="comment">/// been simplified. However, if SimplifiedLatch is false, then we avoid</Highlight></CodeLine>
<Link id="l00409" /><CodeLine lineNumber="409"><Highlight kind="comment">/// rotating loops in which the latch exits to avoid excessive or endless</Highlight></CodeLine>
<Link id="l00410" /><CodeLine lineNumber="410"><Highlight kind="comment">/// rotation. LoopRotate should be repeatable and converge to a canonical</Highlight></CodeLine>
<Link id="l00411" /><CodeLine lineNumber="411"><Highlight kind="comment">/// form. This property is satisfied because simplifying the loop latch can only</Highlight></CodeLine>
<Link id="l00412" /><CodeLine lineNumber="412"><Highlight kind="comment">/// happen once across multiple invocations of the LoopRotate pass.</Highlight></CodeLine>
<Link id="l00413" /><CodeLine lineNumber="413"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00414" /><CodeLine lineNumber="414"><Highlight kind="comment">/// If -loop-rotate-multi is enabled we can do multiple rotations in one go</Highlight></CodeLine>
<Link id="l00415" /><CodeLine lineNumber="415"><Highlight kind="comment">/// so to reach a suitable (non-deoptimizing) exit.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00416" /><CodeLine lineNumber="416"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> LoopRotate::rotateLoop(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L, </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> SimplifiedLatch) &#123;</Highlight></CodeLine>
<Link id="l00417" /><CodeLine lineNumber="417"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If the loop has only one block then there is not much to rotate.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00418" /><CodeLine lineNumber="418"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;getBlocks().size() == 1)</Highlight></CodeLine>
<Link id="l00419" /><CodeLine lineNumber="419"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00420" /><CodeLine lineNumber="420"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00421" /><CodeLine lineNumber="421"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> Rotated = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00422" /><CodeLine lineNumber="422"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">do</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00423" /><CodeLine lineNumber="423"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;OrigHeader = <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;getHeader();</Highlight></CodeLine>
<Link id="l00424" /><CodeLine lineNumber="424"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;OrigLatch = <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;getLoopLatch();</Highlight></CodeLine>
<Link id="l00425" /><CodeLine lineNumber="425"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00426" /><CodeLine lineNumber="426"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;BI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BranchInst&gt;</a>(OrigHeader-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l00427" /><CodeLine lineNumber="427"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!BI || BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#ad56f6a9b5cd05940017c4544df48bc30">isUnconditional</a>())</Highlight></CodeLine>
<Link id="l00428" /><CodeLine lineNumber="428"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> Rotated;</Highlight></CodeLine>
<Link id="l00429" /><CodeLine lineNumber="429"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00430" /><CodeLine lineNumber="430"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If the loop header is not one of the loop exiting blocks then</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00431" /><CodeLine lineNumber="431"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// either this loop is already rotated or it is not</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00432" /><CodeLine lineNumber="432"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// suitable for loop rotation transformations.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00433" /><CodeLine lineNumber="433"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;isLoopExiting(OrigHeader))</Highlight></CodeLine>
<Link id="l00434" /><CodeLine lineNumber="434"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> Rotated;</Highlight></CodeLine>
<Link id="l00435" /><CodeLine lineNumber="435"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00436" /><CodeLine lineNumber="436"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If the loop latch already contains a branch that leaves the loop then the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00437" /><CodeLine lineNumber="437"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// loop is already rotated.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00438" /><CodeLine lineNumber="438"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!OrigLatch)</Highlight></CodeLine>
<Link id="l00439" /><CodeLine lineNumber="439"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> Rotated;</Highlight></CodeLine>
<Link id="l00440" /><CodeLine lineNumber="440"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00441" /><CodeLine lineNumber="441"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Rotate if either the loop latch does &#42;not&#42; exit the loop, or if the loop</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00442" /><CodeLine lineNumber="442"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// latch was just simplified. Or if we think it will be profitable.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00443" /><CodeLine lineNumber="443"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;isLoopExiting(OrigLatch) &amp;&amp; !SimplifiedLatch &amp;&amp; IsUtilMode == </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal"> &amp;&amp;</Highlight></CodeLine>
<Link id="l00444" /><CodeLine lineNumber="444"><Highlight kind="normal">        !<a href="#a7fdcbbf4a72726c120dc9d33b6ee13bb">profitableToRotateLoopExitingLatch</a>(L) &amp;&amp;</Highlight></CodeLine>
<Link id="l00445" /><CodeLine lineNumber="445"><Highlight kind="normal">        !<a href="#a20d58a0069048b80461676a4132ad1d4">canRotateDeoptimizingLatchExit</a>(L))</Highlight></CodeLine>
<Link id="l00446" /><CodeLine lineNumber="446"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> Rotated;</Highlight></CodeLine>
<Link id="l00447" /><CodeLine lineNumber="447"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00448" /><CodeLine lineNumber="448"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Check size of original header and reject loop if it is very big or we can&#39;t</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00449" /><CodeLine lineNumber="449"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// duplicate blocks inside it.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00450" /><CodeLine lineNumber="450"><Highlight kind="normal">    &#123;</Highlight></CodeLine>
<Link id="l00451" /><CodeLine lineNumber="451"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;const Value &#42;, 32&gt;</a> EphValues;</Highlight></CodeLine>
<Link id="l00452" /><CodeLine lineNumber="452"><Highlight kind="normal">      <a href="/docs/api/structs/llvm/codemetrics/#a7e174506b52ad46ea1f746a7f727d999">CodeMetrics::collectEphemeralValues</a>(L, AC, EphValues);</Highlight></CodeLine>
<Link id="l00453" /><CodeLine lineNumber="453"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00454" /><CodeLine lineNumber="454"><Highlight kind="normal">      <a href="/docs/api/structs/llvm/codemetrics">CodeMetrics</a> <a href="/docs/api/files/lib/lib/codegen/machinetracemetrics-cpp/#a6f3004139ef53bc2cf206b8864976928">Metrics</a>;</Highlight></CodeLine>
<Link id="l00455" /><CodeLine lineNumber="455"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/codegen/machinetracemetrics-cpp/#a6f3004139ef53bc2cf206b8864976928">Metrics</a>.analyzeBasicBlock(OrigHeader, &#42;<a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>, EphValues, PrepareForLTO);</Highlight></CodeLine>
<Link id="l00456" /><CodeLine lineNumber="456"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/codegen/machinetracemetrics-cpp/#a6f3004139ef53bc2cf206b8864976928">Metrics</a>.notDuplicatable) &#123;</Highlight></CodeLine>
<Link id="l00457" /><CodeLine lineNumber="457"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(</Highlight></CodeLine>
<Link id="l00458" /><CodeLine lineNumber="458"><Highlight kind="normal">                   <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;LoopRotation: NOT rotating - contains non-duplicatable&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00459" /><CodeLine lineNumber="459"><Highlight kind="normal">                   &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; instructions: &quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00460" /><CodeLine lineNumber="460"><Highlight kind="normal">                   <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;dump());</Highlight></CodeLine>
<Link id="l00461" /><CodeLine lineNumber="461"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> Rotated;</Highlight></CodeLine>
<Link id="l00462" /><CodeLine lineNumber="462"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00463" /><CodeLine lineNumber="463"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/codegen/machinetracemetrics-cpp/#a6f3004139ef53bc2cf206b8864976928">Metrics</a>.Convergence != <a href="/docs/api/namespaces/llvm/#a177a8536e97483817917ecaa40ca1b69a6adf97f83acf6453d4a6a4b1070f3754">ConvergenceKind::None</a>) &#123;</Highlight></CodeLine>
<Link id="l00464" /><CodeLine lineNumber="464"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;LoopRotation: NOT rotating - contains convergent &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00465" /><CodeLine lineNumber="465"><Highlight kind="normal">                   </Highlight><Highlight kind="stringliteral">&quot;instructions: &quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00466" /><CodeLine lineNumber="466"><Highlight kind="normal">                   <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;dump());</Highlight></CodeLine>
<Link id="l00467" /><CodeLine lineNumber="467"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> Rotated;</Highlight></CodeLine>
<Link id="l00468" /><CodeLine lineNumber="468"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00469" /><CodeLine lineNumber="469"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/files/lib/lib/codegen/machinetracemetrics-cpp/#a6f3004139ef53bc2cf206b8864976928">Metrics</a>.NumInsts.isValid()) &#123;</Highlight></CodeLine>
<Link id="l00470" /><CodeLine lineNumber="470"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;LoopRotation: NOT rotating - contains instructions&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00471" /><CodeLine lineNumber="471"><Highlight kind="normal">                   </Highlight><Highlight kind="stringliteral">&quot; with invalid cost: &quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00472" /><CodeLine lineNumber="472"><Highlight kind="normal">                   <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;dump());</Highlight></CodeLine>
<Link id="l00473" /><CodeLine lineNumber="473"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> Rotated;</Highlight></CodeLine>
<Link id="l00474" /><CodeLine lineNumber="474"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00475" /><CodeLine lineNumber="475"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/codegen/machinetracemetrics-cpp/#a6f3004139ef53bc2cf206b8864976928">Metrics</a>.NumInsts &gt; MaxHeaderSize) &#123;</Highlight></CodeLine>
<Link id="l00476" /><CodeLine lineNumber="476"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;LoopRotation: NOT rotating - contains &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00477" /><CodeLine lineNumber="477"><Highlight kind="normal">                          &lt;&lt; <a href="/docs/api/files/lib/lib/codegen/machinetracemetrics-cpp/#a6f3004139ef53bc2cf206b8864976928">Metrics</a>.NumInsts</Highlight></CodeLine>
<Link id="l00478" /><CodeLine lineNumber="478"><Highlight kind="normal">                          &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; instructions, which is more than the threshold (&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00479" /><CodeLine lineNumber="479"><Highlight kind="normal">                          &lt;&lt; MaxHeaderSize &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; instructions): &quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00480" /><CodeLine lineNumber="480"><Highlight kind="normal">                   <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;dump());</Highlight></CodeLine>
<Link id="l00481" /><CodeLine lineNumber="481"><Highlight kind="normal">        ++NumNotRotatedDueToHeaderSize;</Highlight></CodeLine>
<Link id="l00482" /><CodeLine lineNumber="482"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> Rotated;</Highlight></CodeLine>
<Link id="l00483" /><CodeLine lineNumber="483"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00484" /><CodeLine lineNumber="484"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00485" /><CodeLine lineNumber="485"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// When preparing for LTO, avoid rotating loops with calls that could be</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00486" /><CodeLine lineNumber="486"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// inlined during the LTO stage.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00487" /><CodeLine lineNumber="487"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (PrepareForLTO &amp;&amp; <a href="/docs/api/files/lib/lib/codegen/machinetracemetrics-cpp/#a6f3004139ef53bc2cf206b8864976928">Metrics</a>.NumInlineCandidates &gt; 0)</Highlight></CodeLine>
<Link id="l00488" /><CodeLine lineNumber="488"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> Rotated;</Highlight></CodeLine>
<Link id="l00489" /><CodeLine lineNumber="489"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00490" /><CodeLine lineNumber="490"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00491" /><CodeLine lineNumber="491"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Now, this loop is suitable for rotation.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00492" /><CodeLine lineNumber="492"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;OrigPreheader = <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;getLoopPreheader();</Highlight></CodeLine>
<Link id="l00493" /><CodeLine lineNumber="493"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00494" /><CodeLine lineNumber="494"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If the loop could not be converted to canonical form, it must have an</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00495" /><CodeLine lineNumber="495"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// indirectbr in it, just give up.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00496" /><CodeLine lineNumber="496"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!OrigPreheader || !<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;hasDedicatedExits())</Highlight></CodeLine>
<Link id="l00497" /><CodeLine lineNumber="497"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> Rotated;</Highlight></CodeLine>
<Link id="l00498" /><CodeLine lineNumber="498"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00499" /><CodeLine lineNumber="499"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Anything ScalarEvolution may know about this loop or the PHI nodes</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00500" /><CodeLine lineNumber="500"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// in its header will soon be invalidated. We should also invalidate</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00501" /><CodeLine lineNumber="501"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// all outer loops because insertion and deletion of blocks that happens</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00502" /><CodeLine lineNumber="502"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// during the rotation may violate invariants related to backedge taken</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00503" /><CodeLine lineNumber="503"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// infos in them.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00504" /><CodeLine lineNumber="504"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SE) &#123;</Highlight></CodeLine>
<Link id="l00505" /><CodeLine lineNumber="505"><Highlight kind="normal">      SE-&gt;forgetTopmostLoop(L);</Highlight></CodeLine>
<Link id="l00506" /><CodeLine lineNumber="506"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We may hoist some instructions out of loop. In case if they were cached</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00507" /><CodeLine lineNumber="507"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// as &quot;loop variant&quot; or &quot;loop computable&quot;, these caches must be dropped.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00508" /><CodeLine lineNumber="508"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We also may fold basic blocks, so cached block dispositions also need</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00509" /><CodeLine lineNumber="509"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// to be dropped.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00510" /><CodeLine lineNumber="510"><Highlight kind="normal">      SE-&gt;forgetBlockAndLoopDispositions();</Highlight></CodeLine>
<Link id="l00511" /><CodeLine lineNumber="511"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00512" /><CodeLine lineNumber="512"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00513" /><CodeLine lineNumber="513"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;LoopRotation: rotating &quot;</Highlight><Highlight kind="normal">; <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;dump());</Highlight></CodeLine>
<Link id="l00514" /><CodeLine lineNumber="514"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU &amp;&amp; <a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l00515" /><CodeLine lineNumber="515"><Highlight kind="normal">      MSSAU-&gt;getMemorySSA()-&gt;verifyMemorySSA();</Highlight></CodeLine>
<Link id="l00516" /><CodeLine lineNumber="516"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00517" /><CodeLine lineNumber="517"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Find new Loop header. NewHeader is a Header&#39;s one and only successor</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00518" /><CodeLine lineNumber="518"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// that is inside loop.  Header&#39;s other successor is outside the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00519" /><CodeLine lineNumber="519"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// loop.  Otherwise loop is not suitable for rotation.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00520" /><CodeLine lineNumber="520"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;<a href="/docs/api/namespaces/llvm/coff/#ae7629a0652411dc2be61aea4fee2b39cacd4cef2a5a26efd5d75ecca95bc6ff24">Exit</a> = BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(0);</Highlight></CodeLine>
<Link id="l00521" /><CodeLine lineNumber="521"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewHeader = BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(1);</Highlight></CodeLine>
<Link id="l00522" /><CodeLine lineNumber="522"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> BISuccsSwapped = <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;contains(Exit);</Highlight></CodeLine>
<Link id="l00523" /><CodeLine lineNumber="523"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BISuccsSwapped)</Highlight></CodeLine>
<Link id="l00524" /><CodeLine lineNumber="524"><Highlight kind="normal">      <a href="/docs/api/namespaces/std/#ab8424022895aee3e366fb9a32f2883cb">std::swap</a>(Exit, NewHeader);</Highlight></CodeLine>
<Link id="l00525" /><CodeLine lineNumber="525"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(NewHeader &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Unable to determine new loop header&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00526" /><CodeLine lineNumber="526"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;contains(NewHeader) &amp;&amp; !<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;contains(Exit) &amp;&amp;</Highlight></CodeLine>
<Link id="l00527" /><CodeLine lineNumber="527"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;Unable to determine loop header and exit blocks&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00528" /><CodeLine lineNumber="528"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00529" /><CodeLine lineNumber="529"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// This code assumes that the new header has exactly one predecessor.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00530" /><CodeLine lineNumber="530"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Remove any single-entry PHI nodes in it.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00531" /><CodeLine lineNumber="531"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(NewHeader-&gt;<a href="/docs/api/classes/llvm/basicblock/#a59fb91d1691350f7d1b8e8a114e3f2a4">getSinglePredecessor</a>() &amp;&amp;</Highlight></CodeLine>
<Link id="l00532" /><CodeLine lineNumber="532"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;New header doesn&#39;t have one pred!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00533" /><CodeLine lineNumber="533"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#ab7e8be1d1ae7e526ea156b60c51c10e5">FoldSingleEntryPHINodes</a>(NewHeader);</Highlight></CodeLine>
<Link id="l00534" /><CodeLine lineNumber="534"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00535" /><CodeLine lineNumber="535"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Begin by walking OrigHeader and populating ValueMap with an entry for</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00536" /><CodeLine lineNumber="536"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// each Instruction.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00537" /><CodeLine lineNumber="537"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = OrigHeader-&gt;<a href="/docs/api/classes/llvm/basicblock/#a0ed5f3ab3c2e4196ee0cffffa080c062">begin</a>(), <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#abb2b3a60ccc38a28239e19a1646e0c8a">E</a> = OrigHeader-&gt;<a href="/docs/api/classes/llvm/basicblock/#a0b4e7bee9b8575cc7db73329f1a561bd">end</a>();</Highlight></CodeLine>
<Link id="l00538" /><CodeLine lineNumber="538"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> <a href="/docs/api/classes/llvm/valuemap">ValueMap</a>, ValueMapMSSA;</Highlight></CodeLine>
<Link id="l00539" /><CodeLine lineNumber="539"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00540" /><CodeLine lineNumber="540"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// For PHI nodes, the value available in OldPreHeader is just the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00541" /><CodeLine lineNumber="541"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// incoming value from OldPreHeader.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00542" /><CodeLine lineNumber="542"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (; <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;PN = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;PHINode&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>); ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)</Highlight></CodeLine>
<Link id="l00543" /><CodeLine lineNumber="543"><Highlight kind="normal">      <a href="#ad2e3518508b7df1cb9b6ab4dba6557f1">InsertNewValueIntoMap</a>(<a href="/docs/api/classes/llvm/valuemap">ValueMap</a>, PN,</Highlight></CodeLine>
<Link id="l00544" /><CodeLine lineNumber="544"><Highlight kind="normal">                            PN-&gt;<a href="/docs/api/classes/llvm/phinode/#ab2db7609ec72b1af2f91d47e40dc3722">getIncomingValueForBlock</a>(OrigPreheader));</Highlight></CodeLine>
<Link id="l00545" /><CodeLine lineNumber="545"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00546" /><CodeLine lineNumber="546"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// For the rest of the instructions, either hoist to the OrigPreheader if</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00547" /><CodeLine lineNumber="547"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// possible or create a clone in the OldPreHeader if not.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00548" /><CodeLine lineNumber="548"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;LoopEntryBranch = OrigPreheader-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>();</Highlight></CodeLine>
<Link id="l00549" /><CodeLine lineNumber="549"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00550" /><CodeLine lineNumber="550"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Record all debug intrinsics preceding LoopEntryBranch to avoid</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00551" /><CodeLine lineNumber="551"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// duplication.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00552" /><CodeLine lineNumber="552"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">using </Highlight><Highlight kind="normal">DbgIntrinsicHash =</Highlight></CodeLine>
<Link id="l00553" /><CodeLine lineNumber="553"><Highlight kind="normal">        std::pair&lt;std::pair&lt;hash&#95;code, DILocalVariable &#42;&gt;, <a href="/docs/api/classes/llvm/diexpression">DIExpression</a> &#42;&gt;;</Highlight></CodeLine>
<Link id="l00554" /><CodeLine lineNumber="554"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> makeHash = &#91;&#93;(</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#a6a9f043784cf87001c84980afa76da82">D</a>) -&gt; DbgIntrinsicHash &#123;</Highlight></CodeLine>
<Link id="l00555" /><CodeLine lineNumber="555"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> VarLocOps = <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#a6a9f043784cf87001c84980afa76da82">D</a>-&gt;location&#95;ops();</Highlight></CodeLine>
<Link id="l00556" /><CodeLine lineNumber="556"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> &#123;&#123;<a href="/docs/api/namespaces/llvm/#af80edfc5e42059e045aa7bf7fe42bee3">hash&#95;combine&#95;range</a>(VarLocOps.begin(), VarLocOps.end()),</Highlight></CodeLine>
<Link id="l00557" /><CodeLine lineNumber="557"><Highlight kind="normal">               <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#a6a9f043784cf87001c84980afa76da82">D</a>-&gt;getVariable()&#125;,</Highlight></CodeLine>
<Link id="l00558" /><CodeLine lineNumber="558"><Highlight kind="normal">              <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#a6a9f043784cf87001c84980afa76da82">D</a>-&gt;getExpression()&#125;;</Highlight></CodeLine>
<Link id="l00559" /><CodeLine lineNumber="559"><Highlight kind="normal">    &#125;;</Highlight></CodeLine>
<Link id="l00560" /><CodeLine lineNumber="560"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00561" /><CodeLine lineNumber="561"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smalldenseset">SmallDenseSet&lt;DbgIntrinsicHash, 8&gt;</a> DbgIntrinsics;</Highlight></CodeLine>
<Link id="l00562" /><CodeLine lineNumber="562"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : <a href="/docs/api/namespaces/llvm/#a02981de53fb6ffd384d39addc4d25f37">llvm::drop&#95;begin</a>(<a href="/docs/api/namespaces/llvm/#a6b0ac1fa4f05de76413c5e0ca6334035">llvm::reverse</a>(&#42;OrigPreheader))) &#123;</Highlight></CodeLine>
<Link id="l00563" /><CodeLine lineNumber="563"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;DII = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;DbgVariableIntrinsic&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) &#123;</Highlight></CodeLine>
<Link id="l00564" /><CodeLine lineNumber="564"><Highlight kind="normal">        DbgIntrinsics.<a href="/docs/api/classes/llvm/detail/densesetimpl/#a1b0f3ebdced8fce4b22c6a63b25d9525">insert</a>(makeHash(DII));</Highlight></CodeLine>
<Link id="l00565" /><CodeLine lineNumber="565"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Until RemoveDIs supports dbg.declares in DbgVariableRecord format,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00566" /><CodeLine lineNumber="566"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// we&#39;ll need to collect DbgVariableRecords attached to any other debug</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00567" /><CodeLine lineNumber="567"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// intrinsics.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00568" /><CodeLine lineNumber="568"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/dbgvariablerecord">DbgVariableRecord</a> &amp;DVR :</Highlight></CodeLine>
<Link id="l00569" /><CodeLine lineNumber="569"><Highlight kind="normal">             <a href="/docs/api/namespaces/llvm/#ae876eb96b89c1afcc3e9cd285cc3f08c">filterDbgVars</a>(DII-&gt;getDbgRecordRange()))</Highlight></CodeLine>
<Link id="l00570" /><CodeLine lineNumber="570"><Highlight kind="normal">          DbgIntrinsics.<a href="/docs/api/classes/llvm/detail/densesetimpl/#a1b0f3ebdced8fce4b22c6a63b25d9525">insert</a>(makeHash(&amp;DVR));</Highlight></CodeLine>
<Link id="l00571" /><CodeLine lineNumber="571"><Highlight kind="normal">      &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00572" /><CodeLine lineNumber="572"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">break</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00573" /><CodeLine lineNumber="573"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00574" /><CodeLine lineNumber="574"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00575" /><CodeLine lineNumber="575"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00576" /><CodeLine lineNumber="576"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Build DbgVariableRecord hashes for DbgVariableRecords attached to the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00577" /><CodeLine lineNumber="577"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// terminator, which isn&#39;t considered in the loop above.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00578" /><CodeLine lineNumber="578"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/dbgvariablerecord">DbgVariableRecord</a> &amp;DVR :</Highlight></CodeLine>
<Link id="l00579" /><CodeLine lineNumber="579"><Highlight kind="normal">         <a href="/docs/api/namespaces/llvm/#ae876eb96b89c1afcc3e9cd285cc3f08c">filterDbgVars</a>(OrigPreheader-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>()-&gt;<a href="/docs/api/classes/llvm/instruction/#a431be97c0e4d03f713d927197cdcfff0">getDbgRecordRange</a>()))</Highlight></CodeLine>
<Link id="l00580" /><CodeLine lineNumber="580"><Highlight kind="normal">      DbgIntrinsics.<a href="/docs/api/classes/llvm/detail/densesetimpl/#a1b0f3ebdced8fce4b22c6a63b25d9525">insert</a>(makeHash(&amp;DVR));</Highlight></CodeLine>
<Link id="l00581" /><CodeLine lineNumber="581"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00582" /><CodeLine lineNumber="582"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Remember the local noalias scope declarations in the header. After the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00583" /><CodeLine lineNumber="583"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// rotation, they must be duplicated and the scope must be cloned. This</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00584" /><CodeLine lineNumber="584"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// avoids unwanted interaction across iterations.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00585" /><CodeLine lineNumber="585"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;NoAliasScopeDeclInst &#42;, 6&gt;</a> NoAliasDeclInstructions;</Highlight></CodeLine>
<Link id="l00586" /><CodeLine lineNumber="586"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : &#42;OrigHeader)</Highlight></CodeLine>
<Link id="l00587" /><CodeLine lineNumber="587"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;Decl = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;NoAliasScopeDeclInst&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</Highlight></CodeLine>
<Link id="l00588" /><CodeLine lineNumber="588"><Highlight kind="normal">        NoAliasDeclInstructions.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(Decl);</Highlight></CodeLine>
<Link id="l00589" /><CodeLine lineNumber="589"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00590" /><CodeLine lineNumber="590"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/module">Module</a> &#42;M = OrigHeader-&gt;getModule();</Highlight></CodeLine>
<Link id="l00591" /><CodeLine lineNumber="591"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00592" /><CodeLine lineNumber="592"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Track the next DbgRecord to clone. If we have a sequence where an</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00593" /><CodeLine lineNumber="593"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// instruction is hoisted instead of being cloned:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00594" /><CodeLine lineNumber="594"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//    DbgRecord blah</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00595" /><CodeLine lineNumber="595"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//    %foo = add i32 0, 0</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00596" /><CodeLine lineNumber="596"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//    DbgRecord xyzzy</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00597" /><CodeLine lineNumber="597"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//    %bar = call i32 @foobar()</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00598" /><CodeLine lineNumber="598"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// where %foo is hoisted, then the DbgRecord &quot;blah&quot; will be seen twice, once</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00599" /><CodeLine lineNumber="599"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// attached to %foo, then when %foo his hoisted it will &quot;fall down&quot; onto the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00600" /><CodeLine lineNumber="600"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// function call:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00601" /><CodeLine lineNumber="601"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//    DbgRecord blah</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00602" /><CodeLine lineNumber="602"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//    DbgRecord xyzzy</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00603" /><CodeLine lineNumber="603"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//    %bar = call i32 @foobar()</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00604" /><CodeLine lineNumber="604"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// causing it to appear attached to the call too.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00605" /><CodeLine lineNumber="605"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00606" /><CodeLine lineNumber="606"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// To avoid this, cloneDebugInfoFrom takes an optional &quot;start cloning from</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00607" /><CodeLine lineNumber="607"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// here&quot; position to account for this behaviour. We point it at any</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00608" /><CodeLine lineNumber="608"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// DbgRecords on the next instruction, here labelled xyzzy, before we hoist</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00609" /><CodeLine lineNumber="609"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// %foo. Later, we only only clone DbgRecords from that position (xyzzy)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00610" /><CodeLine lineNumber="610"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// onwards, which avoids cloning DbgRecord &quot;blah&quot; multiple times. (Stored as</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00611" /><CodeLine lineNumber="611"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// a range because it gives us a natural way of testing whether</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00612" /><CodeLine lineNumber="612"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//  there were DbgRecords on the next instruction before we hoisted things).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00613" /><CodeLine lineNumber="613"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/iterator-range">iterator&#95;range&lt;DbgRecord::self&#95;iterator&gt;</a> NextDbgInsts =</Highlight></CodeLine>
<Link id="l00614" /><CodeLine lineNumber="614"><Highlight kind="normal">        (<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> != <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#abb2b3a60ccc38a28239e19a1646e0c8a">E</a>) ? <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getDbgRecordRange() : <a href="/docs/api/classes/llvm/dbgmarker/#a035be77460cd22dc24e1f25b30ad6377">DbgMarker::getEmptyDbgRecordRange</a>();</Highlight></CodeLine>
<Link id="l00615" /><CodeLine lineNumber="615"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00616" /><CodeLine lineNumber="616"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> != <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#abb2b3a60ccc38a28239e19a1646e0c8a">E</a>) &#123;</Highlight></CodeLine>
<Link id="l00617" /><CodeLine lineNumber="617"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Inst = &amp;&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>++;</Highlight></CodeLine>
<Link id="l00618" /><CodeLine lineNumber="618"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00619" /><CodeLine lineNumber="619"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// If the instruction&#39;s operands are invariant and it doesn&#39;t read or write</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00620" /><CodeLine lineNumber="620"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// memory, then it is safe to hoist.  Doing this doesn&#39;t change the order of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00621" /><CodeLine lineNumber="621"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// execution in the preheader, but does prevent the instruction from</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00622" /><CodeLine lineNumber="622"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// executing in each iteration of the loop.  This means it is safe to hoist</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00623" /><CodeLine lineNumber="623"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// something that might trap, but isn&#39;t safe to hoist something that reads</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00624" /><CodeLine lineNumber="624"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// memory (without proving that the loop doesn&#39;t write).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00625" /><CodeLine lineNumber="625"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;hasLoopInvariantOperands(Inst) &amp;&amp; !Inst-&gt;<a href="/docs/api/classes/llvm/instruction/#a9149819221d66953ac6c2938b87f0136">mayReadFromMemory</a>() &amp;&amp;</Highlight></CodeLine>
<Link id="l00626" /><CodeLine lineNumber="626"><Highlight kind="normal">          !Inst-&gt;<a href="/docs/api/classes/llvm/instruction/#a383175f96316074965ad115706bd49d7">mayWriteToMemory</a>() &amp;&amp; !Inst-&gt;<a href="/docs/api/classes/llvm/instruction/#a7653277511df1034148a37520a585bb5">isTerminator</a>() &amp;&amp;</Highlight></CodeLine>
<Link id="l00627" /><CodeLine lineNumber="627"><Highlight kind="normal">          !<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;DbgInfoIntrinsic&gt;</a>(Inst) &amp;&amp; !<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;AllocaInst&gt;</a>(Inst) &amp;&amp;</Highlight></CodeLine>
<Link id="l00628" /><CodeLine lineNumber="628"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// It is not safe to hoist the value of these instructions in</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00629" /><CodeLine lineNumber="629"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// coroutines, as the addresses of otherwise eligible variables (e.g.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00630" /><CodeLine lineNumber="630"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// thread-local variables and errno) may change if the coroutine is</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00631" /><CodeLine lineNumber="631"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// resumed in a different thread.Therefore, we disable this</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00632" /><CodeLine lineNumber="632"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// optimization for correctness. However, this may block other correct</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00633" /><CodeLine lineNumber="633"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// optimizations.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00634" /><CodeLine lineNumber="634"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// FIXME: This should be reverted once we have a better model for</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00635" /><CodeLine lineNumber="635"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// memory access in coroutines.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00636" /><CodeLine lineNumber="636"><Highlight kind="normal">          !Inst-&gt;<a href="/docs/api/classes/llvm/instruction/#a6a66ebb3aa12757479a3c88de77d78f8">getFunction</a>()-&gt;<a href="/docs/api/classes/llvm/function/#a9f6ec3f2263a0ed9418c0968cf7c265e">isPresplitCoroutine</a>()) &#123;</Highlight></CodeLine>
<Link id="l00637" /><CodeLine lineNumber="637"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00638" /><CodeLine lineNumber="638"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (LoopEntryBranch-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>()-&gt;IsNewDbgInfoFormat &amp;&amp;</Highlight></CodeLine>
<Link id="l00639" /><CodeLine lineNumber="639"><Highlight kind="normal">            !NextDbgInsts.<a href="/docs/api/classes/llvm/iterator-range/#a06fff5bdd2bdf6d2c200e281787dc284">empty</a>()) &#123;</Highlight></CodeLine>
<Link id="l00640" /><CodeLine lineNumber="640"><Highlight kind="normal">          </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> DbgValueRange =</Highlight></CodeLine>
<Link id="l00641" /><CodeLine lineNumber="641"><Highlight kind="normal">              LoopEntryBranch-&gt;<a href="/docs/api/classes/llvm/instruction/#a2c89a7c3adbeaf3cc5d02a41401801fb">cloneDebugInfoFrom</a>(Inst, NextDbgInsts.<a href="/docs/api/classes/llvm/iterator-range/#af5a020bd9dd7bc8487dd53ce443fdd8f">begin</a>());</Highlight></CodeLine>
<Link id="l00642" /><CodeLine lineNumber="642"><Highlight kind="normal">          <a href="/docs/api/namespaces/llvm/#a3c6de822ccc920e435932d6cb73ac146">RemapDbgRecordRange</a>(M, DbgValueRange, <a href="/docs/api/classes/llvm/valuemap">ValueMap</a>,</Highlight></CodeLine>
<Link id="l00643" /><CodeLine lineNumber="643"><Highlight kind="normal">                              <a href="/docs/api/namespaces/llvm/#a77724415203930efd07d7098cb1e437da9a24bd8dba1bef2753bc3f087435ae7f">RF&#95;NoModuleLevelChanges</a> | <a href="/docs/api/namespaces/llvm/#a77724415203930efd07d7098cb1e437da5633028bc27ffa8eab39cc5de65b3108">RF&#95;IgnoreMissingLocals</a>);</Highlight></CodeLine>
<Link id="l00644" /><CodeLine lineNumber="644"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// Erase anything we&#39;ve seen before.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00645" /><CodeLine lineNumber="645"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/dbgvariablerecord">DbgVariableRecord</a> &amp;DVR :</Highlight></CodeLine>
<Link id="l00646" /><CodeLine lineNumber="646"><Highlight kind="normal">               <a href="/docs/api/namespaces/llvm/#a3d2cdc4a0db233678e7141c9d6ea3419">make&#95;early&#95;inc&#95;range</a>(<a href="/docs/api/namespaces/llvm/#ae876eb96b89c1afcc3e9cd285cc3f08c">filterDbgVars</a>(DbgValueRange)))</Highlight></CodeLine>
<Link id="l00647" /><CodeLine lineNumber="647"><Highlight kind="normal">            </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DbgIntrinsics.<a href="/docs/api/classes/llvm/detail/densesetimpl/#afe504aa31a6a354cec13f5b32d0b1d9d">count</a>(makeHash(&amp;DVR)))</Highlight></CodeLine>
<Link id="l00648" /><CodeLine lineNumber="648"><Highlight kind="normal">              DVR.eraseFromParent();</Highlight></CodeLine>
<Link id="l00649" /><CodeLine lineNumber="649"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l00650" /><CodeLine lineNumber="650"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00651" /><CodeLine lineNumber="651"><Highlight kind="normal">        NextDbgInsts = <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getDbgRecordRange();</Highlight></CodeLine>
<Link id="l00652" /><CodeLine lineNumber="652"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00653" /><CodeLine lineNumber="653"><Highlight kind="normal">        Inst-&gt;<a href="/docs/api/classes/llvm/instruction/#af67d1f3a518964d80a109bb3d9d5cf1e">moveBefore</a>(LoopEntryBranch-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>());</Highlight></CodeLine>
<Link id="l00654" /><CodeLine lineNumber="654"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00655" /><CodeLine lineNumber="655"><Highlight kind="normal">        ++NumInstrsHoisted;</Highlight></CodeLine>
<Link id="l00656" /><CodeLine lineNumber="656"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00657" /><CodeLine lineNumber="657"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00658" /><CodeLine lineNumber="658"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00659" /><CodeLine lineNumber="659"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Otherwise, create a duplicate of the instruction.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00660" /><CodeLine lineNumber="660"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a> = Inst-&gt;<a href="/docs/api/classes/llvm/instruction/#a0a4d51e372293abe5e5f6dac133e80a6">clone</a>();</Highlight></CodeLine>
<Link id="l00661" /><CodeLine lineNumber="661"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>-&gt;insertBefore(LoopEntryBranch-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>());</Highlight></CodeLine>
<Link id="l00662" /><CodeLine lineNumber="662"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00663" /><CodeLine lineNumber="663"><Highlight kind="normal">      ++NumInstrsDuplicated;</Highlight></CodeLine>
<Link id="l00664" /><CodeLine lineNumber="664"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00665" /><CodeLine lineNumber="665"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (LoopEntryBranch-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>()-&gt;IsNewDbgInfoFormat &amp;&amp;</Highlight></CodeLine>
<Link id="l00666" /><CodeLine lineNumber="666"><Highlight kind="normal">          !NextDbgInsts.<a href="/docs/api/classes/llvm/iterator-range/#a06fff5bdd2bdf6d2c200e281787dc284">empty</a>()) &#123;</Highlight></CodeLine>
<Link id="l00667" /><CodeLine lineNumber="667"><Highlight kind="normal">        </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> <a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#a34bd74317e3f04bfc4318c2d1a470877">Range</a> = <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>-&gt;cloneDebugInfoFrom(Inst, NextDbgInsts.<a href="/docs/api/classes/llvm/iterator-range/#af5a020bd9dd7bc8487dd53ce443fdd8f">begin</a>());</Highlight></CodeLine>
<Link id="l00668" /><CodeLine lineNumber="668"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#a3c6de822ccc920e435932d6cb73ac146">RemapDbgRecordRange</a>(M, <a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#a34bd74317e3f04bfc4318c2d1a470877">Range</a>, <a href="/docs/api/classes/llvm/valuemap">ValueMap</a>,</Highlight></CodeLine>
<Link id="l00669" /><CodeLine lineNumber="669"><Highlight kind="normal">                            <a href="/docs/api/namespaces/llvm/#a77724415203930efd07d7098cb1e437da9a24bd8dba1bef2753bc3f087435ae7f">RF&#95;NoModuleLevelChanges</a> | <a href="/docs/api/namespaces/llvm/#a77724415203930efd07d7098cb1e437da5633028bc27ffa8eab39cc5de65b3108">RF&#95;IgnoreMissingLocals</a>);</Highlight></CodeLine>
<Link id="l00670" /><CodeLine lineNumber="670"><Highlight kind="normal">        NextDbgInsts = <a href="/docs/api/classes/llvm/dbgmarker/#a035be77460cd22dc24e1f25b30ad6377">DbgMarker::getEmptyDbgRecordRange</a>();</Highlight></CodeLine>
<Link id="l00671" /><CodeLine lineNumber="671"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Erase anything we&#39;ve seen before.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00672" /><CodeLine lineNumber="672"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/dbgvariablerecord">DbgVariableRecord</a> &amp;DVR :</Highlight></CodeLine>
<Link id="l00673" /><CodeLine lineNumber="673"><Highlight kind="normal">             <a href="/docs/api/namespaces/llvm/#a3d2cdc4a0db233678e7141c9d6ea3419">make&#95;early&#95;inc&#95;range</a>(<a href="/docs/api/namespaces/llvm/#ae876eb96b89c1afcc3e9cd285cc3f08c">filterDbgVars</a>(<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#a34bd74317e3f04bfc4318c2d1a470877">Range</a>)))</Highlight></CodeLine>
<Link id="l00674" /><CodeLine lineNumber="674"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DbgIntrinsics.<a href="/docs/api/classes/llvm/detail/densesetimpl/#afe504aa31a6a354cec13f5b32d0b1d9d">count</a>(makeHash(&amp;DVR)))</Highlight></CodeLine>
<Link id="l00675" /><CodeLine lineNumber="675"><Highlight kind="normal">            DVR.eraseFromParent();</Highlight></CodeLine>
<Link id="l00676" /><CodeLine lineNumber="676"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00677" /><CodeLine lineNumber="677"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00678" /><CodeLine lineNumber="678"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Eagerly remap the operands of the instruction.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00679" /><CodeLine lineNumber="679"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a7da684e1cead3524bdd9b0d171aad161">RemapInstruction</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, <a href="/docs/api/classes/llvm/valuemap">ValueMap</a>,</Highlight></CodeLine>
<Link id="l00680" /><CodeLine lineNumber="680"><Highlight kind="normal">                       <a href="/docs/api/namespaces/llvm/#a77724415203930efd07d7098cb1e437da9a24bd8dba1bef2753bc3f087435ae7f">RF&#95;NoModuleLevelChanges</a> | <a href="/docs/api/namespaces/llvm/#a77724415203930efd07d7098cb1e437da5633028bc27ffa8eab39cc5de65b3108">RF&#95;IgnoreMissingLocals</a>);</Highlight></CodeLine>
<Link id="l00681" /><CodeLine lineNumber="681"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00682" /><CodeLine lineNumber="682"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Avoid inserting the same intrinsic twice.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00683" /><CodeLine lineNumber="683"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;DII = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;DbgVariableIntrinsic&gt;</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>))</Highlight></CodeLine>
<Link id="l00684" /><CodeLine lineNumber="684"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DbgIntrinsics.<a href="/docs/api/classes/llvm/detail/densesetimpl/#afe504aa31a6a354cec13f5b32d0b1d9d">count</a>(makeHash(DII))) &#123;</Highlight></CodeLine>
<Link id="l00685" /><CodeLine lineNumber="685"><Highlight kind="normal">          <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>-&gt;eraseFromParent();</Highlight></CodeLine>
<Link id="l00686" /><CodeLine lineNumber="686"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00687" /><CodeLine lineNumber="687"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l00688" /><CodeLine lineNumber="688"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00689" /><CodeLine lineNumber="689"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// With the operands remapped, see if the instruction constant folds or is</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00690" /><CodeLine lineNumber="690"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// otherwise simplifyable.  This commonly occurs because the entry from PHI</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00691" /><CodeLine lineNumber="691"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// nodes allows icmps and other instructions to fold.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00692" /><CodeLine lineNumber="692"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;V = <a href="/docs/api/namespaces/llvm/#a57feb935aaafd1bd4bfbb8dc56ad2129">simplifyInstruction</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, SQ);</Highlight></CodeLine>
<Link id="l00693" /><CodeLine lineNumber="693"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (V &amp;&amp; LI-&gt;replacementPreservesLCSSAForm(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>, V)) &#123;</Highlight></CodeLine>
<Link id="l00694" /><CodeLine lineNumber="694"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// If so, then delete the temporary instruction and stick the folded value</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00695" /><CodeLine lineNumber="695"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// in the map.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00696" /><CodeLine lineNumber="696"><Highlight kind="normal">        <a href="#ad2e3518508b7df1cb9b6ab4dba6557f1">InsertNewValueIntoMap</a>(<a href="/docs/api/classes/llvm/valuemap">ValueMap</a>, Inst, V);</Highlight></CodeLine>
<Link id="l00697" /><CodeLine lineNumber="697"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>-&gt;mayHaveSideEffects()) &#123;</Highlight></CodeLine>
<Link id="l00698" /><CodeLine lineNumber="698"><Highlight kind="normal">          <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>-&gt;eraseFromParent();</Highlight></CodeLine>
<Link id="l00699" /><CodeLine lineNumber="699"><Highlight kind="normal">          <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a> = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00700" /><CodeLine lineNumber="700"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l00701" /><CodeLine lineNumber="701"><Highlight kind="normal">      &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00702" /><CodeLine lineNumber="702"><Highlight kind="normal">        <a href="#ad2e3518508b7df1cb9b6ab4dba6557f1">InsertNewValueIntoMap</a>(<a href="/docs/api/classes/llvm/valuemap">ValueMap</a>, Inst, <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>);</Highlight></CodeLine>
<Link id="l00703" /><CodeLine lineNumber="703"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00704" /><CodeLine lineNumber="704"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>) &#123;</Highlight></CodeLine>
<Link id="l00705" /><CodeLine lineNumber="705"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Otherwise, stick the new instruction into the new block!</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00706" /><CodeLine lineNumber="706"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>-&gt;setName(Inst-&gt;<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>());</Highlight></CodeLine>
<Link id="l00707" /><CodeLine lineNumber="707"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00708" /><CodeLine lineNumber="708"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;AssumeInst&gt;</a>(<a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>))</Highlight></CodeLine>
<Link id="l00709" /><CodeLine lineNumber="709"><Highlight kind="normal">          AC-&gt;registerAssumption(<a href="/docs/api/files/lib/lib/target/lib/target/nvptx/nvvmintrrange-cpp/#ac5804672fc0850438d63caec770647f8">II</a>);</Highlight></CodeLine>
<Link id="l00710" /><CodeLine lineNumber="710"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// MemorySSA cares whether the cloned instruction was inserted or not, and</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00711" /><CodeLine lineNumber="711"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// not whether it can be remapped to a simplified value.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00712" /><CodeLine lineNumber="712"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU)</Highlight></CodeLine>
<Link id="l00713" /><CodeLine lineNumber="713"><Highlight kind="normal">          <a href="#ad2e3518508b7df1cb9b6ab4dba6557f1">InsertNewValueIntoMap</a>(ValueMapMSSA, Inst, <a href="/docs/api/namespaces/llvm/callingconv/#ac6aa1387c4375260e2468eb5a77fdb4cafd841a49aec1539bc88abc8ff9e170fb">C</a>);</Highlight></CodeLine>
<Link id="l00714" /><CodeLine lineNumber="714"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00715" /><CodeLine lineNumber="715"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00716" /><CodeLine lineNumber="716"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00717" /><CodeLine lineNumber="717"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!NoAliasDeclInstructions.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>()) &#123;</Highlight></CodeLine>
<Link id="l00718" /><CodeLine lineNumber="718"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// There are noalias scope declarations:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00719" /><CodeLine lineNumber="719"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// (general):</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00720" /><CodeLine lineNumber="720"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Original:    OrigPre              &#123; OrigHeader NewHeader ... Latch &#125;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00721" /><CodeLine lineNumber="721"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// after:      (OrigPre+OrigHeader&#39;) &#123; NewHeader ... Latch OrigHeader &#125;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00722" /><CodeLine lineNumber="722"><Highlight kind="normal">      </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00723" /><CodeLine lineNumber="723"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// with D: llvm.experimental.noalias.scope.decl,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00724" /><CodeLine lineNumber="724"><Highlight kind="normal">      </Highlight><Highlight kind="comment">//      U: !noalias or !alias.scope depending on D</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00725" /><CodeLine lineNumber="725"><Highlight kind="normal">      </Highlight><Highlight kind="comment">//       ... &#123; D U1 U2 &#125;   can transform into:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00726" /><CodeLine lineNumber="726"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// (0) : ... &#123; D U1 U2 &#125;        // no relevant rotation for this part</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00727" /><CodeLine lineNumber="727"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// (1) : ... D&#39; &#123; U1 U2 D &#125;     // D is part of OrigHeader</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00728" /><CodeLine lineNumber="728"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// (2) : ... D&#39; U1&#39; &#123; U2 D U1 &#125; // D, U1 are part of OrigHeader</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00729" /><CodeLine lineNumber="729"><Highlight kind="normal">      </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00730" /><CodeLine lineNumber="730"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We now want to transform:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00731" /><CodeLine lineNumber="731"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// (1) -&gt; : ... D&#39; &#123; D U1 U2 D&#39;&#39; &#125;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00732" /><CodeLine lineNumber="732"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// (2) -&gt; : ... D&#39; U1&#39; &#123; D U2 D&#39;&#39; U1&#39;&#39; &#125;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00733" /><CodeLine lineNumber="733"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// D: original llvm.experimental.noalias.scope.decl</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00734" /><CodeLine lineNumber="734"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// D&#39;, U1&#39;: duplicate with replaced scopes</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00735" /><CodeLine lineNumber="735"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// D&#39;&#39;, U1&#39;&#39;: different duplicate with replaced scopes</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00736" /><CodeLine lineNumber="736"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// This ensures a safe fallback to &#39;may&#95;alias&#39; introduced by the rotate,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00737" /><CodeLine lineNumber="737"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// as U1&#39;&#39; and U1&#39; scopes will not be compatible wrt to the local restrict</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00738" /><CodeLine lineNumber="738"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00739" /><CodeLine lineNumber="739"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Clone the llvm.experimental.noalias.decl again for the NewHeader.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00740" /><CodeLine lineNumber="740"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> NewHeaderInsertionPoint =</Highlight></CodeLine>
<Link id="l00741" /><CodeLine lineNumber="741"><Highlight kind="normal">          NewHeader-&gt;<a href="/docs/api/classes/llvm/basicblock/#a362b5e6097732cbc0d2fb555a1f73400">getFirstNonPHIIt</a>();</Highlight></CodeLine>
<Link id="l00742" /><CodeLine lineNumber="742"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/noaliasscopedeclinst">NoAliasScopeDeclInst</a> &#42;NAD : NoAliasDeclInstructions) &#123;</Highlight></CodeLine>
<Link id="l00743" /><CodeLine lineNumber="743"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Cloning llvm.experimental.noalias.scope.decl:&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00744" /><CodeLine lineNumber="744"><Highlight kind="normal">                          &lt;&lt; &#42;NAD &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00745" /><CodeLine lineNumber="745"><Highlight kind="normal">        <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;NewNAD = NAD-&gt;<a href="/docs/api/classes/llvm/instruction/#a0a4d51e372293abe5e5f6dac133e80a6">clone</a>();</Highlight></CodeLine>
<Link id="l00746" /><CodeLine lineNumber="746"><Highlight kind="normal">        NewNAD-&gt;<a href="/docs/api/classes/llvm/instruction/#a482498a1c760122fd33c7fc8190dd277">insertBefore</a>(&#42;NewHeader, NewHeaderInsertionPoint);</Highlight></CodeLine>
<Link id="l00747" /><CodeLine lineNumber="747"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00748" /><CodeLine lineNumber="748"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00749" /><CodeLine lineNumber="749"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Scopes must now be duplicated, once for OrigHeader and once for</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00750" /><CodeLine lineNumber="750"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// OrigPreHeader&#39;.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00751" /><CodeLine lineNumber="751"><Highlight kind="normal">      &#123;</Highlight></CodeLine>
<Link id="l00752" /><CodeLine lineNumber="752"><Highlight kind="normal">        </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;Context = NewHeader-&gt;<a href="/docs/api/classes/llvm/basicblock/#aa286a0f7f5d38488d593bb7ef0ba183e">getContext</a>();</Highlight></CodeLine>
<Link id="l00753" /><CodeLine lineNumber="753"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00754" /><CodeLine lineNumber="754"><Highlight kind="normal">        <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MDNode &#42;, 8&gt;</a> NoAliasDeclScopes;</Highlight></CodeLine>
<Link id="l00755" /><CodeLine lineNumber="755"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/noaliasscopedeclinst">NoAliasScopeDeclInst</a> &#42;NAD : NoAliasDeclInstructions)</Highlight></CodeLine>
<Link id="l00756" /><CodeLine lineNumber="756"><Highlight kind="normal">          NoAliasDeclScopes.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(NAD-&gt;getScopeList());</Highlight></CodeLine>
<Link id="l00757" /><CodeLine lineNumber="757"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00758" /><CodeLine lineNumber="758"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Updating OrigHeader scopes\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00759" /><CodeLine lineNumber="759"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#ab7abd0e34c17dcb201a4138dc65cc067">cloneAndAdaptNoAliasScopes</a>(NoAliasDeclScopes, &#123;OrigHeader&#125;, Context,</Highlight></CodeLine>
<Link id="l00760" /><CodeLine lineNumber="760"><Highlight kind="normal">                                   </Highlight><Highlight kind="stringliteral">&quot;h.rot&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00761" /><CodeLine lineNumber="761"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(OrigHeader-&gt;dump());</Highlight></CodeLine>
<Link id="l00762" /><CodeLine lineNumber="762"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00763" /><CodeLine lineNumber="763"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Keep the compile time impact low by only adapting the inserted block</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00764" /><CodeLine lineNumber="764"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// of instructions in the OrigPreHeader. This might result in slightly</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00765" /><CodeLine lineNumber="765"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// more aliasing between these instructions and those that were already</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00766" /><CodeLine lineNumber="766"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// present, but it will be much faster when the original PreHeader is</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00767" /><CodeLine lineNumber="767"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// large.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00768" /><CodeLine lineNumber="768"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Updating part of OrigPreheader scopes\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00769" /><CodeLine lineNumber="769"><Highlight kind="normal">        </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;FirstDecl =</Highlight></CodeLine>
<Link id="l00770" /><CodeLine lineNumber="770"><Highlight kind="normal">            <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Instruction&gt;</a>(<a href="/docs/api/classes/llvm/valuemap">ValueMap</a>&#91;&#42;NoAliasDeclInstructions.begin()&#93;);</Highlight></CodeLine>
<Link id="l00771" /><CodeLine lineNumber="771"><Highlight kind="normal">        </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;LastInst = &amp;OrigPreheader-&gt;<a href="/docs/api/classes/llvm/basicblock/#a2d071e661a02790177ba05f62c7c27d1">back</a>();</Highlight></CodeLine>
<Link id="l00772" /><CodeLine lineNumber="772"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#ab7abd0e34c17dcb201a4138dc65cc067">cloneAndAdaptNoAliasScopes</a>(NoAliasDeclScopes, FirstDecl, LastInst,</Highlight></CodeLine>
<Link id="l00773" /><CodeLine lineNumber="773"><Highlight kind="normal">                                   Context, </Highlight><Highlight kind="stringliteral">&quot;pre.rot&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00774" /><CodeLine lineNumber="774"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(OrigPreheader-&gt;<a href="/docs/api/classes/llvm/value/#af7dca9a9e816ef69fd9e9467f64f72b4">dump</a>());</Highlight></CodeLine>
<Link id="l00775" /><CodeLine lineNumber="775"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00776" /><CodeLine lineNumber="776"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;  Updated NewHeader:\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00777" /><CodeLine lineNumber="777"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(NewHeader-&gt;<a href="/docs/api/classes/llvm/value/#af7dca9a9e816ef69fd9e9467f64f72b4">dump</a>());</Highlight></CodeLine>
<Link id="l00778" /><CodeLine lineNumber="778"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00779" /><CodeLine lineNumber="779"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00780" /><CodeLine lineNumber="780"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00781" /><CodeLine lineNumber="781"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Along with all the other instructions, we just cloned OrigHeader&#39;s</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00782" /><CodeLine lineNumber="782"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// terminator into OrigPreHeader. Fix up the PHI nodes in each of OrigHeader&#39;s</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00783" /><CodeLine lineNumber="783"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// successors by duplicating their incoming values for OrigHeader.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00784" /><CodeLine lineNumber="784"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;SuccBB : <a href="/docs/api/namespaces/llvm/#a26e2a938b431eaa6eca2beaa96410c9d">successors</a>(OrigHeader))</Highlight></CodeLine>
<Link id="l00785" /><CodeLine lineNumber="785"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> BI = SuccBB-&gt;begin();</Highlight></CodeLine>
<Link id="l00786" /><CodeLine lineNumber="786"><Highlight kind="normal">           <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;PN = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;PHINode&gt;</a>(BI); ++BI)</Highlight></CodeLine>
<Link id="l00787" /><CodeLine lineNumber="787"><Highlight kind="normal">        PN-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(PN-&gt;<a href="/docs/api/classes/llvm/phinode/#ab2db7609ec72b1af2f91d47e40dc3722">getIncomingValueForBlock</a>(OrigHeader), OrigPreheader);</Highlight></CodeLine>
<Link id="l00788" /><CodeLine lineNumber="788"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00789" /><CodeLine lineNumber="789"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Now that OrigPreHeader has a clone of OrigHeader&#39;s terminator, remove</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00790" /><CodeLine lineNumber="790"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// OrigPreHeader&#39;s old terminator (the original branch into the loop), and</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00791" /><CodeLine lineNumber="791"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// remove the corresponding incoming values from the PHI nodes in OrigHeader.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00792" /><CodeLine lineNumber="792"><Highlight kind="normal">    LoopEntryBranch-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</Highlight></CodeLine>
<Link id="l00793" /><CodeLine lineNumber="793"><Highlight kind="normal">    OrigPreheader-&gt;<a href="/docs/api/classes/llvm/basicblock/#a7a7dc3732891611f559b06951a6ee85a">flushTerminatorDbgRecords</a>();</Highlight></CodeLine>
<Link id="l00794" /><CodeLine lineNumber="794"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00795" /><CodeLine lineNumber="795"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Update MemorySSA before the rewrite call below changes the 1:1</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00796" /><CodeLine lineNumber="796"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// instruction:cloned&#95;instruction&#95;or&#95;value mapping.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00797" /><CodeLine lineNumber="797"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU) &#123;</Highlight></CodeLine>
<Link id="l00798" /><CodeLine lineNumber="798"><Highlight kind="normal">      <a href="#ad2e3518508b7df1cb9b6ab4dba6557f1">InsertNewValueIntoMap</a>(ValueMapMSSA, OrigHeader, OrigPreheader);</Highlight></CodeLine>
<Link id="l00799" /><CodeLine lineNumber="799"><Highlight kind="normal">      MSSAU-&gt;updateForClonedBlockIntoPred(OrigHeader, OrigPreheader,</Highlight></CodeLine>
<Link id="l00800" /><CodeLine lineNumber="800"><Highlight kind="normal">                                          ValueMapMSSA);</Highlight></CodeLine>
<Link id="l00801" /><CodeLine lineNumber="801"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00802" /><CodeLine lineNumber="802"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00803" /><CodeLine lineNumber="803"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;PHINode&#42;, 2&gt;</a> InsertedPHIs;</Highlight></CodeLine>
<Link id="l00804" /><CodeLine lineNumber="804"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If there were any uses of instructions in the duplicated block outside the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00805" /><CodeLine lineNumber="805"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// loop, update them, inserting PHI nodes as required</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00806" /><CodeLine lineNumber="806"><Highlight kind="normal">    <a href="#aea660fd3de70e7854de06b7e212f0ecd">RewriteUsesOfClonedInstructions</a>(OrigHeader, OrigPreheader, <a href="/docs/api/classes/llvm/valuemap">ValueMap</a>, SE,</Highlight></CodeLine>
<Link id="l00807" /><CodeLine lineNumber="807"><Highlight kind="normal">                                    &amp;InsertedPHIs);</Highlight></CodeLine>
<Link id="l00808" /><CodeLine lineNumber="808"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00809" /><CodeLine lineNumber="809"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Attach dbg.value intrinsics to the new phis if that phi uses a value that</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00810" /><CodeLine lineNumber="810"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// previously had debug metadata attached. This keeps the debug info</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00811" /><CodeLine lineNumber="811"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// up-to-date in the loop body.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00812" /><CodeLine lineNumber="812"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!InsertedPHIs.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>())</Highlight></CodeLine>
<Link id="l00813" /><CodeLine lineNumber="813"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a4dfea19770364b880a77c3f0c1c0f67c">insertDebugValuesForPHIs</a>(OrigHeader, InsertedPHIs);</Highlight></CodeLine>
<Link id="l00814" /><CodeLine lineNumber="814"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00815" /><CodeLine lineNumber="815"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// NewHeader is now the header of the loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00816" /><CodeLine lineNumber="816"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;moveToHeader(NewHeader);</Highlight></CodeLine>
<Link id="l00817" /><CodeLine lineNumber="817"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;getHeader() == NewHeader &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Latch block is our new header&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00818" /><CodeLine lineNumber="818"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00819" /><CodeLine lineNumber="819"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Inform DT about changes to the CFG.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00820" /><CodeLine lineNumber="820"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DT) &#123;</Highlight></CodeLine>
<Link id="l00821" /><CodeLine lineNumber="821"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// The OrigPreheader branches to the NewHeader and Exit now. Then, inform</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00822" /><CodeLine lineNumber="822"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// the DT about the removed edge to the OrigHeader (that got removed).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00823" /><CodeLine lineNumber="823"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;DominatorTree::UpdateType, 3&gt;</a> Updates;</Highlight></CodeLine>
<Link id="l00824" /><CodeLine lineNumber="824"><Highlight kind="normal">      Updates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;<a href="/docs/api/classes/llvm/dominatortreebase/#a9aeeca2833810f01b20545a46fe22503">DominatorTree::Insert</a>, OrigPreheader, <a href="/docs/api/namespaces/llvm/coff/#ae7629a0652411dc2be61aea4fee2b39cacd4cef2a5a26efd5d75ecca95bc6ff24">Exit</a>&#125;);</Highlight></CodeLine>
<Link id="l00825" /><CodeLine lineNumber="825"><Highlight kind="normal">      Updates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;<a href="/docs/api/classes/llvm/dominatortreebase/#a9aeeca2833810f01b20545a46fe22503">DominatorTree::Insert</a>, OrigPreheader, NewHeader&#125;);</Highlight></CodeLine>
<Link id="l00826" /><CodeLine lineNumber="826"><Highlight kind="normal">      Updates.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(&#123;<a href="/docs/api/classes/llvm/dominatortreebase/#a71c91cbbfc1c0ecf9a69e10ccf739bd7">DominatorTree::Delete</a>, OrigPreheader, OrigHeader&#125;);</Highlight></CodeLine>
<Link id="l00827" /><CodeLine lineNumber="827"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00828" /><CodeLine lineNumber="828"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU) &#123;</Highlight></CodeLine>
<Link id="l00829" /><CodeLine lineNumber="829"><Highlight kind="normal">        MSSAU-&gt;applyUpdates(Updates, &#42;DT, </Highlight><Highlight kind="comment">/&#42;UpdateDT=&#42;/</Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00830" /><CodeLine lineNumber="830"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l00831" /><CodeLine lineNumber="831"><Highlight kind="normal">          MSSAU-&gt;getMemorySSA()-&gt;verifyMemorySSA();</Highlight></CodeLine>
<Link id="l00832" /><CodeLine lineNumber="832"><Highlight kind="normal">      &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00833" /><CodeLine lineNumber="833"><Highlight kind="normal">        DT-&gt;applyUpdates(Updates);</Highlight></CodeLine>
<Link id="l00834" /><CodeLine lineNumber="834"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00835" /><CodeLine lineNumber="835"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00836" /><CodeLine lineNumber="836"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00837" /><CodeLine lineNumber="837"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// At this point, we&#39;ve finished our major CFG changes.  As part of cloning</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00838" /><CodeLine lineNumber="838"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// the loop into the preheader we&#39;ve simplified instructions and the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00839" /><CodeLine lineNumber="839"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// duplicated conditional branch may now be branching on a constant.  If it is</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00840" /><CodeLine lineNumber="840"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// branching on a constant and if that constant means that we enter the loop,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00841" /><CodeLine lineNumber="841"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// then we fold away the cond branch to an uncond branch.  This simplifies the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00842" /><CodeLine lineNumber="842"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// loop in cases important for nested loops, and it also means we don&#39;t have</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00843" /><CodeLine lineNumber="843"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// to split as many edges.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00844" /><CodeLine lineNumber="844"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;PHBI = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BranchInst&gt;</a>(OrigPreheader-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l00845" /><CodeLine lineNumber="845"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(PHBI-&gt;<a href="/docs/api/classes/llvm/branchinst/#a7e4be8b16fbd68c9045a388904044e01">isConditional</a>() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Should be clone of BI condbr!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00846" /><CodeLine lineNumber="846"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a> = PHBI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aebd4af5642453ce3169094f08dd3d7b8">getCondition</a>();</Highlight></CodeLine>
<Link id="l00847" /><CodeLine lineNumber="847"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> HasConditionalPreHeader =</Highlight></CodeLine>
<Link id="l00848" /><CodeLine lineNumber="848"><Highlight kind="normal">        !<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;ConstantInt&gt;</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>) ||</Highlight></CodeLine>
<Link id="l00849" /><CodeLine lineNumber="849"><Highlight kind="normal">        PHBI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;ConstantInt&gt;</a>(<a href="/docs/api/files/lib/lib/target/lib/target/riscv/riscvredundantcopyelimination-cpp/#a193847098793cdbab306803186676899">Cond</a>)-&gt;<a href="/docs/api/files/lib/lib/analysis/lint-cpp/#a45005634b54e2126cb3e6ec0dbc9ade4">isZero</a>()) != NewHeader;</Highlight></CodeLine>
<Link id="l00850" /><CodeLine lineNumber="850"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00851" /><CodeLine lineNumber="851"><Highlight kind="normal">    <a href="#ace004655a04ad52b7fc02fb8e3cf7b0f">updateBranchWeights</a>(&#42;PHBI, &#42;BI, HasConditionalPreHeader, BISuccsSwapped);</Highlight></CodeLine>
<Link id="l00852" /><CodeLine lineNumber="852"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00853" /><CodeLine lineNumber="853"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (HasConditionalPreHeader) &#123;</Highlight></CodeLine>
<Link id="l00854" /><CodeLine lineNumber="854"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// The conditional branch can&#39;t be folded, handle the general case.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00855" /><CodeLine lineNumber="855"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Split edges as necessary to preserve LoopSimplify form.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00856" /><CodeLine lineNumber="856"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00857" /><CodeLine lineNumber="857"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Right now OrigPreHeader has two successors, NewHeader and ExitBlock, and</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00858" /><CodeLine lineNumber="858"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// thus is not a preheader anymore.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00859" /><CodeLine lineNumber="859"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Split the edge to form a real preheader.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00860" /><CodeLine lineNumber="860"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewPH = <a href="/docs/api/namespaces/llvm/#ab61955a622d233750894890e0704da5c">SplitCriticalEdge</a>(</Highlight></CodeLine>
<Link id="l00861" /><CodeLine lineNumber="861"><Highlight kind="normal">                                            OrigPreheader, NewHeader,</Highlight></CodeLine>
<Link id="l00862" /><CodeLine lineNumber="862"><Highlight kind="normal">                                            <a href="/docs/api/structs/llvm/criticaledgesplittingoptions">CriticalEdgeSplittingOptions</a>(DT, LI, MSSAU).setPreserveLCSSA());</Highlight></CodeLine>
<Link id="l00863" /><CodeLine lineNumber="863"><Highlight kind="normal">      NewPH-&gt;<a href="/docs/api/classes/llvm/value/#a35ee267850af7c235474a8c46c7ac5af">setName</a>(NewHeader-&gt;<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>() + </Highlight><Highlight kind="stringliteral">&quot;.lr.ph&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00864" /><CodeLine lineNumber="864"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00865" /><CodeLine lineNumber="865"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Preserve canonical loop form, which means that &#39;Exit&#39; should have only</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00866" /><CodeLine lineNumber="866"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// one predecessor. Note that Exit could be an exit block for multiple</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00867" /><CodeLine lineNumber="867"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// nested loops, causing both of the edges to now be critical and need to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00868" /><CodeLine lineNumber="868"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// be split.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00869" /><CodeLine lineNumber="869"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 4&gt;</a> ExitPreds(<a href="/docs/api/namespaces/llvm/#acb22fb04083152eee862457e42e8dc31">predecessors</a>(Exit));</Highlight></CodeLine>
<Link id="l00870" /><CodeLine lineNumber="870"><Highlight kind="normal">      </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> SplitLatchEdge = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00871" /><CodeLine lineNumber="871"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ExitPred : ExitPreds) &#123;</Highlight></CodeLine>
<Link id="l00872" /><CodeLine lineNumber="872"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// We only need to split loop exit edges.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00873" /><CodeLine lineNumber="873"><Highlight kind="normal">        <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;PredLoop = LI-&gt;getLoopFor(ExitPred);</Highlight></CodeLine>
<Link id="l00874" /><CodeLine lineNumber="874"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!PredLoop || PredLoop-&gt;<a href="/docs/api/classes/llvm/loopbase/#a04337b572d34ea413c35dbac5d75530b">contains</a>(Exit) ||</Highlight></CodeLine>
<Link id="l00875" /><CodeLine lineNumber="875"><Highlight kind="normal">            <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;IndirectBrInst&gt;</a>(ExitPred-&gt;getTerminator()))</Highlight></CodeLine>
<Link id="l00876" /><CodeLine lineNumber="876"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00877" /><CodeLine lineNumber="877"><Highlight kind="normal">        SplitLatchEdge |= <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;getLoopLatch() == ExitPred;</Highlight></CodeLine>
<Link id="l00878" /><CodeLine lineNumber="878"><Highlight kind="normal">        <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ExitSplit = <a href="/docs/api/namespaces/llvm/#ab61955a622d233750894890e0704da5c">SplitCriticalEdge</a>(</Highlight></CodeLine>
<Link id="l00879" /><CodeLine lineNumber="879"><Highlight kind="normal">                                                  ExitPred, Exit,</Highlight></CodeLine>
<Link id="l00880" /><CodeLine lineNumber="880"><Highlight kind="normal">                                                  <a href="/docs/api/structs/llvm/criticaledgesplittingoptions">CriticalEdgeSplittingOptions</a>(DT, LI, MSSAU).setPreserveLCSSA());</Highlight></CodeLine>
<Link id="l00881" /><CodeLine lineNumber="881"><Highlight kind="normal">        ExitSplit-&gt;<a href="/docs/api/classes/llvm/basicblock/#ac1fd6437bbfce263b87f01767d950ce5">moveBefore</a>(Exit);</Highlight></CodeLine>
<Link id="l00882" /><CodeLine lineNumber="882"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00883" /><CodeLine lineNumber="883"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(SplitLatchEdge &amp;&amp;</Highlight></CodeLine>
<Link id="l00884" /><CodeLine lineNumber="884"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;Despite splitting all preds, failed to split latch exit?&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00885" /><CodeLine lineNumber="885"><Highlight kind="normal">      (void)SplitLatchEdge;</Highlight></CodeLine>
<Link id="l00886" /><CodeLine lineNumber="886"><Highlight kind="normal">    &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00887" /><CodeLine lineNumber="887"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We can fold the conditional branch in the preheader, this makes things</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00888" /><CodeLine lineNumber="888"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// simpler. The first step is to remove the extra edge to the Exit block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00889" /><CodeLine lineNumber="889"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/coff/#ae7629a0652411dc2be61aea4fee2b39cacd4cef2a5a26efd5d75ecca95bc6ff24">Exit</a>-&gt;removePredecessor(OrigPreheader, </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="comment">/&#42;preserve LCSSA&#42;/</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00890" /><CodeLine lineNumber="890"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;NewBI = <a href="/docs/api/classes/llvm/branchinst/#a9f40e42226cee617c16cb1c447b115c5">BranchInst::Create</a>(NewHeader, PHBI-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>());</Highlight></CodeLine>
<Link id="l00891" /><CodeLine lineNumber="891"><Highlight kind="normal">      NewBI-&gt;<a href="/docs/api/classes/llvm/instruction/#ae8f5bf5cc06f696b52c709677df00fbf">setDebugLoc</a>(PHBI-&gt;<a href="/docs/api/classes/llvm/instruction/#a4b8faae4ff9e7434a1d226d03d15dcd2">getDebugLoc</a>());</Highlight></CodeLine>
<Link id="l00892" /><CodeLine lineNumber="892"><Highlight kind="normal">      PHBI-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</Highlight></CodeLine>
<Link id="l00893" /><CodeLine lineNumber="893"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00894" /><CodeLine lineNumber="894"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// With our CFG finalized, update DomTree if it is available.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00895" /><CodeLine lineNumber="895"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DT) DT-&gt;deleteEdge(OrigPreheader, Exit);</Highlight></CodeLine>
<Link id="l00896" /><CodeLine lineNumber="896"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00897" /><CodeLine lineNumber="897"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Update MSSA too, if available.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00898" /><CodeLine lineNumber="898"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU)</Highlight></CodeLine>
<Link id="l00899" /><CodeLine lineNumber="899"><Highlight kind="normal">        MSSAU-&gt;removeEdge(OrigPreheader, Exit);</Highlight></CodeLine>
<Link id="l00900" /><CodeLine lineNumber="900"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00901" /><CodeLine lineNumber="901"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00902" /><CodeLine lineNumber="902"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;getLoopPreheader() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Invalid loop preheader after loop rotation&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00903" /><CodeLine lineNumber="903"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;getLoopLatch() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Invalid loop latch after loop rotation&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00904" /><CodeLine lineNumber="904"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00905" /><CodeLine lineNumber="905"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU &amp;&amp; <a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l00906" /><CodeLine lineNumber="906"><Highlight kind="normal">      MSSAU-&gt;getMemorySSA()-&gt;verifyMemorySSA();</Highlight></CodeLine>
<Link id="l00907" /><CodeLine lineNumber="907"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00908" /><CodeLine lineNumber="908"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Now that the CFG and DomTree are in a consistent state again, try to merge</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00909" /><CodeLine lineNumber="909"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// the OrigHeader block into OrigLatch.  This will succeed if they are</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00910" /><CodeLine lineNumber="910"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// connected by an unconditional branch.  This is just a cleanup so the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00911" /><CodeLine lineNumber="911"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// emitted code isn&#39;t too gross in this common case.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00912" /><CodeLine lineNumber="912"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/domtreeupdater">DomTreeUpdater</a> DTU(DT, DomTreeUpdater::UpdateStrategy::Eager);</Highlight></CodeLine>
<Link id="l00913" /><CodeLine lineNumber="913"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;PredBB = OrigHeader-&gt;<a href="/docs/api/classes/llvm/basicblock/#a74aa9daea070e2ad3394a3ec58b7316a">getUniquePredecessor</a>();</Highlight></CodeLine>
<Link id="l00914" /><CodeLine lineNumber="914"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> DidMerge = <a href="/docs/api/namespaces/llvm/#aa76a2cf19b821f320ab439d5659ef4b9">MergeBlockIntoPredecessor</a>(OrigHeader, &amp;DTU, LI, MSSAU);</Highlight></CodeLine>
<Link id="l00915" /><CodeLine lineNumber="915"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DidMerge)</Highlight></CodeLine>
<Link id="l00916" /><CodeLine lineNumber="916"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a08f3f942afc0ee9115a8f9fa87e9191d">RemoveRedundantDbgInstrs</a>(PredBB);</Highlight></CodeLine>
<Link id="l00917" /><CodeLine lineNumber="917"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00918" /><CodeLine lineNumber="918"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU &amp;&amp; <a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l00919" /><CodeLine lineNumber="919"><Highlight kind="normal">      MSSAU-&gt;getMemorySSA()-&gt;verifyMemorySSA();</Highlight></CodeLine>
<Link id="l00920" /><CodeLine lineNumber="920"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00921" /><CodeLine lineNumber="921"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;LoopRotation: into &quot;</Highlight><Highlight kind="normal">; <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;dump());</Highlight></CodeLine>
<Link id="l00922" /><CodeLine lineNumber="922"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00923" /><CodeLine lineNumber="923"><Highlight kind="normal">    ++NumRotated;</Highlight></CodeLine>
<Link id="l00924" /><CodeLine lineNumber="924"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00925" /><CodeLine lineNumber="925"><Highlight kind="normal">    Rotated = </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00926" /><CodeLine lineNumber="926"><Highlight kind="normal">    SimplifiedLatch = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00927" /><CodeLine lineNumber="927"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00928" /><CodeLine lineNumber="928"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Check that new latch is a deoptimizing exit and then repeat rotation if possible.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00929" /><CodeLine lineNumber="929"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Deoptimizing latch exit is not a generally typical case, so we just loop over.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00930" /><CodeLine lineNumber="930"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// TODO: if it becomes a performance bottleneck extend rotation algorithm</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00931" /><CodeLine lineNumber="931"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// to handle multiple rotations in one go.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00932" /><CodeLine lineNumber="932"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (<a href="#a4c85d9b35e543ff80a5f5cedc4982362">MultiRotate</a> &amp;&amp; <a href="#a20d58a0069048b80461676a4132ad1d4">canRotateDeoptimizingLatchExit</a>(L));</Highlight></CodeLine>
<Link id="l00933" /><CodeLine lineNumber="933"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00934" /><CodeLine lineNumber="934"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00935" /><CodeLine lineNumber="935"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00936" /><CodeLine lineNumber="936"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00937" /><CodeLine lineNumber="937"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00938" /><CodeLine lineNumber="938"><Highlight kind="comment">/// Determine whether the instructions in this range may be safely and cheaply</Highlight></CodeLine>
<Link id="l00939" /><CodeLine lineNumber="939"><Highlight kind="comment">/// speculated. This is not an important enough situation to develop complex</Highlight></CodeLine>
<Link id="l00940" /><CodeLine lineNumber="940"><Highlight kind="comment">/// heuristics. We handle a single arithmetic instruction along with any type</Highlight></CodeLine>
<Link id="l00941" /><CodeLine lineNumber="941"><Highlight kind="comment">/// conversions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00942" /><CodeLine lineNumber="942" lineLink="#a41713fe2635c183d98e1a6b7c1cedff5"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a41713fe2635c183d98e1a6b7c1cedff5">shouldSpeculateInstrs</a>(<a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> Begin,</Highlight></CodeLine>
<Link id="l00943" /><CodeLine lineNumber="943"><Highlight kind="normal">                                  <a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> End, <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L) &#123;</Highlight></CodeLine>
<Link id="l00944" /><CodeLine lineNumber="944"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> seenIncrement = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00945" /><CodeLine lineNumber="945"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> MultiExitLoop = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00946" /><CodeLine lineNumber="946"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00947" /><CodeLine lineNumber="947"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!L-&gt;getExitingBlock())</Highlight></CodeLine>
<Link id="l00948" /><CodeLine lineNumber="948"><Highlight kind="normal">    MultiExitLoop = </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00949" /><CodeLine lineNumber="949"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00950" /><CodeLine lineNumber="950"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = Begin; <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> != End; ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &#123;</Highlight></CodeLine>
<Link id="l00951" /><CodeLine lineNumber="951"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00952" /><CodeLine lineNumber="952"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/namespaces/llvm/#a8601ff0320b6e29a13a2194200853425">isSafeToSpeculativelyExecute</a>(&amp;&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</Highlight></CodeLine>
<Link id="l00953" /><CodeLine lineNumber="953"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00954" /><CodeLine lineNumber="954"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00955" /><CodeLine lineNumber="955"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;DbgInfoIntrinsic&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</Highlight></CodeLine>
<Link id="l00956" /><CodeLine lineNumber="956"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00957" /><CodeLine lineNumber="957"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00958" /><CodeLine lineNumber="958"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">switch</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOpcode()) &#123;</Highlight></CodeLine>
<Link id="l00959" /><CodeLine lineNumber="959"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">default</Highlight><Highlight kind="normal">:</Highlight></CodeLine>
<Link id="l00960" /><CodeLine lineNumber="960"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00961" /><CodeLine lineNumber="961"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> Instruction::GetElementPtr:</Highlight></CodeLine>
<Link id="l00962" /><CodeLine lineNumber="962"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// GEPs are cheap if all indices are constant.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00963" /><CodeLine lineNumber="963"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;GEPOperator&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)-&gt;hasAllConstantIndices())</Highlight></CodeLine>
<Link id="l00964" /><CodeLine lineNumber="964"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00965" /><CodeLine lineNumber="965"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// fall-thru to increment case</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00966" /><CodeLine lineNumber="966"><Highlight kind="normal">      &#91;&#91;fallthrough&#93;&#93;;</Highlight></CodeLine>
<Link id="l00967" /><CodeLine lineNumber="967"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> Instruction::Add:</Highlight></CodeLine>
<Link id="l00968" /><CodeLine lineNumber="968"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> Instruction::Sub:</Highlight></CodeLine>
<Link id="l00969" /><CodeLine lineNumber="969"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> Instruction::And:</Highlight></CodeLine>
<Link id="l00970" /><CodeLine lineNumber="970"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> Instruction::Or:</Highlight></CodeLine>
<Link id="l00971" /><CodeLine lineNumber="971"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> Instruction::Xor:</Highlight></CodeLine>
<Link id="l00972" /><CodeLine lineNumber="972"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> Instruction::Shl:</Highlight></CodeLine>
<Link id="l00973" /><CodeLine lineNumber="973"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> Instruction::LShr:</Highlight></CodeLine>
<Link id="l00974" /><CodeLine lineNumber="974"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> Instruction::AShr: &#123;</Highlight></CodeLine>
<Link id="l00975" /><CodeLine lineNumber="975"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;IVOpnd =</Highlight></CodeLine>
<Link id="l00976" /><CodeLine lineNumber="976"><Highlight kind="normal">          !<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;Constant&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOperand(0))</Highlight></CodeLine>
<Link id="l00977" /><CodeLine lineNumber="977"><Highlight kind="normal">              ? <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOperand(0)</Highlight></CodeLine>
<Link id="l00978" /><CodeLine lineNumber="978"><Highlight kind="normal">              : !<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;Constant&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOperand(1)) ? <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOperand(1) : </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00979" /><CodeLine lineNumber="979"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!IVOpnd)</Highlight></CodeLine>
<Link id="l00980" /><CodeLine lineNumber="980"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00981" /><CodeLine lineNumber="981"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00982" /><CodeLine lineNumber="982"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// If increment operand is used outside of the loop, this speculation</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00983" /><CodeLine lineNumber="983"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// could cause extra live range interference.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00984" /><CodeLine lineNumber="984"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MultiExitLoop) &#123;</Highlight></CodeLine>
<Link id="l00985" /><CodeLine lineNumber="985"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/user">User</a> &#42;UseI : IVOpnd-&gt;<a href="/docs/api/classes/llvm/value/#a411cf3e3932f209ce3374cb31adc1da6">users</a>()) &#123;</Highlight></CodeLine>
<Link id="l00986" /><CodeLine lineNumber="986"><Highlight kind="normal">          </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;UserInst = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Instruction&gt;</a>(UseI);</Highlight></CodeLine>
<Link id="l00987" /><CodeLine lineNumber="987"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!L-&gt;contains(UserInst))</Highlight></CodeLine>
<Link id="l00988" /><CodeLine lineNumber="988"><Highlight kind="normal">            </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00989" /><CodeLine lineNumber="989"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l00990" /><CodeLine lineNumber="990"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00991" /><CodeLine lineNumber="991"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00992" /><CodeLine lineNumber="992"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (seenIncrement)</Highlight></CodeLine>
<Link id="l00993" /><CodeLine lineNumber="993"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00994" /><CodeLine lineNumber="994"><Highlight kind="normal">      seenIncrement = </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00995" /><CodeLine lineNumber="995"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">break</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00996" /><CodeLine lineNumber="996"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00997" /><CodeLine lineNumber="997"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> Instruction::Trunc:</Highlight></CodeLine>
<Link id="l00998" /><CodeLine lineNumber="998"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> Instruction::ZExt:</Highlight></CodeLine>
<Link id="l00999" /><CodeLine lineNumber="999"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">case</Highlight><Highlight kind="normal"> Instruction::SExt:</Highlight></CodeLine>
<Link id="l01000" /><CodeLine lineNumber="1000"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// ignore type conversions</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01001" /><CodeLine lineNumber="1001"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">break</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01002" /><CodeLine lineNumber="1002"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01003" /><CodeLine lineNumber="1003"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01004" /><CodeLine lineNumber="1004"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01005" /><CodeLine lineNumber="1005"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01006" /><CodeLine lineNumber="1006"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l01007" /><CodeLine lineNumber="1007"><Highlight kind="comment">/// Fold the loop tail into the loop exit by speculating the loop tail</Highlight></CodeLine>
<Link id="l01008" /><CodeLine lineNumber="1008"><Highlight kind="comment">/// instructions. Typically, this is a single post-increment. In the case of a</Highlight></CodeLine>
<Link id="l01009" /><CodeLine lineNumber="1009"><Highlight kind="comment">/// simple 2-block loop, hoisting the increment can be much better than</Highlight></CodeLine>
<Link id="l01010" /><CodeLine lineNumber="1010"><Highlight kind="comment">/// duplicating the entire loop header. In the case of loops with early exits,</Highlight></CodeLine>
<Link id="l01011" /><CodeLine lineNumber="1011"><Highlight kind="comment">/// rotation will not work anyway, but simplifyLoopLatch will put the loop in</Highlight></CodeLine>
<Link id="l01012" /><CodeLine lineNumber="1012"><Highlight kind="comment">/// canonical form so downstream passes can handle it.</Highlight></CodeLine>
<Link id="l01013" /><CodeLine lineNumber="1013"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l01014" /><CodeLine lineNumber="1014"><Highlight kind="comment">/// I don&#39;t believe this invalidates SCEV.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01015" /><CodeLine lineNumber="1015"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> LoopRotate::simplifyLoopLatch(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L) &#123;</Highlight></CodeLine>
<Link id="l01016" /><CodeLine lineNumber="1016"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Latch = <a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;getLoopLatch();</Highlight></CodeLine>
<Link id="l01017" /><CodeLine lineNumber="1017"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!Latch || Latch-&gt;<a href="/docs/api/classes/llvm/basicblock/#a315f26c899f5ea8a780db4740ba95ef4">hasAddressTaken</a>())</Highlight></CodeLine>
<Link id="l01018" /><CodeLine lineNumber="1018"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01019" /><CodeLine lineNumber="1019"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01020" /><CodeLine lineNumber="1020"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;Jmp = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BranchInst&gt;</a>(Latch-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l01021" /><CodeLine lineNumber="1021"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!Jmp || !Jmp-&gt;<a href="/docs/api/classes/llvm/branchinst/#ad56f6a9b5cd05940017c4544df48bc30">isUnconditional</a>())</Highlight></CodeLine>
<Link id="l01022" /><CodeLine lineNumber="1022"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01023" /><CodeLine lineNumber="1023"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01024" /><CodeLine lineNumber="1024"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;LastExit = Latch-&gt;<a href="/docs/api/classes/llvm/basicblock/#a59fb91d1691350f7d1b8e8a114e3f2a4">getSinglePredecessor</a>();</Highlight></CodeLine>
<Link id="l01025" /><CodeLine lineNumber="1025"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!LastExit || !<a href="/docs/api/namespaces/llvm/m68k/#ab3a288f2953d8eca3e363959fc2cf38ead20caec3b48a1eef164cb4ca81ba2587">L</a>-&gt;isLoopExiting(LastExit))</Highlight></CodeLine>
<Link id="l01026" /><CodeLine lineNumber="1026"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01027" /><CodeLine lineNumber="1027"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01028" /><CodeLine lineNumber="1028"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;BI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BranchInst&gt;</a>(LastExit-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l01029" /><CodeLine lineNumber="1029"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!BI)</Highlight></CodeLine>
<Link id="l01030" /><CodeLine lineNumber="1030"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01031" /><CodeLine lineNumber="1031"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01032" /><CodeLine lineNumber="1032"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="#a41713fe2635c183d98e1a6b7c1cedff5">shouldSpeculateInstrs</a>(Latch-&gt;<a href="/docs/api/classes/llvm/basicblock/#a0ed5f3ab3c2e4196ee0cffffa080c062">begin</a>(), Jmp-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>(), L))</Highlight></CodeLine>
<Link id="l01033" /><CodeLine lineNumber="1033"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01034" /><CodeLine lineNumber="1034"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01035" /><CodeLine lineNumber="1035"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Folding loop latch &quot;</Highlight><Highlight kind="normal"> &lt;&lt; Latch-&gt;<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; into &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01036" /><CodeLine lineNumber="1036"><Highlight kind="normal">                    &lt;&lt; LastExit-&gt;<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01037" /><CodeLine lineNumber="1037"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01038" /><CodeLine lineNumber="1038"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/domtreeupdater">DomTreeUpdater</a> DTU(DT, DomTreeUpdater::UpdateStrategy::Eager);</Highlight></CodeLine>
<Link id="l01039" /><CodeLine lineNumber="1039"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#aa76a2cf19b821f320ab439d5659ef4b9">MergeBlockIntoPredecessor</a>(Latch, &amp;DTU, LI, MSSAU, </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l01040" /><CodeLine lineNumber="1040"><Highlight kind="normal">                            </Highlight><Highlight kind="comment">/&#42;PredecessorWithTwoSuccessors=&#42;/</Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01041" /><CodeLine lineNumber="1041"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01042" /><CodeLine lineNumber="1042"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SE) &#123;</Highlight></CodeLine>
<Link id="l01043" /><CodeLine lineNumber="1043"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Merging blocks may remove blocks reference in the block disposition cache. Clear the cache.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01044" /><CodeLine lineNumber="1044"><Highlight kind="normal">      SE-&gt;forgetBlockAndLoopDispositions();</Highlight></CodeLine>
<Link id="l01045" /><CodeLine lineNumber="1045"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01046" /><CodeLine lineNumber="1046"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01047" /><CodeLine lineNumber="1047"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MSSAU &amp;&amp; <a href="/docs/api/namespaces/llvm/#aa29fe161c408879ada30c90ebbf55dcf">VerifyMemorySSA</a>)</Highlight></CodeLine>
<Link id="l01048" /><CodeLine lineNumber="1048"><Highlight kind="normal">    MSSAU-&gt;getMemorySSA()-&gt;verifyMemorySSA();</Highlight></CodeLine>
<Link id="l01049" /><CodeLine lineNumber="1049"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01050" /><CodeLine lineNumber="1050"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01051" /><CodeLine lineNumber="1051"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01052" /><CodeLine lineNumber="1052"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l01053" /><CodeLine lineNumber="1053"><Highlight kind="comment">/// Rotate \\c L, and return true if any modification was made.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01054" /><CodeLine lineNumber="1054" lineLink="/docs/api/classes/anonymous-namespace-looprotationutils-cpp-/looprotate/#a11d33a961545f41b26d338ee61c8ce42"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-looprotationutils-cpp-/looprotate/#a11d33a961545f41b26d338ee61c8ce42">LoopRotate::processLoop</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L) &#123;</Highlight></CodeLine>
<Link id="l01055" /><CodeLine lineNumber="1055"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Save the loop metadata.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01056" /><CodeLine lineNumber="1056"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42;LoopMD = L-&gt;getLoopID();</Highlight></CodeLine>
<Link id="l01057" /><CodeLine lineNumber="1057"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01058" /><CodeLine lineNumber="1058"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> SimplifiedLatch = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01059" /><CodeLine lineNumber="1059"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01060" /><CodeLine lineNumber="1060"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Simplify the loop latch before attempting to rotate the header</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01061" /><CodeLine lineNumber="1061"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// upward. Rotation may not be needed if the loop tail can be folded into the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01062" /><CodeLine lineNumber="1062"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// loop exit.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01063" /><CodeLine lineNumber="1063"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!RotationOnly)</Highlight></CodeLine>
<Link id="l01064" /><CodeLine lineNumber="1064"><Highlight kind="normal">    SimplifiedLatch = simplifyLoopLatch(L);</Highlight></CodeLine>
<Link id="l01065" /><CodeLine lineNumber="1065"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01066" /><CodeLine lineNumber="1066"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> MadeChange = rotateLoop(L, SimplifiedLatch);</Highlight></CodeLine>
<Link id="l01067" /><CodeLine lineNumber="1067"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((!MadeChange || L-&gt;isLoopExiting(L-&gt;getLoopLatch())) &amp;&amp;</Highlight></CodeLine>
<Link id="l01068" /><CodeLine lineNumber="1068"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;Loop latch should be exiting after loop-rotate.&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01069" /><CodeLine lineNumber="1069"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01070" /><CodeLine lineNumber="1070"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Restore the loop metadata.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01071" /><CodeLine lineNumber="1071"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// NB! We presume LoopRotation DOESN&#39;T ADD its own metadata.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01072" /><CodeLine lineNumber="1072"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> ((MadeChange || SimplifiedLatch) &amp;&amp; LoopMD)</Highlight></CodeLine>
<Link id="l01073" /><CodeLine lineNumber="1073"><Highlight kind="normal">    L-&gt;setLoopID(LoopMD);</Highlight></CodeLine>
<Link id="l01074" /><CodeLine lineNumber="1074"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01075" /><CodeLine lineNumber="1075"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> MadeChange || SimplifiedLatch;</Highlight></CodeLine>
<Link id="l01076" /><CodeLine lineNumber="1076"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l01077" /><CodeLine lineNumber="1077"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01078" /><CodeLine lineNumber="1078"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l01079" /><CodeLine lineNumber="1079"><Highlight kind="comment">/// The utility to convert a loop into a loop with bottom test.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01080" /><CodeLine lineNumber="1080" lineLink="/docs/api/namespaces/llvm/#af450da528c31bc2f2780ea2a243911ad"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/#af450da528c31bc2f2780ea2a243911ad">llvm::LoopRotation</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &#42;LI, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/targettransforminfo">TargetTransformInfo</a> &#42;<a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>,</Highlight></CodeLine>
<Link id="l01081" /><CodeLine lineNumber="1081"><Highlight kind="normal">                        <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &#42;AC, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &#42;DT,</Highlight></CodeLine>
<Link id="l01082" /><CodeLine lineNumber="1082"><Highlight kind="normal">                        <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42;SE, <a href="/docs/api/classes/llvm/memoryssaupdater">MemorySSAUpdater</a> &#42;MSSAU,</Highlight></CodeLine>
<Link id="l01083" /><CodeLine lineNumber="1083"><Highlight kind="normal">                        </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/structs/llvm/simplifyquery">SimplifyQuery</a> &amp;SQ, </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> RotationOnly = </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l01084" /><CodeLine lineNumber="1084"><Highlight kind="normal">                        </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> Threshold = </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal">(-1),</Highlight></CodeLine>
<Link id="l01085" /><CodeLine lineNumber="1085"><Highlight kind="normal">                        </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> IsUtilMode = </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">, </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> PrepareForLTO) &#123;</Highlight></CodeLine>
<Link id="l01086" /><CodeLine lineNumber="1086"><Highlight kind="normal">  <a href="/docs/api/classes/anonymous-namespace-looprotationutils-cpp-/looprotate/#a6458617345354f31e0642b0fa1c096cf">LoopRotate</a> LR(Threshold, LI, <a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>, AC, DT, SE, MSSAU, SQ, RotationOnly,</Highlight></CodeLine>
<Link id="l01087" /><CodeLine lineNumber="1087"><Highlight kind="normal">                IsUtilMode, PrepareForLTO);</Highlight></CodeLine>
<Link id="l01088" /><CodeLine lineNumber="1088"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> LR.processLoop(L);</Highlight></CodeLine>
<Link id="l01089" /><CodeLine lineNumber="1089"><Highlight kind="normal">&#125;</Highlight></CodeLine>

</ProgramListing>


</DoxygenPage>
