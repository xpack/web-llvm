---

# DO NOT EDIT!
# Automatically generated via docusaurus-plugin-doxygen by Doxygen.

slug: /api/files/lib/lib/transforms/lib/transforms/scalar/lowerexpectintrinsic-cpp
custom_edit_url: null
keywords:
  - doxygen
  - reference
  - file

---

import Link from '@docusaurus/Link'

import CodeLine from '@xpack/docusaurus-plugin-doxygen/components/CodeLine'
import DoxygenPage from '@xpack/docusaurus-plugin-doxygen/components/DoxygenPage'
import IncludesList from '@xpack/docusaurus-plugin-doxygen/components/IncludesList'
import IncludesListItem from '@xpack/docusaurus-plugin-doxygen/components/IncludesListItem'
import MemberDefinition from '@xpack/docusaurus-plugin-doxygen/components/MemberDefinition'
import MembersIndex from '@xpack/docusaurus-plugin-doxygen/components/MembersIndex'
import MembersIndexItem from '@xpack/docusaurus-plugin-doxygen/components/MembersIndexItem'
import ProgramListing from '@xpack/docusaurus-plugin-doxygen/components/ProgramListing'
import SectionDefinition from '@xpack/docusaurus-plugin-doxygen/components/SectionDefinition'

import pluginConfig from '@site/docusaurus-plugin-doxygen-config.json'

# The `LowerExpectIntrinsic.cpp` File Reference

<DoxygenPage pluginConfig={pluginConfig}>



## Included Headers

<IncludesList>
<IncludesListItem
  filePath="llvm/Transforms/Scalar/LowerExpectIntrinsic.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/scalar/lowerexpectintrinsic-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SmallVector.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/smallvector-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/Statistic.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/BasicBlock.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/basicblock-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Constants.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/constants-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Function.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/function-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Instructions.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/instructions-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Intrinsics.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/intrinsics-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/LLVMContext.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/llvmcontext-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/MDBuilder.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/mdbuilder-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/ProfDataUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/profdatautils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/CommandLine.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/MisExpect.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/misexpect-h"
  isLocal="true" />
<IncludesListItem
  filePath="cmath"
  permalink=""
  isLocal="false" />
</IncludesList>

## Functions Index

<MembersIndex>

<MembersIndexItem
  type={<>std::tuple&lt; uint32&#95;t, uint32&#95;t &gt;</>}
  name={<><a href="#a4c4c33f562e18b287ca4ca5b0e0eedc7">getBranchWeight</a> (Intrinsic::ID IntrinsicID, CallInst &#42;CI, int BranchCount)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a390dfaf67ef6d58f12f5a19ee938c60f">handleBranchExpect</a> (BranchInst &amp;BI)</>}>
</MembersIndexItem>

<MembersIndexItem
  template={<>template &lt;class BrSelInst&gt;</>}
  type="bool"
  name={<><a href="#a6ac9067dc7c125cd83855df3e480e04c">handleBrSelExpect</a> (BrSelInst &amp;BSI)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#aea5dd05a61257355d99f96d8d6dc9f94">handlePhiDef</a> (CallInst &#42;Expect)</>}>
Handler for PHINodes that define the value argument to an @llvm.expect call. <a href="#aea5dd05a61257355d99f96d8d6dc9f94">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#ab61a60817533b84f369d2623e0593ec7">handleSwitchExpect</a> (SwitchInst &amp;SI)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#ad2fd6546e0f1cc42311962f4ad4b29cd">lowerExpectIntrinsic</a> (Function &amp;F)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#a84c8c3ba81c1ae4709aef0242323c499">STATISTIC</a> (ExpectIntrinsicsHandled, &quot;Number of &#39;expect&#39; intrinsic instructions handled&quot;)</>}>
</MembersIndexItem>

</MembersIndex>

## Variables Index

<MembersIndex>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; uint32&#95;t &gt;</>}
  name={<><a href="#aae93c90b6047163d33af8cc1bd57a193">LikelyBranchWeight</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; uint32&#95;t &gt;</>}
  name={<><a href="#a351a1280d0bfece4f72e806eba12d284">UnlikelyBranchWeight</a></>}>
</MembersIndexItem>

</MembersIndex>

## Defines Index

<MembersIndex>

<MembersIndexItem
  type="#define"
  name={<><a href="#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>&nbsp;&nbsp;&nbsp;&quot;lower-expect-intrinsic&quot;</>}>
</MembersIndexItem>

</MembersIndex>


<SectionDefinition>

## Functions

### getBranchWeight() {#a4c4c33f562e18b287ca4ca5b0e0eedc7}

<MemberDefinition
  prototype={<>static std::tuple&lt; uint32&#95;t, uint32&#95;t &gt; getBranchWeight (<a href="/docs/api/namespaces/llvm/intrinsic/#a80add6b3b1cdaec560907995127adc16">Intrinsic::ID</a> IntrinsicID, <a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42; CI, int BranchCount)</>}
  labels = {["static"]}>

Definition at line <a href="#l00056">56</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/lowerexpectintrinsic-cpp">LowerExpectIntrinsic.cpp</a>.
</MemberDefinition>

### handleBranchExpect() {#a390dfaf67ef6d58f12f5a19ee938c60f}

<MemberDefinition
  prototype={<>static bool handleBranchExpect (<a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &amp; BI)</>}
  labels = {["static"]}>

Definition at line <a href="#l00357">357</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/lowerexpectintrinsic-cpp">LowerExpectIntrinsic.cpp</a>.
</MemberDefinition>

### handleBrSelExpect() {#a6ac9067dc7c125cd83855df3e480e04c}

<MemberDefinition
  template={<>template &lt;class BrSelInst&gt;</>}
  prototype={<>static bool handleBrSelExpect (BrSelInst &amp; BSI)</>}
  labels = {["static"]}>

Definition at line <a href="#l00276">276</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/lowerexpectintrinsic-cpp">LowerExpectIntrinsic.cpp</a>.
</MemberDefinition>

### handlePhiDef() {#aea5dd05a61257355d99f96d8d6dc9f94}

<MemberDefinition
  prototype={<>static void handlePhiDef (<a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42; Expect)</>}
  labels = {["static"]}>
Handler for PHINodes that define the value argument to an @llvm.expect call.

If the operand of the phi has a constant value and it &#39;contradicts&#39; with the expected value of phi def, then the corresponding incoming edge of the phi is unlikely to be taken. Using that information, the branch probability info for the originating branch can be inferred.

Definition at line <a href="#l00116">116</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/lowerexpectintrinsic-cpp">LowerExpectIntrinsic.cpp</a>.
</MemberDefinition>

### handleSwitchExpect() {#ab61a60817533b84f369d2623e0593ec7}

<MemberDefinition
  prototype={<>static bool handleSwitchExpect (<a href="/docs/api/classes/llvm/switchinst">SwitchInst</a> &amp; SI)</>}
  labels = {["static"]}>

Definition at line <a href="#l00076">76</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/lowerexpectintrinsic-cpp">LowerExpectIntrinsic.cpp</a>.
</MemberDefinition>

### lowerExpectIntrinsic() {#ad2fd6546e0f1cc42311962f4ad4b29cd}

<MemberDefinition
  prototype={<>static bool lowerExpectIntrinsic (<a href="/docs/api/classes/llvm/function">Function</a> &amp; F)</>}
  labels = {["static"]}>

Definition at line <a href="#l00364">364</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/lowerexpectintrinsic-cpp">LowerExpectIntrinsic.cpp</a>.
</MemberDefinition>

### STATISTIC() {#a84c8c3ba81c1ae4709aef0242323c499}

<MemberDefinition
  prototype={<>STATISTIC (ExpectIntrinsicsHandled, &quot;Number of &#39;expect&#39; intrinsic <a href="/docs/api/files/lib/lib/codegen/atomicexpandpass-cpp/#a1bcc06b1cb86bd0ea08f33323190bdaa">instructions</a> handled&quot;)</>}>

Definition at line <a href="#l00033">33</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/lowerexpectintrinsic-cpp">LowerExpectIntrinsic.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Variables

### LikelyBranchWeight {#aae93c90b6047163d33af8cc1bd57a193}

<MemberDefinition
  prototype={<>cl::opt&lt; uint32&#95;t &gt; LikelyBranchWeight(&quot;likely-branch-weight&quot;, cl::Hidden, cl::init(2000), cl::desc(&quot;Weight of the branch likely to be taken (default = 2000)&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00048">48</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/lowerexpectintrinsic-cpp">LowerExpectIntrinsic.cpp</a>.
</MemberDefinition>

### UnlikelyBranchWeight {#a351a1280d0bfece4f72e806eba12d284}

<MemberDefinition
  prototype={<>cl::opt&lt; uint32&#95;t &gt; UnlikelyBranchWeight(&quot;unlikely-branch-weight&quot;, cl::Hidden, cl::init(1), cl::desc(&quot;Weight of the branch unlikely to be taken (default = 1)&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00051">51</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/lowerexpectintrinsic-cpp">LowerExpectIntrinsic.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Defines

### DEBUG&#95;TYPE {#ad78e062f62e0d6e453941fb4ca843e4d}

<MemberDefinition
  prototype={<>#define DEBUG&#95;TYPE&nbsp;&nbsp;&nbsp;&quot;lower-expect-intrinsic&quot;</>}>

Definition at line <a href="#l00031">31</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/scalar/lowerexpectintrinsic-cpp">LowerExpectIntrinsic.cpp</a>.
</MemberDefinition>

</SectionDefinition>

## File Listing

The file content with the documentation metadata removed is:

<ProgramListing>

<Link id="l00001" /><CodeLine lineNumber="1"><span class="doxyHighlightComment">//===- LowerExpectIntrinsic.cpp - Lower expect intrinsic ------------------===//</span></CodeLine>
<Link id="l00002" /><CodeLine lineNumber="2"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00003" /><CodeLine lineNumber="3"><span class="doxyHighlightComment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</span></CodeLine>
<Link id="l00004" /><CodeLine lineNumber="4"><span class="doxyHighlightComment">// See https://llvm.org/LICENSE.txt for license information.</span></CodeLine>
<Link id="l00005" /><CodeLine lineNumber="5"><span class="doxyHighlightComment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</span></CodeLine>
<Link id="l00006" /><CodeLine lineNumber="6"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00007" /><CodeLine lineNumber="7"><span class="doxyHighlightComment">//===----------------------------------------------------------------------===//</span></CodeLine>
<Link id="l00008" /><CodeLine lineNumber="8"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00009" /><CodeLine lineNumber="9"><span class="doxyHighlightComment">// This pass lowers the &#39;expect&#39; intrinsic to LLVM metadata.</span></CodeLine>
<Link id="l00010" /><CodeLine lineNumber="10"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00011" /><CodeLine lineNumber="11"><span class="doxyHighlightComment">//===----------------------------------------------------------------------===//</span></CodeLine>
<Link id="l00012" /><CodeLine lineNumber="12"></CodeLine>
<Link id="l00013" /><CodeLine lineNumber="13"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/scalar/lowerexpectintrinsic-h">llvm/Transforms/Scalar/LowerExpectIntrinsic.h</a>&quot;</span></CodeLine>
<Link id="l00014" /><CodeLine lineNumber="14"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/smallvector-h">llvm/ADT/SmallVector.h</a>&quot;</span></CodeLine>
<Link id="l00015" /><CodeLine lineNumber="15"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h">llvm/ADT/Statistic.h</a>&quot;</span></CodeLine>
<Link id="l00016" /><CodeLine lineNumber="16"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/basicblock-h">llvm/IR/BasicBlock.h</a>&quot;</span></CodeLine>
<Link id="l00017" /><CodeLine lineNumber="17"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/constants-h">llvm/IR/Constants.h</a>&quot;</span></CodeLine>
<Link id="l00018" /><CodeLine lineNumber="18"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/function-h">llvm/IR/Function.h</a>&quot;</span></CodeLine>
<Link id="l00019" /><CodeLine lineNumber="19"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/instructions-h">llvm/IR/Instructions.h</a>&quot;</span></CodeLine>
<Link id="l00020" /><CodeLine lineNumber="20"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/intrinsics-h">llvm/IR/Intrinsics.h</a>&quot;</span></CodeLine>
<Link id="l00021" /><CodeLine lineNumber="21"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/llvmcontext-h">llvm/IR/LLVMContext.h</a>&quot;</span></CodeLine>
<Link id="l00022" /><CodeLine lineNumber="22"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/mdbuilder-h">llvm/IR/MDBuilder.h</a>&quot;</span></CodeLine>
<Link id="l00023" /><CodeLine lineNumber="23"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/profdatautils-h">llvm/IR/ProfDataUtils.h</a>&quot;</span></CodeLine>
<Link id="l00024" /><CodeLine lineNumber="24"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h">llvm/Support/CommandLine.h</a>&quot;</span></CodeLine>
<Link id="l00025" /><CodeLine lineNumber="25"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/misexpect-h">llvm/Transforms/Utils/MisExpect.h</a>&quot;</span></CodeLine>
<Link id="l00026" /><CodeLine lineNumber="26"></CodeLine>
<Link id="l00027" /><CodeLine lineNumber="27"><span class="doxyHighlightPreprocessor">#include &lt;cmath&gt;</span></CodeLine>
<Link id="l00028" /><CodeLine lineNumber="28"></CodeLine>
<Link id="l00029" /><CodeLine lineNumber="29"><span class="doxyHighlightKeyword">using namespace </span><span class="doxyHighlight"><a href="/docs/api/namespaces/llvm">llvm</a>;</span></CodeLine>
<Link id="l00030" /><CodeLine lineNumber="30"></CodeLine>
<Link id="l00031" /><CodeLine lineNumber="31" lineLink="#ad78e062f62e0d6e453941fb4ca843e4d"><span class="doxyHighlightPreprocessor">#define DEBUG&#95;TYPE &quot;lower-expect-intrinsic&quot;</span></CodeLine>
<Link id="l00032" /><CodeLine lineNumber="32"></CodeLine>
<Link id="l00033" /><CodeLine lineNumber="33" lineLink="#a84c8c3ba81c1ae4709aef0242323c499"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(ExpectIntrinsicsHandled,</span></CodeLine>
<Link id="l00034" /><CodeLine lineNumber="34"><span class="doxyHighlight">          </span><span class="doxyHighlightStringLiteral">&quot;Number of &#39;expect&#39; intrinsic instructions handled&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00035" /><CodeLine lineNumber="35"></CodeLine>
<Link id="l00036" /><CodeLine lineNumber="36"><span class="doxyHighlightComment">// These default values are chosen to represent an extremely skewed outcome for</span></CodeLine>
<Link id="l00037" /><CodeLine lineNumber="37"><span class="doxyHighlightComment">// a condition, but they leave some room for interpretation by later passes.</span></CodeLine>
<Link id="l00038" /><CodeLine lineNumber="38"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00039" /><CodeLine lineNumber="39"><span class="doxyHighlightComment">// If the documentation for &#95;&#95;builtin&#95;expect() was made explicit that it should</span></CodeLine>
<Link id="l00040" /><CodeLine lineNumber="40"><span class="doxyHighlightComment">// only be used in extreme cases, we could make this ratio higher. As it stands,</span></CodeLine>
<Link id="l00041" /><CodeLine lineNumber="41"><span class="doxyHighlightComment">// programmers may be using &#95;&#95;builtin&#95;expect() / llvm.expect to annotate that a</span></CodeLine>
<Link id="l00042" /><CodeLine lineNumber="42"><span class="doxyHighlightComment">// branch is likely or unlikely to be taken.</span></CodeLine>
<Link id="l00043" /><CodeLine lineNumber="43"></CodeLine>
<Link id="l00044" /><CodeLine lineNumber="44"><span class="doxyHighlightComment">// WARNING: these values are internal implementation detail of the pass.</span></CodeLine>
<Link id="l00045" /><CodeLine lineNumber="45"><span class="doxyHighlightComment">// They should not be exposed to the outside of the pass, front-end codegen</span></CodeLine>
<Link id="l00046" /><CodeLine lineNumber="46"><span class="doxyHighlightComment">// should emit @llvm.expect intrinsics instead of using these weights directly.</span></CodeLine>
<Link id="l00047" /><CodeLine lineNumber="47"><span class="doxyHighlightComment">// Transforms should use TargetTransformInfo&#39;s getPredictableBranchThreshold().</span></CodeLine>
<Link id="l00048" /><CodeLine lineNumber="48" lineLink="#aae93c90b6047163d33af8cc1bd57a193"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;uint32&#95;t&gt;</a> <a href="#aae93c90b6047163d33af8cc1bd57a193">LikelyBranchWeight</a>(</span></CodeLine>
<Link id="l00049" /><CodeLine lineNumber="49"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;likely-branch-weight&quot;</span><span class="doxyHighlight">, <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(2000),</span></CodeLine>
<Link id="l00050" /><CodeLine lineNumber="50"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Weight of the branch likely to be taken (default = 2000)&quot;</span><span class="doxyHighlight">));</span></CodeLine>
<Link id="l00051" /><CodeLine lineNumber="51" lineLink="#a351a1280d0bfece4f72e806eba12d284"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;uint32&#95;t&gt;</a> <a href="#a351a1280d0bfece4f72e806eba12d284">UnlikelyBranchWeight</a>(</span></CodeLine>
<Link id="l00052" /><CodeLine lineNumber="52"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;unlikely-branch-weight&quot;</span><span class="doxyHighlight">, <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(1),</span></CodeLine>
<Link id="l00053" /><CodeLine lineNumber="53"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Weight of the branch unlikely to be taken (default = 1)&quot;</span><span class="doxyHighlight">));</span></CodeLine>
<Link id="l00054" /><CodeLine lineNumber="54"></CodeLine>
<Link id="l00055" /><CodeLine lineNumber="55"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> std::tuple&lt;uint32&#95;t, uint32&#95;t&gt;</span></CodeLine>
<Link id="l00056" /><CodeLine lineNumber="56" lineLink="#a4c4c33f562e18b287ca4ca5b0e0eedc7"><span class="doxyHighlight"><a href="#a4c4c33f562e18b287ca4ca5b0e0eedc7">getBranchWeight</a>(<a href="/docs/api/namespaces/llvm/intrinsic/#a80add6b3b1cdaec560907995127adc16">Intrinsic::ID</a> IntrinsicID, <a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42;CI, </span><span class="doxyHighlightKeywordType">int</span><span class="doxyHighlight"> BranchCount) &#123;</span></CodeLine>
<Link id="l00057" /><CodeLine lineNumber="57"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IntrinsicID == Intrinsic::expect) &#123;</span></CodeLine>
<Link id="l00058" /><CodeLine lineNumber="58"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// &#95;&#95;builtin&#95;expect</span></CodeLine>
<Link id="l00059" /><CodeLine lineNumber="59"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> std::make&#95;tuple(<a href="#aae93c90b6047163d33af8cc1bd57a193">LikelyBranchWeight</a>.getValue(),</span></CodeLine>
<Link id="l00060" /><CodeLine lineNumber="60"><span class="doxyHighlight">                           <a href="#a351a1280d0bfece4f72e806eba12d284">UnlikelyBranchWeight</a>.getValue());</span></CodeLine>
<Link id="l00061" /><CodeLine lineNumber="61"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00062" /><CodeLine lineNumber="62"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// &#95;&#95;builtin&#95;expect&#95;with&#95;probability</span></CodeLine>
<Link id="l00063" /><CodeLine lineNumber="63"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(CI-&gt;<a href="/docs/api/classes/llvm/user/#addec638786f763d967811b45cb662f1f">getNumOperands</a>() &gt;= 3 &amp;&amp;</span></CodeLine>
<Link id="l00064" /><CodeLine lineNumber="64"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;expect with probability must have 3 arguments&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00065" /><CodeLine lineNumber="65"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Confidence = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;ConstantFP&gt;</a>(CI-&gt;<a href="/docs/api/classes/llvm/callbase/#aabd76e6a8a23a5af1ce4d3c310d88bcd">getArgOperand</a>(2));</span></CodeLine>
<Link id="l00066" /><CodeLine lineNumber="66"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">double</span><span class="doxyHighlight"> TrueProb = Confidence-&gt;getValueAPF().convertToDouble();</span></CodeLine>
<Link id="l00067" /><CodeLine lineNumber="67"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((TrueProb &gt;= 0 &amp;&amp; TrueProb &lt;= 1.0) &amp;&amp;</span></CodeLine>
<Link id="l00068" /><CodeLine lineNumber="68"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;probability value must be in the range &#91;0.0, 1.0&#93;&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00069" /><CodeLine lineNumber="69"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">double</span><span class="doxyHighlight"> FalseProb = (1.0 - TrueProb) / (BranchCount - 1);</span></CodeLine>
<Link id="l00070" /><CodeLine lineNumber="70"><span class="doxyHighlight">    uint32&#95;t LikelyBW = ceil((TrueProb &#42; (</span><span class="doxyHighlightKeywordType">double</span><span class="doxyHighlight">)(INT32&#95;MAX - 1)) + 1.0);</span></CodeLine>
<Link id="l00071" /><CodeLine lineNumber="71"><span class="doxyHighlight">    uint32&#95;t UnlikelyBW = ceil((FalseProb &#42; (</span><span class="doxyHighlightKeywordType">double</span><span class="doxyHighlight">)(INT32&#95;MAX - 1)) + 1.0);</span></CodeLine>
<Link id="l00072" /><CodeLine lineNumber="72"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> std::make&#95;tuple(LikelyBW, UnlikelyBW);</span></CodeLine>
<Link id="l00073" /><CodeLine lineNumber="73"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00074" /><CodeLine lineNumber="74"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00075" /><CodeLine lineNumber="75"></CodeLine>
<Link id="l00076" /><CodeLine lineNumber="76" lineLink="#ab61a60817533b84f369d2623e0593ec7"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#ab61a60817533b84f369d2623e0593ec7">handleSwitchExpect</a>(<a href="/docs/api/classes/llvm/switchinst">SwitchInst</a> &amp;<a href="/docs/api/namespaces/llvm/si">SI</a>) &#123;</span></CodeLine>
<Link id="l00077" /><CodeLine lineNumber="77"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42;CI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CallInst&gt;</a>(<a href="/docs/api/namespaces/llvm/si">SI</a>.getCondition());</span></CodeLine>
<Link id="l00078" /><CodeLine lineNumber="78"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CI)</span></CodeLine>
<Link id="l00079" /><CodeLine lineNumber="79"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00080" /><CodeLine lineNumber="80"></CodeLine>
<Link id="l00081" /><CodeLine lineNumber="81"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;Fn = CI-&gt;<a href="/docs/api/classes/llvm/callbase/#a2b1ae7cf1bafdd43d1fee4c6ad0a2913">getCalledFunction</a>();</span></CodeLine>
<Link id="l00082" /><CodeLine lineNumber="82"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Fn || (Fn-&gt;<a href="/docs/api/classes/llvm/function/#a4d0a7baab8d078065b2de10e3460892a">getIntrinsicID</a>() != Intrinsic::expect &amp;&amp;</span></CodeLine>
<Link id="l00083" /><CodeLine lineNumber="83"><span class="doxyHighlight">              Fn-&gt;<a href="/docs/api/classes/llvm/function/#a4d0a7baab8d078065b2de10e3460892a">getIntrinsicID</a>() != Intrinsic::expect&#95;with&#95;probability))</span></CodeLine>
<Link id="l00084" /><CodeLine lineNumber="84"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00085" /><CodeLine lineNumber="85"></CodeLine>
<Link id="l00086" /><CodeLine lineNumber="86"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;ArgValue = CI-&gt;<a href="/docs/api/classes/llvm/callbase/#aabd76e6a8a23a5af1ce4d3c310d88bcd">getArgOperand</a>(0);</span></CodeLine>
<Link id="l00087" /><CodeLine lineNumber="87"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;ExpectedValue = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ConstantInt&gt;</a>(CI-&gt;<a href="/docs/api/classes/llvm/callbase/#aabd76e6a8a23a5af1ce4d3c310d88bcd">getArgOperand</a>(1));</span></CodeLine>
<Link id="l00088" /><CodeLine lineNumber="88"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!ExpectedValue)</span></CodeLine>
<Link id="l00089" /><CodeLine lineNumber="89"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00090" /><CodeLine lineNumber="90"></CodeLine>
<Link id="l00091" /><CodeLine lineNumber="91"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/switchinst/casehandle">SwitchInst::CaseHandle</a> Case = &#42;<a href="/docs/api/namespaces/llvm/si">SI</a>.findCaseValue(ExpectedValue);</span></CodeLine>
<Link id="l00092" /><CodeLine lineNumber="92"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> n = <a href="/docs/api/namespaces/llvm/si">SI</a>.getNumCases(); </span><span class="doxyHighlightComment">// 1 for default case.</span></CodeLine>
<Link id="l00093" /><CodeLine lineNumber="93"><span class="doxyHighlight">  uint32&#95;t LikelyBranchWeightVal, UnlikelyBranchWeightVal;</span></CodeLine>
<Link id="l00094" /><CodeLine lineNumber="94"><span class="doxyHighlight">  std::tie(LikelyBranchWeightVal, UnlikelyBranchWeightVal) =</span></CodeLine>
<Link id="l00095" /><CodeLine lineNumber="95"><span class="doxyHighlight">      <a href="#a4c4c33f562e18b287ca4ca5b0e0eedc7">getBranchWeight</a>(Fn-&gt;<a href="/docs/api/classes/llvm/function/#a4d0a7baab8d078065b2de10e3460892a">getIntrinsicID</a>(), CI, n + 1);</span></CodeLine>
<Link id="l00096" /><CodeLine lineNumber="96"></CodeLine>
<Link id="l00097" /><CodeLine lineNumber="97"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;uint32&#95;t, 16&gt;</a> Weights(n + 1, UnlikelyBranchWeightVal);</span></CodeLine>
<Link id="l00098" /><CodeLine lineNumber="98"></CodeLine>
<Link id="l00099" /><CodeLine lineNumber="99"><span class="doxyHighlight">  uint64&#95;t Index = (Case == &#42;<a href="/docs/api/namespaces/llvm/si">SI</a>.case&#95;default()) ? 0 : Case.<a href="/docs/api/classes/llvm/switchinst/casehandleimpl/#a49fb99a80264b770a56f2b3c2934fb02">getCaseIndex</a>() + 1;</span></CodeLine>
<Link id="l00100" /><CodeLine lineNumber="100"><span class="doxyHighlight">  Weights&#91;Index&#93; = LikelyBranchWeightVal;</span></CodeLine>
<Link id="l00101" /><CodeLine lineNumber="101"></CodeLine>
<Link id="l00102" /><CodeLine lineNumber="102"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/misexpect/#a4c52059f91406714507309d168ff95b8">misexpect::checkExpectAnnotations</a>(<a href="/docs/api/namespaces/llvm/si">SI</a>, Weights, </span><span class="doxyHighlightComment">/&#42;IsFrontend=&#42;/</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00103" /><CodeLine lineNumber="103"></CodeLine>
<Link id="l00104" /><CodeLine lineNumber="104"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/si">SI</a>.setCondition(ArgValue);</span></CodeLine>
<Link id="l00105" /><CodeLine lineNumber="105"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a6cf82c052d63a1b464be8e48ff38c48e">setBranchWeights</a>(<a href="/docs/api/namespaces/llvm/si">SI</a>, Weights, </span><span class="doxyHighlightComment">/&#42;IsExpected=&#42;/</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00106" /><CodeLine lineNumber="106"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00107" /><CodeLine lineNumber="107"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00108" /><CodeLine lineNumber="108"></CodeLine>
<Link id="l00109" /><CodeLine lineNumber="109"><span class="doxyHighlightComment">/// Handler for PHINodes that define the value argument to an</span></CodeLine>
<Link id="l00110" /><CodeLine lineNumber="110"><span class="doxyHighlightComment">/// @llvm.expect call.</span></CodeLine>
<Link id="l00111" /><CodeLine lineNumber="111"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00112" /><CodeLine lineNumber="112"><span class="doxyHighlightComment">/// If the operand of the phi has a constant value and it &#39;contradicts&#39;</span></CodeLine>
<Link id="l00113" /><CodeLine lineNumber="113"><span class="doxyHighlightComment">/// with the expected value of phi def, then the corresponding incoming</span></CodeLine>
<Link id="l00114" /><CodeLine lineNumber="114"><span class="doxyHighlightComment">/// edge of the phi is unlikely to be taken. Using that information,</span></CodeLine>
<Link id="l00115" /><CodeLine lineNumber="115"><span class="doxyHighlightComment">/// the branch probability info for the originating branch can be inferred.</span></CodeLine>
<Link id="l00116" /><CodeLine lineNumber="116" lineLink="#aea5dd05a61257355d99f96d8d6dc9f94"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#aea5dd05a61257355d99f96d8d6dc9f94">handlePhiDef</a>(<a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42;Expect) &#123;</span></CodeLine>
<Link id="l00117" /><CodeLine lineNumber="117"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &amp;Arg = &#42;Expect-&gt;<a href="/docs/api/classes/llvm/callbase/#aabd76e6a8a23a5af1ce4d3c310d88bcd">getArgOperand</a>(0);</span></CodeLine>
<Link id="l00118" /><CodeLine lineNumber="118"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;ExpectedValue = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ConstantInt&gt;</a>(Expect-&gt;<a href="/docs/api/classes/llvm/callbase/#aabd76e6a8a23a5af1ce4d3c310d88bcd">getArgOperand</a>(1));</span></CodeLine>
<Link id="l00119" /><CodeLine lineNumber="119"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!ExpectedValue)</span></CodeLine>
<Link id="l00120" /><CodeLine lineNumber="120"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00121" /><CodeLine lineNumber="121"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/apint">APInt</a> &amp;ExpectedPhiValue = ExpectedValue-&gt;<a href="/docs/api/classes/llvm/constantint/#af7e1934ed72a405ef073ea5f9bbe828e">getValue</a>();</span></CodeLine>
<Link id="l00122" /><CodeLine lineNumber="122"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> ExpectedValueIsLikely = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00123" /><CodeLine lineNumber="123"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;Fn = Expect-&gt;<a href="/docs/api/classes/llvm/callbase/#a2b1ae7cf1bafdd43d1fee4c6ad0a2913">getCalledFunction</a>();</span></CodeLine>
<Link id="l00124" /><CodeLine lineNumber="124"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the function is expect&#95;with&#95;probability, then we need to take the</span></CodeLine>
<Link id="l00125" /><CodeLine lineNumber="125"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// probability into consideration. For example, in</span></CodeLine>
<Link id="l00126" /><CodeLine lineNumber="126"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// expect.with.probability.i64(i64 %a, i64 1, double 0.0), the</span></CodeLine>
<Link id="l00127" /><CodeLine lineNumber="127"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// &quot;ExpectedValue&quot; 1 is unlikely. This affects probability propagation later.</span></CodeLine>
<Link id="l00128" /><CodeLine lineNumber="128"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Fn-&gt;<a href="/docs/api/classes/llvm/function/#a4d0a7baab8d078065b2de10e3460892a">getIntrinsicID</a>() == Intrinsic::expect&#95;with&#95;probability) &#123;</span></CodeLine>
<Link id="l00129" /><CodeLine lineNumber="129"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;Confidence = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;ConstantFP&gt;</a>(Expect-&gt;<a href="/docs/api/classes/llvm/callbase/#aabd76e6a8a23a5af1ce4d3c310d88bcd">getArgOperand</a>(2));</span></CodeLine>
<Link id="l00130" /><CodeLine lineNumber="130"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">double</span><span class="doxyHighlight"> TrueProb = Confidence-&gt;getValueAPF().convertToDouble();</span></CodeLine>
<Link id="l00131" /><CodeLine lineNumber="131"><span class="doxyHighlight">    ExpectedValueIsLikely = (TrueProb &gt; 0.5);</span></CodeLine>
<Link id="l00132" /><CodeLine lineNumber="132"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00133" /><CodeLine lineNumber="133"></CodeLine>
<Link id="l00134" /><CodeLine lineNumber="134"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Walk up in backward a list of instructions that</span></CodeLine>
<Link id="l00135" /><CodeLine lineNumber="135"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// have &#39;copy&#39; semantics by &#39;stripping&#39; the copies</span></CodeLine>
<Link id="l00136" /><CodeLine lineNumber="136"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// until a PHI node or an instruction of unknown kind</span></CodeLine>
<Link id="l00137" /><CodeLine lineNumber="137"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// is reached. Negation via xor is also handled.</span></CodeLine>
<Link id="l00138" /><CodeLine lineNumber="138"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00139" /><CodeLine lineNumber="139"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//       C = PHI(...);</span></CodeLine>
<Link id="l00140" /><CodeLine lineNumber="140"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//       B = C;</span></CodeLine>
<Link id="l00141" /><CodeLine lineNumber="141"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//       A = B;</span></CodeLine>
<Link id="l00142" /><CodeLine lineNumber="142"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//       D = &#95;&#95;builtin&#95;expect(A, 0);</span></CodeLine>
<Link id="l00143" /><CodeLine lineNumber="143"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00144" /><CodeLine lineNumber="144"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;V = &amp;Arg;</span></CodeLine>
<Link id="l00145" /><CodeLine lineNumber="145"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;Instruction &#42;, 4&gt;</a> Operations;</span></CodeLine>
<Link id="l00146" /><CodeLine lineNumber="146"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">while</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;PHINode&gt;</a>(V)) &#123;</span></CodeLine>
<Link id="l00147" /><CodeLine lineNumber="147"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/zextinst">ZExtInst</a> &#42;ZExt = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ZExtInst&gt;</a>(V)) &#123;</span></CodeLine>
<Link id="l00148" /><CodeLine lineNumber="148"><span class="doxyHighlight">      V = ZExt-&gt;getOperand(0);</span></CodeLine>
<Link id="l00149" /><CodeLine lineNumber="149"><span class="doxyHighlight">      Operations.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(ZExt);</span></CodeLine>
<Link id="l00150" /><CodeLine lineNumber="150"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00151" /><CodeLine lineNumber="151"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00152" /><CodeLine lineNumber="152"></CodeLine>
<Link id="l00153" /><CodeLine lineNumber="153"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/sextinst">SExtInst</a> &#42;SExt = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;SExtInst&gt;</a>(V)) &#123;</span></CodeLine>
<Link id="l00154" /><CodeLine lineNumber="154"><span class="doxyHighlight">      V = SExt-&gt;getOperand(0);</span></CodeLine>
<Link id="l00155" /><CodeLine lineNumber="155"><span class="doxyHighlight">      Operations.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(SExt);</span></CodeLine>
<Link id="l00156" /><CodeLine lineNumber="156"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00157" /><CodeLine lineNumber="157"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00158" /><CodeLine lineNumber="158"></CodeLine>
<Link id="l00159" /><CodeLine lineNumber="159"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/binaryoperator">BinaryOperator</a> &#42;BinOp = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BinaryOperator&gt;</a>(V);</span></CodeLine>
<Link id="l00160" /><CodeLine lineNumber="160"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!BinOp || BinOp-&gt;getOpcode() != Instruction::Xor)</span></CodeLine>
<Link id="l00161" /><CodeLine lineNumber="161"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00162" /><CodeLine lineNumber="162"></CodeLine>
<Link id="l00163" /><CodeLine lineNumber="163"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;CInt = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ConstantInt&gt;</a>(BinOp-&gt;getOperand(1));</span></CodeLine>
<Link id="l00164" /><CodeLine lineNumber="164"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CInt)</span></CodeLine>
<Link id="l00165" /><CodeLine lineNumber="165"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00166" /><CodeLine lineNumber="166"></CodeLine>
<Link id="l00167" /><CodeLine lineNumber="167"><span class="doxyHighlight">    V = BinOp-&gt;getOperand(0);</span></CodeLine>
<Link id="l00168" /><CodeLine lineNumber="168"><span class="doxyHighlight">    Operations.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(BinOp);</span></CodeLine>
<Link id="l00169" /><CodeLine lineNumber="169"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00170" /><CodeLine lineNumber="170"></CodeLine>
<Link id="l00171" /><CodeLine lineNumber="171"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Executes the recorded operations on input &#39;Value&#39;.</span></CodeLine>
<Link id="l00172" /><CodeLine lineNumber="172"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> ApplyOperations = &#91;&amp;&#93;(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/apint">APInt</a> &amp;<a href="/docs/api/classes/llvm/value">Value</a>) &#123;</span></CodeLine>
<Link id="l00173" /><CodeLine lineNumber="173"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/apint">APInt</a> Result = <a href="/docs/api/classes/llvm/value">Value</a>;</span></CodeLine>
<Link id="l00174" /><CodeLine lineNumber="174"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a> : <a href="/docs/api/namespaces/llvm/#a6b0ac1fa4f05de76413c5e0ca6334035">llvm::reverse</a>(Operations)) &#123;</span></CodeLine>
<Link id="l00175" /><CodeLine lineNumber="175"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">switch</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>-&gt;getOpcode()) &#123;</span></CodeLine>
<Link id="l00176" /><CodeLine lineNumber="176"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::Xor:</span></CodeLine>
<Link id="l00177" /><CodeLine lineNumber="177"><span class="doxyHighlight">        Result ^= <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;ConstantInt&gt;</a>(<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>-&gt;getOperand(1))-&gt;getValue();</span></CodeLine>
<Link id="l00178" /><CodeLine lineNumber="178"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00179" /><CodeLine lineNumber="179"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::ZExt:</span></CodeLine>
<Link id="l00180" /><CodeLine lineNumber="180"><span class="doxyHighlight">        Result = Result.zext(<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>-&gt;getType()-&gt;getIntegerBitWidth());</span></CodeLine>
<Link id="l00181" /><CodeLine lineNumber="181"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00182" /><CodeLine lineNumber="182"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">case</span><span class="doxyHighlight"> Instruction::SExt:</span></CodeLine>
<Link id="l00183" /><CodeLine lineNumber="183"><span class="doxyHighlight">        Result = Result.sext(<a href="/docs/api/namespaces/llvm/#ab471937b9a227e70c7fe8bd9604014d6">Op</a>-&gt;getType()-&gt;getIntegerBitWidth());</span></CodeLine>
<Link id="l00184" /><CodeLine lineNumber="184"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00185" /><CodeLine lineNumber="185"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">default</span><span class="doxyHighlight">:</span></CodeLine>
<Link id="l00186" /><CodeLine lineNumber="186"><span class="doxyHighlight">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/errorhandling-h/#ace243f5c25697a1107cce46626b3dc94">llvm&#95;unreachable</a>(</span><span class="doxyHighlightStringLiteral">&quot;Unexpected operation&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00187" /><CodeLine lineNumber="187"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00188" /><CodeLine lineNumber="188"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00189" /><CodeLine lineNumber="189"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Result;</span></CodeLine>
<Link id="l00190" /><CodeLine lineNumber="190"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l00191" /><CodeLine lineNumber="191"></CodeLine>
<Link id="l00192" /><CodeLine lineNumber="192"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;PhiDef = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;PHINode&gt;</a>(V);</span></CodeLine>
<Link id="l00193" /><CodeLine lineNumber="193"></CodeLine>
<Link id="l00194" /><CodeLine lineNumber="194"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Get the first dominating conditional branch of the operand</span></CodeLine>
<Link id="l00195" /><CodeLine lineNumber="195"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// i&#39;s incoming block.</span></CodeLine>
<Link id="l00196" /><CodeLine lineNumber="196"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> GetDomConditional = &#91;&amp;&#93;(</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> i) -&gt; <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42; &#123;</span></CodeLine>
<Link id="l00197" /><CodeLine lineNumber="197"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB = PhiDef-&gt;getIncomingBlock(i);</span></CodeLine>
<Link id="l00198" /><CodeLine lineNumber="198"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;BI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BranchInst&gt;</a>(BB-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</span></CodeLine>
<Link id="l00199" /><CodeLine lineNumber="199"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BI &amp;&amp; BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#a7e4be8b16fbd68c9045a388904044e01">isConditional</a>())</span></CodeLine>
<Link id="l00200" /><CodeLine lineNumber="200"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> BI;</span></CodeLine>
<Link id="l00201" /><CodeLine lineNumber="201"><span class="doxyHighlight">    BB = BB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a59fb91d1691350f7d1b8e8a114e3f2a4">getSinglePredecessor</a>();</span></CodeLine>
<Link id="l00202" /><CodeLine lineNumber="202"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!BB)</span></CodeLine>
<Link id="l00203" /><CodeLine lineNumber="203"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00204" /><CodeLine lineNumber="204"><span class="doxyHighlight">    BI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BranchInst&gt;</a>(BB-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</span></CodeLine>
<Link id="l00205" /><CodeLine lineNumber="205"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!BI || BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#ad56f6a9b5cd05940017c4544df48bc30">isUnconditional</a>())</span></CodeLine>
<Link id="l00206" /><CodeLine lineNumber="206"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00207" /><CodeLine lineNumber="207"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> BI;</span></CodeLine>
<Link id="l00208" /><CodeLine lineNumber="208"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l00209" /><CodeLine lineNumber="209"></CodeLine>
<Link id="l00210" /><CodeLine lineNumber="210"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Now walk through all Phi operands to find phi oprerands with values</span></CodeLine>
<Link id="l00211" /><CodeLine lineNumber="211"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// conflicting with the expected phi output value. Any such operand</span></CodeLine>
<Link id="l00212" /><CodeLine lineNumber="212"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// indicates the incoming edge to that operand is unlikely.</span></CodeLine>
<Link id="l00213" /><CodeLine lineNumber="213"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> i = 0, e = PhiDef-&gt;getNumIncomingValues(); i != e; ++i) &#123;</span></CodeLine>
<Link id="l00214" /><CodeLine lineNumber="214"></CodeLine>
<Link id="l00215" /><CodeLine lineNumber="215"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;PhiOpnd = PhiDef-&gt;getIncomingValue(i);</span></CodeLine>
<Link id="l00216" /><CodeLine lineNumber="216"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;CI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ConstantInt&gt;</a>(PhiOpnd);</span></CodeLine>
<Link id="l00217" /><CodeLine lineNumber="217"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CI)</span></CodeLine>
<Link id="l00218" /><CodeLine lineNumber="218"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00219" /><CodeLine lineNumber="219"></CodeLine>
<Link id="l00220" /><CodeLine lineNumber="220"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Not an interesting case when IsUnlikely is false -- we can not infer</span></CodeLine>
<Link id="l00221" /><CodeLine lineNumber="221"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// anything useful when:</span></CodeLine>
<Link id="l00222" /><CodeLine lineNumber="222"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// (1) We expect some phi output and the operand value matches it, or</span></CodeLine>
<Link id="l00223" /><CodeLine lineNumber="223"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// (2) We don&#39;t expect some phi output (i.e. the &quot;ExpectedValue&quot; has low</span></CodeLine>
<Link id="l00224" /><CodeLine lineNumber="224"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//     probability) and the operand value doesn&#39;t match that.</span></CodeLine>
<Link id="l00225" /><CodeLine lineNumber="225"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/apint">APInt</a> &amp;CurrentPhiValue = ApplyOperations(CI-&gt;<a href="/docs/api/classes/llvm/constantint/#af7e1934ed72a405ef073ea5f9bbe828e">getValue</a>());</span></CodeLine>
<Link id="l00226" /><CodeLine lineNumber="226"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ExpectedValueIsLikely == (ExpectedPhiValue == CurrentPhiValue))</span></CodeLine>
<Link id="l00227" /><CodeLine lineNumber="227"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00228" /><CodeLine lineNumber="228"></CodeLine>
<Link id="l00229" /><CodeLine lineNumber="229"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;BI = GetDomConditional(i);</span></CodeLine>
<Link id="l00230" /><CodeLine lineNumber="230"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!BI)</span></CodeLine>
<Link id="l00231" /><CodeLine lineNumber="231"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00232" /><CodeLine lineNumber="232"></CodeLine>
<Link id="l00233" /><CodeLine lineNumber="233"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/mdbuilder">MDBuilder</a> MDB(PhiDef-&gt;getContext());</span></CodeLine>
<Link id="l00234" /><CodeLine lineNumber="234"></CodeLine>
<Link id="l00235" /><CodeLine lineNumber="235"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// There are two situations in which an operand of the PhiDef comes</span></CodeLine>
<Link id="l00236" /><CodeLine lineNumber="236"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// from a given successor of a branch instruction BI.</span></CodeLine>
<Link id="l00237" /><CodeLine lineNumber="237"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// 1) When the incoming block of the operand is the successor block;</span></CodeLine>
<Link id="l00238" /><CodeLine lineNumber="238"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// 2) When the incoming block is BI&#39;s enclosing block and the</span></CodeLine>
<Link id="l00239" /><CodeLine lineNumber="239"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// successor is the PhiDef&#39;s enclosing block.</span></CodeLine>
<Link id="l00240" /><CodeLine lineNumber="240"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00241" /><CodeLine lineNumber="241"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Returns true if the operand which comes from OpndIncomingBB</span></CodeLine>
<Link id="l00242" /><CodeLine lineNumber="242"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// comes from outgoing edge of BI that leads to Succ block.</span></CodeLine>
<Link id="l00243" /><CodeLine lineNumber="243"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;OpndIncomingBB = PhiDef-&gt;getIncomingBlock(i);</span></CodeLine>
<Link id="l00244" /><CodeLine lineNumber="244"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> IsOpndComingFromSuccessor = &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Succ) &#123;</span></CodeLine>
<Link id="l00245" /><CodeLine lineNumber="245"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (OpndIncomingBB == Succ)</span></CodeLine>
<Link id="l00246" /><CodeLine lineNumber="246"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// If this successor is the incoming block for this</span></CodeLine>
<Link id="l00247" /><CodeLine lineNumber="247"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Phi operand, then this successor does lead to the Phi.</span></CodeLine>
<Link id="l00248" /><CodeLine lineNumber="248"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00249" /><CodeLine lineNumber="249"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (OpndIncomingBB == BI-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>() &amp;&amp; Succ == PhiDef-&gt;getParent())</span></CodeLine>
<Link id="l00250" /><CodeLine lineNumber="250"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Otherwise, if the edge is directly from the branch</span></CodeLine>
<Link id="l00251" /><CodeLine lineNumber="251"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// to the Phi, this successor is the one feeding this</span></CodeLine>
<Link id="l00252" /><CodeLine lineNumber="252"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Phi operand.</span></CodeLine>
<Link id="l00253" /><CodeLine lineNumber="253"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00254" /><CodeLine lineNumber="254"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00255" /><CodeLine lineNumber="255"><span class="doxyHighlight">    &#125;;</span></CodeLine>
<Link id="l00256" /><CodeLine lineNumber="256"><span class="doxyHighlight">    uint32&#95;t LikelyBranchWeightVal, UnlikelyBranchWeightVal;</span></CodeLine>
<Link id="l00257" /><CodeLine lineNumber="257"><span class="doxyHighlight">    std::tie(LikelyBranchWeightVal, UnlikelyBranchWeightVal) = <a href="#a4c4c33f562e18b287ca4ca5b0e0eedc7">getBranchWeight</a>(</span></CodeLine>
<Link id="l00258" /><CodeLine lineNumber="258"><span class="doxyHighlight">        Expect-&gt;<a href="/docs/api/classes/llvm/callbase/#a2b1ae7cf1bafdd43d1fee4c6ad0a2913">getCalledFunction</a>()-&gt;<a href="/docs/api/classes/llvm/function/#a4d0a7baab8d078065b2de10e3460892a">getIntrinsicID</a>(), Expect, 2);</span></CodeLine>
<Link id="l00259" /><CodeLine lineNumber="259"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!ExpectedValueIsLikely)</span></CodeLine>
<Link id="l00260" /><CodeLine lineNumber="260"><span class="doxyHighlight">      <a href="/docs/api/namespaces/std/#ab8424022895aee3e366fb9a32f2883cb">std::swap</a>(LikelyBranchWeightVal, UnlikelyBranchWeightVal);</span></CodeLine>
<Link id="l00261" /><CodeLine lineNumber="261"></CodeLine>
<Link id="l00262" /><CodeLine lineNumber="262"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IsOpndComingFromSuccessor(BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(1)))</span></CodeLine>
<Link id="l00263" /><CodeLine lineNumber="263"><span class="doxyHighlight">      BI-&gt;<a href="/docs/api/classes/llvm/instruction/#a9247a212ea89acc9573fa7e7f557eaba">setMetadata</a>(LLVMContext::MD&#95;prof,</span></CodeLine>
<Link id="l00264" /><CodeLine lineNumber="264"><span class="doxyHighlight">                      MDB.<a href="/docs/api/classes/llvm/mdbuilder/#a75043d12a76b84200e9ed593719dc5eb">createBranchWeights</a>(LikelyBranchWeightVal,</span></CodeLine>
<Link id="l00265" /><CodeLine lineNumber="265"><span class="doxyHighlight">                                              UnlikelyBranchWeightVal,</span></CodeLine>
<Link id="l00266" /><CodeLine lineNumber="266"><span class="doxyHighlight">                                              </span><span class="doxyHighlightComment">/&#42;IsExpected=&#42;/</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">));</span></CodeLine>
<Link id="l00267" /><CodeLine lineNumber="267"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IsOpndComingFromSuccessor(BI-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(0)))</span></CodeLine>
<Link id="l00268" /><CodeLine lineNumber="268"><span class="doxyHighlight">      BI-&gt;<a href="/docs/api/classes/llvm/instruction/#a9247a212ea89acc9573fa7e7f557eaba">setMetadata</a>(LLVMContext::MD&#95;prof,</span></CodeLine>
<Link id="l00269" /><CodeLine lineNumber="269"><span class="doxyHighlight">                      MDB.<a href="/docs/api/classes/llvm/mdbuilder/#a75043d12a76b84200e9ed593719dc5eb">createBranchWeights</a>(UnlikelyBranchWeightVal,</span></CodeLine>
<Link id="l00270" /><CodeLine lineNumber="270"><span class="doxyHighlight">                                              LikelyBranchWeightVal,</span></CodeLine>
<Link id="l00271" /><CodeLine lineNumber="271"><span class="doxyHighlight">                                              </span><span class="doxyHighlightComment">/&#42;IsExpected=&#42;/</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">));</span></CodeLine>
<Link id="l00272" /><CodeLine lineNumber="272"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00273" /><CodeLine lineNumber="273"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00274" /><CodeLine lineNumber="274"></CodeLine>
<Link id="l00275" /><CodeLine lineNumber="275"><span class="doxyHighlightComment">// Handle both BranchInst and SelectInst.</span></CodeLine>
<Link id="l00276" /><CodeLine lineNumber="276" lineLink="#a6ac9067dc7c125cd83855df3e480e04c"><span class="doxyHighlightKeyword">template</span><span class="doxyHighlight"> &lt;</span><span class="doxyHighlightKeyword">class</span><span class="doxyHighlight"> BrSelInst&gt; </span><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#a6ac9067dc7c125cd83855df3e480e04c">handleBrSelExpect</a>(BrSelInst &amp;BSI) &#123;</span></CodeLine>
<Link id="l00277" /><CodeLine lineNumber="277"></CodeLine>
<Link id="l00278" /><CodeLine lineNumber="278"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Handle non-optimized IR code like:</span></CodeLine>
<Link id="l00279" /><CodeLine lineNumber="279"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   %expval = call i64 @llvm.expect.i64(i64 %conv1, i64 1)</span></CodeLine>
<Link id="l00280" /><CodeLine lineNumber="280"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   %tobool = icmp ne i64 %expval, 0</span></CodeLine>
<Link id="l00281" /><CodeLine lineNumber="281"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   br i1 %tobool, label %if.then, label %if.end</span></CodeLine>
<Link id="l00282" /><CodeLine lineNumber="282"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00283" /><CodeLine lineNumber="283"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Or the following simpler case:</span></CodeLine>
<Link id="l00284" /><CodeLine lineNumber="284"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   %expval = call i1 @llvm.expect.i1(i1 %cmp, i1 1)</span></CodeLine>
<Link id="l00285" /><CodeLine lineNumber="285"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   br i1 %expval, label %if.then, label %if.end</span></CodeLine>
<Link id="l00286" /><CodeLine lineNumber="286"></CodeLine>
<Link id="l00287" /><CodeLine lineNumber="287"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42;CI;</span></CodeLine>
<Link id="l00288" /><CodeLine lineNumber="288"></CodeLine>
<Link id="l00289" /><CodeLine lineNumber="289"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/icmpinst">ICmpInst</a> &#42;CmpI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ICmpInst&gt;</a>(BSI.getCondition());</span></CodeLine>
<Link id="l00290" /><CodeLine lineNumber="290"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78b">CmpInst::Predicate</a> <a href="/docs/api/classes/predicate">Predicate</a>;</span></CodeLine>
<Link id="l00291" /><CodeLine lineNumber="291"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;CmpConstOperand = </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00292" /><CodeLine lineNumber="292"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CmpI) &#123;</span></CodeLine>
<Link id="l00293" /><CodeLine lineNumber="293"><span class="doxyHighlight">    CI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CallInst&gt;</a>(BSI.getCondition());</span></CodeLine>
<Link id="l00294" /><CodeLine lineNumber="294"><span class="doxyHighlight">    <a href="/docs/api/classes/predicate">Predicate</a> = <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78bac17897ebf2f6a6986280fc3bdf28a30a">CmpInst::ICMP&#95;NE</a>;</span></CodeLine>
<Link id="l00295" /><CodeLine lineNumber="295"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00296" /><CodeLine lineNumber="296"><span class="doxyHighlight">    <a href="/docs/api/classes/predicate">Predicate</a> = CmpI-&gt;<a href="/docs/api/classes/llvm/cmpinst/#aa7414ba9f658ff1287d22a4b8fe81bcb">getPredicate</a>();</span></CodeLine>
<Link id="l00297" /><CodeLine lineNumber="297"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/predicate">Predicate</a> != <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78bac17897ebf2f6a6986280fc3bdf28a30a">CmpInst::ICMP&#95;NE</a> &amp;&amp; <a href="/docs/api/classes/predicate">Predicate</a> != <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78baa719225e2de4059f93fd3209e1f48218">CmpInst::ICMP&#95;EQ</a>)</span></CodeLine>
<Link id="l00298" /><CodeLine lineNumber="298"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00299" /><CodeLine lineNumber="299"></CodeLine>
<Link id="l00300" /><CodeLine lineNumber="300"><span class="doxyHighlight">    CmpConstOperand = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ConstantInt&gt;</a>(CmpI-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(1));</span></CodeLine>
<Link id="l00301" /><CodeLine lineNumber="301"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CmpConstOperand)</span></CodeLine>
<Link id="l00302" /><CodeLine lineNumber="302"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00303" /><CodeLine lineNumber="303"><span class="doxyHighlight">    CI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CallInst&gt;</a>(CmpI-&gt;<a href="/docs/api/classes/llvm/user/#aa0a2cb1582d1cec317bd205085469ca1">getOperand</a>(0));</span></CodeLine>
<Link id="l00304" /><CodeLine lineNumber="304"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00305" /><CodeLine lineNumber="305"></CodeLine>
<Link id="l00306" /><CodeLine lineNumber="306"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CI)</span></CodeLine>
<Link id="l00307" /><CodeLine lineNumber="307"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00308" /><CodeLine lineNumber="308"></CodeLine>
<Link id="l00309" /><CodeLine lineNumber="309"><span class="doxyHighlight">  uint64&#95;t ValueComparedTo = 0;</span></CodeLine>
<Link id="l00310" /><CodeLine lineNumber="310"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CmpConstOperand) &#123;</span></CodeLine>
<Link id="l00311" /><CodeLine lineNumber="311"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CmpConstOperand-&gt;<a href="/docs/api/classes/llvm/constantint/#ab240d0d30dfa9b392ef9d813f3f9e4be">getBitWidth</a>() &gt; 64)</span></CodeLine>
<Link id="l00312" /><CodeLine lineNumber="312"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00313" /><CodeLine lineNumber="313"><span class="doxyHighlight">    ValueComparedTo = CmpConstOperand-&gt;<a href="/docs/api/classes/llvm/constantint/#ac09a21c371a9c535cbc13e8f82503aec">getZExtValue</a>();</span></CodeLine>
<Link id="l00314" /><CodeLine lineNumber="314"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00315" /><CodeLine lineNumber="315"></CodeLine>
<Link id="l00316" /><CodeLine lineNumber="316"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;Fn = CI-&gt;<a href="/docs/api/classes/llvm/callbase/#a2b1ae7cf1bafdd43d1fee4c6ad0a2913">getCalledFunction</a>();</span></CodeLine>
<Link id="l00317" /><CodeLine lineNumber="317"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Fn || (Fn-&gt;<a href="/docs/api/classes/llvm/function/#a4d0a7baab8d078065b2de10e3460892a">getIntrinsicID</a>() != Intrinsic::expect &amp;&amp;</span></CodeLine>
<Link id="l00318" /><CodeLine lineNumber="318"><span class="doxyHighlight">              Fn-&gt;<a href="/docs/api/classes/llvm/function/#a4d0a7baab8d078065b2de10e3460892a">getIntrinsicID</a>() != Intrinsic::expect&#95;with&#95;probability))</span></CodeLine>
<Link id="l00319" /><CodeLine lineNumber="319"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00320" /><CodeLine lineNumber="320"></CodeLine>
<Link id="l00321" /><CodeLine lineNumber="321"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;ArgValue = CI-&gt;<a href="/docs/api/classes/llvm/callbase/#aabd76e6a8a23a5af1ce4d3c310d88bcd">getArgOperand</a>(0);</span></CodeLine>
<Link id="l00322" /><CodeLine lineNumber="322"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/constantint">ConstantInt</a> &#42;ExpectedValue = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;ConstantInt&gt;</a>(CI-&gt;<a href="/docs/api/classes/llvm/callbase/#aabd76e6a8a23a5af1ce4d3c310d88bcd">getArgOperand</a>(1));</span></CodeLine>
<Link id="l00323" /><CodeLine lineNumber="323"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!ExpectedValue)</span></CodeLine>
<Link id="l00324" /><CodeLine lineNumber="324"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00325" /><CodeLine lineNumber="325"></CodeLine>
<Link id="l00326" /><CodeLine lineNumber="326"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/mdbuilder">MDBuilder</a> MDB(CI-&gt;<a href="/docs/api/classes/llvm/value/#ab3fc0225d8aaf8434026c3573f961f2c">getContext</a>());</span></CodeLine>
<Link id="l00327" /><CodeLine lineNumber="327"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42;<a href="/docs/api/classes/node">Node</a>;</span></CodeLine>
<Link id="l00328" /><CodeLine lineNumber="328"></CodeLine>
<Link id="l00329" /><CodeLine lineNumber="329"><span class="doxyHighlight">  uint32&#95;t LikelyBranchWeightVal, UnlikelyBranchWeightVal;</span></CodeLine>
<Link id="l00330" /><CodeLine lineNumber="330"><span class="doxyHighlight">  std::tie(LikelyBranchWeightVal, UnlikelyBranchWeightVal) =</span></CodeLine>
<Link id="l00331" /><CodeLine lineNumber="331"><span class="doxyHighlight">      <a href="#a4c4c33f562e18b287ca4ca5b0e0eedc7">getBranchWeight</a>(Fn-&gt;<a href="/docs/api/classes/llvm/function/#a4d0a7baab8d078065b2de10e3460892a">getIntrinsicID</a>(), CI, 2);</span></CodeLine>
<Link id="l00332" /><CodeLine lineNumber="332"></CodeLine>
<Link id="l00333" /><CodeLine lineNumber="333"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;uint32&#95;t, 4&gt;</a> ExpectedWeights;</span></CodeLine>
<Link id="l00334" /><CodeLine lineNumber="334"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> ((ExpectedValue-&gt;<a href="/docs/api/classes/llvm/constantint/#ac09a21c371a9c535cbc13e8f82503aec">getZExtValue</a>() == ValueComparedTo) ==</span></CodeLine>
<Link id="l00335" /><CodeLine lineNumber="335"><span class="doxyHighlight">      (<a href="/docs/api/classes/predicate">Predicate</a> == <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78baa719225e2de4059f93fd3209e1f48218">CmpInst::ICMP&#95;EQ</a>)) &#123;</span></CodeLine>
<Link id="l00336" /><CodeLine lineNumber="336"><span class="doxyHighlight">    <a href="/docs/api/classes/node">Node</a> = MDB.<a href="/docs/api/classes/llvm/mdbuilder/#a75043d12a76b84200e9ed593719dc5eb">createBranchWeights</a>(</span></CodeLine>
<Link id="l00337" /><CodeLine lineNumber="337"><span class="doxyHighlight">        LikelyBranchWeightVal, UnlikelyBranchWeightVal, </span><span class="doxyHighlightComment">/&#42;IsExpected=&#42;/</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00338" /><CodeLine lineNumber="338"><span class="doxyHighlight">    ExpectedWeights = &#123;LikelyBranchWeightVal, UnlikelyBranchWeightVal&#125;;</span></CodeLine>
<Link id="l00339" /><CodeLine lineNumber="339"><span class="doxyHighlight">  &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00340" /><CodeLine lineNumber="340"><span class="doxyHighlight">    <a href="/docs/api/classes/node">Node</a> = MDB.<a href="/docs/api/classes/llvm/mdbuilder/#a75043d12a76b84200e9ed593719dc5eb">createBranchWeights</a>(UnlikelyBranchWeightVal,</span></CodeLine>
<Link id="l00341" /><CodeLine lineNumber="341"><span class="doxyHighlight">                                   LikelyBranchWeightVal, </span><span class="doxyHighlightComment">/&#42;IsExpected=&#42;/</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00342" /><CodeLine lineNumber="342"><span class="doxyHighlight">    ExpectedWeights = &#123;UnlikelyBranchWeightVal, LikelyBranchWeightVal&#125;;</span></CodeLine>
<Link id="l00343" /><CodeLine lineNumber="343"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00344" /><CodeLine lineNumber="344"></CodeLine>
<Link id="l00345" /><CodeLine lineNumber="345"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (CmpI)</span></CodeLine>
<Link id="l00346" /><CodeLine lineNumber="346"><span class="doxyHighlight">    CmpI-&gt;<a href="/docs/api/classes/llvm/user/#a5fa9b8e1842b354f64c1ba6be0a4a17f">setOperand</a>(0, ArgValue);</span></CodeLine>
<Link id="l00347" /><CodeLine lineNumber="347"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00348" /><CodeLine lineNumber="348"><span class="doxyHighlight">    BSI.setCondition(ArgValue);</span></CodeLine>
<Link id="l00349" /><CodeLine lineNumber="349"></CodeLine>
<Link id="l00350" /><CodeLine lineNumber="350"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/misexpect/#a21de4796e674d8dabcea69242abe5005">misexpect::checkFrontendInstrumentation</a>(BSI, ExpectedWeights);</span></CodeLine>
<Link id="l00351" /><CodeLine lineNumber="351"></CodeLine>
<Link id="l00352" /><CodeLine lineNumber="352"><span class="doxyHighlight">  BSI.setMetadata(LLVMContext::MD&#95;prof, <a href="/docs/api/classes/node">Node</a>);</span></CodeLine>
<Link id="l00353" /><CodeLine lineNumber="353"></CodeLine>
<Link id="l00354" /><CodeLine lineNumber="354"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00355" /><CodeLine lineNumber="355"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00356" /><CodeLine lineNumber="356"></CodeLine>
<Link id="l00357" /><CodeLine lineNumber="357" lineLink="#a390dfaf67ef6d58f12f5a19ee938c60f"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#a390dfaf67ef6d58f12f5a19ee938c60f">handleBranchExpect</a>(<a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &amp;BI) &#123;</span></CodeLine>
<Link id="l00358" /><CodeLine lineNumber="358"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BI.<a href="/docs/api/classes/llvm/branchinst/#ad56f6a9b5cd05940017c4544df48bc30">isUnconditional</a>())</span></CodeLine>
<Link id="l00359" /><CodeLine lineNumber="359"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00360" /><CodeLine lineNumber="360"></CodeLine>
<Link id="l00361" /><CodeLine lineNumber="361"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="#a6ac9067dc7c125cd83855df3e480e04c">handleBrSelExpect&lt;BranchInst&gt;</a>(BI);</span></CodeLine>
<Link id="l00362" /><CodeLine lineNumber="362"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00363" /><CodeLine lineNumber="363"></CodeLine>
<Link id="l00364" /><CodeLine lineNumber="364" lineLink="#ad2fd6546e0f1cc42311962f4ad4b29cd"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#ad2fd6546e0f1cc42311962f4ad4b29cd">lowerExpectIntrinsic</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l00365" /><CodeLine lineNumber="365"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a> = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00366" /><CodeLine lineNumber="366"></CodeLine>
<Link id="l00367" /><CodeLine lineNumber="367"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &amp;BB : <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &#123;</span></CodeLine>
<Link id="l00368" /><CodeLine lineNumber="368"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Create &quot;block&#95;weights&quot; metadata.</span></CodeLine>
<Link id="l00369" /><CodeLine lineNumber="369"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;BI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BranchInst&gt;</a>(BB.getTerminator())) &#123;</span></CodeLine>
<Link id="l00370" /><CodeLine lineNumber="370"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a390dfaf67ef6d58f12f5a19ee938c60f">handleBranchExpect</a>(&#42;BI))</span></CodeLine>
<Link id="l00371" /><CodeLine lineNumber="371"><span class="doxyHighlight">        ExpectIntrinsicsHandled++;</span></CodeLine>
<Link id="l00372" /><CodeLine lineNumber="372"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/switchinst">SwitchInst</a> &#42;<a href="/docs/api/namespaces/llvm/si">SI</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;SwitchInst&gt;</a>(BB.getTerminator())) &#123;</span></CodeLine>
<Link id="l00373" /><CodeLine lineNumber="373"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#ab61a60817533b84f369d2623e0593ec7">handleSwitchExpect</a>(&#42;<a href="/docs/api/namespaces/llvm/si">SI</a>))</span></CodeLine>
<Link id="l00374" /><CodeLine lineNumber="374"><span class="doxyHighlight">        ExpectIntrinsicsHandled++;</span></CodeLine>
<Link id="l00375" /><CodeLine lineNumber="375"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00376" /><CodeLine lineNumber="376"></CodeLine>
<Link id="l00377" /><CodeLine lineNumber="377"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Remove llvm.expect intrinsics. Iterate backwards in order</span></CodeLine>
<Link id="l00378" /><CodeLine lineNumber="378"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// to process select instructions before the intrinsic gets</span></CodeLine>
<Link id="l00379" /><CodeLine lineNumber="379"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// removed.</span></CodeLine>
<Link id="l00380" /><CodeLine lineNumber="380"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;Inst : <a href="/docs/api/namespaces/llvm/#a3d2cdc4a0db233678e7141c9d6ea3419">llvm::make&#95;early&#95;inc&#95;range</a>(<a href="/docs/api/namespaces/llvm/#a6b0ac1fa4f05de76413c5e0ca6334035">llvm::reverse</a>(BB))) &#123;</span></CodeLine>
<Link id="l00381" /><CodeLine lineNumber="381"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/callinst">CallInst</a> &#42;CI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;CallInst&gt;</a>(&amp;Inst);</span></CodeLine>
<Link id="l00382" /><CodeLine lineNumber="382"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!CI) &#123;</span></CodeLine>
<Link id="l00383" /><CodeLine lineNumber="383"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/selectinst">SelectInst</a> &#42;<a href="/docs/api/namespaces/llvm/si">SI</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;SelectInst&gt;</a>(&amp;Inst)) &#123;</span></CodeLine>
<Link id="l00384" /><CodeLine lineNumber="384"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a6ac9067dc7c125cd83855df3e480e04c">handleBrSelExpect</a>(&#42;<a href="/docs/api/namespaces/llvm/si">SI</a>))</span></CodeLine>
<Link id="l00385" /><CodeLine lineNumber="385"><span class="doxyHighlight">            ExpectIntrinsicsHandled++;</span></CodeLine>
<Link id="l00386" /><CodeLine lineNumber="386"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l00387" /><CodeLine lineNumber="387"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00388" /><CodeLine lineNumber="388"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00389" /><CodeLine lineNumber="389"></CodeLine>
<Link id="l00390" /><CodeLine lineNumber="390"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/function">Function</a> &#42;Fn = CI-&gt;<a href="/docs/api/classes/llvm/callbase/#a2b1ae7cf1bafdd43d1fee4c6ad0a2913">getCalledFunction</a>();</span></CodeLine>
<Link id="l00391" /><CodeLine lineNumber="391"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Fn &amp;&amp; (Fn-&gt;<a href="/docs/api/classes/llvm/function/#a4d0a7baab8d078065b2de10e3460892a">getIntrinsicID</a>() == Intrinsic::expect ||</span></CodeLine>
<Link id="l00392" /><CodeLine lineNumber="392"><span class="doxyHighlight">                 Fn-&gt;<a href="/docs/api/classes/llvm/function/#a4d0a7baab8d078065b2de10e3460892a">getIntrinsicID</a>() == Intrinsic::expect&#95;with&#95;probability)) &#123;</span></CodeLine>
<Link id="l00393" /><CodeLine lineNumber="393"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Before erasing the llvm.expect, walk backward to find</span></CodeLine>
<Link id="l00394" /><CodeLine lineNumber="394"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// phi that define llvm.expect&#39;s first arg, and</span></CodeLine>
<Link id="l00395" /><CodeLine lineNumber="395"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// infer branch probability:</span></CodeLine>
<Link id="l00396" /><CodeLine lineNumber="396"><span class="doxyHighlight">        <a href="#aea5dd05a61257355d99f96d8d6dc9f94">handlePhiDef</a>(CI);</span></CodeLine>
<Link id="l00397" /><CodeLine lineNumber="397"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/value">Value</a> &#42;Exp = CI-&gt;<a href="/docs/api/classes/llvm/callbase/#aabd76e6a8a23a5af1ce4d3c310d88bcd">getArgOperand</a>(0);</span></CodeLine>
<Link id="l00398" /><CodeLine lineNumber="398"><span class="doxyHighlight">        CI-&gt;<a href="/docs/api/classes/llvm/value/#a3ab5fc45117b450e8bb04e564cb6e5f2">replaceAllUsesWith</a>(Exp);</span></CodeLine>
<Link id="l00399" /><CodeLine lineNumber="399"><span class="doxyHighlight">        CI-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</span></CodeLine>
<Link id="l00400" /><CodeLine lineNumber="400"><span class="doxyHighlight">        <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a> = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00401" /><CodeLine lineNumber="401"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00402" /><CodeLine lineNumber="402"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00403" /><CodeLine lineNumber="403"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00404" /><CodeLine lineNumber="404"></CodeLine>
<Link id="l00405" /><CodeLine lineNumber="405"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/groups/arcopt/#gaa57b1a4e6a1c79233913139635169cf1">Changed</a>;</span></CodeLine>
<Link id="l00406" /><CodeLine lineNumber="406"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00407" /><CodeLine lineNumber="407"></CodeLine>
<Link id="l00408" /><CodeLine lineNumber="408" lineLink="/docs/api/structs/llvm/lowerexpectintrinsicpass/#afb59e74c5181b5a9fa8d58780be0699a"><span class="doxyHighlight"><a href="/docs/api/classes/llvm/preservedanalyses">PreservedAnalyses</a> <a href="/docs/api/structs/llvm/lowerexpectintrinsicpass/#afb59e74c5181b5a9fa8d58780be0699a">LowerExpectIntrinsicPass::run</a>(<a href="/docs/api/classes/llvm/function">Function</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>,</span></CodeLine>
<Link id="l00409" /><CodeLine lineNumber="409"><span class="doxyHighlight">                                                <a href="/docs/api/namespaces/llvm/#adce09a5a0de0e3177eb00e932734af2f">FunctionAnalysisManager</a> &amp;) &#123;</span></CodeLine>
<Link id="l00410" /><CodeLine lineNumber="410"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#ad2fd6546e0f1cc42311962f4ad4b29cd">lowerExpectIntrinsic</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>))</span></CodeLine>
<Link id="l00411" /><CodeLine lineNumber="411"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/preservedanalyses/#a03797a73044a81cbc6a3409d6c72ee8f">PreservedAnalyses::none</a>();</span></CodeLine>
<Link id="l00412" /><CodeLine lineNumber="412"></CodeLine>
<Link id="l00413" /><CodeLine lineNumber="413"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/preservedanalyses/#a1258a1ff55557c27684010ebd7283712">PreservedAnalyses::all</a>();</span></CodeLine>
<Link id="l00414" /><CodeLine lineNumber="414"><span class="doxyHighlight">&#125;</span></CodeLine>

</ProgramListing>


</DoxygenPage>
