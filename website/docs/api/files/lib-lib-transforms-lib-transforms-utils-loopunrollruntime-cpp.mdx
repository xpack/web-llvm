---

# DO NOT EDIT!
# Automatically generated via docusaurus-plugin-doxygen by Doxygen.

slug: /api/files/lib/lib/transforms/lib/transforms/utils/loopunrollruntime-cpp
custom_edit_url: null
keywords:
  - doxygen
  - reference
  - file

---

import Link from '@docusaurus/Link'

import CodeLine from '@xpack/docusaurus-plugin-doxygen/components/CodeLine'
import DoxygenPage from '@xpack/docusaurus-plugin-doxygen/components/DoxygenPage'
import Highlight from '@xpack/docusaurus-plugin-doxygen/components/Highlight'
import IncludesList from '@xpack/docusaurus-plugin-doxygen/components/IncludesList'
import IncludesListItem from '@xpack/docusaurus-plugin-doxygen/components/IncludesListItem'
import MemberDefinition from '@xpack/docusaurus-plugin-doxygen/components/MemberDefinition'
import MembersIndex from '@xpack/docusaurus-plugin-doxygen/components/MembersIndex'
import MembersIndexItem from '@xpack/docusaurus-plugin-doxygen/components/MembersIndexItem'
import ProgramListing from '@xpack/docusaurus-plugin-doxygen/components/ProgramListing'
import SectionDefinition from '@xpack/docusaurus-plugin-doxygen/components/SectionDefinition'

import pluginConfig from '@site/docusaurus-plugin-doxygen-config.json'

# The `LoopUnrollRuntime.cpp` File Reference

<DoxygenPage pluginConfig={pluginConfig}>



## Included Headers

<IncludesList>
<IncludesListItem
  filePath="llvm/ADT/Statistic.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/DomTreeUpdater.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/domtreeupdater-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/InstructionSimplify.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/instructionsimplify-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/LoopIterator.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/loopiterator-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/ScalarEvolution.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/scalarevolution-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/ValueTracking.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/valuetracking-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/BasicBlock.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/basicblock-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Dominators.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/dominators-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/MDBuilder.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/mdbuilder-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Module.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/module-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/ProfDataUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/profdatautils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/CommandLine.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/Debug.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/debug-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/raw_ostream.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/raw-ostream-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/BasicBlockUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/basicblockutils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/Cloning.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/cloning-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/Local.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/local-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/LoopUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/looputils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/ScalarEvolutionExpander.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/scalarevolutionexpander-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/UnrollLoop.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/unrollloop-h"
  isLocal="true" />
</IncludesList>

## Functions Index

<MembersIndex>

<MembersIndexItem
  type="bool"
  name={<><a href="#a98b4edd31a148a751a95e80997f81c31">canProfitablyRuntimeUnrollMultiExitLoop</a> (Loop &#42;L, SmallVectorImpl&lt; BasicBlock &#42; &gt; &amp;OtherExits, BasicBlock &#42;LatchExit, bool UseEpilogRemainder)</>}>
Returns true if we can profitably unroll the multi-exit loop L. <a href="#a98b4edd31a148a751a95e80997f81c31">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/loop">Loop</a> &#42;</>}
  name={<><a href="#a399d7b7e2e6aec8e1ad80d3d73b7b1c8">CloneLoopBlocks</a> (Loop &#42;L, Value &#42;NewIter, const bool UseEpilogRemainder, const bool UnrollRemainder, BasicBlock &#42;InsertTop, BasicBlock &#42;InsertBot, BasicBlock &#42;Preheader, std::vector&lt; BasicBlock &#42; &gt; &amp;NewBlocks, LoopBlocksDFS &amp;LoopBlocks, ValueToValueMapTy &amp;VMap, DominatorTree &#42;DT, LoopInfo &#42;LI, unsigned Count)</>}>
Create a clone of the blocks in a loop and connect them together. <a href="#a399d7b7e2e6aec8e1ad80d3d73b7b1c8">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a4ebed10d3e842e81a2df6974c2fd3760">ConnectEpilog</a> (Loop &#42;L, Value &#42;ModVal, BasicBlock &#42;NewExit, BasicBlock &#42;Exit, BasicBlock &#42;PreHeader, BasicBlock &#42;EpilogPreHeader, BasicBlock &#42;NewPreHeader, ValueToValueMapTy &amp;VMap, DominatorTree &#42;DT, LoopInfo &#42;LI, bool PreserveLCSSA, ScalarEvolution &amp;SE, unsigned Count)</>}>
Connect the unrolling epilog code to the original loop. <a href="#a4ebed10d3e842e81a2df6974c2fd3760">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#af700561cb065af85122cd321d6c4b989">ConnectProlog</a> (Loop &#42;L, Value &#42;BECount, unsigned Count, BasicBlock &#42;PrologExit, BasicBlock &#42;OriginalLoopLatchExit, BasicBlock &#42;PreHeader, BasicBlock &#42;NewPreHeader, ValueToValueMapTy &amp;VMap, DominatorTree &#42;DT, LoopInfo &#42;LI, bool PreserveLCSSA, ScalarEvolution &amp;SE)</>}>
Connect the unrolling prolog code to the original loop. <a href="#af700561cb065af85122cd321d6c4b989">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/value">Value</a> &#42;</>}
  name={<><a href="#a7bab17532f2b606ad25679ed9e138c73">CreateTripRemainder</a> (IRBuilder&lt;&gt; &amp;B, Value &#42;BECount, Value &#42;TripCount, unsigned Count)</>}>
Calculate ModVal = (BECount + 1) % Count on the abstract integer domain accounting for the possibility of unsigned overflow in the 2s complement domain. <a href="#a7bab17532f2b606ad25679ed9e138c73">More...</a>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#a83a4a18d11086a64b8851319c00671a1">STATISTIC</a> (NumRuntimeUnrolled, &quot;Number of loops unrolled with run-time trip counts&quot;)</>}>
</MembersIndexItem>

</MembersIndex>

## Variables Index

<MembersIndex>

<MembersIndexItem
  type={<><a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> uint32&#95;t</>}
  name={<><a href="#ae905d898b267ca244e6d89fb1fba7c0e">EpilogHeaderWeights</a> = &#123;1, 127&#125;</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> uint32&#95;t</>}
  name={<><a href="#a71d5cd8a9f3f2982e334cb8ce9245e96">UnrolledLoopHeaderWeights</a> = &#123;1, 127&#125;</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#ae9c245e2a4a3f5a845a1cbe2922af167">UnrollRuntimeMultiExit</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a873b044e9706fd66860c6178f74a51f9">UnrollRuntimeOtherExitPredictable</a></>}>
</MembersIndexItem>

</MembersIndex>

## Defines Index

<MembersIndex>

<MembersIndexItem
  type="#define"
  name={<><a href="#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>&nbsp;&nbsp;&nbsp;&quot;loop-unroll&quot;</>}>
</MembersIndexItem>

</MembersIndex>


<SectionDefinition>

## Functions

### canProfitablyRuntimeUnrollMultiExitLoop() {#a98b4edd31a148a751a95e80997f81c31}

<MemberDefinition
  prototype={<>static bool canProfitablyRuntimeUnrollMultiExitLoop (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42; L, <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt; <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; &gt; &amp; OtherExits, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; LatchExit, bool UseEpilogRemainder)</>}
  labels = {["static"]}>
Returns true if we can profitably unroll the multi-exit loop L.

Currently, we return true only if UnrollRuntimeMultiExit is set to true.

Definition at line <a href="#l00464">464</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/loopunrollruntime-cpp">LoopUnrollRuntime.cpp</a>.
</MemberDefinition>

### CloneLoopBlocks() {#a399d7b7e2e6aec8e1ad80d3d73b7b1c8}

<MemberDefinition
  prototype={<>static Loop &#42; CloneLoopBlocks (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42; L, <a href="/docs/api/classes/llvm/value">Value</a> &#42; NewIter, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> bool UseEpilogRemainder, <a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> bool UnrollRemainder, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; InsertTop, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; InsertBot, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; Preheader, <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpupromotealloca-cpp/#ac760e37eba1d852d0a28011a1a0ce05f">std::vector</a>&lt; <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; &gt; &amp; NewBlocks, <a href="/docs/api/classes/llvm/loopblocksdfs">LoopBlocksDFS</a> &amp; LoopBlocks, <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp; VMap, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &#42; DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &#42; LI, unsigned Count)</>}
  labels = {["static"]}>
Create a clone of the blocks in a loop and connect them together.

A new loop will be created including all cloned blocks, and the iterator of the new loop switched to count NewIter down to 0. The cloned blocks should be inserted between InsertTop and InsertBot. InsertTop should be new preheader, InsertBot new loop exit. Returns the new cloned loop that is created.

Definition at line <a href="#l00338">338</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/loopunrollruntime-cpp">LoopUnrollRuntime.cpp</a>.
</MemberDefinition>

### ConnectEpilog() {#a4ebed10d3e842e81a2df6974c2fd3760}

<MemberDefinition
  prototype={<>static void ConnectEpilog (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42; L, <a href="/docs/api/classes/llvm/value">Value</a> &#42; ModVal, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; NewExit, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; Exit, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; PreHeader, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; EpilogPreHeader, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; NewPreHeader, <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp; VMap, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &#42; DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &#42; LI, bool PreserveLCSSA, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &amp; SE, unsigned Count)</>}
  labels = {["static"]}>
Connect the unrolling epilog code to the original loop.

The unrolling epilog code contains code to execute the &#39;extra&#39; iterations if the run-time trip count modulo the unroll count is non-zero.

This function performs the following:
<ul>
<li>Update PHI nodes at the unrolling loop exit and epilog loop exit</li>
<li>Create PHI nodes at the unrolling loop exit to combine values that exit the unrolling loop code and jump around it.</li>
<li>Update PHI operands in the epilog loop by the new PHI nodes</li>
<li>Branch around the epilog loop if extra iters (ModVal) is zero.</li>
</ul>

Definition at line <a href="#l00210">210</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/loopunrollruntime-cpp">LoopUnrollRuntime.cpp</a>.
</MemberDefinition>

### ConnectProlog() {#af700561cb065af85122cd321d6c4b989}

<MemberDefinition
  prototype={<>static void ConnectProlog (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42; L, <a href="/docs/api/classes/llvm/value">Value</a> &#42; BECount, unsigned Count, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; PrologExit, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; OriginalLoopLatchExit, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; PreHeader, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; NewPreHeader, <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp; VMap, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &#42; DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &#42; LI, bool PreserveLCSSA, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &amp; SE)</>}
  labels = {["static"]}>
Connect the unrolling prolog code to the original loop.

The unrolling prolog code contains code to execute the &#39;extra&#39; iterations if the run-time trip count modulo the unroll count is non-zero.

This function performs the following:
<ul>
<li>Create PHI nodes at prolog end block to combine values that exit the prolog code and jump around the prolog.</li>
<li>Add a PHI operand to a PHI node at the loop exit block for values that exit the prolog and go around the loop.</li>
<li>Branch around the original loop if the trip count is less than the unroll factor.</li>
</ul>

Definition at line <a href="#l00082">82</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/loopunrollruntime-cpp">LoopUnrollRuntime.cpp</a>.
</MemberDefinition>

### CreateTripRemainder() {#a7bab17532f2b606ad25679ed9e138c73}

<MemberDefinition
  prototype={<>static Value &#42; CreateTripRemainder (<a href="/docs/api/classes/llvm/irbuilder">IRBuilder</a>&lt;&gt; &amp; B, <a href="/docs/api/classes/llvm/value">Value</a> &#42; BECount, <a href="/docs/api/classes/llvm/value">Value</a> &#42; TripCount, unsigned Count)</>}
  labels = {["static"]}>
Calculate ModVal = (BECount + 1) % Count on the abstract integer domain accounting for the possibility of unsigned overflow in the 2s complement domain.

Preconditions: 1) TripCount = BECount + 1 (allowing overflow) 2) Log2(Count) &lt;= <a href="/docs/api/namespaces/llvm/#abee0df5f7f703bb4462aba260ba0a60f">BitWidth(BECount)</a>

Definition at line <a href="#l00516">516</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/loopunrollruntime-cpp">LoopUnrollRuntime.cpp</a>.
</MemberDefinition>

### STATISTIC() {#a83a4a18d11086a64b8851319c00671a1}

<MemberDefinition
  prototype={<>STATISTIC (NumRuntimeUnrolled, &quot;Number of <a href="/docs/api/files/lib/lib/analysis/loopinfo-cpp/#a49ae40a9c91d665793aaed656c26ca30">loops</a> unrolled with run-time trip counts&quot;)</>}>

Definition at line <a href="#l00048">48</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/loopunrollruntime-cpp">LoopUnrollRuntime.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Variables

### EpilogHeaderWeights {#ae905d898b267ca244e6d89fb1fba7c0e}

<MemberDefinition
  prototype={<>const uint32&#95;t EpilogHeaderWeights&#91;&#93; = &#123;1, 127&#125;</>}
  labels = {["static"]}>

Definition at line <a href="#l00067">67</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/loopunrollruntime-cpp">LoopUnrollRuntime.cpp</a>.
</MemberDefinition>

### UnrolledLoopHeaderWeights {#a71d5cd8a9f3f2982e334cb8ce9245e96}

<MemberDefinition
  prototype={<>const uint32&#95;t UnrolledLoopHeaderWeights&#91;&#93; = &#123;1, 127&#125;</>}
  labels = {["static"]}>

Definition at line <a href="#l00062">62</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/loopunrollruntime-cpp">LoopUnrollRuntime.cpp</a>.
</MemberDefinition>

### UnrollRuntimeMultiExit {#ae9c245e2a4a3f5a845a1cbe2922af167}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; UnrollRuntimeMultiExit(&quot;unroll-runtime-multi-exit&quot;, cl::init(false), cl::Hidden, cl::desc(&quot;Allow runtime unrolling for loops with multiple exits, when &quot; &quot;epilog is generated&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00050">50</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/loopunrollruntime-cpp">LoopUnrollRuntime.cpp</a>.
</MemberDefinition>

### UnrollRuntimeOtherExitPredictable {#a873b044e9706fd66860c6178f74a51f9}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; UnrollRuntimeOtherExitPredictable(&quot;unroll-runtime-other-exit-predictable&quot;, cl::init(false), cl::Hidden, cl::desc(&quot;Assume the non latch exit block to be predictable&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00054">54</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/loopunrollruntime-cpp">LoopUnrollRuntime.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Defines

### DEBUG&#95;TYPE {#ad78e062f62e0d6e453941fb4ca843e4d}

<MemberDefinition
  prototype={<>#define DEBUG&#95;TYPE&nbsp;&nbsp;&nbsp;&quot;loop-unroll&quot;</>}>

Definition at line <a href="#l00046">46</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/loopunrollruntime-cpp">LoopUnrollRuntime.cpp</a>.
</MemberDefinition>

</SectionDefinition>

## File Listing

The file content with the documentation metadata removed is:

<ProgramListing>

<Link id="l00001" /><CodeLine lineNumber="1"><Highlight kind="comment">//===-- UnrollLoopRuntime.cpp - Runtime Loop unrolling utilities ----------===//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00002" /><CodeLine lineNumber="2"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00003" /><CodeLine lineNumber="3"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00004" /><CodeLine lineNumber="4"><Highlight kind="normal"></Highlight><Highlight kind="comment">// See https://llvm.org/LICENSE.txt for license information.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00005" /><CodeLine lineNumber="5"><Highlight kind="normal"></Highlight><Highlight kind="comment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00006" /><CodeLine lineNumber="6"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00007" /><CodeLine lineNumber="7"><Highlight kind="normal"></Highlight><Highlight kind="comment">//===----------------------------------------------------------------------===//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00008" /><CodeLine lineNumber="8"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00009" /><CodeLine lineNumber="9"><Highlight kind="normal"></Highlight><Highlight kind="comment">// This file implements some loop unrolling utilities for loops with run-time</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00010" /><CodeLine lineNumber="10"><Highlight kind="normal"></Highlight><Highlight kind="comment">// trip counts.  See LoopUnroll.cpp for unrolling loops with compile-time</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00011" /><CodeLine lineNumber="11"><Highlight kind="normal"></Highlight><Highlight kind="comment">// trip counts.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00012" /><CodeLine lineNumber="12"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00013" /><CodeLine lineNumber="13"><Highlight kind="normal"></Highlight><Highlight kind="comment">// The functions in this file are used to generate extra code when the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00014" /><CodeLine lineNumber="14"><Highlight kind="normal"></Highlight><Highlight kind="comment">// run-time trip count modulo the unroll factor is not 0  When this is the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00015" /><CodeLine lineNumber="15"><Highlight kind="normal"></Highlight><Highlight kind="comment">// case, we need to generate code to execute these &#39;left over&#39; iterations.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00016" /><CodeLine lineNumber="16"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00017" /><CodeLine lineNumber="17"><Highlight kind="normal"></Highlight><Highlight kind="comment">// The current strategy generates an if-then-else sequence prior to the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00018" /><CodeLine lineNumber="18"><Highlight kind="normal"></Highlight><Highlight kind="comment">// unrolled loop to execute the &#39;left over&#39; iterations before or after the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00019" /><CodeLine lineNumber="19"><Highlight kind="normal"></Highlight><Highlight kind="comment">// unrolled loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00020" /><CodeLine lineNumber="20"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00021" /><CodeLine lineNumber="21"><Highlight kind="normal"></Highlight><Highlight kind="comment">//===----------------------------------------------------------------------===//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00022" /><CodeLine lineNumber="22"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00023" /><CodeLine lineNumber="23"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h">llvm/ADT/Statistic.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00024" /><CodeLine lineNumber="24"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/domtreeupdater-h">llvm/Analysis/DomTreeUpdater.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00025" /><CodeLine lineNumber="25"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/instructionsimplify-h">llvm/Analysis/InstructionSimplify.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00026" /><CodeLine lineNumber="26"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/loopiterator-h">llvm/Analysis/LoopIterator.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00027" /><CodeLine lineNumber="27"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/scalarevolution-h">llvm/Analysis/ScalarEvolution.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00028" /><CodeLine lineNumber="28"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/valuetracking-h">llvm/Analysis/ValueTracking.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00029" /><CodeLine lineNumber="29"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/basicblock-h">llvm/IR/BasicBlock.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00030" /><CodeLine lineNumber="30"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/dominators-h">llvm/IR/Dominators.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00031" /><CodeLine lineNumber="31"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/mdbuilder-h">llvm/IR/MDBuilder.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00032" /><CodeLine lineNumber="32"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/module-h">llvm/IR/Module.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00033" /><CodeLine lineNumber="33"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/profdatautils-h">llvm/IR/ProfDataUtils.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00034" /><CodeLine lineNumber="34"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h">llvm/Support/CommandLine.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00035" /><CodeLine lineNumber="35"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h">llvm/Support/Debug.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00036" /><CodeLine lineNumber="36"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/raw-ostream-h">llvm/Support/raw&#95;ostream.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00037" /><CodeLine lineNumber="37"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/basicblockutils-h">llvm/Transforms/Utils/BasicBlockUtils.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00038" /><CodeLine lineNumber="38"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/cloning-h">llvm/Transforms/Utils/Cloning.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00039" /><CodeLine lineNumber="39"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/local-h">llvm/Transforms/Utils/Local.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00040" /><CodeLine lineNumber="40"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/looputils-h">llvm/Transforms/Utils/LoopUtils.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00041" /><CodeLine lineNumber="41"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/scalarevolutionexpander-h">llvm/Transforms/Utils/ScalarEvolutionExpander.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00042" /><CodeLine lineNumber="42"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/unrollloop-h">llvm/Transforms/Utils/UnrollLoop.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00043" /><CodeLine lineNumber="43"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00044" /><CodeLine lineNumber="44"><Highlight kind="normal"></Highlight><Highlight kind="keyword">using namespace </Highlight><Highlight kind="normal"><a href="/docs/api/namespaces/llvm">llvm</a>;</Highlight></CodeLine>
<Link id="l00045" /><CodeLine lineNumber="45"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00046" /><CodeLine lineNumber="46" lineLink="#ad78e062f62e0d6e453941fb4ca843e4d"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#define DEBUG&#95;TYPE &quot;loop-unroll&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00047" /><CodeLine lineNumber="47"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00048" /><CodeLine lineNumber="48" lineLink="#a83a4a18d11086a64b8851319c00671a1"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumRuntimeUnrolled,</Highlight></CodeLine>
<Link id="l00049" /><CodeLine lineNumber="49"><Highlight kind="normal">          </Highlight><Highlight kind="stringliteral">&quot;Number of loops unrolled with run-time trip counts&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00050" /><CodeLine lineNumber="50" lineLink="#ae9c245e2a4a3f5a845a1cbe2922af167"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#ae9c245e2a4a3f5a845a1cbe2922af167">UnrollRuntimeMultiExit</a>(</Highlight></CodeLine>
<Link id="l00051" /><CodeLine lineNumber="51"><Highlight kind="normal">    </Highlight><Highlight kind="stringliteral">&quot;unroll-runtime-multi-exit&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</Highlight></CodeLine>
<Link id="l00052" /><CodeLine lineNumber="52"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Allow runtime unrolling for loops with multiple exits, when &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00053" /><CodeLine lineNumber="53"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;epilog is generated&quot;</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00054" /><CodeLine lineNumber="54" lineLink="#a873b044e9706fd66860c6178f74a51f9"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a873b044e9706fd66860c6178f74a51f9">UnrollRuntimeOtherExitPredictable</a>(</Highlight></CodeLine>
<Link id="l00055" /><CodeLine lineNumber="55"><Highlight kind="normal">    </Highlight><Highlight kind="stringliteral">&quot;unroll-runtime-other-exit-predictable&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</Highlight></CodeLine>
<Link id="l00056" /><CodeLine lineNumber="56"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Assume the non latch exit block to be predictable&quot;</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00057" /><CodeLine lineNumber="57"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00058" /><CodeLine lineNumber="58"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Probability that the loop trip count is so small that after the prolog</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00059" /><CodeLine lineNumber="59"><Highlight kind="normal"></Highlight><Highlight kind="comment">// we do not enter the unrolled loop at all.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00060" /><CodeLine lineNumber="60"><Highlight kind="normal"></Highlight><Highlight kind="comment">// It is unlikely that the loop trip count is smaller than the unroll factor;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00061" /><CodeLine lineNumber="61"><Highlight kind="normal"></Highlight><Highlight kind="comment">// other than that, the choice of constant is not tuned yet.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00062" /><CodeLine lineNumber="62" lineLink="#a71d5cd8a9f3f2982e334cb8ce9245e96"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> uint32&#95;t <a href="#a71d5cd8a9f3f2982e334cb8ce9245e96">UnrolledLoopHeaderWeights</a>&#91;&#93; = &#123;1, 127&#125;;</Highlight></CodeLine>
<Link id="l00063" /><CodeLine lineNumber="63"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Probability that the loop trip count is so small that we skip the unrolled</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00064" /><CodeLine lineNumber="64"><Highlight kind="normal"></Highlight><Highlight kind="comment">// loop completely and immediately enter the epilogue loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00065" /><CodeLine lineNumber="65"><Highlight kind="normal"></Highlight><Highlight kind="comment">// It is unlikely that the loop trip count is smaller than the unroll factor;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00066" /><CodeLine lineNumber="66"><Highlight kind="normal"></Highlight><Highlight kind="comment">// other than that, the choice of constant is not tuned yet.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00067" /><CodeLine lineNumber="67" lineLink="#ae905d898b267ca244e6d89fb1fba7c0e"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> uint32&#95;t <a href="#ae905d898b267ca244e6d89fb1fba7c0e">EpilogHeaderWeights</a>&#91;&#93; = &#123;1, 127&#125;;</Highlight></CodeLine>
<Link id="l00068" /><CodeLine lineNumber="68"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00069" /><CodeLine lineNumber="69"><Highlight kind="comment">/// Connect the unrolling prolog code to the original loop.</Highlight></CodeLine>
<Link id="l00070" /><CodeLine lineNumber="70"><Highlight kind="comment">/// The unrolling prolog code contains code to execute the</Highlight></CodeLine>
<Link id="l00071" /><CodeLine lineNumber="71"><Highlight kind="comment">/// &#39;extra&#39; iterations if the run-time trip count modulo the</Highlight></CodeLine>
<Link id="l00072" /><CodeLine lineNumber="72"><Highlight kind="comment">/// unroll count is non-zero.</Highlight></CodeLine>
<Link id="l00073" /><CodeLine lineNumber="73"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00074" /><CodeLine lineNumber="74"><Highlight kind="comment">/// This function performs the following:</Highlight></CodeLine>
<Link id="l00075" /><CodeLine lineNumber="75"><Highlight kind="comment">/// - Create PHI nodes at prolog end block to combine values</Highlight></CodeLine>
<Link id="l00076" /><CodeLine lineNumber="76"><Highlight kind="comment">///   that exit the prolog code and jump around the prolog.</Highlight></CodeLine>
<Link id="l00077" /><CodeLine lineNumber="77"><Highlight kind="comment">/// - Add a PHI operand to a PHI node at the loop exit block</Highlight></CodeLine>
<Link id="l00078" /><CodeLine lineNumber="78"><Highlight kind="comment">///   for values that exit the prolog and go around the loop.</Highlight></CodeLine>
<Link id="l00079" /><CodeLine lineNumber="79"><Highlight kind="comment">/// - Branch around the original loop if the trip count is less</Highlight></CodeLine>
<Link id="l00080" /><CodeLine lineNumber="80"><Highlight kind="comment">///   than the unroll factor.</Highlight></CodeLine>
<Link id="l00081" /><CodeLine lineNumber="81"><Highlight kind="comment">///</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00082" /><CodeLine lineNumber="82" lineLink="#af700561cb065af85122cd321d6c4b989"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#af700561cb065af85122cd321d6c4b989">ConnectProlog</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L, <a href="/docs/api/classes/llvm/value">Value</a> &#42;BECount, </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a>,</Highlight></CodeLine>
<Link id="l00083" /><CodeLine lineNumber="83"><Highlight kind="normal">                          <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;PrologExit,</Highlight></CodeLine>
<Link id="l00084" /><CodeLine lineNumber="84"><Highlight kind="normal">                          <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;OriginalLoopLatchExit,</Highlight></CodeLine>
<Link id="l00085" /><CodeLine lineNumber="85"><Highlight kind="normal">                          <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;PreHeader, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewPreHeader,</Highlight></CodeLine>
<Link id="l00086" /><CodeLine lineNumber="86"><Highlight kind="normal">                          <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp;VMap, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &#42;DT,</Highlight></CodeLine>
<Link id="l00087" /><CodeLine lineNumber="87"><Highlight kind="normal">                          <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &#42;LI, </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> PreserveLCSSA,</Highlight></CodeLine>
<Link id="l00088" /><CodeLine lineNumber="88"><Highlight kind="normal">                          <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &amp;SE) &#123;</Highlight></CodeLine>
<Link id="l00089" /><CodeLine lineNumber="89"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Loop structure should be the following:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00090" /><CodeLine lineNumber="90"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Preheader</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00091" /><CodeLine lineNumber="91"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//  PrologHeader</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00092" /><CodeLine lineNumber="92"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//  ...</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00093" /><CodeLine lineNumber="93"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//  PrologLatch</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00094" /><CodeLine lineNumber="94"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//  PrologExit</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00095" /><CodeLine lineNumber="95"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   NewPreheader</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00096" /><CodeLine lineNumber="96"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//    Header</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00097" /><CodeLine lineNumber="97"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//    ...</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00098" /><CodeLine lineNumber="98"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//    Latch</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00099" /><CodeLine lineNumber="99"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//      LatchExit</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00100" /><CodeLine lineNumber="100"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Latch = L-&gt;getLoopLatch();</Highlight></CodeLine>
<Link id="l00101" /><CodeLine lineNumber="101"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Latch &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Loop must have a latch&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00102" /><CodeLine lineNumber="102"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;PrologLatch = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(VMap&#91;Latch&#93;);</Highlight></CodeLine>
<Link id="l00103" /><CodeLine lineNumber="103"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00104" /><CodeLine lineNumber="104"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Create a PHI node for each outgoing value from the original loop</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00105" /><CodeLine lineNumber="105"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// (which means it is an outgoing value from the prolog code too).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00106" /><CodeLine lineNumber="106"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The new PHI node is inserted in the prolog end basic block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00107" /><CodeLine lineNumber="107"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The new PHI node value is added as an operand of a PHI node in either</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00108" /><CodeLine lineNumber="108"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the loop header or the loop exit block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00109" /><CodeLine lineNumber="109"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Succ : <a href="/docs/api/namespaces/llvm/#a26e2a938b431eaa6eca2beaa96410c9d">successors</a>(Latch)) &#123;</Highlight></CodeLine>
<Link id="l00110" /><CodeLine lineNumber="110"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/phinode">PHINode</a> &amp;PN : Succ-&gt;phis()) &#123;</Highlight></CodeLine>
<Link id="l00111" /><CodeLine lineNumber="111"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Add a new PHI node to the prolog end block and add the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00112" /><CodeLine lineNumber="112"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// appropriate incoming values.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00113" /><CodeLine lineNumber="113"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// TODO: This code assumes that the PrologExit (or the LatchExit block for</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00114" /><CodeLine lineNumber="114"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// prolog loop) contains only one predecessor from the loop, i.e. the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00115" /><CodeLine lineNumber="115"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// PrologLatch. When supporting multiple-exiting block loops, we can have</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00116" /><CodeLine lineNumber="116"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// two or more blocks that have the LatchExit as the target in the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00117" /><CodeLine lineNumber="117"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// original loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00118" /><CodeLine lineNumber="118"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;NewPN = <a href="/docs/api/classes/llvm/phinode/#af4aba918a76ca15bde1be3e14572e475">PHINode::Create</a>(PN.getType(), 2, PN.getName() + </Highlight><Highlight kind="stringliteral">&quot;.unr&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00119" /><CodeLine lineNumber="119"><Highlight kind="normal">      NewPN-&gt;<a href="/docs/api/classes/llvm/instruction/#a482498a1c760122fd33c7fc8190dd277">insertBefore</a>(PrologExit-&gt;<a href="/docs/api/classes/llvm/basicblock/#a362b5e6097732cbc0d2fb555a1f73400">getFirstNonPHIIt</a>());</Highlight></CodeLine>
<Link id="l00120" /><CodeLine lineNumber="120"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Adding a value to the new PHI node from the original loop preheader.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00121" /><CodeLine lineNumber="121"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// This is the value that skips all the prolog code.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00122" /><CodeLine lineNumber="122"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L-&gt;contains(&amp;PN)) &#123;</Highlight></CodeLine>
<Link id="l00123" /><CodeLine lineNumber="123"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Succ is loop header.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00124" /><CodeLine lineNumber="124"><Highlight kind="normal">        NewPN-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(PN.getIncomingValueForBlock(NewPreHeader),</Highlight></CodeLine>
<Link id="l00125" /><CodeLine lineNumber="125"><Highlight kind="normal">                           PreHeader);</Highlight></CodeLine>
<Link id="l00126" /><CodeLine lineNumber="126"><Highlight kind="normal">      &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00127" /><CodeLine lineNumber="127"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Succ is LatchExit.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00128" /><CodeLine lineNumber="128"><Highlight kind="normal">        NewPN-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(<a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(PN.getType()), PreHeader);</Highlight></CodeLine>
<Link id="l00129" /><CodeLine lineNumber="129"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00130" /><CodeLine lineNumber="130"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00131" /><CodeLine lineNumber="131"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;V = PN.getIncomingValueForBlock(Latch);</Highlight></CodeLine>
<Link id="l00132" /><CodeLine lineNumber="132"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(V)) &#123;</Highlight></CodeLine>
<Link id="l00133" /><CodeLine lineNumber="133"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L-&gt;contains(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) &#123;</Highlight></CodeLine>
<Link id="l00134" /><CodeLine lineNumber="134"><Highlight kind="normal">          V = VMap.<a href="/docs/api/classes/llvm/valuemap/#a15f92579a5fc316dab8cd1fad51015ef">lookup</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</Highlight></CodeLine>
<Link id="l00135" /><CodeLine lineNumber="135"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l00136" /><CodeLine lineNumber="136"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00137" /><CodeLine lineNumber="137"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Adding a value to the new PHI node from the last prolog block</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00138" /><CodeLine lineNumber="138"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// that was created.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00139" /><CodeLine lineNumber="139"><Highlight kind="normal">      NewPN-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(V, PrologLatch);</Highlight></CodeLine>
<Link id="l00140" /><CodeLine lineNumber="140"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00141" /><CodeLine lineNumber="141"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Update the existing PHI node operand with the value from the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00142" /><CodeLine lineNumber="142"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// new PHI node.  How this is done depends on if the existing</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00143" /><CodeLine lineNumber="143"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// PHI node is in the original loop block, or the exit block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00144" /><CodeLine lineNumber="144"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L-&gt;contains(&amp;PN))</Highlight></CodeLine>
<Link id="l00145" /><CodeLine lineNumber="145"><Highlight kind="normal">        PN.setIncomingValueForBlock(NewPreHeader, NewPN);</Highlight></CodeLine>
<Link id="l00146" /><CodeLine lineNumber="146"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00147" /><CodeLine lineNumber="147"><Highlight kind="normal">        PN.addIncoming(NewPN, PrologExit);</Highlight></CodeLine>
<Link id="l00148" /><CodeLine lineNumber="148"><Highlight kind="normal">      SE.<a href="/docs/api/classes/llvm/scalarevolution/#aa6dc58a1259941c7a17142e6103d059e">forgetLcssaPhiWithNewPredecessor</a>(L, &amp;PN);</Highlight></CodeLine>
<Link id="l00149" /><CodeLine lineNumber="149"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00150" /><CodeLine lineNumber="150"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00151" /><CodeLine lineNumber="151"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00152" /><CodeLine lineNumber="152"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Make sure that created prolog loop is in simplified form</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00153" /><CodeLine lineNumber="153"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 4&gt;</a> PrologExitPreds;</Highlight></CodeLine>
<Link id="l00154" /><CodeLine lineNumber="154"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;PrologLoop = LI-&gt;<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(PrologLatch);</Highlight></CodeLine>
<Link id="l00155" /><CodeLine lineNumber="155"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (PrologLoop) &#123;</Highlight></CodeLine>
<Link id="l00156" /><CodeLine lineNumber="156"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;PredBB : <a href="/docs/api/namespaces/llvm/#acb22fb04083152eee862457e42e8dc31">predecessors</a>(PrologExit))</Highlight></CodeLine>
<Link id="l00157" /><CodeLine lineNumber="157"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (PrologLoop-&gt;<a href="/docs/api/classes/llvm/loopbase/#a04337b572d34ea413c35dbac5d75530b">contains</a>(PredBB))</Highlight></CodeLine>
<Link id="l00158" /><CodeLine lineNumber="158"><Highlight kind="normal">        PrologExitPreds.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(PredBB);</Highlight></CodeLine>
<Link id="l00159" /><CodeLine lineNumber="159"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00160" /><CodeLine lineNumber="160"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a9d391b6acc6d90c9b8a8442324b1aa6f">SplitBlockPredecessors</a>(PrologExit, PrologExitPreds, </Highlight><Highlight kind="stringliteral">&quot;.unr-lcssa&quot;</Highlight><Highlight kind="normal">, DT, LI,</Highlight></CodeLine>
<Link id="l00161" /><CodeLine lineNumber="161"><Highlight kind="normal">                           </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">, PreserveLCSSA);</Highlight></CodeLine>
<Link id="l00162" /><CodeLine lineNumber="162"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00163" /><CodeLine lineNumber="163"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00164" /><CodeLine lineNumber="164"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Create a branch around the original loop, which is taken if there are no</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00165" /><CodeLine lineNumber="165"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// iterations remaining to be executed after running the prologue.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00166" /><CodeLine lineNumber="166"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;InsertPt = PrologExit-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>();</Highlight></CodeLine>
<Link id="l00167" /><CodeLine lineNumber="167"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>(InsertPt);</Highlight></CodeLine>
<Link id="l00168" /><CodeLine lineNumber="168"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00169" /><CodeLine lineNumber="169"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a> != 0 &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;nonsensical Count!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00170" /><CodeLine lineNumber="170"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00171" /><CodeLine lineNumber="171"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If BECount &lt;u (Count - 1) then (BECount + 1) % Count == (BECount + 1)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00172" /><CodeLine lineNumber="172"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// This means %xtraiter is (BECount + 1) and all of the iterations of this</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00173" /><CodeLine lineNumber="173"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// loop were executed by the prologue.  Note that if BECount &lt;u (Count - 1)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00174" /><CodeLine lineNumber="174"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// then (BECount + 1) cannot unsigned-overflow.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00175" /><CodeLine lineNumber="175"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;BrLoopExit =</Highlight></CodeLine>
<Link id="l00176" /><CodeLine lineNumber="176"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>.CreateICmpULT(BECount, ConstantInt::get(BECount-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>(), <a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a> - 1));</Highlight></CodeLine>
<Link id="l00177" /><CodeLine lineNumber="177"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Split the exit to maintain loop canonicalization guarantees</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00178" /><CodeLine lineNumber="178"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 4&gt;</a> Preds(<a href="/docs/api/namespaces/llvm/#acb22fb04083152eee862457e42e8dc31">predecessors</a>(OriginalLoopLatchExit));</Highlight></CodeLine>
<Link id="l00179" /><CodeLine lineNumber="179"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#a9d391b6acc6d90c9b8a8442324b1aa6f">SplitBlockPredecessors</a>(OriginalLoopLatchExit, Preds, </Highlight><Highlight kind="stringliteral">&quot;.unr-lcssa&quot;</Highlight><Highlight kind="normal">, DT, LI,</Highlight></CodeLine>
<Link id="l00180" /><CodeLine lineNumber="180"><Highlight kind="normal">                         </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">, PreserveLCSSA);</Highlight></CodeLine>
<Link id="l00181" /><CodeLine lineNumber="181"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Add the branch to the exit block (around the unrolled loop)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00182" /><CodeLine lineNumber="182"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42;BranchWeights = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00183" /><CodeLine lineNumber="183"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#add2fce2ce0e32b20e41b0aa9f8ca70c2">hasBranchWeightMD</a>(&#42;Latch-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>())) &#123;</Highlight></CodeLine>
<Link id="l00184" /><CodeLine lineNumber="184"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Assume loop is nearly always entered.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00185" /><CodeLine lineNumber="185"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/mdbuilder">MDBuilder</a> MDB(<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>.getContext());</Highlight></CodeLine>
<Link id="l00186" /><CodeLine lineNumber="186"><Highlight kind="normal">    BranchWeights = MDB.<a href="/docs/api/classes/llvm/mdbuilder/#a75043d12a76b84200e9ed593719dc5eb">createBranchWeights</a>(<a href="#a71d5cd8a9f3f2982e334cb8ce9245e96">UnrolledLoopHeaderWeights</a>);</Highlight></CodeLine>
<Link id="l00187" /><CodeLine lineNumber="187"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00188" /><CodeLine lineNumber="188"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>.CreateCondBr(BrLoopExit, OriginalLoopLatchExit, NewPreHeader,</Highlight></CodeLine>
<Link id="l00189" /><CodeLine lineNumber="189"><Highlight kind="normal">                 BranchWeights);</Highlight></CodeLine>
<Link id="l00190" /><CodeLine lineNumber="190"><Highlight kind="normal">  InsertPt-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</Highlight></CodeLine>
<Link id="l00191" /><CodeLine lineNumber="191"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DT) &#123;</Highlight></CodeLine>
<Link id="l00192" /><CodeLine lineNumber="192"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;NewDom = DT-&gt;<a href="/docs/api/classes/llvm/dominatortree/#a2ec50ab2c78eff965caf3da71cd08be4">findNearestCommonDominator</a>(OriginalLoopLatchExit,</Highlight></CodeLine>
<Link id="l00193" /><CodeLine lineNumber="193"><Highlight kind="normal">                                                  PrologExit);</Highlight></CodeLine>
<Link id="l00194" /><CodeLine lineNumber="194"><Highlight kind="normal">    DT-&gt;<a href="/docs/api/classes/llvm/dominatortreebase/#a2881c226e1c102190d54c3b664330aba">changeImmediateDominator</a>(OriginalLoopLatchExit, NewDom);</Highlight></CodeLine>
<Link id="l00195" /><CodeLine lineNumber="195"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00196" /><CodeLine lineNumber="196"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00197" /><CodeLine lineNumber="197"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00198" /><CodeLine lineNumber="198"><Highlight kind="comment">/// Connect the unrolling epilog code to the original loop.</Highlight></CodeLine>
<Link id="l00199" /><CodeLine lineNumber="199"><Highlight kind="comment">/// The unrolling epilog code contains code to execute the</Highlight></CodeLine>
<Link id="l00200" /><CodeLine lineNumber="200"><Highlight kind="comment">/// &#39;extra&#39; iterations if the run-time trip count modulo the</Highlight></CodeLine>
<Link id="l00201" /><CodeLine lineNumber="201"><Highlight kind="comment">/// unroll count is non-zero.</Highlight></CodeLine>
<Link id="l00202" /><CodeLine lineNumber="202"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00203" /><CodeLine lineNumber="203"><Highlight kind="comment">/// This function performs the following:</Highlight></CodeLine>
<Link id="l00204" /><CodeLine lineNumber="204"><Highlight kind="comment">/// - Update PHI nodes at the unrolling loop exit and epilog loop exit</Highlight></CodeLine>
<Link id="l00205" /><CodeLine lineNumber="205"><Highlight kind="comment">/// - Create PHI nodes at the unrolling loop exit to combine</Highlight></CodeLine>
<Link id="l00206" /><CodeLine lineNumber="206"><Highlight kind="comment">///   values that exit the unrolling loop code and jump around it.</Highlight></CodeLine>
<Link id="l00207" /><CodeLine lineNumber="207"><Highlight kind="comment">/// - Update PHI operands in the epilog loop by the new PHI nodes</Highlight></CodeLine>
<Link id="l00208" /><CodeLine lineNumber="208"><Highlight kind="comment">/// - Branch around the epilog loop if extra iters (ModVal) is zero.</Highlight></CodeLine>
<Link id="l00209" /><CodeLine lineNumber="209"><Highlight kind="comment">///</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00210" /><CodeLine lineNumber="210" lineLink="#a4ebed10d3e842e81a2df6974c2fd3760"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#a4ebed10d3e842e81a2df6974c2fd3760">ConnectEpilog</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L, <a href="/docs/api/classes/llvm/value">Value</a> &#42;ModVal, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewExit,</Highlight></CodeLine>
<Link id="l00211" /><CodeLine lineNumber="211"><Highlight kind="normal">                          <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Exit, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;PreHeader,</Highlight></CodeLine>
<Link id="l00212" /><CodeLine lineNumber="212"><Highlight kind="normal">                          <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;EpilogPreHeader, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewPreHeader,</Highlight></CodeLine>
<Link id="l00213" /><CodeLine lineNumber="213"><Highlight kind="normal">                          <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp;VMap, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &#42;DT,</Highlight></CodeLine>
<Link id="l00214" /><CodeLine lineNumber="214"><Highlight kind="normal">                          <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &#42;LI, </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> PreserveLCSSA, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &amp;SE,</Highlight></CodeLine>
<Link id="l00215" /><CodeLine lineNumber="215"><Highlight kind="normal">                          </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a>) &#123;</Highlight></CodeLine>
<Link id="l00216" /><CodeLine lineNumber="216"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Latch = L-&gt;getLoopLatch();</Highlight></CodeLine>
<Link id="l00217" /><CodeLine lineNumber="217"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Latch &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Loop must have a latch&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00218" /><CodeLine lineNumber="218"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;EpilogLatch = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(VMap&#91;Latch&#93;);</Highlight></CodeLine>
<Link id="l00219" /><CodeLine lineNumber="219"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00220" /><CodeLine lineNumber="220"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Loop structure should be the following:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00221" /><CodeLine lineNumber="221"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00222" /><CodeLine lineNumber="222"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// PreHeader</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00223" /><CodeLine lineNumber="223"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// NewPreHeader</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00224" /><CodeLine lineNumber="224"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   Header</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00225" /><CodeLine lineNumber="225"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   ...</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00226" /><CodeLine lineNumber="226"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   Latch</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00227" /><CodeLine lineNumber="227"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// NewExit (PN)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00228" /><CodeLine lineNumber="228"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// EpilogPreHeader</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00229" /><CodeLine lineNumber="229"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   EpilogHeader</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00230" /><CodeLine lineNumber="230"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   ...</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00231" /><CodeLine lineNumber="231"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   EpilogLatch</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00232" /><CodeLine lineNumber="232"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Exit (EpilogPN)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00233" /><CodeLine lineNumber="233"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00234" /><CodeLine lineNumber="234"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Update PHI nodes at NewExit and Exit.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00235" /><CodeLine lineNumber="235"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/phinode">PHINode</a> &amp;PN : NewExit-&gt;<a href="/docs/api/classes/llvm/basicblock/#a13da92d2694197fbcb5b95fd94e7570d">phis</a>()) &#123;</Highlight></CodeLine>
<Link id="l00236" /><CodeLine lineNumber="236"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// PN should be used in another PHI located in Exit block as</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00237" /><CodeLine lineNumber="237"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Exit was split by SplitBlockPredecessors into Exit and NewExit</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00238" /><CodeLine lineNumber="238"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Basically it should look like:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00239" /><CodeLine lineNumber="239"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// NewExit:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00240" /><CodeLine lineNumber="240"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//   PN = PHI &#91;I, Latch&#93;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00241" /><CodeLine lineNumber="241"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// ...</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00242" /><CodeLine lineNumber="242"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Exit:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00243" /><CodeLine lineNumber="243"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//   EpilogPN = PHI &#91;PN, EpilogPreHeader&#93;, &#91;X, Exit2&#93;, &#91;Y, Exit2.epil&#93;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00244" /><CodeLine lineNumber="244"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00245" /><CodeLine lineNumber="245"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Exits from non-latch blocks point to the original exit block and the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00246" /><CodeLine lineNumber="246"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// epilogue edges have already been added.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00247" /><CodeLine lineNumber="247"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00248" /><CodeLine lineNumber="248"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// There is EpilogPreHeader incoming block instead of NewExit as</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00249" /><CodeLine lineNumber="249"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// NewExit was spilt 1 more time to get EpilogPreHeader.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00250" /><CodeLine lineNumber="250"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(PN.hasOneUse() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;The phi should have 1 use&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00251" /><CodeLine lineNumber="251"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;EpilogPN = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;PHINode&gt;</a>(PN.use&#95;begin()-&gt;getUser());</Highlight></CodeLine>
<Link id="l00252" /><CodeLine lineNumber="252"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(EpilogPN-&gt;<a href="/docs/api/classes/llvm/ilist-detail/node-parent-access/#a7e19e7508415378ad9523e0339b23e22">getParent</a>() == Exit &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;EpilogPN should be in Exit block&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00253" /><CodeLine lineNumber="253"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00254" /><CodeLine lineNumber="254"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Add incoming PreHeader from branch around the Loop</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00255" /><CodeLine lineNumber="255"><Highlight kind="normal">    PN.addIncoming(<a href="/docs/api/classes/llvm/poisonvalue/#a1bf08613fb664a2e377a9a72c59a6b66">PoisonValue::get</a>(PN.getType()), PreHeader);</Highlight></CodeLine>
<Link id="l00256" /><CodeLine lineNumber="256"><Highlight kind="normal">    SE.<a href="/docs/api/classes/llvm/scalarevolution/#a804545e5b568edec8b970da32cd37359">forgetValue</a>(&amp;PN);</Highlight></CodeLine>
<Link id="l00257" /><CodeLine lineNumber="257"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00258" /><CodeLine lineNumber="258"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;V = PN.getIncomingValueForBlock(Latch);</Highlight></CodeLine>
<Link id="l00259" /><CodeLine lineNumber="259"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(V);</Highlight></CodeLine>
<Link id="l00260" /><CodeLine lineNumber="260"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> &amp;&amp; L-&gt;contains(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</Highlight></CodeLine>
<Link id="l00261" /><CodeLine lineNumber="261"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// If value comes from an instruction in the loop add VMap value.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00262" /><CodeLine lineNumber="262"><Highlight kind="normal">      V = VMap.<a href="/docs/api/classes/llvm/valuemap/#a15f92579a5fc316dab8cd1fad51015ef">lookup</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</Highlight></CodeLine>
<Link id="l00263" /><CodeLine lineNumber="263"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// For the instruction out of the loop, constant or undefined value</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00264" /><CodeLine lineNumber="264"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// insert value itself.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00265" /><CodeLine lineNumber="265"><Highlight kind="normal">    EpilogPN-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(V, EpilogLatch);</Highlight></CodeLine>
<Link id="l00266" /><CodeLine lineNumber="266"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00267" /><CodeLine lineNumber="267"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(EpilogPN-&gt;<a href="/docs/api/classes/llvm/phinode/#ae9562b96f6f3fa41bd36538c080035ee">getBasicBlockIndex</a>(EpilogPreHeader) &gt;= 0 &amp;&amp;</Highlight></CodeLine>
<Link id="l00268" /><CodeLine lineNumber="268"><Highlight kind="normal">          </Highlight><Highlight kind="stringliteral">&quot;EpilogPN should have EpilogPreHeader incoming block&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00269" /><CodeLine lineNumber="269"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Change EpilogPreHeader incoming block to NewExit.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00270" /><CodeLine lineNumber="270"><Highlight kind="normal">    EpilogPN-&gt;<a href="/docs/api/classes/llvm/phinode/#a5ba57877c55dfdbe6e3bbfdacd9ef8c1">setIncomingBlock</a>(EpilogPN-&gt;<a href="/docs/api/classes/llvm/phinode/#ae9562b96f6f3fa41bd36538c080035ee">getBasicBlockIndex</a>(EpilogPreHeader),</Highlight></CodeLine>
<Link id="l00271" /><CodeLine lineNumber="271"><Highlight kind="normal">                               NewExit);</Highlight></CodeLine>
<Link id="l00272" /><CodeLine lineNumber="272"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Now PHIs should look like:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00273" /><CodeLine lineNumber="273"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// NewExit:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00274" /><CodeLine lineNumber="274"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//   PN = PHI &#91;I, Latch&#93;, &#91;poison, PreHeader&#93;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00275" /><CodeLine lineNumber="275"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// ...</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00276" /><CodeLine lineNumber="276"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Exit:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00277" /><CodeLine lineNumber="277"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//   EpilogPN = PHI &#91;PN, NewExit&#93;, &#91;VMap&#91;I&#93;, EpilogLatch&#93;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00278" /><CodeLine lineNumber="278"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00279" /><CodeLine lineNumber="279"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00280" /><CodeLine lineNumber="280"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Create PHI nodes at NewExit (from the unrolling loop Latch and PreHeader).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00281" /><CodeLine lineNumber="281"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Update corresponding PHI nodes in epilog loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00282" /><CodeLine lineNumber="282"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Succ : <a href="/docs/api/namespaces/llvm/#a26e2a938b431eaa6eca2beaa96410c9d">successors</a>(Latch)) &#123;</Highlight></CodeLine>
<Link id="l00283" /><CodeLine lineNumber="283"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Skip this as we already updated phis in exit blocks.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00284" /><CodeLine lineNumber="284"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!L-&gt;contains(Succ))</Highlight></CodeLine>
<Link id="l00285" /><CodeLine lineNumber="285"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00286" /><CodeLine lineNumber="286"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/phinode">PHINode</a> &amp;PN : Succ-&gt;phis()) &#123;</Highlight></CodeLine>
<Link id="l00287" /><CodeLine lineNumber="287"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Add new PHI nodes to the loop exit block and update epilog</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00288" /><CodeLine lineNumber="288"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// PHIs with the new PHI values.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00289" /><CodeLine lineNumber="289"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;NewPN = <a href="/docs/api/classes/llvm/phinode/#af4aba918a76ca15bde1be3e14572e475">PHINode::Create</a>(PN.getType(), 2, PN.getName() + </Highlight><Highlight kind="stringliteral">&quot;.unr&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00290" /><CodeLine lineNumber="290"><Highlight kind="normal">      NewPN-&gt;<a href="/docs/api/classes/llvm/instruction/#a482498a1c760122fd33c7fc8190dd277">insertBefore</a>(NewExit-&gt;<a href="/docs/api/classes/llvm/basicblock/#a362b5e6097732cbc0d2fb555a1f73400">getFirstNonPHIIt</a>());</Highlight></CodeLine>
<Link id="l00291" /><CodeLine lineNumber="291"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Adding a value to the new PHI node from the unrolling loop preheader.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00292" /><CodeLine lineNumber="292"><Highlight kind="normal">      NewPN-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(PN.getIncomingValueForBlock(NewPreHeader), PreHeader);</Highlight></CodeLine>
<Link id="l00293" /><CodeLine lineNumber="293"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Adding a value to the new PHI node from the unrolling loop latch.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00294" /><CodeLine lineNumber="294"><Highlight kind="normal">      NewPN-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(PN.getIncomingValueForBlock(Latch), Latch);</Highlight></CodeLine>
<Link id="l00295" /><CodeLine lineNumber="295"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00296" /><CodeLine lineNumber="296"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Update the existing PHI node operand with the value from the new PHI</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00297" /><CodeLine lineNumber="297"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// node.  Corresponding instruction in epilog loop should be PHI.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00298" /><CodeLine lineNumber="298"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;VPN = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;PHINode&gt;</a>(VMap&#91;&amp;PN&#93;);</Highlight></CodeLine>
<Link id="l00299" /><CodeLine lineNumber="299"><Highlight kind="normal">      VPN-&gt;<a href="/docs/api/classes/llvm/phinode/#a506bcfb6f92a2184453e1fa9655f62a1">setIncomingValueForBlock</a>(EpilogPreHeader, NewPN);</Highlight></CodeLine>
<Link id="l00300" /><CodeLine lineNumber="300"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00301" /><CodeLine lineNumber="301"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00302" /><CodeLine lineNumber="302"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00303" /><CodeLine lineNumber="303"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;InsertPt = NewExit-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>();</Highlight></CodeLine>
<Link id="l00304" /><CodeLine lineNumber="304"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>(InsertPt);</Highlight></CodeLine>
<Link id="l00305" /><CodeLine lineNumber="305"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;BrLoopExit = <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>.CreateIsNotNull(ModVal, </Highlight><Highlight kind="stringliteral">&quot;lcmp.mod&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00306" /><CodeLine lineNumber="306"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(Exit &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Loop must have a single exit block only&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00307" /><CodeLine lineNumber="307"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Split the epilogue exit to maintain loop canonicalization guarantees</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00308" /><CodeLine lineNumber="308"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock&#42;, 4&gt;</a> Preds(<a href="/docs/api/namespaces/llvm/#acb22fb04083152eee862457e42e8dc31">predecessors</a>(Exit));</Highlight></CodeLine>
<Link id="l00309" /><CodeLine lineNumber="309"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#a9d391b6acc6d90c9b8a8442324b1aa6f">SplitBlockPredecessors</a>(Exit, Preds, </Highlight><Highlight kind="stringliteral">&quot;.epilog-lcssa&quot;</Highlight><Highlight kind="normal">, DT, LI, </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l00310" /><CodeLine lineNumber="310"><Highlight kind="normal">                         PreserveLCSSA);</Highlight></CodeLine>
<Link id="l00311" /><CodeLine lineNumber="311"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Add the branch to the exit block (around the unrolling loop)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00312" /><CodeLine lineNumber="312"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42;BranchWeights = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00313" /><CodeLine lineNumber="313"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#add2fce2ce0e32b20e41b0aa9f8ca70c2">hasBranchWeightMD</a>(&#42;Latch-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>())) &#123;</Highlight></CodeLine>
<Link id="l00314" /><CodeLine lineNumber="314"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Assume equal distribution in interval &#91;0, Count).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00315" /><CodeLine lineNumber="315"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/mdbuilder">MDBuilder</a> MDB(<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>.getContext());</Highlight></CodeLine>
<Link id="l00316" /><CodeLine lineNumber="316"><Highlight kind="normal">    BranchWeights = MDB.<a href="/docs/api/classes/llvm/mdbuilder/#a75043d12a76b84200e9ed593719dc5eb">createBranchWeights</a>(1, <a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a> - 1);</Highlight></CodeLine>
<Link id="l00317" /><CodeLine lineNumber="317"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00318" /><CodeLine lineNumber="318"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>.CreateCondBr(BrLoopExit, EpilogPreHeader, Exit, BranchWeights);</Highlight></CodeLine>
<Link id="l00319" /><CodeLine lineNumber="319"><Highlight kind="normal">  InsertPt-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</Highlight></CodeLine>
<Link id="l00320" /><CodeLine lineNumber="320"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DT) &#123;</Highlight></CodeLine>
<Link id="l00321" /><CodeLine lineNumber="321"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;NewDom = DT-&gt;<a href="/docs/api/classes/llvm/dominatortree/#a2ec50ab2c78eff965caf3da71cd08be4">findNearestCommonDominator</a>(Exit, NewExit);</Highlight></CodeLine>
<Link id="l00322" /><CodeLine lineNumber="322"><Highlight kind="normal">    DT-&gt;<a href="/docs/api/classes/llvm/dominatortreebase/#a2881c226e1c102190d54c3b664330aba">changeImmediateDominator</a>(Exit, NewDom);</Highlight></CodeLine>
<Link id="l00323" /><CodeLine lineNumber="323"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00324" /><CodeLine lineNumber="324"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00325" /><CodeLine lineNumber="325"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Split the main loop exit to maintain canonicalization guarantees.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00326" /><CodeLine lineNumber="326"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock&#42;, 4&gt;</a> NewExitPreds&#123;Latch&#125;;</Highlight></CodeLine>
<Link id="l00327" /><CodeLine lineNumber="327"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#a9d391b6acc6d90c9b8a8442324b1aa6f">SplitBlockPredecessors</a>(NewExit, NewExitPreds, </Highlight><Highlight kind="stringliteral">&quot;.loopexit&quot;</Highlight><Highlight kind="normal">, DT, LI, </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l00328" /><CodeLine lineNumber="328"><Highlight kind="normal">                         PreserveLCSSA);</Highlight></CodeLine>
<Link id="l00329" /><CodeLine lineNumber="329"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00330" /><CodeLine lineNumber="330"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00331" /><CodeLine lineNumber="331"><Highlight kind="comment">/// Create a clone of the blocks in a loop and connect them together. A new</Highlight></CodeLine>
<Link id="l00332" /><CodeLine lineNumber="332"><Highlight kind="comment">/// loop will be created including all cloned blocks, and the iterator of the</Highlight></CodeLine>
<Link id="l00333" /><CodeLine lineNumber="333"><Highlight kind="comment">/// new loop switched to count NewIter down to 0</Highlight></CodeLine>
<Link id="l00334" /><CodeLine lineNumber="334"><Highlight kind="comment">/// The cloned blocks should be inserted between InsertTop and InsertBot.</Highlight></CodeLine>
<Link id="l00335" /><CodeLine lineNumber="335"><Highlight kind="comment">/// InsertTop should be new preheader, InsertBot new loop exit.</Highlight></CodeLine>
<Link id="l00336" /><CodeLine lineNumber="336"><Highlight kind="comment">/// Returns the new cloned loop that is created.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00337" /><CodeLine lineNumber="337"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;</Highlight></CodeLine>
<Link id="l00338" /><CodeLine lineNumber="338" lineLink="#a399d7b7e2e6aec8e1ad80d3d73b7b1c8"><Highlight kind="normal"><a href="#a399d7b7e2e6aec8e1ad80d3d73b7b1c8">CloneLoopBlocks</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L, <a href="/docs/api/classes/llvm/value">Value</a> &#42;NewIter, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> UseEpilogRemainder,</Highlight></CodeLine>
<Link id="l00339" /><CodeLine lineNumber="339"><Highlight kind="normal">                </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> UnrollRemainder,</Highlight></CodeLine>
<Link id="l00340" /><CodeLine lineNumber="340"><Highlight kind="normal">                <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;InsertTop,</Highlight></CodeLine>
<Link id="l00341" /><CodeLine lineNumber="341"><Highlight kind="normal">                <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;InsertBot, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Preheader,</Highlight></CodeLine>
<Link id="l00342" /><CodeLine lineNumber="342"><Highlight kind="normal">                             std::vector&lt;BasicBlock &#42;&gt; &amp;NewBlocks,</Highlight></CodeLine>
<Link id="l00343" /><CodeLine lineNumber="343"><Highlight kind="normal">                             <a href="/docs/api/classes/llvm/loopblocksdfs">LoopBlocksDFS</a> &amp;LoopBlocks, <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp;VMap,</Highlight></CodeLine>
<Link id="l00344" /><CodeLine lineNumber="344"><Highlight kind="normal">                             <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &#42;DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &#42;LI, </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a>) &#123;</Highlight></CodeLine>
<Link id="l00345" /><CodeLine lineNumber="345"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/stringref">StringRef</a> suffix = UseEpilogRemainder ? </Highlight><Highlight kind="stringliteral">&quot;epil&quot;</Highlight><Highlight kind="normal"> : </Highlight><Highlight kind="stringliteral">&quot;prol&quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00346" /><CodeLine lineNumber="346"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Header = L-&gt;getHeader();</Highlight></CodeLine>
<Link id="l00347" /><CodeLine lineNumber="347"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Latch = L-&gt;getLoopLatch();</Highlight></CodeLine>
<Link id="l00348" /><CodeLine lineNumber="348"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = Header-&gt;getParent();</Highlight></CodeLine>
<Link id="l00349" /><CodeLine lineNumber="349"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loopblocksdfs/#a0c1bb1134650f3f69f5921d57fb50b78">LoopBlocksDFS::RPOIterator</a> BlockBegin = LoopBlocks.<a href="/docs/api/classes/llvm/loopblocksdfs/#a003fe6215d300fc9720b1b056cdf4c23">beginRPO</a>();</Highlight></CodeLine>
<Link id="l00350" /><CodeLine lineNumber="350"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loopblocksdfs/#a0c1bb1134650f3f69f5921d57fb50b78">LoopBlocksDFS::RPOIterator</a> BlockEnd = LoopBlocks.<a href="/docs/api/classes/llvm/loopblocksdfs/#aeebda6b0288bea7cd706111624ca73f6">endRPO</a>();</Highlight></CodeLine>
<Link id="l00351" /><CodeLine lineNumber="351"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ParentLoop = L-&gt;getParentLoop();</Highlight></CodeLine>
<Link id="l00352" /><CodeLine lineNumber="352"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#a274d93224edb5b119f8a096e5babdaa1">NewLoopsMap</a> NewLoops;</Highlight></CodeLine>
<Link id="l00353" /><CodeLine lineNumber="353"><Highlight kind="normal">  NewLoops&#91;ParentLoop&#93; = ParentLoop;</Highlight></CodeLine>
<Link id="l00354" /><CodeLine lineNumber="354"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00355" /><CodeLine lineNumber="355"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// For each block in the original loop, create a new copy,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00356" /><CodeLine lineNumber="356"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// and update the value map with the newly created values.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00357" /><CodeLine lineNumber="357"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loopblocksdfs/#a0c1bb1134650f3f69f5921d57fb50b78">LoopBlocksDFS::RPOIterator</a> BB = BlockBegin; BB != BlockEnd; ++BB) &#123;</Highlight></CodeLine>
<Link id="l00358" /><CodeLine lineNumber="358"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewBB = <a href="/docs/api/namespaces/llvm/#aa1c8d384f90fc9d69d7fcdf920138cf2">CloneBasicBlock</a>(&#42;BB, VMap, </Highlight><Highlight kind="stringliteral">&quot;.&quot;</Highlight><Highlight kind="normal"> + suffix, <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</Highlight></CodeLine>
<Link id="l00359" /><CodeLine lineNumber="359"><Highlight kind="normal">    NewBlocks.push&#95;back(NewBB);</Highlight></CodeLine>
<Link id="l00360" /><CodeLine lineNumber="360"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00361" /><CodeLine lineNumber="361"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#ac3328dd05f047ea11f19504685b0e136">addClonedBlockToLoopInfo</a>(&#42;BB, NewBB, LI, NewLoops);</Highlight></CodeLine>
<Link id="l00362" /><CodeLine lineNumber="362"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00363" /><CodeLine lineNumber="363"><Highlight kind="normal">    VMap&#91;&#42;BB&#93; = NewBB;</Highlight></CodeLine>
<Link id="l00364" /><CodeLine lineNumber="364"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Header == &#42;BB) &#123;</Highlight></CodeLine>
<Link id="l00365" /><CodeLine lineNumber="365"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// For the first block, add a CFG connection to this newly</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00366" /><CodeLine lineNumber="366"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// created block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00367" /><CodeLine lineNumber="367"><Highlight kind="normal">      InsertTop-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>()-&gt;<a href="/docs/api/classes/llvm/instruction/#ae959364e4640ac025bbc046d3d7c7e61">setSuccessor</a>(0, NewBB);</Highlight></CodeLine>
<Link id="l00368" /><CodeLine lineNumber="368"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00369" /><CodeLine lineNumber="369"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00370" /><CodeLine lineNumber="370"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DT) &#123;</Highlight></CodeLine>
<Link id="l00371" /><CodeLine lineNumber="371"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Header == &#42;BB) &#123;</Highlight></CodeLine>
<Link id="l00372" /><CodeLine lineNumber="372"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// The header is dominated by the preheader.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00373" /><CodeLine lineNumber="373"><Highlight kind="normal">        DT-&gt;<a href="/docs/api/classes/llvm/dominatortreebase/#a4211a49504539a8a37aebb00e1390370">addNewBlock</a>(NewBB, InsertTop);</Highlight></CodeLine>
<Link id="l00374" /><CodeLine lineNumber="374"><Highlight kind="normal">      &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00375" /><CodeLine lineNumber="375"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Copy information from original loop to unrolled loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00376" /><CodeLine lineNumber="376"><Highlight kind="normal">        <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;IDomBB = DT-&gt;<a href="/docs/api/classes/llvm/dominatortreebase/#ad8295b9b507d1d847cd46856f8255eab">getNode</a>(&#42;BB)-&gt;<a href="/docs/api/classes/llvm/domtreenodebase/#a453de62c2dadf7b4b8df04e89f6ab4e0">getIDom</a>()-&gt;<a href="/docs/api/classes/llvm/domtreenodebase/#aab2bf365c9f4b976adc7479576dfd5bb">getBlock</a>();</Highlight></CodeLine>
<Link id="l00377" /><CodeLine lineNumber="377"><Highlight kind="normal">        DT-&gt;<a href="/docs/api/classes/llvm/dominatortreebase/#a4211a49504539a8a37aebb00e1390370">addNewBlock</a>(NewBB, <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(VMap&#91;IDomBB&#93;));</Highlight></CodeLine>
<Link id="l00378" /><CodeLine lineNumber="378"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00379" /><CodeLine lineNumber="379"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00380" /><CodeLine lineNumber="380"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00381" /><CodeLine lineNumber="381"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Latch == &#42;BB) &#123;</Highlight></CodeLine>
<Link id="l00382" /><CodeLine lineNumber="382"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// For the last block, create a loop back to cloned head.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00383" /><CodeLine lineNumber="383"><Highlight kind="normal">      VMap.<a href="/docs/api/classes/llvm/valuemap/#ae6be28efa794d11d2b1395fa77d7ebef">erase</a>((&#42;BB)-&gt;getTerminator());</Highlight></CodeLine>
<Link id="l00384" /><CodeLine lineNumber="384"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Use an incrementing IV.  Pre-incr/post-incr is backedge/trip count.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00385" /><CodeLine lineNumber="385"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Subtle: NewIter can be 0 if we wrapped when computing the trip count,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00386" /><CodeLine lineNumber="386"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// thus we must compare the post-increment (wrapping) value.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00387" /><CodeLine lineNumber="387"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;FirstLoopBB = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(VMap&#91;Header&#93;);</Highlight></CodeLine>
<Link id="l00388" /><CodeLine lineNumber="388"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;LatchBR = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BranchInst&gt;</a>(NewBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l00389" /><CodeLine lineNumber="389"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> Builder(LatchBR);</Highlight></CodeLine>
<Link id="l00390" /><CodeLine lineNumber="390"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;NewIdx =</Highlight></CodeLine>
<Link id="l00391" /><CodeLine lineNumber="391"><Highlight kind="normal">          <a href="/docs/api/classes/llvm/phinode/#af4aba918a76ca15bde1be3e14572e475">PHINode::Create</a>(NewIter-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>(), 2, suffix + </Highlight><Highlight kind="stringliteral">&quot;.iter&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00392" /><CodeLine lineNumber="392"><Highlight kind="normal">      NewIdx-&gt;<a href="/docs/api/classes/llvm/instruction/#a482498a1c760122fd33c7fc8190dd277">insertBefore</a>(FirstLoopBB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a362b5e6097732cbc0d2fb555a1f73400">getFirstNonPHIIt</a>());</Highlight></CodeLine>
<Link id="l00393" /><CodeLine lineNumber="393"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;Zero = ConstantInt::get(NewIdx-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>(), 0);</Highlight></CodeLine>
<Link id="l00394" /><CodeLine lineNumber="394"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;One = ConstantInt::get(NewIdx-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>(), 1);</Highlight></CodeLine>
<Link id="l00395" /><CodeLine lineNumber="395"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;IdxNext =</Highlight></CodeLine>
<Link id="l00396" /><CodeLine lineNumber="396"><Highlight kind="normal">          Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aada1d6d8de104a5cd1cb9a02c676cc6c">CreateAdd</a>(NewIdx, One, NewIdx-&gt;<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>() + </Highlight><Highlight kind="stringliteral">&quot;.next&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00397" /><CodeLine lineNumber="397"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;IdxCmp = Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a6ef1729b04a4fbd6c6f27787cdd0e813">CreateICmpNE</a>(IdxNext, NewIter, NewIdx-&gt;<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>() + </Highlight><Highlight kind="stringliteral">&quot;.cmp&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00398" /><CodeLine lineNumber="398"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42;BranchWeights = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00399" /><CodeLine lineNumber="399"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#add2fce2ce0e32b20e41b0aa9f8ca70c2">hasBranchWeightMD</a>(&#42;LatchBR)) &#123;</Highlight></CodeLine>
<Link id="l00400" /><CodeLine lineNumber="400"><Highlight kind="normal">        uint32&#95;t ExitWeight;</Highlight></CodeLine>
<Link id="l00401" /><CodeLine lineNumber="401"><Highlight kind="normal">        uint32&#95;t BackEdgeWeight;</Highlight></CodeLine>
<Link id="l00402" /><CodeLine lineNumber="402"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a> &gt;= 3) &#123;</Highlight></CodeLine>
<Link id="l00403" /><CodeLine lineNumber="403"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// Note: We do not enter this loop for zero-remainders. The check</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00404" /><CodeLine lineNumber="404"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// is at the end of the loop. We assume equal distribution between</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00405" /><CodeLine lineNumber="405"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// possible remainders in &#91;1, Count).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00406" /><CodeLine lineNumber="406"><Highlight kind="normal">          ExitWeight = 1;</Highlight></CodeLine>
<Link id="l00407" /><CodeLine lineNumber="407"><Highlight kind="normal">          BackEdgeWeight = (<a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a> - 2) / 2;</Highlight></CodeLine>
<Link id="l00408" /><CodeLine lineNumber="408"><Highlight kind="normal">        &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00409" /><CodeLine lineNumber="409"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// Unnecessary backedge, should never be taken. The conditional</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00410" /><CodeLine lineNumber="410"><Highlight kind="normal">          </Highlight><Highlight kind="comment">// jump should be optimized away later.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00411" /><CodeLine lineNumber="411"><Highlight kind="normal">          ExitWeight = 1;</Highlight></CodeLine>
<Link id="l00412" /><CodeLine lineNumber="412"><Highlight kind="normal">          BackEdgeWeight = 0;</Highlight></CodeLine>
<Link id="l00413" /><CodeLine lineNumber="413"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l00414" /><CodeLine lineNumber="414"><Highlight kind="normal">        <a href="/docs/api/classes/llvm/mdbuilder">MDBuilder</a> MDB(Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#aa2ed385be8984b4306762990278eb13d">getContext</a>());</Highlight></CodeLine>
<Link id="l00415" /><CodeLine lineNumber="415"><Highlight kind="normal">        BranchWeights = MDB.<a href="/docs/api/classes/llvm/mdbuilder/#a75043d12a76b84200e9ed593719dc5eb">createBranchWeights</a>(BackEdgeWeight, ExitWeight);</Highlight></CodeLine>
<Link id="l00416" /><CodeLine lineNumber="416"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00417" /><CodeLine lineNumber="417"><Highlight kind="normal">      Builder.<a href="/docs/api/classes/llvm/irbuilderbase/#a972c30f044db799668bdcace5544edeb">CreateCondBr</a>(IdxCmp, FirstLoopBB, InsertBot, BranchWeights);</Highlight></CodeLine>
<Link id="l00418" /><CodeLine lineNumber="418"><Highlight kind="normal">      NewIdx-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(Zero, InsertTop);</Highlight></CodeLine>
<Link id="l00419" /><CodeLine lineNumber="419"><Highlight kind="normal">      NewIdx-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(IdxNext, NewBB);</Highlight></CodeLine>
<Link id="l00420" /><CodeLine lineNumber="420"><Highlight kind="normal">      LatchBR-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</Highlight></CodeLine>
<Link id="l00421" /><CodeLine lineNumber="421"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00422" /><CodeLine lineNumber="422"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00423" /><CodeLine lineNumber="423"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00424" /><CodeLine lineNumber="424"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Change the incoming values to the ones defined in the preheader or</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00425" /><CodeLine lineNumber="425"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// cloned loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00426" /><CodeLine lineNumber="426"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = Header-&gt;begin(); <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;PHINode&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>); ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &#123;</Highlight></CodeLine>
<Link id="l00427" /><CodeLine lineNumber="427"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;NewPHI = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;PHINode&gt;</a>(VMap&#91;&amp;&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93;);</Highlight></CodeLine>
<Link id="l00428" /><CodeLine lineNumber="428"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> idx = NewPHI-&gt;<a href="/docs/api/classes/llvm/phinode/#ae9562b96f6f3fa41bd36538c080035ee">getBasicBlockIndex</a>(Preheader);</Highlight></CodeLine>
<Link id="l00429" /><CodeLine lineNumber="429"><Highlight kind="normal">    NewPHI-&gt;<a href="/docs/api/classes/llvm/phinode/#a5ba57877c55dfdbe6e3bbfdacd9ef8c1">setIncomingBlock</a>(idx, InsertTop);</Highlight></CodeLine>
<Link id="l00430" /><CodeLine lineNumber="430"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewLatch = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(VMap&#91;Latch&#93;);</Highlight></CodeLine>
<Link id="l00431" /><CodeLine lineNumber="431"><Highlight kind="normal">    idx = NewPHI-&gt;<a href="/docs/api/classes/llvm/phinode/#ae9562b96f6f3fa41bd36538c080035ee">getBasicBlockIndex</a>(Latch);</Highlight></CodeLine>
<Link id="l00432" /><CodeLine lineNumber="432"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;InVal = NewPHI-&gt;<a href="/docs/api/classes/llvm/phinode/#aca1fd00f3ab63ec8f0f1ccc2093a9f6d">getIncomingValue</a>(idx);</Highlight></CodeLine>
<Link id="l00433" /><CodeLine lineNumber="433"><Highlight kind="normal">    NewPHI-&gt;<a href="/docs/api/classes/llvm/phinode/#a5ba57877c55dfdbe6e3bbfdacd9ef8c1">setIncomingBlock</a>(idx, NewLatch);</Highlight></CodeLine>
<Link id="l00434" /><CodeLine lineNumber="434"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/value">Value</a> &#42;V = VMap.<a href="/docs/api/classes/llvm/valuemap/#a15f92579a5fc316dab8cd1fad51015ef">lookup</a>(InVal))</Highlight></CodeLine>
<Link id="l00435" /><CodeLine lineNumber="435"><Highlight kind="normal">      NewPHI-&gt;<a href="/docs/api/classes/llvm/phinode/#a88cdefb709309eddc6e5daca0be6a7b4">setIncomingValue</a>(idx, V);</Highlight></CodeLine>
<Link id="l00436" /><CodeLine lineNumber="436"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00437" /><CodeLine lineNumber="437"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00438" /><CodeLine lineNumber="438"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;NewLoop = NewLoops&#91;L&#93;;</Highlight></CodeLine>
<Link id="l00439" /><CodeLine lineNumber="439"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(NewLoop &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;L should have been cloned&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00440" /><CodeLine lineNumber="440"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42;LoopID = NewLoop-&gt;<a href="/docs/api/classes/llvm/loop/#afbcd78588d5235f99698b5c30f591382">getLoopID</a>();</Highlight></CodeLine>
<Link id="l00441" /><CodeLine lineNumber="441"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00442" /><CodeLine lineNumber="442"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Only add loop metadata if the loop is not going to be completely</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00443" /><CodeLine lineNumber="443"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// unrolled.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00444" /><CodeLine lineNumber="444"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UnrollRemainder)</Highlight></CodeLine>
<Link id="l00445" /><CodeLine lineNumber="445"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> NewLoop;</Highlight></CodeLine>
<Link id="l00446" /><CodeLine lineNumber="446"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00447" /><CodeLine lineNumber="447"><Highlight kind="normal">  std::optional&lt;MDNode &#42;&gt; NewLoopID = <a href="/docs/api/namespaces/llvm/#a368216c9c116e3f30d8dd352ce1370fc">makeFollowupLoopID</a>(</Highlight></CodeLine>
<Link id="l00448" /><CodeLine lineNumber="448"><Highlight kind="normal">      LoopID, &#123;<a href="/docs/api/namespaces/llvm/#a9e3f06a77c19d1098df61d28499fcf3b">LLVMLoopUnrollFollowupAll</a>, <a href="/docs/api/namespaces/llvm/#ac127703689b2c3771640f7fa800d61dc">LLVMLoopUnrollFollowupRemainder</a>&#125;);</Highlight></CodeLine>
<Link id="l00449" /><CodeLine lineNumber="449"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (NewLoopID) &#123;</Highlight></CodeLine>
<Link id="l00450" /><CodeLine lineNumber="450"><Highlight kind="normal">    NewLoop-&gt;<a href="/docs/api/classes/llvm/loop/#adf4be757fa30ca7fe3e8b119438100f0">setLoopID</a>(&#42;NewLoopID);</Highlight></CodeLine>
<Link id="l00451" /><CodeLine lineNumber="451"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00452" /><CodeLine lineNumber="452"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Do not setLoopAlreadyUnrolled if loop attributes have been defined</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00453" /><CodeLine lineNumber="453"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// explicitly.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00454" /><CodeLine lineNumber="454"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> NewLoop;</Highlight></CodeLine>
<Link id="l00455" /><CodeLine lineNumber="455"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00456" /><CodeLine lineNumber="456"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00457" /><CodeLine lineNumber="457"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Add unroll disable metadata to disable future unrolling for this loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00458" /><CodeLine lineNumber="458"><Highlight kind="normal">  NewLoop-&gt;<a href="/docs/api/classes/llvm/loop/#ae27590daf21d575c9bb75c966fe256f2">setLoopAlreadyUnrolled</a>();</Highlight></CodeLine>
<Link id="l00459" /><CodeLine lineNumber="459"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> NewLoop;</Highlight></CodeLine>
<Link id="l00460" /><CodeLine lineNumber="460"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00461" /><CodeLine lineNumber="461"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00462" /><CodeLine lineNumber="462"><Highlight kind="comment">/// Returns true if we can profitably unroll the multi-exit loop L. Currently,</Highlight></CodeLine>
<Link id="l00463" /><CodeLine lineNumber="463"><Highlight kind="comment">/// we return true only if UnrollRuntimeMultiExit is set to true.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00464" /><CodeLine lineNumber="464" lineLink="#a98b4edd31a148a751a95e80997f81c31"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a98b4edd31a148a751a95e80997f81c31">canProfitablyRuntimeUnrollMultiExitLoop</a>(</Highlight></CodeLine>
<Link id="l00465" /><CodeLine lineNumber="465"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L, <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;BasicBlock &#42;&gt;</a> &amp;OtherExits, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;LatchExit,</Highlight></CodeLine>
<Link id="l00466" /><CodeLine lineNumber="466"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> UseEpilogRemainder) &#123;</Highlight></CodeLine>
<Link id="l00467" /><CodeLine lineNumber="467"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00468" /><CodeLine lineNumber="468"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Priority goes to UnrollRuntimeMultiExit if it&#39;s supplied.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00469" /><CodeLine lineNumber="469"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#ae9c245e2a4a3f5a845a1cbe2922af167">UnrollRuntimeMultiExit</a>.getNumOccurrences())</Highlight></CodeLine>
<Link id="l00470" /><CodeLine lineNumber="470"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="#ae9c245e2a4a3f5a845a1cbe2922af167">UnrollRuntimeMultiExit</a>;</Highlight></CodeLine>
<Link id="l00471" /><CodeLine lineNumber="471"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00472" /><CodeLine lineNumber="472"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The main pain point with multi-exit loop unrolling is that once unrolled,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00473" /><CodeLine lineNumber="473"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// we will not be able to merge all blocks into a straight line code.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00474" /><CodeLine lineNumber="474"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// There are branches within the unrolled loop that go to the OtherExits.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00475" /><CodeLine lineNumber="475"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The second point is the increase in code size, but this is true</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00476" /><CodeLine lineNumber="476"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// irrespective of multiple exits.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00477" /><CodeLine lineNumber="477"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00478" /><CodeLine lineNumber="478"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Note: Both the heuristics below are coarse grained. We are essentially</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00479" /><CodeLine lineNumber="479"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// enabling unrolling of loops that have a single side exit other than the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00480" /><CodeLine lineNumber="480"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// normal LatchExit (i.e. exiting into a deoptimize block).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00481" /><CodeLine lineNumber="481"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The heuristics considered are:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00482" /><CodeLine lineNumber="482"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// 1 low number of branches in the unrolled version.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00483" /><CodeLine lineNumber="483"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// 2 high predictability of these extra branches.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00484" /><CodeLine lineNumber="484"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We avoid unrolling loops that have more than two exiting blocks. This</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00485" /><CodeLine lineNumber="485"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// limits the total number of branches in the unrolled loop to be atmost</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00486" /><CodeLine lineNumber="486"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the unroll factor (since one of the exiting blocks is the latch block).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00487" /><CodeLine lineNumber="487"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock&#42;, 4&gt;</a> ExitingBlocks;</Highlight></CodeLine>
<Link id="l00488" /><CodeLine lineNumber="488"><Highlight kind="normal">  L-&gt;getExitingBlocks(ExitingBlocks);</Highlight></CodeLine>
<Link id="l00489" /><CodeLine lineNumber="489"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (ExitingBlocks.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() &gt; 2)</Highlight></CodeLine>
<Link id="l00490" /><CodeLine lineNumber="490"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00491" /><CodeLine lineNumber="491"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00492" /><CodeLine lineNumber="492"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Allow unrolling of loops with no non latch exit blocks.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00493" /><CodeLine lineNumber="493"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (OtherExits.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() == 0)</Highlight></CodeLine>
<Link id="l00494" /><CodeLine lineNumber="494"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00495" /><CodeLine lineNumber="495"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00496" /><CodeLine lineNumber="496"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The second heuristic is that L has one exit other than the latchexit and</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00497" /><CodeLine lineNumber="497"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// that exit is a deoptimize block. We know that deoptimize blocks are rarely</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00498" /><CodeLine lineNumber="498"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// taken, which also implies the branch leading to the deoptimize block is</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00499" /><CodeLine lineNumber="499"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// highly predictable. When UnrollRuntimeOtherExitPredictable is specified, we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00500" /><CodeLine lineNumber="500"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// assume the other exit branch is predictable even if it has no deoptimize</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00501" /><CodeLine lineNumber="501"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// call.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00502" /><CodeLine lineNumber="502"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> (OtherExits.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() == 1 &amp;&amp;</Highlight></CodeLine>
<Link id="l00503" /><CodeLine lineNumber="503"><Highlight kind="normal">          (<a href="#a873b044e9706fd66860c6178f74a51f9">UnrollRuntimeOtherExitPredictable</a> ||</Highlight></CodeLine>
<Link id="l00504" /><CodeLine lineNumber="504"><Highlight kind="normal">           OtherExits&#91;0&#93;-&gt;getPostdominatingDeoptimizeCall()));</Highlight></CodeLine>
<Link id="l00505" /><CodeLine lineNumber="505"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// TODO: These can be fine-tuned further to consider code size or deopt states</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00506" /><CodeLine lineNumber="506"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// that are captured by the deoptimize exit block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00507" /><CodeLine lineNumber="507"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Also, we can extend this to support more cases, if we actually</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00508" /><CodeLine lineNumber="508"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// know of kinds of multiexit loops that would benefit from unrolling.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00509" /><CodeLine lineNumber="509"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00510" /><CodeLine lineNumber="510"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00511" /><CodeLine lineNumber="511"><Highlight kind="comment">/// Calculate ModVal = (BECount + 1) % Count on the abstract integer domain</Highlight></CodeLine>
<Link id="l00512" /><CodeLine lineNumber="512"><Highlight kind="comment">/// accounting for the possibility of unsigned overflow in the 2s complement</Highlight></CodeLine>
<Link id="l00513" /><CodeLine lineNumber="513"><Highlight kind="comment">/// domain. Preconditions:</Highlight></CodeLine>
<Link id="l00514" /><CodeLine lineNumber="514"><Highlight kind="comment">/// 1) TripCount = BECount + 1 (allowing overflow)</Highlight></CodeLine>
<Link id="l00515" /><CodeLine lineNumber="515"><Highlight kind="comment">/// 2) Log2(Count) &lt;= BitWidth(BECount)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00516" /><CodeLine lineNumber="516" lineLink="#a7bab17532f2b606ad25679ed9e138c73"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="#a7bab17532f2b606ad25679ed9e138c73">CreateTripRemainder</a>(<a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> &amp;<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>, <a href="/docs/api/classes/llvm/value">Value</a> &#42;BECount,</Highlight></CodeLine>
<Link id="l00517" /><CodeLine lineNumber="517"><Highlight kind="normal">                                  <a href="/docs/api/classes/llvm/value">Value</a> &#42;TripCount, </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a>) &#123;</Highlight></CodeLine>
<Link id="l00518" /><CodeLine lineNumber="518"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Note that TripCount is BECount + 1</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00519" /><CodeLine lineNumber="519"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a6dec2b5d3e04b47adf4d918d678e81c9">isPowerOf2&#95;32</a>(<a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a>))</Highlight></CodeLine>
<Link id="l00520" /><CodeLine lineNumber="520"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If the expression is zero, then either:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00521" /><CodeLine lineNumber="521"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//  1 There are no iterations to be run in the prolog/epilog loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00522" /><CodeLine lineNumber="522"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// OR</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00523" /><CodeLine lineNumber="523"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//  2 The addition computing TripCount overflowed.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00524" /><CodeLine lineNumber="524"><Highlight kind="normal">    </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00525" /><CodeLine lineNumber="525"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If (2) is true, we know that TripCount really is (1 &lt;&lt; BEWidth) and so</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00526" /><CodeLine lineNumber="526"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// the number of iterations that remain to be run in the original loop is a</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00527" /><CodeLine lineNumber="527"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// multiple Count == (1 &lt;&lt; Log2(Count)) because Log2(Count) &lt;= BEWidth (a</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00528" /><CodeLine lineNumber="528"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// precondition of this method).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00529" /><CodeLine lineNumber="529"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>.CreateAnd(TripCount, <a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a> - 1, </Highlight><Highlight kind="stringliteral">&quot;xtraiter&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00530" /><CodeLine lineNumber="530"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00531" /><CodeLine lineNumber="531"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// As (BECount + 1) can potentially unsigned overflow we count</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00532" /><CodeLine lineNumber="532"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// (BECount % Count) + 1 which is overflow safe as BECount % Count &lt; Count.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00533" /><CodeLine lineNumber="533"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/constant">Constant</a> &#42;CountC = ConstantInt::get(BECount-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>(), <a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a>);</Highlight></CodeLine>
<Link id="l00534" /><CodeLine lineNumber="534"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;ModValTmp = <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>.CreateURem(BECount, CountC);</Highlight></CodeLine>
<Link id="l00535" /><CodeLine lineNumber="535"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;ModValAdd = <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>.CreateAdd(ModValTmp,</Highlight></CodeLine>
<Link id="l00536" /><CodeLine lineNumber="536"><Highlight kind="normal">                                 ConstantInt::get(ModValTmp-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>(), 1));</Highlight></CodeLine>
<Link id="l00537" /><CodeLine lineNumber="537"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// At that point (BECount % Count) + 1 could be equal to Count.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00538" /><CodeLine lineNumber="538"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// To handle this case we need to take mod by Count one more time.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00539" /><CodeLine lineNumber="539"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>.CreateURem(ModValAdd, CountC, </Highlight><Highlight kind="stringliteral">&quot;xtraiter&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00540" /><CodeLine lineNumber="540"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00541" /><CodeLine lineNumber="541"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00542" /><CodeLine lineNumber="542"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00543" /><CodeLine lineNumber="543"><Highlight kind="comment">/// Insert code in the prolog/epilog code when unrolling a loop with a</Highlight></CodeLine>
<Link id="l00544" /><CodeLine lineNumber="544"><Highlight kind="comment">/// run-time trip-count.</Highlight></CodeLine>
<Link id="l00545" /><CodeLine lineNumber="545"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00546" /><CodeLine lineNumber="546"><Highlight kind="comment">/// This method assumes that the loop unroll factor is total number</Highlight></CodeLine>
<Link id="l00547" /><CodeLine lineNumber="547"><Highlight kind="comment">/// of loop bodies in the loop after unrolling. (Some folks refer</Highlight></CodeLine>
<Link id="l00548" /><CodeLine lineNumber="548"><Highlight kind="comment">/// to the unroll factor as the number of &#42;extra&#42; copies added).</Highlight></CodeLine>
<Link id="l00549" /><CodeLine lineNumber="549"><Highlight kind="comment">/// We assume also that the loop unroll factor is a power-of-two. So, after</Highlight></CodeLine>
<Link id="l00550" /><CodeLine lineNumber="550"><Highlight kind="comment">/// unrolling the loop, the number of loop bodies executed is 2,</Highlight></CodeLine>
<Link id="l00551" /><CodeLine lineNumber="551"><Highlight kind="comment">/// 4, 8, etc.  Note - LLVM converts the if-then-sequence to a switch</Highlight></CodeLine>
<Link id="l00552" /><CodeLine lineNumber="552"><Highlight kind="comment">/// instruction in SimplifyCFG.cpp.  Then, the backend decides how code for</Highlight></CodeLine>
<Link id="l00553" /><CodeLine lineNumber="553"><Highlight kind="comment">/// the switch instruction is generated.</Highlight></CodeLine>
<Link id="l00554" /><CodeLine lineNumber="554"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00555" /><CodeLine lineNumber="555"><Highlight kind="comment">/// &#42;&#42;&#42;Prolog case&#42;&#42;&#42;</Highlight></CodeLine>
<Link id="l00556" /><CodeLine lineNumber="556"><Highlight kind="comment">///        extraiters = tripcount % loopfactor</Highlight></CodeLine>
<Link id="l00557" /><CodeLine lineNumber="557"><Highlight kind="comment">///        if (extraiters == 0) jump Loop:</Highlight></CodeLine>
<Link id="l00558" /><CodeLine lineNumber="558"><Highlight kind="comment">///        else jump Prol:</Highlight></CodeLine>
<Link id="l00559" /><CodeLine lineNumber="559"><Highlight kind="comment">/// Prol:  LoopBody;</Highlight></CodeLine>
<Link id="l00560" /><CodeLine lineNumber="560"><Highlight kind="comment">///        extraiters -= 1                 // Omitted if unroll factor is 2</Highlight></CodeLine>
<Link id="l00561" /><CodeLine lineNumber="561"><Highlight kind="comment">///        if (extraiters != 0) jump Prol: // Omitted if unroll factor is 2</Highlight></CodeLine>
<Link id="l00562" /><CodeLine lineNumber="562"><Highlight kind="comment">///        if (tripcount &lt; loopfactor) jump End:</Highlight></CodeLine>
<Link id="l00563" /><CodeLine lineNumber="563"><Highlight kind="comment">/// Loop:</Highlight></CodeLine>
<Link id="l00564" /><CodeLine lineNumber="564"><Highlight kind="comment">/// ...</Highlight></CodeLine>
<Link id="l00565" /><CodeLine lineNumber="565"><Highlight kind="comment">/// End:</Highlight></CodeLine>
<Link id="l00566" /><CodeLine lineNumber="566"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00567" /><CodeLine lineNumber="567"><Highlight kind="comment">/// &#42;&#42;&#42;Epilog case&#42;&#42;&#42;</Highlight></CodeLine>
<Link id="l00568" /><CodeLine lineNumber="568"><Highlight kind="comment">///        extraiters = tripcount % loopfactor</Highlight></CodeLine>
<Link id="l00569" /><CodeLine lineNumber="569"><Highlight kind="comment">///        if (tripcount &lt; loopfactor) jump LoopExit:</Highlight></CodeLine>
<Link id="l00570" /><CodeLine lineNumber="570"><Highlight kind="comment">///        unroll&#95;iters = tripcount - extraiters</Highlight></CodeLine>
<Link id="l00571" /><CodeLine lineNumber="571"><Highlight kind="comment">/// Loop:  LoopBody; (executes unroll&#95;iter times);</Highlight></CodeLine>
<Link id="l00572" /><CodeLine lineNumber="572"><Highlight kind="comment">///        unroll&#95;iter -= 1</Highlight></CodeLine>
<Link id="l00573" /><CodeLine lineNumber="573"><Highlight kind="comment">///        if (unroll&#95;iter != 0) jump Loop:</Highlight></CodeLine>
<Link id="l00574" /><CodeLine lineNumber="574"><Highlight kind="comment">/// LoopExit:</Highlight></CodeLine>
<Link id="l00575" /><CodeLine lineNumber="575"><Highlight kind="comment">///        if (extraiters == 0) jump EpilExit:</Highlight></CodeLine>
<Link id="l00576" /><CodeLine lineNumber="576"><Highlight kind="comment">/// Epil:  LoopBody; (executes extraiters times)</Highlight></CodeLine>
<Link id="l00577" /><CodeLine lineNumber="577"><Highlight kind="comment">///        extraiters -= 1                 // Omitted if unroll factor is 2</Highlight></CodeLine>
<Link id="l00578" /><CodeLine lineNumber="578"><Highlight kind="comment">///        if (extraiters != 0) jump Epil: // Omitted if unroll factor is 2</Highlight></CodeLine>
<Link id="l00579" /><CodeLine lineNumber="579"><Highlight kind="comment">/// EpilExit:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00580" /><CodeLine lineNumber="580"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00581" /><CodeLine lineNumber="581" lineLink="/docs/api/namespaces/llvm/#acd628d451ca9d9b021876d59f46e670b"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/#acd628d451ca9d9b021876d59f46e670b">llvm::UnrollRuntimeLoopRemainder</a>(</Highlight></CodeLine>
<Link id="l00582" /><CodeLine lineNumber="582"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L, </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a>, </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> AllowExpensiveTripCount,</Highlight></CodeLine>
<Link id="l00583" /><CodeLine lineNumber="583"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> UseEpilogRemainder, </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> UnrollRemainder, </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> ForgetAllSCEV,</Highlight></CodeLine>
<Link id="l00584" /><CodeLine lineNumber="584"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &#42;LI, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42;SE, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &#42;DT, <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &#42;AC,</Highlight></CodeLine>
<Link id="l00585" /><CodeLine lineNumber="585"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/targettransforminfo">TargetTransformInfo</a> &#42;<a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>, </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> PreserveLCSSA,</Highlight></CodeLine>
<Link id="l00586" /><CodeLine lineNumber="586"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> SCEVExpansionBudget, </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> RuntimeUnrollMultiExit,</Highlight></CodeLine>
<Link id="l00587" /><CodeLine lineNumber="587"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;&#42;ResultLoop) &#123;</Highlight></CodeLine>
<Link id="l00588" /><CodeLine lineNumber="588"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Trying runtime unrolling on Loop: \\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00589" /><CodeLine lineNumber="589"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(L-&gt;dump());</Highlight></CodeLine>
<Link id="l00590" /><CodeLine lineNumber="590"><Highlight kind="normal">  <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(UseEpilogRemainder ? <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Using epilog remainder.\\n&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00591" /><CodeLine lineNumber="591"><Highlight kind="normal">                                : <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Using prolog remainder.\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00592" /><CodeLine lineNumber="592"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00593" /><CodeLine lineNumber="593"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Make sure the loop is in canonical form.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00594" /><CodeLine lineNumber="594"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!L-&gt;isLoopSimplifyForm()) &#123;</Highlight></CodeLine>
<Link id="l00595" /><CodeLine lineNumber="595"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Not in simplify form!\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00596" /><CodeLine lineNumber="596"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00597" /><CodeLine lineNumber="597"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00598" /><CodeLine lineNumber="598"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00599" /><CodeLine lineNumber="599"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Guaranteed by LoopSimplifyForm.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00600" /><CodeLine lineNumber="600"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Latch = L-&gt;getLoopLatch();</Highlight></CodeLine>
<Link id="l00601" /><CodeLine lineNumber="601"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Header = L-&gt;getHeader();</Highlight></CodeLine>
<Link id="l00602" /><CodeLine lineNumber="602"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00603" /><CodeLine lineNumber="603"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;LatchBR = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BranchInst&gt;</a>(Latch-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l00604" /><CodeLine lineNumber="604"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00605" /><CodeLine lineNumber="605"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!LatchBR || LatchBR-&gt;<a href="/docs/api/classes/llvm/branchinst/#ad56f6a9b5cd05940017c4544df48bc30">isUnconditional</a>()) &#123;</Highlight></CodeLine>
<Link id="l00606" /><CodeLine lineNumber="606"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// The loop-rotate pass can be helpful to avoid this in many cases.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00607" /><CodeLine lineNumber="607"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(</Highlight></CodeLine>
<Link id="l00608" /><CodeLine lineNumber="608"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>()</Highlight></CodeLine>
<Link id="l00609" /><CodeLine lineNumber="609"><Highlight kind="normal">        &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Loop latch not terminated by a conditional branch.\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00610" /><CodeLine lineNumber="610"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00611" /><CodeLine lineNumber="611"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00612" /><CodeLine lineNumber="612"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00613" /><CodeLine lineNumber="613"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> ExitIndex = LatchBR-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(0) == Header ? 1 : 0;</Highlight></CodeLine>
<Link id="l00614" /><CodeLine lineNumber="614"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;LatchExit = LatchBR-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(ExitIndex);</Highlight></CodeLine>
<Link id="l00615" /><CodeLine lineNumber="615"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00616" /><CodeLine lineNumber="616"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L-&gt;contains(LatchExit)) &#123;</Highlight></CodeLine>
<Link id="l00617" /><CodeLine lineNumber="617"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Cloning the loop basic blocks (&#96;CloneLoopBlocks&#96;) requires that one of the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00618" /><CodeLine lineNumber="618"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// targets of the Latch be an exit block out of the loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00619" /><CodeLine lineNumber="619"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(</Highlight></CodeLine>
<Link id="l00620" /><CodeLine lineNumber="620"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>()</Highlight></CodeLine>
<Link id="l00621" /><CodeLine lineNumber="621"><Highlight kind="normal">        &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;One of the loop latch successors must be the exit block.\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00622" /><CodeLine lineNumber="622"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00623" /><CodeLine lineNumber="623"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00624" /><CodeLine lineNumber="624"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00625" /><CodeLine lineNumber="625"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// These are exit blocks other than the target of the latch exiting block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00626" /><CodeLine lineNumber="626"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 4&gt;</a> OtherExits;</Highlight></CodeLine>
<Link id="l00627" /><CodeLine lineNumber="627"><Highlight kind="normal">  L-&gt;getUniqueNonLatchExitBlocks(OtherExits);</Highlight></CodeLine>
<Link id="l00628" /><CodeLine lineNumber="628"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Support only single exit and exiting block unless multi-exit loop</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00629" /><CodeLine lineNumber="629"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// unrolling is enabled.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00630" /><CodeLine lineNumber="630"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!L-&gt;getExitingBlock() || OtherExits.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>()) &#123;</Highlight></CodeLine>
<Link id="l00631" /><CodeLine lineNumber="631"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We rely on LCSSA form being preserved when the exit blocks are transformed.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00632" /><CodeLine lineNumber="632"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// (Note that only an off-by-default mode of the old PM disables PreserveLCCA.)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00633" /><CodeLine lineNumber="633"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!PreserveLCSSA)</Highlight></CodeLine>
<Link id="l00634" /><CodeLine lineNumber="634"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00635" /><CodeLine lineNumber="635"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00636" /><CodeLine lineNumber="636"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!RuntimeUnrollMultiExit &amp;&amp;</Highlight></CodeLine>
<Link id="l00637" /><CodeLine lineNumber="637"><Highlight kind="normal">        !<a href="#a98b4edd31a148a751a95e80997f81c31">canProfitablyRuntimeUnrollMultiExitLoop</a>(L, OtherExits, LatchExit,</Highlight></CodeLine>
<Link id="l00638" /><CodeLine lineNumber="638"><Highlight kind="normal">                                                 UseEpilogRemainder)) &#123;</Highlight></CodeLine>
<Link id="l00639" /><CodeLine lineNumber="639"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(</Highlight></CodeLine>
<Link id="l00640" /><CodeLine lineNumber="640"><Highlight kind="normal">          <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>()</Highlight></CodeLine>
<Link id="l00641" /><CodeLine lineNumber="641"><Highlight kind="normal">          &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Multiple exit/exiting blocks in loop and multi-exit unrolling not &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00642" /><CodeLine lineNumber="642"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;enabled!\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00643" /><CodeLine lineNumber="643"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00644" /><CodeLine lineNumber="644"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00645" /><CodeLine lineNumber="645"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00646" /><CodeLine lineNumber="646"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Use Scalar Evolution to compute the trip count. This allows more loops to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00647" /><CodeLine lineNumber="647"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// be unrolled than relying on induction var simplification.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00648" /><CodeLine lineNumber="648"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!SE)</Highlight></CodeLine>
<Link id="l00649" /><CodeLine lineNumber="649"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00650" /><CodeLine lineNumber="650"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00651" /><CodeLine lineNumber="651"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Only unroll loops with a computable trip count.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00652" /><CodeLine lineNumber="652"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We calculate the backedge count by using getExitCount on the Latch block,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00653" /><CodeLine lineNumber="653"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// which is proven to be the only exiting block in this loop. This is same as</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00654" /><CodeLine lineNumber="654"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// calculating getBackedgeTakenCount on the loop (which computes SCEV for all</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00655" /><CodeLine lineNumber="655"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// exiting blocks).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00656" /><CodeLine lineNumber="656"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;BECountSC = SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#ab24add5df0874cdfa47b47b1d9926e9e">getExitCount</a>(L, Latch);</Highlight></CodeLine>
<Link id="l00657" /><CodeLine lineNumber="657"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;SCEVCouldNotCompute&gt;</a>(BECountSC)) &#123;</Highlight></CodeLine>
<Link id="l00658" /><CodeLine lineNumber="658"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Could not compute exit block SCEV\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00659" /><CodeLine lineNumber="659"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00660" /><CodeLine lineNumber="660"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00661" /><CodeLine lineNumber="661"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00662" /><CodeLine lineNumber="662"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> BEWidth = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;IntegerType&gt;</a>(BECountSC-&gt;<a href="/docs/api/classes/llvm/scev/#aefeda9454a5e8dfcec3deb106964832a">getType</a>())-&gt;getBitWidth();</Highlight></CodeLine>
<Link id="l00663" /><CodeLine lineNumber="663"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00664" /><CodeLine lineNumber="664"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Add 1 since the backedge count doesn&#39;t include the first loop iteration.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00665" /><CodeLine lineNumber="665"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// (Note that overflow can occur, this is handled explicitly below)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00666" /><CodeLine lineNumber="666"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;TripCountSC =</Highlight></CodeLine>
<Link id="l00667" /><CodeLine lineNumber="667"><Highlight kind="normal">      SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#aef6d2bea715d1793e956f41ddeea2320">getAddExpr</a>(BECountSC, SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a2eb94d079d8416118f4aaed865ab05d7">getConstant</a>(BECountSC-&gt;<a href="/docs/api/classes/llvm/scev/#aefeda9454a5e8dfcec3deb106964832a">getType</a>(), 1));</Highlight></CodeLine>
<Link id="l00668" /><CodeLine lineNumber="668"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;SCEVCouldNotCompute&gt;</a>(TripCountSC)) &#123;</Highlight></CodeLine>
<Link id="l00669" /><CodeLine lineNumber="669"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Could not compute trip count SCEV.\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00670" /><CodeLine lineNumber="670"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00671" /><CodeLine lineNumber="671"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00672" /><CodeLine lineNumber="672"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00673" /><CodeLine lineNumber="673"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;PreHeader = L-&gt;getLoopPreheader();</Highlight></CodeLine>
<Link id="l00674" /><CodeLine lineNumber="674"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;PreHeaderBR = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BranchInst&gt;</a>(PreHeader-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l00675" /><CodeLine lineNumber="675"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/datalayout">DataLayout</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a> = Header-&gt;getDataLayout();</Highlight></CodeLine>
<Link id="l00676" /><CodeLine lineNumber="676"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/scevexpander">SCEVExpander</a> Expander(&#42;SE, <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>, </Highlight><Highlight kind="stringliteral">&quot;loop-unroll&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00677" /><CodeLine lineNumber="677"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!AllowExpensiveTripCount &amp;&amp;</Highlight></CodeLine>
<Link id="l00678" /><CodeLine lineNumber="678"><Highlight kind="normal">      Expander.<a href="/docs/api/classes/llvm/scevexpander/#a5a1f8f7e12808825560c7a10ec2f970b">isHighCostExpansion</a>(TripCountSC, L, SCEVExpansionBudget, <a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>,</Highlight></CodeLine>
<Link id="l00679" /><CodeLine lineNumber="679"><Highlight kind="normal">                                   PreHeaderBR)) &#123;</Highlight></CodeLine>
<Link id="l00680" /><CodeLine lineNumber="680"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;High cost for expanding trip count scev!\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00681" /><CodeLine lineNumber="681"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00682" /><CodeLine lineNumber="682"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00683" /><CodeLine lineNumber="683"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00684" /><CodeLine lineNumber="684"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// This constraint lets us deal with an overflowing trip count easily; see the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00685" /><CodeLine lineNumber="685"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// comment on ModVal below.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00686" /><CodeLine lineNumber="686"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a646986783f35e0fef8988f0f28d2589f">Log2&#95;32</a>(<a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a>) &gt; BEWidth) &#123;</Highlight></CodeLine>
<Link id="l00687" /><CodeLine lineNumber="687"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(</Highlight></CodeLine>
<Link id="l00688" /><CodeLine lineNumber="688"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>()</Highlight></CodeLine>
<Link id="l00689" /><CodeLine lineNumber="689"><Highlight kind="normal">        &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Count failed constraint on overflow trip count calculation.\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00690" /><CodeLine lineNumber="690"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00691" /><CodeLine lineNumber="691"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00692" /><CodeLine lineNumber="692"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00693" /><CodeLine lineNumber="693"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Loop structure is the following:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00694" /><CodeLine lineNumber="694"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00695" /><CodeLine lineNumber="695"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// PreHeader</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00696" /><CodeLine lineNumber="696"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   Header</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00697" /><CodeLine lineNumber="697"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   ...</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00698" /><CodeLine lineNumber="698"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   Latch</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00699" /><CodeLine lineNumber="699"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// LatchExit</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00700" /><CodeLine lineNumber="700"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00701" /><CodeLine lineNumber="701"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewPreHeader;</Highlight></CodeLine>
<Link id="l00702" /><CodeLine lineNumber="702"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewExit = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00703" /><CodeLine lineNumber="703"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;PrologExit = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00704" /><CodeLine lineNumber="704"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;EpilogPreHeader = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00705" /><CodeLine lineNumber="705"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;PrologPreHeader = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00706" /><CodeLine lineNumber="706"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00707" /><CodeLine lineNumber="707"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UseEpilogRemainder) &#123;</Highlight></CodeLine>
<Link id="l00708" /><CodeLine lineNumber="708"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If epilog remainder</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00709" /><CodeLine lineNumber="709"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Split PreHeader to insert a branch around loop for unrolling.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00710" /><CodeLine lineNumber="710"><Highlight kind="normal">    NewPreHeader = <a href="/docs/api/namespaces/llvm/#ac6c9ffe7979754415f4ca0d677174bc2">SplitBlock</a>(PreHeader, PreHeader-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>(), DT, LI);</Highlight></CodeLine>
<Link id="l00711" /><CodeLine lineNumber="711"><Highlight kind="normal">    NewPreHeader-&gt;<a href="/docs/api/classes/llvm/value/#a35ee267850af7c235474a8c46c7ac5af">setName</a>(PreHeader-&gt;<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>() + </Highlight><Highlight kind="stringliteral">&quot;.new&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00712" /><CodeLine lineNumber="712"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Split LatchExit to create phi nodes from branch above.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00713" /><CodeLine lineNumber="713"><Highlight kind="normal">    NewExit = <a href="/docs/api/namespaces/llvm/#a9d391b6acc6d90c9b8a8442324b1aa6f">SplitBlockPredecessors</a>(LatchExit, &#123;Latch&#125;, </Highlight><Highlight kind="stringliteral">&quot;.unr-lcssa&quot;</Highlight><Highlight kind="normal">, DT, LI,</Highlight></CodeLine>
<Link id="l00714" /><CodeLine lineNumber="714"><Highlight kind="normal">                                     </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">, PreserveLCSSA);</Highlight></CodeLine>
<Link id="l00715" /><CodeLine lineNumber="715"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// NewExit gets its DebugLoc from LatchExit, which is not part of the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00716" /><CodeLine lineNumber="716"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// original Loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00717" /><CodeLine lineNumber="717"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Fix this by setting Loop&#39;s DebugLoc to NewExit.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00718" /><CodeLine lineNumber="718"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;NewExitTerminator = NewExit-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>();</Highlight></CodeLine>
<Link id="l00719" /><CodeLine lineNumber="719"><Highlight kind="normal">    NewExitTerminator-&gt;<a href="/docs/api/classes/llvm/instruction/#ae8f5bf5cc06f696b52c709677df00fbf">setDebugLoc</a>(Header-&gt;getTerminator()-&gt;getDebugLoc());</Highlight></CodeLine>
<Link id="l00720" /><CodeLine lineNumber="720"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Split NewExit to insert epilog remainder loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00721" /><CodeLine lineNumber="721"><Highlight kind="normal">    EpilogPreHeader = <a href="/docs/api/namespaces/llvm/#ac6c9ffe7979754415f4ca0d677174bc2">SplitBlock</a>(NewExit, NewExitTerminator, DT, LI);</Highlight></CodeLine>
<Link id="l00722" /><CodeLine lineNumber="722"><Highlight kind="normal">    EpilogPreHeader-&gt;<a href="/docs/api/classes/llvm/value/#a35ee267850af7c235474a8c46c7ac5af">setName</a>(Header-&gt;getName() + </Highlight><Highlight kind="stringliteral">&quot;.epil.preheader&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00723" /><CodeLine lineNumber="723"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00724" /><CodeLine lineNumber="724"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If the latch exits from multiple level of nested loops, then</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00725" /><CodeLine lineNumber="725"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// by assumption there must be another loop exit which branches to the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00726" /><CodeLine lineNumber="726"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// outer loop and we must adjust the loop for the newly inserted blocks</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00727" /><CodeLine lineNumber="727"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// to account for the fact that our epilogue is still in the same outer</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00728" /><CodeLine lineNumber="728"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// loop. Note that this leaves loopinfo temporarily out of sync with the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00729" /><CodeLine lineNumber="729"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// CFG until the actual epilogue loop is inserted.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00730" /><CodeLine lineNumber="730"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ParentL = L-&gt;getParentLoop())</Highlight></CodeLine>
<Link id="l00731" /><CodeLine lineNumber="731"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (LI-&gt;getLoopFor(LatchExit) != ParentL) &#123;</Highlight></CodeLine>
<Link id="l00732" /><CodeLine lineNumber="732"><Highlight kind="normal">        LI-&gt;removeBlock(NewExit);</Highlight></CodeLine>
<Link id="l00733" /><CodeLine lineNumber="733"><Highlight kind="normal">        ParentL-&gt;addBasicBlockToLoop(NewExit, &#42;LI);</Highlight></CodeLine>
<Link id="l00734" /><CodeLine lineNumber="734"><Highlight kind="normal">        LI-&gt;removeBlock(EpilogPreHeader);</Highlight></CodeLine>
<Link id="l00735" /><CodeLine lineNumber="735"><Highlight kind="normal">        ParentL-&gt;addBasicBlockToLoop(EpilogPreHeader, &#42;LI);</Highlight></CodeLine>
<Link id="l00736" /><CodeLine lineNumber="736"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00737" /><CodeLine lineNumber="737"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00738" /><CodeLine lineNumber="738"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00739" /><CodeLine lineNumber="739"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If prolog remainder</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00740" /><CodeLine lineNumber="740"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Split the original preheader twice to insert prolog remainder loop</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00741" /><CodeLine lineNumber="741"><Highlight kind="normal">    PrologPreHeader = <a href="/docs/api/namespaces/llvm/#adf83581f514774264d616eef5706cf6e">SplitEdge</a>(PreHeader, Header, DT, LI);</Highlight></CodeLine>
<Link id="l00742" /><CodeLine lineNumber="742"><Highlight kind="normal">    PrologPreHeader-&gt;<a href="/docs/api/classes/llvm/value/#a35ee267850af7c235474a8c46c7ac5af">setName</a>(Header-&gt;getName() + </Highlight><Highlight kind="stringliteral">&quot;.prol.preheader&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00743" /><CodeLine lineNumber="743"><Highlight kind="normal">    PrologExit = <a href="/docs/api/namespaces/llvm/#ac6c9ffe7979754415f4ca0d677174bc2">SplitBlock</a>(PrologPreHeader, PrologPreHeader-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>(),</Highlight></CodeLine>
<Link id="l00744" /><CodeLine lineNumber="744"><Highlight kind="normal">                            DT, LI);</Highlight></CodeLine>
<Link id="l00745" /><CodeLine lineNumber="745"><Highlight kind="normal">    PrologExit-&gt;<a href="/docs/api/classes/llvm/value/#a35ee267850af7c235474a8c46c7ac5af">setName</a>(Header-&gt;getName() + </Highlight><Highlight kind="stringliteral">&quot;.prol.loopexit&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00746" /><CodeLine lineNumber="746"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Split PrologExit to get NewPreHeader.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00747" /><CodeLine lineNumber="747"><Highlight kind="normal">    NewPreHeader = <a href="/docs/api/namespaces/llvm/#ac6c9ffe7979754415f4ca0d677174bc2">SplitBlock</a>(PrologExit, PrologExit-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>(), DT, LI);</Highlight></CodeLine>
<Link id="l00748" /><CodeLine lineNumber="748"><Highlight kind="normal">    NewPreHeader-&gt;<a href="/docs/api/classes/llvm/value/#a35ee267850af7c235474a8c46c7ac5af">setName</a>(PreHeader-&gt;<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>() + </Highlight><Highlight kind="stringliteral">&quot;.new&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00749" /><CodeLine lineNumber="749"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00750" /><CodeLine lineNumber="750"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Loop structure should be the following:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00751" /><CodeLine lineNumber="751"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//  Epilog             Prolog</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00752" /><CodeLine lineNumber="752"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00753" /><CodeLine lineNumber="753"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// PreHeader         PreHeader</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00754" /><CodeLine lineNumber="754"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// &#42;NewPreHeader     &#42;PrologPreHeader</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00755" /><CodeLine lineNumber="755"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   Header          &#42;PrologExit</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00756" /><CodeLine lineNumber="756"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   ...             &#42;NewPreHeader</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00757" /><CodeLine lineNumber="757"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   Latch             Header</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00758" /><CodeLine lineNumber="758"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// &#42;NewExit            ...</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00759" /><CodeLine lineNumber="759"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// &#42;EpilogPreHeader    Latch</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00760" /><CodeLine lineNumber="760"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// LatchExit              LatchExit</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00761" /><CodeLine lineNumber="761"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00762" /><CodeLine lineNumber="762"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Calculate conditions for branch around loop for unrolling</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00763" /><CodeLine lineNumber="763"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// in epilog case and around prolog remainder loop in prolog case.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00764" /><CodeLine lineNumber="764"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Compute the number of extra iterations required, which is:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00765" /><CodeLine lineNumber="765"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//  extra iterations = run-time trip count % loop unroll factor</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00766" /><CodeLine lineNumber="766"><Highlight kind="normal">  PreHeaderBR = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BranchInst&gt;</a>(PreHeader-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l00767" /><CodeLine lineNumber="767"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>(PreHeaderBR);</Highlight></CodeLine>
<Link id="l00768" /><CodeLine lineNumber="768"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;TripCount = Expander.<a href="/docs/api/classes/llvm/scevexpander/#ac711b5659270bd9e66b8f38ec481260c">expandCodeFor</a>(TripCountSC, TripCountSC-&gt;<a href="/docs/api/classes/llvm/scev/#aefeda9454a5e8dfcec3deb106964832a">getType</a>(),</Highlight></CodeLine>
<Link id="l00769" /><CodeLine lineNumber="769"><Highlight kind="normal">                                            PreHeaderBR);</Highlight></CodeLine>
<Link id="l00770" /><CodeLine lineNumber="770"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;BECount;</Highlight></CodeLine>
<Link id="l00771" /><CodeLine lineNumber="771"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If there are other exits before the latch, that may cause the latch exit</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00772" /><CodeLine lineNumber="772"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// branch to never be executed, and the latch exit count may be poison.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00773" /><CodeLine lineNumber="773"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// In this case, freeze the TripCount and base BECount on the frozen</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00774" /><CodeLine lineNumber="774"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// TripCount. We will introduce two branches using these values, and it&#39;s</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00775" /><CodeLine lineNumber="775"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// important that they see a consistent value (which would not be guaranteed</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00776" /><CodeLine lineNumber="776"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// if were frozen independently.)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00777" /><CodeLine lineNumber="777"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> ((!OtherExits.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#ad9a3c7bc26b130377bbafc170b5f88a2">empty</a>() || !SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a3db092f7661158b76135b3b7d39f0991">loopHasNoAbnormalExits</a>(L)) &amp;&amp;</Highlight></CodeLine>
<Link id="l00778" /><CodeLine lineNumber="778"><Highlight kind="normal">      !<a href="/docs/api/namespaces/llvm/#ab8a7ef433279aabf7f30fa5504a4d4ef">isGuaranteedNotToBeUndefOrPoison</a>(TripCount, AC, PreHeaderBR, DT)) &#123;</Highlight></CodeLine>
<Link id="l00779" /><CodeLine lineNumber="779"><Highlight kind="normal">    TripCount = <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>.CreateFreeze(TripCount);</Highlight></CodeLine>
<Link id="l00780" /><CodeLine lineNumber="780"><Highlight kind="normal">    BECount =</Highlight></CodeLine>
<Link id="l00781" /><CodeLine lineNumber="781"><Highlight kind="normal">        <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>.CreateAdd(TripCount, <a href="/docs/api/classes/llvm/constant/#a4d51384de6e1798bb6aa875aebeea9f0">Constant::getAllOnesValue</a>(TripCount-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>()));</Highlight></CodeLine>
<Link id="l00782" /><CodeLine lineNumber="782"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00783" /><CodeLine lineNumber="783"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If we don&#39;t need to freeze, use SCEVExpander for BECount as well, to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00784" /><CodeLine lineNumber="784"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// allow slightly better value reuse.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00785" /><CodeLine lineNumber="785"><Highlight kind="normal">    BECount =</Highlight></CodeLine>
<Link id="l00786" /><CodeLine lineNumber="786"><Highlight kind="normal">        Expander.<a href="/docs/api/classes/llvm/scevexpander/#ac711b5659270bd9e66b8f38ec481260c">expandCodeFor</a>(BECountSC, BECountSC-&gt;<a href="/docs/api/classes/llvm/scev/#aefeda9454a5e8dfcec3deb106964832a">getType</a>(), PreHeaderBR);</Highlight></CodeLine>
<Link id="l00787" /><CodeLine lineNumber="787"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00788" /><CodeLine lineNumber="788"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00789" /><CodeLine lineNumber="789"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/value">Value</a> &#42; </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> ModVal = <a href="#a7bab17532f2b606ad25679ed9e138c73">CreateTripRemainder</a>(<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>, BECount, TripCount, <a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a>);</Highlight></CodeLine>
<Link id="l00790" /><CodeLine lineNumber="790"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00791" /><CodeLine lineNumber="791"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/value">Value</a> &#42;BranchVal =</Highlight></CodeLine>
<Link id="l00792" /><CodeLine lineNumber="792"><Highlight kind="normal">      UseEpilogRemainder ? <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>.CreateICmpULT(BECount,</Highlight></CodeLine>
<Link id="l00793" /><CodeLine lineNumber="793"><Highlight kind="normal">                                           ConstantInt::get(BECount-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>(),</Highlight></CodeLine>
<Link id="l00794" /><CodeLine lineNumber="794"><Highlight kind="normal">                                                            <a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a> - 1)) :</Highlight></CodeLine>
<Link id="l00795" /><CodeLine lineNumber="795"><Highlight kind="normal">                           <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>.CreateIsNotNull(ModVal, </Highlight><Highlight kind="stringliteral">&quot;lcmp.mod&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00796" /><CodeLine lineNumber="796"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;RemainderLoop = UseEpilogRemainder ? NewExit : PrologPreHeader;</Highlight></CodeLine>
<Link id="l00797" /><CodeLine lineNumber="797"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;UnrollingLoop = UseEpilogRemainder ? NewPreHeader : PrologExit;</Highlight></CodeLine>
<Link id="l00798" /><CodeLine lineNumber="798"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Branch to either remainder (extra iterations) loop or unrolling loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00799" /><CodeLine lineNumber="799"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42;BranchWeights = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00800" /><CodeLine lineNumber="800"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#add2fce2ce0e32b20e41b0aa9f8ca70c2">hasBranchWeightMD</a>(&#42;Latch-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>())) &#123;</Highlight></CodeLine>
<Link id="l00801" /><CodeLine lineNumber="801"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Assume loop is nearly always entered.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00802" /><CodeLine lineNumber="802"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/mdbuilder">MDBuilder</a> MDB(<a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>.getContext());</Highlight></CodeLine>
<Link id="l00803" /><CodeLine lineNumber="803"><Highlight kind="normal">    BranchWeights = MDB.<a href="/docs/api/classes/llvm/mdbuilder/#a75043d12a76b84200e9ed593719dc5eb">createBranchWeights</a>(<a href="#ae905d898b267ca244e6d89fb1fba7c0e">EpilogHeaderWeights</a>);</Highlight></CodeLine>
<Link id="l00804" /><CodeLine lineNumber="804"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00805" /><CodeLine lineNumber="805"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/ir/builtingcs-cpp/#ae76959fe811ba090de4cba69ac00f1da">B</a>.CreateCondBr(BranchVal, RemainderLoop, UnrollingLoop, BranchWeights);</Highlight></CodeLine>
<Link id="l00806" /><CodeLine lineNumber="806"><Highlight kind="normal">  PreHeaderBR-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</Highlight></CodeLine>
<Link id="l00807" /><CodeLine lineNumber="807"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DT) &#123;</Highlight></CodeLine>
<Link id="l00808" /><CodeLine lineNumber="808"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UseEpilogRemainder)</Highlight></CodeLine>
<Link id="l00809" /><CodeLine lineNumber="809"><Highlight kind="normal">      DT-&gt;<a href="/docs/api/classes/llvm/dominatortreebase/#a2881c226e1c102190d54c3b664330aba">changeImmediateDominator</a>(NewExit, PreHeader);</Highlight></CodeLine>
<Link id="l00810" /><CodeLine lineNumber="810"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00811" /><CodeLine lineNumber="811"><Highlight kind="normal">      DT-&gt;<a href="/docs/api/classes/llvm/dominatortreebase/#a2881c226e1c102190d54c3b664330aba">changeImmediateDominator</a>(PrologExit, PreHeader);</Highlight></CodeLine>
<Link id="l00812" /><CodeLine lineNumber="812"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00813" /><CodeLine lineNumber="813"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = Header-&gt;getParent();</Highlight></CodeLine>
<Link id="l00814" /><CodeLine lineNumber="814"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Get an ordered list of blocks in the loop to help with the ordering of the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00815" /><CodeLine lineNumber="815"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// cloned blocks in the prolog/epilog code</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00816" /><CodeLine lineNumber="816"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loopblocksdfs">LoopBlocksDFS</a> LoopBlocks(L);</Highlight></CodeLine>
<Link id="l00817" /><CodeLine lineNumber="817"><Highlight kind="normal">  LoopBlocks.<a href="/docs/api/classes/llvm/loopblocksdfs/#adc85a5f08fb0f5dc3e053975995c9d29">perform</a>(LI);</Highlight></CodeLine>
<Link id="l00818" /><CodeLine lineNumber="818"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00819" /><CodeLine lineNumber="819"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00820" /><CodeLine lineNumber="820"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// For each extra loop iteration, create a copy of the loop&#39;s basic blocks</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00821" /><CodeLine lineNumber="821"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// and generate a condition that branches to the copy depending on the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00822" /><CodeLine lineNumber="822"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// number of &#39;left over&#39; iterations.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00823" /><CodeLine lineNumber="823"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00824" /><CodeLine lineNumber="824"><Highlight kind="normal">  std::vector&lt;BasicBlock &#42;&gt; NewBlocks;</Highlight></CodeLine>
<Link id="l00825" /><CodeLine lineNumber="825"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> VMap;</Highlight></CodeLine>
<Link id="l00826" /><CodeLine lineNumber="826"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00827" /><CodeLine lineNumber="827"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Clone all the basic blocks in the loop. If Count is 2, we don&#39;t clone</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00828" /><CodeLine lineNumber="828"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the loop, otherwise we create a cloned loop to execute the extra</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00829" /><CodeLine lineNumber="829"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// iterations. This function adds the appropriate CFG connections.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00830" /><CodeLine lineNumber="830"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;InsertBot = UseEpilogRemainder ? LatchExit : PrologExit;</Highlight></CodeLine>
<Link id="l00831" /><CodeLine lineNumber="831"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;InsertTop = UseEpilogRemainder ? EpilogPreHeader : PrologPreHeader;</Highlight></CodeLine>
<Link id="l00832" /><CodeLine lineNumber="832"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;remainderLoop = <a href="#a399d7b7e2e6aec8e1ad80d3d73b7b1c8">CloneLoopBlocks</a>(</Highlight></CodeLine>
<Link id="l00833" /><CodeLine lineNumber="833"><Highlight kind="normal">      L, ModVal, UseEpilogRemainder, UnrollRemainder, InsertTop, InsertBot,</Highlight></CodeLine>
<Link id="l00834" /><CodeLine lineNumber="834"><Highlight kind="normal">      NewPreHeader, NewBlocks, LoopBlocks, VMap, DT, LI, <a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a>);</Highlight></CodeLine>
<Link id="l00835" /><CodeLine lineNumber="835"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00836" /><CodeLine lineNumber="836"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Insert the cloned blocks into the function.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00837" /><CodeLine lineNumber="837"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;splice(InsertBot-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>(), <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, NewBlocks&#91;0&#93;-&gt;getIterator(), <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;end());</Highlight></CodeLine>
<Link id="l00838" /><CodeLine lineNumber="838"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00839" /><CodeLine lineNumber="839"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now the loop blocks are cloned and the other exiting blocks from the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00840" /><CodeLine lineNumber="840"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// remainder are connected to the original Loop&#39;s exit blocks. The remaining</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00841" /><CodeLine lineNumber="841"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// work is to update the phi nodes in the original loop, and take in the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00842" /><CodeLine lineNumber="842"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// values from the cloned region.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00843" /><CodeLine lineNumber="843"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB : OtherExits) &#123;</Highlight></CodeLine>
<Link id="l00844" /><CodeLine lineNumber="844"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Given we preserve LCSSA form, we know that the values used outside the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00845" /><CodeLine lineNumber="845"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// loop will be used through these phi nodes at the exit blocks that are</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00846" /><CodeLine lineNumber="846"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// transformed below.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00847" /><CodeLine lineNumber="847"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/phinode">PHINode</a> &amp;PN : BB-&gt;phis()) &#123;</Highlight></CodeLine>
<Link id="l00848" /><CodeLine lineNumber="848"><Highlight kind="normal">     </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> oldNumOperands = PN.getNumIncomingValues();</Highlight></CodeLine>
<Link id="l00849" /><CodeLine lineNumber="849"><Highlight kind="normal">     </Highlight><Highlight kind="comment">// Add the incoming values from the remainder code to the end of the phi</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00850" /><CodeLine lineNumber="850"><Highlight kind="normal">     </Highlight><Highlight kind="comment">// node.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00851" /><CodeLine lineNumber="851"><Highlight kind="normal">     </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> i = 0; i &lt; oldNumOperands; i++)&#123;</Highlight></CodeLine>
<Link id="l00852" /><CodeLine lineNumber="852"><Highlight kind="normal">       </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;PredBB =PN.getIncomingBlock(i);</Highlight></CodeLine>
<Link id="l00853" /><CodeLine lineNumber="853"><Highlight kind="normal">       </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (PredBB == Latch)</Highlight></CodeLine>
<Link id="l00854" /><CodeLine lineNumber="854"><Highlight kind="normal">         </Highlight><Highlight kind="comment">// The latch exit is handled separately, see connectX</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00855" /><CodeLine lineNumber="855"><Highlight kind="normal">         </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00856" /><CodeLine lineNumber="856"><Highlight kind="normal">       </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!L-&gt;contains(PredBB))</Highlight></CodeLine>
<Link id="l00857" /><CodeLine lineNumber="857"><Highlight kind="normal">         </Highlight><Highlight kind="comment">// Even if we had dedicated exits, the code above inserted an</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00858" /><CodeLine lineNumber="858"><Highlight kind="normal">         </Highlight><Highlight kind="comment">// extra branch which can reach the latch exit.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00859" /><CodeLine lineNumber="859"><Highlight kind="normal">         </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00860" /><CodeLine lineNumber="860"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00861" /><CodeLine lineNumber="861"><Highlight kind="normal">       </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;V = PN.getIncomingValue(i);</Highlight></CodeLine>
<Link id="l00862" /><CodeLine lineNumber="862"><Highlight kind="normal">       </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(V))</Highlight></CodeLine>
<Link id="l00863" /><CodeLine lineNumber="863"><Highlight kind="normal">         </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L-&gt;contains(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</Highlight></CodeLine>
<Link id="l00864" /><CodeLine lineNumber="864"><Highlight kind="normal">           V = VMap.<a href="/docs/api/classes/llvm/valuemap/#a15f92579a5fc316dab8cd1fad51015ef">lookup</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</Highlight></CodeLine>
<Link id="l00865" /><CodeLine lineNumber="865"><Highlight kind="normal">       PN.addIncoming(V, <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(VMap&#91;PredBB&#93;));</Highlight></CodeLine>
<Link id="l00866" /><CodeLine lineNumber="866"><Highlight kind="normal">     &#125;</Highlight></CodeLine>
<Link id="l00867" /><CodeLine lineNumber="867"><Highlight kind="normal">   &#125;</Highlight></CodeLine>
<Link id="l00868" /><CodeLine lineNumber="868"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#if defined(EXPENSIVE&#95;CHECKS) &amp;&amp; !defined(NDEBUG)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00869" /><CodeLine lineNumber="869"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;SuccBB : <a href="/docs/api/namespaces/llvm/#a26e2a938b431eaa6eca2beaa96410c9d">successors</a>(BB)) &#123;</Highlight></CodeLine>
<Link id="l00870" /><CodeLine lineNumber="870"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!(<a href="/docs/api/namespaces/llvm/#acd1cd968cb420c82d70926920fcdc7d7">llvm::is&#95;contained</a>(OtherExits, SuccBB) || SuccBB == LatchExit) &amp;&amp;</Highlight></CodeLine>
<Link id="l00871" /><CodeLine lineNumber="871"><Highlight kind="normal">             </Highlight><Highlight kind="stringliteral">&quot;Breaks the definition of dedicated exits!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00872" /><CodeLine lineNumber="872"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00873" /><CodeLine lineNumber="873"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#endif</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00874" /><CodeLine lineNumber="874"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00875" /><CodeLine lineNumber="875"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00876" /><CodeLine lineNumber="876"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Update the immediate dominator of the exit blocks and blocks that are</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00877" /><CodeLine lineNumber="877"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// reachable from the exit blocks. This is needed because we now have paths</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00878" /><CodeLine lineNumber="878"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// from both the original loop and the remainder code reaching the exit</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00879" /><CodeLine lineNumber="879"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// blocks. While the IDom of these exit blocks were from the original loop,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00880" /><CodeLine lineNumber="880"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// now the IDom is the preheader (which decides whether the original loop or</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00881" /><CodeLine lineNumber="881"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// remainder code should run).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00882" /><CodeLine lineNumber="882"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DT &amp;&amp; !L-&gt;getExitingBlock()) &#123;</Highlight></CodeLine>
<Link id="l00883" /><CodeLine lineNumber="883"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 16&gt;</a> ChildrenToUpdate;</Highlight></CodeLine>
<Link id="l00884" /><CodeLine lineNumber="884"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// NB! We have to examine the dom children of all loop blocks, not just</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00885" /><CodeLine lineNumber="885"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// those which are the IDom of the exit blocks. This is because blocks</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00886" /><CodeLine lineNumber="886"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// reachable from the exit blocks can have their IDom as the nearest common</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00887" /><CodeLine lineNumber="887"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// dominator of the exit blocks.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00888" /><CodeLine lineNumber="888"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB : L-&gt;blocks()) &#123;</Highlight></CodeLine>
<Link id="l00889" /><CodeLine lineNumber="889"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;DomNodeBB = DT-&gt;<a href="/docs/api/classes/llvm/dominatortreebase/#ad8295b9b507d1d847cd46856f8255eab">getNode</a>(BB);</Highlight></CodeLine>
<Link id="l00890" /><CodeLine lineNumber="890"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;DomChild : DomNodeBB-&gt;children()) &#123;</Highlight></CodeLine>
<Link id="l00891" /><CodeLine lineNumber="891"><Highlight kind="normal">        </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;DomChildBB = DomChild-&gt;getBlock();</Highlight></CodeLine>
<Link id="l00892" /><CodeLine lineNumber="892"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!L-&gt;contains(LI-&gt;<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(DomChildBB)))</Highlight></CodeLine>
<Link id="l00893" /><CodeLine lineNumber="893"><Highlight kind="normal">          ChildrenToUpdate.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(DomChildBB);</Highlight></CodeLine>
<Link id="l00894" /><CodeLine lineNumber="894"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00895" /><CodeLine lineNumber="895"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00896" /><CodeLine lineNumber="896"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB : ChildrenToUpdate)</Highlight></CodeLine>
<Link id="l00897" /><CodeLine lineNumber="897"><Highlight kind="normal">      DT-&gt;<a href="/docs/api/classes/llvm/dominatortreebase/#a2881c226e1c102190d54c3b664330aba">changeImmediateDominator</a>(BB, PreHeader);</Highlight></CodeLine>
<Link id="l00898" /><CodeLine lineNumber="898"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00899" /><CodeLine lineNumber="899"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00900" /><CodeLine lineNumber="900"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Loop structure should be the following:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00901" /><CodeLine lineNumber="901"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//  Epilog             Prolog</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00902" /><CodeLine lineNumber="902"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00903" /><CodeLine lineNumber="903"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// PreHeader         PreHeader</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00904" /><CodeLine lineNumber="904"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// NewPreHeader      PrologPreHeader</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00905" /><CodeLine lineNumber="905"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   Header            PrologHeader</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00906" /><CodeLine lineNumber="906"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   ...               ...</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00907" /><CodeLine lineNumber="907"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   Latch             PrologLatch</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00908" /><CodeLine lineNumber="908"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// NewExit           PrologExit</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00909" /><CodeLine lineNumber="909"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// EpilogPreHeader   NewPreHeader</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00910" /><CodeLine lineNumber="910"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   EpilogHeader      Header</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00911" /><CodeLine lineNumber="911"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   ...               ...</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00912" /><CodeLine lineNumber="912"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   EpilogLatch       Latch</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00913" /><CodeLine lineNumber="913"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// LatchExit              LatchExit</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00914" /><CodeLine lineNumber="914"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00915" /><CodeLine lineNumber="915"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Rewrite the cloned instruction operands to use the values created when the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00916" /><CodeLine lineNumber="916"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// clone is created.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00917" /><CodeLine lineNumber="917"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB : NewBlocks) &#123;</Highlight></CodeLine>
<Link id="l00918" /><CodeLine lineNumber="918"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/module">Module</a> &#42;M = BB-&gt;getModule();</Highlight></CodeLine>
<Link id="l00919" /><CodeLine lineNumber="919"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : &#42;BB) &#123;</Highlight></CodeLine>
<Link id="l00920" /><CodeLine lineNumber="920"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a7da684e1cead3524bdd9b0d171aad161">RemapInstruction</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, VMap,</Highlight></CodeLine>
<Link id="l00921" /><CodeLine lineNumber="921"><Highlight kind="normal">                       <a href="/docs/api/namespaces/llvm/#a77724415203930efd07d7098cb1e437da9a24bd8dba1bef2753bc3f087435ae7f">RF&#95;NoModuleLevelChanges</a> | <a href="/docs/api/namespaces/llvm/#a77724415203930efd07d7098cb1e437da5633028bc27ffa8eab39cc5de65b3108">RF&#95;IgnoreMissingLocals</a>);</Highlight></CodeLine>
<Link id="l00922" /><CodeLine lineNumber="922"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a3c6de822ccc920e435932d6cb73ac146">RemapDbgRecordRange</a>(M, <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getDbgRecordRange(), VMap,</Highlight></CodeLine>
<Link id="l00923" /><CodeLine lineNumber="923"><Highlight kind="normal">                          <a href="/docs/api/namespaces/llvm/#a77724415203930efd07d7098cb1e437da9a24bd8dba1bef2753bc3f087435ae7f">RF&#95;NoModuleLevelChanges</a> | <a href="/docs/api/namespaces/llvm/#a77724415203930efd07d7098cb1e437da5633028bc27ffa8eab39cc5de65b3108">RF&#95;IgnoreMissingLocals</a>);</Highlight></CodeLine>
<Link id="l00924" /><CodeLine lineNumber="924"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00925" /><CodeLine lineNumber="925"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00926" /><CodeLine lineNumber="926"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00927" /><CodeLine lineNumber="927"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UseEpilogRemainder) &#123;</Highlight></CodeLine>
<Link id="l00928" /><CodeLine lineNumber="928"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Connect the epilog code to the original loop and update the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00929" /><CodeLine lineNumber="929"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// PHI functions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00930" /><CodeLine lineNumber="930"><Highlight kind="normal">    <a href="#a4ebed10d3e842e81a2df6974c2fd3760">ConnectEpilog</a>(L, ModVal, NewExit, LatchExit, PreHeader, EpilogPreHeader,</Highlight></CodeLine>
<Link id="l00931" /><CodeLine lineNumber="931"><Highlight kind="normal">                  NewPreHeader, VMap, DT, LI, PreserveLCSSA, &#42;SE, <a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a>);</Highlight></CodeLine>
<Link id="l00932" /><CodeLine lineNumber="932"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00933" /><CodeLine lineNumber="933"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Update counter in loop for unrolling.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00934" /><CodeLine lineNumber="934"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Use an incrementing IV.  Pre-incr/post-incr is backedge/trip count.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00935" /><CodeLine lineNumber="935"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Subtle: TestVal can be 0 if we wrapped when computing the trip count,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00936" /><CodeLine lineNumber="936"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// thus we must compare the post-increment (wrapping) value.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00937" /><CodeLine lineNumber="937"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/irbuilder">IRBuilder&lt;&gt;</a> B2(NewPreHeader-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l00938" /><CodeLine lineNumber="938"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;TestVal = B2.<a href="/docs/api/classes/llvm/irbuilderbase/#a92c83e803f2cf22906da0aaec44ff6d7">CreateSub</a>(TripCount, ModVal, </Highlight><Highlight kind="stringliteral">&quot;unroll&#95;iter&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00939" /><CodeLine lineNumber="939"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;LatchBR = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BranchInst&gt;</a>(Latch-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l00940" /><CodeLine lineNumber="940"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;NewIdx = <a href="/docs/api/classes/llvm/phinode/#af4aba918a76ca15bde1be3e14572e475">PHINode::Create</a>(TestVal-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>(), 2, </Highlight><Highlight kind="stringliteral">&quot;niter&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00941" /><CodeLine lineNumber="941"><Highlight kind="normal">    NewIdx-&gt;<a href="/docs/api/classes/llvm/instruction/#a482498a1c760122fd33c7fc8190dd277">insertBefore</a>(Header-&gt;getFirstNonPHIIt());</Highlight></CodeLine>
<Link id="l00942" /><CodeLine lineNumber="942"><Highlight kind="normal">    B2.<a href="/docs/api/classes/llvm/irbuilderbase/#ace45cae6925c65e9d6916e09dd5b17cc">SetInsertPoint</a>(LatchBR);</Highlight></CodeLine>
<Link id="l00943" /><CodeLine lineNumber="943"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;Zero = ConstantInt::get(NewIdx-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>(), 0);</Highlight></CodeLine>
<Link id="l00944" /><CodeLine lineNumber="944"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;One = ConstantInt::get(NewIdx-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>(), 1);</Highlight></CodeLine>
<Link id="l00945" /><CodeLine lineNumber="945"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;IdxNext = B2.<a href="/docs/api/classes/llvm/irbuilderbase/#aada1d6d8de104a5cd1cb9a02c676cc6c">CreateAdd</a>(NewIdx, One, NewIdx-&gt;<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>() + </Highlight><Highlight kind="stringliteral">&quot;.next&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00946" /><CodeLine lineNumber="946"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> Pred = LatchBR-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(0) == Header ? <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78bac17897ebf2f6a6986280fc3bdf28a30a">ICmpInst::ICMP&#95;NE</a> : <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78baa719225e2de4059f93fd3209e1f48218">ICmpInst::ICMP&#95;EQ</a>;</Highlight></CodeLine>
<Link id="l00947" /><CodeLine lineNumber="947"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;IdxCmp = B2.<a href="/docs/api/classes/llvm/irbuilderbase/#ae0bd6c2fab2d18443038a8f3a2b64856">CreateICmp</a>(Pred, IdxNext, TestVal, NewIdx-&gt;<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>() + </Highlight><Highlight kind="stringliteral">&quot;.ncmp&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00948" /><CodeLine lineNumber="948"><Highlight kind="normal">    NewIdx-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(Zero, NewPreHeader);</Highlight></CodeLine>
<Link id="l00949" /><CodeLine lineNumber="949"><Highlight kind="normal">    NewIdx-&gt;<a href="/docs/api/classes/llvm/phinode/#a089cccb6f231efee72abc76d0f9c695f">addIncoming</a>(IdxNext, Latch);</Highlight></CodeLine>
<Link id="l00950" /><CodeLine lineNumber="950"><Highlight kind="normal">    LatchBR-&gt;<a href="/docs/api/classes/llvm/branchinst/#a3505dab06f59c36142a234321cdc3411">setCondition</a>(IdxCmp);</Highlight></CodeLine>
<Link id="l00951" /><CodeLine lineNumber="951"><Highlight kind="normal">  &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00952" /><CodeLine lineNumber="952"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Connect the prolog code to the original loop and update the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00953" /><CodeLine lineNumber="953"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// PHI functions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00954" /><CodeLine lineNumber="954"><Highlight kind="normal">    <a href="#af700561cb065af85122cd321d6c4b989">ConnectProlog</a>(L, BECount, <a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a>, PrologExit, LatchExit, PreHeader,</Highlight></CodeLine>
<Link id="l00955" /><CodeLine lineNumber="955"><Highlight kind="normal">                  NewPreHeader, VMap, DT, LI, PreserveLCSSA, &#42;SE);</Highlight></CodeLine>
<Link id="l00956" /><CodeLine lineNumber="956"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00957" /><CodeLine lineNumber="957"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00958" /><CodeLine lineNumber="958"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If this loop is nested, then the loop unroller changes the code in the any</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00959" /><CodeLine lineNumber="959"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// of its parent loops, so the Scalar Evolution pass needs to be run again.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00960" /><CodeLine lineNumber="960"><Highlight kind="normal">  SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a7d5bfa1ac3c7c096af6b26fb95cd699d">forgetTopmostLoop</a>(L);</Highlight></CodeLine>
<Link id="l00961" /><CodeLine lineNumber="961"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00962" /><CodeLine lineNumber="962"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Verify that the Dom Tree and Loop Info are correct.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00963" /><CodeLine lineNumber="963"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#if defined(EXPENSIVE&#95;CHECKS) &amp;&amp; !defined(NDEBUG)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00964" /><CodeLine lineNumber="964"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DT) &#123;</Highlight></CodeLine>
<Link id="l00965" /><CodeLine lineNumber="965"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(DT-&gt;<a href="/docs/api/classes/llvm/dominatortreebase/#a1f08f2925fec05b265e540d29066b9c8">verify</a>(DominatorTree::VerificationLevel::Full));</Highlight></CodeLine>
<Link id="l00966" /><CodeLine lineNumber="966"><Highlight kind="normal">    LI-&gt;<a href="/docs/api/classes/llvm/loopinfobase/#a17a8f7aba5cca5c7f9faa779a3c4bc37">verify</a>(&#42;DT);</Highlight></CodeLine>
<Link id="l00967" /><CodeLine lineNumber="967"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00968" /><CodeLine lineNumber="968"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#endif</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00969" /><CodeLine lineNumber="969"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00970" /><CodeLine lineNumber="970"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// For unroll factor 2 remainder loop will have 1 iteration.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00971" /><CodeLine lineNumber="971"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a> == 2 &amp;&amp; DT &amp;&amp; LI &amp;&amp; SE) &#123;</Highlight></CodeLine>
<Link id="l00972" /><CodeLine lineNumber="972"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// TODO: This code could probably be pulled out into a helper function</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00973" /><CodeLine lineNumber="973"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// (e.g. breakLoopBackedgeAndSimplify) and reused in loop-deletion.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00974" /><CodeLine lineNumber="974"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;RemainderLatch = remainderLoop-&gt;<a href="/docs/api/classes/llvm/loopbase/#a1230fd674d2609b96527fe65eaf40b1b">getLoopLatch</a>();</Highlight></CodeLine>
<Link id="l00975" /><CodeLine lineNumber="975"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(RemainderLatch);</Highlight></CodeLine>
<Link id="l00976" /><CodeLine lineNumber="976"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;&gt;</a> RemainderBlocks(remainderLoop-&gt;<a href="/docs/api/classes/llvm/loopbase/#ac94e1f7398df9df2508957f58a82279a">getBlocks</a>());</Highlight></CodeLine>
<Link id="l00977" /><CodeLine lineNumber="977"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a9267cf9acba995fd1b10ae1015d048c8">breakLoopBackedge</a>(remainderLoop, &#42;DT, &#42;SE, &#42;LI, </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00978" /><CodeLine lineNumber="978"><Highlight kind="normal">    remainderLoop = </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00979" /><CodeLine lineNumber="979"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00980" /><CodeLine lineNumber="980"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Simplify loop values after breaking the backedge</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00981" /><CodeLine lineNumber="981"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/datalayout">DataLayout</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a> = L-&gt;getHeader()-&gt;getDataLayout();</Highlight></CodeLine>
<Link id="l00982" /><CodeLine lineNumber="982"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;WeakTrackingVH, 16&gt;</a> DeadInsts;</Highlight></CodeLine>
<Link id="l00983" /><CodeLine lineNumber="983"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB : RemainderBlocks) &#123;</Highlight></CodeLine>
<Link id="l00984" /><CodeLine lineNumber="984"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;Inst : <a href="/docs/api/namespaces/llvm/#a3d2cdc4a0db233678e7141c9d6ea3419">llvm::make&#95;early&#95;inc&#95;range</a>(&#42;BB)) &#123;</Highlight></CodeLine>
<Link id="l00985" /><CodeLine lineNumber="985"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/value">Value</a> &#42;V = <a href="/docs/api/namespaces/llvm/#a57feb935aaafd1bd4bfbb8dc56ad2129">simplifyInstruction</a>(&amp;Inst, &#123;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>, </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">, DT, AC&#125;))</Highlight></CodeLine>
<Link id="l00986" /><CodeLine lineNumber="986"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (LI-&gt;<a href="/docs/api/classes/llvm/loopinfo/#ab12b535502b86394c84bfd24d58e4657">replacementPreservesLCSSAForm</a>(&amp;Inst, V))</Highlight></CodeLine>
<Link id="l00987" /><CodeLine lineNumber="987"><Highlight kind="normal">            Inst.replaceAllUsesWith(V);</Highlight></CodeLine>
<Link id="l00988" /><CodeLine lineNumber="988"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a627b2f86ac433d829482d5a5a0f50668">isInstructionTriviallyDead</a>(&amp;Inst))</Highlight></CodeLine>
<Link id="l00989" /><CodeLine lineNumber="989"><Highlight kind="normal">          DeadInsts.<a href="/docs/api/classes/llvm/smallvectorimpl/#a396fcfee6914c76974b73c3d203da6a5">emplace&#95;back</a>(&amp;Inst);</Highlight></CodeLine>
<Link id="l00990" /><CodeLine lineNumber="990"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00991" /><CodeLine lineNumber="991"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// We can&#39;t do recursive deletion until we&#39;re done iterating, as we might</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00992" /><CodeLine lineNumber="992"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// have a phi which (potentially indirectly) uses instructions later in</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00993" /><CodeLine lineNumber="993"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// the block we&#39;re iterating through.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00994" /><CodeLine lineNumber="994"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#a1106b8a15061e8494873e10bb8a364e5">RecursivelyDeleteTriviallyDeadInstructions</a>(DeadInsts);</Highlight></CodeLine>
<Link id="l00995" /><CodeLine lineNumber="995"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00996" /><CodeLine lineNumber="996"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00997" /><CodeLine lineNumber="997"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Merge latch into exit block.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00998" /><CodeLine lineNumber="998"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ExitBB = RemainderLatch-&gt;<a href="/docs/api/classes/llvm/basicblock/#a79c007dcf9fff57e1569e778d7885b5e">getSingleSuccessor</a>();</Highlight></CodeLine>
<Link id="l00999" /><CodeLine lineNumber="999"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(ExitBB &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;required after breaking cond br backedge&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01000" /><CodeLine lineNumber="1000"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/domtreeupdater">DomTreeUpdater</a> DTU(DT, DomTreeUpdater::UpdateStrategy::Eager);</Highlight></CodeLine>
<Link id="l01001" /><CodeLine lineNumber="1001"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#aa76a2cf19b821f320ab439d5659ef4b9">MergeBlockIntoPredecessor</a>(ExitBB, &amp;DTU, LI);</Highlight></CodeLine>
<Link id="l01002" /><CodeLine lineNumber="1002"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01003" /><CodeLine lineNumber="1003"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01004" /><CodeLine lineNumber="1004"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Canonicalize to LoopSimplifyForm both original and remainder loops. We</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01005" /><CodeLine lineNumber="1005"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// cannot rely on the LoopUnrollPass to do this because it only does</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01006" /><CodeLine lineNumber="1006"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// canonicalization for parent/subloops and not the sibling loops.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01007" /><CodeLine lineNumber="1007"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (OtherExits.<a href="/docs/api/classes/llvm/smallvectortemplatecommon/#a1c479a8c434377c2b8cb056bdfdfc201">size</a>() &gt; 0) &#123;</Highlight></CodeLine>
<Link id="l01008" /><CodeLine lineNumber="1008"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Generate dedicated exit blocks for the original loop, to preserve</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01009" /><CodeLine lineNumber="1009"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// LoopSimplifyForm.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01010" /><CodeLine lineNumber="1010"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#ab1f7831449cd72e78894e3dcda705cd8">formDedicatedExitBlocks</a>(L, DT, LI, </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">, PreserveLCSSA);</Highlight></CodeLine>
<Link id="l01011" /><CodeLine lineNumber="1011"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Generate dedicated exit blocks for the remainder loop if one exists, to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01012" /><CodeLine lineNumber="1012"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// preserve LoopSimplifyForm.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01013" /><CodeLine lineNumber="1013"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (remainderLoop)</Highlight></CodeLine>
<Link id="l01014" /><CodeLine lineNumber="1014"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#ab1f7831449cd72e78894e3dcda705cd8">formDedicatedExitBlocks</a>(remainderLoop, DT, LI, </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">, PreserveLCSSA);</Highlight></CodeLine>
<Link id="l01015" /><CodeLine lineNumber="1015"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01016" /><CodeLine lineNumber="1016"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01017" /><CodeLine lineNumber="1017"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> UnrollResult = <a href="/docs/api/namespaces/llvm/#a8c861ddf753ab3690437dceaadf5c7e1aac5e6ff0bb9cd22f9f55570e7b318c84">LoopUnrollResult::Unmodified</a>;</Highlight></CodeLine>
<Link id="l01018" /><CodeLine lineNumber="1018"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (remainderLoop &amp;&amp; UnrollRemainder) &#123;</Highlight></CodeLine>
<Link id="l01019" /><CodeLine lineNumber="1019"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Unrolling remainder loop\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01020" /><CodeLine lineNumber="1020"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/unrollloopoptions">UnrollLoopOptions</a> ULO;</Highlight></CodeLine>
<Link id="l01021" /><CodeLine lineNumber="1021"><Highlight kind="normal">    ULO.<a href="/docs/api/structs/llvm/unrollloopoptions/#a6430dceedf36358dec517d3b7b33ff8a">Count</a> = <a href="/docs/api/namespaces/llvm/#a845e08be4b0320d66901a66b0c0e9509">Count</a> - 1;</Highlight></CodeLine>
<Link id="l01022" /><CodeLine lineNumber="1022"><Highlight kind="normal">    ULO.<a href="/docs/api/structs/llvm/unrollloopoptions/#a6dad0efbe15aa28f9e2a161d518a2443">Force</a> = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01023" /><CodeLine lineNumber="1023"><Highlight kind="normal">    ULO.<a href="/docs/api/structs/llvm/unrollloopoptions/#a020442efb4f0bf105d9e189a6aa12bf4">Runtime</a> = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01024" /><CodeLine lineNumber="1024"><Highlight kind="normal">    ULO.<a href="/docs/api/structs/llvm/unrollloopoptions/#a72709ed73867283dd45477f372c2f6b5">AllowExpensiveTripCount</a> = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01025" /><CodeLine lineNumber="1025"><Highlight kind="normal">    ULO.<a href="/docs/api/structs/llvm/unrollloopoptions/#a6ba8279ac1a377af2a6e26eb0c007002">UnrollRemainder</a> = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01026" /><CodeLine lineNumber="1026"><Highlight kind="normal">    ULO.<a href="/docs/api/structs/llvm/unrollloopoptions/#a8cc60d0e22615680d0410f2e13501ac0">ForgetAllSCEV</a> = ForgetAllSCEV;</Highlight></CodeLine>
<Link id="l01027" /><CodeLine lineNumber="1027"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(!<a href="/docs/api/namespaces/llvm/#a6ff3bf3190a09af37c0a2eee8b5a367c">getLoopConvergenceHeart</a>(L) &amp;&amp;</Highlight></CodeLine>
<Link id="l01028" /><CodeLine lineNumber="1028"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;A loop with a convergence heart does not allow runtime unrolling.&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01029" /><CodeLine lineNumber="1029"><Highlight kind="normal">    UnrollResult = <a href="/docs/api/namespaces/llvm/#af78eb969de6e17fe20fa8834d3e9c9aa">UnrollLoop</a>(remainderLoop, ULO, LI, SE, DT, AC, <a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>,</Highlight></CodeLine>
<Link id="l01030" /><CodeLine lineNumber="1030"><Highlight kind="normal">                              </Highlight><Highlight kind="comment">/&#42;ORE&#42;/</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">, PreserveLCSSA);</Highlight></CodeLine>
<Link id="l01031" /><CodeLine lineNumber="1031"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01032" /><CodeLine lineNumber="1032"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01033" /><CodeLine lineNumber="1033"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (ResultLoop &amp;&amp; UnrollResult != <a href="/docs/api/namespaces/llvm/#a8c861ddf753ab3690437dceaadf5c7e1add722bdf19fff3e686f559790c6124d8">LoopUnrollResult::FullyUnrolled</a>)</Highlight></CodeLine>
<Link id="l01034" /><CodeLine lineNumber="1034"><Highlight kind="normal">    &#42;ResultLoop = remainderLoop;</Highlight></CodeLine>
<Link id="l01035" /><CodeLine lineNumber="1035"><Highlight kind="normal">  NumRuntimeUnrolled++;</Highlight></CodeLine>
<Link id="l01036" /><CodeLine lineNumber="1036"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01037" /><CodeLine lineNumber="1037"><Highlight kind="normal">&#125;</Highlight></CodeLine>

</ProgramListing>


</DoxygenPage>
