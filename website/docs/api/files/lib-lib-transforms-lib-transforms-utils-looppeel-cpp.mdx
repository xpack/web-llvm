---

# DO NOT EDIT!
# Automatically generated via docusaurus-plugin-doxygen by Doxygen.

slug: /api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp
custom_edit_url: null
keywords:
  - doxygen
  - reference
  - file

---

import Link from '@docusaurus/Link'

import CodeLine from '@xpack/docusaurus-plugin-doxygen/components/CodeLine'
import DoxygenPage from '@xpack/docusaurus-plugin-doxygen/components/DoxygenPage'
import IncludesList from '@xpack/docusaurus-plugin-doxygen/components/IncludesList'
import IncludesListItem from '@xpack/docusaurus-plugin-doxygen/components/IncludesListItem'
import MemberDefinition from '@xpack/docusaurus-plugin-doxygen/components/MemberDefinition'
import MembersIndex from '@xpack/docusaurus-plugin-doxygen/components/MembersIndex'
import MembersIndexItem from '@xpack/docusaurus-plugin-doxygen/components/MembersIndexItem'
import ParametersList from '@xpack/docusaurus-plugin-doxygen/components/ParametersList'
import ParametersListItem from '@xpack/docusaurus-plugin-doxygen/components/ParametersListItem'
import ProgramListing from '@xpack/docusaurus-plugin-doxygen/components/ProgramListing'
import SectionDefinition from '@xpack/docusaurus-plugin-doxygen/components/SectionDefinition'

import pluginConfig from '@site/docusaurus-plugin-doxygen-config.json'

# The `LoopPeel.cpp` File Reference

<DoxygenPage pluginConfig={pluginConfig}>



## Included Headers

<IncludesList>
<IncludesListItem
  filePath="llvm/Transforms/Utils/LoopPeel.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/looppeel-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/DenseMap.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/densemap-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SmallVector.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/smallvector-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/Statistic.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/Loads.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/loads-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/LoopInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/loopinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/LoopIterator.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/loopiterator-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/ScalarEvolution.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/scalarevolution-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/ScalarEvolutionExpressions.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/scalarevolutionexpressions-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/TargetTransformInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/targettransforminfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/BasicBlock.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/basicblock-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Dominators.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/dominators-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Function.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/function-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/InstrTypes.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/instrtypes-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Instruction.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/instruction-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Instructions.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/instructions-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/LLVMContext.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/llvmcontext-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/MDBuilder.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/mdbuilder-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/PatternMatch.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/patternmatch-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/ProfDataUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/profdatautils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/Casting.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/casting-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/CommandLine.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/Debug.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/debug-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/raw_ostream.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/raw-ostream-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/BasicBlockUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/basicblockutils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/Cloning.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/cloning-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/LoopSimplify.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/loopsimplify-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/LoopUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/looputils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/ValueMapper.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/valuemapper-h"
  isLocal="true" />
<IncludesListItem
  filePath="algorithm"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="cassert"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="cstdint"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="optional"
  permalink=""
  isLocal="false" />
</IncludesList>

## Namespaces Index

<MembersIndex>

<MembersIndexItem
  type="namespace"
  name={<><a href="/docs/api/namespaces/anonymous-looppeel-cpp-">anonymous&#123;LoopPeel.cpp&#125;</a></>}>
</MembersIndexItem>

</MembersIndex>

## Classes Index

<MembersIndex>

<MembersIndexItem
  type="class"
  name={<><a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer">PhiAnalyzer</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type="struct"
  name={<><a href="/docs/api/structs/weightinfo">WeightInfo</a></>}>
</MembersIndexItem>

</MembersIndex>

## Functions Index

<MembersIndex>

<MembersIndexItem
  type="void"
  name={<><a href="#a8478b291f8a10892334ba0bcf6a18528">cloneLoopBlocks</a> (Loop &#42;L, unsigned IterNumber, BasicBlock &#42;InsertTop, BasicBlock &#42;InsertBot, SmallVectorImpl&lt; std::pair&lt; BasicBlock &#42;, BasicBlock &#42; &gt; &gt; &amp;ExitEdges, SmallVectorImpl&lt; BasicBlock &#42; &gt; &amp;NewBlocks, LoopBlocksDFS &amp;LoopBlocks, ValueToValueMapTy &amp;VMap, ValueToValueMapTy &amp;LVMap, DominatorTree &#42;DT, LoopInfo &#42;LI, ArrayRef&lt; MDNode &#42; &gt; LoopLocalNoAliasDeclScopes, ScalarEvolution &amp;SE)</>}>
Clones the body of the loop L, putting it between <code>InsertTop</code> and <code>InsertBot</code>. <a href="#a8478b291f8a10892334ba0bcf6a18528">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="unsigned"
  name={<><a href="#a7098623cafc05376a44b27d202b03372">countToEliminateCompares</a> (Loop &amp;L, unsigned MaxPeelCount, ScalarEvolution &amp;SE)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#acd8a7753c2685a14185133433c0bbf26">initBranchWeights</a> (DenseMap&lt; Instruction &#42;, WeightInfo &gt; &amp;WeightInfos, Loop &#42;L)</>}>
Initialize the weights for all exiting blocks. <a href="#acd8a7753c2685a14185133433c0bbf26">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="unsigned"
  name={<><a href="#aaa1d9cfaf2d4ef4eca30ce71eb8c3a89">peelToTurnInvariantLoadsDerefencebale</a> (Loop &amp;L, DominatorTree &amp;DT, AssumptionCache &#42;AC)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#ad7e9e8d290525be96b07046de14b8540">STATISTIC</a> (NumPeeled, &quot;Number of loops peeled&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a070d953c06601ec34680fdc35c867b17">updateBranchWeights</a> (Instruction &#42;Term, WeightInfo &amp;Info)</>}>
Update the branch weights of an exiting block of a peeled-off loop iteration. <a href="#a070d953c06601ec34680fdc35c867b17">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a7d391dbabb8fc073db875548184a768d">violatesLegacyMultiExitLoopCheck</a> (Loop &#42;L)</>}>
This &quot;heuristic&quot; exactly matches implicit behavior which used to exist inside getLoopEstimatedTripCount. <a href="#a7d391dbabb8fc073db875548184a768d">More...</a>
</MembersIndexItem>

</MembersIndex>

## Variables Index

<MembersIndex>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a354acc6ff0fdfde87ae2eb07c6127620">DisableAdvancedPeeling</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> char &#42;</>}
  name={<><a href="#a7f5685c46cf812c90576046af45cd7fa">PeeledCountMetaData</a> = &quot;llvm.loop.peeled.count&quot;</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#aa4d9cb6aeac6c6254d62eeb6c4b662ee">UnrollAllowLoopNestsPeeling</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a626a61b9d8aa04db77aaff8e96059f93">UnrollAllowPeeling</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#a6383b9c934edc393f9e9f3fd992559aa">UnrollForcePeelCount</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#aa9badf8f59af8beee7f66a5252019f70">UnrollPeelCount</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#a36a7dd364657e3ef9947efb9224aaca4">UnrollPeelMaxCount</a></>}>
</MembersIndexItem>

</MembersIndex>

## Defines Index

<MembersIndex>

<MembersIndexItem
  type="#define"
  name={<><a href="#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>&nbsp;&nbsp;&nbsp;&quot;loop-peel&quot;</>}>
</MembersIndexItem>

</MembersIndex>


<SectionDefinition>

## Functions

### cloneLoopBlocks() {#a8478b291f8a10892334ba0bcf6a18528}

<MemberDefinition
  prototype={<>static void cloneLoopBlocks (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42; L, unsigned IterNumber, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; InsertTop, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; InsertBot, <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt; std::pair&lt; <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; &gt; &gt; &amp; ExitEdges, <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt; <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; &gt; &amp; NewBlocks, <a href="/docs/api/classes/llvm/loopblocksdfs">LoopBlocksDFS</a> &amp; LoopBlocks, <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp; VMap, <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp; LVMap, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &#42; DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &#42; LI, <a href="/docs/api/classes/llvm/arrayref">ArrayRef</a>&lt; <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42; &gt; LoopLocalNoAliasDeclScopes, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &amp; SE)</>}
  labels = {["static"]}>
Clones the body of the loop L, putting it between <code>InsertTop</code> and <code>InsertBot</code>.

<ParametersList title="Parameters">
<ParametersListItem name="IterNumber">The serial number of the iteration currently being peeled off.</ParametersListItem>
<ParametersListItem name="ExitEdges">The exit edges of the original loop.</ParametersListItem>
<ParametersListItem name="[out] NewBlocks">A list of the blocks in the newly created clone</ParametersListItem>
<ParametersListItem name="[out] VMap">The value map between the loop and the new clone.</ParametersListItem>
<ParametersListItem name="LoopBlocks">A helper for DFS-traversal of the loop.</ParametersListItem>
<ParametersListItem name="LVMap">A value-map that maps instructions from the original loop to instructions in the last peeled-off iteration.</ParametersListItem>
</ParametersList>

Definition at line <a href="#l00748">748</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### countToEliminateCompares() {#a7098623cafc05376a44b27d202b03372}

<MemberDefinition
  prototype={<>static unsigned countToEliminateCompares (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, unsigned MaxPeelCount, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &amp; SE)</>}
  labels = {["static"]}>

Definition at line <a href="#l00341">341</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### initBranchWeights() {#acd8a7753c2685a14185133433c0bbf26}

<MemberDefinition
  prototype={<>static void initBranchWeights (<a href="/docs/api/classes/llvm/densemap">DenseMap</a>&lt; <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;, <a href="/docs/api/structs/weightinfo">WeightInfo</a> &gt; &amp; WeightInfos, <a href="/docs/api/classes/llvm/loop">Loop</a> &#42; L)</>}
  labels = {["static"]}>
Initialize the weights for all exiting blocks.

Definition at line <a href="#l00695">695</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### peelToTurnInvariantLoadsDerefencebale() {#aaa1d9cfaf2d4ef4eca30ce71eb8c3a89}

<MemberDefinition
  prototype={<>static unsigned peelToTurnInvariantLoadsDerefencebale (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &#42; AC)</>}
  labels = {["static"]}>

Definition at line <a href="#l00274">274</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### STATISTIC() {#ad7e9e8d290525be96b07046de14b8540}

<MemberDefinition
  prototype={<>STATISTIC (NumPeeled, &quot;Number of <a href="/docs/api/files/lib/lib/analysis/loopinfo-cpp/#a49ae40a9c91d665793aaed656c26ca30">loops</a> peeled&quot;)</>}>

Definition at line <a href="#l00051">51</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### updateBranchWeights() {#a070d953c06601ec34680fdc35c867b17}

<MemberDefinition
  prototype={<>static void updateBranchWeights (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42; Term, <a href="/docs/api/structs/weightinfo">WeightInfo</a> &amp; Info)</>}
  labels = {["static"]}>
Update the branch weights of an exiting block of a peeled-off loop iteration.

Let F is a weight of the edge to continue (fallthrough) into the loop. Let E is a weight of the edge to an exit. F/(F+E) is a probability to go to loop and E/(F+E) is a probability to go to exit. Then, Estimated ExitCount = F / E. For I-th (counting from 0) peeled off iteration we set the weights for the peeled exit as (EC - I, 1). It gives us reasonable distribution, The probability to go to exit 1/(EC-I) increases. At the same time the estimated exit count in the remainder loop reduces by I. To avoid dealing with division rounding we can just multiple both part of weights to E and use weight as (F - I &#42; E, E).

Definition at line <a href="#l00680">680</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### violatesLegacyMultiExitLoopCheck() {#a7d391dbabb8fc073db875548184a768d}

<MemberDefinition
  prototype={<>static bool violatesLegacyMultiExitLoopCheck (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42; L)</>}
  labels = {["static"]}>
This &quot;heuristic&quot; exactly matches implicit behavior which used to exist inside getLoopEstimatedTripCount.

It was added here to keep an improvement inside that API from causing peeling to become more aggressive. This should probably be removed.

Definition at line <a href="#l00514">514</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Variables

### DisableAdvancedPeeling {#a354acc6ff0fdfde87ae2eb07c6127620}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; DisableAdvancedPeeling(&quot;disable-advanced-peeling&quot;, cl::init(false), cl::Hidden, cl::desc( &quot;Disable advance peeling. Issues for convergent targets (D134803).&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00075">75</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### PeeledCountMetaData {#a7f5685c46cf812c90576046af45cd7fa}

<MemberDefinition
  prototype={<>const char&#42; PeeledCountMetaData = &quot;llvm.loop.peeled.count&quot;</>}
  labels = {["static"]}>

Definition at line <a href="#l00080">80</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### UnrollAllowLoopNestsPeeling {#aa4d9cb6aeac6c6254d62eeb6c4b662ee}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; UnrollAllowLoopNestsPeeling(&quot;unroll-allow-loop-nests-peeling&quot;, cl::init(false), cl::Hidden, cl::desc(&quot;Allows loop nests to be peeled.&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00063">63</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### UnrollAllowPeeling {#a626a61b9d8aa04db77aaff8e96059f93}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; UnrollAllowPeeling(&quot;unroll-allow-peeling&quot;, cl::init(true), cl::Hidden, cl::desc(&quot;Allows loops to be peeled when the dynamic &quot; &quot;trip count is known to be low.&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00058">58</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### UnrollForcePeelCount {#a6383b9c934edc393f9e9f3fd992559aa}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; UnrollForcePeelCount(&quot;unroll-force-peel-count&quot;, cl::init(0), cl::Hidden, cl::desc(&quot;Force a peel count regardless of profiling information.&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00071">71</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### UnrollPeelCount {#aa9badf8f59af8beee7f66a5252019f70}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; UnrollPeelCount(&quot;unroll-peel-count&quot;, cl::Hidden, cl::desc(&quot;Set the unroll peeling count, for testing purposes&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00053">53</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### UnrollPeelMaxCount {#a36a7dd364657e3ef9947efb9224aaca4}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; UnrollPeelMaxCount(&quot;unroll-peel-max-count&quot;, cl::init(7), cl::Hidden, cl::desc(&quot;Max average trip count which will cause loop peeling.&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00067">67</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Defines

### DEBUG&#95;TYPE {#ad78e062f62e0d6e453941fb4ca843e4d}

<MemberDefinition
  prototype={<>#define DEBUG&#95;TYPE&nbsp;&nbsp;&nbsp;&quot;loop-peel&quot;</>}>

Definition at line <a href="#l00049">49</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

</SectionDefinition>

## File Listing

The file content with the documentation metadata removed is:

<ProgramListing>

<Link id="l00001" /><CodeLine lineNumber="1"><span class="doxyHighlightComment">//===- LoopPeel.cpp -------------------------------------------------------===//</span></CodeLine>
<Link id="l00002" /><CodeLine lineNumber="2"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00003" /><CodeLine lineNumber="3"><span class="doxyHighlightComment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</span></CodeLine>
<Link id="l00004" /><CodeLine lineNumber="4"><span class="doxyHighlightComment">// See https://llvm.org/LICENSE.txt for license information.</span></CodeLine>
<Link id="l00005" /><CodeLine lineNumber="5"><span class="doxyHighlightComment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</span></CodeLine>
<Link id="l00006" /><CodeLine lineNumber="6"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00007" /><CodeLine lineNumber="7"><span class="doxyHighlightComment">//===----------------------------------------------------------------------===//</span></CodeLine>
<Link id="l00008" /><CodeLine lineNumber="8"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00009" /><CodeLine lineNumber="9"><span class="doxyHighlightComment">// Loop Peeling Utilities.</span></CodeLine>
<Link id="l00010" /><CodeLine lineNumber="10"><span class="doxyHighlightComment">//===----------------------------------------------------------------------===//</span></CodeLine>
<Link id="l00011" /><CodeLine lineNumber="11"></CodeLine>
<Link id="l00012" /><CodeLine lineNumber="12"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/looppeel-h">llvm/Transforms/Utils/LoopPeel.h</a>&quot;</span></CodeLine>
<Link id="l00013" /><CodeLine lineNumber="13"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/densemap-h">llvm/ADT/DenseMap.h</a>&quot;</span></CodeLine>
<Link id="l00014" /><CodeLine lineNumber="14"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/smallvector-h">llvm/ADT/SmallVector.h</a>&quot;</span></CodeLine>
<Link id="l00015" /><CodeLine lineNumber="15"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h">llvm/ADT/Statistic.h</a>&quot;</span></CodeLine>
<Link id="l00016" /><CodeLine lineNumber="16"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/loads-h">llvm/Analysis/Loads.h</a>&quot;</span></CodeLine>
<Link id="l00017" /><CodeLine lineNumber="17"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/loopinfo-h">llvm/Analysis/LoopInfo.h</a>&quot;</span></CodeLine>
<Link id="l00018" /><CodeLine lineNumber="18"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/loopiterator-h">llvm/Analysis/LoopIterator.h</a>&quot;</span></CodeLine>
<Link id="l00019" /><CodeLine lineNumber="19"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/scalarevolution-h">llvm/Analysis/ScalarEvolution.h</a>&quot;</span></CodeLine>
<Link id="l00020" /><CodeLine lineNumber="20"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/scalarevolutionexpressions-h">llvm/Analysis/ScalarEvolutionExpressions.h</a>&quot;</span></CodeLine>
<Link id="l00021" /><CodeLine lineNumber="21"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/targettransforminfo-h">llvm/Analysis/TargetTransformInfo.h</a>&quot;</span></CodeLine>
<Link id="l00022" /><CodeLine lineNumber="22"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/basicblock-h">llvm/IR/BasicBlock.h</a>&quot;</span></CodeLine>
<Link id="l00023" /><CodeLine lineNumber="23"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/dominators-h">llvm/IR/Dominators.h</a>&quot;</span></CodeLine>
<Link id="l00024" /><CodeLine lineNumber="24"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/function-h">llvm/IR/Function.h</a>&quot;</span></CodeLine>
<Link id="l00025" /><CodeLine lineNumber="25"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/instrtypes-h">llvm/IR/InstrTypes.h</a>&quot;</span></CodeLine>
<Link id="l00026" /><CodeLine lineNumber="26"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/instruction-h">llvm/IR/Instruction.h</a>&quot;</span></CodeLine>
<Link id="l00027" /><CodeLine lineNumber="27"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/instructions-h">llvm/IR/Instructions.h</a>&quot;</span></CodeLine>
<Link id="l00028" /><CodeLine lineNumber="28"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/llvmcontext-h">llvm/IR/LLVMContext.h</a>&quot;</span></CodeLine>
<Link id="l00029" /><CodeLine lineNumber="29"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/mdbuilder-h">llvm/IR/MDBuilder.h</a>&quot;</span></CodeLine>
<Link id="l00030" /><CodeLine lineNumber="30"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/patternmatch-h">llvm/IR/PatternMatch.h</a>&quot;</span></CodeLine>
<Link id="l00031" /><CodeLine lineNumber="31"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/profdatautils-h">llvm/IR/ProfDataUtils.h</a>&quot;</span></CodeLine>
<Link id="l00032" /><CodeLine lineNumber="32"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/casting-h">llvm/Support/Casting.h</a>&quot;</span></CodeLine>
<Link id="l00033" /><CodeLine lineNumber="33"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h">llvm/Support/CommandLine.h</a>&quot;</span></CodeLine>
<Link id="l00034" /><CodeLine lineNumber="34"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h">llvm/Support/Debug.h</a>&quot;</span></CodeLine>
<Link id="l00035" /><CodeLine lineNumber="35"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/raw-ostream-h">llvm/Support/raw&#95;ostream.h</a>&quot;</span></CodeLine>
<Link id="l00036" /><CodeLine lineNumber="36"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/basicblockutils-h">llvm/Transforms/Utils/BasicBlockUtils.h</a>&quot;</span></CodeLine>
<Link id="l00037" /><CodeLine lineNumber="37"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/cloning-h">llvm/Transforms/Utils/Cloning.h</a>&quot;</span></CodeLine>
<Link id="l00038" /><CodeLine lineNumber="38"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/loopsimplify-h">llvm/Transforms/Utils/LoopSimplify.h</a>&quot;</span></CodeLine>
<Link id="l00039" /><CodeLine lineNumber="39"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/looputils-h">llvm/Transforms/Utils/LoopUtils.h</a>&quot;</span></CodeLine>
<Link id="l00040" /><CodeLine lineNumber="40"><span class="doxyHighlightPreprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/valuemapper-h">llvm/Transforms/Utils/ValueMapper.h</a>&quot;</span></CodeLine>
<Link id="l00041" /><CodeLine lineNumber="41"><span class="doxyHighlightPreprocessor">#include &lt;algorithm&gt;</span></CodeLine>
<Link id="l00042" /><CodeLine lineNumber="42"><span class="doxyHighlightPreprocessor">#include &lt;cassert&gt;</span></CodeLine>
<Link id="l00043" /><CodeLine lineNumber="43"><span class="doxyHighlightPreprocessor">#include &lt;cstdint&gt;</span></CodeLine>
<Link id="l00044" /><CodeLine lineNumber="44"><span class="doxyHighlightPreprocessor">#include &lt;optional&gt;</span></CodeLine>
<Link id="l00045" /><CodeLine lineNumber="45"></CodeLine>
<Link id="l00046" /><CodeLine lineNumber="46"><span class="doxyHighlightKeyword">using namespace </span><span class="doxyHighlight"><a href="/docs/api/namespaces/llvm">llvm</a>;</span></CodeLine>
<Link id="l00047" /><CodeLine lineNumber="47"><span class="doxyHighlightKeyword">using namespace </span><span class="doxyHighlight"><a href="/docs/api/namespaces/llvm/patternmatch">llvm::PatternMatch</a>;</span></CodeLine>
<Link id="l00048" /><CodeLine lineNumber="48"></CodeLine>
<Link id="l00049" /><CodeLine lineNumber="49" lineLink="#ad78e062f62e0d6e453941fb4ca843e4d"><span class="doxyHighlightPreprocessor">#define DEBUG&#95;TYPE &quot;loop-peel&quot;</span></CodeLine>
<Link id="l00050" /><CodeLine lineNumber="50"></CodeLine>
<Link id="l00051" /><CodeLine lineNumber="51" lineLink="#ad7e9e8d290525be96b07046de14b8540"><span class="doxyHighlight"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumPeeled, </span><span class="doxyHighlightStringLiteral">&quot;Number of loops peeled&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00052" /><CodeLine lineNumber="52"></CodeLine>
<Link id="l00053" /><CodeLine lineNumber="53" lineLink="#aa9badf8f59af8beee7f66a5252019f70"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="#aa9badf8f59af8beee7f66a5252019f70">UnrollPeelCount</a>(</span></CodeLine>
<Link id="l00054" /><CodeLine lineNumber="54"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;unroll-peel-count&quot;</span><span class="doxyHighlight">, <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</span></CodeLine>
<Link id="l00055" /><CodeLine lineNumber="55"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Set the unroll peeling count, for testing purposes&quot;</span><span class="doxyHighlight">));</span></CodeLine>
<Link id="l00056" /><CodeLine lineNumber="56"></CodeLine>
<Link id="l00057" /><CodeLine lineNumber="57"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a></span></CodeLine>
<Link id="l00058" /><CodeLine lineNumber="58" lineLink="#a626a61b9d8aa04db77aaff8e96059f93"><span class="doxyHighlight">    <a href="#a626a61b9d8aa04db77aaff8e96059f93">UnrollAllowPeeling</a>(</span><span class="doxyHighlightStringLiteral">&quot;unroll-allow-peeling&quot;</span><span class="doxyHighlight">, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</span></CodeLine>
<Link id="l00059" /><CodeLine lineNumber="59"><span class="doxyHighlight">                       <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Allows loops to be peeled when the dynamic &quot;</span></CodeLine>
<Link id="l00060" /><CodeLine lineNumber="60"><span class="doxyHighlight">                                </span><span class="doxyHighlightStringLiteral">&quot;trip count is known to be low.&quot;</span><span class="doxyHighlight">));</span></CodeLine>
<Link id="l00061" /><CodeLine lineNumber="61"></CodeLine>
<Link id="l00062" /><CodeLine lineNumber="62"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a></span></CodeLine>
<Link id="l00063" /><CodeLine lineNumber="63" lineLink="#aa4d9cb6aeac6c6254d62eeb6c4b662ee"><span class="doxyHighlight">    <a href="#aa4d9cb6aeac6c6254d62eeb6c4b662ee">UnrollAllowLoopNestsPeeling</a>(</span><span class="doxyHighlightStringLiteral">&quot;unroll-allow-loop-nests-peeling&quot;</span><span class="doxyHighlight">,</span></CodeLine>
<Link id="l00064" /><CodeLine lineNumber="64"><span class="doxyHighlight">                                <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</span></CodeLine>
<Link id="l00065" /><CodeLine lineNumber="65"><span class="doxyHighlight">                                <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Allows loop nests to be peeled.&quot;</span><span class="doxyHighlight">));</span></CodeLine>
<Link id="l00066" /><CodeLine lineNumber="66"></CodeLine>
<Link id="l00067" /><CodeLine lineNumber="67" lineLink="#a36a7dd364657e3ef9947efb9224aaca4"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="#a36a7dd364657e3ef9947efb9224aaca4">UnrollPeelMaxCount</a>(</span></CodeLine>
<Link id="l00068" /><CodeLine lineNumber="68"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;unroll-peel-max-count&quot;</span><span class="doxyHighlight">, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(7), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</span></CodeLine>
<Link id="l00069" /><CodeLine lineNumber="69"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Max average trip count which will cause loop peeling.&quot;</span><span class="doxyHighlight">));</span></CodeLine>
<Link id="l00070" /><CodeLine lineNumber="70"></CodeLine>
<Link id="l00071" /><CodeLine lineNumber="71" lineLink="#a6383b9c934edc393f9e9f3fd992559aa"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="#a6383b9c934edc393f9e9f3fd992559aa">UnrollForcePeelCount</a>(</span></CodeLine>
<Link id="l00072" /><CodeLine lineNumber="72"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;unroll-force-peel-count&quot;</span><span class="doxyHighlight">, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(0), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</span></CodeLine>
<Link id="l00073" /><CodeLine lineNumber="73"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span><span class="doxyHighlightStringLiteral">&quot;Force a peel count regardless of profiling information.&quot;</span><span class="doxyHighlight">));</span></CodeLine>
<Link id="l00074" /><CodeLine lineNumber="74"></CodeLine>
<Link id="l00075" /><CodeLine lineNumber="75" lineLink="#a354acc6ff0fdfde87ae2eb07c6127620"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a354acc6ff0fdfde87ae2eb07c6127620">DisableAdvancedPeeling</a>(</span></CodeLine>
<Link id="l00076" /><CodeLine lineNumber="76"><span class="doxyHighlight">    </span><span class="doxyHighlightStringLiteral">&quot;disable-advanced-peeling&quot;</span><span class="doxyHighlight">, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</span></CodeLine>
<Link id="l00077" /><CodeLine lineNumber="77"><span class="doxyHighlight">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</span></CodeLine>
<Link id="l00078" /><CodeLine lineNumber="78"><span class="doxyHighlight">        </span><span class="doxyHighlightStringLiteral">&quot;Disable advance peeling. Issues for convergent targets (D134803).&quot;</span><span class="doxyHighlight">));</span></CodeLine>
<Link id="l00079" /><CodeLine lineNumber="79"></CodeLine>
<Link id="l00080" /><CodeLine lineNumber="80" lineLink="#a7f5685c46cf812c90576046af45cd7fa"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">char</span><span class="doxyHighlight"> &#42;<a href="#a7f5685c46cf812c90576046af45cd7fa">PeeledCountMetaData</a> = </span><span class="doxyHighlightStringLiteral">&quot;llvm.loop.peeled.count&quot;</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00081" /><CodeLine lineNumber="81"></CodeLine>
<Link id="l00082" /><CodeLine lineNumber="82"><span class="doxyHighlightComment">// Check whether we are capable of peeling this loop.</span></CodeLine>
<Link id="l00083" /><CodeLine lineNumber="83" lineLink="/docs/api/namespaces/llvm/#a3aea1e78510aa7469457aade10808e51"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/#a3aea1e78510aa7469457aade10808e51">llvm::canPeel</a>(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L) &#123;</span></CodeLine>
<Link id="l00084" /><CodeLine lineNumber="84"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Make sure the loop is in simplified form</span></CodeLine>
<Link id="l00085" /><CodeLine lineNumber="85"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!L-&gt;isLoopSimplifyForm())</span></CodeLine>
<Link id="l00086" /><CodeLine lineNumber="86"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00087" /><CodeLine lineNumber="87"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="#a354acc6ff0fdfde87ae2eb07c6127620">DisableAdvancedPeeling</a>)</span></CodeLine>
<Link id="l00088" /><CodeLine lineNumber="88"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00089" /><CodeLine lineNumber="89"></CodeLine>
<Link id="l00090" /><CodeLine lineNumber="90"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 4&gt;</a> Exits;</span></CodeLine>
<Link id="l00091" /><CodeLine lineNumber="91"><span class="doxyHighlight">  L-&gt;getUniqueNonLatchExitBlocks(Exits);</span></CodeLine>
<Link id="l00092" /><CodeLine lineNumber="92"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The latch must either be the only exiting block or all non-latch exit</span></CodeLine>
<Link id="l00093" /><CodeLine lineNumber="93"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// blocks have either a deopt or unreachable terminator or compose a chain of</span></CodeLine>
<Link id="l00094" /><CodeLine lineNumber="94"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// blocks where the last one is either deopt or unreachable terminated. Both</span></CodeLine>
<Link id="l00095" /><CodeLine lineNumber="95"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// deopt and unreachable terminators are a strong indication they are not</span></CodeLine>
<Link id="l00096" /><CodeLine lineNumber="96"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// taken. Note that this is a profitability check, not a legality check. Also</span></CodeLine>
<Link id="l00097" /><CodeLine lineNumber="97"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// note that LoopPeeling currently can only update the branch weights of latch</span></CodeLine>
<Link id="l00098" /><CodeLine lineNumber="98"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// blocks and branch weights to blocks with deopt or unreachable do not need</span></CodeLine>
<Link id="l00099" /><CodeLine lineNumber="99"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// updating.</span></CodeLine>
<Link id="l00100" /><CodeLine lineNumber="100"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/#a0d10fe510ced2849a8074fe81e5d04ce">llvm::all&#95;of</a>(Exits, <a href="/docs/api/namespaces/llvm/#a15055c7e3a33b44c293df24e4ba7bc5e">IsBlockFollowedByDeoptOrUnreachable</a>);</span></CodeLine>
<Link id="l00101" /><CodeLine lineNumber="101"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00102" /><CodeLine lineNumber="102"></CodeLine>
<Link id="l00103" /><CodeLine lineNumber="103" lineLink="/docs/api/namespaces/anonymous-looppeel-cpp-"><span class="doxyHighlightKeyword">namespace </span><span class="doxyHighlight">&#123;</span></CodeLine>
<Link id="l00104" /><CodeLine lineNumber="104"></CodeLine>
<Link id="l00105" /><CodeLine lineNumber="105"><span class="doxyHighlightComment">// As a loop is peeled, it may be the case that Phi nodes become</span></CodeLine>
<Link id="l00106" /><CodeLine lineNumber="106"><span class="doxyHighlightComment">// loop-invariant (ie, known because there is only one choice).</span></CodeLine>
<Link id="l00107" /><CodeLine lineNumber="107"><span class="doxyHighlightComment">// For example, consider the following function:</span></CodeLine>
<Link id="l00108" /><CodeLine lineNumber="108"><span class="doxyHighlightComment">//   void g(int);</span></CodeLine>
<Link id="l00109" /><CodeLine lineNumber="109"><span class="doxyHighlightComment">//   void binary() &#123;</span></CodeLine>
<Link id="l00110" /><CodeLine lineNumber="110"><span class="doxyHighlightComment">//     int x = 0;</span></CodeLine>
<Link id="l00111" /><CodeLine lineNumber="111"><span class="doxyHighlightComment">//     int y = 0;</span></CodeLine>
<Link id="l00112" /><CodeLine lineNumber="112"><span class="doxyHighlightComment">//     int a = 0;</span></CodeLine>
<Link id="l00113" /><CodeLine lineNumber="113"><span class="doxyHighlightComment">//     for(int i = 0; i &lt;100000; ++i) &#123;</span></CodeLine>
<Link id="l00114" /><CodeLine lineNumber="114"><span class="doxyHighlightComment">//       g(x);</span></CodeLine>
<Link id="l00115" /><CodeLine lineNumber="115"><span class="doxyHighlightComment">//       x = y;</span></CodeLine>
<Link id="l00116" /><CodeLine lineNumber="116"><span class="doxyHighlightComment">//       g(a);</span></CodeLine>
<Link id="l00117" /><CodeLine lineNumber="117"><span class="doxyHighlightComment">//       y = a + 1;</span></CodeLine>
<Link id="l00118" /><CodeLine lineNumber="118"><span class="doxyHighlightComment">//       a = 5;</span></CodeLine>
<Link id="l00119" /><CodeLine lineNumber="119"><span class="doxyHighlightComment">//     &#125;</span></CodeLine>
<Link id="l00120" /><CodeLine lineNumber="120"><span class="doxyHighlightComment">//   &#125;</span></CodeLine>
<Link id="l00121" /><CodeLine lineNumber="121"><span class="doxyHighlightComment">// Peeling 3 iterations is beneficial because the values for x, y and a</span></CodeLine>
<Link id="l00122" /><CodeLine lineNumber="122"><span class="doxyHighlightComment">// become known.  The IR for this loop looks something like the following:</span></CodeLine>
<Link id="l00123" /><CodeLine lineNumber="123"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00124" /><CodeLine lineNumber="124"><span class="doxyHighlightComment">//   %i = phi i32 &#91; 0, %entry &#93;, &#91; %inc, %if.end &#93;</span></CodeLine>
<Link id="l00125" /><CodeLine lineNumber="125"><span class="doxyHighlightComment">//   %a = phi i32 &#91; 0, %entry &#93;, &#91; 5, %if.end &#93;</span></CodeLine>
<Link id="l00126" /><CodeLine lineNumber="126"><span class="doxyHighlightComment">//   %y = phi i32 &#91; 0, %entry &#93;, &#91; %add, %if.end &#93;</span></CodeLine>
<Link id="l00127" /><CodeLine lineNumber="127"><span class="doxyHighlightComment">//   %x = phi i32 &#91; 0, %entry &#93;, &#91; %y, %if.end &#93;</span></CodeLine>
<Link id="l00128" /><CodeLine lineNumber="128"><span class="doxyHighlightComment">//   ...</span></CodeLine>
<Link id="l00129" /><CodeLine lineNumber="129"><span class="doxyHighlightComment">//   tail call void @&#95;Z1gi(i32 signext %x)</span></CodeLine>
<Link id="l00130" /><CodeLine lineNumber="130"><span class="doxyHighlightComment">//   tail call void @&#95;Z1gi(i32 signext %a)</span></CodeLine>
<Link id="l00131" /><CodeLine lineNumber="131"><span class="doxyHighlightComment">//   %add = add nuw nsw i32 %a, 1</span></CodeLine>
<Link id="l00132" /><CodeLine lineNumber="132"><span class="doxyHighlightComment">//   %inc = add nuw nsw i32 %i, 1</span></CodeLine>
<Link id="l00133" /><CodeLine lineNumber="133"><span class="doxyHighlightComment">//   %exitcond = icmp eq i32 %inc, 100000</span></CodeLine>
<Link id="l00134" /><CodeLine lineNumber="134"><span class="doxyHighlightComment">//   br i1 %exitcond, label %for.cond.cleanup, label %for.body</span></CodeLine>
<Link id="l00135" /><CodeLine lineNumber="135"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00136" /><CodeLine lineNumber="136"><span class="doxyHighlightComment">// The arguments for the calls to g will become known after 3 iterations</span></CodeLine>
<Link id="l00137" /><CodeLine lineNumber="137"><span class="doxyHighlightComment">// of the loop, because the phi nodes values become known after 3 iterations</span></CodeLine>
<Link id="l00138" /><CodeLine lineNumber="138"><span class="doxyHighlightComment">// of the loop (ie, they are known on the 4th iteration, so peel 3 iterations).</span></CodeLine>
<Link id="l00139" /><CodeLine lineNumber="139"><span class="doxyHighlightComment">// The first iteration has g(0), g(0); the second has g(0), g(5); the</span></CodeLine>
<Link id="l00140" /><CodeLine lineNumber="140"><span class="doxyHighlightComment">// third has g(1), g(5) and the fourth (and all subsequent) have g(6), g(5).</span></CodeLine>
<Link id="l00141" /><CodeLine lineNumber="141"><span class="doxyHighlightComment">// Now consider the phi nodes:</span></CodeLine>
<Link id="l00142" /><CodeLine lineNumber="142"><span class="doxyHighlightComment">//   %a is a phi with constants so it is determined after iteration 1</span></CodeLine>
<Link id="l00143" /><CodeLine lineNumber="143"><span class="doxyHighlightComment">//   %y is a phi based on a constant and %a so it is determined on</span></CodeLine>
<Link id="l00144" /><CodeLine lineNumber="144"><span class="doxyHighlightComment">//     the iteration after %a is determined, so iteration 2</span></CodeLine>
<Link id="l00145" /><CodeLine lineNumber="145"><span class="doxyHighlightComment">//   %x is a phi based on a constant and %y so it is determined on</span></CodeLine>
<Link id="l00146" /><CodeLine lineNumber="146"><span class="doxyHighlightComment">//     the iteration after %y, so iteration 3</span></CodeLine>
<Link id="l00147" /><CodeLine lineNumber="147"><span class="doxyHighlightComment">//   %i is based on itself (and is an induction variable) so it is</span></CodeLine>
<Link id="l00148" /><CodeLine lineNumber="148"><span class="doxyHighlightComment">//     never determined.</span></CodeLine>
<Link id="l00149" /><CodeLine lineNumber="149"><span class="doxyHighlightComment">// This means that peeling off 3 iterations will result in being able to</span></CodeLine>
<Link id="l00150" /><CodeLine lineNumber="150"><span class="doxyHighlightComment">// remove the phi nodes for %a, %y, and %x.  The arguments for the</span></CodeLine>
<Link id="l00151" /><CodeLine lineNumber="151"><span class="doxyHighlightComment">// corresponding calls to g are determined and the code for computing</span></CodeLine>
<Link id="l00152" /><CodeLine lineNumber="152"><span class="doxyHighlightComment">// x, y, and a can be removed.</span></CodeLine>
<Link id="l00153" /><CodeLine lineNumber="153"><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00154" /><CodeLine lineNumber="154"><span class="doxyHighlightComment">// The PhiAnalyzer class calculates how many times a loop should be</span></CodeLine>
<Link id="l00155" /><CodeLine lineNumber="155"><span class="doxyHighlightComment">// peeled based on the above analysis of the phi nodes in the loop while</span></CodeLine>
<Link id="l00156" /><CodeLine lineNumber="156"><span class="doxyHighlightComment">// respecting the maximum specified.</span></CodeLine>
<Link id="l00157" /><CodeLine lineNumber="157" lineLink="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer"><span class="doxyHighlightKeyword">class </span><span class="doxyHighlight"><a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a4e785de5fff2e6dd2024f24318e870ac">PhiAnalyzer</a> &#123;</span></CodeLine>
<Link id="l00158" /><CodeLine lineNumber="158"><span class="doxyHighlightKeyword">public</span><span class="doxyHighlight">:</span></CodeLine>
<Link id="l00159" /><CodeLine lineNumber="159"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a4e785de5fff2e6dd2024f24318e870ac">PhiAnalyzer</a>(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c">L</a>, </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0">MaxIterations</a>);</span></CodeLine>
<Link id="l00160" /><CodeLine lineNumber="160"></CodeLine>
<Link id="l00161" /><CodeLine lineNumber="161"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Calculate the sufficient minimum number of iterations of the loop to peel</span></CodeLine>
<Link id="l00162" /><CodeLine lineNumber="162"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// such that phi instructions become determined (subject to allowable limits)</span></CodeLine>
<Link id="l00163" /><CodeLine lineNumber="163"><span class="doxyHighlight">  std::optional&lt;unsigned&gt; <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#ab8be64c7a0b759236a80e76938e501f0">calculateIterationsToPeel</a>();</span></CodeLine>
<Link id="l00164" /><CodeLine lineNumber="164"></CodeLine>
<Link id="l00165" /><CodeLine lineNumber="165"><span class="doxyHighlightKeyword">protected</span><span class="doxyHighlight">:</span></CodeLine>
<Link id="l00166" /><CodeLine lineNumber="166" lineLink="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">using </span><span class="doxyHighlight"><a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0">PeelCounter</a> = std::optional&lt;unsigned&gt;;</span></CodeLine>
<Link id="l00167" /><CodeLine lineNumber="167" lineLink="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0">PeelCounter</a> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a> = std::nullopt;</span></CodeLine>
<Link id="l00168" /><CodeLine lineNumber="168"></CodeLine>
<Link id="l00169" /><CodeLine lineNumber="169"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Add 1 respecting Unknown and return Unknown if result over MaxIterations</span></CodeLine>
<Link id="l00170" /><CodeLine lineNumber="170" lineLink="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1270c5fbdef252d0b97676feeb269587"><span class="doxyHighlight">  <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0">PeelCounter</a> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1270c5fbdef252d0b97676feeb269587">addOne</a>(<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0">PeelCounter</a> PC)</span><span class="doxyHighlightKeyword"> const </span><span class="doxyHighlight">&#123;</span></CodeLine>
<Link id="l00171" /><CodeLine lineNumber="171"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (PC == <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>)</span></CodeLine>
<Link id="l00172" /><CodeLine lineNumber="172"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>;</span></CodeLine>
<Link id="l00173" /><CodeLine lineNumber="173"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> (&#42;PC + 1 &lt;= <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0">MaxIterations</a>) ? <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0">PeelCounter</a>&#123;&#42;PC + 1&#125; : <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>;</span></CodeLine>
<Link id="l00174" /><CodeLine lineNumber="174"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00175" /><CodeLine lineNumber="175"></CodeLine>
<Link id="l00176" /><CodeLine lineNumber="176"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Calculate the number of iterations after which the given value</span></CodeLine>
<Link id="l00177" /><CodeLine lineNumber="177"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// becomes an invariant.</span></CodeLine>
<Link id="l00178" /><CodeLine lineNumber="178"><span class="doxyHighlight">  PeelCounter calculate(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/value">Value</a> &amp;);</span></CodeLine>
<Link id="l00179" /><CodeLine lineNumber="179"></CodeLine>
<Link id="l00180" /><CodeLine lineNumber="180" lineLink="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c">L</a>;</span></CodeLine>
<Link id="l00181" /><CodeLine lineNumber="181" lineLink="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0">MaxIterations</a>;</span></CodeLine>
<Link id="l00182" /><CodeLine lineNumber="182"></CodeLine>
<Link id="l00183" /><CodeLine lineNumber="183"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Map of Values to number of iterations to invariance</span></CodeLine>
<Link id="l00184" /><CodeLine lineNumber="184" lineLink="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1739f186de9b30a666c0340e0eb955af"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;const Value &#42;, PeelCounter&gt;</a> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1739f186de9b30a666c0340e0eb955af">IterationsToInvariance</a>;</span></CodeLine>
<Link id="l00185" /><CodeLine lineNumber="185"><span class="doxyHighlight">&#125;;</span></CodeLine>
<Link id="l00186" /><CodeLine lineNumber="186"></CodeLine>
<Link id="l00187" /><CodeLine lineNumber="187" lineLink="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a4e785de5fff2e6dd2024f24318e870ac"><span class="doxyHighlight"><a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a4e785de5fff2e6dd2024f24318e870ac">PhiAnalyzer::PhiAnalyzer</a>(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c">L</a>, </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0">MaxIterations</a>)</span></CodeLine>
<Link id="l00188" /><CodeLine lineNumber="188"><span class="doxyHighlight">    : <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c">L</a>(<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c">L</a>), <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0">MaxIterations</a>(<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0">MaxIterations</a>) &#123;</span></CodeLine>
<Link id="l00189" /><CodeLine lineNumber="189"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/#a3aea1e78510aa7469457aade10808e51">canPeel</a>(&amp;<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c">L</a>) &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;loop is not suitable for peeling&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00190" /><CodeLine lineNumber="190"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0">MaxIterations</a> &gt; 0 &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;no peeling is allowed?&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00191" /><CodeLine lineNumber="191"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00192" /><CodeLine lineNumber="192"></CodeLine>
<Link id="l00193" /><CodeLine lineNumber="193"><span class="doxyHighlightComment">// This function calculates the number of iterations after which the value</span></CodeLine>
<Link id="l00194" /><CodeLine lineNumber="194"><span class="doxyHighlightComment">// becomes an invariant. The pre-calculated values are memorized in a map.</span></CodeLine>
<Link id="l00195" /><CodeLine lineNumber="195"><span class="doxyHighlightComment">// N.B. This number will be Unknown or &lt;= MaxIterations.</span></CodeLine>
<Link id="l00196" /><CodeLine lineNumber="196"><span class="doxyHighlightComment">// The function is calculated according to the following definition:</span></CodeLine>
<Link id="l00197" /><CodeLine lineNumber="197"><span class="doxyHighlightComment">// Given %x = phi &lt;Inputs from above the loop&gt;, ..., &#91;%y, %back.edge&#93;.</span></CodeLine>
<Link id="l00198" /><CodeLine lineNumber="198"><span class="doxyHighlightComment">//   F(%x) = G(%y) + 1 (N.B. &#91;MaxIterations | Unknown&#93; + 1 =&gt; Unknown)</span></CodeLine>
<Link id="l00199" /><CodeLine lineNumber="199"><span class="doxyHighlightComment">//   G(%y) = 0 if %y is a loop invariant</span></CodeLine>
<Link id="l00200" /><CodeLine lineNumber="200"><span class="doxyHighlightComment">//   G(%y) = G(%BackEdgeValue) if %y is a phi in the header block</span></CodeLine>
<Link id="l00201" /><CodeLine lineNumber="201"><span class="doxyHighlightComment">//   G(%y) = TODO: if %y is an expression based on phis and loop invariants</span></CodeLine>
<Link id="l00202" /><CodeLine lineNumber="202"><span class="doxyHighlightComment">//           The example looks like:</span></CodeLine>
<Link id="l00203" /><CodeLine lineNumber="203"><span class="doxyHighlightComment">//           %x = phi(0, %a) &lt;-- becomes invariant starting from 3rd iteration.</span></CodeLine>
<Link id="l00204" /><CodeLine lineNumber="204"><span class="doxyHighlightComment">//           %y = phi(0, 5)</span></CodeLine>
<Link id="l00205" /><CodeLine lineNumber="205"><span class="doxyHighlightComment">//           %a = %y + 1</span></CodeLine>
<Link id="l00206" /><CodeLine lineNumber="206"><span class="doxyHighlightComment">//   G(%y) = Unknown otherwise (including phi not in header block)</span></CodeLine>
<Link id="l00207" /><CodeLine lineNumber="207" lineLink="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a9b3f8d5fb39a3e2eb0c8416e2f3e70a2"><span class="doxyHighlight"><a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0">PhiAnalyzer::PeelCounter</a> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a9b3f8d5fb39a3e2eb0c8416e2f3e70a2">PhiAnalyzer::calculate</a>(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/value">Value</a> &amp;V) &#123;</span></CodeLine>
<Link id="l00208" /><CodeLine lineNumber="208"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we already know the answer, take it from the map.</span></CodeLine>
<Link id="l00209" /><CodeLine lineNumber="209"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Otherwise, place Unknown to map to avoid infinite recursion. Such</span></CodeLine>
<Link id="l00210" /><CodeLine lineNumber="210"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// cycles can never stop on an invariant.</span></CodeLine>
<Link id="l00211" /><CodeLine lineNumber="211"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, Inserted&#93; = <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1739f186de9b30a666c0340e0eb955af">IterationsToInvariance</a>.try&#95;emplace(&amp;V, <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>);</span></CodeLine>
<Link id="l00212" /><CodeLine lineNumber="212"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Inserted)</span></CodeLine>
<Link id="l00213" /><CodeLine lineNumber="213"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;second;</span></CodeLine>
<Link id="l00214" /><CodeLine lineNumber="214"></CodeLine>
<Link id="l00215" /><CodeLine lineNumber="215"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c">L</a>.isLoopInvariant(&amp;V))</span></CodeLine>
<Link id="l00216" /><CodeLine lineNumber="216"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Loop invariant so known at start.</span></CodeLine>
<Link id="l00217" /><CodeLine lineNumber="217"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> (<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1739f186de9b30a666c0340e0eb955af">IterationsToInvariance</a>&#91;&amp;V&#93; = 0);</span></CodeLine>
<Link id="l00218" /><CodeLine lineNumber="218"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;Phi = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;PHINode&gt;</a>(&amp;V)) &#123;</span></CodeLine>
<Link id="l00219" /><CodeLine lineNumber="219"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Phi-&gt;getParent() != <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c">L</a>.getHeader()) &#123;</span></CodeLine>
<Link id="l00220" /><CodeLine lineNumber="220"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Phi is not in header block so Unknown.</span></CodeLine>
<Link id="l00221" /><CodeLine lineNumber="221"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1739f186de9b30a666c0340e0eb955af">IterationsToInvariance</a>&#91;&amp;V&#93; == <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a> &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;unexpected value saved&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00222" /><CodeLine lineNumber="222"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>;</span></CodeLine>
<Link id="l00223" /><CodeLine lineNumber="223"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00224" /><CodeLine lineNumber="224"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// We need to analyze the input from the back edge and add 1</span></CodeLine>
<Link id="l00225" /><CodeLine lineNumber="225"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/classes/input">Input</a> = Phi-&gt;getIncomingValueForBlock(<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c">L</a>.getLoopLatch());</span></CodeLine>
<Link id="l00226" /><CodeLine lineNumber="226"><span class="doxyHighlight">    <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0">PeelCounter</a> Iterations = <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a9b3f8d5fb39a3e2eb0c8416e2f3e70a2">calculate</a>(&#42;<a href="/docs/api/classes/input">Input</a>);</span></CodeLine>
<Link id="l00227" /><CodeLine lineNumber="227"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1739f186de9b30a666c0340e0eb955af">IterationsToInvariance</a>&#91;<a href="/docs/api/classes/input">Input</a>&#93; == Iterations &amp;&amp;</span></CodeLine>
<Link id="l00228" /><CodeLine lineNumber="228"><span class="doxyHighlight">           </span><span class="doxyHighlightStringLiteral">&quot;unexpected value saved&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00229" /><CodeLine lineNumber="229"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> (<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1739f186de9b30a666c0340e0eb955af">IterationsToInvariance</a>&#91;Phi&#93; = <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1270c5fbdef252d0b97676feeb269587">addOne</a>(Iterations));</span></CodeLine>
<Link id="l00230" /><CodeLine lineNumber="230"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00231" /><CodeLine lineNumber="231"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(&amp;V)) &#123;</span></CodeLine>
<Link id="l00232" /><CodeLine lineNumber="232"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;CmpInst&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) || <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;isBinaryOp()) &#123;</span></CodeLine>
<Link id="l00233" /><CodeLine lineNumber="233"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Binary instructions get the max of the operands.</span></CodeLine>
<Link id="l00234" /><CodeLine lineNumber="234"><span class="doxyHighlight">      <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0">PeelCounter</a> LHS = <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a9b3f8d5fb39a3e2eb0c8416e2f3e70a2">calculate</a>(&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOperand(0));</span></CodeLine>
<Link id="l00235" /><CodeLine lineNumber="235"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LHS == <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>)</span></CodeLine>
<Link id="l00236" /><CodeLine lineNumber="236"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>;</span></CodeLine>
<Link id="l00237" /><CodeLine lineNumber="237"><span class="doxyHighlight">      <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0">PeelCounter</a> RHS = <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a9b3f8d5fb39a3e2eb0c8416e2f3e70a2">calculate</a>(&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOperand(1));</span></CodeLine>
<Link id="l00238" /><CodeLine lineNumber="238"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (RHS == <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>)</span></CodeLine>
<Link id="l00239" /><CodeLine lineNumber="239"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>;</span></CodeLine>
<Link id="l00240" /><CodeLine lineNumber="240"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> (<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1739f186de9b30a666c0340e0eb955af">IterationsToInvariance</a>&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; = &#123;std::max(&#42;LHS, &#42;RHS)&#125;);</span></CodeLine>
<Link id="l00241" /><CodeLine lineNumber="241"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00242" /><CodeLine lineNumber="242"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;isCast())</span></CodeLine>
<Link id="l00243" /><CodeLine lineNumber="243"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Cast instructions get the value of the operand.</span></CodeLine>
<Link id="l00244" /><CodeLine lineNumber="244"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> (<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1739f186de9b30a666c0340e0eb955af">IterationsToInvariance</a>&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; = <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a9b3f8d5fb39a3e2eb0c8416e2f3e70a2">calculate</a>(&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOperand(0)));</span></CodeLine>
<Link id="l00245" /><CodeLine lineNumber="245"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00246" /><CodeLine lineNumber="246"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TODO: handle more expressions</span></CodeLine>
<Link id="l00247" /><CodeLine lineNumber="247"></CodeLine>
<Link id="l00248" /><CodeLine lineNumber="248"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Everything else is Unknown.</span></CodeLine>
<Link id="l00249" /><CodeLine lineNumber="249"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1739f186de9b30a666c0340e0eb955af">IterationsToInvariance</a>&#91;&amp;V&#93; == <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a> &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;unexpected value saved&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00250" /><CodeLine lineNumber="250"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>;</span></CodeLine>
<Link id="l00251" /><CodeLine lineNumber="251"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00252" /><CodeLine lineNumber="252"></CodeLine>
<Link id="l00253" /><CodeLine lineNumber="253" lineLink="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#ab8be64c7a0b759236a80e76938e501f0"><span class="doxyHighlight">std::optional&lt;unsigned&gt; <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#ab8be64c7a0b759236a80e76938e501f0">PhiAnalyzer::calculateIterationsToPeel</a>() &#123;</span></CodeLine>
<Link id="l00254" /><CodeLine lineNumber="254"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> Iterations = 0;</span></CodeLine>
<Link id="l00255" /><CodeLine lineNumber="255"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a> : <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c">L</a>.getHeader()-&gt;phis()) &#123;</span></CodeLine>
<Link id="l00256" /><CodeLine lineNumber="256"><span class="doxyHighlight">    <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0">PeelCounter</a> ToInvariance = <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a9b3f8d5fb39a3e2eb0c8416e2f3e70a2">calculate</a>(<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a>);</span></CodeLine>
<Link id="l00257" /><CodeLine lineNumber="257"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ToInvariance != <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>) &#123;</span></CodeLine>
<Link id="l00258" /><CodeLine lineNumber="258"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(&#42;ToInvariance &lt;= <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0">MaxIterations</a> &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;bad result in phi analysis&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00259" /><CodeLine lineNumber="259"><span class="doxyHighlight">      Iterations = std::max(Iterations, &#42;ToInvariance);</span></CodeLine>
<Link id="l00260" /><CodeLine lineNumber="260"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Iterations == <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0">MaxIterations</a>)</span></CodeLine>
<Link id="l00261" /><CodeLine lineNumber="261"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00262" /><CodeLine lineNumber="262"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00263" /><CodeLine lineNumber="263"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00264" /><CodeLine lineNumber="264"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((Iterations &lt;= <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0">MaxIterations</a>) &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;bad result in phi analysis&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00265" /><CodeLine lineNumber="265"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> Iterations ? std::optional&lt;unsigned&gt;(Iterations) : std::nullopt;</span></CodeLine>
<Link id="l00266" /><CodeLine lineNumber="266"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00267" /><CodeLine lineNumber="267"></CodeLine>
<Link id="l00268" /><CodeLine lineNumber="268"><span class="doxyHighlight">&#125; </span><span class="doxyHighlightComment">// unnamed namespace</span></CodeLine>
<Link id="l00269" /><CodeLine lineNumber="269"></CodeLine>
<Link id="l00270" /><CodeLine lineNumber="270"><span class="doxyHighlightComment">// Try to find any invariant memory reads that will become dereferenceable in</span></CodeLine>
<Link id="l00271" /><CodeLine lineNumber="271"><span class="doxyHighlightComment">// the remainder loop after peeling. The load must also be used (transitively)</span></CodeLine>
<Link id="l00272" /><CodeLine lineNumber="272"><span class="doxyHighlightComment">// by an exit condition. Returns the number of iterations to peel off (at the</span></CodeLine>
<Link id="l00273" /><CodeLine lineNumber="273"><span class="doxyHighlightComment">// moment either 0 or 1).</span></CodeLine>
<Link id="l00274" /><CodeLine lineNumber="274" lineLink="#aaa1d9cfaf2d4ef4eca30ce71eb8c3a89"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="#aaa1d9cfaf2d4ef4eca30ce71eb8c3a89">peelToTurnInvariantLoadsDerefencebale</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L,</span></CodeLine>
<Link id="l00275" /><CodeLine lineNumber="275"><span class="doxyHighlight">                                                      <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT,</span></CodeLine>
<Link id="l00276" /><CodeLine lineNumber="276"><span class="doxyHighlight">                                                      <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &#42;AC) &#123;</span></CodeLine>
<Link id="l00277" /><CodeLine lineNumber="277"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Skip loops with a single exiting block, because there should be no benefit</span></CodeLine>
<Link id="l00278" /><CodeLine lineNumber="278"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// for the heuristic below.</span></CodeLine>
<Link id="l00279" /><CodeLine lineNumber="279"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (L.getExitingBlock())</span></CodeLine>
<Link id="l00280" /><CodeLine lineNumber="280"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> 0;</span></CodeLine>
<Link id="l00281" /><CodeLine lineNumber="281"></CodeLine>
<Link id="l00282" /><CodeLine lineNumber="282"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// All non-latch exit blocks must have an UnreachableInst terminator.</span></CodeLine>
<Link id="l00283" /><CodeLine lineNumber="283"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Otherwise the heuristic below may not be profitable.</span></CodeLine>
<Link id="l00284" /><CodeLine lineNumber="284"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 4&gt;</a> Exits;</span></CodeLine>
<Link id="l00285" /><CodeLine lineNumber="285"><span class="doxyHighlight">  L.getUniqueNonLatchExitBlocks(Exits);</span></CodeLine>
<Link id="l00286" /><CodeLine lineNumber="286"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a61d13d6824ec46c31260a4fd0997eda0">any&#95;of</a>(Exits, &#91;&#93;(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB) &#123;</span></CodeLine>
<Link id="l00287" /><CodeLine lineNumber="287"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> !<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;UnreachableInst&gt;</a>(BB-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</span></CodeLine>
<Link id="l00288" /><CodeLine lineNumber="288"><span class="doxyHighlight">      &#125;))</span></CodeLine>
<Link id="l00289" /><CodeLine lineNumber="289"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> 0;</span></CodeLine>
<Link id="l00290" /><CodeLine lineNumber="290"></CodeLine>
<Link id="l00291" /><CodeLine lineNumber="291"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Now look for invariant loads that dominate the latch and are not known to</span></CodeLine>
<Link id="l00292" /><CodeLine lineNumber="292"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// be dereferenceable. If there are such loads and no writes, they will become</span></CodeLine>
<Link id="l00293" /><CodeLine lineNumber="293"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// dereferenceable in the loop if the first iteration is peeled off. Also</span></CodeLine>
<Link id="l00294" /><CodeLine lineNumber="294"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// collect the set of instructions controlled by such loads. Only peel if an</span></CodeLine>
<Link id="l00295" /><CodeLine lineNumber="295"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// exit condition uses (transitively) such a load.</span></CodeLine>
<Link id="l00296" /><CodeLine lineNumber="296"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Header = L.getHeader();</span></CodeLine>
<Link id="l00297" /><CodeLine lineNumber="297"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Latch = L.getLoopLatch();</span></CodeLine>
<Link id="l00298" /><CodeLine lineNumber="298"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;Value &#42;, 8&gt;</a> LoadUsers;</span></CodeLine>
<Link id="l00299" /><CodeLine lineNumber="299"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/datalayout">DataLayout</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a> = L.getHeader()-&gt;getDataLayout();</span></CodeLine>
<Link id="l00300" /><CodeLine lineNumber="300"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB : L.blocks()) &#123;</span></CodeLine>
<Link id="l00301" /><CodeLine lineNumber="301"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : &#42;BB) &#123;</span></CodeLine>
<Link id="l00302" /><CodeLine lineNumber="302"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.mayWriteToMemory())</span></CodeLine>
<Link id="l00303" /><CodeLine lineNumber="303"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> 0;</span></CodeLine>
<Link id="l00304" /><CodeLine lineNumber="304"></CodeLine>
<Link id="l00305" /><CodeLine lineNumber="305"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Iter = LoadUsers.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a153ea412ff7a0ba105111155d1e16128">find</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</span></CodeLine>
<Link id="l00306" /><CodeLine lineNumber="306"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Iter != LoadUsers.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a7004354fbee1c8cd74ed9001915e1db5">end</a>()) &#123;</span></CodeLine>
<Link id="l00307" /><CodeLine lineNumber="307"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/value">Value</a> &#42;U : <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.users())</span></CodeLine>
<Link id="l00308" /><CodeLine lineNumber="308"><span class="doxyHighlight">          LoadUsers.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(U);</span></CodeLine>
<Link id="l00309" /><CodeLine lineNumber="309"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00310" /><CodeLine lineNumber="310"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Do not look for reads in the header; they can already be hoisted</span></CodeLine>
<Link id="l00311" /><CodeLine lineNumber="311"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// without peeling.</span></CodeLine>
<Link id="l00312" /><CodeLine lineNumber="312"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (BB == Header)</span></CodeLine>
<Link id="l00313" /><CodeLine lineNumber="313"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00314" /><CodeLine lineNumber="314"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;LI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;LoadInst&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) &#123;</span></CodeLine>
<Link id="l00315" /><CodeLine lineNumber="315"><span class="doxyHighlight">        <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/analysis/targetlibraryinfo-cpp/#aca185e6d0e9f423dbb24440206454872a11dbf501abf829b3ab7049c2d3a8a053">Ptr</a> = LI-&gt;getPointerOperand();</span></CodeLine>
<Link id="l00316" /><CodeLine lineNumber="316"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (DT.<a href="/docs/api/classes/llvm/dominatortree/#a5c69311e8d44898dac36a155c3d8691d">dominates</a>(BB, Latch) &amp;&amp; L.isLoopInvariant(<a href="/docs/api/files/lib/lib/analysis/targetlibraryinfo-cpp/#aca185e6d0e9f423dbb24440206454872a11dbf501abf829b3ab7049c2d3a8a053">Ptr</a>) &amp;&amp;</span></CodeLine>
<Link id="l00317" /><CodeLine lineNumber="317"><span class="doxyHighlight">            !<a href="/docs/api/namespaces/llvm/#abf1028e2af158aae1e00d3288ca013bb">isDereferenceablePointer</a>(<a href="/docs/api/files/lib/lib/analysis/targetlibraryinfo-cpp/#aca185e6d0e9f423dbb24440206454872a11dbf501abf829b3ab7049c2d3a8a053">Ptr</a>, LI-&gt;getType(), <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>, LI, AC, &amp;DT))</span></CodeLine>
<Link id="l00318" /><CodeLine lineNumber="318"><span class="doxyHighlight">          </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/value">Value</a> &#42;U : <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.users())</span></CodeLine>
<Link id="l00319" /><CodeLine lineNumber="319"><span class="doxyHighlight">            LoadUsers.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(U);</span></CodeLine>
<Link id="l00320" /><CodeLine lineNumber="320"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00321" /><CodeLine lineNumber="321"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00322" /><CodeLine lineNumber="322"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00323" /><CodeLine lineNumber="323"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;&gt;</a> ExitingBlocks;</span></CodeLine>
<Link id="l00324" /><CodeLine lineNumber="324"><span class="doxyHighlight">  L.getExitingBlocks(ExitingBlocks);</span></CodeLine>
<Link id="l00325" /><CodeLine lineNumber="325"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a61d13d6824ec46c31260a4fd0997eda0">any&#95;of</a>(ExitingBlocks, &#91;&amp;LoadUsers&#93;(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Exiting) &#123;</span></CodeLine>
<Link id="l00326" /><CodeLine lineNumber="326"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> LoadUsers.<a href="/docs/api/classes/llvm/smallptrsetimpl/#af74676a3c7447be34bd2c1da76ec0c48">contains</a>(Exiting-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</span></CodeLine>
<Link id="l00327" /><CodeLine lineNumber="327"><span class="doxyHighlight">      &#125;))</span></CodeLine>
<Link id="l00328" /><CodeLine lineNumber="328"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> 1;</span></CodeLine>
<Link id="l00329" /><CodeLine lineNumber="329"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> 0;</span></CodeLine>
<Link id="l00330" /><CodeLine lineNumber="330"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00331" /><CodeLine lineNumber="331"></CodeLine>
<Link id="l00332" /><CodeLine lineNumber="332"><span class="doxyHighlightComment">// Return the number of iterations to peel off that make conditions in the</span></CodeLine>
<Link id="l00333" /><CodeLine lineNumber="333"><span class="doxyHighlightComment">// body true/false. For example, if we peel 2 iterations off the loop below,</span></CodeLine>
<Link id="l00334" /><CodeLine lineNumber="334"><span class="doxyHighlightComment">// the condition i &lt; 2 can be evaluated at compile time.</span></CodeLine>
<Link id="l00335" /><CodeLine lineNumber="335"><span class="doxyHighlightComment">//  for (i = 0; i &lt; n; i++)</span></CodeLine>
<Link id="l00336" /><CodeLine lineNumber="336"><span class="doxyHighlightComment">//    if (i &lt; 2)</span></CodeLine>
<Link id="l00337" /><CodeLine lineNumber="337"><span class="doxyHighlightComment">//      ..</span></CodeLine>
<Link id="l00338" /><CodeLine lineNumber="338"><span class="doxyHighlightComment">//    else</span></CodeLine>
<Link id="l00339" /><CodeLine lineNumber="339"><span class="doxyHighlightComment">//      ..</span></CodeLine>
<Link id="l00340" /><CodeLine lineNumber="340"><span class="doxyHighlightComment">//   &#125;</span></CodeLine>
<Link id="l00341" /><CodeLine lineNumber="341" lineLink="#a7098623cafc05376a44b27d202b03372"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="#a7098623cafc05376a44b27d202b03372">countToEliminateCompares</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> MaxPeelCount,</span></CodeLine>
<Link id="l00342" /><CodeLine lineNumber="342"><span class="doxyHighlight">                                         <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &amp;SE) &#123;</span></CodeLine>
<Link id="l00343" /><CodeLine lineNumber="343"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(L.isLoopSimplifyForm() &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Loop needs to be in loop simplify form&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00344" /><CodeLine lineNumber="344"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> DesiredPeelCount = 0;</span></CodeLine>
<Link id="l00345" /><CodeLine lineNumber="345"></CodeLine>
<Link id="l00346" /><CodeLine lineNumber="346"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Do not peel the entire loop.</span></CodeLine>
<Link id="l00347" /><CodeLine lineNumber="347"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;BE = SE.<a href="/docs/api/classes/llvm/scalarevolution/#a0182f006bb2ae6411c2111427d58f242">getConstantMaxBackedgeTakenCount</a>(&amp;L);</span></CodeLine>
<Link id="l00348" /><CodeLine lineNumber="348"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/scevconstant">SCEVConstant</a> &#42;SC = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;SCEVConstant&gt;</a>(BE))</span></CodeLine>
<Link id="l00349" /><CodeLine lineNumber="349"><span class="doxyHighlight">    MaxPeelCount =</span></CodeLine>
<Link id="l00350" /><CodeLine lineNumber="350"><span class="doxyHighlight">        std::min((</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight">)SC-&gt;getAPInt().getLimitedValue() - 1, MaxPeelCount);</span></CodeLine>
<Link id="l00351" /><CodeLine lineNumber="351"></CodeLine>
<Link id="l00352" /><CodeLine lineNumber="352"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Increase PeelCount while (IterVal Pred BoundSCEV) condition is satisfied;</span></CodeLine>
<Link id="l00353" /><CodeLine lineNumber="353"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// return true if inversed condition become known before reaching the</span></CodeLine>
<Link id="l00354" /><CodeLine lineNumber="354"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// MaxPeelCount limit.</span></CodeLine>
<Link id="l00355" /><CodeLine lineNumber="355"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> PeelWhilePredicateIsKnown =</span></CodeLine>
<Link id="l00356" /><CodeLine lineNumber="356"><span class="doxyHighlight">      &#91;&amp;&#93;(</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> &amp;PeelCount, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;&amp;IterVal, </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;BoundSCEV,</span></CodeLine>
<Link id="l00357" /><CodeLine lineNumber="357"><span class="doxyHighlight">          </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;Step, <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78b">ICmpInst::Predicate</a> Pred) &#123;</span></CodeLine>
<Link id="l00358" /><CodeLine lineNumber="358"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">while</span><span class="doxyHighlight"> (PeelCount &lt; MaxPeelCount &amp;&amp;</span></CodeLine>
<Link id="l00359" /><CodeLine lineNumber="359"><span class="doxyHighlight">               SE.<a href="/docs/api/classes/llvm/scalarevolution/#af74112dae88db73eb5484821b6f0fccd">isKnownPredicate</a>(Pred, IterVal, BoundSCEV)) &#123;</span></CodeLine>
<Link id="l00360" /><CodeLine lineNumber="360"><span class="doxyHighlight">          IterVal = SE.<a href="/docs/api/classes/llvm/scalarevolution/#aef6d2bea715d1793e956f41ddeea2320">getAddExpr</a>(IterVal, Step);</span></CodeLine>
<Link id="l00361" /><CodeLine lineNumber="361"><span class="doxyHighlight">          ++PeelCount;</span></CodeLine>
<Link id="l00362" /><CodeLine lineNumber="362"><span class="doxyHighlight">        &#125;</span></CodeLine>
<Link id="l00363" /><CodeLine lineNumber="363"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> SE.<a href="/docs/api/classes/llvm/scalarevolution/#af74112dae88db73eb5484821b6f0fccd">isKnownPredicate</a>(<a href="/docs/api/classes/llvm/cmpinst/#aa2a54b545d237ecfe450fd1292f7675e">ICmpInst::getInversePredicate</a>(Pred), IterVal,</span></CodeLine>
<Link id="l00364" /><CodeLine lineNumber="364"><span class="doxyHighlight">                                   BoundSCEV);</span></CodeLine>
<Link id="l00365" /><CodeLine lineNumber="365"><span class="doxyHighlight">      &#125;;</span></CodeLine>
<Link id="l00366" /><CodeLine lineNumber="366"></CodeLine>
<Link id="l00367" /><CodeLine lineNumber="367"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> MaxDepth = 4;</span></CodeLine>
<Link id="l00368" /><CodeLine lineNumber="368"><span class="doxyHighlight">  std::function&lt;void(<a href="/docs/api/classes/llvm/value">Value</a> &#42;, </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight">)&gt; ComputePeelCount =</span></CodeLine>
<Link id="l00369" /><CodeLine lineNumber="369"><span class="doxyHighlight">      &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/value">Value</a> &#42;Condition, </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06afe578efb7ca235af77fb0eef7edcf639">Depth</a>) -&gt; </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00370" /><CodeLine lineNumber="370"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Condition-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>()-&gt;<a href="/docs/api/classes/llvm/type/#ac6d28a9b11139182134a9618028a0d07">isIntegerTy</a>() || <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06afe578efb7ca235af77fb0eef7edcf639">Depth</a> &gt;= MaxDepth)</span></CodeLine>
<Link id="l00371" /><CodeLine lineNumber="371"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00372" /><CodeLine lineNumber="372"></CodeLine>
<Link id="l00373" /><CodeLine lineNumber="373"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;LeftVal, &#42;RightVal;</span></CodeLine>
<Link id="l00374" /><CodeLine lineNumber="374"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Condition, <a href="/docs/api/namespaces/llvm/patternmatch/#a014d851989a66ce781c4f89dfffb26b5">m&#95;And</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(LeftVal), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(RightVal))) ||</span></CodeLine>
<Link id="l00375" /><CodeLine lineNumber="375"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Condition, <a href="/docs/api/namespaces/llvm/patternmatch/#ae44af1eeb2e5f7a1973a4ab78963a503">m&#95;Or</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(LeftVal), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(RightVal)))) &#123;</span></CodeLine>
<Link id="l00376" /><CodeLine lineNumber="376"><span class="doxyHighlight">      ComputePeelCount(LeftVal, <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06afe578efb7ca235af77fb0eef7edcf639">Depth</a> + 1);</span></CodeLine>
<Link id="l00377" /><CodeLine lineNumber="377"><span class="doxyHighlight">      ComputePeelCount(RightVal, <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06afe578efb7ca235af77fb0eef7edcf639">Depth</a> + 1);</span></CodeLine>
<Link id="l00378" /><CodeLine lineNumber="378"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00379" /><CodeLine lineNumber="379"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00380" /><CodeLine lineNumber="380"></CodeLine>
<Link id="l00381" /><CodeLine lineNumber="381"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/cmppredicate">CmpPredicate</a> Pred;</span></CodeLine>
<Link id="l00382" /><CodeLine lineNumber="382"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Condition, <a href="/docs/api/namespaces/llvm/patternmatch/#ab86c85b47e09489dcda68fd91d082d77">m&#95;ICmp</a>(Pred, <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(LeftVal), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(RightVal))))</span></CodeLine>
<Link id="l00383" /><CodeLine lineNumber="383"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00384" /><CodeLine lineNumber="384"></CodeLine>
<Link id="l00385" /><CodeLine lineNumber="385"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;LeftSCEV = SE.<a href="/docs/api/classes/llvm/scalarevolution/#a30bd18ac905eacf3601bc6a553a9ff49">getSCEV</a>(LeftVal);</span></CodeLine>
<Link id="l00386" /><CodeLine lineNumber="386"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;RightSCEV = SE.<a href="/docs/api/classes/llvm/scalarevolution/#a30bd18ac905eacf3601bc6a553a9ff49">getSCEV</a>(RightVal);</span></CodeLine>
<Link id="l00387" /><CodeLine lineNumber="387"></CodeLine>
<Link id="l00388" /><CodeLine lineNumber="388"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Do not consider predicates that are known to be true or false</span></CodeLine>
<Link id="l00389" /><CodeLine lineNumber="389"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// independently of the loop iteration.</span></CodeLine>
<Link id="l00390" /><CodeLine lineNumber="390"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SE.<a href="/docs/api/classes/llvm/scalarevolution/#ad80020012061cb562a6f9c9f715c2cf0">evaluatePredicate</a>(Pred, LeftSCEV, RightSCEV))</span></CodeLine>
<Link id="l00391" /><CodeLine lineNumber="391"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00392" /><CodeLine lineNumber="392"></CodeLine>
<Link id="l00393" /><CodeLine lineNumber="393"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Check if we have a condition with one AddRec and one non AddRec</span></CodeLine>
<Link id="l00394" /><CodeLine lineNumber="394"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// expression. Normalize LeftSCEV to be the AddRec.</span></CodeLine>
<Link id="l00395" /><CodeLine lineNumber="395"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;SCEVAddRecExpr&gt;</a>(LeftSCEV)) &#123;</span></CodeLine>
<Link id="l00396" /><CodeLine lineNumber="396"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;SCEVAddRecExpr&gt;</a>(RightSCEV)) &#123;</span></CodeLine>
<Link id="l00397" /><CodeLine lineNumber="397"><span class="doxyHighlight">        <a href="/docs/api/namespaces/std/#ab8424022895aee3e366fb9a32f2883cb">std::swap</a>(LeftSCEV, RightSCEV);</span></CodeLine>
<Link id="l00398" /><CodeLine lineNumber="398"><span class="doxyHighlight">        Pred = <a href="/docs/api/classes/llvm/cmpinst/#a49a2d8f483ea08a3d6ea75f90c640d76">ICmpInst::getSwappedPredicate</a>(Pred);</span></CodeLine>
<Link id="l00399" /><CodeLine lineNumber="399"><span class="doxyHighlight">      &#125; </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00400" /><CodeLine lineNumber="400"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00401" /><CodeLine lineNumber="401"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00402" /><CodeLine lineNumber="402"></CodeLine>
<Link id="l00403" /><CodeLine lineNumber="403"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/scevaddrecexpr">SCEVAddRecExpr</a> &#42;LeftAR = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;SCEVAddRecExpr&gt;</a>(LeftSCEV);</span></CodeLine>
<Link id="l00404" /><CodeLine lineNumber="404"></CodeLine>
<Link id="l00405" /><CodeLine lineNumber="405"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Avoid huge SCEV computations in the loop below, make sure we only</span></CodeLine>
<Link id="l00406" /><CodeLine lineNumber="406"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// consider AddRecs of the loop we are trying to peel.</span></CodeLine>
<Link id="l00407" /><CodeLine lineNumber="407"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!LeftAR-&gt;<a href="/docs/api/classes/llvm/scevaddrecexpr/#a54bb7394d874cbbef1d81e6bea89d4f3">isAffine</a>() || LeftAR-&gt;<a href="/docs/api/classes/llvm/scevaddrecexpr/#a99ab4a82c6d7373e2e367986b9527bf0">getLoop</a>() != &amp;L)</span></CodeLine>
<Link id="l00408" /><CodeLine lineNumber="408"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00409" /><CodeLine lineNumber="409"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!(<a href="/docs/api/classes/llvm/icmpinst/#abe8988eef2e6fc2baba032cb22afedd7">ICmpInst::isEquality</a>(Pred) &amp;&amp; LeftAR-&gt;<a href="/docs/api/classes/llvm/scevnaryexpr/#a6429bca8fd0024ceb2d76ccaace43c4e">hasNoSelfWrap</a>()) &amp;&amp;</span></CodeLine>
<Link id="l00410" /><CodeLine lineNumber="410"><span class="doxyHighlight">        !SE.<a href="/docs/api/classes/llvm/scalarevolution/#aa92b3e6375805368f9a24cf69ce73797">getMonotonicPredicateType</a>(LeftAR, Pred))</span></CodeLine>
<Link id="l00411" /><CodeLine lineNumber="411"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00412" /><CodeLine lineNumber="412"></CodeLine>
<Link id="l00413" /><CodeLine lineNumber="413"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Check if extending the current DesiredPeelCount lets us evaluate Pred</span></CodeLine>
<Link id="l00414" /><CodeLine lineNumber="414"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// or !Pred in the loop body statically.</span></CodeLine>
<Link id="l00415" /><CodeLine lineNumber="415"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NewPeelCount = DesiredPeelCount;</span></CodeLine>
<Link id="l00416" /><CodeLine lineNumber="416"></CodeLine>
<Link id="l00417" /><CodeLine lineNumber="417"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;IterVal = LeftAR-&gt;<a href="/docs/api/classes/llvm/scevaddrecexpr/#a33583576f220997d1c415df033559a57">evaluateAtIteration</a>(</span></CodeLine>
<Link id="l00418" /><CodeLine lineNumber="418"><span class="doxyHighlight">        SE.<a href="/docs/api/classes/llvm/scalarevolution/#a2eb94d079d8416118f4aaed865ab05d7">getConstant</a>(LeftSCEV-&gt;<a href="/docs/api/classes/llvm/scev/#aefeda9454a5e8dfcec3deb106964832a">getType</a>(), NewPeelCount), SE);</span></CodeLine>
<Link id="l00419" /><CodeLine lineNumber="419"></CodeLine>
<Link id="l00420" /><CodeLine lineNumber="420"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If the original condition is not known, get the negated predicate</span></CodeLine>
<Link id="l00421" /><CodeLine lineNumber="421"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// (which holds on the else branch) and check if it is known. This allows</span></CodeLine>
<Link id="l00422" /><CodeLine lineNumber="422"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// us to peel of iterations that make the original condition false.</span></CodeLine>
<Link id="l00423" /><CodeLine lineNumber="423"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!SE.<a href="/docs/api/classes/llvm/scalarevolution/#af74112dae88db73eb5484821b6f0fccd">isKnownPredicate</a>(Pred, IterVal, RightSCEV))</span></CodeLine>
<Link id="l00424" /><CodeLine lineNumber="424"><span class="doxyHighlight">      Pred = <a href="/docs/api/classes/llvm/cmpinst/#aa2a54b545d237ecfe450fd1292f7675e">ICmpInst::getInversePredicate</a>(Pred);</span></CodeLine>
<Link id="l00425" /><CodeLine lineNumber="425"></CodeLine>
<Link id="l00426" /><CodeLine lineNumber="426"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;Step = LeftAR-&gt;<a href="/docs/api/classes/llvm/scevaddrecexpr/#a4049f7040a4628b15f182c3c9aaf802a">getStepRecurrence</a>(SE);</span></CodeLine>
<Link id="l00427" /><CodeLine lineNumber="427"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!PeelWhilePredicateIsKnown(NewPeelCount, IterVal, RightSCEV, Step,</span></CodeLine>
<Link id="l00428" /><CodeLine lineNumber="428"><span class="doxyHighlight">                                   Pred))</span></CodeLine>
<Link id="l00429" /><CodeLine lineNumber="429"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00430" /><CodeLine lineNumber="430"></CodeLine>
<Link id="l00431" /><CodeLine lineNumber="431"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// However, for equality comparisons, that isn&#39;t always sufficient to</span></CodeLine>
<Link id="l00432" /><CodeLine lineNumber="432"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// eliminate the comparsion in loop body, we may need to peel one more</span></CodeLine>
<Link id="l00433" /><CodeLine lineNumber="433"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// iteration. See if that makes !Pred become unknown again.</span></CodeLine>
<Link id="l00434" /><CodeLine lineNumber="434"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;NextIterVal = SE.<a href="/docs/api/classes/llvm/scalarevolution/#aef6d2bea715d1793e956f41ddeea2320">getAddExpr</a>(IterVal, Step);</span></CodeLine>
<Link id="l00435" /><CodeLine lineNumber="435"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/icmpinst/#abe8988eef2e6fc2baba032cb22afedd7">ICmpInst::isEquality</a>(Pred) &amp;&amp;</span></CodeLine>
<Link id="l00436" /><CodeLine lineNumber="436"><span class="doxyHighlight">        !SE.<a href="/docs/api/classes/llvm/scalarevolution/#af74112dae88db73eb5484821b6f0fccd">isKnownPredicate</a>(<a href="/docs/api/classes/llvm/cmpinst/#aa2a54b545d237ecfe450fd1292f7675e">ICmpInst::getInversePredicate</a>(Pred), NextIterVal,</span></CodeLine>
<Link id="l00437" /><CodeLine lineNumber="437"><span class="doxyHighlight">                             RightSCEV) &amp;&amp;</span></CodeLine>
<Link id="l00438" /><CodeLine lineNumber="438"><span class="doxyHighlight">        !SE.<a href="/docs/api/classes/llvm/scalarevolution/#af74112dae88db73eb5484821b6f0fccd">isKnownPredicate</a>(Pred, IterVal, RightSCEV) &amp;&amp;</span></CodeLine>
<Link id="l00439" /><CodeLine lineNumber="439"><span class="doxyHighlight">        SE.<a href="/docs/api/classes/llvm/scalarevolution/#af74112dae88db73eb5484821b6f0fccd">isKnownPredicate</a>(Pred, NextIterVal, RightSCEV)) &#123;</span></CodeLine>
<Link id="l00440" /><CodeLine lineNumber="440"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NewPeelCount &gt;= MaxPeelCount)</span></CodeLine>
<Link id="l00441" /><CodeLine lineNumber="441"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">; </span><span class="doxyHighlightComment">// Need to peel one more iteration, but can&#39;t. Give up.</span></CodeLine>
<Link id="l00442" /><CodeLine lineNumber="442"><span class="doxyHighlight">      ++NewPeelCount; </span><span class="doxyHighlightComment">// Great!</span></CodeLine>
<Link id="l00443" /><CodeLine lineNumber="443"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00444" /><CodeLine lineNumber="444"></CodeLine>
<Link id="l00445" /><CodeLine lineNumber="445"><span class="doxyHighlight">    DesiredPeelCount = std::max(DesiredPeelCount, NewPeelCount);</span></CodeLine>
<Link id="l00446" /><CodeLine lineNumber="446"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l00447" /><CodeLine lineNumber="447"></CodeLine>
<Link id="l00448" /><CodeLine lineNumber="448"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> ComputePeelCountMinMax = &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/minmaxintrinsic">MinMaxIntrinsic</a> &#42;<a href="/docs/api/structs/llvm/minmax">MinMax</a>) &#123;</span></CodeLine>
<Link id="l00449" /><CodeLine lineNumber="449"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/structs/llvm/minmax">MinMax</a>-&gt;getType()-&gt;isIntegerTy())</span></CodeLine>
<Link id="l00450" /><CodeLine lineNumber="450"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00451" /><CodeLine lineNumber="451"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a> = <a href="/docs/api/structs/llvm/minmax">MinMax</a>-&gt;getLHS(), &#42;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a> = <a href="/docs/api/structs/llvm/minmax">MinMax</a>-&gt;getRHS();</span></CodeLine>
<Link id="l00452" /><CodeLine lineNumber="452"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;BoundSCEV, &#42;IterSCEV;</span></CodeLine>
<Link id="l00453" /><CodeLine lineNumber="453"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (L.isLoopInvariant(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>)) &#123;</span></CodeLine>
<Link id="l00454" /><CodeLine lineNumber="454"><span class="doxyHighlight">      BoundSCEV = SE.<a href="/docs/api/classes/llvm/scalarevolution/#a30bd18ac905eacf3601bc6a553a9ff49">getSCEV</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>);</span></CodeLine>
<Link id="l00455" /><CodeLine lineNumber="455"><span class="doxyHighlight">      IterSCEV = SE.<a href="/docs/api/classes/llvm/scalarevolution/#a30bd18ac905eacf3601bc6a553a9ff49">getSCEV</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>);</span></CodeLine>
<Link id="l00456" /><CodeLine lineNumber="456"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (L.isLoopInvariant(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>)) &#123;</span></CodeLine>
<Link id="l00457" /><CodeLine lineNumber="457"><span class="doxyHighlight">      BoundSCEV = SE.<a href="/docs/api/classes/llvm/scalarevolution/#a30bd18ac905eacf3601bc6a553a9ff49">getSCEV</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>);</span></CodeLine>
<Link id="l00458" /><CodeLine lineNumber="458"><span class="doxyHighlight">      IterSCEV = SE.<a href="/docs/api/classes/llvm/scalarevolution/#a30bd18ac905eacf3601bc6a553a9ff49">getSCEV</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>);</span></CodeLine>
<Link id="l00459" /><CodeLine lineNumber="459"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00460" /><CodeLine lineNumber="460"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00461" /><CodeLine lineNumber="461"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;AddRec = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;SCEVAddRecExpr&gt;</a>(IterSCEV);</span></CodeLine>
<Link id="l00462" /><CodeLine lineNumber="462"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// For simplicity, we support only affine recurrences.</span></CodeLine>
<Link id="l00463" /><CodeLine lineNumber="463"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!AddRec || !AddRec-&gt;isAffine() || AddRec-&gt;getLoop() != &amp;L)</span></CodeLine>
<Link id="l00464" /><CodeLine lineNumber="464"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00465" /><CodeLine lineNumber="465"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;Step = AddRec-&gt;getStepRecurrence(SE);</span></CodeLine>
<Link id="l00466" /><CodeLine lineNumber="466"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> IsSigned = <a href="/docs/api/structs/llvm/minmax">MinMax</a>-&gt;isSigned();</span></CodeLine>
<Link id="l00467" /><CodeLine lineNumber="467"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// To minimize number of peeled iterations, we use strict relational</span></CodeLine>
<Link id="l00468" /><CodeLine lineNumber="468"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// predicates here.</span></CodeLine>
<Link id="l00469" /><CodeLine lineNumber="469"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78b">ICmpInst::Predicate</a> Pred;</span></CodeLine>
<Link id="l00470" /><CodeLine lineNumber="470"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SE.<a href="/docs/api/classes/llvm/scalarevolution/#a5a672708a81ae8da8fb56e32638ca9b3">isKnownPositive</a>(Step))</span></CodeLine>
<Link id="l00471" /><CodeLine lineNumber="471"><span class="doxyHighlight">      Pred = IsSigned ? <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78ba15ae464950ac676919c2f0c7aafc706c">ICmpInst::ICMP&#95;SLT</a> : <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78ba91d86a4753c8bd7624e01bf565d87f8e">ICmpInst::ICMP&#95;ULT</a>;</span></CodeLine>
<Link id="l00472" /><CodeLine lineNumber="472"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SE.<a href="/docs/api/classes/llvm/scalarevolution/#a1b9806d21518ef7fb4d5c4299e21411f">isKnownNegative</a>(Step))</span></CodeLine>
<Link id="l00473" /><CodeLine lineNumber="473"><span class="doxyHighlight">      Pred = IsSigned ? <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78ba720a42e85f7e981afd61e28473b0000a">ICmpInst::ICMP&#95;SGT</a> : <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78ba607cecdc5172814382033e001ed11fad">ICmpInst::ICMP&#95;UGT</a>;</span></CodeLine>
<Link id="l00474" /><CodeLine lineNumber="474"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00475" /><CodeLine lineNumber="475"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00476" /><CodeLine lineNumber="476"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Check that AddRec is not wrapping.</span></CodeLine>
<Link id="l00477" /><CodeLine lineNumber="477"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!(IsSigned ? AddRec-&gt;hasNoSignedWrap() : AddRec-&gt;hasNoUnsignedWrap()))</span></CodeLine>
<Link id="l00478" /><CodeLine lineNumber="478"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00479" /><CodeLine lineNumber="479"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> NewPeelCount = DesiredPeelCount;</span></CodeLine>
<Link id="l00480" /><CodeLine lineNumber="480"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;IterVal = AddRec-&gt;evaluateAtIteration(</span></CodeLine>
<Link id="l00481" /><CodeLine lineNumber="481"><span class="doxyHighlight">        SE.<a href="/docs/api/classes/llvm/scalarevolution/#a2eb94d079d8416118f4aaed865ab05d7">getConstant</a>(AddRec-&gt;getType(), NewPeelCount), SE);</span></CodeLine>
<Link id="l00482" /><CodeLine lineNumber="482"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!PeelWhilePredicateIsKnown(NewPeelCount, IterVal, BoundSCEV, Step,</span></CodeLine>
<Link id="l00483" /><CodeLine lineNumber="483"><span class="doxyHighlight">                                   Pred))</span></CodeLine>
<Link id="l00484" /><CodeLine lineNumber="484"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00485" /><CodeLine lineNumber="485"><span class="doxyHighlight">    DesiredPeelCount = NewPeelCount;</span></CodeLine>
<Link id="l00486" /><CodeLine lineNumber="486"><span class="doxyHighlight">  &#125;;</span></CodeLine>
<Link id="l00487" /><CodeLine lineNumber="487"></CodeLine>
<Link id="l00488" /><CodeLine lineNumber="488"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB : L.blocks()) &#123;</span></CodeLine>
<Link id="l00489" /><CodeLine lineNumber="489"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : &#42;BB) &#123;</span></CodeLine>
<Link id="l00490" /><CodeLine lineNumber="490"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/selectinst">SelectInst</a> &#42;<a href="/docs/api/namespaces/llvm/si">SI</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;SelectInst&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</span></CodeLine>
<Link id="l00491" /><CodeLine lineNumber="491"><span class="doxyHighlight">        ComputePeelCount(<a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getCondition(), 0);</span></CodeLine>
<Link id="l00492" /><CodeLine lineNumber="492"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/minmaxintrinsic">MinMaxIntrinsic</a> &#42;<a href="/docs/api/structs/llvm/minmax">MinMax</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;MinMaxIntrinsic&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</span></CodeLine>
<Link id="l00493" /><CodeLine lineNumber="493"><span class="doxyHighlight">        ComputePeelCountMinMax(<a href="/docs/api/structs/llvm/minmax">MinMax</a>);</span></CodeLine>
<Link id="l00494" /><CodeLine lineNumber="494"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00495" /><CodeLine lineNumber="495"></CodeLine>
<Link id="l00496" /><CodeLine lineNumber="496"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;BI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BranchInst&gt;</a>(BB-&gt;getTerminator());</span></CodeLine>
<Link id="l00497" /><CodeLine lineNumber="497"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!BI || BI-&gt;isUnconditional())</span></CodeLine>
<Link id="l00498" /><CodeLine lineNumber="498"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00499" /><CodeLine lineNumber="499"></CodeLine>
<Link id="l00500" /><CodeLine lineNumber="500"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Ignore loop exit condition.</span></CodeLine>
<Link id="l00501" /><CodeLine lineNumber="501"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (L.getLoopLatch() == BB)</span></CodeLine>
<Link id="l00502" /><CodeLine lineNumber="502"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00503" /><CodeLine lineNumber="503"></CodeLine>
<Link id="l00504" /><CodeLine lineNumber="504"><span class="doxyHighlight">    ComputePeelCount(BI-&gt;getCondition(), 0);</span></CodeLine>
<Link id="l00505" /><CodeLine lineNumber="505"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00506" /><CodeLine lineNumber="506"></CodeLine>
<Link id="l00507" /><CodeLine lineNumber="507"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> DesiredPeelCount;</span></CodeLine>
<Link id="l00508" /><CodeLine lineNumber="508"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00509" /><CodeLine lineNumber="509"></CodeLine>
<Link id="l00510" /><CodeLine lineNumber="510"><span class="doxyHighlightComment">/// This &quot;heuristic&quot; exactly matches implicit behavior which used to exist</span></CodeLine>
<Link id="l00511" /><CodeLine lineNumber="511"><span class="doxyHighlightComment">/// inside getLoopEstimatedTripCount.  It was added here to keep an</span></CodeLine>
<Link id="l00512" /><CodeLine lineNumber="512"><span class="doxyHighlightComment">/// improvement inside that API from causing peeling to become more aggressive.</span></CodeLine>
<Link id="l00513" /><CodeLine lineNumber="513"><span class="doxyHighlightComment">/// This should probably be removed.</span></CodeLine>
<Link id="l00514" /><CodeLine lineNumber="514" lineLink="#a7d391dbabb8fc073db875548184a768d"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="#a7d391dbabb8fc073db875548184a768d">violatesLegacyMultiExitLoopCheck</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L) &#123;</span></CodeLine>
<Link id="l00515" /><CodeLine lineNumber="515"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Latch = L-&gt;getLoopLatch();</span></CodeLine>
<Link id="l00516" /><CodeLine lineNumber="516"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!Latch)</span></CodeLine>
<Link id="l00517" /><CodeLine lineNumber="517"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00518" /><CodeLine lineNumber="518"></CodeLine>
<Link id="l00519" /><CodeLine lineNumber="519"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;LatchBR = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BranchInst&gt;</a>(Latch-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</span></CodeLine>
<Link id="l00520" /><CodeLine lineNumber="520"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!LatchBR || LatchBR-&gt;<a href="/docs/api/classes/llvm/branchinst/#a96b8f11f6f21ca0321294669dab83b35">getNumSuccessors</a>() != 2 || !L-&gt;isLoopExiting(Latch))</span></CodeLine>
<Link id="l00521" /><CodeLine lineNumber="521"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00522" /><CodeLine lineNumber="522"></CodeLine>
<Link id="l00523" /><CodeLine lineNumber="523"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((LatchBR-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(0) == L-&gt;getHeader() ||</span></CodeLine>
<Link id="l00524" /><CodeLine lineNumber="524"><span class="doxyHighlight">          LatchBR-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(1) == L-&gt;getHeader()) &amp;&amp;</span></CodeLine>
<Link id="l00525" /><CodeLine lineNumber="525"><span class="doxyHighlight">         </span><span class="doxyHighlightStringLiteral">&quot;At least one edge out of the latch must go to the header&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00526" /><CodeLine lineNumber="526"></CodeLine>
<Link id="l00527" /><CodeLine lineNumber="527"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 4&gt;</a> ExitBlocks;</span></CodeLine>
<Link id="l00528" /><CodeLine lineNumber="528"><span class="doxyHighlight">  L-&gt;getUniqueNonLatchExitBlocks(ExitBlocks);</span></CodeLine>
<Link id="l00529" /><CodeLine lineNumber="529"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/#a61d13d6824ec46c31260a4fd0997eda0">any&#95;of</a>(ExitBlocks, &#91;&#93;(</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;EB) &#123;</span></CodeLine>
<Link id="l00530" /><CodeLine lineNumber="530"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> !EB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a6796a84f02394ce6ebef227c866cd5eb">getTerminatingDeoptimizeCall</a>();</span></CodeLine>
<Link id="l00531" /><CodeLine lineNumber="531"><span class="doxyHighlight">    &#125;);</span></CodeLine>
<Link id="l00532" /><CodeLine lineNumber="532"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00533" /><CodeLine lineNumber="533"></CodeLine>
<Link id="l00534" /><CodeLine lineNumber="534"></CodeLine>
<Link id="l00535" /><CodeLine lineNumber="535"><span class="doxyHighlightComment">// Return the number of iterations we want to peel off.</span></CodeLine>
<Link id="l00536" /><CodeLine lineNumber="536" lineLink="/docs/api/namespaces/llvm/#a1b8329ea8794c1e6fa1294a1e5a463dd"><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/#a1b8329ea8794c1e6fa1294a1e5a463dd">llvm::computePeelCount</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L, </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> LoopSize,</span></CodeLine>
<Link id="l00537" /><CodeLine lineNumber="537"><span class="doxyHighlight">                            <a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences">TargetTransformInfo::PeelingPreferences</a> &amp;PP,</span></CodeLine>
<Link id="l00538" /><CodeLine lineNumber="538"><span class="doxyHighlight">                            </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> TripCount, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT,</span></CodeLine>
<Link id="l00539" /><CodeLine lineNumber="539"><span class="doxyHighlight">                            <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &amp;SE, <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &#42;AC,</span></CodeLine>
<Link id="l00540" /><CodeLine lineNumber="540"><span class="doxyHighlight">                            </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> Threshold) &#123;</span></CodeLine>
<Link id="l00541" /><CodeLine lineNumber="541"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(LoopSize &gt; 0 &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Zero loop size is not allowed!&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00542" /><CodeLine lineNumber="542"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Save the PP.PeelCount value set by the target in</span></CodeLine>
<Link id="l00543" /><CodeLine lineNumber="543"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// TTI.getPeelingPreferences or by the flag -unroll-peel-count.</span></CodeLine>
<Link id="l00544" /><CodeLine lineNumber="544"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> TargetPeelCount = PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a93102207c7c9430df6ef02447446de9b">PeelCount</a>;</span></CodeLine>
<Link id="l00545" /><CodeLine lineNumber="545"><span class="doxyHighlight">  PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a93102207c7c9430df6ef02447446de9b">PeelCount</a> = 0;</span></CodeLine>
<Link id="l00546" /><CodeLine lineNumber="546"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/#a3aea1e78510aa7469457aade10808e51">canPeel</a>(L))</span></CodeLine>
<Link id="l00547" /><CodeLine lineNumber="547"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00548" /><CodeLine lineNumber="548"></CodeLine>
<Link id="l00549" /><CodeLine lineNumber="549"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Only try to peel innermost loops by default.</span></CodeLine>
<Link id="l00550" /><CodeLine lineNumber="550"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The constraint can be relaxed by the target in TTI.getPeelingPreferences</span></CodeLine>
<Link id="l00551" /><CodeLine lineNumber="551"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// or by the flag -unroll-allow-loop-nests-peeling.</span></CodeLine>
<Link id="l00552" /><CodeLine lineNumber="552"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a71809834780876145831c63077461284">AllowLoopNestsPeeling</a> &amp;&amp; !L-&gt;isInnermost())</span></CodeLine>
<Link id="l00553" /><CodeLine lineNumber="553"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00554" /><CodeLine lineNumber="554"></CodeLine>
<Link id="l00555" /><CodeLine lineNumber="555"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If the user provided a peel count, use that.</span></CodeLine>
<Link id="l00556" /><CodeLine lineNumber="556"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> UserPeelCount = <a href="#a6383b9c934edc393f9e9f3fd992559aa">UnrollForcePeelCount</a>.getNumOccurrences() &gt; 0;</span></CodeLine>
<Link id="l00557" /><CodeLine lineNumber="557"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (UserPeelCount) &#123;</span></CodeLine>
<Link id="l00558" /><CodeLine lineNumber="558"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Force-peeling first &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a6383b9c934edc393f9e9f3fd992559aa">UnrollForcePeelCount</a></span></CodeLine>
<Link id="l00559" /><CodeLine lineNumber="559"><span class="doxyHighlight">                      &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; iterations.\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00560" /><CodeLine lineNumber="560"><span class="doxyHighlight">    PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a93102207c7c9430df6ef02447446de9b">PeelCount</a> = <a href="#a6383b9c934edc393f9e9f3fd992559aa">UnrollForcePeelCount</a>;</span></CodeLine>
<Link id="l00561" /><CodeLine lineNumber="561"><span class="doxyHighlight">    PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a89c02eecae37f89bf86f71336630858d">PeelProfiledIterations</a> = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00562" /><CodeLine lineNumber="562"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00563" /><CodeLine lineNumber="563"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00564" /><CodeLine lineNumber="564"></CodeLine>
<Link id="l00565" /><CodeLine lineNumber="565"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Skip peeling if it&#39;s disabled.</span></CodeLine>
<Link id="l00566" /><CodeLine lineNumber="566"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a3421601051b06ed7b52a09696bd595b2">AllowPeeling</a>)</span></CodeLine>
<Link id="l00567" /><CodeLine lineNumber="567"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00568" /><CodeLine lineNumber="568"></CodeLine>
<Link id="l00569" /><CodeLine lineNumber="569"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Check that we can peel at least one iteration.</span></CodeLine>
<Link id="l00570" /><CodeLine lineNumber="570"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (2 &#42; LoopSize &gt; Threshold)</span></CodeLine>
<Link id="l00571" /><CodeLine lineNumber="571"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00572" /><CodeLine lineNumber="572"></CodeLine>
<Link id="l00573" /><CodeLine lineNumber="573"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> AlreadyPeeled = 0;</span></CodeLine>
<Link id="l00574" /><CodeLine lineNumber="574"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Peeled = <a href="/docs/api/namespaces/llvm/#a9b3cfe2d1603665824476c30368b8eb1">getOptionalIntLoopAttribute</a>(L, <a href="#a7f5685c46cf812c90576046af45cd7fa">PeeledCountMetaData</a>))</span></CodeLine>
<Link id="l00575" /><CodeLine lineNumber="575"><span class="doxyHighlight">    AlreadyPeeled = &#42;Peeled;</span></CodeLine>
<Link id="l00576" /><CodeLine lineNumber="576"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Stop if we already peeled off the maximum number of iterations.</span></CodeLine>
<Link id="l00577" /><CodeLine lineNumber="577"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (AlreadyPeeled &gt;= <a href="#a36a7dd364657e3ef9947efb9224aaca4">UnrollPeelMaxCount</a>)</span></CodeLine>
<Link id="l00578" /><CodeLine lineNumber="578"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00579" /><CodeLine lineNumber="579"></CodeLine>
<Link id="l00580" /><CodeLine lineNumber="580"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Pay respect to limitations implied by loop size and the max peel count.</span></CodeLine>
<Link id="l00581" /><CodeLine lineNumber="581"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> MaxPeelCount = <a href="#a36a7dd364657e3ef9947efb9224aaca4">UnrollPeelMaxCount</a>;</span></CodeLine>
<Link id="l00582" /><CodeLine lineNumber="582"><span class="doxyHighlight">  MaxPeelCount = std::min(MaxPeelCount, Threshold / LoopSize - 1);</span></CodeLine>
<Link id="l00583" /><CodeLine lineNumber="583"></CodeLine>
<Link id="l00584" /><CodeLine lineNumber="584"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Start the max computation with the PP.PeelCount value set by the target</span></CodeLine>
<Link id="l00585" /><CodeLine lineNumber="585"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// in TTI.getPeelingPreferences or by the flag -unroll-peel-count.</span></CodeLine>
<Link id="l00586" /><CodeLine lineNumber="586"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> DesiredPeelCount = TargetPeelCount;</span></CodeLine>
<Link id="l00587" /><CodeLine lineNumber="587"></CodeLine>
<Link id="l00588" /><CodeLine lineNumber="588"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Here we try to get rid of Phis which become invariants after 1, 2, ..., N</span></CodeLine>
<Link id="l00589" /><CodeLine lineNumber="589"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// iterations of the loop. For this we compute the number for iterations after</span></CodeLine>
<Link id="l00590" /><CodeLine lineNumber="590"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// which every Phi is guaranteed to become an invariant, and try to peel the</span></CodeLine>
<Link id="l00591" /><CodeLine lineNumber="591"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// maximum number of iterations among these values, thus turning all those</span></CodeLine>
<Link id="l00592" /><CodeLine lineNumber="592"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Phis into invariants.</span></CodeLine>
<Link id="l00593" /><CodeLine lineNumber="593"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (MaxPeelCount &gt; DesiredPeelCount) &#123;</span></CodeLine>
<Link id="l00594" /><CodeLine lineNumber="594"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Check how many iterations are useful for resolving Phis</span></CodeLine>
<Link id="l00595" /><CodeLine lineNumber="595"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> NumPeels = PhiAnalyzer(&#42;L, MaxPeelCount).calculateIterationsToPeel();</span></CodeLine>
<Link id="l00596" /><CodeLine lineNumber="596"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (NumPeels)</span></CodeLine>
<Link id="l00597" /><CodeLine lineNumber="597"><span class="doxyHighlight">      DesiredPeelCount = std::max(DesiredPeelCount, &#42;NumPeels);</span></CodeLine>
<Link id="l00598" /><CodeLine lineNumber="598"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00599" /><CodeLine lineNumber="599"></CodeLine>
<Link id="l00600" /><CodeLine lineNumber="600"><span class="doxyHighlight">  DesiredPeelCount = std::max(DesiredPeelCount,</span></CodeLine>
<Link id="l00601" /><CodeLine lineNumber="601"><span class="doxyHighlight">                              <a href="#a7098623cafc05376a44b27d202b03372">countToEliminateCompares</a>(&#42;L, MaxPeelCount, SE));</span></CodeLine>
<Link id="l00602" /><CodeLine lineNumber="602"></CodeLine>
<Link id="l00603" /><CodeLine lineNumber="603"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (DesiredPeelCount == 0)</span></CodeLine>
<Link id="l00604" /><CodeLine lineNumber="604"><span class="doxyHighlight">    DesiredPeelCount = <a href="#aaa1d9cfaf2d4ef4eca30ce71eb8c3a89">peelToTurnInvariantLoadsDerefencebale</a>(&#42;L, DT, AC);</span></CodeLine>
<Link id="l00605" /><CodeLine lineNumber="605"></CodeLine>
<Link id="l00606" /><CodeLine lineNumber="606"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (DesiredPeelCount &gt; 0) &#123;</span></CodeLine>
<Link id="l00607" /><CodeLine lineNumber="607"><span class="doxyHighlight">    DesiredPeelCount = std::min(DesiredPeelCount, MaxPeelCount);</span></CodeLine>
<Link id="l00608" /><CodeLine lineNumber="608"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Consider max peel count limitation.</span></CodeLine>
<Link id="l00609" /><CodeLine lineNumber="609"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(DesiredPeelCount &gt; 0 &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Wrong loop size estimation?&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00610" /><CodeLine lineNumber="610"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (DesiredPeelCount + AlreadyPeeled &lt;= <a href="#a36a7dd364657e3ef9947efb9224aaca4">UnrollPeelMaxCount</a>) &#123;</span></CodeLine>
<Link id="l00611" /><CodeLine lineNumber="611"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Peel &quot;</span><span class="doxyHighlight"> &lt;&lt; DesiredPeelCount</span></CodeLine>
<Link id="l00612" /><CodeLine lineNumber="612"><span class="doxyHighlight">                        &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; iteration(s) to turn&quot;</span></CodeLine>
<Link id="l00613" /><CodeLine lineNumber="613"><span class="doxyHighlight">                        &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; some Phis into invariants.\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00614" /><CodeLine lineNumber="614"><span class="doxyHighlight">      PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a93102207c7c9430df6ef02447446de9b">PeelCount</a> = DesiredPeelCount;</span></CodeLine>
<Link id="l00615" /><CodeLine lineNumber="615"><span class="doxyHighlight">      PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a89c02eecae37f89bf86f71336630858d">PeelProfiledIterations</a> = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00616" /><CodeLine lineNumber="616"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00617" /><CodeLine lineNumber="617"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00618" /><CodeLine lineNumber="618"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00619" /><CodeLine lineNumber="619"></CodeLine>
<Link id="l00620" /><CodeLine lineNumber="620"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Bail if we know the statically calculated trip count.</span></CodeLine>
<Link id="l00621" /><CodeLine lineNumber="621"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// In this case we rather prefer partial unrolling.</span></CodeLine>
<Link id="l00622" /><CodeLine lineNumber="622"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (TripCount)</span></CodeLine>
<Link id="l00623" /><CodeLine lineNumber="623"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00624" /><CodeLine lineNumber="624"></CodeLine>
<Link id="l00625" /><CodeLine lineNumber="625"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Do not apply profile base peeling if it is disabled.</span></CodeLine>
<Link id="l00626" /><CodeLine lineNumber="626"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a89c02eecae37f89bf86f71336630858d">PeelProfiledIterations</a>)</span></CodeLine>
<Link id="l00627" /><CodeLine lineNumber="627"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00628" /><CodeLine lineNumber="628"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we don&#39;t know the trip count, but have reason to believe the average</span></CodeLine>
<Link id="l00629" /><CodeLine lineNumber="629"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// trip count is low, peeling should be beneficial, since we will usually</span></CodeLine>
<Link id="l00630" /><CodeLine lineNumber="630"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// hit the peeled section.</span></CodeLine>
<Link id="l00631" /><CodeLine lineNumber="631"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We only do this in the presence of profile information, since otherwise</span></CodeLine>
<Link id="l00632" /><CodeLine lineNumber="632"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// our estimates of the trip count are not reliable enough.</span></CodeLine>
<Link id="l00633" /><CodeLine lineNumber="633"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (L-&gt;getHeader()-&gt;getParent()-&gt;hasProfileData()) &#123;</span></CodeLine>
<Link id="l00634" /><CodeLine lineNumber="634"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a7d391dbabb8fc073db875548184a768d">violatesLegacyMultiExitLoopCheck</a>(L))</span></CodeLine>
<Link id="l00635" /><CodeLine lineNumber="635"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00636" /><CodeLine lineNumber="636"><span class="doxyHighlight">    std::optional&lt;unsigned&gt; EstimatedTripCount = <a href="/docs/api/namespaces/llvm/#a0b3c6dc8e7df65d2385acfe9657abd03">getLoopEstimatedTripCount</a>(L);</span></CodeLine>
<Link id="l00637" /><CodeLine lineNumber="637"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!EstimatedTripCount)</span></CodeLine>
<Link id="l00638" /><CodeLine lineNumber="638"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00639" /><CodeLine lineNumber="639"></CodeLine>
<Link id="l00640" /><CodeLine lineNumber="640"><span class="doxyHighlight">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Profile-based estimated trip count is &quot;</span></CodeLine>
<Link id="l00641" /><CodeLine lineNumber="641"><span class="doxyHighlight">                      &lt;&lt; &#42;EstimatedTripCount &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00642" /><CodeLine lineNumber="642"></CodeLine>
<Link id="l00643" /><CodeLine lineNumber="643"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (&#42;EstimatedTripCount) &#123;</span></CodeLine>
<Link id="l00644" /><CodeLine lineNumber="644"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (&#42;EstimatedTripCount + AlreadyPeeled &lt;= MaxPeelCount) &#123;</span></CodeLine>
<Link id="l00645" /><CodeLine lineNumber="645"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> PeelCount = &#42;EstimatedTripCount;</span></CodeLine>
<Link id="l00646" /><CodeLine lineNumber="646"><span class="doxyHighlight">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Peeling first &quot;</span><span class="doxyHighlight"> &lt;&lt; PeelCount &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot; iterations.\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00647" /><CodeLine lineNumber="647"><span class="doxyHighlight">        PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a93102207c7c9430df6ef02447446de9b">PeelCount</a> = PeelCount;</span></CodeLine>
<Link id="l00648" /><CodeLine lineNumber="648"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00649" /><CodeLine lineNumber="649"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00650" /><CodeLine lineNumber="650"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Already peel count: &quot;</span><span class="doxyHighlight"> &lt;&lt; AlreadyPeeled &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00651" /><CodeLine lineNumber="651"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Max peel count: &quot;</span><span class="doxyHighlight"> &lt;&lt; <a href="#a36a7dd364657e3ef9947efb9224aaca4">UnrollPeelMaxCount</a> &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00652" /><CodeLine lineNumber="652"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Loop cost: &quot;</span><span class="doxyHighlight"> &lt;&lt; LoopSize &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00653" /><CodeLine lineNumber="653"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Max peel cost: &quot;</span><span class="doxyHighlight"> &lt;&lt; Threshold &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00654" /><CodeLine lineNumber="654"><span class="doxyHighlight">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;Max peel count by cost: &quot;</span></CodeLine>
<Link id="l00655" /><CodeLine lineNumber="655"><span class="doxyHighlight">                        &lt;&lt; (Threshold / LoopSize - 1) &lt;&lt; </span><span class="doxyHighlightStringLiteral">&quot;\\n&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00656" /><CodeLine lineNumber="656"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00657" /><CodeLine lineNumber="657"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00658" /><CodeLine lineNumber="658"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00659" /><CodeLine lineNumber="659"></CodeLine>
<Link id="l00660" /><CodeLine lineNumber="660" lineLink="/docs/api/structs/weightinfo"><span class="doxyHighlightKeyword">struct </span><span class="doxyHighlight"><a href="/docs/api/structs/weightinfo">WeightInfo</a> &#123;</span></CodeLine>
<Link id="l00661" /><CodeLine lineNumber="661"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Weights for current iteration.</span></CodeLine>
<Link id="l00662" /><CodeLine lineNumber="662" lineLink="/docs/api/structs/weightinfo/#a79bc95d0a4dfb8b3f4c7f5da4c72ff8e"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;uint32&#95;t&gt;</a> <a href="/docs/api/structs/weightinfo/#a79bc95d0a4dfb8b3f4c7f5da4c72ff8e">Weights</a>;</span></CodeLine>
<Link id="l00663" /><CodeLine lineNumber="663"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Weights to subtract after each iteration.</span></CodeLine>
<Link id="l00664" /><CodeLine lineNumber="664" lineLink="/docs/api/structs/weightinfo/#afcdb4745743d71dcdf4d80b3f6692065"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;uint32&#95;t&gt;</a> <a href="/docs/api/structs/weightinfo/#afcdb4745743d71dcdf4d80b3f6692065">SubWeights</a>;</span></CodeLine>
<Link id="l00665" /><CodeLine lineNumber="665"><span class="doxyHighlight">&#125;;</span></CodeLine>
<Link id="l00666" /><CodeLine lineNumber="666"></CodeLine>
<Link id="l00667" /><CodeLine lineNumber="667"><span class="doxyHighlightComment">/// Update the branch weights of an exiting block of a peeled-off loop</span></CodeLine>
<Link id="l00668" /><CodeLine lineNumber="668"><span class="doxyHighlightComment">/// iteration.</span></CodeLine>
<Link id="l00669" /><CodeLine lineNumber="669"><span class="doxyHighlightComment">/// Let F is a weight of the edge to continue (fallthrough) into the loop.</span></CodeLine>
<Link id="l00670" /><CodeLine lineNumber="670"><span class="doxyHighlightComment">/// Let E is a weight of the edge to an exit.</span></CodeLine>
<Link id="l00671" /><CodeLine lineNumber="671"><span class="doxyHighlightComment">/// F/(F+E) is a probability to go to loop and E/(F+E) is a probability to</span></CodeLine>
<Link id="l00672" /><CodeLine lineNumber="672"><span class="doxyHighlightComment">/// go to exit.</span></CodeLine>
<Link id="l00673" /><CodeLine lineNumber="673"><span class="doxyHighlightComment">/// Then, Estimated ExitCount = F / E.</span></CodeLine>
<Link id="l00674" /><CodeLine lineNumber="674"><span class="doxyHighlightComment">/// For I-th (counting from 0) peeled off iteration we set the weights for</span></CodeLine>
<Link id="l00675" /><CodeLine lineNumber="675"><span class="doxyHighlightComment">/// the peeled exit as (EC - I, 1). It gives us reasonable distribution,</span></CodeLine>
<Link id="l00676" /><CodeLine lineNumber="676"><span class="doxyHighlightComment">/// The probability to go to exit 1/(EC-I) increases. At the same time</span></CodeLine>
<Link id="l00677" /><CodeLine lineNumber="677"><span class="doxyHighlightComment">/// the estimated exit count in the remainder loop reduces by I.</span></CodeLine>
<Link id="l00678" /><CodeLine lineNumber="678"><span class="doxyHighlightComment">/// To avoid dealing with division rounding we can just multiple both part</span></CodeLine>
<Link id="l00679" /><CodeLine lineNumber="679"><span class="doxyHighlightComment">/// of weights to E and use weight as (F - I &#42; E, E).</span></CodeLine>
<Link id="l00680" /><CodeLine lineNumber="680" lineLink="#a070d953c06601ec34680fdc35c867b17"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#a070d953c06601ec34680fdc35c867b17">updateBranchWeights</a>(<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Term, <a href="/docs/api/structs/weightinfo">WeightInfo</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>) &#123;</span></CodeLine>
<Link id="l00681" /><CodeLine lineNumber="681"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a6cf82c052d63a1b464be8e48ff38c48e">setBranchWeights</a>(&#42;Term, <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.Weights, </span><span class="doxyHighlightComment">/&#42;IsExpected=&#42;/</span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00682" /><CodeLine lineNumber="682"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#91;Idx, SubWeight&#93; : <a href="/docs/api/namespaces/llvm/#a206e2134ddd2312c3488d0632d98f554">enumerate</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.SubWeights))</span></CodeLine>
<Link id="l00683" /><CodeLine lineNumber="683"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (SubWeight != 0)</span></CodeLine>
<Link id="l00684" /><CodeLine lineNumber="684"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Don&#39;t set the probability of taking the edge from latch to loop header</span></CodeLine>
<Link id="l00685" /><CodeLine lineNumber="685"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// to less than 1:1 ratio (meaning Weight should not be lower than</span></CodeLine>
<Link id="l00686" /><CodeLine lineNumber="686"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// SubWeight), as this could significantly reduce the loop&#39;s hotness,</span></CodeLine>
<Link id="l00687" /><CodeLine lineNumber="687"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// which would be incorrect in the case of underestimating the trip count.</span></CodeLine>
<Link id="l00688" /><CodeLine lineNumber="688"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.Weights&#91;Idx&#93; =</span></CodeLine>
<Link id="l00689" /><CodeLine lineNumber="689"><span class="doxyHighlight">          <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.Weights&#91;Idx&#93; &gt; SubWeight</span></CodeLine>
<Link id="l00690" /><CodeLine lineNumber="690"><span class="doxyHighlight">              ? std::max(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.Weights&#91;Idx&#93; - SubWeight, SubWeight)</span></CodeLine>
<Link id="l00691" /><CodeLine lineNumber="691"><span class="doxyHighlight">              : SubWeight;</span></CodeLine>
<Link id="l00692" /><CodeLine lineNumber="692"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00693" /><CodeLine lineNumber="693"></CodeLine>
<Link id="l00694" /><CodeLine lineNumber="694"><span class="doxyHighlightComment">/// Initialize the weights for all exiting blocks.</span></CodeLine>
<Link id="l00695" /><CodeLine lineNumber="695" lineLink="#acd8a7753c2685a14185133433c0bbf26"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#acd8a7753c2685a14185133433c0bbf26">initBranchWeights</a>(<a href="/docs/api/classes/llvm/densemap">DenseMap&lt;Instruction &#42;, WeightInfo&gt;</a> &amp;WeightInfos,</span></CodeLine>
<Link id="l00696" /><CodeLine lineNumber="696"><span class="doxyHighlight">                              <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L) &#123;</span></CodeLine>
<Link id="l00697" /><CodeLine lineNumber="697"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;&gt;</a> ExitingBlocks;</span></CodeLine>
<Link id="l00698" /><CodeLine lineNumber="698"><span class="doxyHighlight">  L-&gt;getExitingBlocks(ExitingBlocks);</span></CodeLine>
<Link id="l00699" /><CodeLine lineNumber="699"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ExitingBlock : ExitingBlocks) &#123;</span></CodeLine>
<Link id="l00700" /><CodeLine lineNumber="700"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Term = ExitingBlock-&gt;getTerminator();</span></CodeLine>
<Link id="l00701" /><CodeLine lineNumber="701"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;uint32&#95;t&gt;</a> Weights;</span></CodeLine>
<Link id="l00702" /><CodeLine lineNumber="702"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!<a href="/docs/api/namespaces/llvm/#ac19cbbc4935a23e1d44f65e1eaba6b1d">extractBranchWeights</a>(&#42;Term, Weights))</span></CodeLine>
<Link id="l00703" /><CodeLine lineNumber="703"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00704" /><CodeLine lineNumber="704"></CodeLine>
<Link id="l00705" /><CodeLine lineNumber="705"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// See the comment on updateBranchWeights() for an explanation of what we</span></CodeLine>
<Link id="l00706" /><CodeLine lineNumber="706"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// do here.</span></CodeLine>
<Link id="l00707" /><CodeLine lineNumber="707"><span class="doxyHighlight">    uint32&#95;t FallThroughWeights = 0;</span></CodeLine>
<Link id="l00708" /><CodeLine lineNumber="708"><span class="doxyHighlight">    uint32&#95;t ExitWeights = 0;</span></CodeLine>
<Link id="l00709" /><CodeLine lineNumber="709"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#91;Succ, Weight&#93; : <a href="/docs/api/namespaces/llvm/#a06041e3bf4b0a9e8984809413ddd9506">zip</a>(<a href="/docs/api/namespaces/llvm/#a26e2a938b431eaa6eca2beaa96410c9d">successors</a>(Term), Weights)) &#123;</span></CodeLine>
<Link id="l00710" /><CodeLine lineNumber="710"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (L-&gt;contains(Succ))</span></CodeLine>
<Link id="l00711" /><CodeLine lineNumber="711"><span class="doxyHighlight">        FallThroughWeights += Weight;</span></CodeLine>
<Link id="l00712" /><CodeLine lineNumber="712"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00713" /><CodeLine lineNumber="713"><span class="doxyHighlight">        ExitWeights += Weight;</span></CodeLine>
<Link id="l00714" /><CodeLine lineNumber="714"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00715" /><CodeLine lineNumber="715"></CodeLine>
<Link id="l00716" /><CodeLine lineNumber="716"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Don&#39;t try to update weights for degenerate case.</span></CodeLine>
<Link id="l00717" /><CodeLine lineNumber="717"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (FallThroughWeights == 0)</span></CodeLine>
<Link id="l00718" /><CodeLine lineNumber="718"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00719" /><CodeLine lineNumber="719"></CodeLine>
<Link id="l00720" /><CodeLine lineNumber="720"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;uint32&#95;t&gt;</a> SubWeights;</span></CodeLine>
<Link id="l00721" /><CodeLine lineNumber="721"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#91;Succ, Weight&#93; : <a href="/docs/api/namespaces/llvm/#a06041e3bf4b0a9e8984809413ddd9506">zip</a>(<a href="/docs/api/namespaces/llvm/#a26e2a938b431eaa6eca2beaa96410c9d">successors</a>(Term), Weights)) &#123;</span></CodeLine>
<Link id="l00722" /><CodeLine lineNumber="722"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!L-&gt;contains(Succ)) &#123;</span></CodeLine>
<Link id="l00723" /><CodeLine lineNumber="723"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// Exit weights stay the same.</span></CodeLine>
<Link id="l00724" /><CodeLine lineNumber="724"><span class="doxyHighlight">        SubWeights.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(0);</span></CodeLine>
<Link id="l00725" /><CodeLine lineNumber="725"><span class="doxyHighlight">        </span><span class="doxyHighlightKeywordFlow">continue</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00726" /><CodeLine lineNumber="726"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00727" /><CodeLine lineNumber="727"></CodeLine>
<Link id="l00728" /><CodeLine lineNumber="728"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// Subtract exit weights on each iteration, distributed across all</span></CodeLine>
<Link id="l00729" /><CodeLine lineNumber="729"><span class="doxyHighlight">      </span><span class="doxyHighlightComment">// fallthrough edges.</span></CodeLine>
<Link id="l00730" /><CodeLine lineNumber="730"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordType">double</span><span class="doxyHighlight"> W = (double)Weight / (</span><span class="doxyHighlightKeywordType">double</span><span class="doxyHighlight">)FallThroughWeights;</span></CodeLine>
<Link id="l00731" /><CodeLine lineNumber="731"><span class="doxyHighlight">      SubWeights.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>((uint32&#95;t)(ExitWeights &#42; W));</span></CodeLine>
<Link id="l00732" /><CodeLine lineNumber="732"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00733" /><CodeLine lineNumber="733"></CodeLine>
<Link id="l00734" /><CodeLine lineNumber="734"><span class="doxyHighlight">    WeightInfos.<a href="/docs/api/classes/llvm/densemapbase/#adb33f3ede2f5bfc9b3ee658aaf648492">insert</a>(&#123;Term, &#123;std::move(Weights), std::move(SubWeights)&#125;&#125;);</span></CodeLine>
<Link id="l00735" /><CodeLine lineNumber="735"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00736" /><CodeLine lineNumber="736"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00737" /><CodeLine lineNumber="737"></CodeLine>
<Link id="l00738" /><CodeLine lineNumber="738"><span class="doxyHighlightComment">/// Clones the body of the loop L, putting it between \\p InsertTop and \\p</span></CodeLine>
<Link id="l00739" /><CodeLine lineNumber="739"><span class="doxyHighlightComment">/// InsertBot.</span></CodeLine>
<Link id="l00740" /><CodeLine lineNumber="740"><span class="doxyHighlightComment">/// \\param IterNumber The serial number of the iteration currently being</span></CodeLine>
<Link id="l00741" /><CodeLine lineNumber="741"><span class="doxyHighlightComment">/// peeled off.</span></CodeLine>
<Link id="l00742" /><CodeLine lineNumber="742"><span class="doxyHighlightComment">/// \\param ExitEdges The exit edges of the original loop.</span></CodeLine>
<Link id="l00743" /><CodeLine lineNumber="743"><span class="doxyHighlightComment">/// \\param&#91;out&#93; NewBlocks A list of the blocks in the newly created clone</span></CodeLine>
<Link id="l00744" /><CodeLine lineNumber="744"><span class="doxyHighlightComment">/// \\param&#91;out&#93; VMap The value map between the loop and the new clone.</span></CodeLine>
<Link id="l00745" /><CodeLine lineNumber="745"><span class="doxyHighlightComment">/// \\param LoopBlocks A helper for DFS-traversal of the loop.</span></CodeLine>
<Link id="l00746" /><CodeLine lineNumber="746"><span class="doxyHighlightComment">/// \\param LVMap A value-map that maps instructions from the original loop to</span></CodeLine>
<Link id="l00747" /><CodeLine lineNumber="747"><span class="doxyHighlightComment">/// instructions in the last peeled-off iteration.</span></CodeLine>
<Link id="l00748" /><CodeLine lineNumber="748" lineLink="#a8478b291f8a10892334ba0bcf6a18528"><span class="doxyHighlightKeyword">static</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeywordType">void</span><span class="doxyHighlight"> <a href="#a8478b291f8a10892334ba0bcf6a18528">cloneLoopBlocks</a>(</span></CodeLine>
<Link id="l00749" /><CodeLine lineNumber="749"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L, </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> IterNumber, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;InsertTop, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;InsertBot,</span></CodeLine>
<Link id="l00750" /><CodeLine lineNumber="750"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt;std::pair&lt;BasicBlock &#42;, BasicBlock &#42;&gt;&gt; &amp;ExitEdges,</span></CodeLine>
<Link id="l00751" /><CodeLine lineNumber="751"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;BasicBlock &#42;&gt;</a> &amp;NewBlocks, <a href="/docs/api/classes/llvm/loopblocksdfs">LoopBlocksDFS</a> &amp;LoopBlocks,</span></CodeLine>
<Link id="l00752" /><CodeLine lineNumber="752"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp;VMap, <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp;LVMap, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &#42;DT,</span></CodeLine>
<Link id="l00753" /><CodeLine lineNumber="753"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &#42;LI, <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;MDNode &#42;&gt;</a> LoopLocalNoAliasDeclScopes,</span></CodeLine>
<Link id="l00754" /><CodeLine lineNumber="754"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &amp;SE) &#123;</span></CodeLine>
<Link id="l00755" /><CodeLine lineNumber="755"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Header = L-&gt;getHeader();</span></CodeLine>
<Link id="l00756" /><CodeLine lineNumber="756"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Latch = L-&gt;getLoopLatch();</span></CodeLine>
<Link id="l00757" /><CodeLine lineNumber="757"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;PreHeader = L-&gt;getLoopPreheader();</span></CodeLine>
<Link id="l00758" /><CodeLine lineNumber="758"></CodeLine>
<Link id="l00759" /><CodeLine lineNumber="759"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = Header-&gt;getParent();</span></CodeLine>
<Link id="l00760" /><CodeLine lineNumber="760"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/loopblocksdfs/#a0c1bb1134650f3f69f5921d57fb50b78">LoopBlocksDFS::RPOIterator</a> BlockBegin = LoopBlocks.<a href="/docs/api/classes/llvm/loopblocksdfs/#a003fe6215d300fc9720b1b056cdf4c23">beginRPO</a>();</span></CodeLine>
<Link id="l00761" /><CodeLine lineNumber="761"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/loopblocksdfs/#a0c1bb1134650f3f69f5921d57fb50b78">LoopBlocksDFS::RPOIterator</a> BlockEnd = LoopBlocks.<a href="/docs/api/classes/llvm/loopblocksdfs/#aeebda6b0288bea7cd706111624ca73f6">endRPO</a>();</span></CodeLine>
<Link id="l00762" /><CodeLine lineNumber="762"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ParentLoop = L-&gt;getParentLoop();</span></CodeLine>
<Link id="l00763" /><CodeLine lineNumber="763"></CodeLine>
<Link id="l00764" /><CodeLine lineNumber="764"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For each block in the original loop, create a new copy,</span></CodeLine>
<Link id="l00765" /><CodeLine lineNumber="765"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// and update the value map with the newly created values.</span></CodeLine>
<Link id="l00766" /><CodeLine lineNumber="766"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/loopblocksdfs/#a0c1bb1134650f3f69f5921d57fb50b78">LoopBlocksDFS::RPOIterator</a> BB = BlockBegin; BB != BlockEnd; ++BB) &#123;</span></CodeLine>
<Link id="l00767" /><CodeLine lineNumber="767"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewBB = <a href="/docs/api/namespaces/llvm/#aa1c8d384f90fc9d69d7fcdf920138cf2">CloneBasicBlock</a>(&#42;BB, VMap, </span><span class="doxyHighlightStringLiteral">&quot;.peel&quot;</span><span class="doxyHighlight">, <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</span></CodeLine>
<Link id="l00768" /><CodeLine lineNumber="768"><span class="doxyHighlight">    NewBlocks.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(NewBB);</span></CodeLine>
<Link id="l00769" /><CodeLine lineNumber="769"></CodeLine>
<Link id="l00770" /><CodeLine lineNumber="770"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If an original block is an immediate child of the loop L, its copy</span></CodeLine>
<Link id="l00771" /><CodeLine lineNumber="771"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// is a child of a ParentLoop after peeling. If a block is a child of</span></CodeLine>
<Link id="l00772" /><CodeLine lineNumber="772"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// a nested loop, it is handled in the cloneLoop() call below.</span></CodeLine>
<Link id="l00773" /><CodeLine lineNumber="773"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (ParentLoop &amp;&amp; LI-&gt;<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(&#42;BB) == L)</span></CodeLine>
<Link id="l00774" /><CodeLine lineNumber="774"><span class="doxyHighlight">      ParentLoop-&gt;<a href="/docs/api/classes/llvm/loopbase/#a63f099d3bf7cf97eb3ae2d630e3d1afc">addBasicBlockToLoop</a>(NewBB, &#42;LI);</span></CodeLine>
<Link id="l00775" /><CodeLine lineNumber="775"></CodeLine>
<Link id="l00776" /><CodeLine lineNumber="776"><span class="doxyHighlight">    VMap&#91;&#42;BB&#93; = NewBB;</span></CodeLine>
<Link id="l00777" /><CodeLine lineNumber="777"></CodeLine>
<Link id="l00778" /><CodeLine lineNumber="778"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// If dominator tree is available, insert nodes to represent cloned blocks.</span></CodeLine>
<Link id="l00779" /><CodeLine lineNumber="779"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (DT) &#123;</span></CodeLine>
<Link id="l00780" /><CodeLine lineNumber="780"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Header == &#42;BB)</span></CodeLine>
<Link id="l00781" /><CodeLine lineNumber="781"><span class="doxyHighlight">        DT-&gt;<a href="/docs/api/classes/llvm/dominatortreebase/#a4211a49504539a8a37aebb00e1390370">addNewBlock</a>(NewBB, InsertTop);</span></CodeLine>
<Link id="l00782" /><CodeLine lineNumber="782"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00783" /><CodeLine lineNumber="783"><span class="doxyHighlight">        <a href="/docs/api/namespaces/llvm/#a58b9df85470fc4e2a8066ff6a62e5a34">DomTreeNode</a> &#42;IDom = DT-&gt;<a href="/docs/api/classes/llvm/dominatortreebase/#ad8295b9b507d1d847cd46856f8255eab">getNode</a>(&#42;BB)-&gt;<a href="/docs/api/classes/llvm/domtreenodebase/#a453de62c2dadf7b4b8df04e89f6ab4e0">getIDom</a>();</span></CodeLine>
<Link id="l00784" /><CodeLine lineNumber="784"><span class="doxyHighlight">        </span><span class="doxyHighlightComment">// VMap must contain entry for IDom, as the iteration order is RPO.</span></CodeLine>
<Link id="l00785" /><CodeLine lineNumber="785"><span class="doxyHighlight">        DT-&gt;<a href="/docs/api/classes/llvm/dominatortreebase/#a4211a49504539a8a37aebb00e1390370">addNewBlock</a>(NewBB, <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(VMap&#91;IDom-&gt;<a href="/docs/api/classes/llvm/domtreenodebase/#aab2bf365c9f4b976adc7479576dfd5bb">getBlock</a>()&#93;));</span></CodeLine>
<Link id="l00786" /><CodeLine lineNumber="786"><span class="doxyHighlight">      &#125;</span></CodeLine>
<Link id="l00787" /><CodeLine lineNumber="787"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00788" /><CodeLine lineNumber="788"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00789" /><CodeLine lineNumber="789"></CodeLine>
<Link id="l00790" /><CodeLine lineNumber="790"><span class="doxyHighlight">  &#123;</span></CodeLine>
<Link id="l00791" /><CodeLine lineNumber="791"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Identify what other metadata depends on the cloned version. After</span></CodeLine>
<Link id="l00792" /><CodeLine lineNumber="792"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// cloning, replace the metadata with the corrected version for both</span></CodeLine>
<Link id="l00793" /><CodeLine lineNumber="793"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// memory instructions and noalias intrinsics.</span></CodeLine>
<Link id="l00794" /><CodeLine lineNumber="794"><span class="doxyHighlight">    std::string Ext = (<a href="/docs/api/classes/llvm/twine">Twine</a>(</span><span class="doxyHighlightStringLiteral">&quot;Peel&quot;</span><span class="doxyHighlight">) + <a href="/docs/api/classes/llvm/twine">Twine</a>(IterNumber)).str();</span></CodeLine>
<Link id="l00795" /><CodeLine lineNumber="795"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#ab7abd0e34c17dcb201a4138dc65cc067">cloneAndAdaptNoAliasScopes</a>(LoopLocalNoAliasDeclScopes, NewBlocks,</span></CodeLine>
<Link id="l00796" /><CodeLine lineNumber="796"><span class="doxyHighlight">                               Header-&gt;getContext(), Ext);</span></CodeLine>
<Link id="l00797" /><CodeLine lineNumber="797"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00798" /><CodeLine lineNumber="798"></CodeLine>
<Link id="l00799" /><CodeLine lineNumber="799"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Recursively create the new Loop objects for nested loops, if any,</span></CodeLine>
<Link id="l00800" /><CodeLine lineNumber="800"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// to preserve LoopInfo.</span></CodeLine>
<Link id="l00801" /><CodeLine lineNumber="801"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ChildLoop : &#42;L) &#123;</span></CodeLine>
<Link id="l00802" /><CodeLine lineNumber="802"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#afe8e2e0edcd7756ff5985b8798270c5d">cloneLoop</a>(ChildLoop, ParentLoop, VMap, LI, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00803" /><CodeLine lineNumber="803"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00804" /><CodeLine lineNumber="804"></CodeLine>
<Link id="l00805" /><CodeLine lineNumber="805"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Hook-up the control flow for the newly inserted blocks.</span></CodeLine>
<Link id="l00806" /><CodeLine lineNumber="806"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The new header is hooked up directly to the &quot;top&quot;, which is either</span></CodeLine>
<Link id="l00807" /><CodeLine lineNumber="807"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the original loop preheader (for the first iteration) or the previous</span></CodeLine>
<Link id="l00808" /><CodeLine lineNumber="808"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// iteration&#39;s exiting block (for every other iteration)</span></CodeLine>
<Link id="l00809" /><CodeLine lineNumber="809"><span class="doxyHighlight">  InsertTop-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>()-&gt;<a href="/docs/api/classes/llvm/instruction/#ae959364e4640ac025bbc046d3d7c7e61">setSuccessor</a>(0, <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(VMap&#91;Header&#93;));</span></CodeLine>
<Link id="l00810" /><CodeLine lineNumber="810"></CodeLine>
<Link id="l00811" /><CodeLine lineNumber="811"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Similarly, for the latch:</span></CodeLine>
<Link id="l00812" /><CodeLine lineNumber="812"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The original exiting edge is still hooked up to the loop exit.</span></CodeLine>
<Link id="l00813" /><CodeLine lineNumber="813"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The backedge now goes to the &quot;bottom&quot;, which is either the loop&#39;s real</span></CodeLine>
<Link id="l00814" /><CodeLine lineNumber="814"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// header (for the last peeled iteration) or the copied header of the next</span></CodeLine>
<Link id="l00815" /><CodeLine lineNumber="815"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// iteration (for every other iteration)</span></CodeLine>
<Link id="l00816" /><CodeLine lineNumber="816"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewLatch = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(VMap&#91;Latch&#93;);</span></CodeLine>
<Link id="l00817" /><CodeLine lineNumber="817"><span class="doxyHighlight">  </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;LatchTerm = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Instruction&gt;</a>(NewLatch-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</span></CodeLine>
<Link id="l00818" /><CodeLine lineNumber="818"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> idx = 0, e = LatchTerm-&gt;getNumSuccessors(); idx &lt; e; ++idx)</span></CodeLine>
<Link id="l00819" /><CodeLine lineNumber="819"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LatchTerm-&gt;getSuccessor(idx) == Header) &#123;</span></CodeLine>
<Link id="l00820" /><CodeLine lineNumber="820"><span class="doxyHighlight">      LatchTerm-&gt;setSuccessor(idx, InsertBot);</span></CodeLine>
<Link id="l00821" /><CodeLine lineNumber="821"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">break</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00822" /><CodeLine lineNumber="822"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00823" /><CodeLine lineNumber="823"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (DT)</span></CodeLine>
<Link id="l00824" /><CodeLine lineNumber="824"><span class="doxyHighlight">    DT-&gt;<a href="/docs/api/classes/llvm/dominatortreebase/#a2881c226e1c102190d54c3b664330aba">changeImmediateDominator</a>(InsertBot, NewLatch);</span></CodeLine>
<Link id="l00825" /><CodeLine lineNumber="825"></CodeLine>
<Link id="l00826" /><CodeLine lineNumber="826"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// The new copy of the loop body starts with a bunch of PHI nodes</span></CodeLine>
<Link id="l00827" /><CodeLine lineNumber="827"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// that pick an incoming value from either the preheader, or the previous</span></CodeLine>
<Link id="l00828" /><CodeLine lineNumber="828"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// loop iteration. Since this copy is no longer part of the loop, we</span></CodeLine>
<Link id="l00829" /><CodeLine lineNumber="829"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// resolve this statically:</span></CodeLine>
<Link id="l00830" /><CodeLine lineNumber="830"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For the first iteration, we use the value from the preheader directly.</span></CodeLine>
<Link id="l00831" /><CodeLine lineNumber="831"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For any other iteration, we replace the phi with the value generated by</span></CodeLine>
<Link id="l00832" /><CodeLine lineNumber="832"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the immediately preceding clone of the loop body (which represents</span></CodeLine>
<Link id="l00833" /><CodeLine lineNumber="833"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// the previous iteration).</span></CodeLine>
<Link id="l00834" /><CodeLine lineNumber="834"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = Header-&gt;begin(); <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;PHINode&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>); ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &#123;</span></CodeLine>
<Link id="l00835" /><CodeLine lineNumber="835"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;NewPHI = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;PHINode&gt;</a>(VMap&#91;&amp;&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93;);</span></CodeLine>
<Link id="l00836" /><CodeLine lineNumber="836"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (IterNumber == 0) &#123;</span></CodeLine>
<Link id="l00837" /><CodeLine lineNumber="837"><span class="doxyHighlight">      VMap&#91;&amp;&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; = NewPHI-&gt;<a href="/docs/api/classes/llvm/phinode/#ab2db7609ec72b1af2f91d47e40dc3722">getIncomingValueForBlock</a>(PreHeader);</span></CodeLine>
<Link id="l00838" /><CodeLine lineNumber="838"><span class="doxyHighlight">    &#125; </span><span class="doxyHighlightKeywordFlow">else</span><span class="doxyHighlight"> &#123;</span></CodeLine>
<Link id="l00839" /><CodeLine lineNumber="839"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;LatchVal = NewPHI-&gt;<a href="/docs/api/classes/llvm/phinode/#ab2db7609ec72b1af2f91d47e40dc3722">getIncomingValueForBlock</a>(Latch);</span></CodeLine>
<Link id="l00840" /><CodeLine lineNumber="840"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;LatchInst = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(LatchVal);</span></CodeLine>
<Link id="l00841" /><CodeLine lineNumber="841"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LatchInst &amp;&amp; L-&gt;contains(LatchInst))</span></CodeLine>
<Link id="l00842" /><CodeLine lineNumber="842"><span class="doxyHighlight">        VMap&#91;&amp;&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; = LVMap&#91;LatchInst&#93;;</span></CodeLine>
<Link id="l00843" /><CodeLine lineNumber="843"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">else</span></CodeLine>
<Link id="l00844" /><CodeLine lineNumber="844"><span class="doxyHighlight">        VMap&#91;&amp;&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; = LatchVal;</span></CodeLine>
<Link id="l00845" /><CodeLine lineNumber="845"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00846" /><CodeLine lineNumber="846"><span class="doxyHighlight">    NewPHI-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</span></CodeLine>
<Link id="l00847" /><CodeLine lineNumber="847"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00848" /><CodeLine lineNumber="848"></CodeLine>
<Link id="l00849" /><CodeLine lineNumber="849"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Fix up the outgoing values - we need to add a value for the iteration</span></CodeLine>
<Link id="l00850" /><CodeLine lineNumber="850"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// we&#39;ve just created. Note that this must happen &#42;after&#42; the incoming</span></CodeLine>
<Link id="l00851" /><CodeLine lineNumber="851"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// values are adjusted, since the value going out of the latch may also be</span></CodeLine>
<Link id="l00852" /><CodeLine lineNumber="852"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// a value coming into the header.</span></CodeLine>
<Link id="l00853" /><CodeLine lineNumber="853"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Edge : ExitEdges)</span></CodeLine>
<Link id="l00854" /><CodeLine lineNumber="854"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/phinode">PHINode</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a> : Edge.second-&gt;phis()) &#123;</span></CodeLine>
<Link id="l00855" /><CodeLine lineNumber="855"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;LatchVal = <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a>.getIncomingValueForBlock(Edge.first);</span></CodeLine>
<Link id="l00856" /><CodeLine lineNumber="856"><span class="doxyHighlight">      <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;LatchInst = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(LatchVal);</span></CodeLine>
<Link id="l00857" /><CodeLine lineNumber="857"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LatchInst &amp;&amp; L-&gt;contains(LatchInst))</span></CodeLine>
<Link id="l00858" /><CodeLine lineNumber="858"><span class="doxyHighlight">        LatchVal = VMap&#91;LatchVal&#93;;</span></CodeLine>
<Link id="l00859" /><CodeLine lineNumber="859"><span class="doxyHighlight">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a>.addIncoming(LatchVal, <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(VMap&#91;Edge.first&#93;));</span></CodeLine>
<Link id="l00860" /><CodeLine lineNumber="860"><span class="doxyHighlight">      SE.<a href="/docs/api/classes/llvm/scalarevolution/#aa6dc58a1259941c7a17142e6103d059e">forgetLcssaPhiWithNewPredecessor</a>(L, &amp;<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a>);</span></CodeLine>
<Link id="l00861" /><CodeLine lineNumber="861"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00862" /><CodeLine lineNumber="862"></CodeLine>
<Link id="l00863" /><CodeLine lineNumber="863"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// LastValueMap is updated with the values for the current loop</span></CodeLine>
<Link id="l00864" /><CodeLine lineNumber="864"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// which are used the next time this function is called.</span></CodeLine>
<Link id="l00865" /><CodeLine lineNumber="865"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> KV : VMap)</span></CodeLine>
<Link id="l00866" /><CodeLine lineNumber="866"><span class="doxyHighlight">    LVMap&#91;KV.first&#93; = KV.second;</span></CodeLine>
<Link id="l00867" /><CodeLine lineNumber="867"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00868" /><CodeLine lineNumber="868"></CodeLine>
<Link id="l00869" /><CodeLine lineNumber="869"><span class="doxyHighlight">TargetTransformInfo::PeelingPreferences</span></CodeLine>
<Link id="l00870" /><CodeLine lineNumber="870" lineLink="/docs/api/namespaces/llvm/#a6e86d0ac2e968adc60290ca52da02e42"><span class="doxyHighlight"><a href="/docs/api/namespaces/llvm/#a6e86d0ac2e968adc60290ca52da02e42">llvm::gatherPeelingPreferences</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &amp;SE,</span></CodeLine>
<Link id="l00871" /><CodeLine lineNumber="871"><span class="doxyHighlight">                               </span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> <a href="/docs/api/classes/llvm/targettransforminfo">TargetTransformInfo</a> &amp;<a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>,</span></CodeLine>
<Link id="l00872" /><CodeLine lineNumber="872"><span class="doxyHighlight">                               std::optional&lt;bool&gt; UserAllowPeeling,</span></CodeLine>
<Link id="l00873" /><CodeLine lineNumber="873"><span class="doxyHighlight">                               std::optional&lt;bool&gt; UserAllowProfileBasedPeeling,</span></CodeLine>
<Link id="l00874" /><CodeLine lineNumber="874"><span class="doxyHighlight">                               </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> UnrollingSpecficValues) &#123;</span></CodeLine>
<Link id="l00875" /><CodeLine lineNumber="875"><span class="doxyHighlight">  <a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences">TargetTransformInfo::PeelingPreferences</a> PP;</span></CodeLine>
<Link id="l00876" /><CodeLine lineNumber="876"></CodeLine>
<Link id="l00877" /><CodeLine lineNumber="877"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Set the default values.</span></CodeLine>
<Link id="l00878" /><CodeLine lineNumber="878"><span class="doxyHighlight">  PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a93102207c7c9430df6ef02447446de9b">PeelCount</a> = 0;</span></CodeLine>
<Link id="l00879" /><CodeLine lineNumber="879"><span class="doxyHighlight">  PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a3421601051b06ed7b52a09696bd595b2">AllowPeeling</a> = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00880" /><CodeLine lineNumber="880"><span class="doxyHighlight">  PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a71809834780876145831c63077461284">AllowLoopNestsPeeling</a> = </span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00881" /><CodeLine lineNumber="881"><span class="doxyHighlight">  PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a89c02eecae37f89bf86f71336630858d">PeelProfiledIterations</a> = </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l00882" /><CodeLine lineNumber="882"></CodeLine>
<Link id="l00883" /><CodeLine lineNumber="883"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Get the target specifc values.</span></CodeLine>
<Link id="l00884" /><CodeLine lineNumber="884"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>.getPeelingPreferences(L, SE, PP);</span></CodeLine>
<Link id="l00885" /><CodeLine lineNumber="885"></CodeLine>
<Link id="l00886" /><CodeLine lineNumber="886"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// User specified values using cl::opt.</span></CodeLine>
<Link id="l00887" /><CodeLine lineNumber="887"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (UnrollingSpecficValues) &#123;</span></CodeLine>
<Link id="l00888" /><CodeLine lineNumber="888"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#aa9badf8f59af8beee7f66a5252019f70">UnrollPeelCount</a>.getNumOccurrences() &gt; 0)</span></CodeLine>
<Link id="l00889" /><CodeLine lineNumber="889"><span class="doxyHighlight">      PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a93102207c7c9430df6ef02447446de9b">PeelCount</a> = <a href="#aa9badf8f59af8beee7f66a5252019f70">UnrollPeelCount</a>;</span></CodeLine>
<Link id="l00890" /><CodeLine lineNumber="890"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#a626a61b9d8aa04db77aaff8e96059f93">UnrollAllowPeeling</a>.getNumOccurrences() &gt; 0)</span></CodeLine>
<Link id="l00891" /><CodeLine lineNumber="891"><span class="doxyHighlight">      PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a3421601051b06ed7b52a09696bd595b2">AllowPeeling</a> = <a href="#a626a61b9d8aa04db77aaff8e96059f93">UnrollAllowPeeling</a>;</span></CodeLine>
<Link id="l00892" /><CodeLine lineNumber="892"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="#aa4d9cb6aeac6c6254d62eeb6c4b662ee">UnrollAllowLoopNestsPeeling</a>.getNumOccurrences() &gt; 0)</span></CodeLine>
<Link id="l00893" /><CodeLine lineNumber="893"><span class="doxyHighlight">      PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a71809834780876145831c63077461284">AllowLoopNestsPeeling</a> = <a href="#aa4d9cb6aeac6c6254d62eeb6c4b662ee">UnrollAllowLoopNestsPeeling</a>;</span></CodeLine>
<Link id="l00894" /><CodeLine lineNumber="894"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00895" /><CodeLine lineNumber="895"></CodeLine>
<Link id="l00896" /><CodeLine lineNumber="896"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// User specifed values provided by argument.</span></CodeLine>
<Link id="l00897" /><CodeLine lineNumber="897"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (UserAllowPeeling)</span></CodeLine>
<Link id="l00898" /><CodeLine lineNumber="898"><span class="doxyHighlight">    PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a3421601051b06ed7b52a09696bd595b2">AllowPeeling</a> = &#42;UserAllowPeeling;</span></CodeLine>
<Link id="l00899" /><CodeLine lineNumber="899"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (UserAllowProfileBasedPeeling)</span></CodeLine>
<Link id="l00900" /><CodeLine lineNumber="900"><span class="doxyHighlight">    PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a89c02eecae37f89bf86f71336630858d">PeelProfiledIterations</a> = &#42;UserAllowProfileBasedPeeling;</span></CodeLine>
<Link id="l00901" /><CodeLine lineNumber="901"></CodeLine>
<Link id="l00902" /><CodeLine lineNumber="902"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> PP;</span></CodeLine>
<Link id="l00903" /><CodeLine lineNumber="903"><span class="doxyHighlight">&#125;</span></CodeLine>
<Link id="l00904" /><CodeLine lineNumber="904"></CodeLine>
<Link id="l00905" /><CodeLine lineNumber="905"><span class="doxyHighlightComment">/// Peel off the first \\p PeelCount iterations of loop \\p L.</span></CodeLine>
<Link id="l00906" /><CodeLine lineNumber="906"><span class="doxyHighlightComment">///</span></CodeLine>
<Link id="l00907" /><CodeLine lineNumber="907"><span class="doxyHighlightComment">/// Note that this does not peel them off as a single straight-line block.</span></CodeLine>
<Link id="l00908" /><CodeLine lineNumber="908"><span class="doxyHighlightComment">/// Rather, each iteration is peeled off separately, and needs to check the</span></CodeLine>
<Link id="l00909" /><CodeLine lineNumber="909"><span class="doxyHighlightComment">/// exit condition.</span></CodeLine>
<Link id="l00910" /><CodeLine lineNumber="910"><span class="doxyHighlightComment">/// For loops that dynamically execute \\p PeelCount iterations or less</span></CodeLine>
<Link id="l00911" /><CodeLine lineNumber="911"><span class="doxyHighlightComment">/// this provides a benefit, since the peeled off iterations, which account</span></CodeLine>
<Link id="l00912" /><CodeLine lineNumber="912"><span class="doxyHighlightComment">/// for the bulk of dynamic execution, can be further simplified by scalar</span></CodeLine>
<Link id="l00913" /><CodeLine lineNumber="913"><span class="doxyHighlightComment">/// optimizations.</span></CodeLine>
<Link id="l00914" /><CodeLine lineNumber="914" lineLink="/docs/api/namespaces/llvm/#afdb3eec2f46233c924c30c0838a3c8fe"><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> <a href="/docs/api/namespaces/llvm/#afdb3eec2f46233c924c30c0838a3c8fe">llvm::peelLoop</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L, </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> PeelCount, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &#42;LI,</span></CodeLine>
<Link id="l00915" /><CodeLine lineNumber="915"><span class="doxyHighlight">                    <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42;SE, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT, <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &#42;AC,</span></CodeLine>
<Link id="l00916" /><CodeLine lineNumber="916"><span class="doxyHighlight">                    </span><span class="doxyHighlightKeywordType">bool</span><span class="doxyHighlight"> PreserveLCSSA, <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp;LVMap) &#123;</span></CodeLine>
<Link id="l00917" /><CodeLine lineNumber="917"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(PeelCount &gt; 0 &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Attempt to peel out zero iterations?&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00918" /><CodeLine lineNumber="918"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/#a3aea1e78510aa7469457aade10808e51">canPeel</a>(L) &amp;&amp; </span><span class="doxyHighlightStringLiteral">&quot;Attempt to peel a loop which is not peelable?&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l00919" /><CodeLine lineNumber="919"></CodeLine>
<Link id="l00920" /><CodeLine lineNumber="920"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/loopblocksdfs">LoopBlocksDFS</a> LoopBlocks(L);</span></CodeLine>
<Link id="l00921" /><CodeLine lineNumber="921"><span class="doxyHighlight">  LoopBlocks.<a href="/docs/api/classes/llvm/loopblocksdfs/#adc85a5f08fb0f5dc3e053975995c9d29">perform</a>(LI);</span></CodeLine>
<Link id="l00922" /><CodeLine lineNumber="922"></CodeLine>
<Link id="l00923" /><CodeLine lineNumber="923"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Header = L-&gt;getHeader();</span></CodeLine>
<Link id="l00924" /><CodeLine lineNumber="924"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;PreHeader = L-&gt;getLoopPreheader();</span></CodeLine>
<Link id="l00925" /><CodeLine lineNumber="925"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Latch = L-&gt;getLoopLatch();</span></CodeLine>
<Link id="l00926" /><CodeLine lineNumber="926"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;std::pair&lt;BasicBlock &#42;, BasicBlock &#42;&gt;</a>, 4&gt; ExitEdges;</span></CodeLine>
<Link id="l00927" /><CodeLine lineNumber="927"><span class="doxyHighlight">  L-&gt;getExitEdges(ExitEdges);</span></CodeLine>
<Link id="l00928" /><CodeLine lineNumber="928"></CodeLine>
<Link id="l00929" /><CodeLine lineNumber="929"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Remember dominators of blocks we might reach through exits to change them</span></CodeLine>
<Link id="l00930" /><CodeLine lineNumber="930"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// later. Immediate dominator of such block might change, because we add more</span></CodeLine>
<Link id="l00931" /><CodeLine lineNumber="931"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// routes which can lead to the exit: we can reach it from the peeled</span></CodeLine>
<Link id="l00932" /><CodeLine lineNumber="932"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// iterations too.</span></CodeLine>
<Link id="l00933" /><CodeLine lineNumber="933"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/densemap">DenseMap&lt;BasicBlock &#42;, BasicBlock &#42;&gt;</a> NonLoopBlocksIDom;</span></CodeLine>
<Link id="l00934" /><CodeLine lineNumber="934"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;BB : L-&gt;blocks()) &#123;</span></CodeLine>
<Link id="l00935" /><CodeLine lineNumber="935"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;BBDomNode = DT.<a href="/docs/api/classes/llvm/dominatortreebase/#ad8295b9b507d1d847cd46856f8255eab">getNode</a>(BB);</span></CodeLine>
<Link id="l00936" /><CodeLine lineNumber="936"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 16&gt;</a> ChildrenToUpdate;</span></CodeLine>
<Link id="l00937" /><CodeLine lineNumber="937"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;ChildDomNode : BBDomNode-&gt;children()) &#123;</span></CodeLine>
<Link id="l00938" /><CodeLine lineNumber="938"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;ChildBB = ChildDomNode-&gt;getBlock();</span></CodeLine>
<Link id="l00939" /><CodeLine lineNumber="939"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (!L-&gt;contains(ChildBB))</span></CodeLine>
<Link id="l00940" /><CodeLine lineNumber="940"><span class="doxyHighlight">        ChildrenToUpdate.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(ChildBB);</span></CodeLine>
<Link id="l00941" /><CodeLine lineNumber="941"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l00942" /><CodeLine lineNumber="942"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// The new idom of the block will be the nearest common dominator</span></CodeLine>
<Link id="l00943" /><CodeLine lineNumber="943"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// of all copies of the previous idom. This is equivalent to the</span></CodeLine>
<Link id="l00944" /><CodeLine lineNumber="944"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// nearest common dominator of the previous idom and the first latch,</span></CodeLine>
<Link id="l00945" /><CodeLine lineNumber="945"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// which dominates all copies of the previous idom.</span></CodeLine>
<Link id="l00946" /><CodeLine lineNumber="946"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewIDom = DT.<a href="/docs/api/classes/llvm/dominatortree/#a2ec50ab2c78eff965caf3da71cd08be4">findNearestCommonDominator</a>(BB, Latch);</span></CodeLine>
<Link id="l00947" /><CodeLine lineNumber="947"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;ChildBB : ChildrenToUpdate)</span></CodeLine>
<Link id="l00948" /><CodeLine lineNumber="948"><span class="doxyHighlight">      NonLoopBlocksIDom&#91;ChildBB&#93; = NewIDom;</span></CodeLine>
<Link id="l00949" /><CodeLine lineNumber="949"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l00950" /><CodeLine lineNumber="950"></CodeLine>
<Link id="l00951" /><CodeLine lineNumber="951"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = Header-&gt;getParent();</span></CodeLine>
<Link id="l00952" /><CodeLine lineNumber="952"></CodeLine>
<Link id="l00953" /><CodeLine lineNumber="953"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Set up all the necessary basic blocks. It is convenient to split the</span></CodeLine>
<Link id="l00954" /><CodeLine lineNumber="954"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// preheader into 3 parts - two blocks to anchor the peeled copy of the loop</span></CodeLine>
<Link id="l00955" /><CodeLine lineNumber="955"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// body, and a new preheader for the &quot;real&quot; loop.</span></CodeLine>
<Link id="l00956" /><CodeLine lineNumber="956"></CodeLine>
<Link id="l00957" /><CodeLine lineNumber="957"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Peeling the first iteration transforms.</span></CodeLine>
<Link id="l00958" /><CodeLine lineNumber="958"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00959" /><CodeLine lineNumber="959"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// PreHeader:</span></CodeLine>
<Link id="l00960" /><CodeLine lineNumber="960"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// ...</span></CodeLine>
<Link id="l00961" /><CodeLine lineNumber="961"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Header:</span></CodeLine>
<Link id="l00962" /><CodeLine lineNumber="962"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   LoopBody</span></CodeLine>
<Link id="l00963" /><CodeLine lineNumber="963"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   If (cond) goto Header</span></CodeLine>
<Link id="l00964" /><CodeLine lineNumber="964"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Exit:</span></CodeLine>
<Link id="l00965" /><CodeLine lineNumber="965"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00966" /><CodeLine lineNumber="966"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// into</span></CodeLine>
<Link id="l00967" /><CodeLine lineNumber="967"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00968" /><CodeLine lineNumber="968"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// InsertTop:</span></CodeLine>
<Link id="l00969" /><CodeLine lineNumber="969"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   LoopBody</span></CodeLine>
<Link id="l00970" /><CodeLine lineNumber="970"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   If (!cond) goto Exit</span></CodeLine>
<Link id="l00971" /><CodeLine lineNumber="971"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// InsertBot:</span></CodeLine>
<Link id="l00972" /><CodeLine lineNumber="972"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// NewPreHeader:</span></CodeLine>
<Link id="l00973" /><CodeLine lineNumber="973"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// ...</span></CodeLine>
<Link id="l00974" /><CodeLine lineNumber="974"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Header:</span></CodeLine>
<Link id="l00975" /><CodeLine lineNumber="975"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  LoopBody</span></CodeLine>
<Link id="l00976" /><CodeLine lineNumber="976"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  If (cond) goto Header</span></CodeLine>
<Link id="l00977" /><CodeLine lineNumber="977"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Exit:</span></CodeLine>
<Link id="l00978" /><CodeLine lineNumber="978"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00979" /><CodeLine lineNumber="979"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Each following iteration will split the current bottom anchor in two,</span></CodeLine>
<Link id="l00980" /><CodeLine lineNumber="980"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// and put the new copy of the loop body between these two blocks. That is,</span></CodeLine>
<Link id="l00981" /><CodeLine lineNumber="981"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// after peeling another iteration from the example above, we&#39;ll split</span></CodeLine>
<Link id="l00982" /><CodeLine lineNumber="982"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// InsertBot, and get:</span></CodeLine>
<Link id="l00983" /><CodeLine lineNumber="983"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//</span></CodeLine>
<Link id="l00984" /><CodeLine lineNumber="984"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// InsertTop:</span></CodeLine>
<Link id="l00985" /><CodeLine lineNumber="985"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   LoopBody</span></CodeLine>
<Link id="l00986" /><CodeLine lineNumber="986"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   If (!cond) goto Exit</span></CodeLine>
<Link id="l00987" /><CodeLine lineNumber="987"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// InsertBot:</span></CodeLine>
<Link id="l00988" /><CodeLine lineNumber="988"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   LoopBody</span></CodeLine>
<Link id="l00989" /><CodeLine lineNumber="989"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//   If (!cond) goto Exit</span></CodeLine>
<Link id="l00990" /><CodeLine lineNumber="990"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// InsertBot.next:</span></CodeLine>
<Link id="l00991" /><CodeLine lineNumber="991"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// NewPreHeader:</span></CodeLine>
<Link id="l00992" /><CodeLine lineNumber="992"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// ...</span></CodeLine>
<Link id="l00993" /><CodeLine lineNumber="993"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Header:</span></CodeLine>
<Link id="l00994" /><CodeLine lineNumber="994"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  LoopBody</span></CodeLine>
<Link id="l00995" /><CodeLine lineNumber="995"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">//  If (cond) goto Header</span></CodeLine>
<Link id="l00996" /><CodeLine lineNumber="996"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Exit:</span></CodeLine>
<Link id="l00997" /><CodeLine lineNumber="997"></CodeLine>
<Link id="l00998" /><CodeLine lineNumber="998"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;InsertTop = <a href="/docs/api/namespaces/llvm/#adf83581f514774264d616eef5706cf6e">SplitEdge</a>(PreHeader, Header, &amp;DT, LI);</span></CodeLine>
<Link id="l00999" /><CodeLine lineNumber="999"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;InsertBot =</span></CodeLine>
<Link id="l01000" /><CodeLine lineNumber="1000"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#ac6c9ffe7979754415f4ca0d677174bc2">SplitBlock</a>(InsertTop, InsertTop-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>(), &amp;DT, LI);</span></CodeLine>
<Link id="l01001" /><CodeLine lineNumber="1001"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewPreHeader =</span></CodeLine>
<Link id="l01002" /><CodeLine lineNumber="1002"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#ac6c9ffe7979754415f4ca0d677174bc2">SplitBlock</a>(InsertBot, InsertBot-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>(), &amp;DT, LI);</span></CodeLine>
<Link id="l01003" /><CodeLine lineNumber="1003"></CodeLine>
<Link id="l01004" /><CodeLine lineNumber="1004"><span class="doxyHighlight">  InsertTop-&gt;<a href="/docs/api/classes/llvm/value/#a35ee267850af7c235474a8c46c7ac5af">setName</a>(Header-&gt;getName() + </span><span class="doxyHighlightStringLiteral">&quot;.peel.begin&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01005" /><CodeLine lineNumber="1005"><span class="doxyHighlight">  InsertBot-&gt;<a href="/docs/api/classes/llvm/value/#a35ee267850af7c235474a8c46c7ac5af">setName</a>(Header-&gt;getName() + </span><span class="doxyHighlightStringLiteral">&quot;.peel.next&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01006" /><CodeLine lineNumber="1006"><span class="doxyHighlight">  NewPreHeader-&gt;<a href="/docs/api/classes/llvm/value/#a35ee267850af7c235474a8c46c7ac5af">setName</a>(PreHeader-&gt;<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>() + </span><span class="doxyHighlightStringLiteral">&quot;.peel.newph&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01007" /><CodeLine lineNumber="1007"></CodeLine>
<Link id="l01008" /><CodeLine lineNumber="1008"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;LatchTerm =</span></CodeLine>
<Link id="l01009" /><CodeLine lineNumber="1009"><span class="doxyHighlight">      <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Instruction&gt;</a>(<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(Latch)-&gt;getTerminator());</span></CodeLine>
<Link id="l01010" /><CodeLine lineNumber="1010"></CodeLine>
<Link id="l01011" /><CodeLine lineNumber="1011"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// If we have branch weight information, we&#39;ll want to update it for the</span></CodeLine>
<Link id="l01012" /><CodeLine lineNumber="1012"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// newly created branches.</span></CodeLine>
<Link id="l01013" /><CodeLine lineNumber="1013"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/densemap">DenseMap&lt;Instruction &#42;, WeightInfo&gt;</a> Weights;</span></CodeLine>
<Link id="l01014" /><CodeLine lineNumber="1014"><span class="doxyHighlight">  <a href="#acd8a7753c2685a14185133433c0bbf26">initBranchWeights</a>(Weights, L);</span></CodeLine>
<Link id="l01015" /><CodeLine lineNumber="1015"></CodeLine>
<Link id="l01016" /><CodeLine lineNumber="1016"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Identify what noalias metadata is inside the loop: if it is inside the</span></CodeLine>
<Link id="l01017" /><CodeLine lineNumber="1017"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// loop, the associated metadata must be cloned for each iteration.</span></CodeLine>
<Link id="l01018" /><CodeLine lineNumber="1018"><span class="doxyHighlight">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MDNode &#42;, 6&gt;</a> LoopLocalNoAliasDeclScopes;</span></CodeLine>
<Link id="l01019" /><CodeLine lineNumber="1019"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#ade9551bcb1121539a279452fec71f9eb">identifyNoAliasScopesToClone</a>(L-&gt;getBlocks(), LoopLocalNoAliasDeclScopes);</span></CodeLine>
<Link id="l01020" /><CodeLine lineNumber="1020"></CodeLine>
<Link id="l01021" /><CodeLine lineNumber="1021"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// For each peeled-off iteration, make a copy of the loop.</span></CodeLine>
<Link id="l01022" /><CodeLine lineNumber="1022"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> Iter = 0; Iter &lt; PeelCount; ++Iter) &#123;</span></CodeLine>
<Link id="l01023" /><CodeLine lineNumber="1023"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 8&gt;</a> NewBlocks;</span></CodeLine>
<Link id="l01024" /><CodeLine lineNumber="1024"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> VMap;</span></CodeLine>
<Link id="l01025" /><CodeLine lineNumber="1025"></CodeLine>
<Link id="l01026" /><CodeLine lineNumber="1026"><span class="doxyHighlight">    <a href="#a8478b291f8a10892334ba0bcf6a18528">cloneLoopBlocks</a>(L, Iter, InsertTop, InsertBot, ExitEdges, NewBlocks,</span></CodeLine>
<Link id="l01027" /><CodeLine lineNumber="1027"><span class="doxyHighlight">                    LoopBlocks, VMap, LVMap, &amp;DT, LI,</span></CodeLine>
<Link id="l01028" /><CodeLine lineNumber="1028"><span class="doxyHighlight">                    LoopLocalNoAliasDeclScopes, &#42;SE);</span></CodeLine>
<Link id="l01029" /><CodeLine lineNumber="1029"></CodeLine>
<Link id="l01030" /><CodeLine lineNumber="1030"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Remap to use values from the current iteration instead of the</span></CodeLine>
<Link id="l01031" /><CodeLine lineNumber="1031"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// previous one.</span></CodeLine>
<Link id="l01032" /><CodeLine lineNumber="1032"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#ab8ec5c940fbc440c992716fbe4a48636">remapInstructionsInBlocks</a>(NewBlocks, VMap);</span></CodeLine>
<Link id="l01033" /><CodeLine lineNumber="1033"></CodeLine>
<Link id="l01034" /><CodeLine lineNumber="1034"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Update IDoms of the blocks reachable through exits.</span></CodeLine>
<Link id="l01035" /><CodeLine lineNumber="1035"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (Iter == 0)</span></CodeLine>
<Link id="l01036" /><CodeLine lineNumber="1036"><span class="doxyHighlight">      </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> BBIDom : NonLoopBlocksIDom)</span></CodeLine>
<Link id="l01037" /><CodeLine lineNumber="1037"><span class="doxyHighlight">        DT.<a href="/docs/api/classes/llvm/dominatortreebase/#a2881c226e1c102190d54c3b664330aba">changeImmediateDominator</a>(BBIDom.first,</span></CodeLine>
<Link id="l01038" /><CodeLine lineNumber="1038"><span class="doxyHighlight">                                     <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(LVMap&#91;BBIDom.second&#93;));</span></CodeLine>
<Link id="l01039" /><CodeLine lineNumber="1039"><span class="doxyHighlightPreprocessor">#ifdef EXPENSIVE&#95;CHECKS</span></CodeLine>
<Link id="l01040" /><CodeLine lineNumber="1040"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(DT.<a href="/docs/api/classes/llvm/dominatortreebase/#a1f08f2925fec05b265e540d29066b9c8">verify</a>(DominatorTree::VerificationLevel::Fast));</span></CodeLine>
<Link id="l01041" /><CodeLine lineNumber="1041"><span class="doxyHighlightPreprocessor">#endif</span></CodeLine>
<Link id="l01042" /><CodeLine lineNumber="1042"></CodeLine>
<Link id="l01043" /><CodeLine lineNumber="1043"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;&#91;Term, Info&#93; : Weights) &#123;</span></CodeLine>
<Link id="l01044" /><CodeLine lineNumber="1044"><span class="doxyHighlight">      </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;TermCopy = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Instruction&gt;</a>(VMap&#91;Term&#93;);</span></CodeLine>
<Link id="l01045" /><CodeLine lineNumber="1045"><span class="doxyHighlight">      <a href="#a070d953c06601ec34680fdc35c867b17">updateBranchWeights</a>(TermCopy, Info);</span></CodeLine>
<Link id="l01046" /><CodeLine lineNumber="1046"><span class="doxyHighlight">    &#125;</span></CodeLine>
<Link id="l01047" /><CodeLine lineNumber="1047"></CodeLine>
<Link id="l01048" /><CodeLine lineNumber="1048"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// Remove Loop metadata from the latch branch instruction</span></CodeLine>
<Link id="l01049" /><CodeLine lineNumber="1049"><span class="doxyHighlight">    </span><span class="doxyHighlightComment">// because it is not the Loop&#39;s latch branch anymore.</span></CodeLine>
<Link id="l01050" /><CodeLine lineNumber="1050"><span class="doxyHighlight">    </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &#42;LatchTermCopy = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Instruction&gt;</a>(VMap&#91;LatchTerm&#93;);</span></CodeLine>
<Link id="l01051" /><CodeLine lineNumber="1051"><span class="doxyHighlight">    LatchTermCopy-&gt;setMetadata(LLVMContext::MD&#95;loop, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01052" /><CodeLine lineNumber="1052"></CodeLine>
<Link id="l01053" /><CodeLine lineNumber="1053"><span class="doxyHighlight">    InsertTop = InsertBot;</span></CodeLine>
<Link id="l01054" /><CodeLine lineNumber="1054"><span class="doxyHighlight">    InsertBot = <a href="/docs/api/namespaces/llvm/#ac6c9ffe7979754415f4ca0d677174bc2">SplitBlock</a>(InsertBot, InsertBot-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>(), &amp;DT, LI);</span></CodeLine>
<Link id="l01055" /><CodeLine lineNumber="1055"><span class="doxyHighlight">    InsertBot-&gt;<a href="/docs/api/classes/llvm/value/#a35ee267850af7c235474a8c46c7ac5af">setName</a>(Header-&gt;getName() + </span><span class="doxyHighlightStringLiteral">&quot;.peel.next&quot;</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01056" /><CodeLine lineNumber="1056"></CodeLine>
<Link id="l01057" /><CodeLine lineNumber="1057"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;splice(InsertTop-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>(), <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, NewBlocks&#91;0&#93;-&gt;getIterator(),</span></CodeLine>
<Link id="l01058" /><CodeLine lineNumber="1058"><span class="doxyHighlight">              <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;end());</span></CodeLine>
<Link id="l01059" /><CodeLine lineNumber="1059"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01060" /><CodeLine lineNumber="1060"></CodeLine>
<Link id="l01061" /><CodeLine lineNumber="1061"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Now adjust the phi nodes in the loop header to get their initial values</span></CodeLine>
<Link id="l01062" /><CodeLine lineNumber="1062"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// from the last peeled-off iteration instead of the preheader.</span></CodeLine>
<Link id="l01063" /><CodeLine lineNumber="1063"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = Header-&gt;begin(); <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;PHINode&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>); ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &#123;</span></CodeLine>
<Link id="l01064" /><CodeLine lineNumber="1064"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a> = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;PHINode&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</span></CodeLine>
<Link id="l01065" /><CodeLine lineNumber="1065"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;NewVal = <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a>-&gt;getIncomingValueForBlock(Latch);</span></CodeLine>
<Link id="l01066" /><CodeLine lineNumber="1066"><span class="doxyHighlight">    <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;LatchInst = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(NewVal);</span></CodeLine>
<Link id="l01067" /><CodeLine lineNumber="1067"><span class="doxyHighlight">    </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (LatchInst &amp;&amp; L-&gt;contains(LatchInst))</span></CodeLine>
<Link id="l01068" /><CodeLine lineNumber="1068"><span class="doxyHighlight">      NewVal = LVMap&#91;LatchInst&#93;;</span></CodeLine>
<Link id="l01069" /><CodeLine lineNumber="1069"></CodeLine>
<Link id="l01070" /><CodeLine lineNumber="1070"><span class="doxyHighlight">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a>-&gt;setIncomingValueForBlock(NewPreHeader, NewVal);</span></CodeLine>
<Link id="l01071" /><CodeLine lineNumber="1071"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01072" /><CodeLine lineNumber="1072"></CodeLine>
<Link id="l01073" /><CodeLine lineNumber="1073"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">for</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">const</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> &amp;&#91;Term, Info&#93; : Weights) &#123;</span></CodeLine>
<Link id="l01074" /><CodeLine lineNumber="1074"><span class="doxyHighlight">    <a href="/docs/api/namespaces/llvm/#a6cf82c052d63a1b464be8e48ff38c48e">setBranchWeights</a>(&#42;Term, Info.Weights, </span><span class="doxyHighlightComment">/&#42;IsExpected=&#42;/</span><span class="doxyHighlightKeyword">false</span><span class="doxyHighlight">);</span></CodeLine>
<Link id="l01075" /><CodeLine lineNumber="1075"><span class="doxyHighlight">  &#125;</span></CodeLine>
<Link id="l01076" /><CodeLine lineNumber="1076"></CodeLine>
<Link id="l01077" /><CodeLine lineNumber="1077"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Update Metadata for count of peeled off iterations.</span></CodeLine>
<Link id="l01078" /><CodeLine lineNumber="1078"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordType">unsigned</span><span class="doxyHighlight"> AlreadyPeeled = 0;</span></CodeLine>
<Link id="l01079" /><CodeLine lineNumber="1079"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (</span><span class="doxyHighlightKeyword">auto</span><span class="doxyHighlight"> Peeled = <a href="/docs/api/namespaces/llvm/#a9b3cfe2d1603665824476c30368b8eb1">getOptionalIntLoopAttribute</a>(L, <a href="#a7f5685c46cf812c90576046af45cd7fa">PeeledCountMetaData</a>))</span></CodeLine>
<Link id="l01080" /><CodeLine lineNumber="1080"><span class="doxyHighlight">    AlreadyPeeled = &#42;Peeled;</span></CodeLine>
<Link id="l01081" /><CodeLine lineNumber="1081"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a55c9054d63d1c6a39e9c09ba13a482fa">addStringMetadataToLoop</a>(L, <a href="#a7f5685c46cf812c90576046af45cd7fa">PeeledCountMetaData</a>, AlreadyPeeled + PeelCount);</span></CodeLine>
<Link id="l01082" /><CodeLine lineNumber="1082"></CodeLine>
<Link id="l01083" /><CodeLine lineNumber="1083"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">if</span><span class="doxyHighlight"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ParentLoop = L-&gt;getParentLoop())</span></CodeLine>
<Link id="l01084" /><CodeLine lineNumber="1084"><span class="doxyHighlight">    L = ParentLoop;</span></CodeLine>
<Link id="l01085" /><CodeLine lineNumber="1085"></CodeLine>
<Link id="l01086" /><CodeLine lineNumber="1086"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// We modified the loop, update SE.</span></CodeLine>
<Link id="l01087" /><CodeLine lineNumber="1087"><span class="doxyHighlight">  SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a7d5bfa1ac3c7c096af6b26fb95cd699d">forgetTopmostLoop</a>(L);</span></CodeLine>
<Link id="l01088" /><CodeLine lineNumber="1088"><span class="doxyHighlight">  SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a830ba09d5969cd66878b05c17fdf66b6">forgetBlockAndLoopDispositions</a>();</span></CodeLine>
<Link id="l01089" /><CodeLine lineNumber="1089"></CodeLine>
<Link id="l01090" /><CodeLine lineNumber="1090"><span class="doxyHighlightPreprocessor">#ifdef EXPENSIVE&#95;CHECKS</span></CodeLine>
<Link id="l01091" /><CodeLine lineNumber="1091"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// Finally DomtTree must be correct.</span></CodeLine>
<Link id="l01092" /><CodeLine lineNumber="1092"><span class="doxyHighlight">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(DT.<a href="/docs/api/classes/llvm/dominatortreebase/#a1f08f2925fec05b265e540d29066b9c8">verify</a>(DominatorTree::VerificationLevel::Fast));</span></CodeLine>
<Link id="l01093" /><CodeLine lineNumber="1093"><span class="doxyHighlightPreprocessor">#endif</span></CodeLine>
<Link id="l01094" /><CodeLine lineNumber="1094"></CodeLine>
<Link id="l01095" /><CodeLine lineNumber="1095"><span class="doxyHighlight">  </span><span class="doxyHighlightComment">// FIXME: Incrementally update loop-simplify</span></CodeLine>
<Link id="l01096" /><CodeLine lineNumber="1096"><span class="doxyHighlight">  <a href="/docs/api/namespaces/llvm/#a0083a69883e0f97e111dbff064c60f42">simplifyLoop</a>(L, &amp;DT, LI, SE, AC, </span><span class="doxyHighlightKeyword">nullptr</span><span class="doxyHighlight">, PreserveLCSSA);</span></CodeLine>
<Link id="l01097" /><CodeLine lineNumber="1097"></CodeLine>
<Link id="l01098" /><CodeLine lineNumber="1098"><span class="doxyHighlight">  NumPeeled++;</span></CodeLine>
<Link id="l01099" /><CodeLine lineNumber="1099"></CodeLine>
<Link id="l01100" /><CodeLine lineNumber="1100"><span class="doxyHighlight">  </span><span class="doxyHighlightKeywordFlow">return</span><span class="doxyHighlight"> </span><span class="doxyHighlightKeyword">true</span><span class="doxyHighlight">;</span></CodeLine>
<Link id="l01101" /><CodeLine lineNumber="1101"><span class="doxyHighlight">&#125;</span></CodeLine>

</ProgramListing>


</DoxygenPage>
