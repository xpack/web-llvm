---

# DO NOT EDIT!
# Automatically generated via docusaurus-plugin-doxygen by Doxygen.

slug: /api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp
custom_edit_url: null
keywords:
  - doxygen
  - reference
  - file

---

import Link from '@docusaurus/Link'

import CodeLine from '@xpack/docusaurus-plugin-doxygen/components/CodeLine'
import DoxygenPage from '@xpack/docusaurus-plugin-doxygen/components/DoxygenPage'
import Highlight from '@xpack/docusaurus-plugin-doxygen/components/Highlight'
import IncludesList from '@xpack/docusaurus-plugin-doxygen/components/IncludesList'
import IncludesListItem from '@xpack/docusaurus-plugin-doxygen/components/IncludesListItem'
import MemberDefinition from '@xpack/docusaurus-plugin-doxygen/components/MemberDefinition'
import MembersIndex from '@xpack/docusaurus-plugin-doxygen/components/MembersIndex'
import MembersIndexItem from '@xpack/docusaurus-plugin-doxygen/components/MembersIndexItem'
import ParametersList from '@xpack/docusaurus-plugin-doxygen/components/ParametersList'
import ParametersListItem from '@xpack/docusaurus-plugin-doxygen/components/ParametersListItem'
import ProgramListing from '@xpack/docusaurus-plugin-doxygen/components/ProgramListing'
import SectionDefinition from '@xpack/docusaurus-plugin-doxygen/components/SectionDefinition'

import pluginConfig from '@site/docusaurus-plugin-doxygen-config.json'

# The `LoopPeel.cpp` File Reference

<DoxygenPage pluginConfig={pluginConfig}>



## Included Headers

<IncludesList>
<IncludesListItem
  filePath="llvm/Transforms/Utils/LoopPeel.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/looppeel-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/DenseMap.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/densemap-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/SmallVector.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/smallvector-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/ADT/Statistic.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/Loads.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/loads-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/LoopInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/loopinfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/LoopIterator.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/loopiterator-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/ScalarEvolution.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/scalarevolution-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/ScalarEvolutionExpressions.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/scalarevolutionexpressions-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Analysis/TargetTransformInfo.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/analysis/targettransforminfo-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/BasicBlock.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/basicblock-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Dominators.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/dominators-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Function.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/function-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/InstrTypes.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/instrtypes-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Instruction.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/instruction-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/Instructions.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/instructions-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/LLVMContext.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/llvmcontext-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/MDBuilder.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/mdbuilder-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/PatternMatch.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/patternmatch-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/IR/ProfDataUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/ir/profdatautils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/Casting.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/casting-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/CommandLine.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/Debug.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/debug-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Support/raw_ostream.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/support/raw-ostream-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/BasicBlockUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/basicblockutils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/Cloning.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/cloning-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/LoopSimplify.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/loopsimplify-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/LoopUtils.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/looputils-h"
  isLocal="true" />
<IncludesListItem
  filePath="llvm/Transforms/Utils/ValueMapper.h"
  permalink="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/valuemapper-h"
  isLocal="true" />
<IncludesListItem
  filePath="algorithm"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="cassert"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="cstdint"
  permalink=""
  isLocal="false" />
<IncludesListItem
  filePath="optional"
  permalink=""
  isLocal="false" />
</IncludesList>

## Namespaces Index

<MembersIndex>

<MembersIndexItem
  type="namespace"
  name={<><a href="/docs/api/namespaces/anonymous-looppeel-cpp-">anonymous&#123;LoopPeel.cpp&#125;</a></>}>
</MembersIndexItem>

</MembersIndex>

## Classes Index

<MembersIndex>

<MembersIndexItem
  type="class"
  name={<><a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer">PhiAnalyzer</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type="struct"
  name={<><a href="/docs/api/structs/weightinfo">WeightInfo</a></>}>
</MembersIndexItem>

</MembersIndex>

## Functions Index

<MembersIndex>

<MembersIndexItem
  type="void"
  name={<><a href="#a8478b291f8a10892334ba0bcf6a18528">cloneLoopBlocks</a> (Loop &#42;L, unsigned IterNumber, BasicBlock &#42;InsertTop, BasicBlock &#42;InsertBot, SmallVectorImpl&lt; std::pair&lt; BasicBlock &#42;, BasicBlock &#42; &gt; &gt; &amp;ExitEdges, SmallVectorImpl&lt; BasicBlock &#42; &gt; &amp;NewBlocks, LoopBlocksDFS &amp;LoopBlocks, ValueToValueMapTy &amp;VMap, ValueToValueMapTy &amp;LVMap, DominatorTree &#42;DT, LoopInfo &#42;LI, ArrayRef&lt; MDNode &#42; &gt; LoopLocalNoAliasDeclScopes, ScalarEvolution &amp;SE)</>}>
Clones the body of the loop L, putting it between <code>InsertTop</code> and <code>InsertBot</code>. <a href="#a8478b291f8a10892334ba0bcf6a18528">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="unsigned"
  name={<><a href="#a7098623cafc05376a44b27d202b03372">countToEliminateCompares</a> (Loop &amp;L, unsigned MaxPeelCount, ScalarEvolution &amp;SE)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#acd8a7753c2685a14185133433c0bbf26">initBranchWeights</a> (DenseMap&lt; Instruction &#42;, WeightInfo &gt; &amp;WeightInfos, Loop &#42;L)</>}>
Initialize the weights for all exiting blocks. <a href="#acd8a7753c2685a14185133433c0bbf26">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="unsigned"
  name={<><a href="#aaa1d9cfaf2d4ef4eca30ce71eb8c3a89">peelToTurnInvariantLoadsDerefencebale</a> (Loop &amp;L, DominatorTree &amp;DT, AssumptionCache &#42;AC)</>}>
</MembersIndexItem>

<MembersIndexItem
  name={<><a href="#ad7e9e8d290525be96b07046de14b8540">STATISTIC</a> (NumPeeled, &quot;Number of loops peeled&quot;)</>}>
</MembersIndexItem>

<MembersIndexItem
  type="void"
  name={<><a href="#a070d953c06601ec34680fdc35c867b17">updateBranchWeights</a> (Instruction &#42;Term, WeightInfo &amp;Info)</>}>
Update the branch weights of an exiting block of a peeled-off loop iteration. <a href="#a070d953c06601ec34680fdc35c867b17">More...</a>
</MembersIndexItem>

<MembersIndexItem
  type="bool"
  name={<><a href="#a7d391dbabb8fc073db875548184a768d">violatesLegacyMultiExitLoopCheck</a> (Loop &#42;L)</>}>
This &quot;heuristic&quot; exactly matches implicit behavior which used to exist inside getLoopEstimatedTripCount. <a href="#a7d391dbabb8fc073db875548184a768d">More...</a>
</MembersIndexItem>

</MembersIndex>

## Variables Index

<MembersIndex>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a354acc6ff0fdfde87ae2eb07c6127620">DisableAdvancedPeeling</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/files/lib/lib/target/lib/target/aarch64/aarch64promoteconstant-cpp/#a90f8350fecae261c25be85d38b451bff">const</a> char &#42;</>}
  name={<><a href="#a7f5685c46cf812c90576046af45cd7fa">PeeledCountMetaData</a> = &quot;llvm.loop.peeled.count&quot;</>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#aa4d9cb6aeac6c6254d62eeb6c4b662ee">UnrollAllowLoopNestsPeeling</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; bool &gt;</>}
  name={<><a href="#a626a61b9d8aa04db77aaff8e96059f93">UnrollAllowPeeling</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#a6383b9c934edc393f9e9f3fd992559aa">UnrollForcePeelCount</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#aa9badf8f59af8beee7f66a5252019f70">UnrollPeelCount</a></>}>
</MembersIndexItem>

<MembersIndexItem
  type={<><a href="/docs/api/classes/llvm/cl/opt">cl::opt</a>&lt; unsigned &gt;</>}
  name={<><a href="#a36a7dd364657e3ef9947efb9224aaca4">UnrollPeelMaxCount</a></>}>
</MembersIndexItem>

</MembersIndex>

## Defines Index

<MembersIndex>

<MembersIndexItem
  type="#define"
  name={<><a href="#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG&#95;TYPE</a>&nbsp;&nbsp;&nbsp;&quot;loop-peel&quot;</>}>
</MembersIndexItem>

</MembersIndex>


<SectionDefinition>

## Functions

### cloneLoopBlocks() {#a8478b291f8a10892334ba0bcf6a18528}

<MemberDefinition
  prototype={<>static void cloneLoopBlocks (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42; L, unsigned IterNumber, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; InsertTop, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; InsertBot, <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt; std::pair&lt; <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; &gt; &gt; &amp; ExitEdges, <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt; <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42; &gt; &amp; NewBlocks, <a href="/docs/api/classes/llvm/loopblocksdfs">LoopBlocksDFS</a> &amp; LoopBlocks, <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp; VMap, <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp; LVMap, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &#42; DT, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &#42; LI, <a href="/docs/api/classes/llvm/arrayref">ArrayRef</a>&lt; <a href="/docs/api/classes/llvm/mdnode">MDNode</a> &#42; &gt; LoopLocalNoAliasDeclScopes, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &amp; SE)</>}
  labels = {["static"]}>
Clones the body of the loop L, putting it between <code>InsertTop</code> and <code>InsertBot</code>.

<ParametersList title="Parameters">
<ParametersListItem name="IterNumber">The serial number of the iteration currently being peeled off.</ParametersListItem>
<ParametersListItem name="ExitEdges">The exit edges of the original loop.</ParametersListItem>
<ParametersListItem name="[out] NewBlocks">A list of the blocks in the newly created clone</ParametersListItem>
<ParametersListItem name="[out] VMap">The value map between the loop and the new clone.</ParametersListItem>
<ParametersListItem name="LoopBlocks">A helper for DFS-traversal of the loop.</ParametersListItem>
<ParametersListItem name="LVMap">A value-map that maps instructions from the original loop to instructions in the last peeled-off iteration.</ParametersListItem>
</ParametersList>

Definition at line <a href="#l00748">748</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### countToEliminateCompares() {#a7098623cafc05376a44b27d202b03372}

<MemberDefinition
  prototype={<>static unsigned countToEliminateCompares (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, unsigned MaxPeelCount, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &amp; SE)</>}
  labels = {["static"]}>

Definition at line <a href="#l00341">341</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### initBranchWeights() {#acd8a7753c2685a14185133433c0bbf26}

<MemberDefinition
  prototype={<>static void initBranchWeights (<a href="/docs/api/classes/llvm/densemap">DenseMap</a>&lt; <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;, <a href="/docs/api/structs/weightinfo">WeightInfo</a> &gt; &amp; WeightInfos, <a href="/docs/api/classes/llvm/loop">Loop</a> &#42; L)</>}
  labels = {["static"]}>
Initialize the weights for all exiting blocks.

Definition at line <a href="#l00695">695</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### peelToTurnInvariantLoadsDerefencebale() {#aaa1d9cfaf2d4ef4eca30ce71eb8c3a89}

<MemberDefinition
  prototype={<>static unsigned peelToTurnInvariantLoadsDerefencebale (<a href="/docs/api/classes/llvm/loop">Loop</a> &amp; L, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp; DT, <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &#42; AC)</>}
  labels = {["static"]}>

Definition at line <a href="#l00274">274</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### STATISTIC() {#ad7e9e8d290525be96b07046de14b8540}

<MemberDefinition
  prototype={<>STATISTIC (NumPeeled, &quot;Number of <a href="/docs/api/files/lib/lib/analysis/loopinfo-cpp/#a49ae40a9c91d665793aaed656c26ca30">loops</a> peeled&quot;)</>}>

Definition at line <a href="#l00051">51</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### updateBranchWeights() {#a070d953c06601ec34680fdc35c867b17}

<MemberDefinition
  prototype={<>static void updateBranchWeights (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42; Term, <a href="/docs/api/structs/weightinfo">WeightInfo</a> &amp; Info)</>}
  labels = {["static"]}>
Update the branch weights of an exiting block of a peeled-off loop iteration.

Let F is a weight of the edge to continue (fallthrough) into the loop. Let E is a weight of the edge to an exit. F/(F+E) is a probability to go to loop and E/(F+E) is a probability to go to exit. Then, Estimated ExitCount = F / E. For I-th (counting from 0) peeled off iteration we set the weights for the peeled exit as (EC - I, 1). It gives us reasonable distribution, The probability to go to exit 1/(EC-I) increases. At the same time the estimated exit count in the remainder loop reduces by I. To avoid dealing with division rounding we can just multiple both part of weights to E and use weight as (F - I &#42; E, E).

Definition at line <a href="#l00680">680</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### violatesLegacyMultiExitLoopCheck() {#a7d391dbabb8fc073db875548184a768d}

<MemberDefinition
  prototype={<>static bool violatesLegacyMultiExitLoopCheck (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42; L)</>}
  labels = {["static"]}>
This &quot;heuristic&quot; exactly matches implicit behavior which used to exist inside getLoopEstimatedTripCount.

It was added here to keep an improvement inside that API from causing peeling to become more aggressive. This should probably be removed.

Definition at line <a href="#l00514">514</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Variables

### DisableAdvancedPeeling {#a354acc6ff0fdfde87ae2eb07c6127620}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; DisableAdvancedPeeling(&quot;disable-advanced-peeling&quot;, cl::init(false), cl::Hidden, cl::desc( &quot;Disable advance peeling. Issues for convergent targets (D134803).&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00075">75</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### PeeledCountMetaData {#a7f5685c46cf812c90576046af45cd7fa}

<MemberDefinition
  prototype={<>const char&#42; PeeledCountMetaData = &quot;llvm.loop.peeled.count&quot;</>}
  labels = {["static"]}>

Definition at line <a href="#l00080">80</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### UnrollAllowLoopNestsPeeling {#aa4d9cb6aeac6c6254d62eeb6c4b662ee}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; UnrollAllowLoopNestsPeeling(&quot;unroll-allow-loop-nests-peeling&quot;, cl::init(false), cl::Hidden, cl::desc(&quot;Allows loop nests to be peeled.&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00063">63</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### UnrollAllowPeeling {#a626a61b9d8aa04db77aaff8e96059f93}

<MemberDefinition
  prototype={<>cl::opt&lt; bool &gt; UnrollAllowPeeling(&quot;unroll-allow-peeling&quot;, cl::init(true), cl::Hidden, cl::desc(&quot;Allows loops to be peeled when the dynamic &quot; &quot;trip count is known to be low.&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00058">58</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### UnrollForcePeelCount {#a6383b9c934edc393f9e9f3fd992559aa}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; UnrollForcePeelCount(&quot;unroll-force-peel-count&quot;, cl::init(0), cl::Hidden, cl::desc(&quot;Force a peel count regardless of profiling information.&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00071">71</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### UnrollPeelCount {#aa9badf8f59af8beee7f66a5252019f70}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; UnrollPeelCount(&quot;unroll-peel-count&quot;, cl::Hidden, cl::desc(&quot;Set the unroll peeling count, for testing purposes&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00053">53</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

### UnrollPeelMaxCount {#a36a7dd364657e3ef9947efb9224aaca4}

<MemberDefinition
  prototype={<>cl::opt&lt; unsigned &gt; UnrollPeelMaxCount(&quot;unroll-peel-max-count&quot;, cl::init(7), cl::Hidden, cl::desc(&quot;Max average trip count which will cause loop peeling.&quot;))</>}
  labels = {["static"]}>

Definition at line <a href="#l00067">67</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

</SectionDefinition>

<SectionDefinition>

## Defines

### DEBUG&#95;TYPE {#ad78e062f62e0d6e453941fb4ca843e4d}

<MemberDefinition
  prototype={<>#define DEBUG&#95;TYPE&nbsp;&nbsp;&nbsp;&quot;loop-peel&quot;</>}>

Definition at line <a href="#l00049">49</a> of file <a href="/docs/api/files/lib/lib/transforms/lib/transforms/utils/looppeel-cpp">LoopPeel.cpp</a>.
</MemberDefinition>

</SectionDefinition>

## File Listing

The file content with the documentation metadata removed is:

<ProgramListing>

<Link id="l00001" /><CodeLine lineNumber="1"><Highlight kind="comment">//===- LoopPeel.cpp -------------------------------------------------------===//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00002" /><CodeLine lineNumber="2"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00003" /><CodeLine lineNumber="3"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00004" /><CodeLine lineNumber="4"><Highlight kind="normal"></Highlight><Highlight kind="comment">// See https://llvm.org/LICENSE.txt for license information.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00005" /><CodeLine lineNumber="5"><Highlight kind="normal"></Highlight><Highlight kind="comment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00006" /><CodeLine lineNumber="6"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00007" /><CodeLine lineNumber="7"><Highlight kind="normal"></Highlight><Highlight kind="comment">//===----------------------------------------------------------------------===//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00008" /><CodeLine lineNumber="8"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00009" /><CodeLine lineNumber="9"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Loop Peeling Utilities.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00010" /><CodeLine lineNumber="10"><Highlight kind="normal"></Highlight><Highlight kind="comment">//===----------------------------------------------------------------------===//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00011" /><CodeLine lineNumber="11"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00012" /><CodeLine lineNumber="12"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/looppeel-h">llvm/Transforms/Utils/LoopPeel.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00013" /><CodeLine lineNumber="13"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/densemap-h">llvm/ADT/DenseMap.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00014" /><CodeLine lineNumber="14"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/smallvector-h">llvm/ADT/SmallVector.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00015" /><CodeLine lineNumber="15"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h">llvm/ADT/Statistic.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00016" /><CodeLine lineNumber="16"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/loads-h">llvm/Analysis/Loads.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00017" /><CodeLine lineNumber="17"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/loopinfo-h">llvm/Analysis/LoopInfo.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00018" /><CodeLine lineNumber="18"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/loopiterator-h">llvm/Analysis/LoopIterator.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00019" /><CodeLine lineNumber="19"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/scalarevolution-h">llvm/Analysis/ScalarEvolution.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00020" /><CodeLine lineNumber="20"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/scalarevolutionexpressions-h">llvm/Analysis/ScalarEvolutionExpressions.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00021" /><CodeLine lineNumber="21"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/analysis/targettransforminfo-h">llvm/Analysis/TargetTransformInfo.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00022" /><CodeLine lineNumber="22"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/basicblock-h">llvm/IR/BasicBlock.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00023" /><CodeLine lineNumber="23"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/dominators-h">llvm/IR/Dominators.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00024" /><CodeLine lineNumber="24"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/function-h">llvm/IR/Function.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00025" /><CodeLine lineNumber="25"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/instrtypes-h">llvm/IR/InstrTypes.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00026" /><CodeLine lineNumber="26"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/instruction-h">llvm/IR/Instruction.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00027" /><CodeLine lineNumber="27"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/instructions-h">llvm/IR/Instructions.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00028" /><CodeLine lineNumber="28"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/llvmcontext-h">llvm/IR/LLVMContext.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00029" /><CodeLine lineNumber="29"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/mdbuilder-h">llvm/IR/MDBuilder.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00030" /><CodeLine lineNumber="30"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/patternmatch-h">llvm/IR/PatternMatch.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00031" /><CodeLine lineNumber="31"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/ir/profdatautils-h">llvm/IR/ProfDataUtils.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00032" /><CodeLine lineNumber="32"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/casting-h">llvm/Support/Casting.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00033" /><CodeLine lineNumber="33"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/commandline-h">llvm/Support/CommandLine.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00034" /><CodeLine lineNumber="34"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h">llvm/Support/Debug.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00035" /><CodeLine lineNumber="35"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/support/raw-ostream-h">llvm/Support/raw&#95;ostream.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00036" /><CodeLine lineNumber="36"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/basicblockutils-h">llvm/Transforms/Utils/BasicBlockUtils.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00037" /><CodeLine lineNumber="37"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/cloning-h">llvm/Transforms/Utils/Cloning.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00038" /><CodeLine lineNumber="38"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/loopsimplify-h">llvm/Transforms/Utils/LoopSimplify.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00039" /><CodeLine lineNumber="39"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/looputils-h">llvm/Transforms/Utils/LoopUtils.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00040" /><CodeLine lineNumber="40"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &quot;<a href="/docs/api/files/include/include/llvm/include/llvm/transforms/include/llvm/transforms/utils/valuemapper-h">llvm/Transforms/Utils/ValueMapper.h</a>&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00041" /><CodeLine lineNumber="41"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &lt;algorithm&gt;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00042" /><CodeLine lineNumber="42"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &lt;cassert&gt;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00043" /><CodeLine lineNumber="43"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &lt;cstdint&gt;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00044" /><CodeLine lineNumber="44"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#include &lt;optional&gt;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00045" /><CodeLine lineNumber="45"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00046" /><CodeLine lineNumber="46"><Highlight kind="normal"></Highlight><Highlight kind="keyword">using namespace </Highlight><Highlight kind="normal"><a href="/docs/api/namespaces/llvm">llvm</a>;</Highlight></CodeLine>
<Link id="l00047" /><CodeLine lineNumber="47"><Highlight kind="normal"></Highlight><Highlight kind="keyword">using namespace </Highlight><Highlight kind="normal"><a href="/docs/api/namespaces/llvm/patternmatch">llvm::PatternMatch</a>;</Highlight></CodeLine>
<Link id="l00048" /><CodeLine lineNumber="48"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00049" /><CodeLine lineNumber="49" lineLink="#ad78e062f62e0d6e453941fb4ca843e4d"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#define DEBUG&#95;TYPE &quot;loop-peel&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00050" /><CodeLine lineNumber="50"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00051" /><CodeLine lineNumber="51" lineLink="#ad7e9e8d290525be96b07046de14b8540"><Highlight kind="normal"><a href="/docs/api/files/include/include/llvm/include/llvm/adt/statistic-h/#ad6117415b93e5675d5a6c8e1855b3b2f">STATISTIC</a>(NumPeeled, </Highlight><Highlight kind="stringliteral">&quot;Number of loops peeled&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00052" /><CodeLine lineNumber="52"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00053" /><CodeLine lineNumber="53" lineLink="#aa9badf8f59af8beee7f66a5252019f70"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="#aa9badf8f59af8beee7f66a5252019f70">UnrollPeelCount</a>(</Highlight></CodeLine>
<Link id="l00054" /><CodeLine lineNumber="54"><Highlight kind="normal">    </Highlight><Highlight kind="stringliteral">&quot;unroll-peel-count&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</Highlight></CodeLine>
<Link id="l00055" /><CodeLine lineNumber="55"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Set the unroll peeling count, for testing purposes&quot;</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00056" /><CodeLine lineNumber="56"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00057" /><CodeLine lineNumber="57"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a></Highlight></CodeLine>
<Link id="l00058" /><CodeLine lineNumber="58" lineLink="#a626a61b9d8aa04db77aaff8e96059f93"><Highlight kind="normal">    <a href="#a626a61b9d8aa04db77aaff8e96059f93">UnrollAllowPeeling</a>(</Highlight><Highlight kind="stringliteral">&quot;unroll-allow-peeling&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</Highlight></CodeLine>
<Link id="l00059" /><CodeLine lineNumber="59"><Highlight kind="normal">                       <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Allows loops to be peeled when the dynamic &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00060" /><CodeLine lineNumber="60"><Highlight kind="normal">                                </Highlight><Highlight kind="stringliteral">&quot;trip count is known to be low.&quot;</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00061" /><CodeLine lineNumber="61"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00062" /><CodeLine lineNumber="62"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a></Highlight></CodeLine>
<Link id="l00063" /><CodeLine lineNumber="63" lineLink="#aa4d9cb6aeac6c6254d62eeb6c4b662ee"><Highlight kind="normal">    <a href="#aa4d9cb6aeac6c6254d62eeb6c4b662ee">UnrollAllowLoopNestsPeeling</a>(</Highlight><Highlight kind="stringliteral">&quot;unroll-allow-loop-nests-peeling&quot;</Highlight><Highlight kind="normal">,</Highlight></CodeLine>
<Link id="l00064" /><CodeLine lineNumber="64"><Highlight kind="normal">                                <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</Highlight></CodeLine>
<Link id="l00065" /><CodeLine lineNumber="65"><Highlight kind="normal">                                <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Allows loop nests to be peeled.&quot;</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00066" /><CodeLine lineNumber="66"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00067" /><CodeLine lineNumber="67" lineLink="#a36a7dd364657e3ef9947efb9224aaca4"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="#a36a7dd364657e3ef9947efb9224aaca4">UnrollPeelMaxCount</a>(</Highlight></CodeLine>
<Link id="l00068" /><CodeLine lineNumber="68"><Highlight kind="normal">    </Highlight><Highlight kind="stringliteral">&quot;unroll-peel-max-count&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(7), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</Highlight></CodeLine>
<Link id="l00069" /><CodeLine lineNumber="69"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Max average trip count which will cause loop peeling.&quot;</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00070" /><CodeLine lineNumber="70"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00071" /><CodeLine lineNumber="71" lineLink="#a6383b9c934edc393f9e9f3fd992559aa"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;unsigned&gt;</a> <a href="#a6383b9c934edc393f9e9f3fd992559aa">UnrollForcePeelCount</a>(</Highlight></CodeLine>
<Link id="l00072" /><CodeLine lineNumber="72"><Highlight kind="normal">    </Highlight><Highlight kind="stringliteral">&quot;unroll-force-peel-count&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(0), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</Highlight></CodeLine>
<Link id="l00073" /><CodeLine lineNumber="73"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight><Highlight kind="stringliteral">&quot;Force a peel count regardless of profiling information.&quot;</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00074" /><CodeLine lineNumber="74"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00075" /><CodeLine lineNumber="75" lineLink="#a354acc6ff0fdfde87ae2eb07c6127620"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/cl/opt">cl::opt&lt;bool&gt;</a> <a href="#a354acc6ff0fdfde87ae2eb07c6127620">DisableAdvancedPeeling</a>(</Highlight></CodeLine>
<Link id="l00076" /><CodeLine lineNumber="76"><Highlight kind="normal">    </Highlight><Highlight kind="stringliteral">&quot;disable-advanced-peeling&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/namespaces/llvm/cl/#ac12e6a8f3a1b511f0dee2ed6de0ae806">cl::init</a>(</Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">), <a href="/docs/api/namespaces/llvm/cl/#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</Highlight></CodeLine>
<Link id="l00077" /><CodeLine lineNumber="77"><Highlight kind="normal">    <a href="/docs/api/structs/llvm/cl/desc">cl::desc</a>(</Highlight></CodeLine>
<Link id="l00078" /><CodeLine lineNumber="78"><Highlight kind="normal">        </Highlight><Highlight kind="stringliteral">&quot;Disable advance peeling. Issues for convergent targets (D134803).&quot;</Highlight><Highlight kind="normal">));</Highlight></CodeLine>
<Link id="l00079" /><CodeLine lineNumber="79"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00080" /><CodeLine lineNumber="80" lineLink="#a7f5685c46cf812c90576046af45cd7fa"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">char</Highlight><Highlight kind="normal"> &#42;<a href="#a7f5685c46cf812c90576046af45cd7fa">PeeledCountMetaData</a> = </Highlight><Highlight kind="stringliteral">&quot;llvm.loop.peeled.count&quot;</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00081" /><CodeLine lineNumber="81"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00082" /><CodeLine lineNumber="82"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Check whether we are capable of peeling this loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00083" /><CodeLine lineNumber="83" lineLink="/docs/api/namespaces/llvm/#a3aea1e78510aa7469457aade10808e51"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/#a3aea1e78510aa7469457aade10808e51">llvm::canPeel</a>(</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L) &#123;</Highlight></CodeLine>
<Link id="l00084" /><CodeLine lineNumber="84"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Make sure the loop is in simplified form</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00085" /><CodeLine lineNumber="85"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!L-&gt;isLoopSimplifyForm())</Highlight></CodeLine>
<Link id="l00086" /><CodeLine lineNumber="86"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00087" /><CodeLine lineNumber="87"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="#a354acc6ff0fdfde87ae2eb07c6127620">DisableAdvancedPeeling</a>)</Highlight></CodeLine>
<Link id="l00088" /><CodeLine lineNumber="88"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00089" /><CodeLine lineNumber="89"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00090" /><CodeLine lineNumber="90"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 4&gt;</a> Exits;</Highlight></CodeLine>
<Link id="l00091" /><CodeLine lineNumber="91"><Highlight kind="normal">  L-&gt;getUniqueNonLatchExitBlocks(Exits);</Highlight></CodeLine>
<Link id="l00092" /><CodeLine lineNumber="92"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The latch must either be the only exiting block or all non-latch exit</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00093" /><CodeLine lineNumber="93"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// blocks have either a deopt or unreachable terminator or compose a chain of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00094" /><CodeLine lineNumber="94"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// blocks where the last one is either deopt or unreachable terminated. Both</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00095" /><CodeLine lineNumber="95"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// deopt and unreachable terminators are a strong indication they are not</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00096" /><CodeLine lineNumber="96"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// taken. Note that this is a profitability check, not a legality check. Also</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00097" /><CodeLine lineNumber="97"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// note that LoopPeeling currently can only update the branch weights of latch</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00098" /><CodeLine lineNumber="98"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// blocks and branch weights to blocks with deopt or unreachable do not need</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00099" /><CodeLine lineNumber="99"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// updating.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00100" /><CodeLine lineNumber="100"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/#a0d10fe510ced2849a8074fe81e5d04ce">llvm::all&#95;of</a>(Exits, <a href="/docs/api/namespaces/llvm/#a15055c7e3a33b44c293df24e4ba7bc5e">IsBlockFollowedByDeoptOrUnreachable</a>);</Highlight></CodeLine>
<Link id="l00101" /><CodeLine lineNumber="101"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00102" /><CodeLine lineNumber="102"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00103" /><CodeLine lineNumber="103" lineLink="/docs/api/namespaces/anonymous-looppeel-cpp-"><Highlight kind="normal"></Highlight><Highlight kind="keyword">namespace </Highlight><Highlight kind="normal">&#123;</Highlight></CodeLine>
<Link id="l00104" /><CodeLine lineNumber="104"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00105" /><CodeLine lineNumber="105"><Highlight kind="normal"></Highlight><Highlight kind="comment">// As a loop is peeled, it may be the case that Phi nodes become</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00106" /><CodeLine lineNumber="106"><Highlight kind="normal"></Highlight><Highlight kind="comment">// loop-invariant (ie, known because there is only one choice).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00107" /><CodeLine lineNumber="107"><Highlight kind="normal"></Highlight><Highlight kind="comment">// For example, consider the following function:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00108" /><CodeLine lineNumber="108"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   void g(int);</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00109" /><CodeLine lineNumber="109"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   void binary() &#123;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00110" /><CodeLine lineNumber="110"><Highlight kind="normal"></Highlight><Highlight kind="comment">//     int x = 0;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00111" /><CodeLine lineNumber="111"><Highlight kind="normal"></Highlight><Highlight kind="comment">//     int y = 0;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00112" /><CodeLine lineNumber="112"><Highlight kind="normal"></Highlight><Highlight kind="comment">//     int a = 0;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00113" /><CodeLine lineNumber="113"><Highlight kind="normal"></Highlight><Highlight kind="comment">//     for(int i = 0; i &lt;100000; ++i) &#123;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00114" /><CodeLine lineNumber="114"><Highlight kind="normal"></Highlight><Highlight kind="comment">//       g(x);</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00115" /><CodeLine lineNumber="115"><Highlight kind="normal"></Highlight><Highlight kind="comment">//       x = y;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00116" /><CodeLine lineNumber="116"><Highlight kind="normal"></Highlight><Highlight kind="comment">//       g(a);</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00117" /><CodeLine lineNumber="117"><Highlight kind="normal"></Highlight><Highlight kind="comment">//       y = a + 1;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00118" /><CodeLine lineNumber="118"><Highlight kind="normal"></Highlight><Highlight kind="comment">//       a = 5;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00119" /><CodeLine lineNumber="119"><Highlight kind="normal"></Highlight><Highlight kind="comment">//     &#125;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00120" /><CodeLine lineNumber="120"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   &#125;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00121" /><CodeLine lineNumber="121"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Peeling 3 iterations is beneficial because the values for x, y and a</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00122" /><CodeLine lineNumber="122"><Highlight kind="normal"></Highlight><Highlight kind="comment">// become known.  The IR for this loop looks something like the following:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00123" /><CodeLine lineNumber="123"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00124" /><CodeLine lineNumber="124"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   %i = phi i32 &#91; 0, %entry &#93;, &#91; %inc, %if.end &#93;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00125" /><CodeLine lineNumber="125"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   %a = phi i32 &#91; 0, %entry &#93;, &#91; 5, %if.end &#93;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00126" /><CodeLine lineNumber="126"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   %y = phi i32 &#91; 0, %entry &#93;, &#91; %add, %if.end &#93;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00127" /><CodeLine lineNumber="127"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   %x = phi i32 &#91; 0, %entry &#93;, &#91; %y, %if.end &#93;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00128" /><CodeLine lineNumber="128"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   ...</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00129" /><CodeLine lineNumber="129"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   tail call void @&#95;Z1gi(i32 signext %x)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00130" /><CodeLine lineNumber="130"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   tail call void @&#95;Z1gi(i32 signext %a)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00131" /><CodeLine lineNumber="131"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   %add = add nuw nsw i32 %a, 1</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00132" /><CodeLine lineNumber="132"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   %inc = add nuw nsw i32 %i, 1</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00133" /><CodeLine lineNumber="133"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   %exitcond = icmp eq i32 %inc, 100000</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00134" /><CodeLine lineNumber="134"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   br i1 %exitcond, label %for.cond.cleanup, label %for.body</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00135" /><CodeLine lineNumber="135"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00136" /><CodeLine lineNumber="136"><Highlight kind="normal"></Highlight><Highlight kind="comment">// The arguments for the calls to g will become known after 3 iterations</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00137" /><CodeLine lineNumber="137"><Highlight kind="normal"></Highlight><Highlight kind="comment">// of the loop, because the phi nodes values become known after 3 iterations</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00138" /><CodeLine lineNumber="138"><Highlight kind="normal"></Highlight><Highlight kind="comment">// of the loop (ie, they are known on the 4th iteration, so peel 3 iterations).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00139" /><CodeLine lineNumber="139"><Highlight kind="normal"></Highlight><Highlight kind="comment">// The first iteration has g(0), g(0); the second has g(0), g(5); the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00140" /><CodeLine lineNumber="140"><Highlight kind="normal"></Highlight><Highlight kind="comment">// third has g(1), g(5) and the fourth (and all subsequent) have g(6), g(5).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00141" /><CodeLine lineNumber="141"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Now consider the phi nodes:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00142" /><CodeLine lineNumber="142"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   %a is a phi with constants so it is determined after iteration 1</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00143" /><CodeLine lineNumber="143"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   %y is a phi based on a constant and %a so it is determined on</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00144" /><CodeLine lineNumber="144"><Highlight kind="normal"></Highlight><Highlight kind="comment">//     the iteration after %a is determined, so iteration 2</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00145" /><CodeLine lineNumber="145"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   %x is a phi based on a constant and %y so it is determined on</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00146" /><CodeLine lineNumber="146"><Highlight kind="normal"></Highlight><Highlight kind="comment">//     the iteration after %y, so iteration 3</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00147" /><CodeLine lineNumber="147"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   %i is based on itself (and is an induction variable) so it is</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00148" /><CodeLine lineNumber="148"><Highlight kind="normal"></Highlight><Highlight kind="comment">//     never determined.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00149" /><CodeLine lineNumber="149"><Highlight kind="normal"></Highlight><Highlight kind="comment">// This means that peeling off 3 iterations will result in being able to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00150" /><CodeLine lineNumber="150"><Highlight kind="normal"></Highlight><Highlight kind="comment">// remove the phi nodes for %a, %y, and %x.  The arguments for the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00151" /><CodeLine lineNumber="151"><Highlight kind="normal"></Highlight><Highlight kind="comment">// corresponding calls to g are determined and the code for computing</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00152" /><CodeLine lineNumber="152"><Highlight kind="normal"></Highlight><Highlight kind="comment">// x, y, and a can be removed.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00153" /><CodeLine lineNumber="153"><Highlight kind="normal"></Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00154" /><CodeLine lineNumber="154"><Highlight kind="normal"></Highlight><Highlight kind="comment">// The PhiAnalyzer class calculates how many times a loop should be</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00155" /><CodeLine lineNumber="155"><Highlight kind="normal"></Highlight><Highlight kind="comment">// peeled based on the above analysis of the phi nodes in the loop while</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00156" /><CodeLine lineNumber="156"><Highlight kind="normal"></Highlight><Highlight kind="comment">// respecting the maximum specified.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00157" /><CodeLine lineNumber="157" lineLink="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer"><Highlight kind="normal"></Highlight><Highlight kind="keyword">class </Highlight><Highlight kind="normal"><a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a4e785de5fff2e6dd2024f24318e870ac">PhiAnalyzer</a> &#123;</Highlight></CodeLine>
<Link id="l00158" /><CodeLine lineNumber="158"><Highlight kind="normal"></Highlight><Highlight kind="keyword">public</Highlight><Highlight kind="normal">:</Highlight></CodeLine>
<Link id="l00159" /><CodeLine lineNumber="159"><Highlight kind="normal">  <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a4e785de5fff2e6dd2024f24318e870ac">PhiAnalyzer</a>(</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c">L</a>, </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0">MaxIterations</a>);</Highlight></CodeLine>
<Link id="l00160" /><CodeLine lineNumber="160"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00161" /><CodeLine lineNumber="161"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Calculate the sufficient minimum number of iterations of the loop to peel</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00162" /><CodeLine lineNumber="162"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// such that phi instructions become determined (subject to allowable limits)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00163" /><CodeLine lineNumber="163"><Highlight kind="normal">  std::optional&lt;unsigned&gt; <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#ab8be64c7a0b759236a80e76938e501f0">calculateIterationsToPeel</a>();</Highlight></CodeLine>
<Link id="l00164" /><CodeLine lineNumber="164"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00165" /><CodeLine lineNumber="165"><Highlight kind="normal"></Highlight><Highlight kind="keyword">protected</Highlight><Highlight kind="normal">:</Highlight></CodeLine>
<Link id="l00166" /><CodeLine lineNumber="166" lineLink="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">using </Highlight><Highlight kind="normal"><a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0">PeelCounter</a> = std::optional&lt;unsigned&gt;;</Highlight></CodeLine>
<Link id="l00167" /><CodeLine lineNumber="167" lineLink="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0">PeelCounter</a> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a> = std::nullopt;</Highlight></CodeLine>
<Link id="l00168" /><CodeLine lineNumber="168"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00169" /><CodeLine lineNumber="169"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Add 1 respecting Unknown and return Unknown if result over MaxIterations</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00170" /><CodeLine lineNumber="170" lineLink="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1270c5fbdef252d0b97676feeb269587"><Highlight kind="normal">  <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0">PeelCounter</a> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1270c5fbdef252d0b97676feeb269587">addOne</a>(<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0">PeelCounter</a> PC)</Highlight><Highlight kind="keyword"> const </Highlight><Highlight kind="normal">&#123;</Highlight></CodeLine>
<Link id="l00171" /><CodeLine lineNumber="171"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (PC == <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>)</Highlight></CodeLine>
<Link id="l00172" /><CodeLine lineNumber="172"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>;</Highlight></CodeLine>
<Link id="l00173" /><CodeLine lineNumber="173"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> (&#42;PC + 1 &lt;= <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0">MaxIterations</a>) ? <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0">PeelCounter</a>&#123;&#42;PC + 1&#125; : <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>;</Highlight></CodeLine>
<Link id="l00174" /><CodeLine lineNumber="174"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00175" /><CodeLine lineNumber="175"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00176" /><CodeLine lineNumber="176"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Calculate the number of iterations after which the given value</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00177" /><CodeLine lineNumber="177"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// becomes an invariant.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00178" /><CodeLine lineNumber="178"><Highlight kind="normal">  PeelCounter calculate(</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/value">Value</a> &amp;);</Highlight></CodeLine>
<Link id="l00179" /><CodeLine lineNumber="179"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00180" /><CodeLine lineNumber="180" lineLink="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c">L</a>;</Highlight></CodeLine>
<Link id="l00181" /><CodeLine lineNumber="181" lineLink="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0">MaxIterations</a>;</Highlight></CodeLine>
<Link id="l00182" /><CodeLine lineNumber="182"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00183" /><CodeLine lineNumber="183"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Map of Values to number of iterations to invariance</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00184" /><CodeLine lineNumber="184" lineLink="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1739f186de9b30a666c0340e0eb955af"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smalldensemap">SmallDenseMap&lt;const Value &#42;, PeelCounter&gt;</a> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1739f186de9b30a666c0340e0eb955af">IterationsToInvariance</a>;</Highlight></CodeLine>
<Link id="l00185" /><CodeLine lineNumber="185"><Highlight kind="normal">&#125;;</Highlight></CodeLine>
<Link id="l00186" /><CodeLine lineNumber="186"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00187" /><CodeLine lineNumber="187" lineLink="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a4e785de5fff2e6dd2024f24318e870ac"><Highlight kind="normal"><a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a4e785de5fff2e6dd2024f24318e870ac">PhiAnalyzer::PhiAnalyzer</a>(</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/loop">Loop</a> &amp;<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c">L</a>, </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0">MaxIterations</a>)</Highlight></CodeLine>
<Link id="l00188" /><CodeLine lineNumber="188"><Highlight kind="normal">    : <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c">L</a>(<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c">L</a>), <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0">MaxIterations</a>(<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0">MaxIterations</a>) &#123;</Highlight></CodeLine>
<Link id="l00189" /><CodeLine lineNumber="189"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/#a3aea1e78510aa7469457aade10808e51">canPeel</a>(&amp;<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c">L</a>) &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;loop is not suitable for peeling&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00190" /><CodeLine lineNumber="190"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0">MaxIterations</a> &gt; 0 &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;no peeling is allowed?&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00191" /><CodeLine lineNumber="191"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00192" /><CodeLine lineNumber="192"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00193" /><CodeLine lineNumber="193"><Highlight kind="normal"></Highlight><Highlight kind="comment">// This function calculates the number of iterations after which the value</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00194" /><CodeLine lineNumber="194"><Highlight kind="normal"></Highlight><Highlight kind="comment">// becomes an invariant. The pre-calculated values are memorized in a map.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00195" /><CodeLine lineNumber="195"><Highlight kind="normal"></Highlight><Highlight kind="comment">// N.B. This number will be Unknown or &lt;= MaxIterations.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00196" /><CodeLine lineNumber="196"><Highlight kind="normal"></Highlight><Highlight kind="comment">// The function is calculated according to the following definition:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00197" /><CodeLine lineNumber="197"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Given %x = phi &lt;Inputs from above the loop&gt;, ..., &#91;%y, %back.edge&#93;.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00198" /><CodeLine lineNumber="198"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   F(%x) = G(%y) + 1 (N.B. &#91;MaxIterations | Unknown&#93; + 1 =&gt; Unknown)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00199" /><CodeLine lineNumber="199"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   G(%y) = 0 if %y is a loop invariant</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00200" /><CodeLine lineNumber="200"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   G(%y) = G(%BackEdgeValue) if %y is a phi in the header block</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00201" /><CodeLine lineNumber="201"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   G(%y) = TODO: if %y is an expression based on phis and loop invariants</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00202" /><CodeLine lineNumber="202"><Highlight kind="normal"></Highlight><Highlight kind="comment">//           The example looks like:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00203" /><CodeLine lineNumber="203"><Highlight kind="normal"></Highlight><Highlight kind="comment">//           %x = phi(0, %a) &lt;-- becomes invariant starting from 3rd iteration.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00204" /><CodeLine lineNumber="204"><Highlight kind="normal"></Highlight><Highlight kind="comment">//           %y = phi(0, 5)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00205" /><CodeLine lineNumber="205"><Highlight kind="normal"></Highlight><Highlight kind="comment">//           %a = %y + 1</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00206" /><CodeLine lineNumber="206"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   G(%y) = Unknown otherwise (including phi not in header block)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00207" /><CodeLine lineNumber="207" lineLink="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a9b3f8d5fb39a3e2eb0c8416e2f3e70a2"><Highlight kind="normal"><a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0">PhiAnalyzer::PeelCounter</a> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a9b3f8d5fb39a3e2eb0c8416e2f3e70a2">PhiAnalyzer::calculate</a>(</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/value">Value</a> &amp;V) &#123;</Highlight></CodeLine>
<Link id="l00208" /><CodeLine lineNumber="208"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If we already know the answer, take it from the map.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00209" /><CodeLine lineNumber="209"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Otherwise, place Unknown to map to avoid infinite recursion. Such</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00210" /><CodeLine lineNumber="210"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// cycles can never stop on an invariant.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00211" /><CodeLine lineNumber="211"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>, Inserted&#93; = <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1739f186de9b30a666c0340e0eb955af">IterationsToInvariance</a>.try&#95;emplace(&amp;V, <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>);</Highlight></CodeLine>
<Link id="l00212" /><CodeLine lineNumber="212"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!Inserted)</Highlight></CodeLine>
<Link id="l00213" /><CodeLine lineNumber="213"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;second;</Highlight></CodeLine>
<Link id="l00214" /><CodeLine lineNumber="214"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00215" /><CodeLine lineNumber="215"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c">L</a>.isLoopInvariant(&amp;V))</Highlight></CodeLine>
<Link id="l00216" /><CodeLine lineNumber="216"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Loop invariant so known at start.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00217" /><CodeLine lineNumber="217"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1739f186de9b30a666c0340e0eb955af">IterationsToInvariance</a>&#91;&amp;V&#93; = 0);</Highlight></CodeLine>
<Link id="l00218" /><CodeLine lineNumber="218"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;Phi = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;PHINode&gt;</a>(&amp;V)) &#123;</Highlight></CodeLine>
<Link id="l00219" /><CodeLine lineNumber="219"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Phi-&gt;getParent() != <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c">L</a>.getHeader()) &#123;</Highlight></CodeLine>
<Link id="l00220" /><CodeLine lineNumber="220"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Phi is not in header block so Unknown.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00221" /><CodeLine lineNumber="221"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1739f186de9b30a666c0340e0eb955af">IterationsToInvariance</a>&#91;&amp;V&#93; == <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a> &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;unexpected value saved&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00222" /><CodeLine lineNumber="222"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>;</Highlight></CodeLine>
<Link id="l00223" /><CodeLine lineNumber="223"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00224" /><CodeLine lineNumber="224"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// We need to analyze the input from the back edge and add 1</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00225" /><CodeLine lineNumber="225"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/classes/input">Input</a> = Phi-&gt;getIncomingValueForBlock(<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c">L</a>.getLoopLatch());</Highlight></CodeLine>
<Link id="l00226" /><CodeLine lineNumber="226"><Highlight kind="normal">    <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0">PeelCounter</a> Iterations = <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a9b3f8d5fb39a3e2eb0c8416e2f3e70a2">calculate</a>(&#42;<a href="/docs/api/classes/input">Input</a>);</Highlight></CodeLine>
<Link id="l00227" /><CodeLine lineNumber="227"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1739f186de9b30a666c0340e0eb955af">IterationsToInvariance</a>&#91;<a href="/docs/api/classes/input">Input</a>&#93; == Iterations &amp;&amp;</Highlight></CodeLine>
<Link id="l00228" /><CodeLine lineNumber="228"><Highlight kind="normal">           </Highlight><Highlight kind="stringliteral">&quot;unexpected value saved&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00229" /><CodeLine lineNumber="229"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1739f186de9b30a666c0340e0eb955af">IterationsToInvariance</a>&#91;Phi&#93; = <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1270c5fbdef252d0b97676feeb269587">addOne</a>(Iterations));</Highlight></CodeLine>
<Link id="l00230" /><CodeLine lineNumber="230"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00231" /><CodeLine lineNumber="231"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(&amp;V)) &#123;</Highlight></CodeLine>
<Link id="l00232" /><CodeLine lineNumber="232"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;CmpInst&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) || <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;isBinaryOp()) &#123;</Highlight></CodeLine>
<Link id="l00233" /><CodeLine lineNumber="233"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Binary instructions get the max of the operands.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00234" /><CodeLine lineNumber="234"><Highlight kind="normal">      <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0">PeelCounter</a> LHS = <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a9b3f8d5fb39a3e2eb0c8416e2f3e70a2">calculate</a>(&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOperand(0));</Highlight></CodeLine>
<Link id="l00235" /><CodeLine lineNumber="235"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (LHS == <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>)</Highlight></CodeLine>
<Link id="l00236" /><CodeLine lineNumber="236"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>;</Highlight></CodeLine>
<Link id="l00237" /><CodeLine lineNumber="237"><Highlight kind="normal">      <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0">PeelCounter</a> RHS = <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a9b3f8d5fb39a3e2eb0c8416e2f3e70a2">calculate</a>(&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOperand(1));</Highlight></CodeLine>
<Link id="l00238" /><CodeLine lineNumber="238"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (RHS == <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>)</Highlight></CodeLine>
<Link id="l00239" /><CodeLine lineNumber="239"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>;</Highlight></CodeLine>
<Link id="l00240" /><CodeLine lineNumber="240"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1739f186de9b30a666c0340e0eb955af">IterationsToInvariance</a>&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; = &#123;std::max(&#42;LHS, &#42;RHS)&#125;);</Highlight></CodeLine>
<Link id="l00241" /><CodeLine lineNumber="241"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00242" /><CodeLine lineNumber="242"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;isCast())</Highlight></CodeLine>
<Link id="l00243" /><CodeLine lineNumber="243"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Cast instructions get the value of the operand.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00244" /><CodeLine lineNumber="244"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1739f186de9b30a666c0340e0eb955af">IterationsToInvariance</a>&#91;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; = <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a9b3f8d5fb39a3e2eb0c8416e2f3e70a2">calculate</a>(&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getOperand(0)));</Highlight></CodeLine>
<Link id="l00245" /><CodeLine lineNumber="245"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00246" /><CodeLine lineNumber="246"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// TODO: handle more expressions</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00247" /><CodeLine lineNumber="247"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00248" /><CodeLine lineNumber="248"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Everything else is Unknown.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00249" /><CodeLine lineNumber="249"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a1739f186de9b30a666c0340e0eb955af">IterationsToInvariance</a>&#91;&amp;V&#93; == <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a> &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;unexpected value saved&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00250" /><CodeLine lineNumber="250"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>;</Highlight></CodeLine>
<Link id="l00251" /><CodeLine lineNumber="251"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00252" /><CodeLine lineNumber="252"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00253" /><CodeLine lineNumber="253" lineLink="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#ab8be64c7a0b759236a80e76938e501f0"><Highlight kind="normal">std::optional&lt;unsigned&gt; <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#ab8be64c7a0b759236a80e76938e501f0">PhiAnalyzer::calculateIterationsToPeel</a>() &#123;</Highlight></CodeLine>
<Link id="l00254" /><CodeLine lineNumber="254"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> Iterations = 0;</Highlight></CodeLine>
<Link id="l00255" /><CodeLine lineNumber="255"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a> : <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6345df92cab35767ee19e9486c813b6c">L</a>.getHeader()-&gt;phis()) &#123;</Highlight></CodeLine>
<Link id="l00256" /><CodeLine lineNumber="256"><Highlight kind="normal">    <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#aaded76557bf83bcb73a8a1b606a4c3f0">PeelCounter</a> ToInvariance = <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a9b3f8d5fb39a3e2eb0c8416e2f3e70a2">calculate</a>(<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a>);</Highlight></CodeLine>
<Link id="l00257" /><CodeLine lineNumber="257"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (ToInvariance != <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a6f99e3555798da51265f3620c405aa90">Unknown</a>) &#123;</Highlight></CodeLine>
<Link id="l00258" /><CodeLine lineNumber="258"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(&#42;ToInvariance &lt;= <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0">MaxIterations</a> &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;bad result in phi analysis&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00259" /><CodeLine lineNumber="259"><Highlight kind="normal">      Iterations = std::max(Iterations, &#42;ToInvariance);</Highlight></CodeLine>
<Link id="l00260" /><CodeLine lineNumber="260"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Iterations == <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0">MaxIterations</a>)</Highlight></CodeLine>
<Link id="l00261" /><CodeLine lineNumber="261"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">break</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00262" /><CodeLine lineNumber="262"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00263" /><CodeLine lineNumber="263"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00264" /><CodeLine lineNumber="264"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((Iterations &lt;= <a href="/docs/api/classes/anonymous-namespace-looppeel-cpp-/phianalyzer/#a7126678ba10e49d92cd0fe8d2fa484f0">MaxIterations</a>) &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;bad result in phi analysis&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00265" /><CodeLine lineNumber="265"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> Iterations ? std::optional&lt;unsigned&gt;(Iterations) : std::nullopt;</Highlight></CodeLine>
<Link id="l00266" /><CodeLine lineNumber="266"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00267" /><CodeLine lineNumber="267"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00268" /><CodeLine lineNumber="268"><Highlight kind="normal">&#125; </Highlight><Highlight kind="comment">// unnamed namespace</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00269" /><CodeLine lineNumber="269"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00270" /><CodeLine lineNumber="270"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Try to find any invariant memory reads that will become dereferenceable in</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00271" /><CodeLine lineNumber="271"><Highlight kind="normal"></Highlight><Highlight kind="comment">// the remainder loop after peeling. The load must also be used (transitively)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00272" /><CodeLine lineNumber="272"><Highlight kind="normal"></Highlight><Highlight kind="comment">// by an exit condition. Returns the number of iterations to peel off (at the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00273" /><CodeLine lineNumber="273"><Highlight kind="normal"></Highlight><Highlight kind="comment">// moment either 0 or 1).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00274" /><CodeLine lineNumber="274" lineLink="#aaa1d9cfaf2d4ef4eca30ce71eb8c3a89"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> <a href="#aaa1d9cfaf2d4ef4eca30ce71eb8c3a89">peelToTurnInvariantLoadsDerefencebale</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L,</Highlight></CodeLine>
<Link id="l00275" /><CodeLine lineNumber="275"><Highlight kind="normal">                                                      <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT,</Highlight></CodeLine>
<Link id="l00276" /><CodeLine lineNumber="276"><Highlight kind="normal">                                                      <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &#42;AC) &#123;</Highlight></CodeLine>
<Link id="l00277" /><CodeLine lineNumber="277"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Skip loops with a single exiting block, because there should be no benefit</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00278" /><CodeLine lineNumber="278"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// for the heuristic below.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00279" /><CodeLine lineNumber="279"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L.getExitingBlock())</Highlight></CodeLine>
<Link id="l00280" /><CodeLine lineNumber="280"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> 0;</Highlight></CodeLine>
<Link id="l00281" /><CodeLine lineNumber="281"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00282" /><CodeLine lineNumber="282"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// All non-latch exit blocks must have an UnreachableInst terminator.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00283" /><CodeLine lineNumber="283"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Otherwise the heuristic below may not be profitable.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00284" /><CodeLine lineNumber="284"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 4&gt;</a> Exits;</Highlight></CodeLine>
<Link id="l00285" /><CodeLine lineNumber="285"><Highlight kind="normal">  L.getUniqueNonLatchExitBlocks(Exits);</Highlight></CodeLine>
<Link id="l00286" /><CodeLine lineNumber="286"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a61d13d6824ec46c31260a4fd0997eda0">any&#95;of</a>(Exits, &#91;&#93;(</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB) &#123;</Highlight></CodeLine>
<Link id="l00287" /><CodeLine lineNumber="287"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> !<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;UnreachableInst&gt;</a>(BB-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l00288" /><CodeLine lineNumber="288"><Highlight kind="normal">      &#125;))</Highlight></CodeLine>
<Link id="l00289" /><CodeLine lineNumber="289"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> 0;</Highlight></CodeLine>
<Link id="l00290" /><CodeLine lineNumber="290"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00291" /><CodeLine lineNumber="291"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now look for invariant loads that dominate the latch and are not known to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00292" /><CodeLine lineNumber="292"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// be dereferenceable. If there are such loads and no writes, they will become</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00293" /><CodeLine lineNumber="293"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// dereferenceable in the loop if the first iteration is peeled off. Also</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00294" /><CodeLine lineNumber="294"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// collect the set of instructions controlled by such loads. Only peel if an</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00295" /><CodeLine lineNumber="295"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// exit condition uses (transitively) such a load.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00296" /><CodeLine lineNumber="296"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Header = L.getHeader();</Highlight></CodeLine>
<Link id="l00297" /><CodeLine lineNumber="297"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Latch = L.getLoopLatch();</Highlight></CodeLine>
<Link id="l00298" /><CodeLine lineNumber="298"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallptrset">SmallPtrSet&lt;Value &#42;, 8&gt;</a> LoadUsers;</Highlight></CodeLine>
<Link id="l00299" /><CodeLine lineNumber="299"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/datalayout">DataLayout</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a> = L.getHeader()-&gt;getDataLayout();</Highlight></CodeLine>
<Link id="l00300" /><CodeLine lineNumber="300"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB : L.blocks()) &#123;</Highlight></CodeLine>
<Link id="l00301" /><CodeLine lineNumber="301"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : &#42;BB) &#123;</Highlight></CodeLine>
<Link id="l00302" /><CodeLine lineNumber="302"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.mayWriteToMemory())</Highlight></CodeLine>
<Link id="l00303" /><CodeLine lineNumber="303"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> 0;</Highlight></CodeLine>
<Link id="l00304" /><CodeLine lineNumber="304"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00305" /><CodeLine lineNumber="305"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> Iter = LoadUsers.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a153ea412ff7a0ba105111155d1e16128">find</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</Highlight></CodeLine>
<Link id="l00306" /><CodeLine lineNumber="306"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Iter != LoadUsers.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a7004354fbee1c8cd74ed9001915e1db5">end</a>()) &#123;</Highlight></CodeLine>
<Link id="l00307" /><CodeLine lineNumber="307"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/value">Value</a> &#42;U : <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.users())</Highlight></CodeLine>
<Link id="l00308" /><CodeLine lineNumber="308"><Highlight kind="normal">          LoadUsers.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(U);</Highlight></CodeLine>
<Link id="l00309" /><CodeLine lineNumber="309"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00310" /><CodeLine lineNumber="310"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Do not look for reads in the header; they can already be hoisted</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00311" /><CodeLine lineNumber="311"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// without peeling.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00312" /><CodeLine lineNumber="312"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (BB == Header)</Highlight></CodeLine>
<Link id="l00313" /><CodeLine lineNumber="313"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00314" /><CodeLine lineNumber="314"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;LI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;LoadInst&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) &#123;</Highlight></CodeLine>
<Link id="l00315" /><CodeLine lineNumber="315"><Highlight kind="normal">        <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/analysis/targetlibraryinfo-cpp/#aca185e6d0e9f423dbb24440206454872a11dbf501abf829b3ab7049c2d3a8a053">Ptr</a> = LI-&gt;getPointerOperand();</Highlight></CodeLine>
<Link id="l00316" /><CodeLine lineNumber="316"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DT.<a href="/docs/api/classes/llvm/dominatortree/#a5c69311e8d44898dac36a155c3d8691d">dominates</a>(BB, Latch) &amp;&amp; L.isLoopInvariant(<a href="/docs/api/files/lib/lib/analysis/targetlibraryinfo-cpp/#aca185e6d0e9f423dbb24440206454872a11dbf501abf829b3ab7049c2d3a8a053">Ptr</a>) &amp;&amp;</Highlight></CodeLine>
<Link id="l00317" /><CodeLine lineNumber="317"><Highlight kind="normal">            !<a href="/docs/api/namespaces/llvm/#abf1028e2af158aae1e00d3288ca013bb">isDereferenceablePointer</a>(<a href="/docs/api/files/lib/lib/analysis/targetlibraryinfo-cpp/#aca185e6d0e9f423dbb24440206454872a11dbf501abf829b3ab7049c2d3a8a053">Ptr</a>, LI-&gt;getType(), <a href="/docs/api/files/lib/lib/target/lib/target/arm/armslshardening-cpp/#ad467c4ab9119043f9b7750ab986be61a">DL</a>, LI, AC, &amp;DT))</Highlight></CodeLine>
<Link id="l00318" /><CodeLine lineNumber="318"><Highlight kind="normal">          </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/value">Value</a> &#42;U : <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>.users())</Highlight></CodeLine>
<Link id="l00319" /><CodeLine lineNumber="319"><Highlight kind="normal">            LoadUsers.<a href="/docs/api/classes/llvm/smallptrsetimpl/#a9d834ae3da8c62c2b668dada51335eb0">insert</a>(U);</Highlight></CodeLine>
<Link id="l00320" /><CodeLine lineNumber="320"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00321" /><CodeLine lineNumber="321"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00322" /><CodeLine lineNumber="322"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00323" /><CodeLine lineNumber="323"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;&gt;</a> ExitingBlocks;</Highlight></CodeLine>
<Link id="l00324" /><CodeLine lineNumber="324"><Highlight kind="normal">  L.getExitingBlocks(ExitingBlocks);</Highlight></CodeLine>
<Link id="l00325" /><CodeLine lineNumber="325"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a61d13d6824ec46c31260a4fd0997eda0">any&#95;of</a>(ExitingBlocks, &#91;&amp;LoadUsers&#93;(<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Exiting) &#123;</Highlight></CodeLine>
<Link id="l00326" /><CodeLine lineNumber="326"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> LoadUsers.<a href="/docs/api/classes/llvm/smallptrsetimpl/#af74676a3c7447be34bd2c1da76ec0c48">contains</a>(Exiting-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l00327" /><CodeLine lineNumber="327"><Highlight kind="normal">      &#125;))</Highlight></CodeLine>
<Link id="l00328" /><CodeLine lineNumber="328"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> 1;</Highlight></CodeLine>
<Link id="l00329" /><CodeLine lineNumber="329"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> 0;</Highlight></CodeLine>
<Link id="l00330" /><CodeLine lineNumber="330"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00331" /><CodeLine lineNumber="331"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00332" /><CodeLine lineNumber="332"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Return the number of iterations to peel off that make conditions in the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00333" /><CodeLine lineNumber="333"><Highlight kind="normal"></Highlight><Highlight kind="comment">// body true/false. For example, if we peel 2 iterations off the loop below,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00334" /><CodeLine lineNumber="334"><Highlight kind="normal"></Highlight><Highlight kind="comment">// the condition i &lt; 2 can be evaluated at compile time.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00335" /><CodeLine lineNumber="335"><Highlight kind="normal"></Highlight><Highlight kind="comment">//  for (i = 0; i &lt; n; i++)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00336" /><CodeLine lineNumber="336"><Highlight kind="normal"></Highlight><Highlight kind="comment">//    if (i &lt; 2)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00337" /><CodeLine lineNumber="337"><Highlight kind="normal"></Highlight><Highlight kind="comment">//      ..</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00338" /><CodeLine lineNumber="338"><Highlight kind="normal"></Highlight><Highlight kind="comment">//    else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00339" /><CodeLine lineNumber="339"><Highlight kind="normal"></Highlight><Highlight kind="comment">//      ..</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00340" /><CodeLine lineNumber="340"><Highlight kind="normal"></Highlight><Highlight kind="comment">//   &#125;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00341" /><CodeLine lineNumber="341" lineLink="#a7098623cafc05376a44b27d202b03372"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> <a href="#a7098623cafc05376a44b27d202b03372">countToEliminateCompares</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &amp;L, </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> MaxPeelCount,</Highlight></CodeLine>
<Link id="l00342" /><CodeLine lineNumber="342"><Highlight kind="normal">                                         <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &amp;SE) &#123;</Highlight></CodeLine>
<Link id="l00343" /><CodeLine lineNumber="343"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(L.isLoopSimplifyForm() &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Loop needs to be in loop simplify form&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00344" /><CodeLine lineNumber="344"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> DesiredPeelCount = 0;</Highlight></CodeLine>
<Link id="l00345" /><CodeLine lineNumber="345"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00346" /><CodeLine lineNumber="346"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Do not peel the entire loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00347" /><CodeLine lineNumber="347"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;BE = SE.<a href="/docs/api/classes/llvm/scalarevolution/#a0182f006bb2ae6411c2111427d58f242">getConstantMaxBackedgeTakenCount</a>(&amp;L);</Highlight></CodeLine>
<Link id="l00348" /><CodeLine lineNumber="348"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/scevconstant">SCEVConstant</a> &#42;SC = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;SCEVConstant&gt;</a>(BE))</Highlight></CodeLine>
<Link id="l00349" /><CodeLine lineNumber="349"><Highlight kind="normal">    MaxPeelCount =</Highlight></CodeLine>
<Link id="l00350" /><CodeLine lineNumber="350"><Highlight kind="normal">        std::min((</Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal">)SC-&gt;getAPInt().getLimitedValue() - 1, MaxPeelCount);</Highlight></CodeLine>
<Link id="l00351" /><CodeLine lineNumber="351"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00352" /><CodeLine lineNumber="352"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Increase PeelCount while (IterVal Pred BoundSCEV) condition is satisfied;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00353" /><CodeLine lineNumber="353"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// return true if inversed condition become known before reaching the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00354" /><CodeLine lineNumber="354"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// MaxPeelCount limit.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00355" /><CodeLine lineNumber="355"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> PeelWhilePredicateIsKnown =</Highlight></CodeLine>
<Link id="l00356" /><CodeLine lineNumber="356"><Highlight kind="normal">      &#91;&amp;&#93;(</Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> &amp;PeelCount, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;&amp;IterVal, </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;BoundSCEV,</Highlight></CodeLine>
<Link id="l00357" /><CodeLine lineNumber="357"><Highlight kind="normal">          </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;Step, <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78b">ICmpInst::Predicate</a> Pred) &#123;</Highlight></CodeLine>
<Link id="l00358" /><CodeLine lineNumber="358"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">while</Highlight><Highlight kind="normal"> (PeelCount &lt; MaxPeelCount &amp;&amp;</Highlight></CodeLine>
<Link id="l00359" /><CodeLine lineNumber="359"><Highlight kind="normal">               SE.<a href="/docs/api/classes/llvm/scalarevolution/#af74112dae88db73eb5484821b6f0fccd">isKnownPredicate</a>(Pred, IterVal, BoundSCEV)) &#123;</Highlight></CodeLine>
<Link id="l00360" /><CodeLine lineNumber="360"><Highlight kind="normal">          IterVal = SE.<a href="/docs/api/classes/llvm/scalarevolution/#aef6d2bea715d1793e956f41ddeea2320">getAddExpr</a>(IterVal, Step);</Highlight></CodeLine>
<Link id="l00361" /><CodeLine lineNumber="361"><Highlight kind="normal">          ++PeelCount;</Highlight></CodeLine>
<Link id="l00362" /><CodeLine lineNumber="362"><Highlight kind="normal">        &#125;</Highlight></CodeLine>
<Link id="l00363" /><CodeLine lineNumber="363"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> SE.<a href="/docs/api/classes/llvm/scalarevolution/#af74112dae88db73eb5484821b6f0fccd">isKnownPredicate</a>(<a href="/docs/api/classes/llvm/cmpinst/#aa2a54b545d237ecfe450fd1292f7675e">ICmpInst::getInversePredicate</a>(Pred), IterVal,</Highlight></CodeLine>
<Link id="l00364" /><CodeLine lineNumber="364"><Highlight kind="normal">                                   BoundSCEV);</Highlight></CodeLine>
<Link id="l00365" /><CodeLine lineNumber="365"><Highlight kind="normal">      &#125;;</Highlight></CodeLine>
<Link id="l00366" /><CodeLine lineNumber="366"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00367" /><CodeLine lineNumber="367"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> MaxDepth = 4;</Highlight></CodeLine>
<Link id="l00368" /><CodeLine lineNumber="368"><Highlight kind="normal">  std::function&lt;void(<a href="/docs/api/classes/llvm/value">Value</a> &#42;, </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal">)&gt; ComputePeelCount =</Highlight></CodeLine>
<Link id="l00369" /><CodeLine lineNumber="369"><Highlight kind="normal">      &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/value">Value</a> &#42;Condition, </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06afe578efb7ca235af77fb0eef7edcf639">Depth</a>) -&gt; </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00370" /><CodeLine lineNumber="370"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!Condition-&gt;<a href="/docs/api/classes/llvm/value/#a0344a49526443edf90cc0aef3abd3337">getType</a>()-&gt;<a href="/docs/api/classes/llvm/type/#ac6d28a9b11139182134a9618028a0d07">isIntegerTy</a>() || <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06afe578efb7ca235af77fb0eef7edcf639">Depth</a> &gt;= MaxDepth)</Highlight></CodeLine>
<Link id="l00371" /><CodeLine lineNumber="371"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00372" /><CodeLine lineNumber="372"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00373" /><CodeLine lineNumber="373"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;LeftVal, &#42;RightVal;</Highlight></CodeLine>
<Link id="l00374" /><CodeLine lineNumber="374"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Condition, <a href="/docs/api/namespaces/llvm/patternmatch/#a014d851989a66ce781c4f89dfffb26b5">m&#95;And</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(LeftVal), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(RightVal))) ||</Highlight></CodeLine>
<Link id="l00375" /><CodeLine lineNumber="375"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Condition, <a href="/docs/api/namespaces/llvm/patternmatch/#ae44af1eeb2e5f7a1973a4ab78963a503">m&#95;Or</a>(<a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(LeftVal), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(RightVal)))) &#123;</Highlight></CodeLine>
<Link id="l00376" /><CodeLine lineNumber="376"><Highlight kind="normal">      ComputePeelCount(LeftVal, <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06afe578efb7ca235af77fb0eef7edcf639">Depth</a> + 1);</Highlight></CodeLine>
<Link id="l00377" /><CodeLine lineNumber="377"><Highlight kind="normal">      ComputePeelCount(RightVal, <a href="/docs/api/namespaces/llvm/#a1eb5609345b906d024fbf9e4bc1adc06afe578efb7ca235af77fb0eef7edcf639">Depth</a> + 1);</Highlight></CodeLine>
<Link id="l00378" /><CodeLine lineNumber="378"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00379" /><CodeLine lineNumber="379"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00380" /><CodeLine lineNumber="380"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00381" /><CodeLine lineNumber="381"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/cmppredicate">CmpPredicate</a> Pred;</Highlight></CodeLine>
<Link id="l00382" /><CodeLine lineNumber="382"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/namespaces/llvm/patternmatch/#a25d956d9e0beadd47ce4bc255dfa811d">match</a>(Condition, <a href="/docs/api/namespaces/llvm/patternmatch/#ab86c85b47e09489dcda68fd91d082d77">m&#95;ICmp</a>(Pred, <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(LeftVal), <a href="/docs/api/namespaces/llvm/patternmatch/#aaf522908fe903018eb9b087dd6e49296">m&#95;Value</a>(RightVal))))</Highlight></CodeLine>
<Link id="l00383" /><CodeLine lineNumber="383"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00384" /><CodeLine lineNumber="384"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00385" /><CodeLine lineNumber="385"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;LeftSCEV = SE.<a href="/docs/api/classes/llvm/scalarevolution/#a30bd18ac905eacf3601bc6a553a9ff49">getSCEV</a>(LeftVal);</Highlight></CodeLine>
<Link id="l00386" /><CodeLine lineNumber="386"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;RightSCEV = SE.<a href="/docs/api/classes/llvm/scalarevolution/#a30bd18ac905eacf3601bc6a553a9ff49">getSCEV</a>(RightVal);</Highlight></CodeLine>
<Link id="l00387" /><CodeLine lineNumber="387"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00388" /><CodeLine lineNumber="388"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Do not consider predicates that are known to be true or false</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00389" /><CodeLine lineNumber="389"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// independently of the loop iteration.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00390" /><CodeLine lineNumber="390"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SE.<a href="/docs/api/classes/llvm/scalarevolution/#ad80020012061cb562a6f9c9f715c2cf0">evaluatePredicate</a>(Pred, LeftSCEV, RightSCEV))</Highlight></CodeLine>
<Link id="l00391" /><CodeLine lineNumber="391"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00392" /><CodeLine lineNumber="392"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00393" /><CodeLine lineNumber="393"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Check if we have a condition with one AddRec and one non AddRec</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00394" /><CodeLine lineNumber="394"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// expression. Normalize LeftSCEV to be the AddRec.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00395" /><CodeLine lineNumber="395"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;SCEVAddRecExpr&gt;</a>(LeftSCEV)) &#123;</Highlight></CodeLine>
<Link id="l00396" /><CodeLine lineNumber="396"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;SCEVAddRecExpr&gt;</a>(RightSCEV)) &#123;</Highlight></CodeLine>
<Link id="l00397" /><CodeLine lineNumber="397"><Highlight kind="normal">        <a href="/docs/api/namespaces/std/#ab8424022895aee3e366fb9a32f2883cb">std::swap</a>(LeftSCEV, RightSCEV);</Highlight></CodeLine>
<Link id="l00398" /><CodeLine lineNumber="398"><Highlight kind="normal">        Pred = <a href="/docs/api/classes/llvm/cmpinst/#a49a2d8f483ea08a3d6ea75f90c640d76">ICmpInst::getSwappedPredicate</a>(Pred);</Highlight></CodeLine>
<Link id="l00399" /><CodeLine lineNumber="399"><Highlight kind="normal">      &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00400" /><CodeLine lineNumber="400"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00401" /><CodeLine lineNumber="401"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00402" /><CodeLine lineNumber="402"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00403" /><CodeLine lineNumber="403"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/scevaddrecexpr">SCEVAddRecExpr</a> &#42;LeftAR = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;SCEVAddRecExpr&gt;</a>(LeftSCEV);</Highlight></CodeLine>
<Link id="l00404" /><CodeLine lineNumber="404"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00405" /><CodeLine lineNumber="405"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Avoid huge SCEV computations in the loop below, make sure we only</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00406" /><CodeLine lineNumber="406"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// consider AddRecs of the loop we are trying to peel.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00407" /><CodeLine lineNumber="407"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!LeftAR-&gt;<a href="/docs/api/classes/llvm/scevaddrecexpr/#a54bb7394d874cbbef1d81e6bea89d4f3">isAffine</a>() || LeftAR-&gt;<a href="/docs/api/classes/llvm/scevaddrecexpr/#a99ab4a82c6d7373e2e367986b9527bf0">getLoop</a>() != &amp;L)</Highlight></CodeLine>
<Link id="l00408" /><CodeLine lineNumber="408"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00409" /><CodeLine lineNumber="409"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!(<a href="/docs/api/classes/llvm/icmpinst/#abe8988eef2e6fc2baba032cb22afedd7">ICmpInst::isEquality</a>(Pred) &amp;&amp; LeftAR-&gt;<a href="/docs/api/classes/llvm/scevnaryexpr/#a6429bca8fd0024ceb2d76ccaace43c4e">hasNoSelfWrap</a>()) &amp;&amp;</Highlight></CodeLine>
<Link id="l00410" /><CodeLine lineNumber="410"><Highlight kind="normal">        !SE.<a href="/docs/api/classes/llvm/scalarevolution/#aa92b3e6375805368f9a24cf69ce73797">getMonotonicPredicateType</a>(LeftAR, Pred))</Highlight></CodeLine>
<Link id="l00411" /><CodeLine lineNumber="411"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00412" /><CodeLine lineNumber="412"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00413" /><CodeLine lineNumber="413"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Check if extending the current DesiredPeelCount lets us evaluate Pred</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00414" /><CodeLine lineNumber="414"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// or !Pred in the loop body statically.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00415" /><CodeLine lineNumber="415"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> NewPeelCount = DesiredPeelCount;</Highlight></CodeLine>
<Link id="l00416" /><CodeLine lineNumber="416"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00417" /><CodeLine lineNumber="417"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;IterVal = LeftAR-&gt;<a href="/docs/api/classes/llvm/scevaddrecexpr/#a33583576f220997d1c415df033559a57">evaluateAtIteration</a>(</Highlight></CodeLine>
<Link id="l00418" /><CodeLine lineNumber="418"><Highlight kind="normal">        SE.<a href="/docs/api/classes/llvm/scalarevolution/#a2eb94d079d8416118f4aaed865ab05d7">getConstant</a>(LeftSCEV-&gt;<a href="/docs/api/classes/llvm/scev/#aefeda9454a5e8dfcec3deb106964832a">getType</a>(), NewPeelCount), SE);</Highlight></CodeLine>
<Link id="l00419" /><CodeLine lineNumber="419"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00420" /><CodeLine lineNumber="420"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If the original condition is not known, get the negated predicate</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00421" /><CodeLine lineNumber="421"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// (which holds on the else branch) and check if it is known. This allows</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00422" /><CodeLine lineNumber="422"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// us to peel of iterations that make the original condition false.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00423" /><CodeLine lineNumber="423"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!SE.<a href="/docs/api/classes/llvm/scalarevolution/#af74112dae88db73eb5484821b6f0fccd">isKnownPredicate</a>(Pred, IterVal, RightSCEV))</Highlight></CodeLine>
<Link id="l00424" /><CodeLine lineNumber="424"><Highlight kind="normal">      Pred = <a href="/docs/api/classes/llvm/cmpinst/#aa2a54b545d237ecfe450fd1292f7675e">ICmpInst::getInversePredicate</a>(Pred);</Highlight></CodeLine>
<Link id="l00425" /><CodeLine lineNumber="425"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00426" /><CodeLine lineNumber="426"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;Step = LeftAR-&gt;<a href="/docs/api/classes/llvm/scevaddrecexpr/#a4049f7040a4628b15f182c3c9aaf802a">getStepRecurrence</a>(SE);</Highlight></CodeLine>
<Link id="l00427" /><CodeLine lineNumber="427"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!PeelWhilePredicateIsKnown(NewPeelCount, IterVal, RightSCEV, Step,</Highlight></CodeLine>
<Link id="l00428" /><CodeLine lineNumber="428"><Highlight kind="normal">                                   Pred))</Highlight></CodeLine>
<Link id="l00429" /><CodeLine lineNumber="429"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00430" /><CodeLine lineNumber="430"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00431" /><CodeLine lineNumber="431"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// However, for equality comparisons, that isn&#39;t always sufficient to</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00432" /><CodeLine lineNumber="432"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// eliminate the comparsion in loop body, we may need to peel one more</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00433" /><CodeLine lineNumber="433"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// iteration. See if that makes !Pred become unknown again.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00434" /><CodeLine lineNumber="434"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;NextIterVal = SE.<a href="/docs/api/classes/llvm/scalarevolution/#aef6d2bea715d1793e956f41ddeea2320">getAddExpr</a>(IterVal, Step);</Highlight></CodeLine>
<Link id="l00435" /><CodeLine lineNumber="435"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/icmpinst/#abe8988eef2e6fc2baba032cb22afedd7">ICmpInst::isEquality</a>(Pred) &amp;&amp;</Highlight></CodeLine>
<Link id="l00436" /><CodeLine lineNumber="436"><Highlight kind="normal">        !SE.<a href="/docs/api/classes/llvm/scalarevolution/#af74112dae88db73eb5484821b6f0fccd">isKnownPredicate</a>(<a href="/docs/api/classes/llvm/cmpinst/#aa2a54b545d237ecfe450fd1292f7675e">ICmpInst::getInversePredicate</a>(Pred), NextIterVal,</Highlight></CodeLine>
<Link id="l00437" /><CodeLine lineNumber="437"><Highlight kind="normal">                             RightSCEV) &amp;&amp;</Highlight></CodeLine>
<Link id="l00438" /><CodeLine lineNumber="438"><Highlight kind="normal">        !SE.<a href="/docs/api/classes/llvm/scalarevolution/#af74112dae88db73eb5484821b6f0fccd">isKnownPredicate</a>(Pred, IterVal, RightSCEV) &amp;&amp;</Highlight></CodeLine>
<Link id="l00439" /><CodeLine lineNumber="439"><Highlight kind="normal">        SE.<a href="/docs/api/classes/llvm/scalarevolution/#af74112dae88db73eb5484821b6f0fccd">isKnownPredicate</a>(Pred, NextIterVal, RightSCEV)) &#123;</Highlight></CodeLine>
<Link id="l00440" /><CodeLine lineNumber="440"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (NewPeelCount &gt;= MaxPeelCount)</Highlight></CodeLine>
<Link id="l00441" /><CodeLine lineNumber="441"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">; </Highlight><Highlight kind="comment">// Need to peel one more iteration, but can&#39;t. Give up.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00442" /><CodeLine lineNumber="442"><Highlight kind="normal">      ++NewPeelCount; </Highlight><Highlight kind="comment">// Great!</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00443" /><CodeLine lineNumber="443"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00444" /><CodeLine lineNumber="444"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00445" /><CodeLine lineNumber="445"><Highlight kind="normal">    DesiredPeelCount = std::max(DesiredPeelCount, NewPeelCount);</Highlight></CodeLine>
<Link id="l00446" /><CodeLine lineNumber="446"><Highlight kind="normal">  &#125;;</Highlight></CodeLine>
<Link id="l00447" /><CodeLine lineNumber="447"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00448" /><CodeLine lineNumber="448"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> ComputePeelCountMinMax = &#91;&amp;&#93;(<a href="/docs/api/classes/llvm/minmaxintrinsic">MinMaxIntrinsic</a> &#42;<a href="/docs/api/structs/llvm/minmax">MinMax</a>) &#123;</Highlight></CodeLine>
<Link id="l00449" /><CodeLine lineNumber="449"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/structs/llvm/minmax">MinMax</a>-&gt;getType()-&gt;isIntegerTy())</Highlight></CodeLine>
<Link id="l00450" /><CodeLine lineNumber="450"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00451" /><CodeLine lineNumber="451"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a> = <a href="/docs/api/structs/llvm/minmax">MinMax</a>-&gt;getLHS(), &#42;<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a> = <a href="/docs/api/structs/llvm/minmax">MinMax</a>-&gt;getRHS();</Highlight></CodeLine>
<Link id="l00452" /><CodeLine lineNumber="452"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;BoundSCEV, &#42;IterSCEV;</Highlight></CodeLine>
<Link id="l00453" /><CodeLine lineNumber="453"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L.isLoopInvariant(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>)) &#123;</Highlight></CodeLine>
<Link id="l00454" /><CodeLine lineNumber="454"><Highlight kind="normal">      BoundSCEV = SE.<a href="/docs/api/classes/llvm/scalarevolution/#a30bd18ac905eacf3601bc6a553a9ff49">getSCEV</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>);</Highlight></CodeLine>
<Link id="l00455" /><CodeLine lineNumber="455"><Highlight kind="normal">      IterSCEV = SE.<a href="/docs/api/classes/llvm/scalarevolution/#a30bd18ac905eacf3601bc6a553a9ff49">getSCEV</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>);</Highlight></CodeLine>
<Link id="l00456" /><CodeLine lineNumber="456"><Highlight kind="normal">    &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L.isLoopInvariant(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>)) &#123;</Highlight></CodeLine>
<Link id="l00457" /><CodeLine lineNumber="457"><Highlight kind="normal">      BoundSCEV = SE.<a href="/docs/api/classes/llvm/scalarevolution/#a30bd18ac905eacf3601bc6a553a9ff49">getSCEV</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a87b8bfbbe9d8f7146d7f20a5fb42efd0">RHS</a>);</Highlight></CodeLine>
<Link id="l00458" /><CodeLine lineNumber="458"><Highlight kind="normal">      IterSCEV = SE.<a href="/docs/api/classes/llvm/scalarevolution/#a30bd18ac905eacf3601bc6a553a9ff49">getSCEV</a>(<a href="/docs/api/files/lib/lib/target/lib/target/x86/x86partialreduction-cpp/#a9e1483f7215664a2315c53c3558d9a8d">LHS</a>);</Highlight></CodeLine>
<Link id="l00459" /><CodeLine lineNumber="459"><Highlight kind="normal">    &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00460" /><CodeLine lineNumber="460"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00461" /><CodeLine lineNumber="461"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;AddRec = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;SCEVAddRecExpr&gt;</a>(IterSCEV);</Highlight></CodeLine>
<Link id="l00462" /><CodeLine lineNumber="462"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// For simplicity, we support only affine recurrences.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00463" /><CodeLine lineNumber="463"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!AddRec || !AddRec-&gt;isAffine() || AddRec-&gt;getLoop() != &amp;L)</Highlight></CodeLine>
<Link id="l00464" /><CodeLine lineNumber="464"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00465" /><CodeLine lineNumber="465"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;Step = AddRec-&gt;getStepRecurrence(SE);</Highlight></CodeLine>
<Link id="l00466" /><CodeLine lineNumber="466"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> IsSigned = <a href="/docs/api/structs/llvm/minmax">MinMax</a>-&gt;isSigned();</Highlight></CodeLine>
<Link id="l00467" /><CodeLine lineNumber="467"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// To minimize number of peeled iterations, we use strict relational</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00468" /><CodeLine lineNumber="468"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// predicates here.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00469" /><CodeLine lineNumber="469"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78b">ICmpInst::Predicate</a> Pred;</Highlight></CodeLine>
<Link id="l00470" /><CodeLine lineNumber="470"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SE.<a href="/docs/api/classes/llvm/scalarevolution/#a5a672708a81ae8da8fb56e32638ca9b3">isKnownPositive</a>(Step))</Highlight></CodeLine>
<Link id="l00471" /><CodeLine lineNumber="471"><Highlight kind="normal">      Pred = IsSigned ? <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78ba15ae464950ac676919c2f0c7aafc706c">ICmpInst::ICMP&#95;SLT</a> : <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78ba91d86a4753c8bd7624e01bf565d87f8e">ICmpInst::ICMP&#95;ULT</a>;</Highlight></CodeLine>
<Link id="l00472" /><CodeLine lineNumber="472"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SE.<a href="/docs/api/classes/llvm/scalarevolution/#a1b9806d21518ef7fb4d5c4299e21411f">isKnownNegative</a>(Step))</Highlight></CodeLine>
<Link id="l00473" /><CodeLine lineNumber="473"><Highlight kind="normal">      Pred = IsSigned ? <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78ba720a42e85f7e981afd61e28473b0000a">ICmpInst::ICMP&#95;SGT</a> : <a href="/docs/api/classes/llvm/cmpinst/#a2be3583dac92a031fa1458d4d992c78ba607cecdc5172814382033e001ed11fad">ICmpInst::ICMP&#95;UGT</a>;</Highlight></CodeLine>
<Link id="l00474" /><CodeLine lineNumber="474"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00475" /><CodeLine lineNumber="475"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00476" /><CodeLine lineNumber="476"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Check that AddRec is not wrapping.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00477" /><CodeLine lineNumber="477"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!(IsSigned ? AddRec-&gt;hasNoSignedWrap() : AddRec-&gt;hasNoUnsignedWrap()))</Highlight></CodeLine>
<Link id="l00478" /><CodeLine lineNumber="478"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00479" /><CodeLine lineNumber="479"><Highlight kind="normal">    </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> NewPeelCount = DesiredPeelCount;</Highlight></CodeLine>
<Link id="l00480" /><CodeLine lineNumber="480"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/scev">SCEV</a> &#42;IterVal = AddRec-&gt;evaluateAtIteration(</Highlight></CodeLine>
<Link id="l00481" /><CodeLine lineNumber="481"><Highlight kind="normal">        SE.<a href="/docs/api/classes/llvm/scalarevolution/#a2eb94d079d8416118f4aaed865ab05d7">getConstant</a>(AddRec-&gt;getType(), NewPeelCount), SE);</Highlight></CodeLine>
<Link id="l00482" /><CodeLine lineNumber="482"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!PeelWhilePredicateIsKnown(NewPeelCount, IterVal, BoundSCEV, Step,</Highlight></CodeLine>
<Link id="l00483" /><CodeLine lineNumber="483"><Highlight kind="normal">                                   Pred))</Highlight></CodeLine>
<Link id="l00484" /><CodeLine lineNumber="484"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00485" /><CodeLine lineNumber="485"><Highlight kind="normal">    DesiredPeelCount = NewPeelCount;</Highlight></CodeLine>
<Link id="l00486" /><CodeLine lineNumber="486"><Highlight kind="normal">  &#125;;</Highlight></CodeLine>
<Link id="l00487" /><CodeLine lineNumber="487"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00488" /><CodeLine lineNumber="488"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;BB : L.blocks()) &#123;</Highlight></CodeLine>
<Link id="l00489" /><CodeLine lineNumber="489"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/instruction">Instruction</a> &amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> : &#42;BB) &#123;</Highlight></CodeLine>
<Link id="l00490" /><CodeLine lineNumber="490"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/selectinst">SelectInst</a> &#42;<a href="/docs/api/namespaces/llvm/si">SI</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;SelectInst&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</Highlight></CodeLine>
<Link id="l00491" /><CodeLine lineNumber="491"><Highlight kind="normal">        ComputePeelCount(<a href="/docs/api/namespaces/llvm/si">SI</a>-&gt;getCondition(), 0);</Highlight></CodeLine>
<Link id="l00492" /><CodeLine lineNumber="492"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/minmaxintrinsic">MinMaxIntrinsic</a> &#42;<a href="/docs/api/structs/llvm/minmax">MinMax</a> = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;MinMaxIntrinsic&gt;</a>(&amp;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</Highlight></CodeLine>
<Link id="l00493" /><CodeLine lineNumber="493"><Highlight kind="normal">        ComputePeelCountMinMax(<a href="/docs/api/structs/llvm/minmax">MinMax</a>);</Highlight></CodeLine>
<Link id="l00494" /><CodeLine lineNumber="494"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00495" /><CodeLine lineNumber="495"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00496" /><CodeLine lineNumber="496"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BI = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BranchInst&gt;</a>(BB-&gt;getTerminator());</Highlight></CodeLine>
<Link id="l00497" /><CodeLine lineNumber="497"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!BI || BI-&gt;isUnconditional())</Highlight></CodeLine>
<Link id="l00498" /><CodeLine lineNumber="498"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00499" /><CodeLine lineNumber="499"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00500" /><CodeLine lineNumber="500"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Ignore loop exit condition.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00501" /><CodeLine lineNumber="501"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L.getLoopLatch() == BB)</Highlight></CodeLine>
<Link id="l00502" /><CodeLine lineNumber="502"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00503" /><CodeLine lineNumber="503"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00504" /><CodeLine lineNumber="504"><Highlight kind="normal">    ComputePeelCount(BI-&gt;getCondition(), 0);</Highlight></CodeLine>
<Link id="l00505" /><CodeLine lineNumber="505"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00506" /><CodeLine lineNumber="506"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00507" /><CodeLine lineNumber="507"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> DesiredPeelCount;</Highlight></CodeLine>
<Link id="l00508" /><CodeLine lineNumber="508"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00509" /><CodeLine lineNumber="509"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00510" /><CodeLine lineNumber="510"><Highlight kind="comment">/// This &quot;heuristic&quot; exactly matches implicit behavior which used to exist</Highlight></CodeLine>
<Link id="l00511" /><CodeLine lineNumber="511"><Highlight kind="comment">/// inside getLoopEstimatedTripCount.  It was added here to keep an</Highlight></CodeLine>
<Link id="l00512" /><CodeLine lineNumber="512"><Highlight kind="comment">/// improvement inside that API from causing peeling to become more aggressive.</Highlight></CodeLine>
<Link id="l00513" /><CodeLine lineNumber="513"><Highlight kind="comment">/// This should probably be removed.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00514" /><CodeLine lineNumber="514" lineLink="#a7d391dbabb8fc073db875548184a768d"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="#a7d391dbabb8fc073db875548184a768d">violatesLegacyMultiExitLoopCheck</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L) &#123;</Highlight></CodeLine>
<Link id="l00515" /><CodeLine lineNumber="515"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Latch = L-&gt;getLoopLatch();</Highlight></CodeLine>
<Link id="l00516" /><CodeLine lineNumber="516"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!Latch)</Highlight></CodeLine>
<Link id="l00517" /><CodeLine lineNumber="517"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00518" /><CodeLine lineNumber="518"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00519" /><CodeLine lineNumber="519"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/branchinst">BranchInst</a> &#42;LatchBR = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;BranchInst&gt;</a>(Latch-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l00520" /><CodeLine lineNumber="520"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!LatchBR || LatchBR-&gt;<a href="/docs/api/classes/llvm/branchinst/#a96b8f11f6f21ca0321294669dab83b35">getNumSuccessors</a>() != 2 || !L-&gt;isLoopExiting(Latch))</Highlight></CodeLine>
<Link id="l00521" /><CodeLine lineNumber="521"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00522" /><CodeLine lineNumber="522"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00523" /><CodeLine lineNumber="523"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>((LatchBR-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(0) == L-&gt;getHeader() ||</Highlight></CodeLine>
<Link id="l00524" /><CodeLine lineNumber="524"><Highlight kind="normal">          LatchBR-&gt;<a href="/docs/api/classes/llvm/branchinst/#aa05da2b94b366573d1651d5b163c521e">getSuccessor</a>(1) == L-&gt;getHeader()) &amp;&amp;</Highlight></CodeLine>
<Link id="l00525" /><CodeLine lineNumber="525"><Highlight kind="normal">         </Highlight><Highlight kind="stringliteral">&quot;At least one edge out of the latch must go to the header&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00526" /><CodeLine lineNumber="526"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00527" /><CodeLine lineNumber="527"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 4&gt;</a> ExitBlocks;</Highlight></CodeLine>
<Link id="l00528" /><CodeLine lineNumber="528"><Highlight kind="normal">  L-&gt;getUniqueNonLatchExitBlocks(ExitBlocks);</Highlight></CodeLine>
<Link id="l00529" /><CodeLine lineNumber="529"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/#a61d13d6824ec46c31260a4fd0997eda0">any&#95;of</a>(ExitBlocks, &#91;&#93;(</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;EB) &#123;</Highlight></CodeLine>
<Link id="l00530" /><CodeLine lineNumber="530"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> !EB-&gt;<a href="/docs/api/classes/llvm/basicblock/#a6796a84f02394ce6ebef227c866cd5eb">getTerminatingDeoptimizeCall</a>();</Highlight></CodeLine>
<Link id="l00531" /><CodeLine lineNumber="531"><Highlight kind="normal">    &#125;);</Highlight></CodeLine>
<Link id="l00532" /><CodeLine lineNumber="532"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00533" /><CodeLine lineNumber="533"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00534" /><CodeLine lineNumber="534"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00535" /><CodeLine lineNumber="535"><Highlight kind="normal"></Highlight><Highlight kind="comment">// Return the number of iterations we want to peel off.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00536" /><CodeLine lineNumber="536" lineLink="/docs/api/namespaces/llvm/#a1b8329ea8794c1e6fa1294a1e5a463dd"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/#a1b8329ea8794c1e6fa1294a1e5a463dd">llvm::computePeelCount</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L, </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> LoopSize,</Highlight></CodeLine>
<Link id="l00537" /><CodeLine lineNumber="537"><Highlight kind="normal">                            <a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences">TargetTransformInfo::PeelingPreferences</a> &amp;PP,</Highlight></CodeLine>
<Link id="l00538" /><CodeLine lineNumber="538"><Highlight kind="normal">                            </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> TripCount, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT,</Highlight></CodeLine>
<Link id="l00539" /><CodeLine lineNumber="539"><Highlight kind="normal">                            <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &amp;SE, <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &#42;AC,</Highlight></CodeLine>
<Link id="l00540" /><CodeLine lineNumber="540"><Highlight kind="normal">                            </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> Threshold) &#123;</Highlight></CodeLine>
<Link id="l00541" /><CodeLine lineNumber="541"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(LoopSize &gt; 0 &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Zero loop size is not allowed!&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00542" /><CodeLine lineNumber="542"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Save the PP.PeelCount value set by the target in</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00543" /><CodeLine lineNumber="543"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// TTI.getPeelingPreferences or by the flag -unroll-peel-count.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00544" /><CodeLine lineNumber="544"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> TargetPeelCount = PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a93102207c7c9430df6ef02447446de9b">PeelCount</a>;</Highlight></CodeLine>
<Link id="l00545" /><CodeLine lineNumber="545"><Highlight kind="normal">  PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a93102207c7c9430df6ef02447446de9b">PeelCount</a> = 0;</Highlight></CodeLine>
<Link id="l00546" /><CodeLine lineNumber="546"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/namespaces/llvm/#a3aea1e78510aa7469457aade10808e51">canPeel</a>(L))</Highlight></CodeLine>
<Link id="l00547" /><CodeLine lineNumber="547"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00548" /><CodeLine lineNumber="548"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00549" /><CodeLine lineNumber="549"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Only try to peel innermost loops by default.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00550" /><CodeLine lineNumber="550"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The constraint can be relaxed by the target in TTI.getPeelingPreferences</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00551" /><CodeLine lineNumber="551"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// or by the flag -unroll-allow-loop-nests-peeling.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00552" /><CodeLine lineNumber="552"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a71809834780876145831c63077461284">AllowLoopNestsPeeling</a> &amp;&amp; !L-&gt;isInnermost())</Highlight></CodeLine>
<Link id="l00553" /><CodeLine lineNumber="553"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00554" /><CodeLine lineNumber="554"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00555" /><CodeLine lineNumber="555"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If the user provided a peel count, use that.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00556" /><CodeLine lineNumber="556"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> UserPeelCount = <a href="#a6383b9c934edc393f9e9f3fd992559aa">UnrollForcePeelCount</a>.getNumOccurrences() &gt; 0;</Highlight></CodeLine>
<Link id="l00557" /><CodeLine lineNumber="557"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UserPeelCount) &#123;</Highlight></CodeLine>
<Link id="l00558" /><CodeLine lineNumber="558"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Force-peeling first &quot;</Highlight><Highlight kind="normal"> &lt;&lt; <a href="#a6383b9c934edc393f9e9f3fd992559aa">UnrollForcePeelCount</a></Highlight></CodeLine>
<Link id="l00559" /><CodeLine lineNumber="559"><Highlight kind="normal">                      &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; iterations.\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00560" /><CodeLine lineNumber="560"><Highlight kind="normal">    PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a93102207c7c9430df6ef02447446de9b">PeelCount</a> = <a href="#a6383b9c934edc393f9e9f3fd992559aa">UnrollForcePeelCount</a>;</Highlight></CodeLine>
<Link id="l00561" /><CodeLine lineNumber="561"><Highlight kind="normal">    PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a89c02eecae37f89bf86f71336630858d">PeelProfiledIterations</a> = </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00562" /><CodeLine lineNumber="562"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00563" /><CodeLine lineNumber="563"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00564" /><CodeLine lineNumber="564"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00565" /><CodeLine lineNumber="565"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Skip peeling if it&#39;s disabled.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00566" /><CodeLine lineNumber="566"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a3421601051b06ed7b52a09696bd595b2">AllowPeeling</a>)</Highlight></CodeLine>
<Link id="l00567" /><CodeLine lineNumber="567"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00568" /><CodeLine lineNumber="568"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00569" /><CodeLine lineNumber="569"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Check that we can peel at least one iteration.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00570" /><CodeLine lineNumber="570"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (2 &#42; LoopSize &gt; Threshold)</Highlight></CodeLine>
<Link id="l00571" /><CodeLine lineNumber="571"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00572" /><CodeLine lineNumber="572"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00573" /><CodeLine lineNumber="573"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> AlreadyPeeled = 0;</Highlight></CodeLine>
<Link id="l00574" /><CodeLine lineNumber="574"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> Peeled = <a href="/docs/api/namespaces/llvm/#a9b3cfe2d1603665824476c30368b8eb1">getOptionalIntLoopAttribute</a>(L, <a href="#a7f5685c46cf812c90576046af45cd7fa">PeeledCountMetaData</a>))</Highlight></CodeLine>
<Link id="l00575" /><CodeLine lineNumber="575"><Highlight kind="normal">    AlreadyPeeled = &#42;Peeled;</Highlight></CodeLine>
<Link id="l00576" /><CodeLine lineNumber="576"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Stop if we already peeled off the maximum number of iterations.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00577" /><CodeLine lineNumber="577"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (AlreadyPeeled &gt;= <a href="#a36a7dd364657e3ef9947efb9224aaca4">UnrollPeelMaxCount</a>)</Highlight></CodeLine>
<Link id="l00578" /><CodeLine lineNumber="578"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00579" /><CodeLine lineNumber="579"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00580" /><CodeLine lineNumber="580"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Pay respect to limitations implied by loop size and the max peel count.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00581" /><CodeLine lineNumber="581"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> MaxPeelCount = <a href="#a36a7dd364657e3ef9947efb9224aaca4">UnrollPeelMaxCount</a>;</Highlight></CodeLine>
<Link id="l00582" /><CodeLine lineNumber="582"><Highlight kind="normal">  MaxPeelCount = std::min(MaxPeelCount, Threshold / LoopSize - 1);</Highlight></CodeLine>
<Link id="l00583" /><CodeLine lineNumber="583"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00584" /><CodeLine lineNumber="584"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Start the max computation with the PP.PeelCount value set by the target</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00585" /><CodeLine lineNumber="585"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// in TTI.getPeelingPreferences or by the flag -unroll-peel-count.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00586" /><CodeLine lineNumber="586"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> DesiredPeelCount = TargetPeelCount;</Highlight></CodeLine>
<Link id="l00587" /><CodeLine lineNumber="587"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00588" /><CodeLine lineNumber="588"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Here we try to get rid of Phis which become invariants after 1, 2, ..., N</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00589" /><CodeLine lineNumber="589"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// iterations of the loop. For this we compute the number for iterations after</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00590" /><CodeLine lineNumber="590"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// which every Phi is guaranteed to become an invariant, and try to peel the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00591" /><CodeLine lineNumber="591"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// maximum number of iterations among these values, thus turning all those</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00592" /><CodeLine lineNumber="592"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Phis into invariants.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00593" /><CodeLine lineNumber="593"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (MaxPeelCount &gt; DesiredPeelCount) &#123;</Highlight></CodeLine>
<Link id="l00594" /><CodeLine lineNumber="594"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Check how many iterations are useful for resolving Phis</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00595" /><CodeLine lineNumber="595"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> NumPeels = PhiAnalyzer(&#42;L, MaxPeelCount).calculateIterationsToPeel();</Highlight></CodeLine>
<Link id="l00596" /><CodeLine lineNumber="596"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (NumPeels)</Highlight></CodeLine>
<Link id="l00597" /><CodeLine lineNumber="597"><Highlight kind="normal">      DesiredPeelCount = std::max(DesiredPeelCount, &#42;NumPeels);</Highlight></CodeLine>
<Link id="l00598" /><CodeLine lineNumber="598"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00599" /><CodeLine lineNumber="599"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00600" /><CodeLine lineNumber="600"><Highlight kind="normal">  DesiredPeelCount = std::max(DesiredPeelCount,</Highlight></CodeLine>
<Link id="l00601" /><CodeLine lineNumber="601"><Highlight kind="normal">                              <a href="#a7098623cafc05376a44b27d202b03372">countToEliminateCompares</a>(&#42;L, MaxPeelCount, SE));</Highlight></CodeLine>
<Link id="l00602" /><CodeLine lineNumber="602"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00603" /><CodeLine lineNumber="603"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DesiredPeelCount == 0)</Highlight></CodeLine>
<Link id="l00604" /><CodeLine lineNumber="604"><Highlight kind="normal">    DesiredPeelCount = <a href="#aaa1d9cfaf2d4ef4eca30ce71eb8c3a89">peelToTurnInvariantLoadsDerefencebale</a>(&#42;L, DT, AC);</Highlight></CodeLine>
<Link id="l00605" /><CodeLine lineNumber="605"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00606" /><CodeLine lineNumber="606"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DesiredPeelCount &gt; 0) &#123;</Highlight></CodeLine>
<Link id="l00607" /><CodeLine lineNumber="607"><Highlight kind="normal">    DesiredPeelCount = std::min(DesiredPeelCount, MaxPeelCount);</Highlight></CodeLine>
<Link id="l00608" /><CodeLine lineNumber="608"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Consider max peel count limitation.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00609" /><CodeLine lineNumber="609"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(DesiredPeelCount &gt; 0 &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Wrong loop size estimation?&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00610" /><CodeLine lineNumber="610"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DesiredPeelCount + AlreadyPeeled &lt;= <a href="#a36a7dd364657e3ef9947efb9224aaca4">UnrollPeelMaxCount</a>) &#123;</Highlight></CodeLine>
<Link id="l00611" /><CodeLine lineNumber="611"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Peel &quot;</Highlight><Highlight kind="normal"> &lt;&lt; DesiredPeelCount</Highlight></CodeLine>
<Link id="l00612" /><CodeLine lineNumber="612"><Highlight kind="normal">                        &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; iteration(s) to turn&quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00613" /><CodeLine lineNumber="613"><Highlight kind="normal">                        &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; some Phis into invariants.\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00614" /><CodeLine lineNumber="614"><Highlight kind="normal">      PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a93102207c7c9430df6ef02447446de9b">PeelCount</a> = DesiredPeelCount;</Highlight></CodeLine>
<Link id="l00615" /><CodeLine lineNumber="615"><Highlight kind="normal">      PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a89c02eecae37f89bf86f71336630858d">PeelProfiledIterations</a> = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00616" /><CodeLine lineNumber="616"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00617" /><CodeLine lineNumber="617"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00618" /><CodeLine lineNumber="618"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00619" /><CodeLine lineNumber="619"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00620" /><CodeLine lineNumber="620"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Bail if we know the statically calculated trip count.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00621" /><CodeLine lineNumber="621"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// In this case we rather prefer partial unrolling.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00622" /><CodeLine lineNumber="622"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (TripCount)</Highlight></CodeLine>
<Link id="l00623" /><CodeLine lineNumber="623"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00624" /><CodeLine lineNumber="624"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00625" /><CodeLine lineNumber="625"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Do not apply profile base peeling if it is disabled.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00626" /><CodeLine lineNumber="626"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a89c02eecae37f89bf86f71336630858d">PeelProfiledIterations</a>)</Highlight></CodeLine>
<Link id="l00627" /><CodeLine lineNumber="627"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00628" /><CodeLine lineNumber="628"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If we don&#39;t know the trip count, but have reason to believe the average</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00629" /><CodeLine lineNumber="629"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// trip count is low, peeling should be beneficial, since we will usually</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00630" /><CodeLine lineNumber="630"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// hit the peeled section.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00631" /><CodeLine lineNumber="631"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We only do this in the presence of profile information, since otherwise</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00632" /><CodeLine lineNumber="632"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// our estimates of the trip count are not reliable enough.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00633" /><CodeLine lineNumber="633"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L-&gt;getHeader()-&gt;getParent()-&gt;hasProfileData()) &#123;</Highlight></CodeLine>
<Link id="l00634" /><CodeLine lineNumber="634"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#a7d391dbabb8fc073db875548184a768d">violatesLegacyMultiExitLoopCheck</a>(L))</Highlight></CodeLine>
<Link id="l00635" /><CodeLine lineNumber="635"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00636" /><CodeLine lineNumber="636"><Highlight kind="normal">    std::optional&lt;unsigned&gt; EstimatedTripCount = <a href="/docs/api/namespaces/llvm/#a0b3c6dc8e7df65d2385acfe9657abd03">getLoopEstimatedTripCount</a>(L);</Highlight></CodeLine>
<Link id="l00637" /><CodeLine lineNumber="637"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!EstimatedTripCount)</Highlight></CodeLine>
<Link id="l00638" /><CodeLine lineNumber="638"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00639" /><CodeLine lineNumber="639"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00640" /><CodeLine lineNumber="640"><Highlight kind="normal">    <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Profile-based estimated trip count is &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00641" /><CodeLine lineNumber="641"><Highlight kind="normal">                      &lt;&lt; &#42;EstimatedTripCount &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00642" /><CodeLine lineNumber="642"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00643" /><CodeLine lineNumber="643"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (&#42;EstimatedTripCount) &#123;</Highlight></CodeLine>
<Link id="l00644" /><CodeLine lineNumber="644"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (&#42;EstimatedTripCount + AlreadyPeeled &lt;= MaxPeelCount) &#123;</Highlight></CodeLine>
<Link id="l00645" /><CodeLine lineNumber="645"><Highlight kind="normal">        </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> PeelCount = &#42;EstimatedTripCount;</Highlight></CodeLine>
<Link id="l00646" /><CodeLine lineNumber="646"><Highlight kind="normal">        <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Peeling first &quot;</Highlight><Highlight kind="normal"> &lt;&lt; PeelCount &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot; iterations.\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00647" /><CodeLine lineNumber="647"><Highlight kind="normal">        PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a93102207c7c9430df6ef02447446de9b">PeelCount</a> = PeelCount;</Highlight></CodeLine>
<Link id="l00648" /><CodeLine lineNumber="648"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00649" /><CodeLine lineNumber="649"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00650" /><CodeLine lineNumber="650"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Already peel count: &quot;</Highlight><Highlight kind="normal"> &lt;&lt; AlreadyPeeled &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00651" /><CodeLine lineNumber="651"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Max peel count: &quot;</Highlight><Highlight kind="normal"> &lt;&lt; <a href="#a36a7dd364657e3ef9947efb9224aaca4">UnrollPeelMaxCount</a> &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00652" /><CodeLine lineNumber="652"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Loop cost: &quot;</Highlight><Highlight kind="normal"> &lt;&lt; LoopSize &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00653" /><CodeLine lineNumber="653"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Max peel cost: &quot;</Highlight><Highlight kind="normal"> &lt;&lt; Threshold &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00654" /><CodeLine lineNumber="654"><Highlight kind="normal">      <a href="/docs/api/files/include/include/llvm/include/llvm/support/debug-h/#a196897517069dda1bdb549e24468f7d7">LLVM&#95;DEBUG</a>(<a href="/docs/api/namespaces/llvm/#a7c46c742c31be54870e2038048e6b391">dbgs</a>() &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;Max peel count by cost: &quot;</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00655" /><CodeLine lineNumber="655"><Highlight kind="normal">                        &lt;&lt; (Threshold / LoopSize - 1) &lt;&lt; </Highlight><Highlight kind="stringliteral">&quot;\\n&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00656" /><CodeLine lineNumber="656"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00657" /><CodeLine lineNumber="657"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00658" /><CodeLine lineNumber="658"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00659" /><CodeLine lineNumber="659"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00660" /><CodeLine lineNumber="660" lineLink="/docs/api/structs/weightinfo"><Highlight kind="normal"></Highlight><Highlight kind="keyword">struct </Highlight><Highlight kind="normal"><a href="/docs/api/structs/weightinfo">WeightInfo</a> &#123;</Highlight></CodeLine>
<Link id="l00661" /><CodeLine lineNumber="661"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Weights for current iteration.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00662" /><CodeLine lineNumber="662" lineLink="/docs/api/structs/weightinfo/#a79bc95d0a4dfb8b3f4c7f5da4c72ff8e"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;uint32&#95;t&gt;</a> <a href="/docs/api/structs/weightinfo/#a79bc95d0a4dfb8b3f4c7f5da4c72ff8e">Weights</a>;</Highlight></CodeLine>
<Link id="l00663" /><CodeLine lineNumber="663"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Weights to subtract after each iteration.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00664" /><CodeLine lineNumber="664" lineLink="/docs/api/structs/weightinfo/#afcdb4745743d71dcdf4d80b3f6692065"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;uint32&#95;t&gt;</a> <a href="/docs/api/structs/weightinfo/#afcdb4745743d71dcdf4d80b3f6692065">SubWeights</a>;</Highlight></CodeLine>
<Link id="l00665" /><CodeLine lineNumber="665"><Highlight kind="normal">&#125;;</Highlight></CodeLine>
<Link id="l00666" /><CodeLine lineNumber="666"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00667" /><CodeLine lineNumber="667"><Highlight kind="comment">/// Update the branch weights of an exiting block of a peeled-off loop</Highlight></CodeLine>
<Link id="l00668" /><CodeLine lineNumber="668"><Highlight kind="comment">/// iteration.</Highlight></CodeLine>
<Link id="l00669" /><CodeLine lineNumber="669"><Highlight kind="comment">/// Let F is a weight of the edge to continue (fallthrough) into the loop.</Highlight></CodeLine>
<Link id="l00670" /><CodeLine lineNumber="670"><Highlight kind="comment">/// Let E is a weight of the edge to an exit.</Highlight></CodeLine>
<Link id="l00671" /><CodeLine lineNumber="671"><Highlight kind="comment">/// F/(F+E) is a probability to go to loop and E/(F+E) is a probability to</Highlight></CodeLine>
<Link id="l00672" /><CodeLine lineNumber="672"><Highlight kind="comment">/// go to exit.</Highlight></CodeLine>
<Link id="l00673" /><CodeLine lineNumber="673"><Highlight kind="comment">/// Then, Estimated ExitCount = F / E.</Highlight></CodeLine>
<Link id="l00674" /><CodeLine lineNumber="674"><Highlight kind="comment">/// For I-th (counting from 0) peeled off iteration we set the weights for</Highlight></CodeLine>
<Link id="l00675" /><CodeLine lineNumber="675"><Highlight kind="comment">/// the peeled exit as (EC - I, 1). It gives us reasonable distribution,</Highlight></CodeLine>
<Link id="l00676" /><CodeLine lineNumber="676"><Highlight kind="comment">/// The probability to go to exit 1/(EC-I) increases. At the same time</Highlight></CodeLine>
<Link id="l00677" /><CodeLine lineNumber="677"><Highlight kind="comment">/// the estimated exit count in the remainder loop reduces by I.</Highlight></CodeLine>
<Link id="l00678" /><CodeLine lineNumber="678"><Highlight kind="comment">/// To avoid dealing with division rounding we can just multiple both part</Highlight></CodeLine>
<Link id="l00679" /><CodeLine lineNumber="679"><Highlight kind="comment">/// of weights to E and use weight as (F - I &#42; E, E).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00680" /><CodeLine lineNumber="680" lineLink="#a070d953c06601ec34680fdc35c867b17"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#a070d953c06601ec34680fdc35c867b17">updateBranchWeights</a>(<a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Term, <a href="/docs/api/structs/weightinfo">WeightInfo</a> &amp;<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>) &#123;</Highlight></CodeLine>
<Link id="l00681" /><CodeLine lineNumber="681"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#a6cf82c052d63a1b464be8e48ff38c48e">setBranchWeights</a>(&#42;Term, <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.Weights, </Highlight><Highlight kind="comment">/&#42;IsExpected=&#42;/</Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00682" /><CodeLine lineNumber="682"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#91;Idx, SubWeight&#93; : <a href="/docs/api/namespaces/llvm/#a206e2134ddd2312c3488d0632d98f554">enumerate</a>(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.SubWeights))</Highlight></CodeLine>
<Link id="l00683" /><CodeLine lineNumber="683"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (SubWeight != 0)</Highlight></CodeLine>
<Link id="l00684" /><CodeLine lineNumber="684"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Don&#39;t set the probability of taking the edge from latch to loop header</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00685" /><CodeLine lineNumber="685"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// to less than 1:1 ratio (meaning Weight should not be lower than</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00686" /><CodeLine lineNumber="686"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// SubWeight), as this could significantly reduce the loop&#39;s hotness,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00687" /><CodeLine lineNumber="687"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// which would be incorrect in the case of underestimating the trip count.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00688" /><CodeLine lineNumber="688"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.Weights&#91;Idx&#93; =</Highlight></CodeLine>
<Link id="l00689" /><CodeLine lineNumber="689"><Highlight kind="normal">          <a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.Weights&#91;Idx&#93; &gt; SubWeight</Highlight></CodeLine>
<Link id="l00690" /><CodeLine lineNumber="690"><Highlight kind="normal">              ? std::max(<a href="/docs/api/files/lib/lib/codegen/lib/codegen/globalisel/cseinfo-cpp/#a75f8a8519c2c9b30e7c06dc5e256fffa">Info</a>.Weights&#91;Idx&#93; - SubWeight, SubWeight)</Highlight></CodeLine>
<Link id="l00691" /><CodeLine lineNumber="691"><Highlight kind="normal">              : SubWeight;</Highlight></CodeLine>
<Link id="l00692" /><CodeLine lineNumber="692"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00693" /><CodeLine lineNumber="693"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00694" /><CodeLine lineNumber="694"><Highlight kind="comment">/// Initialize the weights for all exiting blocks.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00695" /><CodeLine lineNumber="695" lineLink="#acd8a7753c2685a14185133433c0bbf26"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#acd8a7753c2685a14185133433c0bbf26">initBranchWeights</a>(<a href="/docs/api/classes/llvm/densemap">DenseMap&lt;Instruction &#42;, WeightInfo&gt;</a> &amp;WeightInfos,</Highlight></CodeLine>
<Link id="l00696" /><CodeLine lineNumber="696"><Highlight kind="normal">                              <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L) &#123;</Highlight></CodeLine>
<Link id="l00697" /><CodeLine lineNumber="697"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;&gt;</a> ExitingBlocks;</Highlight></CodeLine>
<Link id="l00698" /><CodeLine lineNumber="698"><Highlight kind="normal">  L-&gt;getExitingBlocks(ExitingBlocks);</Highlight></CodeLine>
<Link id="l00699" /><CodeLine lineNumber="699"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;ExitingBlock : ExitingBlocks) &#123;</Highlight></CodeLine>
<Link id="l00700" /><CodeLine lineNumber="700"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;Term = ExitingBlock-&gt;getTerminator();</Highlight></CodeLine>
<Link id="l00701" /><CodeLine lineNumber="701"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;uint32&#95;t&gt;</a> Weights;</Highlight></CodeLine>
<Link id="l00702" /><CodeLine lineNumber="702"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!<a href="/docs/api/namespaces/llvm/#ac19cbbc4935a23e1d44f65e1eaba6b1d">extractBranchWeights</a>(&#42;Term, Weights))</Highlight></CodeLine>
<Link id="l00703" /><CodeLine lineNumber="703"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00704" /><CodeLine lineNumber="704"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00705" /><CodeLine lineNumber="705"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// See the comment on updateBranchWeights() for an explanation of what we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00706" /><CodeLine lineNumber="706"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// do here.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00707" /><CodeLine lineNumber="707"><Highlight kind="normal">    uint32&#95;t FallThroughWeights = 0;</Highlight></CodeLine>
<Link id="l00708" /><CodeLine lineNumber="708"><Highlight kind="normal">    uint32&#95;t ExitWeights = 0;</Highlight></CodeLine>
<Link id="l00709" /><CodeLine lineNumber="709"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#91;Succ, Weight&#93; : <a href="/docs/api/namespaces/llvm/#a06041e3bf4b0a9e8984809413ddd9506">zip</a>(<a href="/docs/api/namespaces/llvm/#a26e2a938b431eaa6eca2beaa96410c9d">successors</a>(Term), Weights)) &#123;</Highlight></CodeLine>
<Link id="l00710" /><CodeLine lineNumber="710"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (L-&gt;contains(Succ))</Highlight></CodeLine>
<Link id="l00711" /><CodeLine lineNumber="711"><Highlight kind="normal">        FallThroughWeights += Weight;</Highlight></CodeLine>
<Link id="l00712" /><CodeLine lineNumber="712"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00713" /><CodeLine lineNumber="713"><Highlight kind="normal">        ExitWeights += Weight;</Highlight></CodeLine>
<Link id="l00714" /><CodeLine lineNumber="714"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00715" /><CodeLine lineNumber="715"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00716" /><CodeLine lineNumber="716"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Don&#39;t try to update weights for degenerate case.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00717" /><CodeLine lineNumber="717"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (FallThroughWeights == 0)</Highlight></CodeLine>
<Link id="l00718" /><CodeLine lineNumber="718"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00719" /><CodeLine lineNumber="719"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00720" /><CodeLine lineNumber="720"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;uint32&#95;t&gt;</a> SubWeights;</Highlight></CodeLine>
<Link id="l00721" /><CodeLine lineNumber="721"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#91;Succ, Weight&#93; : <a href="/docs/api/namespaces/llvm/#a06041e3bf4b0a9e8984809413ddd9506">zip</a>(<a href="/docs/api/namespaces/llvm/#a26e2a938b431eaa6eca2beaa96410c9d">successors</a>(Term), Weights)) &#123;</Highlight></CodeLine>
<Link id="l00722" /><CodeLine lineNumber="722"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!L-&gt;contains(Succ)) &#123;</Highlight></CodeLine>
<Link id="l00723" /><CodeLine lineNumber="723"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// Exit weights stay the same.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00724" /><CodeLine lineNumber="724"><Highlight kind="normal">        SubWeights.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(0);</Highlight></CodeLine>
<Link id="l00725" /><CodeLine lineNumber="725"><Highlight kind="normal">        </Highlight><Highlight kind="keywordflow">continue</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00726" /><CodeLine lineNumber="726"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00727" /><CodeLine lineNumber="727"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00728" /><CodeLine lineNumber="728"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// Subtract exit weights on each iteration, distributed across all</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00729" /><CodeLine lineNumber="729"><Highlight kind="normal">      </Highlight><Highlight kind="comment">// fallthrough edges.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00730" /><CodeLine lineNumber="730"><Highlight kind="normal">      </Highlight><Highlight kind="keywordtype">double</Highlight><Highlight kind="normal"> W = (double)Weight / (</Highlight><Highlight kind="keywordtype">double</Highlight><Highlight kind="normal">)FallThroughWeights;</Highlight></CodeLine>
<Link id="l00731" /><CodeLine lineNumber="731"><Highlight kind="normal">      SubWeights.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>((uint32&#95;t)(ExitWeights &#42; W));</Highlight></CodeLine>
<Link id="l00732" /><CodeLine lineNumber="732"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00733" /><CodeLine lineNumber="733"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00734" /><CodeLine lineNumber="734"><Highlight kind="normal">    WeightInfos.<a href="/docs/api/classes/llvm/densemapbase/#adb33f3ede2f5bfc9b3ee658aaf648492">insert</a>(&#123;Term, &#123;std::move(Weights), std::move(SubWeights)&#125;&#125;);</Highlight></CodeLine>
<Link id="l00735" /><CodeLine lineNumber="735"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00736" /><CodeLine lineNumber="736"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00737" /><CodeLine lineNumber="737"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00738" /><CodeLine lineNumber="738"><Highlight kind="comment">/// Clones the body of the loop L, putting it between \\p InsertTop and \\p</Highlight></CodeLine>
<Link id="l00739" /><CodeLine lineNumber="739"><Highlight kind="comment">/// InsertBot.</Highlight></CodeLine>
<Link id="l00740" /><CodeLine lineNumber="740"><Highlight kind="comment">/// \\param IterNumber The serial number of the iteration currently being</Highlight></CodeLine>
<Link id="l00741" /><CodeLine lineNumber="741"><Highlight kind="comment">/// peeled off.</Highlight></CodeLine>
<Link id="l00742" /><CodeLine lineNumber="742"><Highlight kind="comment">/// \\param ExitEdges The exit edges of the original loop.</Highlight></CodeLine>
<Link id="l00743" /><CodeLine lineNumber="743"><Highlight kind="comment">/// \\param&#91;out&#93; NewBlocks A list of the blocks in the newly created clone</Highlight></CodeLine>
<Link id="l00744" /><CodeLine lineNumber="744"><Highlight kind="comment">/// \\param&#91;out&#93; VMap The value map between the loop and the new clone.</Highlight></CodeLine>
<Link id="l00745" /><CodeLine lineNumber="745"><Highlight kind="comment">/// \\param LoopBlocks A helper for DFS-traversal of the loop.</Highlight></CodeLine>
<Link id="l00746" /><CodeLine lineNumber="746"><Highlight kind="comment">/// \\param LVMap A value-map that maps instructions from the original loop to</Highlight></CodeLine>
<Link id="l00747" /><CodeLine lineNumber="747"><Highlight kind="comment">/// instructions in the last peeled-off iteration.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00748" /><CodeLine lineNumber="748" lineLink="#a8478b291f8a10892334ba0bcf6a18528"><Highlight kind="normal"></Highlight><Highlight kind="keyword">static</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keywordtype">void</Highlight><Highlight kind="normal"> <a href="#a8478b291f8a10892334ba0bcf6a18528">cloneLoopBlocks</a>(</Highlight></CodeLine>
<Link id="l00749" /><CodeLine lineNumber="749"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L, </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> IterNumber, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;InsertTop, <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;InsertBot,</Highlight></CodeLine>
<Link id="l00750" /><CodeLine lineNumber="750"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl</a>&lt;std::pair&lt;BasicBlock &#42;, BasicBlock &#42;&gt;&gt; &amp;ExitEdges,</Highlight></CodeLine>
<Link id="l00751" /><CodeLine lineNumber="751"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallvectorimpl">SmallVectorImpl&lt;BasicBlock &#42;&gt;</a> &amp;NewBlocks, <a href="/docs/api/classes/llvm/loopblocksdfs">LoopBlocksDFS</a> &amp;LoopBlocks,</Highlight></CodeLine>
<Link id="l00752" /><CodeLine lineNumber="752"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp;VMap, <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp;LVMap, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &#42;DT,</Highlight></CodeLine>
<Link id="l00753" /><CodeLine lineNumber="753"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &#42;LI, <a href="/docs/api/classes/llvm/arrayref">ArrayRef&lt;MDNode &#42;&gt;</a> LoopLocalNoAliasDeclScopes,</Highlight></CodeLine>
<Link id="l00754" /><CodeLine lineNumber="754"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &amp;SE) &#123;</Highlight></CodeLine>
<Link id="l00755" /><CodeLine lineNumber="755"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Header = L-&gt;getHeader();</Highlight></CodeLine>
<Link id="l00756" /><CodeLine lineNumber="756"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Latch = L-&gt;getLoopLatch();</Highlight></CodeLine>
<Link id="l00757" /><CodeLine lineNumber="757"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;PreHeader = L-&gt;getLoopPreheader();</Highlight></CodeLine>
<Link id="l00758" /><CodeLine lineNumber="758"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00759" /><CodeLine lineNumber="759"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = Header-&gt;getParent();</Highlight></CodeLine>
<Link id="l00760" /><CodeLine lineNumber="760"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loopblocksdfs/#a0c1bb1134650f3f69f5921d57fb50b78">LoopBlocksDFS::RPOIterator</a> BlockBegin = LoopBlocks.<a href="/docs/api/classes/llvm/loopblocksdfs/#a003fe6215d300fc9720b1b056cdf4c23">beginRPO</a>();</Highlight></CodeLine>
<Link id="l00761" /><CodeLine lineNumber="761"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loopblocksdfs/#a0c1bb1134650f3f69f5921d57fb50b78">LoopBlocksDFS::RPOIterator</a> BlockEnd = LoopBlocks.<a href="/docs/api/classes/llvm/loopblocksdfs/#aeebda6b0288bea7cd706111624ca73f6">endRPO</a>();</Highlight></CodeLine>
<Link id="l00762" /><CodeLine lineNumber="762"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ParentLoop = L-&gt;getParentLoop();</Highlight></CodeLine>
<Link id="l00763" /><CodeLine lineNumber="763"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00764" /><CodeLine lineNumber="764"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// For each block in the original loop, create a new copy,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00765" /><CodeLine lineNumber="765"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// and update the value map with the newly created values.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00766" /><CodeLine lineNumber="766"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loopblocksdfs/#a0c1bb1134650f3f69f5921d57fb50b78">LoopBlocksDFS::RPOIterator</a> BB = BlockBegin; BB != BlockEnd; ++BB) &#123;</Highlight></CodeLine>
<Link id="l00767" /><CodeLine lineNumber="767"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewBB = <a href="/docs/api/namespaces/llvm/#aa1c8d384f90fc9d69d7fcdf920138cf2">CloneBasicBlock</a>(&#42;BB, VMap, </Highlight><Highlight kind="stringliteral">&quot;.peel&quot;</Highlight><Highlight kind="normal">, <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</Highlight></CodeLine>
<Link id="l00768" /><CodeLine lineNumber="768"><Highlight kind="normal">    NewBlocks.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(NewBB);</Highlight></CodeLine>
<Link id="l00769" /><CodeLine lineNumber="769"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00770" /><CodeLine lineNumber="770"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If an original block is an immediate child of the loop L, its copy</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00771" /><CodeLine lineNumber="771"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// is a child of a ParentLoop after peeling. If a block is a child of</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00772" /><CodeLine lineNumber="772"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// a nested loop, it is handled in the cloneLoop() call below.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00773" /><CodeLine lineNumber="773"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (ParentLoop &amp;&amp; LI-&gt;<a href="/docs/api/classes/llvm/loopinfobase/#ad61bd84d4988c90bf6c5cd62d8e7fb00">getLoopFor</a>(&#42;BB) == L)</Highlight></CodeLine>
<Link id="l00774" /><CodeLine lineNumber="774"><Highlight kind="normal">      ParentLoop-&gt;<a href="/docs/api/classes/llvm/loopbase/#a63f099d3bf7cf97eb3ae2d630e3d1afc">addBasicBlockToLoop</a>(NewBB, &#42;LI);</Highlight></CodeLine>
<Link id="l00775" /><CodeLine lineNumber="775"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00776" /><CodeLine lineNumber="776"><Highlight kind="normal">    VMap&#91;&#42;BB&#93; = NewBB;</Highlight></CodeLine>
<Link id="l00777" /><CodeLine lineNumber="777"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00778" /><CodeLine lineNumber="778"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// If dominator tree is available, insert nodes to represent cloned blocks.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00779" /><CodeLine lineNumber="779"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DT) &#123;</Highlight></CodeLine>
<Link id="l00780" /><CodeLine lineNumber="780"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Header == &#42;BB)</Highlight></CodeLine>
<Link id="l00781" /><CodeLine lineNumber="781"><Highlight kind="normal">        DT-&gt;<a href="/docs/api/classes/llvm/dominatortreebase/#a4211a49504539a8a37aebb00e1390370">addNewBlock</a>(NewBB, InsertTop);</Highlight></CodeLine>
<Link id="l00782" /><CodeLine lineNumber="782"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00783" /><CodeLine lineNumber="783"><Highlight kind="normal">        <a href="/docs/api/namespaces/llvm/#a58b9df85470fc4e2a8066ff6a62e5a34">DomTreeNode</a> &#42;IDom = DT-&gt;<a href="/docs/api/classes/llvm/dominatortreebase/#ad8295b9b507d1d847cd46856f8255eab">getNode</a>(&#42;BB)-&gt;<a href="/docs/api/classes/llvm/domtreenodebase/#a453de62c2dadf7b4b8df04e89f6ab4e0">getIDom</a>();</Highlight></CodeLine>
<Link id="l00784" /><CodeLine lineNumber="784"><Highlight kind="normal">        </Highlight><Highlight kind="comment">// VMap must contain entry for IDom, as the iteration order is RPO.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00785" /><CodeLine lineNumber="785"><Highlight kind="normal">        DT-&gt;<a href="/docs/api/classes/llvm/dominatortreebase/#a4211a49504539a8a37aebb00e1390370">addNewBlock</a>(NewBB, <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(VMap&#91;IDom-&gt;<a href="/docs/api/classes/llvm/domtreenodebase/#aab2bf365c9f4b976adc7479576dfd5bb">getBlock</a>()&#93;));</Highlight></CodeLine>
<Link id="l00786" /><CodeLine lineNumber="786"><Highlight kind="normal">      &#125;</Highlight></CodeLine>
<Link id="l00787" /><CodeLine lineNumber="787"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00788" /><CodeLine lineNumber="788"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00789" /><CodeLine lineNumber="789"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00790" /><CodeLine lineNumber="790"><Highlight kind="normal">  &#123;</Highlight></CodeLine>
<Link id="l00791" /><CodeLine lineNumber="791"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Identify what other metadata depends on the cloned version. After</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00792" /><CodeLine lineNumber="792"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// cloning, replace the metadata with the corrected version for both</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00793" /><CodeLine lineNumber="793"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// memory instructions and noalias intrinsics.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00794" /><CodeLine lineNumber="794"><Highlight kind="normal">    std::string Ext = (<a href="/docs/api/classes/llvm/twine">Twine</a>(</Highlight><Highlight kind="stringliteral">&quot;Peel&quot;</Highlight><Highlight kind="normal">) + <a href="/docs/api/classes/llvm/twine">Twine</a>(IterNumber)).str();</Highlight></CodeLine>
<Link id="l00795" /><CodeLine lineNumber="795"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#ab7abd0e34c17dcb201a4138dc65cc067">cloneAndAdaptNoAliasScopes</a>(LoopLocalNoAliasDeclScopes, NewBlocks,</Highlight></CodeLine>
<Link id="l00796" /><CodeLine lineNumber="796"><Highlight kind="normal">                               Header-&gt;getContext(), Ext);</Highlight></CodeLine>
<Link id="l00797" /><CodeLine lineNumber="797"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00798" /><CodeLine lineNumber="798"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00799" /><CodeLine lineNumber="799"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Recursively create the new Loop objects for nested loops, if any,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00800" /><CodeLine lineNumber="800"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// to preserve LoopInfo.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00801" /><CodeLine lineNumber="801"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ChildLoop : &#42;L) &#123;</Highlight></CodeLine>
<Link id="l00802" /><CodeLine lineNumber="802"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#afe8e2e0edcd7756ff5985b8798270c5d">cloneLoop</a>(ChildLoop, ParentLoop, VMap, LI, </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00803" /><CodeLine lineNumber="803"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00804" /><CodeLine lineNumber="804"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00805" /><CodeLine lineNumber="805"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Hook-up the control flow for the newly inserted blocks.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00806" /><CodeLine lineNumber="806"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The new header is hooked up directly to the &quot;top&quot;, which is either</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00807" /><CodeLine lineNumber="807"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the original loop preheader (for the first iteration) or the previous</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00808" /><CodeLine lineNumber="808"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// iteration&#39;s exiting block (for every other iteration)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00809" /><CodeLine lineNumber="809"><Highlight kind="normal">  InsertTop-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>()-&gt;<a href="/docs/api/classes/llvm/instruction/#ae959364e4640ac025bbc046d3d7c7e61">setSuccessor</a>(0, <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(VMap&#91;Header&#93;));</Highlight></CodeLine>
<Link id="l00810" /><CodeLine lineNumber="810"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00811" /><CodeLine lineNumber="811"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Similarly, for the latch:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00812" /><CodeLine lineNumber="812"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The original exiting edge is still hooked up to the loop exit.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00813" /><CodeLine lineNumber="813"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The backedge now goes to the &quot;bottom&quot;, which is either the loop&#39;s real</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00814" /><CodeLine lineNumber="814"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// header (for the last peeled iteration) or the copied header of the next</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00815" /><CodeLine lineNumber="815"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// iteration (for every other iteration)</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00816" /><CodeLine lineNumber="816"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewLatch = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(VMap&#91;Latch&#93;);</Highlight></CodeLine>
<Link id="l00817" /><CodeLine lineNumber="817"><Highlight kind="normal">  </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;LatchTerm = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Instruction&gt;</a>(NewLatch-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>());</Highlight></CodeLine>
<Link id="l00818" /><CodeLine lineNumber="818"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> idx = 0, e = LatchTerm-&gt;getNumSuccessors(); idx &lt; e; ++idx)</Highlight></CodeLine>
<Link id="l00819" /><CodeLine lineNumber="819"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (LatchTerm-&gt;getSuccessor(idx) == Header) &#123;</Highlight></CodeLine>
<Link id="l00820" /><CodeLine lineNumber="820"><Highlight kind="normal">      LatchTerm-&gt;setSuccessor(idx, InsertBot);</Highlight></CodeLine>
<Link id="l00821" /><CodeLine lineNumber="821"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">break</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00822" /><CodeLine lineNumber="822"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00823" /><CodeLine lineNumber="823"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (DT)</Highlight></CodeLine>
<Link id="l00824" /><CodeLine lineNumber="824"><Highlight kind="normal">    DT-&gt;<a href="/docs/api/classes/llvm/dominatortreebase/#a2881c226e1c102190d54c3b664330aba">changeImmediateDominator</a>(InsertBot, NewLatch);</Highlight></CodeLine>
<Link id="l00825" /><CodeLine lineNumber="825"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00826" /><CodeLine lineNumber="826"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// The new copy of the loop body starts with a bunch of PHI nodes</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00827" /><CodeLine lineNumber="827"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// that pick an incoming value from either the preheader, or the previous</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00828" /><CodeLine lineNumber="828"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// loop iteration. Since this copy is no longer part of the loop, we</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00829" /><CodeLine lineNumber="829"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// resolve this statically:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00830" /><CodeLine lineNumber="830"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// For the first iteration, we use the value from the preheader directly.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00831" /><CodeLine lineNumber="831"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// For any other iteration, we replace the phi with the value generated by</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00832" /><CodeLine lineNumber="832"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the immediately preceding clone of the loop body (which represents</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00833" /><CodeLine lineNumber="833"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// the previous iteration).</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00834" /><CodeLine lineNumber="834"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = Header-&gt;begin(); <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;PHINode&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>); ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &#123;</Highlight></CodeLine>
<Link id="l00835" /><CodeLine lineNumber="835"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;NewPHI = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;PHINode&gt;</a>(VMap&#91;&amp;&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93;);</Highlight></CodeLine>
<Link id="l00836" /><CodeLine lineNumber="836"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (IterNumber == 0) &#123;</Highlight></CodeLine>
<Link id="l00837" /><CodeLine lineNumber="837"><Highlight kind="normal">      VMap&#91;&amp;&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; = NewPHI-&gt;<a href="/docs/api/classes/llvm/phinode/#ab2db7609ec72b1af2f91d47e40dc3722">getIncomingValueForBlock</a>(PreHeader);</Highlight></CodeLine>
<Link id="l00838" /><CodeLine lineNumber="838"><Highlight kind="normal">    &#125; </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"> &#123;</Highlight></CodeLine>
<Link id="l00839" /><CodeLine lineNumber="839"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;LatchVal = NewPHI-&gt;<a href="/docs/api/classes/llvm/phinode/#ab2db7609ec72b1af2f91d47e40dc3722">getIncomingValueForBlock</a>(Latch);</Highlight></CodeLine>
<Link id="l00840" /><CodeLine lineNumber="840"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;LatchInst = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(LatchVal);</Highlight></CodeLine>
<Link id="l00841" /><CodeLine lineNumber="841"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (LatchInst &amp;&amp; L-&gt;contains(LatchInst))</Highlight></CodeLine>
<Link id="l00842" /><CodeLine lineNumber="842"><Highlight kind="normal">        VMap&#91;&amp;&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; = LVMap&#91;LatchInst&#93;;</Highlight></CodeLine>
<Link id="l00843" /><CodeLine lineNumber="843"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">else</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00844" /><CodeLine lineNumber="844"><Highlight kind="normal">        VMap&#91;&amp;&#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>&#93; = LatchVal;</Highlight></CodeLine>
<Link id="l00845" /><CodeLine lineNumber="845"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00846" /><CodeLine lineNumber="846"><Highlight kind="normal">    NewPHI-&gt;<a href="/docs/api/classes/llvm/instruction/#a601ee49a4c4e0babf29bd1cf09036570">eraseFromParent</a>();</Highlight></CodeLine>
<Link id="l00847" /><CodeLine lineNumber="847"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00848" /><CodeLine lineNumber="848"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00849" /><CodeLine lineNumber="849"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Fix up the outgoing values - we need to add a value for the iteration</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00850" /><CodeLine lineNumber="850"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// we&#39;ve just created. Note that this must happen &#42;after&#42; the incoming</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00851" /><CodeLine lineNumber="851"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// values are adjusted, since the value going out of the latch may also be</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00852" /><CodeLine lineNumber="852"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// a value coming into the header.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00853" /><CodeLine lineNumber="853"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> Edge : ExitEdges)</Highlight></CodeLine>
<Link id="l00854" /><CodeLine lineNumber="854"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/phinode">PHINode</a> &amp;<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a> : Edge.second-&gt;phis()) &#123;</Highlight></CodeLine>
<Link id="l00855" /><CodeLine lineNumber="855"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/value">Value</a> &#42;LatchVal = <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a>.getIncomingValueForBlock(Edge.first);</Highlight></CodeLine>
<Link id="l00856" /><CodeLine lineNumber="856"><Highlight kind="normal">      <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;LatchInst = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(LatchVal);</Highlight></CodeLine>
<Link id="l00857" /><CodeLine lineNumber="857"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (LatchInst &amp;&amp; L-&gt;contains(LatchInst))</Highlight></CodeLine>
<Link id="l00858" /><CodeLine lineNumber="858"><Highlight kind="normal">        LatchVal = VMap&#91;LatchVal&#93;;</Highlight></CodeLine>
<Link id="l00859" /><CodeLine lineNumber="859"><Highlight kind="normal">      <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a>.addIncoming(LatchVal, <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(VMap&#91;Edge.first&#93;));</Highlight></CodeLine>
<Link id="l00860" /><CodeLine lineNumber="860"><Highlight kind="normal">      SE.<a href="/docs/api/classes/llvm/scalarevolution/#aa6dc58a1259941c7a17142e6103d059e">forgetLcssaPhiWithNewPredecessor</a>(L, &amp;<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a>);</Highlight></CodeLine>
<Link id="l00861" /><CodeLine lineNumber="861"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00862" /><CodeLine lineNumber="862"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00863" /><CodeLine lineNumber="863"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// LastValueMap is updated with the values for the current loop</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00864" /><CodeLine lineNumber="864"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// which are used the next time this function is called.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00865" /><CodeLine lineNumber="865"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> KV : VMap)</Highlight></CodeLine>
<Link id="l00866" /><CodeLine lineNumber="866"><Highlight kind="normal">    LVMap&#91;KV.first&#93; = KV.second;</Highlight></CodeLine>
<Link id="l00867" /><CodeLine lineNumber="867"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00868" /><CodeLine lineNumber="868"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00869" /><CodeLine lineNumber="869"><Highlight kind="normal">TargetTransformInfo::PeelingPreferences</Highlight></CodeLine>
<Link id="l00870" /><CodeLine lineNumber="870" lineLink="/docs/api/namespaces/llvm/#a6e86d0ac2e968adc60290ca52da02e42"><Highlight kind="normal"><a href="/docs/api/namespaces/llvm/#a6e86d0ac2e968adc60290ca52da02e42">llvm::gatherPeelingPreferences</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L, <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &amp;SE,</Highlight></CodeLine>
<Link id="l00871" /><CodeLine lineNumber="871"><Highlight kind="normal">                               </Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> <a href="/docs/api/classes/llvm/targettransforminfo">TargetTransformInfo</a> &amp;<a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>,</Highlight></CodeLine>
<Link id="l00872" /><CodeLine lineNumber="872"><Highlight kind="normal">                               std::optional&lt;bool&gt; UserAllowPeeling,</Highlight></CodeLine>
<Link id="l00873" /><CodeLine lineNumber="873"><Highlight kind="normal">                               std::optional&lt;bool&gt; UserAllowProfileBasedPeeling,</Highlight></CodeLine>
<Link id="l00874" /><CodeLine lineNumber="874"><Highlight kind="normal">                               </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> UnrollingSpecficValues) &#123;</Highlight></CodeLine>
<Link id="l00875" /><CodeLine lineNumber="875"><Highlight kind="normal">  <a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences">TargetTransformInfo::PeelingPreferences</a> PP;</Highlight></CodeLine>
<Link id="l00876" /><CodeLine lineNumber="876"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00877" /><CodeLine lineNumber="877"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Set the default values.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00878" /><CodeLine lineNumber="878"><Highlight kind="normal">  PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a93102207c7c9430df6ef02447446de9b">PeelCount</a> = 0;</Highlight></CodeLine>
<Link id="l00879" /><CodeLine lineNumber="879"><Highlight kind="normal">  PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a3421601051b06ed7b52a09696bd595b2">AllowPeeling</a> = </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00880" /><CodeLine lineNumber="880"><Highlight kind="normal">  PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a71809834780876145831c63077461284">AllowLoopNestsPeeling</a> = </Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00881" /><CodeLine lineNumber="881"><Highlight kind="normal">  PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a89c02eecae37f89bf86f71336630858d">PeelProfiledIterations</a> = </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l00882" /><CodeLine lineNumber="882"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00883" /><CodeLine lineNumber="883"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Get the target specifc values.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00884" /><CodeLine lineNumber="884"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#aa0d69e81725c10fa5407f0bf34462068">TTI</a>.getPeelingPreferences(L, SE, PP);</Highlight></CodeLine>
<Link id="l00885" /><CodeLine lineNumber="885"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00886" /><CodeLine lineNumber="886"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// User specified values using cl::opt.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00887" /><CodeLine lineNumber="887"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UnrollingSpecficValues) &#123;</Highlight></CodeLine>
<Link id="l00888" /><CodeLine lineNumber="888"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#aa9badf8f59af8beee7f66a5252019f70">UnrollPeelCount</a>.getNumOccurrences() &gt; 0)</Highlight></CodeLine>
<Link id="l00889" /><CodeLine lineNumber="889"><Highlight kind="normal">      PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a93102207c7c9430df6ef02447446de9b">PeelCount</a> = <a href="#aa9badf8f59af8beee7f66a5252019f70">UnrollPeelCount</a>;</Highlight></CodeLine>
<Link id="l00890" /><CodeLine lineNumber="890"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#a626a61b9d8aa04db77aaff8e96059f93">UnrollAllowPeeling</a>.getNumOccurrences() &gt; 0)</Highlight></CodeLine>
<Link id="l00891" /><CodeLine lineNumber="891"><Highlight kind="normal">      PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a3421601051b06ed7b52a09696bd595b2">AllowPeeling</a> = <a href="#a626a61b9d8aa04db77aaff8e96059f93">UnrollAllowPeeling</a>;</Highlight></CodeLine>
<Link id="l00892" /><CodeLine lineNumber="892"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="#aa4d9cb6aeac6c6254d62eeb6c4b662ee">UnrollAllowLoopNestsPeeling</a>.getNumOccurrences() &gt; 0)</Highlight></CodeLine>
<Link id="l00893" /><CodeLine lineNumber="893"><Highlight kind="normal">      PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a71809834780876145831c63077461284">AllowLoopNestsPeeling</a> = <a href="#aa4d9cb6aeac6c6254d62eeb6c4b662ee">UnrollAllowLoopNestsPeeling</a>;</Highlight></CodeLine>
<Link id="l00894" /><CodeLine lineNumber="894"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00895" /><CodeLine lineNumber="895"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00896" /><CodeLine lineNumber="896"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// User specifed values provided by argument.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00897" /><CodeLine lineNumber="897"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UserAllowPeeling)</Highlight></CodeLine>
<Link id="l00898" /><CodeLine lineNumber="898"><Highlight kind="normal">    PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a3421601051b06ed7b52a09696bd595b2">AllowPeeling</a> = &#42;UserAllowPeeling;</Highlight></CodeLine>
<Link id="l00899" /><CodeLine lineNumber="899"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (UserAllowProfileBasedPeeling)</Highlight></CodeLine>
<Link id="l00900" /><CodeLine lineNumber="900"><Highlight kind="normal">    PP.<a href="/docs/api/structs/llvm/targettransforminfo/peelingpreferences/#a89c02eecae37f89bf86f71336630858d">PeelProfiledIterations</a> = &#42;UserAllowProfileBasedPeeling;</Highlight></CodeLine>
<Link id="l00901" /><CodeLine lineNumber="901"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00902" /><CodeLine lineNumber="902"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> PP;</Highlight></CodeLine>
<Link id="l00903" /><CodeLine lineNumber="903"><Highlight kind="normal">&#125;</Highlight></CodeLine>
<Link id="l00904" /><CodeLine lineNumber="904"><Highlight kind="normal"></Highlight><Highlight kind="comment"></Highlight></CodeLine>
<Link id="l00905" /><CodeLine lineNumber="905"><Highlight kind="comment">/// Peel off the first \\p PeelCount iterations of loop \\p L.</Highlight></CodeLine>
<Link id="l00906" /><CodeLine lineNumber="906"><Highlight kind="comment">///</Highlight></CodeLine>
<Link id="l00907" /><CodeLine lineNumber="907"><Highlight kind="comment">/// Note that this does not peel them off as a single straight-line block.</Highlight></CodeLine>
<Link id="l00908" /><CodeLine lineNumber="908"><Highlight kind="comment">/// Rather, each iteration is peeled off separately, and needs to check the</Highlight></CodeLine>
<Link id="l00909" /><CodeLine lineNumber="909"><Highlight kind="comment">/// exit condition.</Highlight></CodeLine>
<Link id="l00910" /><CodeLine lineNumber="910"><Highlight kind="comment">/// For loops that dynamically execute \\p PeelCount iterations or less</Highlight></CodeLine>
<Link id="l00911" /><CodeLine lineNumber="911"><Highlight kind="comment">/// this provides a benefit, since the peeled off iterations, which account</Highlight></CodeLine>
<Link id="l00912" /><CodeLine lineNumber="912"><Highlight kind="comment">/// for the bulk of dynamic execution, can be further simplified by scalar</Highlight></CodeLine>
<Link id="l00913" /><CodeLine lineNumber="913"><Highlight kind="comment">/// optimizations.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00914" /><CodeLine lineNumber="914" lineLink="/docs/api/namespaces/llvm/#afdb3eec2f46233c924c30c0838a3c8fe"><Highlight kind="normal"></Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> <a href="/docs/api/namespaces/llvm/#afdb3eec2f46233c924c30c0838a3c8fe">llvm::peelLoop</a>(<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;L, </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> PeelCount, <a href="/docs/api/classes/llvm/loopinfo">LoopInfo</a> &#42;LI,</Highlight></CodeLine>
<Link id="l00915" /><CodeLine lineNumber="915"><Highlight kind="normal">                    <a href="/docs/api/classes/llvm/scalarevolution">ScalarEvolution</a> &#42;SE, <a href="/docs/api/classes/llvm/dominatortree">DominatorTree</a> &amp;DT, <a href="/docs/api/classes/llvm/assumptioncache">AssumptionCache</a> &#42;AC,</Highlight></CodeLine>
<Link id="l00916" /><CodeLine lineNumber="916"><Highlight kind="normal">                    </Highlight><Highlight kind="keywordtype">bool</Highlight><Highlight kind="normal"> PreserveLCSSA, <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> &amp;LVMap) &#123;</Highlight></CodeLine>
<Link id="l00917" /><CodeLine lineNumber="917"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(PeelCount &gt; 0 &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Attempt to peel out zero iterations?&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00918" /><CodeLine lineNumber="918"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a href="/docs/api/namespaces/llvm/#a3aea1e78510aa7469457aade10808e51">canPeel</a>(L) &amp;&amp; </Highlight><Highlight kind="stringliteral">&quot;Attempt to peel a loop which is not peelable?&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l00919" /><CodeLine lineNumber="919"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00920" /><CodeLine lineNumber="920"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/loopblocksdfs">LoopBlocksDFS</a> LoopBlocks(L);</Highlight></CodeLine>
<Link id="l00921" /><CodeLine lineNumber="921"><Highlight kind="normal">  LoopBlocks.<a href="/docs/api/classes/llvm/loopblocksdfs/#adc85a5f08fb0f5dc3e053975995c9d29">perform</a>(LI);</Highlight></CodeLine>
<Link id="l00922" /><CodeLine lineNumber="922"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00923" /><CodeLine lineNumber="923"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Header = L-&gt;getHeader();</Highlight></CodeLine>
<Link id="l00924" /><CodeLine lineNumber="924"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;PreHeader = L-&gt;getLoopPreheader();</Highlight></CodeLine>
<Link id="l00925" /><CodeLine lineNumber="925"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;Latch = L-&gt;getLoopLatch();</Highlight></CodeLine>
<Link id="l00926" /><CodeLine lineNumber="926"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;std::pair&lt;BasicBlock &#42;, BasicBlock &#42;&gt;</a>, 4&gt; ExitEdges;</Highlight></CodeLine>
<Link id="l00927" /><CodeLine lineNumber="927"><Highlight kind="normal">  L-&gt;getExitEdges(ExitEdges);</Highlight></CodeLine>
<Link id="l00928" /><CodeLine lineNumber="928"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00929" /><CodeLine lineNumber="929"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Remember dominators of blocks we might reach through exits to change them</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00930" /><CodeLine lineNumber="930"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// later. Immediate dominator of such block might change, because we add more</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00931" /><CodeLine lineNumber="931"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// routes which can lead to the exit: we can reach it from the peeled</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00932" /><CodeLine lineNumber="932"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// iterations too.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00933" /><CodeLine lineNumber="933"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/densemap">DenseMap&lt;BasicBlock &#42;, BasicBlock &#42;&gt;</a> NonLoopBlocksIDom;</Highlight></CodeLine>
<Link id="l00934" /><CodeLine lineNumber="934"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BB : L-&gt;blocks()) &#123;</Highlight></CodeLine>
<Link id="l00935" /><CodeLine lineNumber="935"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;BBDomNode = DT.<a href="/docs/api/classes/llvm/dominatortreebase/#ad8295b9b507d1d847cd46856f8255eab">getNode</a>(BB);</Highlight></CodeLine>
<Link id="l00936" /><CodeLine lineNumber="936"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 16&gt;</a> ChildrenToUpdate;</Highlight></CodeLine>
<Link id="l00937" /><CodeLine lineNumber="937"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ChildDomNode : BBDomNode-&gt;children()) &#123;</Highlight></CodeLine>
<Link id="l00938" /><CodeLine lineNumber="938"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ChildBB = ChildDomNode-&gt;getBlock();</Highlight></CodeLine>
<Link id="l00939" /><CodeLine lineNumber="939"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (!L-&gt;contains(ChildBB))</Highlight></CodeLine>
<Link id="l00940" /><CodeLine lineNumber="940"><Highlight kind="normal">        ChildrenToUpdate.<a href="/docs/api/classes/llvm/smallvectortemplatebase/#af42bfbc067df27c19ee2fc859df58799">push&#95;back</a>(ChildBB);</Highlight></CodeLine>
<Link id="l00941" /><CodeLine lineNumber="941"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l00942" /><CodeLine lineNumber="942"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// The new idom of the block will be the nearest common dominator</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00943" /><CodeLine lineNumber="943"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// of all copies of the previous idom. This is equivalent to the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00944" /><CodeLine lineNumber="944"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// nearest common dominator of the previous idom and the first latch,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00945" /><CodeLine lineNumber="945"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// which dominates all copies of the previous idom.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00946" /><CodeLine lineNumber="946"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewIDom = DT.<a href="/docs/api/classes/llvm/dominatortree/#a2ec50ab2c78eff965caf3da71cd08be4">findNearestCommonDominator</a>(BB, Latch);</Highlight></CodeLine>
<Link id="l00947" /><CodeLine lineNumber="947"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;ChildBB : ChildrenToUpdate)</Highlight></CodeLine>
<Link id="l00948" /><CodeLine lineNumber="948"><Highlight kind="normal">      NonLoopBlocksIDom&#91;ChildBB&#93; = NewIDom;</Highlight></CodeLine>
<Link id="l00949" /><CodeLine lineNumber="949"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l00950" /><CodeLine lineNumber="950"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00951" /><CodeLine lineNumber="951"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/function">Function</a> &#42;<a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = Header-&gt;getParent();</Highlight></CodeLine>
<Link id="l00952" /><CodeLine lineNumber="952"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00953" /><CodeLine lineNumber="953"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Set up all the necessary basic blocks. It is convenient to split the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00954" /><CodeLine lineNumber="954"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// preheader into 3 parts - two blocks to anchor the peeled copy of the loop</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00955" /><CodeLine lineNumber="955"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// body, and a new preheader for the &quot;real&quot; loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00956" /><CodeLine lineNumber="956"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00957" /><CodeLine lineNumber="957"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Peeling the first iteration transforms.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00958" /><CodeLine lineNumber="958"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00959" /><CodeLine lineNumber="959"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// PreHeader:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00960" /><CodeLine lineNumber="960"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// ...</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00961" /><CodeLine lineNumber="961"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Header:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00962" /><CodeLine lineNumber="962"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   LoopBody</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00963" /><CodeLine lineNumber="963"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   If (cond) goto Header</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00964" /><CodeLine lineNumber="964"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Exit:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00965" /><CodeLine lineNumber="965"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00966" /><CodeLine lineNumber="966"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// into</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00967" /><CodeLine lineNumber="967"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00968" /><CodeLine lineNumber="968"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// InsertTop:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00969" /><CodeLine lineNumber="969"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   LoopBody</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00970" /><CodeLine lineNumber="970"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   If (!cond) goto Exit</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00971" /><CodeLine lineNumber="971"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// InsertBot:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00972" /><CodeLine lineNumber="972"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// NewPreHeader:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00973" /><CodeLine lineNumber="973"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// ...</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00974" /><CodeLine lineNumber="974"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Header:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00975" /><CodeLine lineNumber="975"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//  LoopBody</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00976" /><CodeLine lineNumber="976"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//  If (cond) goto Header</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00977" /><CodeLine lineNumber="977"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Exit:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00978" /><CodeLine lineNumber="978"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00979" /><CodeLine lineNumber="979"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Each following iteration will split the current bottom anchor in two,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00980" /><CodeLine lineNumber="980"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// and put the new copy of the loop body between these two blocks. That is,</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00981" /><CodeLine lineNumber="981"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// after peeling another iteration from the example above, we&#39;ll split</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00982" /><CodeLine lineNumber="982"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// InsertBot, and get:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00983" /><CodeLine lineNumber="983"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00984" /><CodeLine lineNumber="984"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// InsertTop:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00985" /><CodeLine lineNumber="985"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   LoopBody</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00986" /><CodeLine lineNumber="986"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   If (!cond) goto Exit</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00987" /><CodeLine lineNumber="987"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// InsertBot:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00988" /><CodeLine lineNumber="988"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   LoopBody</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00989" /><CodeLine lineNumber="989"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//   If (!cond) goto Exit</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00990" /><CodeLine lineNumber="990"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// InsertBot.next:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00991" /><CodeLine lineNumber="991"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// NewPreHeader:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00992" /><CodeLine lineNumber="992"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// ...</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00993" /><CodeLine lineNumber="993"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Header:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00994" /><CodeLine lineNumber="994"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//  LoopBody</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00995" /><CodeLine lineNumber="995"><Highlight kind="normal">  </Highlight><Highlight kind="comment">//  If (cond) goto Header</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00996" /><CodeLine lineNumber="996"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Exit:</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00997" /><CodeLine lineNumber="997"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l00998" /><CodeLine lineNumber="998"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;InsertTop = <a href="/docs/api/namespaces/llvm/#adf83581f514774264d616eef5706cf6e">SplitEdge</a>(PreHeader, Header, &amp;DT, LI);</Highlight></CodeLine>
<Link id="l00999" /><CodeLine lineNumber="999"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;InsertBot =</Highlight></CodeLine>
<Link id="l01000" /><CodeLine lineNumber="1000"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#ac6c9ffe7979754415f4ca0d677174bc2">SplitBlock</a>(InsertTop, InsertTop-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>(), &amp;DT, LI);</Highlight></CodeLine>
<Link id="l01001" /><CodeLine lineNumber="1001"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/basicblock">BasicBlock</a> &#42;NewPreHeader =</Highlight></CodeLine>
<Link id="l01002" /><CodeLine lineNumber="1002"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#ac6c9ffe7979754415f4ca0d677174bc2">SplitBlock</a>(InsertBot, InsertBot-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>(), &amp;DT, LI);</Highlight></CodeLine>
<Link id="l01003" /><CodeLine lineNumber="1003"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01004" /><CodeLine lineNumber="1004"><Highlight kind="normal">  InsertTop-&gt;<a href="/docs/api/classes/llvm/value/#a35ee267850af7c235474a8c46c7ac5af">setName</a>(Header-&gt;getName() + </Highlight><Highlight kind="stringliteral">&quot;.peel.begin&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01005" /><CodeLine lineNumber="1005"><Highlight kind="normal">  InsertBot-&gt;<a href="/docs/api/classes/llvm/value/#a35ee267850af7c235474a8c46c7ac5af">setName</a>(Header-&gt;getName() + </Highlight><Highlight kind="stringliteral">&quot;.peel.next&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01006" /><CodeLine lineNumber="1006"><Highlight kind="normal">  NewPreHeader-&gt;<a href="/docs/api/classes/llvm/value/#a35ee267850af7c235474a8c46c7ac5af">setName</a>(PreHeader-&gt;<a href="/docs/api/classes/llvm/value/#adb5c319f5905c1d3ca9eb5df546388c5">getName</a>() + </Highlight><Highlight kind="stringliteral">&quot;.peel.newph&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01007" /><CodeLine lineNumber="1007"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01008" /><CodeLine lineNumber="1008"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;LatchTerm =</Highlight></CodeLine>
<Link id="l01009" /><CodeLine lineNumber="1009"><Highlight kind="normal">      <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Instruction&gt;</a>(<a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(Latch)-&gt;getTerminator());</Highlight></CodeLine>
<Link id="l01010" /><CodeLine lineNumber="1010"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01011" /><CodeLine lineNumber="1011"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// If we have branch weight information, we&#39;ll want to update it for the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01012" /><CodeLine lineNumber="1012"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// newly created branches.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01013" /><CodeLine lineNumber="1013"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/densemap">DenseMap&lt;Instruction &#42;, WeightInfo&gt;</a> Weights;</Highlight></CodeLine>
<Link id="l01014" /><CodeLine lineNumber="1014"><Highlight kind="normal">  <a href="#acd8a7753c2685a14185133433c0bbf26">initBranchWeights</a>(Weights, L);</Highlight></CodeLine>
<Link id="l01015" /><CodeLine lineNumber="1015"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01016" /><CodeLine lineNumber="1016"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Identify what noalias metadata is inside the loop: if it is inside the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01017" /><CodeLine lineNumber="1017"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// loop, the associated metadata must be cloned for each iteration.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01018" /><CodeLine lineNumber="1018"><Highlight kind="normal">  <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;MDNode &#42;, 6&gt;</a> LoopLocalNoAliasDeclScopes;</Highlight></CodeLine>
<Link id="l01019" /><CodeLine lineNumber="1019"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#ade9551bcb1121539a279452fec71f9eb">identifyNoAliasScopesToClone</a>(L-&gt;getBlocks(), LoopLocalNoAliasDeclScopes);</Highlight></CodeLine>
<Link id="l01020" /><CodeLine lineNumber="1020"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01021" /><CodeLine lineNumber="1021"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// For each peeled-off iteration, make a copy of the loop.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01022" /><CodeLine lineNumber="1022"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> Iter = 0; Iter &lt; PeelCount; ++Iter) &#123;</Highlight></CodeLine>
<Link id="l01023" /><CodeLine lineNumber="1023"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/smallvector">SmallVector&lt;BasicBlock &#42;, 8&gt;</a> NewBlocks;</Highlight></CodeLine>
<Link id="l01024" /><CodeLine lineNumber="1024"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#abf0f52ae29f87b5e0f2b95ff961cdae1">ValueToValueMapTy</a> VMap;</Highlight></CodeLine>
<Link id="l01025" /><CodeLine lineNumber="1025"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01026" /><CodeLine lineNumber="1026"><Highlight kind="normal">    <a href="#a8478b291f8a10892334ba0bcf6a18528">cloneLoopBlocks</a>(L, Iter, InsertTop, InsertBot, ExitEdges, NewBlocks,</Highlight></CodeLine>
<Link id="l01027" /><CodeLine lineNumber="1027"><Highlight kind="normal">                    LoopBlocks, VMap, LVMap, &amp;DT, LI,</Highlight></CodeLine>
<Link id="l01028" /><CodeLine lineNumber="1028"><Highlight kind="normal">                    LoopLocalNoAliasDeclScopes, &#42;SE);</Highlight></CodeLine>
<Link id="l01029" /><CodeLine lineNumber="1029"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01030" /><CodeLine lineNumber="1030"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Remap to use values from the current iteration instead of the</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01031" /><CodeLine lineNumber="1031"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// previous one.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01032" /><CodeLine lineNumber="1032"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#ab8ec5c940fbc440c992716fbe4a48636">remapInstructionsInBlocks</a>(NewBlocks, VMap);</Highlight></CodeLine>
<Link id="l01033" /><CodeLine lineNumber="1033"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01034" /><CodeLine lineNumber="1034"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Update IDoms of the blocks reachable through exits.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01035" /><CodeLine lineNumber="1035"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (Iter == 0)</Highlight></CodeLine>
<Link id="l01036" /><CodeLine lineNumber="1036"><Highlight kind="normal">      </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> BBIDom : NonLoopBlocksIDom)</Highlight></CodeLine>
<Link id="l01037" /><CodeLine lineNumber="1037"><Highlight kind="normal">        DT.<a href="/docs/api/classes/llvm/dominatortreebase/#a2881c226e1c102190d54c3b664330aba">changeImmediateDominator</a>(BBIDom.first,</Highlight></CodeLine>
<Link id="l01038" /><CodeLine lineNumber="1038"><Highlight kind="normal">                                     <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;BasicBlock&gt;</a>(LVMap&#91;BBIDom.second&#93;));</Highlight></CodeLine>
<Link id="l01039" /><CodeLine lineNumber="1039"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#ifdef EXPENSIVE&#95;CHECKS</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01040" /><CodeLine lineNumber="1040"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(DT.<a href="/docs/api/classes/llvm/dominatortreebase/#a1f08f2925fec05b265e540d29066b9c8">verify</a>(DominatorTree::VerificationLevel::Fast));</Highlight></CodeLine>
<Link id="l01041" /><CodeLine lineNumber="1041"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#endif</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01042" /><CodeLine lineNumber="1042"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01043" /><CodeLine lineNumber="1043"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;&#91;Term, Info&#93; : Weights) &#123;</Highlight></CodeLine>
<Link id="l01044" /><CodeLine lineNumber="1044"><Highlight kind="normal">      </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;TermCopy = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Instruction&gt;</a>(VMap&#91;Term&#93;);</Highlight></CodeLine>
<Link id="l01045" /><CodeLine lineNumber="1045"><Highlight kind="normal">      <a href="#a070d953c06601ec34680fdc35c867b17">updateBranchWeights</a>(TermCopy, Info);</Highlight></CodeLine>
<Link id="l01046" /><CodeLine lineNumber="1046"><Highlight kind="normal">    &#125;</Highlight></CodeLine>
<Link id="l01047" /><CodeLine lineNumber="1047"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01048" /><CodeLine lineNumber="1048"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// Remove Loop metadata from the latch branch instruction</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01049" /><CodeLine lineNumber="1049"><Highlight kind="normal">    </Highlight><Highlight kind="comment">// because it is not the Loop&#39;s latch branch anymore.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01050" /><CodeLine lineNumber="1050"><Highlight kind="normal">    </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &#42;LatchTermCopy = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;Instruction&gt;</a>(VMap&#91;LatchTerm&#93;);</Highlight></CodeLine>
<Link id="l01051" /><CodeLine lineNumber="1051"><Highlight kind="normal">    LatchTermCopy-&gt;setMetadata(LLVMContext::MD&#95;loop, </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01052" /><CodeLine lineNumber="1052"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01053" /><CodeLine lineNumber="1053"><Highlight kind="normal">    InsertTop = InsertBot;</Highlight></CodeLine>
<Link id="l01054" /><CodeLine lineNumber="1054"><Highlight kind="normal">    InsertBot = <a href="/docs/api/namespaces/llvm/#ac6c9ffe7979754415f4ca0d677174bc2">SplitBlock</a>(InsertBot, InsertBot-&gt;<a href="/docs/api/classes/llvm/basicblock/#aef9e9fcf4c5dfce90276ca16d91b8e46">getTerminator</a>(), &amp;DT, LI);</Highlight></CodeLine>
<Link id="l01055" /><CodeLine lineNumber="1055"><Highlight kind="normal">    InsertBot-&gt;<a href="/docs/api/classes/llvm/value/#a35ee267850af7c235474a8c46c7ac5af">setName</a>(Header-&gt;getName() + </Highlight><Highlight kind="stringliteral">&quot;.peel.next&quot;</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01056" /><CodeLine lineNumber="1056"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01057" /><CodeLine lineNumber="1057"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;splice(InsertTop-&gt;<a href="/docs/api/classes/llvm/ilist-node-impl/#af719fc783be6589465137d997701a432">getIterator</a>(), <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, NewBlocks&#91;0&#93;-&gt;getIterator(),</Highlight></CodeLine>
<Link id="l01058" /><CodeLine lineNumber="1058"><Highlight kind="normal">              <a href="/docs/api/files/lib/lib/support/md5-cpp/#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;end());</Highlight></CodeLine>
<Link id="l01059" /><CodeLine lineNumber="1059"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01060" /><CodeLine lineNumber="1060"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01061" /><CodeLine lineNumber="1061"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Now adjust the phi nodes in the loop header to get their initial values</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01062" /><CodeLine lineNumber="1062"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// from the last peeled-off iteration instead of the preheader.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01063" /><CodeLine lineNumber="1063"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/basicblock/#a98c0a84a5dfa8bce341c829709f171e5">BasicBlock::iterator</a> <a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a> = Header-&gt;begin(); <a href="/docs/api/namespaces/llvm/#a92ca992e52dddc420f4b069cae06dfbe">isa&lt;PHINode&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>); ++<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &#123;</Highlight></CodeLine>
<Link id="l01064" /><CodeLine lineNumber="1064"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/phinode">PHINode</a> &#42;<a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a> = <a href="/docs/api/namespaces/llvm/#ac4fc845f5ed92de63cd4474f128f5fc5">cast&lt;PHINode&gt;</a>(<a href="/docs/api/files/lib/lib/support/md5-cpp/#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</Highlight></CodeLine>
<Link id="l01065" /><CodeLine lineNumber="1065"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/value">Value</a> &#42;NewVal = <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a>-&gt;getIncomingValueForBlock(Latch);</Highlight></CodeLine>
<Link id="l01066" /><CodeLine lineNumber="1066"><Highlight kind="normal">    <a href="/docs/api/classes/llvm/instruction">Instruction</a> &#42;LatchInst = <a href="/docs/api/namespaces/llvm/#a22eeee01734061ac1b31ccd994c49eef">dyn&#95;cast&lt;Instruction&gt;</a>(NewVal);</Highlight></CodeLine>
<Link id="l01067" /><CodeLine lineNumber="1067"><Highlight kind="normal">    </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (LatchInst &amp;&amp; L-&gt;contains(LatchInst))</Highlight></CodeLine>
<Link id="l01068" /><CodeLine lineNumber="1068"><Highlight kind="normal">      NewVal = LVMap&#91;LatchInst&#93;;</Highlight></CodeLine>
<Link id="l01069" /><CodeLine lineNumber="1069"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01070" /><CodeLine lineNumber="1070"><Highlight kind="normal">    <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/amdgpurewriteundefforphi-cpp/#a2e83cb1bc3f5e8986cbd14575755a134">PHI</a>-&gt;setIncomingValueForBlock(NewPreHeader, NewVal);</Highlight></CodeLine>
<Link id="l01071" /><CodeLine lineNumber="1071"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01072" /><CodeLine lineNumber="1072"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01073" /><CodeLine lineNumber="1073"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">for</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">const</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> &amp;&#91;Term, Info&#93; : Weights) &#123;</Highlight></CodeLine>
<Link id="l01074" /><CodeLine lineNumber="1074"><Highlight kind="normal">    <a href="/docs/api/namespaces/llvm/#a6cf82c052d63a1b464be8e48ff38c48e">setBranchWeights</a>(&#42;Term, Info.Weights, </Highlight><Highlight kind="comment">/&#42;IsExpected=&#42;/</Highlight><Highlight kind="keyword">false</Highlight><Highlight kind="normal">);</Highlight></CodeLine>
<Link id="l01075" /><CodeLine lineNumber="1075"><Highlight kind="normal">  &#125;</Highlight></CodeLine>
<Link id="l01076" /><CodeLine lineNumber="1076"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01077" /><CodeLine lineNumber="1077"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Update Metadata for count of peeled off iterations.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01078" /><CodeLine lineNumber="1078"><Highlight kind="normal">  </Highlight><Highlight kind="keywordtype">unsigned</Highlight><Highlight kind="normal"> AlreadyPeeled = 0;</Highlight></CodeLine>
<Link id="l01079" /><CodeLine lineNumber="1079"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (</Highlight><Highlight kind="keyword">auto</Highlight><Highlight kind="normal"> Peeled = <a href="/docs/api/namespaces/llvm/#a9b3cfe2d1603665824476c30368b8eb1">getOptionalIntLoopAttribute</a>(L, <a href="#a7f5685c46cf812c90576046af45cd7fa">PeeledCountMetaData</a>))</Highlight></CodeLine>
<Link id="l01080" /><CodeLine lineNumber="1080"><Highlight kind="normal">    AlreadyPeeled = &#42;Peeled;</Highlight></CodeLine>
<Link id="l01081" /><CodeLine lineNumber="1081"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#a55c9054d63d1c6a39e9c09ba13a482fa">addStringMetadataToLoop</a>(L, <a href="#a7f5685c46cf812c90576046af45cd7fa">PeeledCountMetaData</a>, AlreadyPeeled + PeelCount);</Highlight></CodeLine>
<Link id="l01082" /><CodeLine lineNumber="1082"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01083" /><CodeLine lineNumber="1083"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">if</Highlight><Highlight kind="normal"> (<a href="/docs/api/classes/llvm/loop">Loop</a> &#42;ParentLoop = L-&gt;getParentLoop())</Highlight></CodeLine>
<Link id="l01084" /><CodeLine lineNumber="1084"><Highlight kind="normal">    L = ParentLoop;</Highlight></CodeLine>
<Link id="l01085" /><CodeLine lineNumber="1085"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01086" /><CodeLine lineNumber="1086"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// We modified the loop, update SE.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01087" /><CodeLine lineNumber="1087"><Highlight kind="normal">  SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a7d5bfa1ac3c7c096af6b26fb95cd699d">forgetTopmostLoop</a>(L);</Highlight></CodeLine>
<Link id="l01088" /><CodeLine lineNumber="1088"><Highlight kind="normal">  SE-&gt;<a href="/docs/api/classes/llvm/scalarevolution/#a830ba09d5969cd66878b05c17fdf66b6">forgetBlockAndLoopDispositions</a>();</Highlight></CodeLine>
<Link id="l01089" /><CodeLine lineNumber="1089"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01090" /><CodeLine lineNumber="1090"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#ifdef EXPENSIVE&#95;CHECKS</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01091" /><CodeLine lineNumber="1091"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// Finally DomtTree must be correct.</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01092" /><CodeLine lineNumber="1092"><Highlight kind="normal">  <a href="/docs/api/files/lib/lib/target/lib/target/amdgpu/silowercontrolflow-cpp/#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(DT.<a href="/docs/api/classes/llvm/dominatortreebase/#a1f08f2925fec05b265e540d29066b9c8">verify</a>(DominatorTree::VerificationLevel::Fast));</Highlight></CodeLine>
<Link id="l01093" /><CodeLine lineNumber="1093"><Highlight kind="normal"></Highlight><Highlight kind="preprocessor">#endif</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01094" /><CodeLine lineNumber="1094"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01095" /><CodeLine lineNumber="1095"><Highlight kind="normal">  </Highlight><Highlight kind="comment">// FIXME: Incrementally update loop-simplify</Highlight><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01096" /><CodeLine lineNumber="1096"><Highlight kind="normal">  <a href="/docs/api/namespaces/llvm/#a0083a69883e0f97e111dbff064c60f42">simplifyLoop</a>(L, &amp;DT, LI, SE, AC, </Highlight><Highlight kind="keyword">nullptr</Highlight><Highlight kind="normal">, PreserveLCSSA);</Highlight></CodeLine>
<Link id="l01097" /><CodeLine lineNumber="1097"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01098" /><CodeLine lineNumber="1098"><Highlight kind="normal">  NumPeeled++;</Highlight></CodeLine>
<Link id="l01099" /><CodeLine lineNumber="1099"><Highlight kind="normal"></Highlight></CodeLine>
<Link id="l01100" /><CodeLine lineNumber="1100"><Highlight kind="normal">  </Highlight><Highlight kind="keywordflow">return</Highlight><Highlight kind="normal"> </Highlight><Highlight kind="keyword">true</Highlight><Highlight kind="normal">;</Highlight></CodeLine>
<Link id="l01101" /><CodeLine lineNumber="1101"><Highlight kind="normal">&#125;</Highlight></CodeLine>

</ProgramListing>

</DoxygenPage>
